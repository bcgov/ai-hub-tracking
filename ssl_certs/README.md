# SSL Certificate Configuration

Scripts and documentation for SSL certificate management for the AI Hub vanity domains.

> **Note:** DNS Zone, static Public IP, and A record management is handled by the Terraform `dns-zone` module
> (`infra-ai-hub/modules/dns-zone/`). See the module for details.

> **Note:** The App Gateway module uses `lifecycle { ignore_changes = [ssl_certificate] }`, so SSL certs
> uploaded via Portal or CLI will **not** be reverted by `terraform apply`.

## Scripts

| Script | Purpose |
|--------|---------|
| `csr-gen.sh` | Generates CSR for SSL certificate requests (BC Gov internal process) || `create-pfx.sh` | Creates PFX bundle from PEM cert files + private key (passwordless for KV) || `upload-cert-direct.sh` | Uploads PFX directly to App Gateway (no Key Vault) |
| `upload-cert-keyvault.sh` | Imports PFX into Key Vault, configures RBAC, attaches to App Gateway |

All scripts support `--help`, `-i` (interactive mode), `--dry-run`, and CLI parameters.

### Quick Start — Upload Scripts

```bash
# ── Step 1: Create PFX from PEM files ──

# Passwordless PFX for Key Vault — interactive
./create-pfx.sh -i

# Passwordless PFX — non-interactive
./create-pfx.sh --cert-dir prod/aihub.gov.bc.ca --key /path/to/private.key

# PFX with password (for direct upload)
./create-pfx.sh --cert-dir prod/aihub.gov.bc.ca --key /path/to/private.key --with-password

# Verify an existing PFX
./create-pfx.sh --verify-only --output prod/aihub.gov.bc.ca/aihub.gov.bc.ca.pfx

# ── Step 2: Upload to App Gateway ──

# Direct upload (no Key Vault) — interactive
./upload-cert-direct.sh -i

# Direct upload — non-interactive
./upload-cert-direct.sh --env prod --pfx prod/aihub.gov.bc.ca/aihub.gov.bc.ca.pfx --password SECRET

# Direct upload — with HTTPS listener setup
./upload-cert-direct.sh --env prod --pfx cert.pfx --password SECRET --setup-https

# Key Vault upload — interactive
./upload-cert-keyvault.sh -i

# Key Vault upload — non-interactive
./upload-cert-keyvault.sh --env prod --pfx prod/aihub.gov.bc.ca/aihub.gov.bc.ca.pfx --vault-name my-kv

# Key Vault upload — skip RBAC (already managed by Terraform)
./upload-cert-keyvault.sh --env prod --pfx cert.pfx --vault-name my-kv --skip-rbac

# Dry run either script
./upload-cert-direct.sh --env test --pfx cert.pfx --password SECRET --dry-run
./upload-cert-keyvault.sh --env test --pfx cert.pfx --vault-name my-kv --dry-run
```

## Domain Mapping

| Environment | Domain |
|-------------|--------|
| test | `test.aihub.gov.bc.ca` |
| prod | `aihub.gov.bc.ca` |

## CSR Generation & Private Key Management

The `csr-gen.sh` script generates a Certificate Signing Request (CSR) and an accompanying private key for the vanity domain. This is used in the BC Gov internal SSL certificate procurement process.

### Using csr-gen.sh

The script supports interactive mode, non-interactive mode, and using an existing private key:

```bash
# Interactive mode (will prompt for domain and options)
./csr-gen.sh -i

# Non-interactive — generates new CSR and private key
./csr-gen.sh test.aihub.gov.bc.ca

# Non-interactive — with custom private key path output
./csr-gen.sh aihub.gov.bc.ca --key-output /secure/path/to/private.key

# With existing private key (reuse for renewal)
./csr-gen.sh test.aihub.gov.bc.ca /path/to/existing.key
```

### CSR Submission via NRM Ticket

Once generated, submit the CSR through the BC Government NRM (Natural Resource Management) ticketing system:

1. **Create a new ticket** in the [Service Desk](https://apps.nrs.gov.bc.ca/int/jira/browse/SD-166296) (component: Infrastructure, type: Service Request)
2. **Attach the CSR file** (typically `{domain}.csr`) to the ticket
3. **Request details:**
   - Domain: `test.aihub.gov.bc.ca` or `aihub.gov.bc.ca`
   - Certificate type: OV (Organization Validation) TLS
   - Validity period: 1 year (or as approved)
4. **Reference issue:** [SD-166296 (SSL Certs | AI Hub Test Environment)](https://apps.nrs.gov.bc.ca/int/jira/browse/SD-166296)

### ⚠️ IMPORTANT: Private Key Preservation

**The private key generated by `csr-gen.sh` is REQUIRED for subsequent steps:**

- The private key is needed to create the PFX bundle (`create-pfx.sh` step)
- The PFX is required for App Gateway SSL configuration
- **If the private key is lost, you must:**
  1. Generate a new CSR with a new private key (`./csr-gen.sh`)
  2. Request a new certificate from BC Gov
  3. Cannot use the original certificate

**Best practices:**
- Store the private key in a **secure location outside this repository** (e.g., Azure Key Vault during development, or secured file system)
- Use file permissions to restrict access: `chmod 600 private.key`
- Back up the private key securely before proceeding with PFX creation
- Never commit the private key to version control (`.gitignore` should exclude it)

---

## SSL Certificate Upload Methods

There are three ways to configure SSL certificates for the App Gateway. Choose the method that fits your workflow.

### Method 1: Azure Portal — Direct PFX Upload (No Key Vault)

Best for: quick setup, testing, or environments without Key Vault.

**Prerequisites:**
- A `.pfx` file containing the certificate + private key + CA chain
- The PFX password

**Steps:**

1. Navigate to **Azure Portal → Application Gateways → `ai-services-hub-{env}-appgw`**
2. In the left menu, select **Listeners**
3. Click the HTTPS listener (e.g., `*-listener-https`), or create a new one:
   - **Protocol:** HTTPS
   - **Port:** 443
   - **Host name:** your vanity domain (e.g., `test.aihub.gov.bc.ca`)
4. Under **Choose a certificate**, select **Upload a certificate**
5. Fill in:
   - **Cert name:** `api-{env}-cert` (e.g., `api-test-cert`)
   - **PFX certificate file:** browse and select your `.pfx` file
   - **Password:** enter the PFX password
6. Click **Save**

> If the App Gateway does not yet have an HTTPS listener (initial deploy without SSL), you also need
> to add a routing rule. See [Adding HTTPS routing after initial deploy](#adding-https-routing-after-initial-deploy).

**Creating a PFX from PEM files** (if you received separate cert/key/chain files):

```bash
# Combine cert, chain, and key into a PFX
# IMPORTANT: -legacy flag is required for OpenSSL 3.x (Azure App GW needs 3DES format)
openssl pkcs12 -export -legacy \
  -out aihub.gov.bc.ca.pfx \
  -inkey private.key \
  -in aihub.gov.bc.ca.pem \
  -certfile "Entrust OV TLS Issuing RSA CA 2.pem" \
  -certfile "USERTrust RSA Certification Authority.pem" \
  -certfile "Sectigo Public Server Authentication Root R46.pem"
```

---

### Method 2: Azure Portal — Key Vault Reference

Best for: production, automated rotation, centralized cert management.

**Prerequisites:**
- Certificate uploaded to Azure Key Vault as a **Secret** (base64-encoded PFX, no password)
- App Gateway's user-assigned managed identity has **Key Vault Secrets User** role on the vault

**Steps:**

1. **Upload cert to Key Vault:**
   - Azure Portal → **Key Vaults → `{kv-name}` → Certificates → Generate/Import**
   - Method: **Import**
   - Certificate name: `api-{env}-cert`
   - Upload the `.pfx` file (password if required)
   - Click **Create**

2. **Copy the Secret ID** (not the Certificate ID):
   - Go to **Key Vaults → `{kv-name}` → Secrets → `api-{env}-cert`**
   - Click the current version
   - Copy the **Secret Identifier** (e.g., `https://{kv-name}.vault.azure.net/secrets/api-{env}-cert`)
   - For auto-rotation, use the **versionless** URL (without the version GUID at the end)

3. **Configure in App Gateway:**
   - Azure Portal → **Application Gateways → `ai-services-hub-{env}-appgw`**
   - Go to **Listeners** → click the HTTPS listener
   - Under **Choose a certificate**, select **Choose a certificate from Key Vault**
   - **Cert name:** `api-{env}-cert`
   - **Managed identity:** select the `ai-services-hub-{env}-appgw-identity`
   - **Key Vault:** select your Key Vault
   - **Certificate:** select the certificate
   - Click **Save**

> **Certificate rotation:** If you used the versionless Secret ID, uploading a new version to Key Vault
> will automatically rotate the certificate on the App Gateway (within ~4 hours, or force via Portal restart).

---

### Method 3: Terraform — Declarative Configuration

Best for: fully IaC-managed environments where certs are already in Key Vault.

Add to `params/{env}/shared.tfvars`:

```hcl
app_gateway = {
  # ... other settings ...

  # Option A: Key Vault reference (recommended)
  ssl_certificates = {
    primary = {
      name                = "api-{env}-cert"
      key_vault_secret_id = "https://{kv-name}.vault.azure.net/secrets/api-{env}-cert"
    }
  }
  key_vault_id = "/subscriptions/{sub-id}/resourceGroups/{rg}/providers/Microsoft.KeyVault/vaults/{kv-name}"

  # Option B: Direct PFX (base64 encoded, not recommended for prod)
  # ssl_certificates = {
  #   primary = {
  #     name     = "api-{env}-cert"
  #     data     = filebase64("path/to/cert.pfx")
  #     password = "pfx-password"
  #   }
  # }
}
```

> **Important:** The App Gateway Terraform module ignores changes to `ssl_certificate` blocks.
> This means you can initially deploy via Terraform, then manage rotation via Portal or Key Vault
> without Terraform reverting your changes.

---

## Adding HTTPS Routing After Initial Deploy

If the App Gateway was initially deployed **without SSL** (HTTP only), you need to add HTTPS
routing after uploading the certificate via Portal:

1. **Add HTTPS listener** (as described in Method 1 or 2 above)

2. **Add HTTPS routing rule:**
   - Azure Portal → **Application Gateways → Rules → Add**
   - **Rule name:** `{appgw-name}-rule-https`
   - **Priority:** `100`
   - **Listener:** select the HTTPS listener you just created
   - **Backend targets:**
     - **Backend pool:** `{appgw-name}-bepool-apim`
     - **Backend settings:** `{appgw-name}-httpsetting`
   - Click **Add**

3. **Update HTTP rule to redirect:**
   - Click the existing HTTP routing rule (`*-rule-http`)
   - Change **Backend targets** → **Target type** to **Redirection**
   - **Redirection type:** Permanent (301)
   - **Redirection target:** the HTTPS listener
   - **Include path** and **Include query string:** both checked
   - Click **Save**

---

## Certificate Chain

For BC Gov Sectigo certificates, the full chain order is:

| Order | File | Purpose |
|-------|------|---------|
| 1 | `aihub.gov.bc.ca.pem` | Server certificate (leaf) |
| 2 | `Entrust OV TLS Issuing RSA CA 2.pem` | Issuing CA |
| 3 | `USERTrust RSA Certification Authority.pem` | Intermediate CA |
| 4 | `Sectigo Public Server Authentication Root R46.pem` | Root CA |

These files are stored in `ssl_certs/prod/aihub.gov.bc.ca/` for reference.

Use `create-pfx.sh` to bundle these into a PFX:

```bash
# Passwordless PFX (for Key Vault)
./create-pfx.sh --cert-dir prod/aihub.gov.bc.ca --key /secure/path/to/private.key

# PFX with password (for direct App GW upload)
./create-pfx.sh --cert-dir prod/aihub.gov.bc.ca --key /secure/path/to/private.key --with-password
```

---

### Step 1: Create the Full Chain PEM

Concatenate all CA certificates into a single chain file (order matters — leaf issuers first, root last):

```bash
cat "ssl_certs/prod/aihub.gov.bc.ca/Entrust OV TLS Issuing RSA CA 2.pem" \
    "ssl_certs/prod/aihub.gov.bc.ca/USERTrust RSA Certification Authority.pem" \
    "ssl_certs/prod/aihub.gov.bc.ca/Sectigo Public Server Authentication Root R46.pem" \
    > ssl_certs/prod/aihub.gov.bc.ca/ca-chain.pem
```

### Step 2: Create the PFX Bundle

The PFX (PKCS#12) file bundles the private key + server cert + CA chain into a single encrypted file. App Gateway requires this format.

```bash
cd ssl_certs/prod/aihub.gov.bc.ca

# IMPORTANT: -legacy flag is required for OpenSSL 3.x (Azure App GW needs 3DES format)
openssl pkcs12 -export -legacy \
  -out aihub.gov.bc.ca.pfx \
  -inkey /path/to/private.key \
  -in aihub.gov.bc.ca.pem \
  -certfile ca-chain.pem \
  -name "aihub.gov.bc.ca"

# You will be prompted for an export password — remember it for the upload step
```

> **Where is the private key?** The private key was generated during CSR creation (`csr-gen.sh`).
> It is typically stored securely outside this repo. If you lost it, you must generate a new CSR
> and request a new certificate.

### Step 3: Verify the PFX

```bash
# Check the PFX contents (should show subject, issuer chain, and "has private key")
openssl pkcs12 -in aihub.gov.bc.ca.pfx -info -nokeys -passin pass:YOUR_PASSWORD 2>/dev/null

# Verify the full chain
openssl pkcs12 -in aihub.gov.bc.ca.pfx -clcerts -nokeys -passin pass:YOUR_PASSWORD 2>/dev/null | \
  openssl x509 -noout -subject -issuer -dates
```

Expected output:
```
subject=CN = aihub.gov.bc.ca
issuer=CN = Entrust OV TLS Issuing RSA CA 2, O = Entrust, ...
notBefore=...
notAfter=...
```

---

### Upload Path A: Direct to App Gateway (Without Key Vault)

Use this when you want the simplest path — upload the PFX directly to the App Gateway.

**Via Azure Portal:**

1. Go to **Azure Portal → Application Gateways → `ai-services-hub-{env}-appgw`**
2. Left menu → **Listeners** → click the HTTPS listener (or create one)
3. Under **Choose a certificate** → select **Upload a certificate**
4. Fill in:
   - **Cert name:** `api-prod-cert`
   - **PFX certificate file:** select `aihub.gov.bc.ca.pfx`
   - **Password:** enter the export password from Step 2
5. Click **Save**

**Via Azure CLI:**

```bash
# Upload PFX directly when creating/updating the listener
# Note: This embeds the cert in the App Gateway config (not externally managed)
az network application-gateway ssl-cert create \
  --resource-group "ai-services-hub-prod" \
  --gateway-name "ai-services-hub-prod-appgw" \
  --name "api-prod-cert" \
  --cert-file "ssl_certs/prod/aihub.gov.bc.ca/aihub.gov.bc.ca.pfx" \
  --cert-password "YOUR_PASSWORD"
```

**Pros:** Simple, no Key Vault dependency, works immediately.
**Cons:** No automated rotation. Must re-upload manually when the cert expires. Cert is embedded in App Gateway config.

---

### Upload Path B: Via Azure Key Vault (Recommended for Production)

Use this for centralized cert management and automated rotation.

#### B1. Create a passwordless PFX for Key Vault

Key Vault expects a PFX **without a password** when importing as a certificate:

```bash
cd ssl_certs/prod/aihub.gov.bc.ca

# Create passwordless PFX (pass empty string for export password)
# IMPORTANT: -legacy flag is required for OpenSSL 3.x (Azure App GW needs 3DES format)
openssl pkcs12 -export -legacy \
  -out aihub.gov.bc.ca-nopass.pfx \
  -inkey /path/to/private.key \
  -in aihub.gov.bc.ca.pem \
  -certfile ca-chain.pem \
  -name "aihub.gov.bc.ca" \
  -passout pass:
```

#### B2. Import into Key Vault

**Via Azure Portal:**

1. Go to **Azure Portal → Key Vaults → `{kv-name}`**
2. Left menu → **Certificates** → **Generate/Import**
3. Fill in:
   - **Method:** Import
   - **Certificate name:** `api-prod-cert`
   - **Upload Certificate File:** select `aihub.gov.bc.ca-nopass.pfx`
   - **Password:** leave empty (passwordless PFX)
4. Click **Create**

**Via Azure CLI:**

```bash
az keyvault certificate import \
  --vault-name "{kv-name}" \
  --name "api-prod-cert" \
  --file "ssl_certs/prod/aihub.gov.bc.ca/aihub.gov.bc.ca-nopass.pfx"
```

#### B3. Get the Secret Identifier

The App Gateway references the Key Vault **Secret** (not Certificate) identifier:

**Via Azure Portal:**

1. Go to **Key Vaults → `{kv-name}` → Secrets** (not Certificates)
2. Click `api-prod-cert` → click the current version
3. Copy the **Secret Identifier** URL
4. **For auto-rotation:** remove the version GUID from the end of the URL:
   - Versioned: `https://{kv-name}.vault.azure.net/secrets/api-prod-cert/abc123...`
   - Versionless: `https://{kv-name}.vault.azure.net/secrets/api-prod-cert` ← use this

**Via Azure CLI:**

```bash
# Get the versionless secret ID
az keyvault secret show \
  --vault-name "{kv-name}" \
  --name "api-prod-cert" \
  --query "id" -o tsv | sed 's|/[^/]*$||'
```

#### B4. Ensure App Gateway identity has Key Vault access

The App Gateway's managed identity needs **Key Vault Secrets User** role:

```bash
# Get the managed identity principal ID
IDENTITY_ID=$(az identity show \
  --resource-group "ai-services-hub-prod" \
  --name "ai-services-hub-prod-appgw-identity" \
  --query principalId -o tsv)

# Get Key Vault resource ID
KV_ID=$(az keyvault show --name "{kv-name}" --query id -o tsv)

# Assign role
az role assignment create \
  --assignee "$IDENTITY_ID" \
  --role "Key Vault Secrets User" \
  --scope "$KV_ID"
```

> **Note:** If you configured `key_vault_id` in `shared.tfvars`, Terraform creates this role
> assignment automatically via `azurerm_role_assignment.appgw_to_keyvault`.

#### B5. Attach in App Gateway

**Via Azure Portal:**

1. Go to **Application Gateways → `ai-services-hub-{env}-appgw`**
2. Left menu → **Listeners** → click the HTTPS listener
3. Under **Choose a certificate** → select **Choose a certificate from Key Vault**
4. Fill in:
   - **Cert name:** `api-prod-cert`
   - **Managed identity:** `ai-services-hub-prod-appgw-identity`
   - **Key Vault:** select `{kv-name}`
   - **Certificate:** select `api-prod-cert`
5. Click **Save**

**Via Azure CLI:**

```bash
az network application-gateway ssl-cert create \
  --resource-group "ai-services-hub-prod" \
  --gateway-name "ai-services-hub-prod-appgw" \
  --name "api-prod-cert" \
  --key-vault-secret-id "https://{kv-name}.vault.azure.net/secrets/api-prod-cert"
```

**Pros:** Centralized management, automated rotation (~4h poll), audit trail, single source of truth.
**Cons:** Requires Key Vault setup, managed identity and RBAC configuration.

---

### Certificate Rotation

| Method | How to rotate |
|--------|---------------|
| **Direct PFX** | Re-upload new PFX via Portal or CLI (manual) |
| **Key Vault (versioned)** | Import new cert to KV, then update App GW to point to new version |
| **Key Vault (versionless)** | Import new cert to KV — App GW auto-picks it up within ~4 hours |

To force immediate rotation with Key Vault (versionless):
1. Import the new certificate into Key Vault
2. Azure Portal → App Gateway → **Stop** then **Start** (or via CLI: `az network application-gateway stop/start`)

> Terraform will **not** interfere with any rotation method — `ssl_certificate` changes are ignored.
