<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TerraformModules | AI Services Hub</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <style>
        :root {
            --bc-blue: #003366;
            --bc-gold: #fcba19;
            --bc-blue-dark: #002244;
            --bc-blue-light: #1a5a96;
            --text-primary: #313132;
            --text-secondary: #606060;
            --bg-light: #f2f2f2;
            --white: #ffffff;
            --gradient-hero: linear-gradient(135deg, #003366 0%, #1a5a96 50%, #003366 100%);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'BC Sans', 'Noto Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .bc-header {
            background: var(--gradient-hero);
            border-bottom: 4px solid var(--bc-gold);
            padding: 0.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .bc-header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }

        .bc-header-logo {
            height: 36px;
            width: auto;
            border-radius: 4px;
        }

        .bc-header-title {
            color: var(--white);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .bc-header-subtitle {
            color: var(--bc-gold);
            font-size: 0.875rem;
        }

        /* Navigation with Dropdowns */
        .bc-nav {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .bc-nav > a,
        .nav-dropdown > .nav-trigger {
            color: var(--white);
            text-decoration: none;
            padding: 0.6rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            border: none;
            background: transparent;
            font-family: inherit;
        }

        .bc-nav > a:hover,
        .nav-dropdown:hover > .nav-trigger {
            background: rgba(255,255,255,0.15);
        }

        .bc-nav > a.active {
            background: var(--bc-gold);
            color: var(--bc-blue);
            font-weight: 600;
        }

        /* Dropdown */
        .nav-dropdown {
            position: relative;
        }

        .nav-trigger::after {
            content: '';
            border: solid currentColor;
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(45deg);
            margin-top: -3px;
            transition: transform 0.2s;
        }

        .nav-dropdown:hover .nav-trigger::after {
            transform: rotate(-135deg);
            margin-top: 3px;
        }

        .nav-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .nav-dropdown:hover .nav-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nav-dropdown-menu a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-dropdown-menu a:hover {
            background: var(--bg-light);
            border-left-color: var(--bc-gold);
            color: var(--bc-blue);
        }

        .nav-dropdown-menu a.active {
            background: #fef9e7;
            border-left-color: var(--bc-gold);
            border-left-width: 4px;
            color: var(--bc-blue);
            font-weight: 600;
        }

        .nav-dropdown-menu a small {
            display: block;
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 0.2rem;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
            width: 100%;
        }

        /* Hero Section */
        .hero {
            background: var(--gradient-hero);
            color: var(--white);
            padding: 3rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .hero h1 {
            color: var(--white);
            border: none;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Typography */
        h1 {
            color: var(--bc-blue);
            font-size: 2.25rem;
            margin-bottom: 1rem;
            border-bottom: 3px solid var(--bc-gold);
            padding-bottom: 0.5rem;
        }

        h2 {
            color: var(--bc-blue);
            font-size: 1.5rem;
            margin: 2rem 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 1.5rem;
            background: var(--bc-gold);
            border-radius: 2px;
        }

        h3 {
            color: var(--bc-blue-light);
            font-size: 1.25rem;
            margin: 1.5rem 0 0.75rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* Cards - Enhanced */
        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--bc-blue);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-gold {
            border-left-color: var(--bc-gold);
        }

        .card h3 {
            margin-top: 0;
        }

        /* Clickable Cards */
        a.card-link {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        a.card-link .card {
            cursor: pointer;
        }

        a.card-link .card:hover {
            border-left-width: 6px;
        }

        .card-arrow {
            color: var(--bc-blue-light);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            transition: var(--transition);
        }

        a.card-link:hover .card-arrow {
            gap: 0.75rem;
            color: var(--bc-blue);
        }

        /* Feature Cards */
        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .feature-icon.gold { background: rgba(252, 186, 25, 0.15); }
        .feature-icon.blue { background: rgba(0, 51, 102, 0.1); }
        .feature-icon.green { background: rgba(34, 197, 94, 0.1); }
        .feature-icon.purple { background: rgba(139, 92, 246, 0.1); }

        /* Stats */
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--bc-gold);
            line-height: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Code blocks */
        pre {
            background: var(--bc-blue-dark);
            color: #e2e8f0;
            padding: 1.25rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.875rem;
            box-shadow: var(--shadow-sm);
        }

        code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: #e2e8f0;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        pre code {
            background: none;
            padding: 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        th {
            background: var(--bc-blue);
            color: var(--white);
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f8fafc;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        /* Links */
        a {
            color: var(--bc-blue-light);
            transition: var(--transition);
        }

        a:hover {
            color: var(--bc-blue);
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert > * {
            min-width: 0;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-info {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-left: 4px solid #0ea5e9;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--bc-gold);
        }

        .alert-success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left: 4px solid #22c55e;
        }

        /* Image containers */
        .img-container {
            margin: 1.5rem 0;
            text-align: center;
        }

        .img-container img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-gold {
            background: var(--bc-gold);
            color: var(--bc-blue);
        }

        .badge-blue {
            background: var(--bc-blue);
            color: var(--white);
        }

        /* Accordion / Collapsible */
        details {
            background: var(--white);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--bc-blue);
            overflow: hidden;
            transition: var(--transition);
        }

        details:hover {
            box-shadow: var(--shadow-md);
        }

        details[open] {
            border-left-color: var(--bc-gold);
        }

        summary {
            padding: 1rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--bc-blue);
            display: flex;
            align-items: center;
            justify-content: space-between;
            list-style: none;
            user-select: none;
            transition: var(--transition);
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::after {
            content: '';
            border: solid var(--bc-blue-light);
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 4px;
            transform: rotate(-45deg);
            transition: transform 0.2s ease;
            flex-shrink: 0;
            margin-left: 1rem;
        }

        details[open] summary::after {
            transform: rotate(45deg);
        }

        summary:hover {
            background: var(--bg-light);
        }

        details[open] summary {
            border-bottom: 1px solid #e2e8f0;
            background: var(--bg-light);
        }

        .accordion-content {
            padding: 1rem 1.25rem;
        }

        .accordion-content p:last-child {
            margin-bottom: 0;
        }

        /* Accordion with badge */
        summary .badge {
            margin-left: auto;
            margin-right: 1rem;
        }

        /* Accordion group */
        .accordion-group {
            margin: 1rem 0;
        }

        .accordion-group details:last-child {
            margin-bottom: 0;
        }

        /* Footer */
        .site-footer {
            background: var(--bc-blue);
            color: var(--white);
            padding: 3rem 2rem;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }

        .footer-brand h4,
        .footer-links h4 {
            color: var(--bc-gold);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .footer-brand p {
            color: #94a3b8;
            font-size: 0.875rem;
            margin: 0;
        }

        .footer-links ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-links li {
            margin-bottom: 0.5rem;
        }

        .footer-links a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .footer-links a:hover {
            color: var(--bc-gold);
        }

        .footer-copyright {
            text-align: right;
        }

        .footer-copyright p {
            color: #64748b;
            font-size: 0.75rem;
            margin: 0;
        }

        .footer-meta {
            margin-top: 0.5rem !important;
            opacity: 0.7;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .bc-header {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }

            .bc-nav {
                justify-content: center;
            }

            .nav-dropdown-menu {
                position: fixed;
                left: 1rem;
                right: 1rem;
                width: auto;
            }

            main {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .hero {
                padding: 2rem 1rem;
            }

            .hero h1 {
                font-size: 1.75rem;
            }

            .footer-content {
                text-align: center;
            }

            .footer-copyright {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header class="bc-header">
        <a href="index.html" class="bc-header-brand">
            <img src="assets/bc_citz_logo.jpg" alt="BC Government" class="bc-header-logo">
            <div>
                <div class="bc-header-title">AI Services Hub</div>
                <div class="bc-header-subtitle">Azure Landing Zone Infrastructure</div>
            </div>
        </a>
        <nav class="bc-nav">
            <a href="index.html" class="">Home</a>
            <div class="nav-dropdown">
                <span class="nav-trigger">For Tenants</span>
                <div class="nav-dropdown-menu">
                    <a href="services.html" class="">
                        AI Services
                        <small>Available models &amp; services catalogue</small>
                    </a>
                    <a href="language-service-pii.html" class="">
                        Language Service PII
                        <small>ML-based PII detection &amp; APIM</small>
                    </a>
                    <a href="apim-internal-endpoints.html" class="">
                        APIM Internal Endpoints
                        <small>tenant-info &amp; apim-keys API reference</small>
                    </a>
                    <a href="apim-key-rotation.html" class="">
                        APIM Key Rotation
                        <small>Subscription key auto-rotation</small>
                    </a>
                </div>
            </div>
            <div class="nav-dropdown">
                <span class="nav-trigger">For AI Hub Admins</span>
                <div class="nav-dropdown-menu">
                    <a href="playbooks.html" class="">
                        Playbooks
                        <small>Operational runbooks &amp; how-to guides</small>
                    </a>
                    <a href="oidc-setup.html" class="">
                        OIDC Setup
                        <small>GitHub to Azure authentication</small>
                    </a>
                    <a href="workflows.html" class="">
                        GitHub Workflows
                        <small>CI/CD automation</small>
                    </a>
                    <a href="terraform-reference.html" class="">
                        TF Reference
                        <small>Auto-generated from code</small>
                    </a>
                    <a href="technical-deep-dive.html" class="">
                        Technical Deep Dive
                        <small>Control/data plane &amp; Chisel architecture</small>
                    </a>
                </div>
            </div>
            <a href="diagrams.html" class="">Diagrams</a>
            <a href="decisions.html" class="">ADRs</a>
            <a href="cost.html" class="">Cost</a>
            <a href="faq.html" class="">FAQ</a>
        </nav>
    </header>
    <main>

<h1>Terraform Modules</h1>

<p>This project uses modular Terraform configuration for Azure Landing Zone infrastructure. Each module is designed to be reusable and follows Azure best practices.</p>

<h2>Module Overview</h2>

<table>
    <thead>
        <tr>
            <th>Module</th>
            <th>Purpose</th>
            <th>Key Resources</th>
            <th>Optional?</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>network</strong></td>
            <td>VNet subnets and NSG configuration</td>
            <td>Subnets, Network Security Groups</td>
            <td><strong>No</strong></td>
        </tr>
        <tr>
            <td><strong>monitoring</strong></td>
            <td>Observability with Log Analytics & Application Insights</td>
            <td>Log Analytics Workspace, App Insights</td>
            <td>No</td>
        </tr>
        <tr>
            <td><strong>bastion</strong></td>
            <td>Secure VM access without public IPs</td>
            <td>Azure Bastion Host, Public IP</td>
            <td>Yes (<code>enable_bastion</code>)</td>
        </tr>
        <tr>
            <td><strong>jumpbox</strong></td>
            <td>Development VM with CLI tools</td>
            <td>Linux VM, SSH Keys, Auto-shutdown</td>
            <td>Yes (<code>enable_jumpbox</code>)</td>
        </tr>
        <tr>
            <td><strong>github-runners-aca</strong></td>
            <td>Self-hosted GitHub runners on Container Apps</td>
            <td>Container Apps Environment, Container Job, ACR</td>
            <td>Yes (<code>github_runners_aca_enabled</code>)</td>
        </tr>
        <tr>
            <td><strong>azure-proxy</strong></td>
            <td>Secure tunnel (chisel) for proxying to peered networks</td>
            <td>App Service, Container Image</td>
            <td>Yes (<code>enable_azure_proxy</code>)</td>
        </tr>
    </tbody>
</table>

<div class="alert alert-info">
    <strong>Optional Modules:</strong> Modules marked as optional can be toggled on/off using their respective variables. Set them in <code>terraform.tfvars</code> or as environment variables.
</div>

<h2>Deployment Script: deploy-terraform.sh</h2>

<p>A wrapper script that simplifies Terraform operations with proper Azure authentication. Features auto-import of conflicting resources and intelligent retry logic.</p>

<h3>Usage</h3>

<pre>./initial-setup/infra/deploy-terraform.sh <command> [options]

Commands:
  init     Initialize Terraform with backend configuration
  plan     Preview infrastructure changes
  apply    Apply infrastructure changes (with auto-import & retry)
  destroy  Destroy all infrastructure
  output   Display Terraform outputs</pre>

<div class="card card-gold">
    <h3>Smart Apply Logic</h3>
    <p>The <code>apply</code> command now includes:</p>
    <ul>
        <li><strong>Auto-detection</strong>: Detects "already exists" errors from Azure</li>
        <li><strong>Automatic import</strong>: Imports conflicting resources into Terraform state</li>
        <li><strong>Retry on success</strong>: Reruns apply after successful import (max 3 attempts)</li>
        <li><strong>Clear failure messages</strong>: Shows which resource was imported or why the apply failed</li>
    </ul>
</div>

<h3>Examples</h3>

<div class="grid grid-2">
    <div class="card">
        <h3>Full Deployment</h3>
        <pre>./initial-setup/infra/deploy-terraform.sh init
./initial-setup/infra/deploy-terraform.sh plan
./initial-setup/infra/deploy-terraform.sh apply</pre>
    </div>
    <div class="card">
        <h3>Target Specific Module</h3>
        <pre># Deploy only bastion
./initial-setup/infra/deploy-terraform.sh apply \
  -target=module.bastion

# Deploy only jumpbox
./initial-setup/infra/deploy-terraform.sh apply \
  -target=module.jumpbox</pre>
    </div>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Monitoring Module</h2>

<p>Provides centralized observability across all deployed resources using Azure Monitor services.</p>

<div class="card">
    <h3>Resources Created</h3>
    <ul>
        <li><strong>Log Analytics Workspace</strong>: Central logs and metrics repository (default retention: 30 days, configurable)</li>
        <li><strong>Application Insights</strong>: APM for applications, connected to Log Analytics workspace</li>
    </ul>
</div>

<div class="card card-gold">
    <h3>Key Variables</h3>
    <table>
        <thead>
            <tr>
                <th>Variable</th>
                <th>Default</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>log_analytics_sku</code></td>
                <td>PerGB2018</td>
                <td>Log Analytics pricing tier</td>
            </tr>
            <tr>
                <td><code>log_analytics_retention_days</code></td>
                <td>30</td>
                <td>Data retention period in days</td>
            </tr>
        </tbody>
    </table>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Network Module</h2>

<p>Configures subnets within an existing VNet and creates Network Security Groups (NSGs) for traffic control.</p>

<div class="card">
    <h3>Subnets Created</h3>
    <table>
        <thead>
            <tr>
                <th>Subnet</th>
                <th>Purpose</th>
                <th>Delegation</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>AzureBastionSubnet</code></td>
                <td>Azure Bastion service</td>
                <td>None (required name)</td>
            </tr>
            <tr>
                <td><code>jumpbox-subnet</code></td>
                <td>Jumpbox VM</td>
                <td>None</td>
            </tr>
            <tr>
                <td><code>privateendpoints-subnet</code></td>
                <td>Private Endpoints for Azure services</td>
                <td>None</td>
            </tr>
            <tr>
                <td><code>app-service-subnet</code></td>
                <td>App Service VNet integration</td>
                <td>Microsoft.Web/serverFarms</td>
            </tr>
            <tr>
                <td><code>container-instance-subnet</code></td>
                <td>Azure Container Instances</td>
                <td>Microsoft.ContainerInstance/containerGroups</td>
            </tr>
            <tr>
                <td><code>container-apps-subnet</code></td>
                <td>Azure Container Apps Environment</td>
                <td>Microsoft.App/environments</td>
            </tr>
            <tr>
                <td><code>apim-subnet</code></td>
                <td>Azure API Management</td>
                <td>Microsoft.Web/serverFarms</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card card-gold">
    <h3>Network Security Groups</h3>
    <p>Each subnet has a dedicated NSG with rules for:</p>
    <ul>
        <li><strong>Bastion NSG</strong>: HTTPS inbound, Gateway Manager, SSH/RDP to VNet</li>
        <li><strong>Jumpbox NSG</strong>: SSH/RDP from Bastion only, outbound to Private Endpoints</li>
        <li><strong>App Service NSG</strong>: HTTP/HTTPS from internet, communication with Private Endpoints</li>
        <li><strong>Container Apps NSG</strong>: Load Balancer, HTTP/HTTPS, Private Endpoint access</li>
        <li><strong>APIM NSG</strong>: API Management traffic, backend service access</li>
    </ul>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Bastion Module</h2>

<p>Deploys Azure Bastion for secure, browser-based SSH/RDP access to VMs without exposing public IPs.</p>

<div class="grid grid-2">
    <div class="card">
        <h3>Resources Created</h3>
        <ul>
            <li><strong>Public IP</strong>: Static, Standard SKU (required for Bastion)</li>
            <li><strong>Bastion Host</strong>: Basic SKU for cost optimization</li>
        </ul>
    </div>
    <div class="card">
        <h3>Features</h3>
        <ul>
            <li>Web-based SSH/RDP from Azure Portal</li>
            <li>No public IPs needed on VMs</li>
            <li>TLS encryption for all sessions</li>
            <li>NSG rules per Microsoft requirements</li>
        </ul>
    </div>
</div>

<div class="alert alert-info">
    <strong>Cost Tip:</strong> Azure Bastion has hourly charges. Use the <code>add-or-remove-module.yml</code> workflow to deploy/destroy Bastion on demand.
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Jumpbox Module</h2>

<p>Creates a Linux VM for development and administration tasks, pre-configured with essential CLI tools.</p>

<div class="card">
    <h3>VM Configuration</h3>
    <table>
        <thead>
            <tr>
                <th>Setting</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>OS</td>
                <td>Ubuntu 24.04 LTS (Noble Numbat)</td>
            </tr>
            <tr>
                <td>Size</td>
                <td>B-series burstable (configurable)</td>
            </tr>
            <tr>
                <td>Authentication</td>
                <td>SSH Key (auto-generated, stored in <code>sensitive/</code>)</td>
            </tr>
            <tr>
                <td>Public IP</td>
                <td>None (access via Bastion only)</td>
            </tr>
            <tr>
                <td>Identity</td>
                <td>System-assigned managed identity</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card card-gold">
    <h3>Pre-installed Tools</h3>
    <p>The VM is bootstrapped with cloud-init to install:</p>
    <div class="grid grid-3">
        <div>
            <strong>Azure & Cloud</strong>
            <ul>
                <li>Azure CLI</li>
                <li>Terraform</li>
                <li>kubectl</li>
            </ul>
        </div>
        <div>
            <strong>Development</strong>
            <ul>
                <li>Docker & Compose</li>
                <li>GitHub CLI</li>
                <li>Python 3 & pip</li>
            </ul>
        </div>
        <div>
            <strong>Utilities</strong>
            <ul>
                <li>git, vim, tmux</li>
                <li>jq, curl, wget</li>
                <li>htop, net-tools</li>
            </ul>
        </div>
    </div>
</div>

<div class="card">
    <h3>Auto-Shutdown & Start</h3>
    <p>Cost optimization through scheduled operations:</p>
    <table>
        <thead>
            <tr>
                <th>Schedule</th>
                <th>Time</th>
                <th>Method</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Auto-Shutdown</strong></td>
                <td>7:00 PM PST daily</td>
                <td>Azure Dev/Test shutdown schedule</td>
            </tr>
            <tr>
                <td><strong>Auto-Start</strong></td>
                <td>8:00 AM PST Mon-Fri</td>
                <td>Azure Automation Runbook (Python3)</td>
            </tr>
        </tbody>
    </table>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Azure Proxy Module (Chisel Tunnel)</h2>

<p>Deploys a <strong>Chisel</strong> secure tunnel server for accessing private Azure resources (data plane) from your local machine. This solves the problem of accessing private endpoints when you're outside the VNet.</p>

<div class="alert alert-info">
    <strong>Why Chisel?</strong> Private endpoints block data plane access from the public internet. Chisel creates an HTTPS tunnel through an App Service (which has VNet integration) to reach Key Vault secrets, databases, and other private resources from your laptop.
</div>

<div class="grid grid-2">
    <div class="card">
        <h3>Resources Created</h3>
        <ul>
            <li><strong>App Service Plan</strong>: Linux plan hosting the tunnel (configurable SKU)</li>
            <li><strong>Web App</strong>: Runs containerized Chisel server with VNet integration</li>
            <li><strong>Random Credentials</strong>: Auto-generated username/password for tunnel auth</li>
            <li><strong>Application Insights</strong>: Connection logging and monitoring</li>
        </ul>
    </div>
    <div class="card card-gold">
        <h3>Security Features</h3>
        <ul>
            <li><strong>HTTPS Only</strong>: TLS 1.3 minimum</li>
            <li><strong>Mandatory Auth</strong>: Random credentials stored in App Settings</li>
            <li><strong>Health Checks</strong>: Automatic restart on failure</li>
            <li><strong>Logging</strong>: All connections logged to App Insights</li>
        </ul>
    </div>
</div>

<div class="card">
    <h3>Key Variables</h3>
    <table>
        <thead>
            <tr>
                <th>Variable</th>
                <th>Default</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>enable_azure_proxy</code></td>
                <td>false</td>
                <td>Enable/disable Chisel deployment</td>
            </tr>
            <tr>
                <td><code>azure_proxy_image</code></td>
                <td>-</td>
                <td>Container image URI (built by pr-open workflow)</td>
            </tr>
            <tr>
                <td><code>app_service_sku_name_azure_proxy</code></td>
                <td>B1</td>
                <td>App Service plan SKU</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card" style="border-left-color: #8b5cf6;">
    <h3>Usage Example</h3>
    <p>After deployment, connect from your laptop:</p>
    <pre># Get credentials from Terraform output
terraform output azure_proxy_chisel_auth
terraform output azure_proxy_url

# Connect to private PostgreSQL database
docker run --rm -it -p 5432:5432 jpillora/chisel:latest client \
  --auth "tunnel:XXXXXXXX" \
  https://your-app.azurewebsites.net \
  0.0.0.0:5432:private-postgres.postgres.database.azure.com:5432

# Now connect locally
psql -h localhost -p 5432 -U admin -d mydb</pre>
    <p>See <a href="playbooks.html#chisel-tunnel">Chisel Tunnel Playbook</a> for detailed instructions.</p>
</div>

<div class="alert alert-warning">
    <strong>Platform Maintainers Only:</strong> Chisel is for the platform team to access private resources. Tenant developers should use APIM/App Gateway endpoints designed for their applications.
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Choosing Your Access Method</h2>

<p>The infrastructure provides <strong>four interchangeable access methods</strong> for reaching Azure resources. Enable only what you need - all are optional and controlled via Terraform variables.</p>

<div class="alert alert-success">
    <strong>Understanding Control vs Data Plane:</strong> OIDC authentication works for <em>control plane</em> (creating resources) but <em>not</em> data plane (accessing secrets, blobs, databases) when private endpoints are enabled. See <a href="decisions.html#adr-011">ADR-011</a> for details.
</div>

<table>
    <thead>
        <tr>
            <th>Access Method</th>
            <th>Toggle Variable</th>
            <th>Control Plane</th>
            <th>Data Plane</th>
            <th>Best For</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Public GitHub Runners</strong></td>
            <td><em>(default, no toggle)</em></td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td style="color: #ef4444;">&#10007; No</td>
            <td>Resource deployments only</td>
        </tr>
        <tr>
            <td><strong>Self-Hosted Runners</strong></td>
            <td><code>github_runners_aca_enabled</code></td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td>Tenant CI/CD pipelines needing VNet access</td>
        </tr>
        <tr>
            <td><strong>Bastion + Jumpbox</strong></td>
            <td><code>enable_bastion</code> + <code>enable_jumpbox</code></td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td>Admin access, debugging</td>
        </tr>
        <tr>
            <td><strong>Chisel Tunnel</strong></td>
            <td><code>enable_azure_proxy</code></td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td>Local dev access from laptop</td>
        </tr>
    </tbody>
</table>

<div class="grid grid-2">
    <div class="card">
        <h3>Example: Minimal (Control Plane Only)</h3>
        <pre># terraform.tfvars
enable_bastion              = false
enable_jumpbox              = false
enable_azure_proxy          = false
github_runners_aca_enabled  = false

# Uses public GitHub runners
# Good for: Resource-only Terraform</pre>
    </div>
    <div class="card card-gold">
        <h3>Example: Full Access</h3>
        <pre># terraform.tfvars
enable_bastion              = true
enable_jumpbox              = true
enable_azure_proxy          = true
github_runners_aca_enabled  = true

# All access methods available
# Good for: Platform maintainers</pre>
    </div>
</div>

<div class="card" style="border-left-color: #0ea5e9;">
    <h3>Recommended Setup by Role</h3>
    <table>
        <tr>
            <td><strong>Platform Maintainers</strong></td>
            <td>Enable all: Bastion + Jumpbox for admin, Chisel for local dev, Self-hosted for CI/CD</td>
        </tr>
        <tr>
            <td><strong>Project Developers</strong></td>
            <td>No direct access needed - use APIM/App Gateway endpoints provided by platform</td>
        </tr>
        <tr>
            <td><strong>Cost-Conscious</strong></td>
            <td>Chisel only (<code>enable_azure_proxy</code>) - cheapest option with data plane access</td>
        </tr>
    </table>
</div>

<p>See <a href="diagrams.html#access-methods">Access Methods Architecture Diagram</a> for a visual overview.</p>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Backend Configuration</h2>

<p>Terraform state is stored in Azure Blob Storage with Azure AD authentication.</p>

<pre># infra/backend.tf
terraform {
  backend "azurerm" {
    resource_group_name  = "your-resource-group"
    storage_account_name = "tfstateaccount"
    container_name       = "tfstate"
    key                  = "terraform.tfstate"
    use_azuread_auth     = true  # Required for OIDC
  }
}</pre>

<div class="alert alert-warning">
    <strong>Important:</strong> The <code>use_azuread_auth = true</code> setting is required when using OIDC authentication. Without it, Terraform will fail to access the state file.
</div>

<h2>Variables Reference</h2>

<p>Key variables used across modules:</p>

<table>
    <thead>
        <tr>
            <th>Variable</th>
            <th>Description</th>
            <th>Source</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>app_name</code></td>
            <td>Application name prefix for resources</td>
            <td>Environment variable</td>
        </tr>
        <tr>
            <td><code>app_env</code></td>
            <td>Environment (dev, test, prod)</td>
            <td>GitHub Environment</td>
        </tr>
        <tr>
            <td><code>location</code></td>
            <td>Azure region</td>
            <td>Default: Canada Central</td>
        </tr>
        <tr>
            <td><code>resource_group_name</code></td>
            <td>Target resource group</td>
            <td>Environment variable</td>
        </tr>
        <tr>
            <td><code>vnet_name</code></td>
            <td>Existing VNet name</td>
            <td>GitHub Secret</td>
        </tr>
        <tr>
            <td><code>vnet_address_space</code></td>
            <td>VNet CIDR for subnet calculation</td>
            <td>GitHub Secret</td>
        </tr>
    </tbody>
</table>
    </main>
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-brand">
                <h4>AI Services Hub</h4>
                <p>Infrastructure as Code for Azure Landing Zone deployments</p>
            </div>
            <div class="footer-links">
                <h4>Resources</h4>
                <ul>
                    <li><a href="https://github.com/bcgov/ai-hub-tracking">GitHub Repository</a></li>
                    <li><a href="assets/azure-oidc-complete-guide.svg" target="_blank">Architecture Diagram</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>Documentation</h4>
                <ul>
                    <li><a href="services.html">AI Services</a></li>
                    <li><a href="diagrams.html">Architecture Diagrams</a></li>
                    <li><a href="playbooks.html">Playbooks</a></li>
                    <li><a href="decisions.html">ADRs</a></li>
                    <li><a href="faq.html">FAQ</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>BC Government</h4>
                <ul>
                    <li><a href="https://www2.gov.bc.ca">gov.bc.ca</a></li>
                    <li><a href="https://digital.gov.bc.ca">Digital Office</a></li>
                </ul>
            </div>
            <div class="footer-copyright">
                <p>&copy; 2026 Province of British Columbia</p>
                <p class="footer-meta">Built with zero dependencies</p>
            </div>
        </div>
    </footer>

    <script>
        (function () {
            function scrollToWithHeaderOffset(el) {
                if (!el) return;
                const header = document.querySelector('.bc-header');
                const offset = (header ? header.getBoundingClientRect().height : 0) + 16;

                const top = el.getBoundingClientRect().top + window.scrollY - offset;
                window.scrollTo({ top: Math.max(0, top) });
            }

            function openDetailsFromHash() {
                const hash = window.location.hash;
                if (!hash || hash.length < 2) return;

                const id = hash.substring(1);
                const el = document.getElementById(id);
                if (el && el.tagName && el.tagName.toLowerCase() === 'details') {
                    el.open = true;
                    // Opening can change layout; adjust scroll after paint so the
                    // sticky header doesn't cover the <summary> title.
                    requestAnimationFrame(function () {
                        requestAnimationFrame(function () {
                            scrollToWithHeaderOffset(el);
                        });
                    });
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                openDetailsFromHash();
            });

            window.addEventListener('hashchange', function () {
                openDetailsFromHash();
            });

            // If user clicks the same #hash twice, hashchange won't fire.
            // This ensures ADR links always expand.
            document.addEventListener('click', function (e) {
                const link = e.target.closest && e.target.closest('a[href^="#"]');
                if (!link) return;

                const href = link.getAttribute('href');
                if (!href || href.length < 2) return;

                const id = href.substring(1);
                const el = document.getElementById(id);
                if (el && el.tagName && el.tagName.toLowerCase() === 'details') {
                    el.open = true;
                    requestAnimationFrame(function () {
                        requestAnimationFrame(function () {
                            scrollToWithHeaderOffset(el);
                        });
                    });
                }
            });
        })();
    </script>
</body>
</html>
