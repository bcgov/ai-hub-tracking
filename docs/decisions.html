<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchitectureDecisions | AI Hub Tracking</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <style>
        :root {
            --bc-blue: #003366;
            --bc-gold: #fcba19;
            --bc-blue-dark: #002244;
            --bc-blue-light: #1a5a96;
            --text-primary: #313132;
            --text-secondary: #606060;
            --bg-light: #f2f2f2;
            --white: #ffffff;
            --gradient-hero: linear-gradient(135deg, #003366 0%, #1a5a96 50%, #003366 100%);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'BC Sans', 'Noto Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .bc-header {
            background: var(--gradient-hero);
            border-bottom: 4px solid var(--bc-gold);
            padding: 0.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .bc-header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }

        .bc-header-logo {
            height: 36px;
            width: auto;
            border-radius: 4px;
        }

        .bc-header-title {
            color: var(--white);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .bc-header-subtitle {
            color: var(--bc-gold);
            font-size: 0.875rem;
        }

        /* Navigation with Dropdowns */
        .bc-nav {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .bc-nav > a,
        .nav-dropdown > .nav-trigger {
            color: var(--white);
            text-decoration: none;
            padding: 0.6rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            border: none;
            background: transparent;
            font-family: inherit;
        }

        .bc-nav > a:hover,
        .nav-dropdown:hover > .nav-trigger {
            background: rgba(255,255,255,0.15);
        }

        .bc-nav > a.active {
            background: var(--bc-gold);
            color: var(--bc-blue);
            font-weight: 600;
        }

        /* Dropdown */
        .nav-dropdown {
            position: relative;
        }

        .nav-trigger::after {
            content: '';
            border: solid currentColor;
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(45deg);
            margin-top: -3px;
            transition: transform 0.2s;
        }

        .nav-dropdown:hover .nav-trigger::after {
            transform: rotate(-135deg);
            margin-top: 3px;
        }

        .nav-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .nav-dropdown:hover .nav-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nav-dropdown-menu a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-dropdown-menu a:hover {
            background: var(--bg-light);
            border-left-color: var(--bc-gold);
            color: var(--bc-blue);
        }

        .nav-dropdown-menu a small {
            display: block;
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 0.2rem;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
            width: 100%;
        }

        /* Hero Section */
        .hero {
            background: var(--gradient-hero);
            color: var(--white);
            padding: 3rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .hero h1 {
            color: var(--white);
            border: none;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Typography */
        h1 {
            color: var(--bc-blue);
            font-size: 2.25rem;
            margin-bottom: 1rem;
            border-bottom: 3px solid var(--bc-gold);
            padding-bottom: 0.5rem;
        }

        h2 {
            color: var(--bc-blue);
            font-size: 1.5rem;
            margin: 2rem 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 1.5rem;
            background: var(--bc-gold);
            border-radius: 2px;
        }

        h3 {
            color: var(--bc-blue-light);
            font-size: 1.25rem;
            margin: 1.5rem 0 0.75rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* Cards - Enhanced */
        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--bc-blue);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-gold {
            border-left-color: var(--bc-gold);
        }

        .card h3 {
            margin-top: 0;
        }

        /* Clickable Cards */
        a.card-link {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        a.card-link .card {
            cursor: pointer;
        }

        a.card-link .card:hover {
            border-left-width: 6px;
        }

        .card-arrow {
            color: var(--bc-blue-light);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            transition: var(--transition);
        }

        a.card-link:hover .card-arrow {
            gap: 0.75rem;
            color: var(--bc-blue);
        }

        /* Feature Cards */
        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .feature-icon.gold { background: rgba(252, 186, 25, 0.15); }
        .feature-icon.blue { background: rgba(0, 51, 102, 0.1); }
        .feature-icon.green { background: rgba(34, 197, 94, 0.1); }
        .feature-icon.purple { background: rgba(139, 92, 246, 0.1); }

        /* Stats */
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--bc-gold);
            line-height: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Code blocks */
        pre {
            background: var(--bc-blue-dark);
            color: #e2e8f0;
            padding: 1.25rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.875rem;
            box-shadow: var(--shadow-sm);
        }

        code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: #e2e8f0;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        pre code {
            background: none;
            padding: 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        th {
            background: var(--bc-blue);
            color: var(--white);
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f8fafc;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        /* Links */
        a {
            color: var(--bc-blue-light);
            transition: var(--transition);
        }

        a:hover {
            color: var(--bc-blue);
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-info {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-left: 4px solid #0ea5e9;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--bc-gold);
        }

        .alert-success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left: 4px solid #22c55e;
        }

        /* Image containers */
        .img-container {
            margin: 1.5rem 0;
            text-align: center;
        }

        .img-container img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-gold {
            background: var(--bc-gold);
            color: var(--bc-blue);
        }

        .badge-blue {
            background: var(--bc-blue);
            color: var(--white);
        }

        /* Accordion / Collapsible */
        details {
            background: var(--white);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--bc-blue);
            overflow: hidden;
            transition: var(--transition);
        }

        details:hover {
            box-shadow: var(--shadow-md);
        }

        details[open] {
            border-left-color: var(--bc-gold);
        }

        summary {
            padding: 1rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--bc-blue);
            display: flex;
            align-items: center;
            justify-content: space-between;
            list-style: none;
            user-select: none;
            transition: var(--transition);
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::after {
            content: '';
            border: solid var(--bc-blue-light);
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 4px;
            transform: rotate(-45deg);
            transition: transform 0.2s ease;
            flex-shrink: 0;
            margin-left: 1rem;
        }

        details[open] summary::after {
            transform: rotate(45deg);
        }

        summary:hover {
            background: var(--bg-light);
        }

        details[open] summary {
            border-bottom: 1px solid #e2e8f0;
            background: var(--bg-light);
        }

        .accordion-content {
            padding: 1rem 1.25rem;
        }

        .accordion-content p:last-child {
            margin-bottom: 0;
        }

        /* Accordion with badge */
        summary .badge {
            margin-left: auto;
            margin-right: 1rem;
        }

        /* Accordion group */
        .accordion-group {
            margin: 1rem 0;
        }

        .accordion-group details:last-child {
            margin-bottom: 0;
        }

        /* Footer */
        .site-footer {
            background: var(--bc-blue);
            color: var(--white);
            padding: 3rem 2rem;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }

        .footer-brand h4,
        .footer-links h4 {
            color: var(--bc-gold);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .footer-brand p {
            color: #94a3b8;
            font-size: 0.875rem;
            margin: 0;
        }

        .footer-links ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-links li {
            margin-bottom: 0.5rem;
        }

        .footer-links a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .footer-links a:hover {
            color: var(--bc-gold);
        }

        .footer-copyright {
            text-align: right;
        }

        .footer-copyright p {
            color: #64748b;
            font-size: 0.75rem;
            margin: 0;
        }

        .footer-meta {
            margin-top: 0.5rem !important;
            opacity: 0.7;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .bc-header {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }

            .bc-nav {
                justify-content: center;
            }

            .nav-dropdown-menu {
                position: fixed;
                left: 1rem;
                right: 1rem;
                width: auto;
            }

            main {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .hero {
                padding: 2rem 1rem;
            }

            .hero h1 {
                font-size: 1.75rem;
            }

            .footer-content {
                text-align: center;
            }

            .footer-copyright {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header class="bc-header">
        <a href="index.html" class="bc-header-brand">
            <img src="assets/bc_citz_logo.jpg" alt="BC Government" class="bc-header-logo">
            <div>
                <div class="bc-header-title">AI Hub Tracking</div>
                <div class="bc-header-subtitle">Azure Landing Zone Infrastructure</div>
            </div>
        </a>
        <nav class="bc-nav">
            <a href="index.html" class="">Home</a>
            <div class="nav-dropdown">
                <span class="nav-trigger">Guides</span>
                <div class="nav-dropdown-menu">
                    <a href="oidc-setup.html">
                        OIDC Setup
                        <small>GitHub to Azure authentication</small>
                    </a>
                    <a href="terraform.html">
                        Terraform Modules
                        <small>Network, Bastion, Jumpbox</small>
                    </a>
                    <a href="workflows.html">
                        GitHub Workflows
                        <small>CI/CD automation</small>
                    </a>
                    <a href="terraform-reference.html">
                        TF Reference
                        <small>Auto-generated from code</small>
                    </a>
                </div>
            </div>
            <a href="diagrams.html" class="">Diagrams</a>
            <a href="playbooks.html" class="">Playbooks</a>
            <a href="decisions.html" class="">ADRs</a>
            <a href="faq.html" class="">FAQ</a>
        </nav>
    </header>
    <main>
<!-- TITLE: Architecture Decisions -->
<!-- NAV: decisions -->

<h1>Architecture Decision Records</h1>

<p>This page documents key architectural decisions for the AI Hub Tracking infrastructure. Each ADR explains the context, decision, and consequences to help future maintainers understand why things are built the way they are.</p>

<div class="alert alert-warning">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10Z"/></svg>
    </div>
    <div>
        <strong>BC Government Policy Context</strong><br>
        Most decisions documented here are <strong>driven by BC Government security policies</strong>, not optional architectural choices. Key policy constraints include:
        <ul style="margin: 0.5rem 0 0 0;">
            <li><strong>No public endpoints</strong> - All Azure services must use private endpoints only</li>
            <li><strong>Private networking required</strong> - Resources must be isolated within VNets</li>
            <li><strong>No long-lived secrets</strong> - Credential rotation policies favor OIDC/managed identities</li>
            <li><strong>Bastion-only access</strong> - Direct SSH/RDP from internet is prohibited</li>
        </ul>
    </div>
</div>

<div class="card" style="border-left-color: #003366; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
    <h3 style="margin-top: 0; color: var(--bc-blue);">Start Here: ADR-001</h3>
    <p style="margin-bottom: 0;"><strong>ADR-001 (Shared Landing Zone)</strong> is the foundation that explains <em>why</em> all the other infrastructure exists. Read it first to understand the architecture.</p>
</div>

<div class="alert alert-info">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    </div>
    <div>
        <strong>About ADRs</strong><br>
        Architecture Decision Records capture decisions along with their context and consequences. They help prevent re-litigating settled discussions and provide onboarding context for new team members.
    </div>
</div>

<h2>Decision Index</h2>

<table>
    <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Driver</th>
        <th>Status</th>
    </tr>
    <tr>
        <td><a href="#adr-001">ADR-001</a></td>
        <td>Shared Landing Zone with Bastion/Jumpbox</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-002">ADR-002</a></td>
        <td>Use OIDC instead of Service Principal Secrets</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-003">ADR-003</a></td>
        <td>Use Azure Bastion for VM Access</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-004">ADR-004</a></td>
        <td>Private Endpoints for All Azure Services</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-005">ADR-005</a></td>
        <td>Zero-Dependency Documentation System</td>
        <td><span class="badge" style="background:#22c55e;color:white;">Choice</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-006">ADR-006</a></td>
        <td>Multi-Tenant Isolation Model</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-007">ADR-007</a></td>
        <td>Client Connectivity via App Gateway + APIM</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
</table>

<!-- ============================================================================
     ADR-001: Shared Landing Zone Architecture (THE FOUNDATION)
     ============================================================================ -->

<h2 id="adr-001">ADR-001: Shared Landing Zone with Bastion/Jumpbox</h2>

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Architecture</div>
</div>

<div class="alert alert-success">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
    </div>
    <div>
        <strong>This is the foundational ADR.</strong> It explains why we need VNets, Bastion, Jumpbox, and self-hosted runners. All other ADRs build on these concepts.
    </div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    </div>
    <div>
        <strong>Policy Driver:</strong> BC Gov requires all Azure services to use private endpoints only. GitHub Actions runners on the public internet cannot reach private endpoints. This creates a fundamental problem: how do we run Terraform if GitHub can't talk to Azure resources?
    </div>
</div>

<h3>The Problem: Why Can't GitHub Just Run Terraform Directly?</h3>

<div class="card" style="border-left-color: #ef4444;">
    <h4 style="margin-top: 0;">The Network Barrier</h4>
    <p>When you run <code>terraform apply</code> from GitHub Actions, here's what happens:</p>
    <ol>
        <li>GitHub spins up a runner (a VM on Microsoft's public cloud)</li>
        <li>Terraform tries to connect to Azure Storage (for state file)</li>
        <li><strong style="color:#ef4444;">BLOCKED</strong> - Storage has no public endpoint</li>
        <li>Terraform tries to connect to Key Vault, databases, etc.</li>
        <li><strong style="color:#ef4444;">BLOCKED</strong> - All services are private-only</li>
    </ol>
    <p style="margin-bottom:0;"><strong>Result:</strong> Terraform cannot run from the public internet because it can't reach any Azure resources.</p>
</div>

<h3>The Solution: Landing Zone Architecture</h3>

<p>We need infrastructure <strong>inside the private network</strong> that can:</p>
<ul>
    <li>Receive commands from GitHub (via OIDC tokens)</li>
    <li>Run Terraform against private endpoints</li>
    <li>Allow humans to access resources for debugging</li>
</ul>

<div class="grid grid-3">
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0;">VNet (Virtual Network)</h4>
        <p><strong>What:</strong> Private network in Azure</p>
        <p><strong>Why:</strong> All resources live here, isolated from public internet</p>
        <p style="margin-bottom:0;"><strong>Analogy:</strong> The building's internal network</p>
    </div>
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0;">Jumpbox VM</h4>
        <p><strong>What:</strong> Linux VM inside the VNet</p>
        <p><strong>Why:</strong> Runs Terraform, can reach all private endpoints</p>
        <p style="margin-bottom:0;"><strong>Analogy:</strong> A workstation inside the secure office</p>
    </div>
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0;">Azure Bastion</h4>
        <p><strong>What:</strong> Managed gateway service</p>
        <p><strong>Why:</strong> Secure way to access Jumpbox (no public SSH)</p>
        <p style="margin-bottom:0;"><strong>Analogy:</strong> The secure lobby with ID verification</p>
    </div>
</div>

<h3>How Terraform Actually Runs</h3>

<div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
<pre style="background: var(--bc-blue-dark); margin: 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DEPLOYMENT FLOW                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   GitHub Actions          â”‚ Azure Landing Zone (Private Network)        â”‚
â”‚   (Public Internet)       â”‚                                              â”‚
â”‚                           â”‚                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Workflow     â”‚        â”‚    â”‚ Self-Hosted  â”‚    â”‚ Private         â”‚  â”‚
â”‚   â”‚ Triggers     â”‚â”€â”€â”€OIDCâ”€â”€â”€â”€â–¶â”‚ Runner       â”‚â”€â”€â”€â–¶â”‚ Endpoints       â”‚  â”‚
â”‚   â”‚              â”‚  Token  â”‚    â”‚ (in VNet)    â”‚    â”‚ (Storage, KV)   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚           â”‚                                  â”‚
â”‚                           â”‚           â–¼                                  â”‚
â”‚                           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                           â”‚    â”‚ terraform    â”‚                         â”‚
â”‚                           â”‚    â”‚ plan/apply   â”‚                         â”‚
â”‚                           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                           â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
</div>

<p><strong>Two deployment options:</strong></p>

<div class="grid grid-2">
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">Option A: Self-Hosted Runners</h4>
        <p>GitHub Actions runners deployed inside the VNet. Workflows run directly on these VMs.</p>
        <ul>
            <li>Runner registers with GitHub</li>
            <li>Workflow triggers, runner picks it up</li>
            <li>Terraform runs inside VNet</li>
            <li>Full access to private endpoints</li>
        </ul>
        <p style="margin-bottom:0;color:#22c55e;"><strong>Recommended for CI/CD</strong></p>
    </div>
    <div class="card" style="border-left-color: #0ea5e9;">
        <h4 style="margin-top: 0;">Option B: Jumpbox + Bastion</h4>
        <p>Manual access via Bastion for debugging, testing, and emergency fixes.</p>
        <ul>
            <li>Human connects via Azure Portal</li>
            <li>Bastion brokers SSH connection</li>
            <li>Land on Jumpbox inside VNet</li>
            <li>Run commands, debug issues</li>
        </ul>
        <p style="margin-bottom:0;color:#0ea5e9;"><strong>Required for human access</strong></p>
    </div>
</div>

<h3>What About Other Repositories?</h3>

<div class="alert alert-success">
    <span class="alert-icon">âœ…</span>
    <div>
        <strong>Good News: Other repos do NOT need their own Bastion/Jumpbox/VNet!</strong><br>
        This is <strong>shared infrastructure</strong> - the Landing Zone is set up once and used by all projects.
    </div>
</div>

<h4>What This Repo Provides (Set Up Once)</h4>
<table>
    <tr>
        <th>Component</th>
        <th>Purpose</th>
        <th>Shared?</th>
    </tr>
    <tr>
        <td>VNet + Subnets</td>
        <td>Private network for all resources</td>
        <td><strong>Yes - all projects use this</strong></td>
    </tr>
    <tr>
        <td>Azure Bastion</td>
        <td>Secure access gateway</td>
        <td><strong>Yes - one Bastion for all</strong></td>
    </tr>
    <tr>
        <td>Jumpbox VM</td>
        <td>Admin access point</td>
        <td><strong>Yes - shared by admins</strong></td>
    </tr>
    <tr>
        <td>Self-Hosted Runners</td>
        <td>CI/CD execution inside VNet</td>
        <td><strong>Yes - shared runner pool</strong></td>
    </tr>
    <tr>
        <td>Private DNS Zones</td>
        <td>Name resolution for private endpoints</td>
        <td><strong>Managed by Platform Services</strong></td>
    </tr>
</table>

<div class="alert alert-info" style="margin-top: 1rem;">
    <span class="alert-icon">&#128274;</span>
    <div>
        <strong>DNS & ExpressRoute Note:</strong> Private DNS zones are managed centrally by Platform Services, not by this Landing Zone. ExpressRoute connectivity exists for on-premises access, but AI Hub clients will connect through <strong>App Gateway + APIM</strong> endpoints rather than directly via ExpressRoute.
    </div>
</div>

<h4>What Other Repos Need To Do</h4>
<table>
    <tr>
        <th>Task</th>
        <th>Why</th>
        <th>Effort</th>
    </tr>
    <tr>
        <td>Configure OIDC federation</td>
        <td>Allow their repo to authenticate to Azure</td>
        <td>~30 min setup</td>
    </tr>
    <tr>
        <td>Use shared runner labels</td>
        <td>Target self-hosted runners in VNet</td>
        <td>1 line in workflow</td>
    </tr>
    <tr>
        <td>Deploy into existing VNet</td>
        <td>Resources join the private network</td>
        <td>Reference VNet in Terraform</td>
    </tr>
</table>

<div class="card" style="border-left-color: #22c55e; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
    <h4 style="margin-top: 0; color: #166534;">Example: New Project Onboarding</h4>
    <p>A new AI project wants to deploy a model endpoint. Here's what they do:</p>
    <ol>
        <li><strong>OIDC Setup:</strong> Platform team adds federated credential for <code>repo:bcgov/new-project:*</code></li>
        <li><strong>Workflow:</strong> Use <code>runs-on: [self-hosted, azure-vnet]</code> instead of <code>runs-on: ubuntu-latest</code></li>
        <li><strong>Terraform:</strong> Reference existing VNet: <code>data "azurerm_virtual_network" "hub" { ... }</code></li>
        <li><strong>Deploy:</strong> Resources automatically use private endpoints in the shared network</li>
    </ol>
    <p style="margin-bottom:0;"><strong>Total setup time: ~1 hour</strong> (vs. days to build their own Landing Zone)</p>
</div>

<h3>Why Not Just Open Public Endpoints Temporarily?</h3>

<div class="card" style="border-left-color: #ef4444;">
    <p><strong>Policy prohibits this.</strong> Even temporary public access:</p>
    <ul>
        <li>Creates audit findings</li>
        <li>Requires security exemption paperwork</li>
        <li>Introduces attack window</li>
        <li>Must be reverted manually (often forgotten)</li>
    </ul>
    <p style="margin-bottom:0;">The Landing Zone approach is <strong>always private</strong> - no exemptions needed.</p>
</div>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>Fully policy compliant</strong> - No public endpoints ever</li>
    <li><strong>Shared infrastructure</strong> - One-time setup, many projects benefit</li>
    <li><strong>Consistent security</strong> - All projects inherit the same secure baseline</li>
    <li><strong>Cost efficient</strong> - Single Bastion (~$140/mo) serves all projects</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>Initial complexity</strong> - Landing Zone must be built first</li>
    <li><strong>Runner maintenance</strong> - Self-hosted runners need updates</li>
    <li><strong>VNet planning</strong> - Must allocate IP ranges carefully</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/">Azure Landing Zone Concepts</a></li>
    <li><a href="https://docs.github.com/en/actions/hosting-your-own-runners">GitHub Self-Hosted Runners</a></li>
    <li><a href="diagrams.html#network-arch">Network Architecture Diagram</a></li>
</ul>

<!-- ============================================================================
     ADR-002: OIDC vs Service Principal
     ============================================================================ -->

<h2 id="adr-002">ADR-002: Use OIDC instead of Service Principal Secrets</h2>

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Security</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Policy Driver:</strong> BC Gov security policy requires minimizing long-lived credentials and implementing credential rotation. The platform team provides rotating keys, but OIDC eliminates the need for a cron job to fetch and update credentials.
    </div>
</div>

<p>GitHub Actions workflows need to authenticate with Azure to deploy infrastructure via Terraform. We evaluated three options for credential management:</p>

<div class="grid grid-3">
    <div class="card" style="border-left-color: #ef4444;">
        <h4 style="margin-top: 0;">Option A: Static Secrets</h4>
        <ul>
            <li>Create Azure AD App Registration</li>
            <li>Generate Client Secret</li>
            <li>Store in GitHub Secrets</li>
            <li>Rotate manually every 1-2 years</li>
        </ul>
        <p style="margin-bottom:0;color:#ef4444;"><strong>Not policy compliant</strong> - Long-lived credentials prohibited</p>
    </div>
    <div class="card" style="border-left-color: #f59e0b;">
        <h4 style="margin-top: 0;">Option B: Platform Rotating Keys</h4>
        <ul>
            <li>Platform team rotates keys every 2 days</li>
            <li>Keys expire after 4 days</li>
            <li>Requires cron job to fetch/update</li>
            <li>Must sync to GitHub Secrets</li>
        </ul>
        <p style="margin-bottom:0;color:#f59e0b;"><strong>Policy compliant</strong> - But adds operational overhead</p>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">Option C: OIDC Federation</h4>
        <ul>
            <li>Create Managed Identity</li>
            <li>Configure GitHub OIDC trust</li>
            <li>Token fetched in pipeline</li>
            <li>No cron job needed</li>
        </ul>
        <p style="margin-bottom:0;color:#22c55e;"><strong>Policy compliant</strong> - Zero operational overhead</p>
    </div>
</div>

<h3>Decision</h3>

<p><strong>We chose Option C: OIDC Federated Credentials.</strong></p>

<p>While the platform team's rotating key solution (Option B) is policy compliant, it requires maintaining a cron job to continuously fetch and update credentials. OIDC eliminates this operational burden - the bearer token is obtained directly within the GitHub Actions workflow at runtime, with no external synchronization required.</p>

<h3>Rationale</h3>

<table>
    <tr>
        <th>Criteria</th>
        <th>Static Secrets</th>
        <th>Platform Rotating</th>
        <th>OIDC</th>
    </tr>
    <tr>
        <td>Policy Compliant</td>
        <td style="color:#ef4444;">No</td>
        <td>Yes</td>
        <td><strong>Yes</strong></td>
    </tr>
    <tr>
        <td>Secret Management</td>
        <td>Manual rotation</td>
        <td>Cron job required</td>
        <td><strong>No secrets needed</strong></td>
    </tr>
    <tr>
        <td>Security Risk</td>
        <td>Long-lived credential leak</td>
        <td>4-day window if compromised</td>
        <td><strong>~10 min window</strong></td>
    </tr>
    <tr>
        <td>Operational Overhead</td>
        <td>Annual rotation</td>
        <td>Cron job maintenance</td>
        <td><strong>Set and forget</strong></td>
    </tr>
    <tr>
        <td>Token Lifetime</td>
        <td>1-2 years</td>
        <td>4 days max</td>
        <td><strong>~10 minutes</strong></td>
    </tr>
    <tr>
        <td>Failure Mode</td>
        <td>Expired secret breaks deploy</td>
        <td>Cron failure breaks deploy</td>
        <td><strong>Self-contained in pipeline</strong></td>
    </tr>
    <tr>
        <td>Scope Control</td>
        <td>Per application</td>
        <td>Per application</td>
        <td><strong>Per repo/branch/env</strong></td>
    </tr>
</table>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>Zero secrets to rotate</strong> - Eliminates credential management overhead</li>
    <li><strong>Reduced blast radius</strong> - Tokens valid for minutes, not years</li>
    <li><strong>Fine-grained access</strong> - Can restrict to specific branches/environments</li>
    <li><strong>Better audit trail</strong> - Every token exchange is logged with JWT claims</li>
    <li><strong>No secret sprawl</strong> - Secrets don't end up in logs, config files, or developer machines</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>More complex initial setup</strong> - Federated credential configuration is more involved</li>
    <li><strong>Newer technology</strong> - Less documentation and community examples available</li>
    <li><strong>GitHub dependency</strong> - Tightly coupled to GitHub's OIDC provider</li>
</ul>

<h4>Neutral</h4>
<ul>
    <li>Requires understanding of JWT claims and subject matching</li>
    <li>Debugging auth failures requires knowledge of OIDC flow</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect">GitHub OIDC Documentation</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/active-directory/workload-identities/workload-identity-federation">Azure Workload Identity Federation</a></li>
    <li><a href="diagrams.html#token-flow">Token Exchange Flow Diagram</a></li>
</ul>

<!-- ============================================================================
     ADR-003: Azure Bastion vs VPN
     ============================================================================ -->

<h2 id="adr-003">ADR-003: Use Azure Bastion for VM Access</h2>

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Networking</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Policy Driver:</strong> BC Gov policy prohibits public IP addresses on virtual machines. VMs must only be accessible through private networks. Azure Bastion provides compliant access without exposing VMs to the internet.
    </div>
</div>

<p>Operators need secure access to jumpbox VMs for debugging and administration. The VMs cannot have public IPs per policy. We evaluated:</p>

<div class="grid grid-3">
    <div class="card">
        <h4 style="margin-top: 0;">Option A: VPN Gateway</h4>
        <p>Point-to-site VPN for developer access</p>
    </div>
    <div class="card">
        <h4 style="margin-top: 0;">Option B: Public IP + NSG</h4>
        <p>Expose SSH/RDP with IP allowlisting</p>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">Option C: Azure Bastion</h4>
        <p>Browser-based RDP/SSH via Azure Portal</p>
    </div>
</div>

<h3>Decision</h3>

<p><strong>We chose Option C: Azure Bastion.</strong></p>

<h3>Rationale</h3>

<table>
    <tr>
        <th>Criteria</th>
        <th>VPN Gateway</th>
        <th>Public IP</th>
        <th>Bastion</th>
    </tr>
    <tr>
        <td>Setup Complexity</td>
        <td>High (certs, clients)</td>
        <td>Low</td>
        <td><strong>Medium</strong></td>
    </tr>
    <tr>
        <td>Client Requirements</td>
        <td>VPN client software</td>
        <td>SSH/RDP client</td>
        <td><strong>Browser only</strong></td>
    </tr>
    <tr>
        <td>Attack Surface</td>
        <td>VPN endpoint</td>
        <td>High (exposed ports)</td>
        <td><strong>Minimal</strong></td>
    </tr>
    <tr>
        <td>Cost</td>
        <td>~$140/month</td>
        <td>~$5/month</td>
        <td><strong>~$140/month (when on)</strong></td>
    </tr>
    <tr>
        <td>On-demand</td>
        <td>No (always on)</td>
        <td>Yes</td>
        <td><strong>Yes (can destroy)</strong></td>
    </tr>
</table>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>No public IPs on VMs</strong> - VMs only have private IPs</li>
    <li><strong>No client software</strong> - Works from any browser</li>
    <li><strong>Azure AD integration</strong> - Uses existing identity</li>
    <li><strong>Session recording</strong> - Can enable for audit</li>
    <li><strong>Cost control</strong> - Can deploy/destroy on demand via workflow</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>Azure Portal dependency</strong> - Must use Azure UI or CLI</li>
    <li><strong>File transfer limitations</strong> - No native SCP/SFTP</li>
    <li><strong>Latency</strong> - Browser-based adds some lag</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="https://learn.microsoft.com/en-us/azure/bastion/bastion-overview">Azure Bastion Documentation</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/bastion/bastion-connect-vm-ssh-linux">Connect to Linux VM via Bastion</a></li>
    <li><a href="diagrams.html#network-environments">Network Environments Diagram</a></li>
</ul>

<!-- ============================================================================
     ADR-004: Private Endpoints
     ============================================================================ -->

<h2 id="adr-004">ADR-004: Private Endpoints for All Azure Services</h2>

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Networking</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Policy Driver:</strong> BC Gov security policy mandates that all Azure PaaS services must be accessed via Private Endpoints only. Public endpoints must be disabled. This ensures all traffic stays within the Azure backbone and private networks.
    </div>
</div>

<p>Azure PaaS services (Storage Accounts, Key Vaults, Databases, etc.) by default have public endpoints accessible from the internet. BC Gov policy requires these to be locked down.</p>

<h3>Policy Requirements</h3>

<div class="card" style="border-left-color: #ef4444;">
    <h4 style="margin-top: 0;">What Policy Prohibits</h4>
    <ul style="margin-bottom: 0;">
        <li>Public endpoints on any Azure service</li>
        <li>Storage accounts accessible from internet</li>
        <li>Key Vaults with public network access</li>
        <li>Databases with public connectivity</li>
        <li>Any service reachable without VNet integration</li>
    </ul>
</div>

<div class="card" style="border-left-color: #22c55e;">
    <h4 style="margin-top: 0;">What Policy Requires</h4>
    <ul style="margin-bottom: 0;">
        <li>Private Endpoints for all PaaS services</li>
        <li>Private DNS zones for name resolution <em>(managed by Platform Services)</em></li>
        <li>VNet integration for all access</li>
        <li>Network Security Groups controlling traffic</li>
        <li>"Deny public access" enabled on all services</li>
    </ul>
</div>

<h3>Implementation</h3>

<div class="alert alert-info" style="margin-bottom: 1rem;">
    <span class="alert-icon">&#128274;</span>
    <div>
        <strong>DNS Management:</strong> All private DNS zones are managed centrally by Platform Services. The AI Hub team does not manage DNS - we only create private endpoints that link to the existing DNS zones.
    </div>
</div>

<table>
    <tr>
        <th>Service</th>
        <th>Private Endpoint</th>
        <th>DNS Zone (Platform Services)</th>
    </tr>
    <tr>
        <td>Storage Account (Terraform State)</td>
        <td><code>privateEndpoint-blob</code></td>
        <td><code>privatelink.blob.core.windows.net</code></td>
    </tr>
    <tr>
        <td>Key Vault (if used)</td>
        <td><code>privateEndpoint-vault</code></td>
        <td><code>privatelink.vaultcore.azure.net</code></td>
    </tr>
    <tr>
        <td>Container Registry (if used)</td>
        <td><code>privateEndpoint-acr</code></td>
        <td><code>privatelink.azurecr.io</code></td>
    </tr>
</table>

<h3>Client Connectivity Model</h3>

<div class="card" style="border-left-color: var(--bc-gold);">
    <h4 style="margin-top: 0;">ExpressRoute + App Gateway + APIM</h4>
    <p>BC Gov has ExpressRoute connectivity to Azure, but AI Hub clients will <strong>not</strong> access services directly via ExpressRoute. Instead:</p>
    <ul>
        <li><strong>App Gateway:</strong> Provides ingress, WAF protection, and SSL termination</li>
        <li><strong>APIM:</strong> API management layer for authentication, rate limiting, and routing</li>
        <li><strong>Private Endpoints:</strong> Backend services (AI models, storage) remain fully private</li>
    </ul>
    <p style="margin-bottom: 0;"><strong>Client flow:</strong> Client â†’ App Gateway â†’ APIM â†’ Private Endpoint â†’ Azure Service</p>
</div>

<h3>Consequences</h3>

<h4>Challenges</h4>
<ul>
    <li><strong>GitHub Actions cannot reach private endpoints directly</strong> - Requires self-hosted runners inside the VNet (see <a href="#adr-001">ADR-001</a>)</li>
    <li><strong>Local development complexity</strong> - Developers cannot access resources without VPN/Bastion</li>
    <li><strong>DNS resolution</strong> - Must configure private DNS zones correctly</li>
    <li><strong>Debugging difficulty</strong> - Cannot easily test from outside the network</li>
</ul>

<h4>Workarounds</h4>
<ul>
    <li><strong>Terraform State:</strong> Use self-hosted runners inside the VNet which can access the private storage endpoint directly. The <code>use_azuread_auth = true</code> setting enables Azure AD authentication for state access.</li>
    <li><strong>Development:</strong> Use Bastion + Jumpbox for all Azure resource access (see <a href="#adr-003">ADR-003</a>)</li>
    <li><strong>CI/CD:</strong> Use self-hosted runners in the VNet for full private access (see <a href="#adr-001">ADR-001</a>)</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview">Azure Private Endpoint Documentation</a></li>
    <li><a href="diagrams.html#network-arch">Network Architecture Diagram</a></li>
</ul>

<!-- ============================================================================
     ADR-005: Zero-Dependency Docs
     ============================================================================ -->

<h2 id="adr-005">ADR-005: Zero-Dependency Documentation System</h2>

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-12</div>
    <div><strong>Driver:</strong> <span class="badge" style="background:#22c55e;color:white;">Choice</span></div>
    <div><strong>Category:</strong> Documentation</div>
</div>

<h3>Context</h3>

<p>We needed a documentation site for the project. Options considered:</p>

<div class="grid grid-2">
    <div class="card">
        <h4 style="margin-top: 0;">Static Site Generators</h4>
        <ul>
            <li>Jekyll (Ruby)</li>
            <li>Hugo (Go)</li>
            <li>Docusaurus (Node.js)</li>
            <li>MkDocs (Python)</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">Custom Bash Build</h4>
        <ul>
            <li>Header/footer partials</li>
            <li>Variable substitution</li>
            <li>~60 lines of shell script</li>
            <li>Zero external dependencies</li>
        </ul>
    </div>
</div>

<h3>Decision</h3>

<p><strong>We built a custom Bash-based static site generator.</strong></p>

<h3>Rationale</h3>

<ul>
    <li><strong>Portability:</strong> Runs anywhere with Bash (Linux, Mac, WSL, CI)</li>
    <li><strong>No dependency management:</strong> No npm, gem, pip, go install required</li>
    <li><strong>Simplicity:</strong> Anyone can understand the 60-line build script</li>
    <li><strong>Speed:</strong> Builds in milliseconds</li>
    <li><strong>GitHub Pages native:</strong> No special plugins or build configurations</li>
    <li><strong>AI-friendly:</strong> HTML generation is trivial for AI assistants</li>
</ul>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li>Zero build dependencies to maintain or update</li>
    <li>Works in any environment without setup</li>
    <li>Easy to understand and modify</li>
    <li>No security vulnerabilities from npm packages</li>
</ul>

<h4>Negative</h4>
<ul>
    <li>No built-in Markdown support (write HTML directly)</li>
    <li>No automatic table of contents generation</li>
    <li>No built-in search (added custom client-side solution)</li>
</ul>

<h4>Mitigations</h4>
<ul>
    <li>Created template page with all components for easy copy-paste</li>
    <li>AI assistants generate HTML as easily as Markdown</li>
    <li>Added custom SVG viewer for diagrams</li>
</ul>

<!-- ============================================================================
     ADR-006: Multi-Tenant Isolation Model
     ============================================================================ -->

<h2 id="adr-006">ADR-006: Multi-Tenant Isolation Model</h2>

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-12</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Architecture</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Policy Driver:</strong> BC Gov requires strict data isolation between ministries. Each ministry's data must be logically separated, with access controls preventing cross-ministry data exposure. The AI Hub serves multiple ministries (Health, SDPR, Justice, etc.) from shared infrastructure.
    </div>
</div>

<p>The AI Hub Landing Zone is designed to serve multiple BC Government ministries from a single shared infrastructure deployment. This creates a multi-tenancy challenge: how do we provide cost-efficient shared services while ensuring strict data isolation between ministries?</p>

<h3>The Problem: Shared Infrastructure, Isolated Data</h3>

<div class="grid grid-2">
    <div class="card" style="border-left-color: #ef4444;">
        <h4 style="margin-top: 0;">What We Cannot Do</h4>
        <ul style="margin-bottom: 0;">
            <li>Allow Ministry A to access Ministry B's documents</li>
            <li>Share AI search indexes across ministries</li>
            <li>Use single storage accounts for all ministry data</li>
            <li>Allow cross-ministry API access without authorization</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">What We Can Share</h4>
        <ul style="margin-bottom: 0;">
            <li>Network infrastructure (VNets, Bastion, NSGs)</li>
            <li>Compute resources (AI Foundry, AKS clusters)</li>
            <li>Ingress layer (App Gateway, APIM)</li>
            <li>Monitoring and logging infrastructure</li>
        </ul>
    </div>
</div>

<h3>Decision</h3>

<p><strong>We implement a four-layer isolation model:</strong></p>

<div class="grid grid-2">
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0;">1. Storage Isolation</h4>
        <p><strong>Separate storage accounts per ministry</strong></p>
        <ul style="margin-bottom: 0;">
            <li>Each ministry gets dedicated blob containers</li>
            <li>Azure RBAC restricts access to ministry principals</li>
            <li>Private endpoints per storage account</li>
            <li>Encryption keys can be ministry-specific (CMK)</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0;">2. AI Search Index Isolation</h4>
        <p><strong>Separate search indexes per ministry</strong></p>
        <ul style="margin-bottom: 0;">
            <li>Each ministry's documents indexed separately</li>
            <li>RAG queries scoped to ministry index only</li>
            <li>No cross-index queries permitted</li>
            <li>Index-level access control via Azure RBAC</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: var(--bc-blue);">
        <h4 style="margin-top: 0;">3. API Isolation (APIM)</h4>
        <p><strong>APIM subscriptions per ministry</strong></p>
        <ul style="margin-bottom: 0;">
            <li>Unique subscription keys per ministry</li>
            <li>Rate limiting scoped to subscription</li>
            <li>API policies enforce ministry context</li>
            <li>Audit logging includes ministry identifier</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: var(--bc-blue);">
        <h4 style="margin-top: 0;">4. Network Isolation (NSGs)</h4>
        <p><strong>Network policies enforce boundaries</strong></p>
        <ul style="margin-bottom: 0;">
            <li>NSG rules restrict subnet-to-subnet traffic</li>
            <li>Private endpoints isolated by ministry where needed</li>
            <li>No direct cross-ministry network paths</li>
            <li>All traffic routed through controlled ingress</li>
        </ul>
    </div>
</div>

<h3>Implementation Architecture</h3>

<div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
<pre style="background: var(--bc-blue-dark); margin: 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MULTI-TENANT ISOLATION MODEL                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Ministry Health        Ministry SDPR         Ministry Justice             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚ APIM Sub: H â”‚       â”‚ APIM Sub: S â”‚       â”‚ APIM Sub: J â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚          â”‚                     â”‚                     â”‚                      â”‚
â”‚          â–¼                     â–¼                     â–¼                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚              Shared APIM (Policy Enforcement)                â”‚          â”‚
â”‚   â”‚         (validates subscription â†’ routes to ministry)        â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚          â”‚                     â”‚                     â”‚                      â”‚
â”‚          â–¼                     â–¼                     â–¼                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚ Storage: H  â”‚       â”‚ Storage: S  â”‚       â”‚ Storage: J  â”‚              â”‚
â”‚   â”‚ Index: H    â”‚       â”‚ Index: S    â”‚       â”‚ Index: J    â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                              â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â”‚
â”‚                    Shared Infrastructure Layer                               â”‚
â”‚        (VNet, Bastion, AI Foundry Compute, Monitoring)                      â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
</div>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>Strong data isolation</strong> - Ministry data never co-mingled</li>
    <li><strong>Cost efficiency</strong> - Shared compute and network infrastructure</li>
    <li><strong>Audit compliance</strong> - Clear ministry attribution in all logs</li>
    <li><strong>Scalable onboarding</strong> - New ministries get isolated resources automatically</li>
    <li><strong>Flexible isolation levels</strong> - Can increase isolation (dedicated compute) if needed</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>Resource multiplication</strong> - Each ministry needs separate storage/indexes</li>
    <li><strong>Complexity</strong> - More resources to manage and monitor</li>
    <li><strong>Cost per ministry</strong> - Base cost increases with each ministry onboarded</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="diagrams.html#multi-tenant">Multi-Tenant Isolation Diagram</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/architecture/guide/multitenant/overview">Azure Multi-Tenant Architecture Guide</a></li>
    <li><a href="diagrams.html#data-flow">AI Request Data Flow Diagram</a></li>
</ul>

<!-- ============================================================================
     ADR-007: Client Connectivity Model
     ============================================================================ -->

<h2 id="adr-007">ADR-007: Client Connectivity via App Gateway + APIM</h2>

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-12</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Networking</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Policy Driver:</strong> BC Gov has ExpressRoute connectivity to Azure for private, high-bandwidth access. However, AI Hub clients should not access backend services directly. All client traffic must pass through security layers that provide WAF protection, authentication, rate limiting, and audit logging.
    </div>
</div>

<p>BC Government has established ExpressRoute connectivity between on-premises networks and Azure. The question arose: should ministry applications connect directly to AI services via ExpressRoute, or through a managed ingress layer?</p>

<h3>Options Considered</h3>

<div class="grid grid-2">
    <div class="card" style="border-left-color: #ef4444;">
        <h4 style="margin-top: 0;">Option A: Direct ExpressRoute Access</h4>
        <p>Clients connect directly to private endpoints via ExpressRoute.</p>
        <ul>
            <li>Lowest latency (no middlemen)</li>
            <li>Simpler architecture</li>
        </ul>
        <p style="color:#ef4444;margin-bottom:0;"><strong>Rejected:</strong> No WAF, no rate limiting, no centralized auth, difficult to audit</p>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">Option B: App Gateway + APIM</h4>
        <p>All traffic flows through App Gateway and APIM before reaching backends.</p>
        <ul>
            <li>WAF protection at ingress</li>
            <li>Centralized authentication</li>
            <li>Rate limiting and quotas</li>
            <li>Complete audit trail</li>
        </ul>
        <p style="color:#22c55e;margin-bottom:0;"><strong>Selected:</strong> Provides security controls required by policy</p>
    </div>
</div>

<h3>Decision</h3>

<p><strong>All AI Hub client traffic must flow through App Gateway â†’ APIM â†’ Private Endpoints.</strong></p>

<p>Even though ExpressRoute provides private connectivity, we require all client requests to pass through our security stack. This ensures consistent policy enforcement regardless of how clients connect to Azure.</p>

<h3>Traffic Flow</h3>

<div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
<pre style="background: var(--bc-blue-dark); margin: 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT CONNECTIVITY MODEL                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   On-Premises                    â”‚         Azure Landing Zone               â”‚
â”‚   (Ministry Apps)                â”‚                                          â”‚
â”‚                                  â”‚                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Ministry App â”‚              â”‚    â”‚         App Gateway              â”‚   â”‚
â”‚   â”‚ (Health)     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â€¢ SSL Termination              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Express    â”‚    â”‚  â€¢ WAF Protection               â”‚   â”‚
â”‚                      Route      â”‚    â”‚  â€¢ DDoS Mitigation              â”‚   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”‚ Ministry App â”‚              â”‚                   â”‚                       â”‚
â”‚   â”‚ (SDPR)       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶               â–¼                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                 â”‚    â”‚            APIM                  â”‚   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚    â”‚  â€¢ Authentication (API Keys)    â”‚   â”‚
â”‚   â”‚ Ministry App â”‚              â”‚    â”‚  â€¢ Rate Limiting                â”‚   â”‚
â”‚   â”‚ (Justice)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â€¢ Request Validation           â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚    â”‚  â€¢ Ministry Routing             â”‚   â”‚
â”‚                                 â”‚    â”‚  â€¢ Audit Logging                â”‚   â”‚
â”‚                                 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                   â”‚                       â”‚
â”‚                                 â”‚                   â–¼                       â”‚
â”‚                                 â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                 â”‚    â”‚      Private Endpoints          â”‚   â”‚
â”‚                                 â”‚    â”‚  â€¢ AI Foundry                   â”‚   â”‚
â”‚                                 â”‚    â”‚  â€¢ Azure OpenAI                 â”‚   â”‚
â”‚                                 â”‚    â”‚  â€¢ AI Search                    â”‚   â”‚
â”‚                                 â”‚    â”‚  â€¢ Storage (RAG docs)           â”‚   â”‚
â”‚                                 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
</div>

<h3>Security Controls at Each Layer</h3>

<table>
    <tr>
        <th>Layer</th>
        <th>Security Control</th>
        <th>Purpose</th>
    </tr>
    <tr>
        <td><strong>App Gateway</strong></td>
        <td>Web Application Firewall (WAF)</td>
        <td>Block OWASP top 10, SQL injection, XSS</td>
    </tr>
    <tr>
        <td><strong>App Gateway</strong></td>
        <td>SSL/TLS Termination</td>
        <td>Enforce HTTPS, manage certificates</td>
    </tr>
    <tr>
        <td><strong>App Gateway</strong></td>
        <td>DDoS Protection</td>
        <td>Mitigate volumetric attacks</td>
    </tr>
    <tr>
        <td><strong>APIM</strong></td>
        <td>Subscription Keys</td>
        <td>Identify and authenticate ministry</td>
    </tr>
    <tr>
        <td><strong>APIM</strong></td>
        <td>Rate Limiting</td>
        <td>Prevent abuse, ensure fair usage</td>
    </tr>
    <tr>
        <td><strong>APIM</strong></td>
        <td>Request Validation</td>
        <td>Validate payload structure</td>
    </tr>
    <tr>
        <td><strong>APIM</strong></td>
        <td>Audit Logging</td>
        <td>Track all requests with ministry context</td>
    </tr>
    <tr>
        <td><strong>Private Endpoints</strong></td>
        <td>Network Isolation</td>
        <td>Backend services unreachable from internet</td>
    </tr>
</table>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>Defense in depth</strong> - Multiple security layers before reaching backends</li>
    <li><strong>Centralized policy</strong> - All clients subject to same rules</li>
    <li><strong>Audit compliance</strong> - Every request logged with full context</li>
    <li><strong>Flexibility</strong> - Can update policies without changing backends</li>
    <li><strong>Cost attribution</strong> - Can track usage per ministry via APIM metrics</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>Added latency</strong> - Two extra hops (App Gateway + APIM)</li>
    <li><strong>Cost</strong> - App Gateway and APIM have significant monthly costs</li>
    <li><strong>Complexity</strong> - More components to configure and maintain</li>
</ul>

<h4>Mitigations</h4>
<ul>
    <li>Latency is typically &lt;10ms additional per hop</li>
    <li>Costs are shared across all ministries (per <a href="#adr-006">ADR-006</a>)</li>
    <li>Infrastructure-as-code manages complexity</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="diagrams.html#data-flow">AI Request Data Flow Diagram</a></li>
    <li><a href="diagrams.html#full-stack">Full Stack Architecture Diagram</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/api-management/api-management-key-concepts">Azure API Management Overview</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/application-gateway/overview">Azure Application Gateway Overview</a></li>
</ul>

<h2>ADR Template</h2>

<p>Use this template when adding new ADRs:</p>

<div class="card" style="background: var(--bg-light);">
<pre style="background: transparent; box-shadow: none; margin: 0;">## ADR-XXX: [Title]

**Status:** [Proposed | Accepted | Deprecated | Superseded]
**Date:** YYYY-MM
**Deciders:** [Team/People]
**Category:** [Security | Networking | Infrastructure | Documentation | etc.]

### Context
[What is the issue? What forces are at play?]

### Decision
[What is the decision? Be specific.]

### Rationale
[Why this decision over alternatives?]

### Consequences
#### Positive
- [Good outcomes]

#### Negative
- [Tradeoffs accepted]

### References
- [Links to relevant docs, diagrams, discussions]</pre>
</div>
    </main>
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-brand">
                <h4>AI Hub Tracking</h4>
                <p>Infrastructure as Code for Azure Landing Zone deployments</p>
            </div>
            <div class="footer-links">
                <h4>Resources</h4>
                <ul>
                    <li><a href="https://github.com/bcgov/ai-hub-tracking">GitHub Repository</a></li>
                    <li><a href="assets/azure-oidc-complete-guide.svg" target="_blank">Architecture Diagram</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>BC Government</h4>
                <ul>
                    <li><a href="https://www2.gov.bc.ca">gov.bc.ca</a></li>
                    <li><a href="https://digital.gov.bc.ca">Digital Office</a></li>
                </ul>
            </div>
            <div class="footer-copyright">
                <p>&copy; 2025 Province of British Columbia</p>
                <p class="footer-meta">Built with zero dependencies</p>
            </div>
        </div>
    </footer>
</body>
</html>
