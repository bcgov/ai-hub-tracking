[{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"apim-internal-endpoints","sectionTitle":"APIM Internal Endpoints","text":"Each tenant API exposes two internal endpoints that are available only to authenticated callers holding a valid APIM subscription key. Neither endpoint proxies traffic to an AI backend — both are implemented entirely in APIM policy and return responses directly. Authentication Required All internal endpoints require a valid APIM subscription key in the api-key header. Unauthenticated requests receive 401 Unauthorized . Only GET is accepted &mdash; any other method returns 405 Method Not Allowed .","excerpt":"Each tenant API exposes two internal endpoints that are available only to authenticated callers holding a valid APIM subscription key. Neither endpoint proxies traffic to an AI backend — both are implemented entirely in…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"internalapim-keys","sectionTitle":"/internal/apim-keys","text":"Returns both subscription keys and rotation metadata sourced from the centralized hub Key Vault at request time. Requires: key rotation enabled ( rotation_enabled = true in shared.tfvars ). View reference &darr;","excerpt":"Returns both subscription keys and rotation metadata sourced from the centralized hub Key Vault at request time. Requires: key rotation enabled ( rotation_enabled = true in shared.tfvars ). View reference &darr;"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"internaltenant-info","sectionTitle":"/internal/tenant-info","text":"Returns the tenant's deployed AI models with quota information and a list of enabled services. Always available &mdash; no Key Vault access needed. Requires: nothing beyond a valid subscription key. View reference &darr;","excerpt":"Returns the tenant's deployed AI models with quota information and a list of enabled services. Always available &mdash; no Key Vault access needed. Requires: nothing beyond a valid subscription key. View reference &darr;"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"apim-keys","sectionTitle":"GET /{tenant-name}/internal/apim-keys","text":"","excerpt":""},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"overview","sectionTitle":"Overview","text":"Returns the tenant's current primary and secondary APIM subscription keys, plus rotation metadata, from the centralized hub Key Vault. Use this endpoint to programmatically refresh your stored key after a rotation event without needing direct Key Vault access. See the APIM Key Rotation guide for the full operational workflow, rotation schedule, and troubleshooting information.","excerpt":"Returns the tenant's current primary and secondary APIM subscription keys, plus rotation metadata, from the centralized hub Key Vault. Use this endpoint to programmatically refresh your stored key after a rotation event…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"authentication","sectionTitle":"Authentication","text":"Pass either the primary or secondary subscription key in the api-key header. APIM validates it before running any policy logic &mdash; the still-valid key (not the one just rotated) always works. curl -s -H \"api-key: YOUR_SUBSCRIPTION_KEY\" \\ \"https://your-apim-gateway.azure-api.net/YOUR_TENANT/internal/apim-keys\" | jq .","excerpt":"Pass either the primary or secondary subscription key in the api-key header. APIM validates it before running any policy logic &mdash; the still-valid key (not the one just rotated) always works. curl -s -H \"api-key:…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"how-it-works","sectionTitle":"How It Works","text":"APIM validates the incoming subscription key (standard APIM behavior). APIM policy uses its system-assigned managed identity to read three secrets from the centralized hub Key Vault: {tenant}-apim-primary-key , {tenant}-apim-secondary-key , and {tenant}-apim-rotation-metadata . Secrets are assembled into a JSON response and returned directly &mdash; no backend service is called.","excerpt":"APIM validates the incoming subscription key (standard APIM behavior). APIM policy uses its system-assigned managed identity to read three secrets from the centralized hub Key Vault: {tenant}-apim-primary-key ,…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"response-200-ok","sectionTitle":"Response (200 OK)","text":"{ \"tenant\": \"your-tenant-name\", \"primary_key\": \"abc123def456...\", \"secondary_key\": \"ghi789jkl012...\", \"rotation\": { \"last_rotated_slot\": \"primary\", \"last_rotation_at\": \"2026-02-11T02:00:00Z\", \"next_rotation_at\": \"2026-02-18T02:00:00Z\", \"rotation_number\": 5, \"safe_slot\": \"secondary\" }, \"keyvault\": { \"uri\": \"https://hub-kv.vault.azure.net/\", \"primary_key_secret\": \"your-tenant-name-apim-primary-key\", \"secondary_key_secret\": \"your-tenant-name-apim-secondary-key\" } } Field Type Description tenant string The tenant identifier (matches the API path prefix). primary_key string Current value of the APIM primary subscription key slot. secondary_key string Current value of the APIM secondary subscription key slot. rotation.last_rotated_slot string \"primary\" or \"secondary\" &mdash; the slot regenerated most recently. rotation.safe_slot string The slot that was not just rotated. Switch to this key. rotation.last_rotation_at ISO 8601 Timestamp of the most recent rotation. rotation.next_rotation_at ISO 8601 Estimated timestamp of the next scheduled rotation. rotation.rotation_number number Monotonically increasing rotation counter. keyvault.uri string Hub Key Vault base URI. keyvault.primary_key_secret string Secret name for the primary key in the hub Key Vault. keyvault.secondary_key_secret string Secret name for the secondary key in the hub Key Vault.","excerpt":"{ \"tenant\": \"your-tenant-name\", \"primary_key\": \"abc123def456...\", \"secondary_key\": \"ghi789jkl012...\", \"rotation\": { \"last_rotated_slot\": \"primary\", \"last_rotation_at\": \"2026-02-11T02:00:00Z\", \"next_rotation_at\":…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"error-responses","sectionTitle":"Error Responses","text":"Status Cause Body ( error.code ) 401 Missing or invalid subscription key. Standard APIM 401 404 Key rotation is disabled for this environment ( rotation_enabled = false ); route not present in policy. NotFound 405 Non-GET method used. MethodNotAllowed 502 APIM managed identity could not read one or more secrets from the hub Key Vault. KeyVaultReadFailed","excerpt":"Status Cause Body ( error.code ) 401 Missing or invalid subscription key. Standard APIM 401 404 Key rotation is disabled for this environment ( rotation_enabled = false ); route not present in policy. NotFound 405…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"infrastructure","sectionTitle":"Infrastructure","text":"Implemented purely in APIM policy. APIM's system-assigned managed identity holds a single Key Vault Secrets User RBAC assignment on the centralized hub Key Vault &mdash; one assignment scales to all tenants. Enabled only when shared.tfvars has key_rotation.rotation_enabled = true . Source: infra-ai-hub/params/apim/api_policy.xml.tftpl ( key_rotation_enabled block).","excerpt":"Implemented purely in APIM policy. APIM's system-assigned managed identity holds a single Key Vault Secrets User RBAC assignment on the centralized hub Key Vault &mdash; one assignment scales to all tenants. Enabled only…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"tenant-info","sectionTitle":"GET /{tenant-name}/internal/tenant-info","text":"","excerpt":""},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"overview-1","sectionTitle":"Overview","text":"Returns the tenant's deployed AI models (with quota information) and the set of enabled AI services. The response is fully static &mdash; data is baked in at Terraform deploy time via templatefile() , so no Key Vault or backend calls are made at runtime. Always available; there is no feature flag that disables this endpoint. Use this endpoint to: Discover which models are available and their per-model token-per-minute quota. Confirm which AI services (Document Intelligence, AI Search, Speech, etc.) are enabled for your tenant. Drive UI dropdowns or config auto-discovery without maintaining a separate config file.","excerpt":"Returns the tenant's deployed AI models (with quota information) and the set of enabled AI services. The response is fully static &mdash; data is baked in at Terraform deploy time via templatefile() , so no Key Vault or…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"authentication-1","sectionTitle":"Authentication","text":"Pass the subscription key in the api-key header. APIM validates it before returning any data. curl -s -H \"api-key: YOUR_SUBSCRIPTION_KEY\" \\ \"https://your-apim-gateway.azure-api.net/YOUR_TENANT/internal/tenant-info\" | jq .","excerpt":"Pass the subscription key in the api-key header. APIM validates it before returning any data. curl -s -H \"api-key: YOUR_SUBSCRIPTION_KEY\" \\ \"https://your-apim-gateway.azure-api.net/YOUR_TENANT/internal/tenant-info\" | jq…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"how-it-works-1","sectionTitle":"How It Works","text":"APIM validates the incoming subscription key. The policy matches paths ending in internal/tenant-info and returns the pre-rendered JSON body directly &mdash; no backend service is called. The JSON is generated once by Terraform's templatefile() from values in tenant.tfvars ( openai.model_deployments , service feature flags) and embedded in the APIM policy at deploy time. Static data: A new Terraform apim stack deploy is required for model or service flag changes to be reflected in the response.","excerpt":"APIM validates the incoming subscription key. The policy matches paths ending in internal/tenant-info and returns the pre-rendered JSON body directly &mdash; no backend service is called. The JSON is generated once by…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"response-200-ok-1","sectionTitle":"Response (200 OK)","text":"{ \"tenant\": \"wlrs-water-form-assistant\", \"models\": [ { \"name\": \"gpt-4.1-mini\", \"model_name\": \"gpt-4.1-mini\", \"model_version\": \"2025-04-14\", \"scale_type\": \"GlobalStandard\", \"capacity_k_tpm\": 1500, \"tokens_per_minute\": 1500000 }, { \"name\": \"gpt-4.1\", \"model_name\": \"gpt-4.1\", \"model_version\": \"2025-04-14\", \"scale_type\": \"GlobalStandard\", \"capacity_k_tpm\": 300, \"tokens_per_minute\": 300000 } ], \"services\": { \"ai_search\": true, \"document_intelligence\": true, \"openai\": true, \"speech_services\": true, \"storage\": true } } Field Type Description tenant string The tenant identifier (matches the API path prefix). models[].name string Deployment name used in API calls (e.g., gpt-4.1-mini ). models[].model_name string Underlying Azure OpenAI model name. models[].model_version string Model version date string. models[].scale_type string Deployment scale type (e.g., GlobalStandard ). models[].capacity_k_tpm number Allocated quota in thousands of tokens per minute (from tenant.tfvars ). models[].tokens_per_minute number Computed TPM limit applied by rate-limiting ( capacity_k_tpm &times; 1000 ). services.openai bool true when OpenAI model deployments are configured for this tenant. services.document_intelligence bool true when Document Intelligence is enabled. services.ai_search bool true when AI Search is enabled. services.speech_services bool true when Speech Services (STT/TTS) are enabled. services.storage bool true when the Storage account proxy is enabled.","excerpt":"{ \"tenant\": \"wlrs-water-form-assistant\", \"models\": [ { \"name\": \"gpt-4.1-mini\", \"model_name\": \"gpt-4.1-mini\", \"model_version\": \"2025-04-14\", \"scale_type\": \"GlobalStandard\", \"capacity_k_tpm\": 1500, \"tokens_per_minute\":…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"error-responses-1","sectionTitle":"Error Responses","text":"Status Cause 401 Missing or invalid subscription key. 405 Non-GET method used.","excerpt":"Status Cause 401 Missing or invalid subscription key. 405 Non-GET method used."},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"infrastructure-1","sectionTitle":"Infrastructure","text":"Implemented purely in APIM policy. Enabled for every tenant unconditionally ( tenant_info_enabled = true in stacks/apim/locals.tf ). No Key Vault grants required. Source: infra-ai-hub/params/apim/api_policy.xml.tftpl ( tenant_info_enabled block).","excerpt":"Implemented purely in APIM policy. Enabled for every tenant unconditionally ( tenant_info_enabled = true in stacks/apim/locals.tf ). No Key Vault grants required. Source: infra-ai-hub/params/apim/api_policy.xml.tftpl (…"},{"page":"apim-internal-endpoints.html","pageTitle":"APIM Internal Endpoints","sectionId":"integration-tests","sectionTitle":"Integration Tests","text":"Both endpoints have bats integration test coverage in tests/integration/ : Suite Endpoint Proxy required apim-key-rotation.bats /internal/apim-keys Yes &mdash; Key Vault is private-only. Runs via the chisel/privoxy tunnel in CI. tenant-info.bats /internal/tenant-info No &mdash; response is static, no Key Vault calls. Runs in the direct (no-proxy) CI step. # Run tenant-info tests locally cd tests/integration ./run-tests.sh test tenant-info.bats # Run apim-keys tests (requires az login + hub Key Vault access) ./run-tests.sh test apim-key-rotation.bats AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"Both endpoints have bats integration test coverage in tests/integration/ : Suite Endpoint Proxy required apim-key-rotation.bats /internal/apim-keys Yes &mdash; Key Vault is private-only. Runs via the chisel/privoxy…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"apim-subscription-key-rotation","sectionTitle":"APIM Subscription Key Rotation","text":"This guide explains how APIM subscription keys are automatically rotated for tenant teams, and how to update your application to use the new keys. Zero Downtime Key rotation uses an alternating primary/secondary pattern. Only one key is rotated at a time &mdash; the other remains valid and untouched. Your service is never interrupted.","excerpt":"This guide explains how APIM subscription keys are automatically rotated for tenant teams, and how to update your application to use the new keys. Zero Downtime Key rotation uses an alternating primary/secondary pattern.…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"how-it-works","sectionTitle":"How It Works","text":"","excerpt":""},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"alternating-primarysecondary-pattern","sectionTitle":"Alternating Primary/Secondary Pattern","text":"APIM subscriptions have two key slots: primary and secondary . Both are valid for API calls at all times. Each rotation cycle regenerates one slot while the other remains untouched: Week 1: Regenerate SECONDARY &mdash; tenants continue using PRIMARY (untouched) Week 2: Regenerate PRIMARY &mdash; tenants continue using SECONDARY (regenerated last week, still valid) Week 3: Regenerate SECONDARY &mdash; alternates indefinitely Both keys are stored in the centralized hub Key Vault after every rotation. Tenants can fetch new keys at their convenience via the APIM internal endpoint or by requesting access from the platform team.","excerpt":"APIM subscriptions have two key slots: primary and secondary . Both are valid for API calls at all times. Each rotation cycle regenerates one slot while the other remains untouched: Week 1: Regenerate SECONDARY &mdash;…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"key-lifecycle-timeline","sectionTitle":"Key Lifecycle Timeline","text":"Event Primary Key Secondary Key Safe to Use Initial key_A key_B Either &check; Rotation 1 (regen secondary) key_A (untouched) key_C (NEW) key_A &check; Rotation 2 (regen primary) key_D (NEW) key_C (untouched) key_C &check; Rotation 3 (regen secondary) key_D (untouched) key_E (NEW) key_D &check; The key NOT being rotated is always safe. You have the full rotation interval to switch to the new key.","excerpt":"Event Primary Key Secondary Key Safe to Use Initial key_A key_B Either &check; Rotation 1 (regen secondary) key_A (untouched) key_C (NEW) key_A &check; Rotation 2 (regen primary) key_D (NEW) key_C (untouched) key_C…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"platform-team-runbook-emergency","sectionTitle":"Platform Team Runbook (Emergency)","text":"","excerpt":""},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"compromised-keys-rotate-both-slots-immediately","sectionTitle":"Compromised Keys: Rotate Both Slots Immediately","text":"Use this runbook only for emergency compromise scenarios where both keys must be replaced right away. This is a manual operational procedure (documentation only). Identify the APIM subscription ID and tenant name. Regenerate secondary and then primary in APIM. Read latest key values from APIM listSecrets . Write both keys to hub Key Vault with 90-day expiry. Update {tenant}-apim-rotation-metadata with safe_slot and timestamps. Notify tenant team to pull new keys from /internal/apim-keys . Example CLI Sequence # Inputs SUBSCRIPTION_ID=\"<azure-subscription-id>\" RESOURCE_GROUP=\"ai-services-hub-dev\" APIM_NAME=\"ai-services-hub-dev-apim\" TENANT=\"wlrs-water-form-assistant\" APIM_SUB_ID=\"<apim-subscription-guid>\" HUB_KV=\"ai-services-hub-dev-hkv\" # 1) Regenerate both slots (secondary first, then primary) az rest --method POST \\ --url \"https://management.azure.com/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.ApiManagement/service/${APIM_NAME}/subscriptions/${APIM_SUB_ID}/regenerateSecondaryKey?api-version=2024-05-01\" az rest --method POST \\ --url \"https://management.azure.com/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.ApiManagement/service/${APIM_NAME}/subscriptions/${APIM_SUB_ID}/regeneratePrimaryKey?api-version=2024-05-01\" # 2) Get current keys from APIM SECRETS_JSON=$(az rest --method POST \\ --url \"https://management.azure.com/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.ApiManagement/service/${APIM_NAME}/subscriptions/${APIM_SUB_ID}/listSecrets?api-version=2024-05-01\") PRIMARY=$(echo \"$SECRETS_JSON\" | jq -r '.primaryKey') SECONDARY=$(echo \"$SECRETS_JSON\" | jq -r '.secondaryKey') EXPIRES_ON=$(date -u -d \"+90 days\" +\"%Y-%m-%dT%H:%M:%SZ\") NOW=$(date -u +\"%Y-%m-%dT%H:%M:%SZ\") # 3) Store keys in hub Key Vault az keyvault secret set --vault-name \"$HUB_KV\" --name \"${TENANT}-apim-primary-key\" --value \"$PRIMARY\" --expires \"$EXPIRES_ON\" az keyvault secret set --vault-name \"$HUB_KV\" --name \"${TENANT}-apim-secondary-key\" --value \"$SECONDARY\" --expires \"$EXPIRES_ON\" # 4) Update metadata METADATA=$(jq -n --arg now \"$NOW\" '{ last_rotated_slot: \"primary\", last_rotation_at: $now, next_rotation_at: \"manual-emergency\", rotation_number: 999, safe_slot: \"secondary\" }') az keyvault secret set \\ --vault-name \"$HUB_KV\" \\ --name \"${TENANT}-apim-rotation-metadata\" \\ --value \"$METADATA\" \\ --content-type \"application/json\" \\ --expires \"$EXPIRES_ON\" Important: This emergency sequence invalidates all previously leaked keys. Coordinate tenant notifications immediately after completion.","excerpt":"Use this runbook only for emergency compromise scenarios where both keys must be replaced right away. This is a manual operational procedure (documentation only). Identify the APIM subscription ID and tenant name.…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"tenant-retrieval-after-emergency-rotation","sectionTitle":"Tenant Retrieval After Emergency Rotation","text":"After platform team rotates both keys, tenant teams should fetch current keys from APIM and switch to the safe_slot key. curl -s -H \"api-key: YOUR_CURRENT_VALID_KEY\" \\ \"https://your-apim-gateway.azure-api.net/YOUR_TENANT/internal/apim-keys\" | jq . # Read the recommended key: # .rotation.safe_slot # Then use .primary_key or .secondary_key accordingly. If the tenant has no valid key left, platform team must provide one-time bootstrap access/key out-of-band.","excerpt":"After platform team rotates both keys, tenant teams should fetch current keys from APIM and switch to the safe_slot key. curl -s -H \"api-key: YOUR_CURRENT_VALID_KEY\" \\…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"configuration","sectionTitle":"Configuration","text":"","excerpt":""},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"shared-config-paramsenvsharedtfvars","sectionTitle":"Shared Config ( params/{env}/shared.tfvars )","text":"Key rotation is configured globally for all tenants in the shared config: apim = { # ... existing APIM config ... key_rotation = { rotation_enabled = true # Master flag (on/off for all tenants) rotation_interval_days = 7 # Rotate every N days (same for all tenants) } } Setting Type Default Description rotation_enabled bool false Master flag. When false , no keys are rotated for any tenant. rotation_interval_days number 7 Days between rotations. Applies uniformly to all tenants.","excerpt":"Key rotation is configured globally for all tenants in the shared config: apim = { # ... existing APIM config ... key_rotation = { rotation_enabled = true # Master flag (on/off for all tenants) rotation_interval_days = 7…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"tenant-prerequisites","sectionTitle":"Tenant Prerequisites","text":"For a tenant to participate in key rotation, it only needs: apim_auth.mode = \"subscription_key\" (default) Note: A per-tenant Key Vault is not required for key rotation. All rotation keys are stored in a centralized hub Key Vault managed by the platform team. Any tenant using subscription_key auth is automatically eligible.","excerpt":"For a tenant to participate in key rotation, it only needs: apim_auth.mode = \"subscription_key\" (default) Note: A per-tenant Key Vault is not required for key rotation. All rotation keys are stored in a centralized hub…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"how-tenants-fetch-new-keys","sectionTitle":"How Tenants Fetch New Keys","text":"Key Insight After rotation, one of your keys is always still valid (the one that was NOT rotated). Use it to call the APIM internal endpoint or continue using your service while you update to the new key.","excerpt":"Key Insight After rotation, one of your keys is always still valid (the one that was NOT rotated). Use it to call the APIM internal endpoint or continue using your service while you update to the new key."},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"option-1-apim-internal-endpoint-simplest","sectionTitle":"Option 1: APIM Internal Endpoint (Simplest)","text":"Call GET /{your-tenant}/internal/apim-keys with ANY valid subscription key. Returns both keys plus rotation metadata as JSON. Bash #!/bin/bash # Fetch both APIM keys via the internal endpoint APIM_GATEWAY=\"https://your-apim-gateway.azure-api.net\" TENANT=\"your-tenant-name\" CURRENT_KEY=\"your-current-valid-key\" RESPONSE=$(curl -s \\ -H \"api-key: ${CURRENT_KEY}\" \\ \"${APIM_GATEWAY}/${TENANT}/internal/apim-keys\") echo \"${RESPONSE}\" | jq . # Example response: # { # \"tenant\": \"your-tenant-name\", # \"primary_key\": \"abc123...\", # \"secondary_key\": \"def456...\", # \"rotation\": { # \"last_rotated_slot\": \"primary\", # \"last_rotation_at\": \"2026-02-11T02:00:00Z\", # \"next_rotation_at\": \"2026-02-18T02:00:00Z\", # \"rotation_number\": 5, # \"safe_slot\": \"secondary\" # }, # \"keyvault\": { # \"uri\": \"https://hub-kv.vault.azure.net/\", # \"primary_key_secret\": \"your-tenant-name-apim-primary-key\", # \"secondary_key_secret\": \"your-tenant-name-apim-secondary-key\" # } # } # Use the safe_slot key (the one NOT just rotated) SAFE_SLOT=$(echo \"${RESPONSE}\" | jq -r '.rotation.safe_slot') if [[ \"${SAFE_SLOT}\" == \"primary\" ]]; then NEW_KEY=$(echo \"${RESPONSE}\" | jq -r '.primary_key') else NEW_KEY=$(echo \"${RESPONSE}\" | jq -r '.secondary_key') fi echo \"Safe key to use: ${NEW_KEY:0:8}...\" Python import requests apim_gateway = \"https://your-apim-gateway.azure-api.net\" tenant = \"your-tenant-name\" current_key = \"your-current-valid-key\" response = requests.get( f\"{apim_gateway}/{tenant}/internal/apim-keys\", headers={\"api-key\": current_key} ) data = response.json() safe_slot = data[\"rotation\"][\"safe_slot\"] # \"primary\" or \"secondary\" safe_key = data[f\"{safe_slot}_key\"] print(f\"Safe slot: {safe_slot}, key: {safe_key[:8]}...\")","excerpt":"Call GET /{your-tenant}/internal/apim-keys with ANY valid subscription key. Returns both keys plus rotation metadata as JSON. Bash #!/bin/bash # Fetch both APIM keys via the internal endpoint…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"option-2-contact-platform-team","sectionTitle":"Option 2: Contact Platform Team","text":"If you've missed a rotation schedule or need a fresh set of keys, contact the platform team directly. The platform team manages the centralized hub Key Vault and can provide your current keys or trigger an ad-hoc rotation. Hub Key Vault: All tenant rotation keys are stored centrally in the hub Key Vault ( {app_name}-{env}-hkv ). Tenants do not need their own Key Vault for rotation. Secret names follow the pattern: {tenant}-apim-primary-key , {tenant}-apim-secondary-key .","excerpt":"If you've missed a rotation schedule or need a fresh set of keys, contact the platform team directly. The platform team manages the centralized hub Key Vault and can provide your current keys or trigger an ad-hoc…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"option-3-automatic-key-refresh-production-pattern","sectionTitle":"Option 3: Automatic Key Refresh (Production Pattern)","text":"For production apps, implement a periodic key check. This pattern uses the APIM endpoint so no Azure SDK is needed. #!/bin/bash # rotate-my-key.sh - Run via cron: 0 3 * * * /path/to/rotate-my-key.sh set -euo pipefail APIM_GATEWAY=\"https://your-apim-gateway.azure-api.net\" TENANT=\"your-tenant-name\" CONFIG_FILE=\"/etc/myapp/apim-key\" # Read the current key your app is using CURRENT_KEY=$(cat \"${CONFIG_FILE}\" 2>/dev/null || echo \"\") if [[ -z \"${CURRENT_KEY}\" ]]; then echo \"ERROR: No current key found in ${CONFIG_FILE}\" exit 1 fi # Fetch both keys via APIM (authenticates with current key) RESPONSE=$(curl -s -H \"api-key: ${CURRENT_KEY}\" \\ \"${APIM_GATEWAY}/${TENANT}/internal/apim-keys\") SAFE_SLOT=$(echo \"${RESPONSE}\" | jq -r '.rotation.safe_slot') if [[ \"${SAFE_SLOT}\" == \"primary\" ]]; then LATEST_KEY=$(echo \"${RESPONSE}\" | jq -r '.primary_key') else LATEST_KEY=$(echo \"${RESPONSE}\" | jq -r '.secondary_key') fi if [[ \"${CURRENT_KEY}\" != \"${LATEST_KEY}\" ]]; then echo \"$(date -u +'%Y-%m-%dT%H:%M:%SZ') Key changed - updating config\" echo \"${LATEST_KEY}\" > \"${CONFIG_FILE}\" # Optionally: systemctl reload myapp else echo \"$(date -u +'%Y-%m-%dT%H:%M:%SZ') Key unchanged\" fi","excerpt":"For production apps, implement a periodic key check. This pattern uses the APIM endpoint so no Azure SDK is needed. #!/bin/bash # rotate-my-key.sh - Run via cron: 0 3 * * * /path/to/rotate-my-key.sh set -euo pipefail…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"key-vault-secrets-reference","sectionTitle":"Key Vault Secrets Reference","text":"All secrets are stored in the centralized hub Key Vault ( {app_name}-{env}-hkv ) with tenant-prefixed names: Secret Name Pattern Description Managed By {tenant}-apim-primary-key Current value of the APIM primary key slot for this tenant. Terraform (seed) + Rotation script {tenant}-apim-secondary-key Current value of the APIM secondary key slot for this tenant. Terraform (seed) + Rotation script {tenant}-apim-rotation-metadata JSON metadata: last rotated slot, safe slot, rotation timestamp, rotation number. Rotation script","excerpt":"All secrets are stored in the centralized hub Key Vault ( {app_name}-{env}-hkv ) with tenant-prefixed names: Secret Name Pattern Description Managed By {tenant}-apim-primary-key Current value of the APIM primary key slot…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"rotation-schedule","sectionTitle":"Rotation Schedule","text":"Environment Interval Schedule Status Dev 7 days Every Monday 02:00 UTC Enabled Test 7 days Every Monday 02:00 UTC Enabled Prod 30 days Every Monday 02:00 UTC (only rotates when interval elapsed) Disabled (pending validation) The GitHub Actions workflow runs weekly, but the bash script checks whether the rotation interval has actually elapsed before regenerating keys. A 30-day interval means the script will skip most weekly runs. Repository Maintenance Required: GitHub automatically disables scheduled workflows after 60 days of repo inactivity. This repo must have regular commits or activity to keep the rotation workflow running. If the workflow gets disabled, re-enable it from the Actions tab or trigger manually via workflow_dispatch . Missed Rotation? If a rotation was missed due to workflow inactivity, tenants can contact the platform team for a new set of keys or to trigger an ad-hoc rotation.","excerpt":"Environment Interval Schedule Status Dev 7 days Every Monday 02:00 UTC Enabled Test 7 days Every Monday 02:00 UTC Enabled Prod 30 days Every Monday 02:00 UTC (only rotates when interval elapsed) Disabled (pending…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"apim-internal-endpoint","sectionTitle":"APIM Internal Endpoint","text":"","excerpt":""},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"get-tenant-nameinternalapim-keys","sectionTitle":"GET /{tenant-name}/internal/apim-keys","text":"When key rotation is enabled, each tenant API exposes an internal endpoint for fetching both subscription keys. Authentication Requires a valid APIM subscription key (either primary or secondary) in the api-key header. APIM validates the key before serving the response. How It Works APIM validates the incoming subscription key (standard APIM behavior) APIM policy uses its managed identity to read secrets from the centralized hub Key Vault Returns JSON with primary key, secondary key, rotation metadata, and Key Vault info Response Example { \"tenant\": \"your-tenant-name\", \"primary_key\": \"abc123def456...\", \"secondary_key\": \"ghi789jkl012...\", \"rotation\": { \"last_rotated_slot\": \"primary\", \"last_rotation_at\": \"2026-02-11T02:00:00Z\", \"next_rotation_at\": \"2026-02-18T02:00:00Z\", \"rotation_number\": 5, \"safe_slot\": \"secondary\" }, \"keyvault\": { \"uri\": \"https://hub-kv.vault.azure.net/\", \"primary_key_secret\": \"your-tenant-name-apim-primary-key\", \"secondary_key_secret\": \"your-tenant-name-apim-secondary-key\" } } Infrastructure The endpoint is implemented purely in APIM policy (no backend service). APIM's system-assigned managed identity is granted Key Vault Secrets User on the centralized hub Key Vault via a single Terraform RBAC assignment (scales to 1000+ tenants). See also: APIM Internal Endpoints reference &mdash; full API reference for all internal endpoints including the new /internal/tenant-info endpoint.","excerpt":"When key rotation is enabled, each tenant API exposes an internal endpoint for fetching both subscription keys. Authentication Requires a valid APIM subscription key (either primary or secondary) in the api-key header.…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"troubleshooting","sectionTitle":"Troubleshooting","text":"","excerpt":""},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"my-api-calls-return-401-after-rotation","sectionTitle":"My API calls return 401 after rotation","text":"Your app is using the key that was just rotated. The other key is still valid. Fix: Fetch both keys: curl -H \"api-key: YOUR_OTHER_KEY\" https://apim/{tenant}/internal/apim-keys Use the safe_slot key from the response Both keys are also in the hub Key Vault: {tenant}-apim-primary-key and {tenant}-apim-secondary-key","excerpt":"Your app is using the key that was just rotated. The other key is still valid. Fix: Fetch both keys: curl -H \"api-key: YOUR_OTHER_KEY\" https://apim/{tenant}/internal/apim-keys Use the safe_slot key from the response Both…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"how-do-i-check-rotation-metadata","sectionTitle":"How do I check rotation metadata?","text":"az keyvault secret show \\ --vault-name HUB_KV_NAME \\ --name \"YOUR_TENANT-apim-rotation-metadata\" \\ --query \"value\" -o tsv | jq . Output: { \"last_rotated_slot\": \"primary\", \"last_rotation_at\": \"2026-02-11T02:00:00Z\", \"next_rotation_at\": \"2026-02-18T02:00:00Z\", \"rotation_number\": 5, \"safe_slot\": \"secondary\" }","excerpt":"az keyvault secret show \\ --vault-name HUB_KV_NAME \\ --name \"YOUR_TENANT-apim-rotation-metadata\" \\ --query \"value\" -o tsv | jq . Output: { \"last_rotated_slot\": \"primary\", \"last_rotation_at\": \"2026-02-11T02:00:00Z\",…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"the-internalapim-keys-endpoint-returns-empty-keys","sectionTitle":"The /internal/apim-keys endpoint returns empty keys","text":"APIM's managed identity may not have access to the hub Key Vault. Verify the RBAC assignment: terraform output apim_key_rotation_summary Ensure the azurerm_role_assignment.apim_keyvault_secrets_user resource exists on the hub Key Vault. Check that the hub Key Vault ( {app_name}-{env}-hkv ) is deployed and accessible.","excerpt":"APIM's managed identity may not have access to the hub Key Vault. Verify the RBAC assignment: terraform output apim_key_rotation_summary Ensure the azurerm_role_assignment.apim_keyvault_secrets_user resource exists on…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"github-actions-rotation-stopped-running","sectionTitle":"GitHub Actions rotation stopped running","text":"GitHub disables scheduled workflows after 60 days of repo inactivity. This repo requires regular maintenance (commits, activity) to keep scheduled workflows active. Go to Actions tab &rarr; Find \"APIM Key Rotation\" workflow Click \"Enable workflow\" Or trigger manually via workflow_dispatch Contact the platform team if rotation was missed &mdash; they can issue new keys or trigger an ad-hoc rotation","excerpt":"GitHub disables scheduled workflows after 60 days of repo inactivity. This repo requires regular maintenance (commits, activity) to keep scheduled workflows active. Go to Actions tab &rarr; Find \"APIM Key Rotation\"…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"i-want-to-temporarily-disable-rotation-for-my-environment","sectionTitle":"I want to temporarily disable rotation for my environment","text":"Set rotation_enabled = false in params/{env}/shared.tfvars and deploy. The rotation workflow will skip all tenants.","excerpt":"Set rotation_enabled = false in params/{env}/shared.tfvars and deploy. The rotation workflow will skip all tenants."},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"my-tenant-is-not-eligible-for-rotation","sectionTitle":"My tenant is not eligible for rotation","text":"Check: terraform output apim_key_rotation_summary Common reasons: apim_auth.mode != \"subscription_key\" &mdash; rotation only applies to subscription key auth Rotation is globally disabled ( rotation_enabled = false in shared.tfvars )","excerpt":"Check: terraform output apim_key_rotation_summary Common reasons: apim_auth.mode != \"subscription_key\" &mdash; rotation only applies to subscription key auth Rotation is globally disabled ( rotation_enabled = false in…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"architecture","sectionTitle":"Architecture","text":"","excerpt":""},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"component-overview","sectionTitle":"Component Overview","text":"Component Purpose Location Rotation Script Self-contained bash script: discovers APIM + hub KV, rotates keys, stores in hub KV infra-ai-hub/scripts/rotate-apim-keys.sh GitHub Actions Workflow Thin wrapper: checkout, OIDC login, calls script with --environment .github/workflows/apim-key-rotation.yml Hub Key Vault Centralized KV storing ALL tenant rotation keys (scales to 1000+ tenants) infra-ai-hub/main.tf ( module.hub_key_vault ) APIM Policy Endpoint Internal /apim-keys route reads from hub KV infra-ai-hub/params/apim/api_policy.xml.tftpl Terraform Config Seeds initial KV secrets, rotation metadata, single RBAC for APIM MI &rarr; hub KV infra-ai-hub/main.tf (key rotation section) Shared Config Rotation enabled flag + interval days infra-ai-hub/params/{env}/shared.tfvars","excerpt":"Component Purpose Location Rotation Script Self-contained bash script: discovers APIM + hub KV, rotates keys, stores in hub KV infra-ai-hub/scripts/rotate-apim-keys.sh GitHub Actions Workflow Thin wrapper: checkout, OIDC…"},{"page":"apim-key-rotation.html","pageTitle":"APIM Subscription Key Rotation","sectionId":"security-considerations","sectionTitle":"Security Considerations","text":"OIDC Authentication : The rotation workflow uses the same OIDC identity as Terraform deployments. No stored secrets. Centralized Hub Key Vault : All rotation keys are stored in a single hub KV. APIM reads keys via its system-assigned MI with one RBAC assignment. Scales to 1000+ tenants. No Per-Tenant KV Required : Tenants do not need their own Key Vault for rotation. The hub KV handles all tenants centrally. Audit Trail : Every key change is versioned in Key Vault with rotation metadata tags. No Key in Logs : The rotation script never prints key values. Only metadata appears in logs. Terraform Lifecycle : Key Vault secrets use ignore_changes = [value, tags] so Terraform won't overwrite rotated keys. Internal Endpoint Security : The /internal/apim-keys endpoint requires a valid subscription key. Only authenticated tenants can read their own keys. AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"OIDC Authentication : The rotation workflow uses the same OIDC identity as Terraform deployments. No stored secrets. Centralized Hub Key Vault : All rotation keys are stored in a single hub KV. APIM reads keys via its…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"cost-tracking","sectionTitle":"Cost Tracking","text":"Work in Progress This page is under active development. Cost tracking architecture and chargeback processes are being finalised. See ADR-012 for the decision record. How costs are tracked and allocated for each project in the AI Hub.","excerpt":"Work in Progress This page is under active development. Cost tracking architecture and chargeback processes are being finalised. See ADR-012 for the decision record. How costs are tracked and allocated for each project…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"architecture","sectionTitle":"Architecture","text":"","excerpt":""},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"what-each-project-gets","sectionTitle":"What Each Project Gets","text":"Resource Type Description Resource Group Dedicated rg-{project}-{env} - contains all project resources Storage Account Dedicated Project documents and data Search Service Dedicated Project indexes for RAG Key Vault Dedicated Project secrets and keys AI Foundry Project Dedicated Project's own API endpoint, prompt flows, index (within shared Hub) APIM Subscription Dedicated Project's API key for access AI Models (GPT-4, etc.) Shared Deployed once in Hub, accessed via AI Foundry Project APIM, App Gateway, Firewall Shared Entry point infrastructure Azure Proxy (Chisel Server) Shared App Service running Chisel SOCKS5 proxy for CI/CD private-endpoint access (always-on) CI/CD Runners (GitHub self-hosted) Optional Optional Container Apps job + ACR + Log Analytics — provisioned only when github_runners_aca_enabled = true ; not used by this platform’s own CI/CD","excerpt":"Resource Type Description Resource Group Dedicated rg-{project}-{env} - contains all project resources Storage Account Dedicated Project documents and data Search Service Dedicated Project indexes for RAG Key Vault…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"terraform-deploys-everything","sectionTitle":"Terraform Deploys Everything","text":"Tenant stacks are deployed with deploy-scaled.sh which runs Terraform across five isolated state files. Resource AVM modules are used where available ; raw Terraform resources are used when an AVM module does not exist. # deploy-scaled.sh executes 3 phases: # Phase 1: shared foundation (network, KV, AppGW, WAF) # Phase 2: per-tenant stacks (parallel, isolated state) # Phase 3: foundry + apim + tenant-user-mgmt # # Each stack corresponds to an infra-ai-hub/stacks/* directory.","excerpt":"Tenant stacks are deployed with deploy-scaled.sh which runs Terraform across five isolated state files. Resource AVM modules are used where available ; raw Terraform resources are used when an AVM module does not exist.…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"avm-modules-used","sectionTitle":"AVM Modules Used","text":"Resource AVM Module Storage Account avm-res-storage-storageaccount Search Service avm-res-search-searchservice Key Vault avm-res-keyvault-vault AI Foundry Hub avm-res-machinelearningservices-workspace API Management avm-res-apimanagement-service Application Gateway avm-res-network-applicationgateway Virtual Network avm-res-network-virtualnetwork","excerpt":"Resource AVM Module Storage Account avm-res-storage-storageaccount Search Service avm-res-search-searchservice Key Vault avm-res-keyvault-vault AI Foundry Hub avm-res-machinelearningservices-workspace API Management…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"how-cost-tracking-works","sectionTitle":"How Cost Tracking Works","text":"","excerpt":""},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"direct-costs","sectionTitle":"Direct Costs","text":"Storage, Search, Key Vault Tracked automatically by Azure Cost Management using Resource Group tags. ~40% of total","excerpt":"Storage, Search, Key Vault Tracked automatically by Azure Cost Management using Resource Group tags. ~40% of total"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"ai-usage","sectionTitle":"AI Usage","text":"Tokens, API calls Tracked by AI Foundry per project. Each AI Foundry Project has its own metrics. ~45% of total","excerpt":"Tokens, API calls Tracked by AI Foundry per project. Each AI Foundry Project has its own metrics. ~45% of total"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"platform-split","sectionTitle":"Platform Split","text":"APIM, Gateway, Firewall Split evenly across all projects (shared infrastructure). ~15% of total","excerpt":"APIM, Gateway, Firewall Split evenly across all projects (shared infrastructure). ~15% of total"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"cicd-runner-costs","sectionTitle":"CI/CD Runner Costs (Self-hosted GitHub runners)","text":"The optional github_runners_aca module provisions self-hosted runners inside the VNet for tenant CI/CD pipelines that need private endpoint access. Runners run as Azure Container Apps jobs (scale-to-zero) with supporting services (ACR + Log Analytics). Note: this repo's own CI/CD uses public GitHub runners + the Chisel tunnel instead.","excerpt":"The optional github_runners_aca module provisions self-hosted runners inside the VNet for tenant CI/CD pipelines that need private endpoint access. Runners run as Azure Container Apps jobs (scale-to-zero) with supporting…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"cost-drivers","sectionTitle":"Cost Drivers","text":"Runner compute: Container Apps job runtime (primary driver; usage-based) Concurrency cap: max_runners (default 4) Sizing: container_cpu (default 1 vCPU) and container_memory (default 2Gi) Logs: Log Analytics ingestion (GB/month) Images: ACR Premium base cost (fixed) + storage/transfer (Premium is required for Private Link / private endpoints)","excerpt":"Runner compute: Container Apps job runtime (primary driver; usage-based) Concurrency cap: max_runners (default 4) Sizing: container_cpu (default 1 vCPU) and container_memory (default 2Gi) Logs: Log Analytics ingestion…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"sample-calculation-module-defaults","sectionTitle":"Sample Calculation (module defaults)","text":"Assumptions: 20 jobs/day, 10 min/job, avg concurrency = 1.5 Monthly runner hours = 30 * 20 * (10/60) * 1.5 = 150 hours Total seconds = 150 * 3600 = 540,000 seconds Canada Central rates (Container Apps): vCPU-seconds: $0.0000480/sec GiB-seconds: $0.0000057/sec Requests: $0.565 per million vCPU cost = 540,000 * 1 vCPU * 0.0000480 = $25.92 Memory cost = 540,000 * 2 GiB * 0.0000057 = $6.16 Request cost (example 1M req/mo) = $0.57 Estimated runner compute total ≈ $32.65/mo ACR Premium base cost = $2.351/day ≈ $70.53/mo (30-day month) Estimated compute + ACR base ≈ $103.18/mo Assumes a single-region ACR Premium registry with no geo-replication and no connected registry . Add Log Analytics ingestion (GB/month) and any ACR transfer/storage beyond the included 500 GB for a full estimate.","excerpt":"Assumptions: 20 jobs/day, 10 min/job, avg concurrency = 1.5 Monthly runner hours = 30 * 20 * (10/60) * 1.5 = 150 hours Total seconds = 150 * 3600 = 540,000 seconds Canada Central rates (Container Apps): vCPU-seconds:…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"example-monthly-costs","sectionTitle":"Example Monthly Costs","text":"","excerpt":""},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"health-rag-project","sectionTitle":"Health-RAG Project","text":"Storage + Search + KV $420 DIRECT AI usage (60% of tokens) $1,020 AI Platform share (50%) $300 SPLIT Total $1,740","excerpt":"Storage + Search + KV $420 DIRECT AI usage (60% of tokens) $1,020 AI Platform share (50%) $300 SPLIT Total $1,740"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"sdpr-chatbot-project","sectionTitle":"SDPR-Chatbot Project","text":"Storage + Search + KV $350 DIRECT AI usage (40% of tokens) $680 AI Platform share (50%) $300 SPLIT Total $1,330","excerpt":"Storage + Search + KV $350 DIRECT AI usage (40% of tokens) $680 AI Platform share (50%) $300 SPLIT Total $1,330"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"usage-monitoring-cost-allocation-and-chargeback-metrics","sectionTitle":"Usage Monitoring, Cost Allocation, and Chargeback Metrics","text":"","excerpt":""},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"introduction","sectionTitle":"Introduction","text":"This document defines the approach for implementing Usage Monitoring , Cost Allocation , and Chargeback Metrics for the BC Government AI Services Hub multi-tenant platform. These three interconnected capabilities are essential for operating a shared AI infrastructure that serves multiple ministries while maintaining cost transparency and accountability. Key Concepts Usage Monitoring tracks resource consumption at the tenant level to support both cost allocation and operational insights. For the AI Services Hub, monitoring serves two purposes: capturing metrics for shared infrastructure allocation (APIM, App Gateway) and providing operational visibility into service usage patterns. Cost Allocation combines Azure's native cost tracking with custom calculations for shared resources. The hub architecture uses two allocation models: direct attribution for tenant-dedicated resources (AI Foundry projects with their own Azure OpenAI, Cosmos DB, and AI Search; dedicated Document Intelligence instances), and proportional allocation for shared infrastructure (APIM, App Gateway, monitoring services) where costs are split based on actual usage percentages. Chargeback Metrics aggregate all cost components—direct resource costs from Azure billing and allocated shared infrastructure costs—into consolidated monthly invoices per tenant. Document Scope This document covers: Tagging strategies for both dedicated and shared resources across the dual-region deployment (Canada Central/East) Usage tracking pipelines using APIM, Event Hubs, and Azure Functions to capture metrics for shared infrastructure allocation Cost calculation methods combining Azure Cost Management (for direct attribution) with custom allocation logic (for shared infrastructure) Implementation patterns with code examples for usage tracking, cost allocation functions, and Kusto queries for chargeback reporting Network egress tracking to handle cross-region costs between Canada Central (APIM/App Gateway) and Canada East (AI Foundry) The approach leverages APIM as the central governance point where all AI requests flow—regardless of whether backend services are inside the Foundry landing zone (OpenAI, AI Search) or outside it (Document Intelligence). APIM routing policies direct each tenant to their appropriate backend resources, enabling consistent tenant identification for shared infrastructure cost allocation.","excerpt":"This document defines the approach for implementing Usage Monitoring , Cost Allocation , and Chargeback Metrics for the BC Government AI Services Hub multi-tenant platform. These three interconnected capabilities are…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"usage-monitoring-metrics","sectionTitle":"Usage Monitoring Metrics","text":"Azure API Management (APIM) provides centralized monitoring as all AI requests flow through the gateway. Monitoring serves two distinct purposes: tracking metrics for shared infrastructure allocation and providing operational insights. Metrics for Shared Infrastructure Allocation These metrics are used to proportionally split shared infrastructure costs (APIM, App Gateway, networking): API call volume : Request count per tenant—used to allocate APIM and App Gateway costs Network egress bytes : Response payload size per tenant—used to allocate cross-region data transfer costs Log ingestion (GB) : Application Insights data volume per tenant—used to allocate monitoring costs Operational Metrics (Not for Chargeback) These metrics support capacity planning, SLA monitoring, and performance optimization: Token consumption breakdown : Which models each tenant uses and token volume (for capacity planning) Document Intelligence pages : Pages processed per tenant (for capacity planning) Query latency : Response times per service/tenant Error rates : Failed requests for support escalation Concurrent connections : Active sessions per tenant Monitoring Architecture APIM logs requests/responses with tenant-id to Azure Event Hubs Azure Functions process Event Hub messages to: Count API calls per tenant (for APIM/Gateway allocation) Sum network egress bytes per tenant (for data transfer allocation) Extract operational metrics (tokens, pages, latency) Results stored in Log Analytics : Allocation metrics used in monthly shared cost calculations Operational metrics used for dashboards and SLA reporting","excerpt":"Azure API Management (APIM) provides centralized monitoring as all AI requests flow through the gateway. Monitoring serves two distinct purposes: tracking metrics for shared infrastructure allocation and providing…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"resource-tagging-and-cost-allocation","sectionTitle":"Resource Tagging and Cost Allocation","text":"AI Foundry Projects (Direct Attribution) Each tenant receives a dedicated Foundry project with isolated resources. Azure automatically bills all consumption (Azure OpenAI tokens, Cosmos DB, AI Search) to the project. Tagging strategy : Project: \"tenant-wlrs-water-permits\" Tags: - tenant-id: \"wlrs\" - cost-center: \"CC-NRM-WLRS\" - department: \"Natural-Resources\" - environment: \"production\" - service-tier: \"standard\" Cost allocation : Direct attribution via Azure Cost Management tag filtering. Query Tags[\"tenant-id\"] == \"wlrs\" shows all Foundry project costs including: Azure OpenAI token consumption (all models, prompt/completion/safety tokens) Cosmos DB storage and operations AI Search queries and indexing Foundry artifact storage No manual calculation needed —Azure bills these resources directly to each project. Document Intelligence (Direct Attribution) Architectural Decision : Deploy one dedicated Document Intelligence resource per tenant Rationale : Simplified cost allocation : Direct attribution via tags, no proportional calculation needed Performance isolation : No \"noisy neighbor\" concerns with dedicated resources Compliance : Easier to meet ministry-specific data residency requirements Scaling : Each tenant can independently scale their DI instance Resources : docint-wlrs (Canada Central) docint-sdpr (Canada Central) Tags (on each DI resource): Tags: - tenant-id: \"wlrs\" OR \"sdpr\" - shared-service: \"no\" - resource-type: \"document-intelligence\" - managed-by: \"ai-services-hub\" Cost allocation : Direct attribution via Azure Cost Management tag filtering. Azure Cost Management query: Tags[\"tenant-id\"] == \"wlrs\" shows WLRS's DI costs (page processing charges) directly. Usage tracking (for operational metrics only): APIM logs pages processed per tenant to Event Hubs Used for: capacity planning, SLA monitoring, usage trends NOT used for cost allocation (costs already directly attributed via tags) Implementation : Deploy DI resources in same subscription as AI Services Hub Configure APIM backends pointing to each DI instance Use APIM set-backend-service policy for tenant routing","excerpt":"AI Foundry Projects (Direct Attribution) Each tenant receives a dedicated Foundry project with isolated resources. Azure automatically bills all consumption (Azure OpenAI tokens, Cosmos DB, AI Search) to the project.…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"infrastructure-and-platform-costs-proportional-allocation","sectionTitle":"Infrastructure and Platform Costs (Proportional Allocation)","text":"These shared resources serve all tenants and require proportional cost allocation based on usage metrics. App Gateway/WAF Tags : Tags: - shared-service: \"yes\" - resource-type: \"app-gateway-waf-v2\" - allocation-method: \"request-count-proportional\" Cost structure : Fixed: ~$323/month (split equally across active tenants) Variable: Allocated by capacity units consumed Allocation method : Proportional based on request count from App Gateway access logs APIM V2 Tags : Tags: - shared-service: \"yes\" - allocation-method: \"api-call-proportional\" Cost structure : $1,000-2,000/month depending on tier Allocation method : Based on API call volume per tenant from Event Hubs AI Foundry Hub Dependencies Storage Account (Foundry hub-level): Shared storage account for Foundry hub artifacts, flows, evaluations Tags : foundry-dependency: \"hub-storage\" allocated-to: \"all-projects\" Allocation method : Split equally across active projects OR by storage consumption if measurable Note : Individual project storage is billed directly to each project (direct attribution) Application Insights/Log Analytics : Required for Foundry monitoring Cost based on data ingestion volume (GB) Tags : monitoring-service: \"foundry\" allocation-method: \"proportional\" Allocation method : By log volume per project (if tenant-id in logs) Key Vault : Stores connection strings for each project Transaction-based pricing (~$0.03/10k transactions) Tags : foundry-dependency: \"secrets\" shared-service: \"yes\" Allocation method : By transaction count per project (minimal cost impact) Network Egress Cost structure : First 100 GB/month free per region Then tiered pricing: $0.087/GB (next 10 TB), $0.067/GB (next 40 TB), etc. Risk in dual-region setup : Cross-region traffic between Canada East (Foundry) and Canada Central (APIM) incurs egress charges Tags : Tags: - traffic-source: \"canada-east-foundry\" - traffic-destination: \"canada-central-apim\" - allocation-method: \"tenant-response-bytes\" Tracking mechanism : App Gateway diagnostic logs (not Azure Cost Management tags) Note : Egress is billed at subscription level, requires custom calculation from logs (see implementation section below) Regional Cost Tracking The dual-region deployment (Canada Central for APIM/App Gateway, Canada East for Foundry) requires regional cost tracking. All resources must include : Tags: - deployment-region: \"canada-central\" OR \"canada-east\" - primary-region: \"canada-central\" Why this matters : Pricing variations : Some Azure services have different pricing between Canada Central and Canada East Cross-region attribution : When WLRS uses Foundry in Canada East but APIM in Canada Central, costs must be attributed correctly Egress tracking : Cross-region traffic needs regional source/destination tags","excerpt":"These shared resources serve all tenants and require proportional cost allocation based on usage metrics. App Gateway/WAF Tags : Tags: - shared-service: \"yes\" - resource-type: \"app-gateway-waf-v2\" - allocation-method:…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"chargeback-metrics-summary","sectionTitle":"Chargeback Metrics Summary","text":"Monthly tenant invoices combine two cost categories: Direct Costs (Azure-Billed, No Calculation Needed) Retrieved via Azure Cost Management tag filtering ( tenant-id ): AI Foundry project costs : All Azure OpenAI consumption (tokens), Cosmos DB, AI Search, project storage Document Intelligence costs : Page processing charges for dedicated DI instance Foundry compute costs : Any custom agent execution resources (if applicable) Allocated Costs (Calculated from Usage Metrics) Proportionally split based on tenant usage: APIM costs : Split by API call volume per tenant App Gateway costs : Split by request count per tenant Network egress costs : Split by response bytes per tenant Application Insights costs : Split by log ingestion volume per tenant Shared storage costs : Split equally or by consumption across Foundry projects","excerpt":"Monthly tenant invoices combine two cost categories: Direct Costs (Azure-Billed, No Calculation Needed) Retrieved via Azure Cost Management tag filtering ( tenant-id ): AI Foundry project costs : All Azure OpenAI…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"implementation-cost-calculation-methods","sectionTitle":"Implementation: Cost Calculation Methods","text":"Method 1: Azure Cost Management (Built-in, No Code) Azure Cost Management handles all direct attribution automatically. No custom code needed for tenant-dedicated resources. Step 1: Enable Tag Inheritance Azure Portal → Cost Management → Settings → Configuration → Enable \"Automatically apply subscription and resource group tags to new data\" This propagates tags from subscriptions/resource groups down to individual usage records. Step 2: View Direct Attribution Costs Cost Analysis → Add Filter → Tag → Select \"tenant-id\" → Choose \"wlrs\" This shows all costs where tenant-id = wlrs , including: Foundry project (Azure OpenAI tokens, Cosmos DB, AI Search, storage) Document Intelligence (page processing) Any other dedicated resources This is direct attribution —Azure calculates it automatically based on actual consumption. Step 3: Create Cost Allocation Rules for Shared Resources This is where shared infrastructure costs (APIM, App Gateway) get split: Cost Management → Cost Allocation Rules → Add Rule SOURCE (what to split): - Resource Group: \"rg-ai-hub-shared-infra\" - Tag filter: shared-service = \"yes\" TARGETS (who receives the split): - Tag: tenant-id = \"wlrs\" - Tag: tenant-id = \"sdpr\" - Tag: tenant-id = \"other-ministry\" ALLOCATION METHOD: Option A: \"Distribute evenly\" → Each tenant gets 33.33% Option B: \"Total cost proportional\" → Split based on each tenant's existing costs Option C: \"Custom percentage\" → Manually set: WLRS 45%, SDPR 30%, Others 25% Limitation : The \"proportional\" options only work based on existing Azure costs , not custom metrics like \"API call count\". For usage-based allocation, use Method 2 below. Result : Monthly report showing allocated costs per tenant: WLRS: $5,230 (includes $675 allocated from shared APIM) SDPR: $3,100 (includes $450 allocated from shared APIM) Method 2: Custom Calculation (Usage-Based Allocation) For proportional allocation based on usage metrics (API calls, egress bytes), custom code is required. Architecture Event Hubs (usage data) → Azure Function (calculate percentages) → Log Analytics (store allocation data) → Power BI/Cost Dashboard (reporting) Step 1: Calculate Tenant Usage Percentages Azure Function runs monthly (triggered by timer): # Pseudo-code for monthly allocation calculation import kusto_client # Query Event Hub processed data for API call counts query = \"\"\" customEvents | where timestamp >= startofmonth(now()) and timestamp Step 2: Query Azure Cost Management API for Shared Resource Costs from azure.mgmt.costmanagement import CostManagementClient # Get actual costs for shared resources cost_query = { \"type\": \"ActualCost\", \"timeframe\": \"MonthToDate\", \"filter\": { \"tags\": { \"name\": \"shared-service\", \"operator\": \"In\", \"values\": [\"yes\"] } } } shared_costs = cost_client.query(scope, cost_query) # Result: APIM = $1,500, App Gateway = $400, Total = $1,900 Step 3: Apply Allocation Percentages # Calculate each tenant's share of shared infrastructure apim_cost = 1500 app_gateway_cost = 400 tenant_allocations = { \"wlrs\": { \"apim\": apim_cost * 0.45, # $675 \"gateway\": app_gateway_cost * 0.45, # $180 \"total_shared\": 855 }, \"sdpr\": { \"apim\": apim_cost * 0.30, # $450 \"gateway\": app_gateway_cost * 0.30, # $120 \"total_shared\": 570 }, \"others\": { \"apim\": apim_cost * 0.25, # $375 \"gateway\": app_gateway_cost * 0.25, # $100 \"total_shared\": 475 } } Step 4: Write Allocation Results to Log Analytics # Store calculated allocations for reporting log_analytics_client.post( workspace_id, log_type=\"SharedCostAllocation\", json=[ { \"Month\": \"2026-01\", \"TenantId\": \"wlrs\", \"APIManagement\": 675, \"AppGateway\": 180, \"NetworkEgress\": 0, # Calculated separately in Step 5 \"TotalSharedCost\": 855, \"AllocationMethod\": \"api-call-proportional\" }, # ... repeat for other tenants ] ) Step 5: Calculate Network Egress Costs Network egress is billed at the subscription level and requires custom calculation from diagnostic logs. Enable Network Diagnostics : App Gateway → Diagnostic Settings → Send to Log Analytics → Enable \"Access Logs\" (contains bytes sent per request) Query Logs to Calculate Per-Tenant Egress : AzureDiagnostics | where ResourceType == \"APPLICATIONGATEWAYS\" | where Category == \"ApplicationGatewayAccessLog\" | extend TenantId = extract(\"tenant=([^&]+)\", 1, requestUri_s) // Parse from URL | summarize TotalEgressGB = sum(sentBytes_d) / 1073741824 by TenantId | extend EgressCost = case( TotalEgressGB 10240, (10140 * 0.087) + ((TotalEgressGB - 10240) * 0.067) # Tiered ) Write these egress costs to the `SharedCostAllocation` table alongside other shared infrastructure costs. Step 6: Combine All Costs in Final Chargeback Report Monthly Kusto query for chargeback: // Direct costs from Azure Cost Management (Foundry projects, DI instances) let DirectCosts = AzureCosts | where Tags[\"tenant-id\"] != \"\" | summarize DirectCost = sum(Cost) by TenantId = Tags[\"tenant-id\"]; // Allocated shared infrastructure costs from custom calculation let AllocatedCosts = SharedCostAllocation_CL | where Month == startofmonth(now()) | summarize AllocatedCost = sum(TotalSharedCost) by TenantId; // Final chargeback report DirectCosts | join kind=leftouter AllocatedCosts on TenantId | extend TotalChargeback = DirectCost + AllocatedCost | project TenantId, DirectCost, AllocatedCost, TotalChargeback Output : TenantId DirectCost AllocatedCost TotalChargeback wlrs $4,200 $855 $5,055 sdpr $2,400 $570 $2,970 Note : DirectCost includes all Azure OpenAI token consumption, Document Intelligence page processing, Cosmos DB, AI Search, and storage—automatically calculated by Azure based on actual usage.","excerpt":"Method 1: Azure Cost Management (Built-in, No Code) Azure Cost Management handles all direct attribution automatically. No custom code needed for tenant-dedicated resources. Step 1: Enable Tag Inheritance Azure Portal →…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"summary","sectionTitle":"Summary","text":"This document establishes a comprehensive cost tracking framework for the AI Services Hub using: Direct attribution for tenant-dedicated resources (Foundry projects with Azure OpenAI/Cosmos/AI Search, Document Intelligence instances)—Azure automatically bills these based on actual consumption Proportional allocation for shared infrastructure (APIM, App Gateway, monitoring)—custom calculations split costs based on API call volume and network usage Minimal custom tracking via Event Hubs and Azure Functions—only needed for shared infrastructure allocation, not for AI service consumption Dual calculation methods : Azure Cost Management for tag-based direct attribution (90% of costs), and custom code for usage-based shared infrastructure allocation (10% of costs) The implementation provides full cost transparency while minimizing operational overhead—most costs are automatically tracked by Azure, with custom calculations only for shared platform services.","excerpt":"This document establishes a comprehensive cost tracking framework for the AI Services Hub using: Direct attribution for tenant-dedicated resources (Foundry projects with Azure OpenAI/Cosmos/AI Search, Document…"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"related","sectionTitle":"Related","text":"","excerpt":""},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"adr-006","sectionTitle":"ADR-006","text":"Multi-Tenant Isolation","excerpt":"Multi-Tenant Isolation"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"diagrams","sectionTitle":"Diagrams","text":"Architecture diagrams","excerpt":"Architecture diagrams"},{"page":"cost.html","pageTitle":"Cost Tracking","sectionId":"terraform-reference","sectionTitle":"Terraform Reference","text":"Module variable & output docs AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"Module variable & output docs AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"architecture-decision-records","sectionTitle":"Architecture Decision Records","text":"This page documents key architectural decisions for the AI Services Hub infrastructure. Each ADR explains the context, decision, and consequences to help future maintainers understand why things are built the way they are. BC Government Policy Context Most decisions documented here are driven by BC Government security policies , not optional architectural choices. Key policy constraints include: No public endpoints - All Azure services must use private endpoints only Private networking required - Resources must be isolated within VNets No long-lived secrets - Credential rotation policies favor OIDC/managed identities Bastion-only access - Direct SSH/RDP from internet is prohibited","excerpt":"This page documents key architectural decisions for the AI Services Hub infrastructure. Each ADR explains the context, decision, and consequences to help future maintainers understand why things are built the way they…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"start-here-adr-001","sectionTitle":"Start Here: ADR-001","text":"ADR-001 (Shared Landing Zone) is the foundation that explains why all the other infrastructure exists. Read it first to understand the architecture. About ADRs Architecture Decision Records capture decisions along with their context and consequences. They help prevent re-litigating settled discussions and provide onboarding context for new team members.","excerpt":"ADR-001 (Shared Landing Zone) is the foundation that explains why all the other infrastructure exists. Read it first to understand the architecture. About ADRs Architecture Decision Records capture decisions along with…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-index","sectionTitle":"Decision Index","text":"ID Title Driver Status ADR-001 Shared AI Landing Zone Policy Accepted ADR-002 Use OIDC instead of Service Principal Secrets Policy Accepted ADR-003 Optional Use of Azure Bastion for VM Access Policy Accepted ADR-004 Private Endpoints for All Azure Services Policy Accepted ADR-005 Zero-Dependency Documentation System Choice Accepted ADR-006 Terraform as Infrastructure as Code (IaC) Choice Accepted ADR-007 Client Connectivity via App Gateway + APIM Policy Accepted ADR-008 No Azure Portal or Foundry Studio UI Access Policy Pending Platform/MS ADR-009 Why AI Landing Zone vs Custom Solution Choice Accepted ADR-010 Multi-Tenant Isolation Model Policy Accepted ADR-011 Control Plane vs Data Plane Access & Chisel Tunnel Policy Accepted ADR-012 Usage Monitoring, Cost Allocation and Chargeback Metrics Operations Proposed ADR-013 Scaled Stack Architecture with Isolated State Files Choice Accepted ADR-014 APIM Subscription Key Rotation Choice Proposed ADR-015 Tenant Isolation: Resource Group vs Subscription Policy Pending Platform/MS ADR-001: Shared AI Landing Zone Accepted Status: Accepted Date: 2025-01 Driver: Policy Required Category: Architecture This is the foundational ADR. It explains why we need VNets, Bastion, Jumpbox, and the Chisel tunnel CI/CD approach. All other ADRs build on these concepts.","excerpt":"ID Title Driver Status ADR-001 Shared AI Landing Zone Policy Accepted ADR-002 Use OIDC instead of Service Principal Secrets Policy Accepted ADR-003 Optional Use of Azure Bastion for VM Access Policy Accepted ADR-004…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context","sectionTitle":"Context","text":"Policy Driver: BC Gov requires all Azure services to use private endpoints only for data plane access. GitHub Actions runners on the public internet cannot reach private endpoints. This creates a fundamental problem: how do we run Terraform if GitHub can't talk to Azure resources?","excerpt":"Policy Driver: BC Gov requires all Azure services to use private endpoints only for data plane access. GitHub Actions runners on the public internet cannot reach private endpoints. This creates a fundamental problem: how…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"the-problem-why-cant-github-just-run-terraform-directly","sectionTitle":"The Problem: Why Can't GitHub Just Run Terraform Directly?","text":"The Network Barrier When you run terraform apply from GitHub Actions, here's what happens: GitHub spins up a runner (a VM on Microsoft's public cloud) Terraform tries to connect to Azure PaaS services for data plane access for ec: key vault secrets BLOCKED - KV has no public endpoint Terraform tries to connect to Key Vault, databases, etc. BLOCKED - All services data plane access are private-only within the vnet. Result: Terraform can run from the public internet but limited to Storage account and control plane access of Azure resources.","excerpt":"The Network Barrier When you run terraform apply from GitHub Actions, here's what happens: GitHub spins up a runner (a VM on Microsoft's public cloud) Terraform tries to connect to Azure PaaS services for data plane…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"the-solution-landing-zone-architecture","sectionTitle":"The Solution: Landing Zone Architecture","text":"We need infrastructure inside the private network that can: Receive commands from GitHub (via OIDC tokens) Run Terraform against private endpoints Allow humans to access resources for debugging VNet (Virtual Network) What: Private network in Azure Why: All resources live here, isolated from public internet Analogy: The building's internal network Jumpbox VM What: Linux VM inside the VNet Why: Runs Terraform, can reach all private endpoints Analogy: A workstation inside the secure office Azure Bastion What: Managed gateway service Why: Secure way to access Jumpbox (no public SSH) Analogy: The secure lobby with ID verification","excerpt":"We need infrastructure inside the private network that can: Receive commands from GitHub (via OIDC tokens) Run Terraform against private endpoints Allow humans to access resources for debugging VNet (Virtual Network)…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"how-terraform-actually-runs","sectionTitle":"How Terraform Actually Runs","text":"┌─────────────────────────────────────────────────────────────────────────┐ │ DEPLOYMENT FLOW │ ├─────────────────────────────────────────────────────────────────────────┤ │ │ │ GitHub Actions │ Azure Landing Zone (Private Network) │ │ (Public Internet) │ │ │ │ │ │ ┌──────────────┐ OIDC │ ┌──────────────┐ ┌─────────────────┐ │ │ │ GitHub-Hosted│───────▶│ │ Azure Proxy │───▶│ Private │ │ │ │ Runner │ │ │ (Chisel App │ │ Endpoints │ │ │ │ ubuntu-24.04 │◀SOCKS5─┘ │ Service) │ │ (Storage, KV) │ │ │ └──────────────┘ │ └──────────────┘ └─────────────────┘ │ │ │ │ │ │ ▼ │ │ │ ┌──────────────┐ │ │ │ │ terraform │ │ │ │ │ plan/apply │ │ │ │ └──────────────┘ │ │ │ (via SOCKS tunnel) │ │ └─────────────────────────────────────────────────────────────────────────┘ Two deployment options: Option A: Chisel Tunnel with GitHub-Hosted Runners Standard GitHub-hosted runners ( ubuntu-24.04 ) combined with a Chisel SOCKS5 proxy deployed as an Azure App Service inside the VNet. This eliminates the need for persistent self-hosted runner infrastructure. GitHub-hosted runner starts (ephemeral, no maintenance) Workflow deploys/starts the Chisel proxy App Service Runner connects through SOCKS5 tunnel into VNet Terraform traffic routed via tunnel to private endpoints No persistent runner pool needed — pay only for workflow minutes 💡 Implementation: The azure-proxy/chisel container runs on an App Service Plan inside the tools VNet subnet. The .deployer.yml reusable workflow deploys it first, then subsequent steps use it as a SOCKS proxy via ALL_PROXY environment variable. Used by this platform for all CI/CD Option B: Jumpbox + Bastion Manual access via Bastion for debugging, testing, and emergency fixes. Human connects via Azure Portal Bastion brokers SSH connection Land on Jumpbox inside VNet Run commands, debug issues Required for human access","excerpt":"┌─────────────────────────────────────────────────────────────────────────┐ │ DEPLOYMENT FLOW │ ├─────────────────────────────────────────────────────────────────────────┤ │ │ │ GitHub Actions │ Azure Landing Zone…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"what-about-other-repositories","sectionTitle":"What About Other Repositories?","text":"✅ Good News: Other repos do NOT need their own Bastion/Jumpbox/VNet! This is shared infrastructure - the Landing Zone is set up once and used by all projects. What This Repo Provides (Set Up Once) Component Purpose Shared? VNet + Subnets Private network for all resources Yes - all projects use this Azure Bastion Secure access gateway Yes - one Bastion for all Jumpbox VM Admin access point Yes - shared by admins Azure Proxy (Chisel Server) SOCKS5 tunnel for CI/CD private-endpoint access Yes - shared by all stacks Private DNS Zones Name resolution for private endpoints Managed by Platform Services &#128274; DNS & ExpressRoute Note: Private DNS zones are managed centrally by Platform Services, not by this Landing Zone. ExpressRoute connectivity exists for on-premises access, but AI Hub clients will connect through App Gateway + APIM endpoints rather than directly via ExpressRoute. How Access Actually Works (Public vs Private) 🔑 Key Concept: \"No public endpoints\" doesn't mean \"no access\". It means access flows through controlled private channels , not the open internet. Who Access Path Public IPs? How It Works Platform Team (Admin) Internet → Azure Portal → Bastion → VMs Bastion only Bastion is Azure-managed PaaS with public IP. VMs have private IPs only. This is the ONE public-to-private bridge. Ministry Apps/Users Gov Network → ExpressRoute → App Gateway → APIM → Services None ExpressRoute is a private dedicated circuit from BC Gov data centers to Azure backbone. Traffic never touches public internet. GitHub Actions (CI/CD) GitHub-hosted runner + Chisel SOCKS tunnel → Private Endpoints None GitHub-hosted runners ( ubuntu-24.04 ) route Terraform traffic through a Chisel SOCKS5 proxy (App Service inside the VNet). The runner itself is on the public internet but all data-plane calls are tunnelled privately. What is ExpressRoute? ExpressRoute is NOT a public endpoint. It's a dedicated fiber connection from BC Gov's data centers directly into Azure's network backbone. Traffic stays on private circuits (not internet) Managed by BC Gov Platform Services Already exists - we just use it Like a private tunnel to Azure Why APIM is Internal APIM is internal only for security purposes. APIM is reachable via App gateway : ExpressRoute connects Gov Network → Azure VNet App Gateway acts as TCP layer 4 load balancer and proxy to APIM with strong WAF protection. Gov users can reach internal IPs via ExpressRoute if needed with proper Firewall rules in place. Summary: Only ONE Public Endpoint ┌─────────────────────────────────────────────────────────────────────────────┐ │ BC Gov Network │ │ ┌──────────────┐ │ │ │ Ministry │ │ │ │ Applications │──┐ │ │ └──────────────┘ │ │ │ │ │ │ ┌──────────────┐ │ ┌──────────────────────────────────────────────────┐│ │ │ Ministry │──┼────│ ExpressRoute (Private Circuit) ││ │ │ Users │ │ │ NOT public internet! ││ │ └──────────────┘ │ └──────────────────────────────────────────────────┘│ └────────────────────┼────────────────────────────────────────────────────────┘ │ Firewall Rules (Allowed Traffic) ▼ ┌─────────────────────────────────────────────────────────────────────────────┐ │ Azure (Private VNet) │ │ │ │ ┌────────────────┐ ┌────────────────┐ ┌────────────────────────────┐ │ │ │ App Gateway │───▶│ APIM │───▶│ Private Endpoints │ │ │ │ (Public IP) │ │ (Internal IP) │ │ (Storage, OpenAI, etc.) │ │ │ └────────────────┘ └────────────────┘ └────────────────────────────┘ │ │ ▲ │ │ │ │ │ │ All private IPs - reachable via ExpressRoute │ │ │ │ ════════════════════════════════════════════════════════════════════════ │ │ │ │ ┌────────────────┐ ┌────────────────┐ │ │ │ BASTION │─▶ │ Jumpbox VM │ ◀── Only Bastion has public IP │ │ │ (PUBLIC IP) │ │ (Private IP) │ (for admin access) │ │ └────────────────┘ └────────────────┘ │ │ ▲ │ └─────────┼───────────────────────────────────────────────────────────────────┘ │ │ Admin accesses via Azure Portal (browser) │ ┌─────────┴────────┐ │ INTERNET │ │ (Platform Team) │ └──────────────────┘","excerpt":"✅ Good News: Other repos do NOT need their own Bastion/Jumpbox/VNet! This is shared infrastructure - the Landing Zone is set up once and used by all projects. What This Repo Provides (Set Up Once) Component Purpose…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"why-not-just-open-public-endpoints-temporarily","sectionTitle":"Why Not Just Open Public Endpoints Temporarily?","text":"Policy prohibits this. Even temporary public access: Creates audit findings Requires security exemption paperwork Introduces attack window Must be reverted manually (often forgotten) The Landing Zone approach is always private - no exemptions needed.","excerpt":"Policy prohibits this. Even temporary public access: Creates audit findings Requires security exemption paperwork Introduces attack window Must be reverted manually (often forgotten) The Landing Zone approach is always…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences","sectionTitle":"Consequences","text":"Positive Fully policy compliant - No public endpoints ever Shared infrastructure - One-time setup, many projects benefit Consistent security - All projects inherit the same secure baseline Cost efficient - Single Bastion (~$140/mo) serves all projects Negative Initial complexity - Landing Zone must be built first Proxy dependency - Chisel App Service must be healthy before Terraform workflows run VNet planning - Must allocate IP ranges carefully","excerpt":"Positive Fully policy compliant - No public endpoints ever Shared infrastructure - One-time setup, many projects benefit Consistent security - All projects inherit the same secure baseline Cost efficient - Single Bastion…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references","sectionTitle":"References","text":"Azure Landing Zone Concepts Chisel - Fast TCP/UDP tunnel over HTTP Network Architecture Diagram Deployment Pipeline Diagram ADR-002: Use OIDC instead of Service Principal Secrets Accepted Status: Accepted Date: 2025-01 Driver: Policy Required Category: Security","excerpt":"Azure Landing Zone Concepts Chisel - Fast TCP/UDP tunnel over HTTP Network Architecture Diagram Deployment Pipeline Diagram ADR-002: Use OIDC instead of Service Principal Secrets Accepted Status: Accepted Date: 2025-01…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-1","sectionTitle":"Context","text":"🏛️ Policy Driver: BC Gov security policy requires minimizing long-lived credentials and implementing credential rotation. The platform team provides rotating keys, but OIDC eliminates the need for a cron job to fetch and update credentials. GitHub Actions workflows need to authenticate with Azure to deploy infrastructure via Terraform. We evaluated three options for credential management: Option A: Static Secrets Create Azure AD App Registration Generate Client Secret Store in GitHub Secrets Rotate manually every 1-2 years Not policy compliant - Long-lived credentials prohibited Option B: Platform Rotating Keys Platform team rotates keys every 2 days Keys expire after 4 days Requires cron job to fetch/update Must sync to GitHub Secrets Policy compliant - But adds operational overhead Option C: OIDC Federation Create Managed Identity Configure GitHub OIDC trust Token fetched in pipeline No cron job needed Policy compliant - Zero operational overhead","excerpt":"🏛️ Policy Driver: BC Gov security policy requires minimizing long-lived credentials and implementing credential rotation. The platform team provides rotating keys, but OIDC eliminates the need for a cron job to fetch…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision","sectionTitle":"Decision","text":"We chose Option C: OIDC Federated Credentials. While the platform team's rotating key solution (Option B) is policy compliant, it requires maintaining a cron job to continuously fetch and update credentials. OIDC eliminates this operational burden - the bearer token is obtained directly within the GitHub Actions workflow at runtime, with no external synchronization required.","excerpt":"We chose Option C: OIDC Federated Credentials. While the platform team's rotating key solution (Option B) is policy compliant, it requires maintaining a cron job to continuously fetch and update credentials. OIDC…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"rationale","sectionTitle":"Rationale","text":"Criteria Static Secrets Platform Rotating OIDC Policy Compliant No Yes Yes Secret Management Manual rotation Cron job required No secrets needed Security Risk Long-lived credential leak 4-day window if compromised ~10 min window Operational Overhead Annual rotation Cron job maintenance Set and forget Token Lifetime 1-2 years 4 days max ~10 minutes Failure Mode Expired secret breaks deploy Cron failure breaks deploy Self-contained in pipeline Scope Control Per application Per application Per repo/branch/env","excerpt":"Criteria Static Secrets Platform Rotating OIDC Policy Compliant No Yes Yes Secret Management Manual rotation Cron job required No secrets needed Security Risk Long-lived credential leak 4-day window if compromised ~10…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-1","sectionTitle":"Consequences","text":"Positive Zero secrets to rotate - Eliminates credential management overhead Reduced blast radius - Tokens valid for minutes, not years Fine-grained access - Can restrict to specific branches/environments Better audit trail - Every token exchange is logged with JWT claims No secret sprawl - Secrets don't end up in logs, config files, or developer machines Negative More complex initial setup - Federated credential configuration is more involved Newer technology - Less documentation and community examples available GitHub dependency - Tightly coupled to GitHub's OIDC provider Neutral Requires understanding of JWT claims and subject matching Debugging auth failures requires knowledge of OIDC flow","excerpt":"Positive Zero secrets to rotate - Eliminates credential management overhead Reduced blast radius - Tokens valid for minutes, not years Fine-grained access - Can restrict to specific branches/environments Better audit…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-1","sectionTitle":"References","text":"GitHub OIDC Documentation Azure Workload Identity Federation Token Exchange Flow Diagram ADR-003: Optional Use of Azure Bastion for VM Access Accepted Status: Accepted Date: 2025-01 Driver: Policy Required Category: Networking","excerpt":"GitHub OIDC Documentation Azure Workload Identity Federation Token Exchange Flow Diagram ADR-003: Optional Use of Azure Bastion for VM Access Accepted Status: Accepted Date: 2025-01 Driver: Policy Required Category:…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-2","sectionTitle":"Context","text":"🏛️ Policy Driver: BC Gov policy prohibits public IP addresses on virtual machines. VMs must only be accessible through private networks. Azure Bastion provides compliant access without exposing VMs to the internet. 🌉 Bastion = The Public-to-Private Bridge Azure Bastion is the one approved exception to the \"no public endpoints\" rule. It's an Azure-managed PaaS service with a public IP that provides secure browser-based access to private VMs. The key point: Bastion has the public IP, not the VMs themselves. Public Endpoints in the Architecture Service Has Public IP? Why Azure Bastion Yes (exception) Required for browser-based VM access. Azure-managed, AAD-authenticated. This is the public-to-private bridge for admin access. App Gateway Yes Receives traffic from public internet with WAF (Web Application Firewall). APIM No (internal) Deployed in internal mode, sits behind App Gateway. No public exposure. VMs (Jumpbox) No Private IPs only. Access via Bastion. Storage, Key Vault, etc. No Private endpoints only. Public access disabled. Operators need secure access to jumpbox VMs for debugging and administration. The VMs cannot have public IPs per policy. We evaluated: Option A: VPN Gateway Point-to-site VPN for developer access Option B: Public IP + NSG Expose SSH/RDP with IP allowlisting Option C: Azure Bastion Browser-based RDP/SSH via Azure Portal","excerpt":"🏛️ Policy Driver: BC Gov policy prohibits public IP addresses on virtual machines. VMs must only be accessible through private networks. Azure Bastion provides compliant access without exposing VMs to the internet. 🌉…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-1","sectionTitle":"Decision","text":"We chose Option C: Azure Bastion.","excerpt":"We chose Option C: Azure Bastion."},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"rationale-1","sectionTitle":"Rationale","text":"Criteria VPN Gateway Public IP Bastion Setup Complexity High (certs, clients) Low Medium Client Requirements VPN client software SSH/RDP client Browser only Attack Surface VPN endpoint High (exposed ports) Minimal Cost ~$140/month ~$5/month ~$140/month (when on) On-demand No (always on) Yes Yes (can destroy)","excerpt":"Criteria VPN Gateway Public IP Bastion Setup Complexity High (certs, clients) Low Medium Client Requirements VPN client software SSH/RDP client Browser only Attack Surface VPN endpoint High (exposed ports) Minimal Cost…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-2","sectionTitle":"Consequences","text":"Positive No public IPs on VMs - VMs only have private IPs No client software - Works from any browser Azure AD integration - Uses existing identity Session recording - Can enable for audit Cost control - Can deploy/destroy on demand via workflow Negative Azure Portal dependency - Must use Azure UI or CLI File transfer limitations - No native SCP/SFTP Latency - Browser-based adds some lag","excerpt":"Positive No public IPs on VMs - VMs only have private IPs No client software - Works from any browser Azure AD integration - Uses existing identity Session recording - Can enable for audit Cost control - Can…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-2","sectionTitle":"References","text":"Azure Bastion Documentation Connect to Linux VM via Bastion Network Environments Diagram ADR-004: Private Endpoints for All Azure Services Accepted Status: Accepted Date: 2025-01 Driver: Policy Required Category: Networking","excerpt":"Azure Bastion Documentation Connect to Linux VM via Bastion Network Environments Diagram ADR-004: Private Endpoints for All Azure Services Accepted Status: Accepted Date: 2025-01 Driver: Policy Required Category:…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-3","sectionTitle":"Context","text":"🏛️ Policy Driver: BC Gov security policy mandates that all Azure PaaS services must be accessed via Private Endpoints only. Public endpoints must be disabled. This ensures all traffic stays within the Azure backbone and private networks. Azure PaaS services (Storage Accounts, Key Vaults, Databases, etc.) by default have public endpoints accessible from the internet. BC Gov policy requires these to be locked down.","excerpt":"🏛️ Policy Driver: BC Gov security policy mandates that all Azure PaaS services must be accessed via Private Endpoints only. Public endpoints must be disabled. This ensures all traffic stays within the Azure backbone and…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"policy-requirements","sectionTitle":"Policy Requirements","text":"What Policy Prohibits Public endpoints on any Azure service Key Vaults with public network access Databases with public connectivity Any service reachable without VNet integration What Policy Requires Private Endpoints for all PaaS services Private DNS zones for name resolution (managed by Platform Services) VNet integration for all access Network Security Groups controlling traffic \"Deny public access\" enabled on all services","excerpt":"What Policy Prohibits Public endpoints on any Azure service Key Vaults with public network access Databases with public connectivity Any service reachable without VNet integration What Policy Requires Private Endpoints…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"implementation","sectionTitle":"Implementation","text":"&#128274; DNS Management: All private DNS zones are managed centrally by Platform Services. The AI Hub team does not manage DNS - we only create private endpoints that link to the existing DNS zones. Service Private Endpoint DNS Zone (Platform Services) Key Vault (if used) privateEndpoint-vault privatelink.vaultcore.azure.net Container Registry (if used) privateEndpoint-acr privatelink.azurecr.io","excerpt":"&#128274; DNS Management: All private DNS zones are managed centrally by Platform Services. The AI Hub team does not manage DNS - we only create private endpoints that link to the existing DNS zones. Service Private…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"client-connectivity-model","sectionTitle":"Client Connectivity Model","text":"ExpressRoute + App Gateway + APIM BC Gov has ExpressRoute connectivity to Azure, but AI Hub clients will not access services directly via ExpressRoute. Instead: App Gateway: Provides ingress, WAF protection, and SSL termination APIM: API management layer for authentication, rate limiting, and routing Private Endpoints: Backend services (AI models, storage) remain fully private Client flow: Client → App Gateway → APIM → Private Endpoint → Azure Service","excerpt":"ExpressRoute + App Gateway + APIM BC Gov has ExpressRoute connectivity to Azure, but AI Hub clients will not access services directly via ExpressRoute. Instead: App Gateway: Provides ingress, WAF protection, and SSL…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-3","sectionTitle":"Consequences","text":"Challenges GitHub Actions cannot reach private endpoints directly - Requires the Chisel SOCKS tunnel or VNet-internal access (see ADR-001 ) Local development complexity - Developers cannot access resources without VPN/Bastion DNS resolution - Must configure private DNS zones correctly Debugging difficulty - Cannot easily test from outside the network Workarounds Terraform State: Use the Chisel SOCKS tunnel (GitHub-hosted runner + Azure Proxy) to access the private storage endpoint. The use_azuread_auth = true setting enables Azure AD authentication for state access. Development: Use Bastion + Jumpbox for all Azure resource access (see ADR-003 ) CI/CD: Use the Chisel SOCKS tunnel for full private-endpoint access during Terraform runs (see ADR-001 )","excerpt":"Challenges GitHub Actions cannot reach private endpoints directly - Requires the Chisel SOCKS tunnel or VNet-internal access (see ADR-001 ) Local development complexity - Developers cannot access resources without…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-3","sectionTitle":"References","text":"Azure Private Endpoint Documentation Network Architecture Diagram ADR-005: Zero-Dependency Documentation System Accepted Status: Accepted Date: 2025-12 Driver: Choice Category: Documentation","excerpt":"Azure Private Endpoint Documentation Network Architecture Diagram ADR-005: Zero-Dependency Documentation System Accepted Status: Accepted Date: 2025-12 Driver: Choice Category: Documentation"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-4","sectionTitle":"Context","text":"We needed a documentation site for the project. Options considered: Static Site Generators Jekyll (Ruby) Hugo (Go) Docusaurus (Node.js) MkDocs (Python) Custom Bash Build Header/footer partials Variable substitution ~60 lines of shell script Zero external dependencies","excerpt":"We needed a documentation site for the project. Options considered: Static Site Generators Jekyll (Ruby) Hugo (Go) Docusaurus (Node.js) MkDocs (Python) Custom Bash Build Header/footer partials Variable substitution ~60…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-2","sectionTitle":"Decision","text":"We built a custom Bash-based static site generator.","excerpt":"We built a custom Bash-based static site generator."},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"rationale-2","sectionTitle":"Rationale","text":"Portability: Runs anywhere with Bash (Linux, Mac, WSL, CI) No dependency management: No npm, gem, pip, go install required Simplicity: Anyone can understand the 60-line build script Speed: Builds in milliseconds GitHub Pages native: No special plugins or build configurations AI-friendly: HTML generation is trivial for AI assistants","excerpt":"Portability: Runs anywhere with Bash (Linux, Mac, WSL, CI) No dependency management: No npm, gem, pip, go install required Simplicity: Anyone can understand the 60-line build script Speed: Builds in milliseconds GitHub…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-4","sectionTitle":"Consequences","text":"Positive Zero build dependencies to maintain or update Works in any environment without setup Easy to understand and modify No security vulnerabilities from npm packages Negative No built-in Markdown support (write HTML directly) No automatic table of contents generation No built-in search (added custom client-side solution) Mitigations Created template page with all components for easy copy-paste AI assistants generate HTML as easily as Markdown Added custom SVG viewer for diagrams ADR-006: Terraform as Infrastructure as Code (IaC) Accepted Status: Accepted Date: 2025-12 Driver: Choice Category: Infrastructure","excerpt":"Positive Zero build dependencies to maintain or update Works in any environment without setup Easy to understand and modify No security vulnerabilities from npm packages Negative No built-in Markdown support (write HTML…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-5","sectionTitle":"Context","text":"This repo needs a repeatable, auditable way to provision and update Azure infrastructure (networking, private endpoints, RBAC, diagnostics, and PaaS services) under BC Government policy constraints. Given the Landing Zone design (private endpoints, limited portal use, and CI/CD execution from within the VNet), we need Infrastructure as Code that supports: Idempotent, reviewable changes (pull requests as the change record) Policy-driven patterns (private endpoints, NSGs, diagnostics settings) Composable modules (prefer Azure Verified Modules where possible) Automation via GitHub Actions using OIDC and Chisel SOCKS tunnel","excerpt":"This repo needs a repeatable, auditable way to provision and update Azure infrastructure (networking, private endpoints, RBAC, diagnostics, and PaaS services) under BC Government policy constraints. Given the Landing…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"options-considered","sectionTitle":"Options Considered","text":"Terraform (selected) Large ecosystem and Azure provider support Strong module approach (including AVM for Terraform) Works well in CI/CD and supports multi-environment workflows Alternatives Bicep / ARM templates Pulumi Portal-based configuration (click-ops)","excerpt":"Terraform (selected) Large ecosystem and Azure provider support Strong module approach (including AVM for Terraform) Works well in CI/CD and supports multi-environment workflows Alternatives Bicep / ARM templates Pulumi…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-3","sectionTitle":"Decision","text":"We use Terraform as the primary Infrastructure as Code (IaC) tool for this repo.","excerpt":"We use Terraform as the primary Infrastructure as Code (IaC) tool for this repo."},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"rationale-3","sectionTitle":"Rationale","text":"Fits Landing Zone operations: Terraform runs cleanly on GitHub-hosted runners via the Chisel SOCKS tunnel, providing data-plane access to private endpoints when required. Standardization via modules: We can prefer Azure Verified Modules (AVM) for consistent, policy-aligned deployments. Auditable change control: Plans and applies can be gated by pull request review and CI checks. Multi-environment support: Variables and modules make it straightforward to deploy dev/test/prod consistently. Sustainability: Terraform's widespread adoption ensures long-term community and vendor support. Team members working across AWS, Azure, and OpenShift can use one IaC tool consistently across the stack","excerpt":"Fits Landing Zone operations: Terraform runs cleanly on GitHub-hosted runners via the Chisel SOCKS tunnel, providing data-plane access to private endpoints when required. Standardization via modules: We can prefer Azure…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-5","sectionTitle":"Consequences","text":"Positive Repeatable deployments - Same inputs produce the same infrastructure Versioned infrastructure - Git history becomes the change log Policy-aligned defaults - Modules can encode private endpoint and logging patterns Negative Learning curve - Contributors must understand Terraform workflows State management - Requires careful backend configuration and access controls Upgrades - Provider/module version bumps require ongoing maintenance Mitigations Use pinned module versions and keep provider versions explicit Use CI to run terraform fmt , terraform validate , and plans Prefer AVM modules over custom resources where feasible","excerpt":"Positive Repeatable deployments - Same inputs produce the same infrastructure Versioned infrastructure - Git history becomes the change log Policy-aligned defaults - Modules can encode private endpoint and logging…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-4","sectionTitle":"References","text":"Terraform Reference - Complete module, variable, and output docs Terraform Documentation Azure Verified Modules (Terraform index) ADR-007: Client Connectivity via App Gateway + APIM Accepted Status: Accepted Date: 2025-12 Driver: Policy Required Category: Networking","excerpt":"Terraform Reference - Complete module, variable, and output docs Terraform Documentation Azure Verified Modules (Terraform index) ADR-007: Client Connectivity via App Gateway + APIM Accepted Status: Accepted Date:…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-6","sectionTitle":"Context","text":"🏛️ Platform Context: BC Gov Platform Services provides ExpressRoute connectivity to Azure for private, high-bandwidth access. ExpressRoute is available , not denied. However, for this multi-tenant AI Hub platform, we recommend all clients connect through App Gateway + APIM to ensure consistent security controls across all tenants. BC Government Platform Services has established ExpressRoute connectivity between on-premises networks and Azure. For this AI Hub Landing Zone, the question arose: should ministry applications connect directly to AI services via ExpressRoute, or through a managed ingress layer?","excerpt":"🏛️ Platform Context: BC Gov Platform Services provides ExpressRoute connectivity to Azure for private, high-bandwidth access. ExpressRoute is available , not denied. However, for this multi-tenant AI Hub platform, we…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"options-considered-1","sectionTitle":"Options Considered","text":"Option A: Direct ExpressRoute Access Clients connect directly to private endpoints via ExpressRoute. Lowest latency (no middlemen) Simpler architecture for single-tenant ExpressRoute is provided by Platform Services Case-by-Case: Available upon request with justification. Requires separate security review as it bypasses WAF, rate limiting, and centralized audit logging. Option B: App Gateway + APIM (Recommended) All traffic flows through App Gateway and APIM before reaching backends. WAF protection at ingress Centralized authentication Rate limiting and quotas per tenant Complete audit trail Consistent multi-tenant isolation Recommended: Standard path for all AI Hub clients","excerpt":"Option A: Direct ExpressRoute Access Clients connect directly to private endpoints via ExpressRoute. Lowest latency (no middlemen) Simpler architecture for single-tenant ExpressRoute is provided by Platform Services…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-4","sectionTitle":"Decision","text":"For a clear multi-tenant platform, we recommend all clients connect through App Gateway → APIM → Private Endpoints. ExpressRoute connectivity is provided by Platform Services and is available. However, to support consistent security controls, audit logging, and fair resource allocation across multiple ministries, we recommend the App Gateway + APIM path as the standard connectivity model. 💡 Direct ExpressRoute Access: If a client has a specific requirement for direct ExpressRoute access to backend services (e.g., extremely latency-sensitive workloads), this can be analyzed on a case-by-case basis. Such requests require justification and a separate security review.","excerpt":"For a clear multi-tenant platform, we recommend all clients connect through App Gateway → APIM → Private Endpoints. ExpressRoute connectivity is provided by Platform Services and is available. However, to support…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"traffic-flow","sectionTitle":"Traffic Flow","text":"┌─────────────────────────────────────────────────────────────────────────────┐ │ CLIENT CONNECTIVITY MODEL │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ On-Premises │ Azure Landing Zone │ │ (Ministry Apps) │ │ │ │ │ │ ┌──────────────┐ │ ┌─────────────────────────────────┐ │ │ │ Ministry App │ │ │ App Gateway │ │ │ │ (Health) │──────────────────▶│ • SSL Termination │ │ │ └──────────────┘ Express │ │ • WAF Protection │ │ │ Route │ │ • DDoS Mitigation │ │ │ ┌──────────────┐ │ └──────────────┬──────────────────┘ │ │ │ Ministry App │ │ │ │ │ │ (SDPR) │──────────────────▶ ▼ │ │ └──────────────┘ │ ┌─────────────────────────────────┐ │ │ │ │ APIM │ │ │ ┌──────────────┐ │ │ • Authentication (API Keys) │ │ │ │ Ministry App │ │ │ • Rate Limiting │ │ │ │ (Justice) │──────────────────▶│ • Request Validation │ │ │ └──────────────┘ │ │ • Ministry Routing │ │ │ │ │ • Audit Logging │ │ │ │ └──────────────┬──────────────────┘ │ │ │ │ │ │ │ ▼ │ │ │ ┌─────────────────────────────────┐ │ │ │ │ Private Endpoints │ │ │ │ │ • AI Foundry │ │ │ │ │ • Azure OpenAI │ │ │ │ │ • AI Search │ │ │ │ │ • Storage (RAG docs) │ │ │ │ └─────────────────────────────────┘ │ │ │ │ └─────────────────────────────────────────────────────────────────────────────┘","excerpt":"┌─────────────────────────────────────────────────────────────────────────────┐ │ CLIENT CONNECTIVITY MODEL │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ On-Premises │ Azure…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"security-controls-at-each-layer","sectionTitle":"Security Controls at Each Layer","text":"Layer Security Control Purpose App Gateway Web Application Firewall (WAF) Block OWASP top 10, SQL injection, XSS App Gateway SSL/TLS Termination Enforce HTTPS, manage certificates App Gateway DDoS Protection Mitigate volumetric attacks APIM Subscription Keys Identify and authenticate ministry APIM Rate Limiting Prevent abuse, ensure fair usage APIM Request Validation Validate payload structure APIM Audit Logging Track all requests with ministry context Private Endpoints Network Isolation Backend services unreachable from internet","excerpt":"Layer Security Control Purpose App Gateway Web Application Firewall (WAF) Block OWASP top 10, SQL injection, XSS App Gateway SSL/TLS Termination Enforce HTTPS, manage certificates App Gateway DDoS Protection Mitigate…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-6","sectionTitle":"Consequences","text":"Positive Defense in depth - Multiple security layers before reaching backends Centralized policy - All clients subject to same rules Audit compliance - Every request logged with full context Flexibility - Can update policies without changing backends Cost attribution - Can track usage per ministry via APIM metrics Negative Added latency - Two extra hops (App Gateway + APIM) Cost - App Gateway and APIM have significant monthly costs Complexity - More components to configure and maintain Mitigations Latency is typically <10ms additional per hop Costs are shared across all ministries (per ADR-010 ) Infrastructure-as-code manages complexity","excerpt":"Positive Defense in depth - Multiple security layers before reaching backends Centralized policy - All clients subject to same rules Audit compliance - Every request logged with full context Flexibility - Can update…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-5","sectionTitle":"References","text":"AI Request Data Flow Diagram Full Stack Architecture Diagram Azure API Management Overview Azure Application Gateway Overview ADR-008: No Azure Portal or Foundry Studio UI Access Pending Platform/MS Status: Pending Platform/MS Date: 2025-12 Driver: Policy Required Category: Operations","excerpt":"AI Request Data Flow Diagram Full Stack Architecture Diagram Azure API Management Overview Azure Application Gateway Overview ADR-008: No Azure Portal or Foundry Studio UI Access Pending Platform/MS Status: Pending…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-7","sectionTitle":"Context","text":"🏛️ Policy Driver: BC Gov requires all Azure services to use private endpoints only, with no public network access. Azure Portal, AI Foundry Studio, and other browser-based management tools require public endpoints to function. This creates a fundamental incompatibility. Microsoft's standard approach to AI Landing Zones assumes users will manage resources through: Azure Portal (portal.azure.com) AI Foundry Studio (ai.azure.com) Azure Machine Learning Studio All of these require public endpoint access to the Azure services being managed.","excerpt":"🏛️ Policy Driver: BC Gov requires all Azure services to use private endpoints only, with no public network access. Azure Portal, AI Foundry Studio, and other browser-based management tools require public endpoints to…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"the-problem-ui-requires-public-endpoints","sectionTitle":"The Problem: UI Requires Public Endpoints","text":"User Browser (Public Internet) │ ▼ ┌─────────────────────────────────────────────────────────────────┐ │ ai.azure.com / portal.azure.com (Public Endpoint) │ │ │ │ \"To manage your AI Foundry project, we need to reach │ │ your Azure resources over the public internet\" │ │ │ │ │ │ │ ▼ │ │ ┌─────────────────────────────────────────────────┐ │ │ │ Your AI Foundry / Storage / Search │ │ │ │ │ │ │ │ ❌ PUBLIC ENDPOINT REQUIRED │ │ │ │ BC Gov Policy: DENIED │ │ │ └─────────────────────────────────────────────────┘ │ └─────────────────────────────────────────────────────────────────┘","excerpt":"User Browser (Public Internet) │ ▼ ┌─────────────────────────────────────────────────────────────────┐ │ ai.azure.com / portal.azure.com (Public Endpoint) │ │ │ │ \"To manage your AI Foundry project, we need to reach │ │…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-5","sectionTitle":"Decision","text":"No browser-based UI access is supported for tenant management. All resource provisioning and management must occur through: Terraform/AVM modules - Infrastructure as Code Azure CLI - Via Chisel tunnel (CI/CD) or Jumpbox (admin only) REST APIs - Via APIM with subscription keys","excerpt":"No browser-based UI access is supported for tenant management. All resource provisioning and management must occur through: Terraform/AVM modules - Infrastructure as Code Azure CLI - Via Chisel tunnel (CI/CD) or Jumpbox…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"what-this-means-for-tenants","sectionTitle":"What This Means for Tenants","text":"👁️ Important Clarification: Tenants CAN navigate to Azure Portal and AI Foundry Studio. They can see their resources, browse the UI, and view configurations. However, operations that require the UI to communicate with Azure services will fail because those services have no public endpoints. The UI is read-only at best, non-functional at worst. Can Do (View Only) Browse to portal.azure.com See resource groups and resources View configurations (read-only) Navigate AI Foundry Studio UI See project structure Cannot Do (UI Blocked) Create/modify resources via Portal Upload documents in Foundry Studio Test models in Foundry playground Configure settings via web forms Any operation requiring service connection Supported Methods Request resources via Terraform PR Upload documents via API (APIM) Query AI models via API (APIM) Automate via CLI in pipelines Use SDK from within VNet Why Does This Happen? When you click \"Upload Document\" in Foundry Studio, the browser (on public internet) tries to connect directly to your Storage Account. But your Storage Account has no public endpoint - it only accepts connections from within the VNet via Private Endpoint. Browser (Public) → Storage Account (Private Only) = ❌ Connection Refused Pipeline (VNet) → Storage Account (Private EP) = ✅ Works The UI shows the resource exists, but can't actually interact with it.","excerpt":"👁️ Important Clarification: Tenants CAN navigate to Azure Portal and AI Foundry Studio. They can see their resources, browse the UI, and view configurations. However, operations that require the UI to communicate with…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"why-not-provide-bastion-access-to-everyone","sectionTitle":"Why Not Provide Bastion Access to Everyone?","text":"This was considered and rejected: Approach Problem Bastion + VM per tenant Not scalable (20 ministries = 20 VMs = $$$), security nightmare Shared Jumpbox for all Multi-tenant isolation violated, credential management chaos VPN per tenant Massive operational overhead, not self-service Result: Bastion/Jumpbox is for platform team administration only. Tenants interact via API.","excerpt":"This was considered and rejected: Approach Problem Bastion + VM per tenant Not scalable (20 ministries = 20 VMs = $$$), security nightmare Shared Jumpbox for all Multi-tenant isolation violated, credential management…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"avm-module-requirement","sectionTitle":"AVM Module Requirement","text":"Because all management must be IaC-based, only services with Azure Verified Modules (AVM) are supported . Supported AVM Modules AI Services: cognitiveservices-account machinelearningservices-workspace search-searchservice Data: storage-storageaccount documentdb-databaseaccount keyvault-vault Compute: containerservice-managedcluster containerregistry-registry apimanagement-service Full catalog: azure.github.io/Azure-Verified-Modules","excerpt":"Because all management must be IaC-based, only services with Azure Verified Modules (AVM) are supported . Supported AVM Modules AI Services: cognitiveservices-account machinelearningservices-workspace…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"path-forward-secure-ui-access","sectionTitle":"Path Forward: Secure UI Access","text":"⚠️ Open Question: A secure and scalable way to access browser-based tooling — including Document Intelligence Studio, AI Foundry Portal, and other Azure service UIs — needs to be investigated in collaboration with the BC Gov Azure Platform Services team. Current constraints leave tenants without an interactive management interface. A solution is needed at the platform level before this ADR can be fully closed.","excerpt":"⚠️ Open Question: A secure and scalable way to access browser-based tooling — including Document Intelligence Studio, AI Foundry Portal, and other Azure service UIs — needs to be investigated in collaboration with the BC…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-7","sectionTitle":"Consequences","text":"Positive Policy compliant - No public endpoints ever exposed Reproducible - All infrastructure is code, auditable, version controlled Scalable - Onboard 100 tenants with same process as 1 Secure - No browser-based attack surface Negative Steeper learning curve - Tenants must use IaC, not click-ops No visual management - Can't \"see\" resources in Portal Debugging harder - Must use CLI/API, not browser dev tools Microsoft disconnect - Their guidance assumes UI access","excerpt":"Positive Policy compliant - No public endpoints ever exposed Reproducible - All infrastructure is code, auditable, version controlled Scalable - Onboard 100 tenants with same process as 1 Secure - No browser-based attack…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-6","sectionTitle":"References","text":"Microsoft vs BC Gov Comparison Diagram What's Included / Not Included Infographic Azure Verified Modules Catalog ADR-009: Why AI Landing Zone vs Custom Solution Accepted Status: Accepted Date: 2025-12 Driver: Choice Category: Architecture","excerpt":"Microsoft vs BC Gov Comparison Diagram What's Included / Not Included Infographic Azure Verified Modules Catalog ADR-009: Why AI Landing Zone vs Custom Solution Accepted Status: Accepted Date: 2025-12 Driver: Choice…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-8","sectionTitle":"Context","text":"A valid question arises: If we're customizing everything for BC Gov requirements anyway, why use Microsoft's AI Landing Zone at all? Why not just build our own custom solution from scratch? This ADR explains what value the AI Landing Zone and Azure Verified Modules (AVM) actually provide, even when we can't use Microsoft's default assumptions.","excerpt":"A valid question arises: If we're customizing everything for BC Gov requirements anyway, why use Microsoft's AI Landing Zone at all? Why not just build our own custom solution from scratch? This ADR explains what value…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"what-ai-landing-zone-actually-provides","sectionTitle":"What AI Landing Zone Actually Provides","text":"💡 Key Insight: We're not using Microsoft's AI Landing Zone as a turnkey solution. We're using it as a reference architecture and leveraging the Azure Verified Modules (AVM) it's built on. The value is in the tested, maintained, modular components - not the out-of-box configuration.","excerpt":"💡 Key Insight: We're not using Microsoft's AI Landing Zone as a turnkey solution. We're using it as a reference architecture and leveraging the Azure Verified Modules (AVM) it's built on. The value is in the tested,…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"the-real-value-avm-modules","sectionTitle":"The Real Value: AVM Modules","text":"Building From Scratch If we wrote our own Terraform modules: Write 1000+ lines of Terraform per service Handle every Azure API change ourselves Debug edge cases Microsoft already solved Maintain security patches ourselves No community validation or review Reinvent private endpoint patterns Figure out RBAC configurations Test against every Azure region Using AVM Modules wherever possible With Azure Verified Modules: ~50 lines of Terraform to deploy a service Microsoft maintains API compatibility Edge cases handled by module maintainers Security updates pushed automatically Community tested, Microsoft validated Private endpoint patterns built-in RBAC best practices included Tested across all Azure regions","excerpt":"Building From Scratch If we wrote our own Terraform modules: Write 1000+ lines of Terraform per service Handle every Azure API change ourselves Debug edge cases Microsoft already solved Maintain security patches…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"what-we-get-from-ai-landing-zone-reference","sectionTitle":"What We Get From AI Landing Zone Reference","text":"Component What Microsoft Provides What We Customize Network Topology Hub-spoke pattern, subnet sizing guidance, NSG rule templates IP ranges, Canada regions, Platform Services DNS integration AI Foundry Setup AVM module for workspace, project structure, compute patterns Disable public access, multi-tenant project isolation Private Endpoints Patterns for connecting services privately, DNS zone integration Link to Platform Services DNS, IP allocation per tenant APIM Integration AVM module, backend pool patterns, policy templates Subscription per tenant, OpenAPI routing, rate limits Security Baseline RBAC templates, managed identity patterns, Key Vault integration BC Gov RBAC requirements, ministry-level isolation","excerpt":"Component What Microsoft Provides What We Customize Network Topology Hub-spoke pattern, subnet sizing guidance, NSG rule templates IP ranges, Canada regions, Platform Services DNS integration AI Foundry Setup AVM module…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"avm-module-maturity-honest-assessment","sectionTitle":"AVM Module Maturity - Honest Assessment","text":"⚠️ Important: Not all AVM modules are equally mature. AI Foundry modules are newer and still evolving. We must be realistic about what's production-ready vs what's in development. Module Status Maturity Notes avm-res-storage-storageaccount Released Production Ready Mature, well-tested avm-res-keyvault-vault Released Production Ready Mature, well-tested avm-res-network-virtualnetwork Released Production Ready Mature, well-tested avm-res-network-applicationgateway Released Production Ready Mature, well-tested avm-res-network-bastionhost Released Production Ready Mature, well-tested avm-res-documentdb-databaseaccount Released Production Ready Cosmos DB - mature avm-res-apimanagement-service Pending Early Release v0.0.5 - may need custom work avm-res-cognitiveservices-account Pending Maturing OpenAI, Doc Intel - verify features avm-res-search-searchservice Pending Maturing AI Search - verify private EP support avm-res-machinelearningservices-workspace Pending Maturing Core resource for Foundry Hub/Project avm-ptn-aiml-ai-foundry In Development Not Production Ready Pattern module - active development avm-ptn-ai-foundry-enterprise Archived Abandoned Was archived July 2025 - do not use avm-res-containerservice-managedcluster Pending Pre-release AKS - v0.4.0-pre2 What This Means Safe to Use AVM Virtual Networks, Subnets, NSGs Storage Accounts Key Vault Bastion Host App Gateway Cosmos DB Evaluate / May Need Custom AI Foundry (use resource module, not pattern) APIM (early version, test thoroughly) Cognitive Services (verify private EP) AI Search (verify features needed) AKS (pre-release) 💡 Our Strategy: Use mature AVM modules for infrastructure (networking, storage, security). For AI Foundry, start with the core machinelearningservices-workspace resource module rather than the pattern modules. Be prepared to write custom Terraform for AI-specific configurations that AVM doesn't yet support.","excerpt":"⚠️ Important: Not all AVM modules are equally mature. AI Foundry modules are newer and still evolving. We must be realistic about what's production-ready vs what's in development. Module Status Maturity Notes…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"concrete-example-storage-account","sectionTitle":"Concrete Example: Storage Account","text":"Without AVM (Custom from scratch) # ~200 lines of Terraform to handle: resource \"azurerm_storage_account\" \"main\" { ... } resource \"azurerm_storage_account_network_rules\" \"main\" { ... } resource \"azurerm_private_endpoint\" \"blob\" { ... } resource \"azurerm_private_endpoint\" \"file\" { ... } resource \"azurerm_private_endpoint\" \"queue\" { ... } resource \"azurerm_private_dns_zone_virtual_network_link\" \"blob\" { ... } resource \"azurerm_role_assignment\" \"contributor\" { ... } resource \"azurerm_role_assignment\" \"reader\" { ... } resource \"azurerm_monitor_diagnostic_setting\" \"main\" { ... } # Plus encryption, lifecycle policies, soft delete, versioning... # Plus handling for every Azure API version change... With AVM Module module \"storage\" { source = \"Azure/avm-res-storage-storageaccount/azurerm\" version = \"0.6.7\" name = \"ministryhealthstorage\" resource_group_name = azurerm_resource_group.ministry.name location = \"canadacentral\" # Private endpoints - one line enables the pattern private_endpoints = { blob = { subnet_id = module.network.subnet_ids[\"private-endpoints\"] } } # All the security, RBAC, monitoring handled by module tags = var.common_tags } Result: Same outcome, 10x less code, maintained by Microsoft.","excerpt":"Without AVM (Custom from scratch) # ~200 lines of Terraform to handle: resource \"azurerm_storage_account\" \"main\" { ... } resource \"azurerm_storage_account_network_rules\" \"main\" { ... } resource \"azurerm_private_endpoint\"…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"why-not-100-custom","sectionTitle":"Why Not 100% Custom?","text":"Custom = Maintenance Burden Azure releases ~100 API changes/month Each change could break custom modules Security vulnerabilities need patching New features require manual implementation Team turnover = knowledge loss Who maintains this in 3 years? AVM = Shared Maintenance Microsoft + community maintain modules API changes handled upstream Security patches published as versions New features added automatically Documentation maintained centrally Sustainable long-term","excerpt":"Custom = Maintenance Burden Azure releases ~100 API changes/month Each change could break custom modules Security vulnerabilities need patching New features require manual implementation Team turnover = knowledge loss…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"what-were-actually-doing","sectionTitle":"What We're Actually Doing","text":"Our Approach: AVM + BC Gov Customization Layer ┌─────────────────────────────────────────────────────────────────────┐ │ BC Gov AI Hub Architecture │ ├─────────────────────────────────────────────────────────────────────┤ │ │ │ ┌─────────────────────────────────────────────────────────────┐ │ │ │ BC Gov Customization Layer (Our Code) │ │ │ │ • Multi-tenant resource group structure │ │ │ │ • APIM subscription per ministry │ │ │ │ • IP allocation policies │ │ │ │ • Platform Services DNS integration │ │ │ │ • Canada data residency enforcement │ │ │ └─────────────────────────────────────────────────────────────┘ │ │ │ │ │ ▼ │ │ ┌─────────────────────────────────────────────────────────────┐ │ │ │ Azure Verified Modules (Microsoft Maintained) │ │ │ │ • avm-res-cognitiveservices-account │ │ │ │ • avm-res-machinelearningservices-workspace │ │ │ │ • avm-res-storage-storageaccount │ │ │ │ • avm-res-network-virtualnetwork │ │ │ │ • avm-res-apimanagement-service │ │ │ │ • ... 100+ more modules │ │ │ └─────────────────────────────────────────────────────────────┘ │ │ │ │ │ ▼ │ │ ┌─────────────────────────────────────────────────────────────┐ │ │ │ Azure Resource Manager APIs │ │ │ └─────────────────────────────────────────────────────────────┘ │ │ │ └─────────────────────────────────────────────────────────────────────┘ We write the thin customization layer. Microsoft maintains the heavy lifting.","excerpt":"Our Approach: AVM + BC Gov Customization Layer ┌─────────────────────────────────────────────────────────────────────┐ │ BC Gov AI Hub Architecture │…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-6","sectionTitle":"Decision","text":"We use AI Landing Zone reference architecture and AVM modules as our foundation, with a BC Gov customization layer on top. We do NOT use Microsoft's default configuration. We use their: Reference patterns - How to wire services together AVM modules - Tested, maintained infrastructure components Best practices - Security, networking, RBAC patterns","excerpt":"We use AI Landing Zone reference architecture and AVM modules as our foundation, with a BC Gov customization layer on top. We do NOT use Microsoft's default configuration. We use their: Reference patterns - How to wire…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-8","sectionTitle":"Consequences","text":"Positive Reduced maintenance - Microsoft maintains 90% of the code Faster development - Use proven patterns instead of inventing Security updates - Get patches via module version bumps Community support - Issues/bugs reported and fixed by others Audit trail - Using \"official\" modules helps with compliance Negative Module constraints - Can only do what AVM modules support Version management - Must track and update module versions Abstraction leakage - Sometimes need to understand module internals","excerpt":"Positive Reduced maintenance - Microsoft maintains 90% of the code Faster development - Use proven patterns instead of inventing Security updates - Get patches via module version bumps Community support - Issues/bugs…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-7","sectionTitle":"References","text":"Azure Verified Modules (AVM) AI/ML Landing Zone Pattern Module Azure Landing Zone Concepts Architecture Layers Diagram ADR-010: Multi-Tenant Isolation Model Accepted Status: Accepted Date: 2025-12 Driver: Policy Required Category: Architecture","excerpt":"Azure Verified Modules (AVM) AI/ML Landing Zone Pattern Module Azure Landing Zone Concepts Architecture Layers Diagram ADR-010: Multi-Tenant Isolation Model Accepted Status: Accepted Date: 2025-12 Driver: Policy Required…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-9","sectionTitle":"Context","text":"🏛️ Policy Driver: BC Gov requires strict data isolation between ministries. Each ministry's data must be logically separated, with access controls preventing cross-ministry data exposure. The AI Hub serves multiple BC Government tenants (WLRS, SDPR, NR-DAP, etc.) from shared infrastructure. The AI Hub Landing Zone is designed to serve multiple BC Government ministries from a single shared infrastructure deployment. This creates a multi-tenancy challenge: how do we provide cost-efficient shared services while ensuring strict data isolation between ministries?","excerpt":"🏛️ Policy Driver: BC Gov requires strict data isolation between ministries. Each ministry's data must be logically separated, with access controls preventing cross-ministry data exposure. The AI Hub serves multiple BC…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"the-problem-shared-infrastructure-isolated-data","sectionTitle":"The Problem: Shared Infrastructure, Isolated Data","text":"What We Cannot Do Allow Ministry A to access Ministry B's documents Share AI search indexes across ministries Use single storage accounts for all ministry data Allow cross-ministry API access without authorization What We Can Share Network infrastructure (VNets, Bastion, NSGs) Compute resources (AI Foundry Hub) Ingress layer (App Gateway, APIM) Monitoring and logging infrastructure","excerpt":"What We Cannot Do Allow Ministry A to access Ministry B's documents Share AI search indexes across ministries Use single storage accounts for all ministry data Allow cross-ministry API access without authorization What…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-7","sectionTitle":"Decision","text":"We implement a four-layer isolation model: 1. Storage Isolation Separate storage accounts per ministry Each ministry gets dedicated blob containers Azure RBAC restricts access to ministry principals Private endpoints per storage account Encryption keys can be ministry-specific (CMK) 2. AI Search Index Isolation Separate search indexes per ministry Each ministry's documents indexed separately RAG queries scoped to ministry index only No cross-index queries permitted Index-level access control via Azure RBAC 3. API Isolation (APIM) APIM subscriptions per ministry Unique subscription keys per ministry Rate limiting scoped to subscription API policies enforce ministry context Audit logging includes ministry identifier 4. Network Isolation (NSGs) Network policies enforce boundaries NSG rules restrict subnet-to-subnet traffic Private endpoints isolated by ministry where needed No direct cross-ministry network paths All traffic routed through controlled ingress","excerpt":"We implement a four-layer isolation model: 1. Storage Isolation Separate storage accounts per ministry Each ministry gets dedicated blob containers Azure RBAC restricts access to ministry principals Private endpoints per…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"implementation-architecture","sectionTitle":"Implementation Architecture","text":"┌─────────────────────────────────────────────────────────────────────────────┐ │ MULTI-TENANT ISOLATION MODEL │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ Ministry Health Ministry SDPR Ministry Justice │ │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │ │ │ APIM Sub: H │ │ APIM Sub: S │ │ APIM Sub: J │ │ │ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ │ │ │ │ │ │ │ ▼ ▼ ▼ │ │ ┌─────────────────────────────────────────────────────────────┐ │ │ │ Shared APIM (Policy Enforcement) │ │ │ │ (validates subscription → routes to ministry) │ │ │ └─────────────────────────────────────────────────────────────┘ │ │ │ │ │ │ │ ▼ ▼ ▼ │ │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │ │ │ Storage: H │ │ Storage: S │ │ Storage: J │ │ │ │ Index: H │ │ Index: S │ │ Index: J │ │ │ └─────────────┘ └─────────────┘ └─────────────┘ │ │ │ │ ════════════════════════════════════════════════════════════════ │ │ Shared Infrastructure Layer │ │ (VNet, Bastion, AI Foundry Compute, Monitoring) │ │ ════════════════════════════════════════════════════════════════ │ │ │ └─────────────────────────────────────────────────────────────────────────────┘","excerpt":"┌─────────────────────────────────────────────────────────────────────────────┐ │ MULTI-TENANT ISOLATION MODEL │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ Ministry Health…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-9","sectionTitle":"Consequences","text":"Positive Strong data isolation - Ministry data never co-mingled Cost efficiency - Shared compute and network infrastructure Audit compliance - Clear ministry attribution in all logs Scalable onboarding - New ministries get isolated resources automatically Flexible isolation levels - Can increase isolation (dedicated compute) if needed Negative Resource multiplication - Each ministry needs separate storage/indexes Complexity - More resources to manage and monitor Cost per ministry - Base cost increases with each ministry onboarded","excerpt":"Positive Strong data isolation - Ministry data never co-mingled Cost efficiency - Shared compute and network infrastructure Audit compliance - Clear ministry attribution in all logs Scalable onboarding - New ministries…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"cost-tracking","sectionTitle":"Cost Tracking","text":"Multi-tenant isolation also enables per-tenant cost tracking and chargeback. See the detailed cost allocation strategy: Click diagram to view full Cost Tracking documentation","excerpt":"Multi-tenant isolation also enables per-tenant cost tracking and chargeback. See the detailed cost allocation strategy: Click diagram to view full Cost Tracking documentation"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-8","sectionTitle":"References","text":"Cost Tracking Documentation - Full cost allocation strategy Multi-Tenant Isolation Diagram Azure Multi-Tenant Architecture Guide AI Request Data Flow Diagram ADR-011: Control Plane vs Data Plane Access & Chisel Tunnel Pending Status: Pending Date: 2026-01 Driver: Policy Required Category: Architecture This ADR explains a fundamental Azure concept that drives many architecture decisions: the difference between Control Plane and Data Plane access, why OIDC works for one but not the other, and how Chisel provides data plane access for platform maintainers.","excerpt":"Cost Tracking Documentation - Full cost allocation strategy Multi-Tenant Isolation Diagram Azure Multi-Tenant Architecture Guide AI Request Data Flow Diagram ADR-011: Control Plane vs Data Plane Access & Chisel Tunnel…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-10","sectionTitle":"Context","text":"Azure services have two distinct access paths that are often confused: Control Plane (ARM APIs) What: Managing Azure resources - create, update, delete, configure Endpoint: management.azure.com (always public) Authentication: OIDC tokens, Service Principals, Managed Identity Examples: Creating a Key Vault Configuring a Storage Account Setting up Private Endpoints RBAC role assignments Azure Portal UI (viewing resources) Data Plane (Service-specific APIs) What: Accessing data inside resources Endpoint: *.vault.azure.net , *.blob.core.windows.net , etc. Authentication: Same tokens, BUT requires network access Examples: Reading/writing Key Vault secrets Reading/writing Storage blobs Querying databases (PostgreSQL, CosmosDB) Calling Azure OpenAI APIs Terraform state file read/write","excerpt":"Azure services have two distinct access paths that are often confused: Control Plane (ARM APIs) What: Managing Azure resources - create, update, delete, configure Endpoint: management.azure.com (always public)…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"the-problem-private-endpoints-block-data-plane","sectionTitle":"The Problem: Private Endpoints Block Data Plane","text":"🔒 BC Gov Policy: All Azure services must use private endpoints. This blocks data plane access from the public internet - even with valid OIDC credentials! ┌─────────────────────────────────────────────────────────────────────────────┐ │ WHAT WORKS vs WHAT'S BLOCKED │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ From Public Internet (GitHub Actions, Azure Portal, Your Laptop): │ │ │ │ ✅ CONTROL PLANE (management.azure.com) │ │ • Create Key Vault → ARM API → Works │ │ • Create Storage Account → ARM API → Works │ │ • View resource properties in Portal → ARM API → Works │ │ • OIDC authentication → Azure AD → Works │ │ │ │ ❌ DATA PLANE (*.vault.azure.net, *.blob.core.windows.net) │ │ • Read Key Vault secret → Private Endpoint → BLOCKED │ │ • Write Storage blob → Private Endpoint → BLOCKED │ │ • \"View Secret Value\" in Portal → Private Endpoint → BLOCKED │ │ • Terraform state read/write → Private Endpoint → BLOCKED │ │ │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ From Inside VNet (Chisel Tunnel, Jumpbox, or Optional Self-hosted Runners):│ │ │ │ ✅ CONTROL PLANE → Still works (ARM is public) │ │ ✅ DATA PLANE → Works via Private Endpoints (network path exists) │ │ │ └─────────────────────────────────────────────────────────────────────────────┘","excerpt":"🔒 BC Gov Policy: All Azure services must use private endpoints. This blocks data plane access from the public internet - even with valid OIDC credentials!…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"why-azure-portal-shows-resources-but-not-data","sectionTitle":"Why Azure Portal Shows Resources But Not Data","text":"The Azure Portal is a Control Plane UI . When you browse to a Key Vault in the portal: ✅ You can see the vault exists (control plane: list resources) ✅ You can see its configuration (control plane: read properties) ❌ You CANNOT click \"Show Secret Value\" (data plane: blocked by private endpoint) This is why ADR-008 states \"No Azure Portal or Foundry Studio UI Access\" for data operations - the portal physically cannot reach private data plane endpoints from your browser.","excerpt":"The Azure Portal is a Control Plane UI . When you browse to a Key Vault in the portal: ✅ You can see the vault exists (control plane: list resources) ✅ You can see its configuration (control plane: read properties) ❌ You…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"why-oidc-is-used-for-control-plane","sectionTitle":"Why OIDC Is Used for Control Plane","text":"OIDC (OpenID Connect) federation provides passwordless authentication from GitHub Actions to Azure: ┌─────────────────────────────────────────────────────────────────────────────┐ │ OIDC AUTHENTICATION FLOW │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ 1. GitHub Actions workflow starts │ │ ↓ │ │ 2. GitHub OIDC Provider issues JWT token │ │ (claims: repo, branch, environment, workflow) │ │ ↓ │ │ 3. Token sent to Azure AD │ │ ↓ │ │ 4. Azure AD validates against Federated Credential │ │ (checks: issuer=GitHub, subject=repo:bcgov/ai-hub-tracking:...) │ │ ↓ │ │ 5. Azure AD issues Access Token (valid ~1 hour) │ │ ↓ │ │ 6. Access Token used for ARM API calls (Control Plane) │ │ ↓ │ │ ✅ terraform plan/apply (resource management) │ │ ✅ az cli commands (control plane operations) │ │ ✅ No secrets stored in GitHub! │ │ │ │ BUT: OIDC gives credentials, NOT network access. │ │ Data plane still blocked without VNet connectivity. │ │ │ └─────────────────────────────────────────────────────────────────────────────┘","excerpt":"OIDC (OpenID Connect) federation provides passwordless authentication from GitHub Actions to Azure: ┌─────────────────────────────────────────────────────────────────────────────┐ │ OIDC AUTHENTICATION FLOW │…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-multiple-access-methods-for-different-needs","sectionTitle":"Decision: Multiple Access Methods for Different Needs","text":"We provide four toggleable access mechanisms via Terraform, each serving a different use case: Access Method Terraform Toggle Who Uses It Use Case Plane Access Self-Hosted Runners github_runners_aca_enabled Other tenant repos Optional: persistent VNet compute for CI/CD workloads that can't use Chisel Control + Data Bastion + Jumpbox enable_bastion , enable_jumpbox Platform Maintainers Emergency debugging, manual admin tasks Control + Data Chisel Tunnel enable_azure_proxy Platform Maintainers Local dev access to private databases/APIs Control + Data Public GitHub Runners (default) CI/CD (limited) Control plane only operations Control only","excerpt":"We provide four toggleable access mechanisms via Terraform, each serving a different use case: Access Method Terraform Toggle Who Uses It Use Case Plane Access Self-Hosted Runners github_runners_aca_enabled Other tenant…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"chisel-tunnel-data-plane-access-for-platform-maintainers","sectionTitle":"Chisel Tunnel: Data Plane Access for Platform Maintainers","text":"🔧 Chisel is for Platform Maintainers ONLY - not for tenant/project developers. Tenants access AI services through APIM/App Gateway (the designed public entry point). What is Chisel? A fast TCP/UDP tunnel over HTTP that creates a secure reverse proxy from your local machine into the Azure VNet. ┌─────────────────────────────────────────────────────────────────────────────┐ │ CHISEL TUNNEL ARCHITECTURE │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ Platform Maintainer's Laptop │ │ ┌─────────────────────────────┐ │ │ │ Chisel Client (Docker) │ │ │ │ Listens on localhost:5432 │ │ │ └──────────────┬──────────────┘ │ │ │ HTTPS (encrypted) │ │ ▼ │ │ ┌─────────────────────────────────────────────────────────────────────┐ │ │ │ Azure App Service (Chisel Server) │ │ │ │ Inside VNet (app-service-subnet) │ │ │ │ Random auth: tunnel:XXXXXXXX │ │ │ └──────────────┬──────────────────────────────────────────────────────┘ │ │ │ VNet Integration (Private Network) │ │ ▼ │ │ ┌─────────────────────────────────────────────────────────────────────┐ │ │ │ Private Endpoints │ │ │ │ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ │ │ │ │ │ PostgreSQL │ │ Key Vault │ │ CosmosDB │ │ │ │ │ │ :5432 │ │ :443 │ │ :443 │ │ │ │ │ └──────────────┘ └──────────────┘ └──────────────┘ │ │ │ └─────────────────────────────────────────────────────────────────────┘ │ │ │ │ Result: psql -h localhost -p 5432 → tunnels to private PostgreSQL │ │ │ └─────────────────────────────────────────────────────────────────────────────┘","excerpt":"🔧 Chisel is for Platform Maintainers ONLY - not for tenant/project developers. Tenants access AI services through APIM/App Gateway (the designed public entry point). What is Chisel? A fast TCP/UDP tunnel over HTTP that…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"what-terraform-operations-need-data-plane","sectionTitle":"What Terraform Operations Need Data Plane?","text":"Most Terraform operations are control plane only. Data plane is only needed when: Resource/Operation Plane Works from Public? Example azurerm_key_vault (create) Control ✅ Yes Creating the vault itself azurerm_key_vault_secret (write) Data ❌ No Writing secrets INTO the vault data \"azurerm_key_vault_secret\" Data ❌ No Reading secrets FROM the vault Terraform state backend (Storage) Data ❌ No Reading/writing .tfstate blob azurerm_storage_account (create) Control ✅ Yes Creating the account azurerm_storage_blob (upload) Data ❌ No Uploading files to storage azurerm_private_endpoint Control ✅ Yes Creating the private endpoint RBAC role assignments Control ✅ Yes Granting permissions","excerpt":"Most Terraform operations are control plane only. Data plane is only needed when: Resource/Operation Plane Works from Public? Example azurerm_key_vault (create) Control ✅ Yes Creating the vault itself…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"access-model-summary","sectionTitle":"Access Model Summary","text":"┌─────────────────────────────────────────────────────────────────────────────┐ │ COMPLETE ACCESS MODEL │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ TENANT DEVELOPERS (Ministry Teams) │ │ ┌─────────────┐ ┌──────────────┐ ┌─────────────────┐ │ │ │ Their Apps │─────▶│ App Gateway │─────▶│ APIM (rate │─────▶ AI │ │ │ │ │ + WAF │ │ limited, metered)│ APIs │ │ └─────────────┘ └──────────────┘ └─────────────────┘ │ │ ▲ │ │ │ Public endpoint (by design) │ │ │ No direct private endpoint access │ │ │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ PLATFORM MAINTAINERS (This Team) │ │ │ │ ┌────────────────────────────────────────────────────────────────────────┐ │ │ │ Method │ Toggle Variable │ Use Case │ │ │ ├────────────────────────────────────────────────────────────────────────┤ │ │ │ Self-hosted Runners │ github_runners_aca_enabled │ Optional tenant CI/CD │ │ │ │ Bastion + Jumpbox │ enable_bastion/jumpbox │ Admin access │ │ │ │ Chisel Tunnel │ enable_azure_proxy │ Local dev access │ │ │ └────────────────────────────────────────────────────────────────────────┘ │ │ │ │ All three provide: Control Plane + Data Plane access │ │ │ └─────────────────────────────────────────────────────────────────────────────┘","excerpt":"┌─────────────────────────────────────────────────────────────────────────────┐ │ COMPLETE ACCESS MODEL │ ├─────────────────────────────────────────────────────────────────────────────┤ │ │ │ TENANT DEVELOPERS (Ministry…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-10","sectionTitle":"Consequences","text":"Positive Clear mental model - Understanding control vs data plane explains \"why\" behind many decisions Flexible access - Enable only what you need (cost optimization) Policy compliant - No public data plane endpoints ever Secure tenant isolation - Tenants use APIM, never touch private endpoints directly Negative Complexity - Must understand two planes, not just \"Azure access\" Chisel proxy dependency - Terraform workflows require the Azure Proxy App Service to be healthy before running Portal limitations - Can't \"see\" data in Portal even with permissions","excerpt":"Positive Clear mental model - Understanding control vs data plane explains \"why\" behind many decisions Flexible access - Enable only what you need (cost optimization) Policy compliant - No public data plane endpoints…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-9","sectionTitle":"References","text":"Playbook: Using Chisel Tunnel for Local Development Terraform Reference: azure-proxy module (Chisel) ADR-001: Shared Landing Zone ADR-002: OIDC Authentication ADR-008: No Azure Portal UI Access Microsoft Docs: Control Plane and Data Plane ADR-012: Hybrid Cost Allocation & Usage Monitoring Strategy Proposed Status: Proposed Date: 2026-01 Deciders: Platform Team Category: Observability","excerpt":"Playbook: Using Chisel Tunnel for Local Development Terraform Reference: azure-proxy module (Chisel) ADR-001: Shared Landing Zone ADR-002: OIDC Authentication ADR-008: No Azure Portal UI Access Microsoft Docs: Control…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-11","sectionTitle":"Context","text":"The AI Services Hub operates as a multi-tenant platform serving multiple ministries. This shared infrastructure creates a financial governance challenge: we must accurately allocate costs to specific tenants to ensure accountability and cost recovery. The architecture includes two types of resources: Tenant-Dedicated: Resources used exclusively by one tenant (e.g., Azure OpenAI instances, Document Intelligence, Cosmos DB). Shared Infrastructure: Resources serving all tenants simultaneously (e.g., APIM, App Gateway, Application Insights). We need a standardized strategy to track consumption and generate accurate chargeback invoices that account for both resource types across our dual-region deployment (Canada Central & East).","excerpt":"The AI Services Hub operates as a multi-tenant platform serving multiple ministries. This shared infrastructure creates a financial governance challenge: we must accurately allocate costs to specific tenants to ensure…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-8","sectionTitle":"Decision","text":"We will adopt a Hybrid Cost Allocation Model that combines native Azure billing with custom usage tracking: Direct Attribution (90% of costs): We will isolate high-cost resources (AI Foundry Projects, Document Intelligence) into tenant-specific resource groups. These will be billed directly to tenants using Azure Cost Management tags ( tenant-id ), requiring no manual calculation. Proportional Allocation (10% of costs): We will split the cost of shared infrastructure (APIM, App Gateway) based on actual usage metrics. APIM & Gateway costs split by API Request Volume . Monitoring costs split by Log Ingestion Volume . Centralized Tracking via APIM: Azure API Management will serve as the single source of truth for usage metrics. All traffic must flow through APIM to ensure consistent tenant identification and logging. Custom Egress Calculation: We will implement a custom calculation pipeline using App Gateway logs to track and charge for cross-region network egress (between Canada Central and Canada East).","excerpt":"We will adopt a Hybrid Cost Allocation Model that combines native Azure billing with custom usage tracking: Direct Attribution (90% of costs): We will isolate high-cost resources (AI Foundry Projects, Document…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"rationale-4","sectionTitle":"Rationale","text":"Minimizes Operational Overhead: By using Direct Attribution for the most expensive resources (OpenAI tokens, Search), we rely on Azure's native billing engine for the vast majority of chargebacks. We only maintain custom logic for the shared platform components. Fairness: A flat fee for shared infrastructure would be unfair to smaller tenants. Proportional allocation based on request volume ensures ministries only pay for the platform capacity they actually consume. Granular Visibility: Using APIM as the central logging point allows us to capture operational metrics (latency, errors, token usage) alongside billing data without adding sidecar proxies to every service.","excerpt":"Minimizes Operational Overhead: By using Direct Attribution for the most expensive resources (OpenAI tokens, Search), we rely on Azure's native billing engine for the vast majority of chargebacks. We only maintain custom…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-11","sectionTitle":"Consequences","text":"Positive Transparency: Tenants can verify their direct Azure costs in the portal using their tenant tag. Scalability: New tenants can be onboarded simply by adding tags; the cost model adjusts automatically. Cost Recovery: Ensures the Platform Team fully recovers infrastructure costs rather than absorbing the overhead of shared services. Negative Complexity of Egress: Cross-region data transfer is billed at the subscription level and is difficult to attribute. We accept the tradeoff of maintaining a custom Kusto query to calculate this specific cost. Maintenance: The logic for splitting shared costs (Python functions/Kusto queries) is custom code that must be maintained and verified monthly against Azure invoices. ADR-013: Scaled Stack Architecture with Isolated State Files Accepted Status: Accepted Date: 2026-02 Deciders: AI Services Hub Team Category: Infrastructure","excerpt":"Positive Transparency: Tenants can verify their direct Azure costs in the portal using their tenant tag. Scalability: New tenants can be onboarded simply by adding tags; the cost model adjusts automatically. Cost…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-12","sectionTitle":"Context","text":"The AI Services Hub infrastructure was originally deployed as a single Terraform root module with one monolithic state file containing ~174 resources. This created several operational problems: Blast radius: Any Terraform error or state corruption could affect all 174 resources simultaneously. Lock contention: Only one Terraform operation could run at a time across the entire infrastructure, even for independent resources. Serial execution: Foundry projects required parallelism=1 due to Azure ETag conflicts, which forced the entire apply to run serially. Apply duration: A full apply took 5m 44s because independent stacks (APIM, foundry, tenant-user-mgmt) had to wait for each other. Phased targeting: The deployment script used -target flags to orchestrate a multi-phase apply (Phase 1: everything except foundry, Phase 2: foundry only, Phase 3: validation). This was fragile and hid dependency issues.","excerpt":"The AI Services Hub infrastructure was originally deployed as a single Terraform root module with one monolithic state file containing ~174 resources. This created several operational problems: Blast radius: Any…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-9","sectionTitle":"Decision","text":"We split the monolithic root module into 5 isolated Terraform stacks , each with its own state file, backend configuration, and dependency management via terraform_remote_state data sources: Stack State Key Phase Purpose shared shared.tfstate 1 (serial) VNet, subnets, AI Foundry Hub, App Gateway, WAF, Key Vault, ACR, monitoring tenant tenant-{key}.tfstate 2 (parallel fan-out) Per-tenant resources: AI Search, CosmosDB, Document Intelligence, Storage, Key Vault foundry foundry.tfstate 3 (parallel) AI Foundry projects per tenant ( parallelism=1 to avoid ETag conflicts) apim apim.tfstate 3 (parallel) API Management gateway, policies, tenant subscriptions, role assignments tenant-user-mgmt tenant-user-management.tfstate 3 (parallel) Entra ID user/group assignments (requires Graph API permissions) A stack engine ( deploy-scaled.sh ) orchestrates execution in dependency order: Phase 1: shared runs first (all other stacks depend on it). Phase 2: tenant runs per-tenant in parallel (each tenant gets isolated TF_DATA_DIR and state). Phase 3: foundry , apim , and tenant-user-mgmt run concurrently (no cross-dependencies between them). For destroy , the order is reversed: Phase 3 stacks first (parallel), then tenants (parallel), then shared last.","excerpt":"We split the monolithic root module into 5 isolated Terraform stacks , each with its own state file, backend configuration, and dependency management via terraform_remote_state data sources: Stack State Key Phase Purpose…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"rationale-5","sectionTitle":"Rationale","text":"Reduced blast radius: A state corruption or failed apply in apim cannot affect shared or tenant resources. Each stack can be independently recovered. Parallel execution: Phase 3 stacks have no dependencies on each other and can run concurrently, reducing total apply time by ~60 seconds. Isolated parallelism: The foundry stack runs with parallelism=1 without forcing the entire infrastructure to be serial. APIM and tenant-user-mgmt run with full parallelism simultaneously. Independent state locking: Multiple operators or CI pipelines can work on different stacks without lock contention (e.g., updating APIM policies while a tenant deployment is in progress). Cleaner dependencies: Using terraform_remote_state data sources makes cross-stack dependencies explicit and typed, replacing implicit module-to-module references.","excerpt":"Reduced blast radius: A state corruption or failed apply in apim cannot affect shared or tenant resources. Each stack can be independently recovered. Parallel execution: Phase 3 stacks have no dependencies on each other…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-12","sectionTitle":"Consequences","text":"Positive 19% faster applies: Total apply time reduced from 5m 44s to 4m 39s (measured on test environment with 2 tenants). Eliminated -target phasing: The old Phase 1/2/3 with -target flags is replaced by natural stack ordering. No more fragile target expressions. Auto-recovery: The stack engine includes deposed object cleanup, import-on-conflict, and transient error retry — previously only available at the monolith level. Live output streaming: Each stack streams Terraform output in real time via tee , improving debuggability in CI/CD logs. Per-tenant state isolation: Each tenant has its own state file, making tenant onboarding/offboarding a state-level operation rather than a resource-level one. Negative More files: 5 stacks &times; 5 standard files (main.tf, variables.tf, outputs.tf, providers.tf, backend.tf) = 25 files vs. the original 6. Some variable declarations are duplicated across stacks. State migration required: One-time migration from the monolith state to 5 stack states using terraform state mv . This was performed manually with verification scripts. Cross-stack refactoring: Moving a resource between stacks requires a state move operation, not just a code move. This adds operational complexity for future refactors. Remote state coupling: Stacks are coupled via terraform_remote_state data sources. Adding a new output in shared that apim needs requires deploying shared first.","excerpt":"Positive 19% faster applies: Total apply time reduced from 5m 44s to 4m 39s (measured on test environment with 2 tenants). Eliminated -target phasing: The old Phase 1/2/3 with -target flags is replaced by natural stack…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-10","sectionTitle":"References","text":"Terraform Remote State Data Source infra-ai-hub/stacks/ — Stack root modules infra-ai-hub/scripts/deploy-scaled.sh — Stack engine infra-ai-hub/scripts/deploy-terraform.sh — Public entrypoint ADR-014: APIM Subscription Key Rotation Proposed Status: Proposed Date: 2026-02 Deciders: AI Services Hub Team Category: Security Pending STRA Approval This decision has been made by the AI Services Hub team and all infrastructure is in place. Final approval from the Security Threat and Risk Assessment (STRA) process is pending. The rotation mechanism can be enabled per-environment via a single config flag.","excerpt":"Terraform Remote State Data Source infra-ai-hub/stacks/ — Stack root modules infra-ai-hub/scripts/deploy-scaled.sh — Stack engine infra-ai-hub/scripts/deploy-terraform.sh — Public entrypoint ADR-014: APIM Subscription…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-13","sectionTitle":"Context","text":"APIM subscription keys authenticate tenant API calls to the AI Services Hub gateway. Without rotation, these long-lived secrets present a growing risk: Credential staleness: Keys provisioned at tenant onboarding remain valid indefinitely unless manually changed. A compromised key grants persistent access. No expiry enforcement: Azure APIM subscription keys have no built-in TTL or auto-expiry. The platform must implement rotation externally. BC Gov compliance: Government security policy expects secrets to be rotated periodically. The rotation interval and mechanism require STRA sign-off before production use. Multi-tenant blast radius: Each tenant has isolated subscription keys, but without rotation a single leaked key provides indefinite access to that tenant&rsquo;s API surface.","excerpt":"APIM subscription keys authenticate tenant API calls to the AI Services Hub gateway. Without rotation, these long-lived secrets present a growing risk: Credential staleness: Keys provisioned at tenant onboarding remain…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-10","sectionTitle":"Decision","text":"We implement an alternating primary/secondary key rotation pattern with zero downtime, driven by a scheduled GitHub Actions workflow and a self-contained Bash script: Alternating slots: APIM subscriptions have two key slots (primary and secondary). Each rotation cycle regenerates one slot while the other remains valid and untouched. Centralized hub Key Vault: After regeneration, both keys are written to a single hub Key Vault ( {app_name}-{env}-hkv ) with 90-day expiry and rotation metadata. No per-tenant Key Vault is required. Self-service retrieval: Tenants fetch current keys via GET /{tenant}/internal/apim-keys &mdash; an APIM policy endpoint that reads from the hub Key Vault using APIM&rsquo;s managed identity. No Azure SDK required. Configurable schedule: Rotation is controlled by two flags in params/{env}/shared.tfvars : rotation_enabled (master on/off) and rotation_interval_days (7 for dev/test, 30 for prod). OIDC authentication: The GitHub Actions workflow uses the same OIDC identity as Terraform deployments. No stored secrets for the rotation process itself. Component Purpose Location Rotation script Discovers APIM + hub KV, rotates keys, stores in KV infra-ai-hub/scripts/rotate-apim-keys.sh GHA workflow Scheduled trigger, OIDC login, calls script per-env .github/workflows/apim-key-rotation.yml Hub Key Vault Centralized storage for all tenant keys (scales to 1000+) stacks/shared/main.tf APIM policy endpoint /internal/apim-keys reads from hub KV params/apim/api_policy.xml.tftpl Terraform config Seeds initial KV secrets + RBAC for APIM MI &rarr; hub KV stacks/apim/main.tf","excerpt":"We implement an alternating primary/secondary key rotation pattern with zero downtime, driven by a scheduled GitHub Actions workflow and a self-contained Bash script: Alternating slots: APIM subscriptions have two key…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"rationale-6","sectionTitle":"Rationale","text":"Zero downtime: The alternating slot pattern guarantees one key is always valid. Tenants are never locked out during rotation. No Azure Function required: A Bash script + GHA scheduled workflow replaces what would otherwise require an Azure Function, Timer Trigger, and associated infrastructure. This keeps the solution simple and auditable. Centralized over distributed: A single hub Key Vault with tenant-prefixed secrets scales better than per-tenant Key Vaults. One RBAC assignment for APIM&rsquo;s managed identity covers all tenants. Self-service key retrieval: The /internal/apim-keys endpoint eliminates the need for tenants to have Azure portal access or Key Vault Reader roles. Any valid subscription key authenticates the request. Idempotent and safe: The script checks elapsed time since last rotation before acting. Multiple runs within the interval are no-ops. A --dry-run flag allows validation without changes.","excerpt":"Zero downtime: The alternating slot pattern guarantees one key is always valid. Tenants are never locked out during rotation. No Azure Function required: A Bash script + GHA scheduled workflow replaces what would…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-13","sectionTitle":"Consequences","text":"Positive Automated secret hygiene: Keys rotate on a known schedule with full audit trail in Key Vault versioning and GitHub Actions logs. Minimal tenant burden: Tenants can use the APIM internal endpoint, daily cron polling, or simply contact the platform team. No Azure SDK or Key Vault access needed. Emergency rotation: Both slots can be regenerated immediately via the documented runbook, invalidating all compromised keys. Per-environment control: Rotation can be enabled independently per environment &mdash; currently active in dev/test, disabled in prod pending STRA approval. Negative GitHub workflow dependency: Rotation depends on GitHub Actions scheduler. GitHub silently disables workflows after 60 days of repo inactivity &mdash; requires periodic commits or manual re-enablement. STRA gate: Production rotation cannot be enabled until the STRA process completes. Until then, prod keys are static (same risk as baseline). Tenant coordination: Tenants using hard-coded keys (rather than the self-service endpoint) must update their configuration within the rotation interval or face 401 errors.","excerpt":"Positive Automated secret hygiene: Keys rotate on a known schedule with full audit trail in Key Vault versioning and GitHub Actions logs. Minimal tenant burden: Tenants can use the APIM internal endpoint, daily cron…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-11","sectionTitle":"References","text":"APIM Key Rotation Guide &mdash; full operational documentation infra-ai-hub/scripts/rotate-apim-keys.sh &mdash; rotation script (704 lines) .github/workflows/apim-key-rotation.yml &mdash; GHA scheduled workflow params/{env}/shared.tfvars &mdash; per-environment rotation config ADR-015: Tenant Isolation: Resource Group vs Subscription Pending Platform/MS Status: Pending Platform/MS Date: 2026-02 Deciders: AI Services Hub Team, MS Team, Platform Services Team Category: Architecture Pending Discussion with Microsoft & Platform Services This decision requires input from Microsoft&rsquo;s team on Azure quota scaling options and from the Landing Zone Platform team on subscription provisioning constraints. The current RG-based design is the preferred approach for centralized governance. See #63 and #74 .","excerpt":"APIM Key Rotation Guide &mdash; full operational documentation infra-ai-hub/scripts/rotate-apim-keys.sh &mdash; rotation script (704 lines) .github/workflows/apim-key-rotation.yml &mdash; GHA scheduled workflow…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"context-14","sectionTitle":"Context","text":"The AI Services Hub serves multiple BC Government ministries from a shared Azure subscription. Tenant isolation is currently implemented at the Resource Group level &mdash; each tenant gets its own RG with dedicated data-plane resources while sharing control-plane infrastructure (VNet, App Gateway, APIM, AI Foundry Hub) in a central RG. As the platform scales beyond the initial 2 tenants, key Azure subscription-level quotas create hard scaling ceilings: Resource Per-Subscription Limit Per-Tenant Usage Ceiling (tenants) Model deployments per AI account 32 (default) 5&ndash;7 ~4&ndash;5 AI Search services 16 (Basic/Standard) 0&ndash;1 16 Cosmos DB accounts 50 0&ndash;1 50 Cognitive Services accounts 200 2 (Doc Intel + Speech) ~100 APIM APIs per instance 400 5&ndash;6 ~80 Private endpoints per subnet 1000 ~5 ~200 GlobalStandard TPM (per model) Varies (e.g., 2M for gpt-4.1-mini) 7.5K&ndash;30K Depends on model The most immediate bottleneck is the 32 model deployments per AI Foundry Hub account . With 2 tenants deploying 6&ndash;7 models each (13 total today), the limit is reached at roughly 4&ndash;5 tenants. Additionally, LLM quotas (PTU and GlobalStandard TPM) are tied to the subscription scope, so all tenants compete for the same throughput pool. Issue #74 raises specific questions about PTU scaling: turnaround time for quota increases, dynamic scaling between PTU and pay-as-you-go, and whether the single-subscription model can support production-scale workloads.","excerpt":"The AI Services Hub serves multiple BC Government ministries from a shared Azure subscription. Tenant isolation is currently implemented at the Resource Group level &mdash; each tenant gets its own RG with dedicated…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"options-evaluated","sectionTitle":"Options Evaluated","text":"Option A: Resource Group Isolation (Current & Preferred) All tenants share a single Azure subscription. Shared infrastructure (VNet, AppGW, APIM, AI Foundry Hub) lives in a central RG. Each tenant gets a dedicated RG with isolated data-plane resources. Scaling limits are mitigated at the application layer. Option B: Subscription-Per-Tenant Each tenant (or group of tenants) gets a dedicated Azure subscription. Shared infrastructure is replicated or connected via VNet peering. Each subscription has independent quota pools.","excerpt":"Option A: Resource Group Isolation (Current & Preferred) All tenants share a single Azure subscription. Shared infrastructure (VNet, AppGW, APIM, AI Foundry Hub) lives in a central RG. Each tenant gets a dedicated RG…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"option-a-resource-group-isolation-mdash-pros-cons","sectionTitle":"Option A: Resource Group Isolation &mdash; Pros & Cons","text":"Pros Centralized governance: Single subscription = single set of Azure Policies, RBAC, Defender for Cloud, cost management. One pane of glass for the platform team. Simplified networking: All resources in one VNet with one PE subnet. No cross-subscription VNet peering, no transit routing, no DNS forwarding complexity. Lower cost: Shared App Gateway, APIM, AI Foundry Hub, Log Analytics. No per-subscription overhead (reserved instances apply once, shared Defender plans). Faster tenant onboarding: Adding a tenant = adding a Terraform tenant config block. No subscription provisioning, OIDC setup, or Landing Zone request. Existing investment: Current architecture (5 stacks, phased deployment, APIM key rotation) is built and validated for this model. Operational simplicity: One deployment pipeline, one set of state files per environment, one OIDC identity per environment. Cost attribution: Per-tenant RGs enable native Azure Cost Management tag-based and RG-based cost reporting without subscription boundaries. Cons Quota ceilings: All tenants share subscription-scoped quotas. The 32-deployment AI account limit is the most immediate constraint (~4&ndash;5 tenants). TPM/PTU contention: All model deployments on the shared Hub compete for the same GlobalStandard TPM pool. High-demand tenants crowd out others. Blast radius: A subscription-level issue (quota exhaustion, policy misconfiguration, billing suspension) impacts all tenants simultaneously. Quota increase friction: Requesting Azure quota increases is a per-subscription manual process. Lead times can be days to weeks for PTU. AI Search hard limit: 16 search services per subscription is a fixed limit with no increase path &mdash; hard wall at 16 search-enabled tenants. Foundry serialization: Model deployments run serially across all tenants to avoid ETag conflicts on the shared Hub. More tenants = slower deploys.","excerpt":"Pros Centralized governance: Single subscription = single set of Azure Policies, RBAC, Defender for Cloud, cost management. One pane of glass for the platform team. Simplified networking: All resources in one VNet with…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"option-b-subscription-per-tenant-mdash-pros-cons","sectionTitle":"Option B: Subscription-Per-Tenant &mdash; Pros & Cons","text":"Pros Independent quota pools: Each subscription gets its own 32 model deployments, 200 Cognitive Services accounts, 16 AI Search services, etc. Eliminates quota-based scaling ceilings. PTU isolation: Each tenant can request and manage its own PTU commitments. No cross-tenant throughput contention. Blast radius reduction: Subscription-level issues are isolated to one tenant. Independent scaling: Each subscription can scale resources (VM sizes, throughput, storage) without affecting others. Compliance flexibility: Some future tenants may have regulatory requirements (FOIPPA, health data) that mandate subscription-level isolation. Clean cost separation: Native Azure billing per subscription. No tag-based attribution needed. Cons Loss of central governance: Each subscription needs its own Azure Policies, RBAC assignments, Defender plans. Policy drift risk increases linearly. Networking complexity: Requires cross-subscription VNet peering (or VWAN hub-and-spoke), cross-subscription private DNS zones, transit routing. Significant complexity increase. Infrastructure duplication: App Gateway, APIM, Key Vault, and potentially AI Foundry Hub must be replicated per subscription &mdash; or a complex shared services model must be designed. Higher cost: Duplicated infrastructure (App Gateway ~$300/mo, APIM StandardV2 ~$700/mo per subscription). Reserved instance savings are fragmented. Subscription provisioning lead time: BC Gov Landing Zone subscription requests go through the Platform Services team. Lead time is days to weeks, blocking rapid tenant onboarding. Pipeline complexity: Each subscription needs its own OIDC federation, deployment pipeline, state backend. The current single-pipeline model does not extend. Operational overhead: N subscriptions = N sets of monitoring, alerting, secret rotation, certificate management. Platform team workload scales linearly. APIM routing: A shared APIM fronting multiple subscription backends requires cross-subscription private endpoints or public exposure &mdash; both add complexity.","excerpt":"Pros Independent quota pools: Each subscription gets its own 32 model deployments, 200 Cognitive Services accounts, 16 AI Search services, etc. Eliminates quota-based scaling ceilings. PTU isolation: Each tenant can…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"decision-11","sectionTitle":"Decision","text":"We continue with Resource Group isolation (Option A) as the preferred architecture, with specific mitigations for quota scaling constraints. This decision is pending confirmation from Microsoft on quota flexibility and from the Platform team on subscription provisioning options as a future fallback.","excerpt":"We continue with Resource Group isolation (Option A) as the preferred architecture, with specific mitigations for quota scaling constraints. This decision is pending confirmation from Microsoft on quota flexibility and…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"mitigations-for-rg-based-scaling-limits","sectionTitle":"Mitigations for RG-Based Scaling Limits","text":"Constraint Limit Mitigation Strategy Status Model deployments per AI account 32 Request quota increase via Azure Support. Deploy a second AI Foundry Hub account if increase denied. Consolidate shared models (e.g., single embedding model for all tenants). Pending MS GlobalStandard TPM contention Per-model cap Implement APIM rate limiting per tenant (already in place). Explore PTU for high-priority tenants. Use dynamic_throttling_enabled on AI account. Investigate PTU &harr; pay-as-you-go spillover. Pending MS AI Search services 16 Not all tenants need AI Search (1 of 2 currently enabled). For tenants with simple needs, use shared index with document-level permissions or skip Search entirely. Mitigated Foundry project serialization Serial deploys Already mitigated in ADR-013 (scaled stacks). Foundry stack runs serial but other phases are parallel. prevent_destroy on model deployments reduces redeploy churn. In Place APIM API count 400 Consolidate API definitions. Use a single versioned API with tenant routing via APIM policies rather than per-tenant API duplicates. Future","excerpt":"Constraint Limit Mitigation Strategy Status Model deployments per AI account 32 Request quota increase via Azure Support. Deploy a second AI Foundry Hub account if increase denied. Consolidate shared models (e.g., single…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"trigger-for-revisiting-this-decision","sectionTitle":"Trigger for Revisiting This Decision","text":"The following conditions would warrant moving specific tenants or tenant groups to dedicated subscriptions (hybrid model): Tenant count exceeds 10&ndash;15 and quota increase requests are denied by Microsoft A tenant requires dedicated PTU with guaranteed throughput SLAs that conflict with shared pool Regulatory requirements (e.g., health data under FOIPPA) mandate subscription-level isolation explicitly PTU turnaround time for quota increases exceeds acceptable lead times for tenant onboarding Total GlobalStandard TPM across all tenants approaches the per-model subscription ceiling","excerpt":"The following conditions would warrant moving specific tenants or tenant groups to dedicated subscriptions (hybrid model): Tenant count exceeds 10&ndash;15 and quota increase requests are denied by Microsoft A tenant…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"rationale-7","sectionTitle":"Rationale","text":"Right-sizing for now: With 2 active tenants and realistic growth to 5&ndash;10 in the near term, the RG model has headroom with mitigations. Subscription-level rearchitecture is premature. Governance is the priority: BC Gov Landing Zone policies, RBAC, and audit requirements are significantly easier to enforce in a single subscription. The compliance benefit outweighs the quota risk. Cost efficiency: Shared infrastructure saves ~$1,000+/mo per avoided subscription (AppGW + APIM alone). This is material in a government context. Onboarding velocity: A Terraform config change vs. a multi-week subscription provisioning request. This directly impacts ministry adoption speed. Hybrid escape hatch: The architecture supports a future hybrid model where high-demand or compliance-sensitive tenants move to dedicated subscriptions while most remain on the shared RG model. This is not an irreversible decision.","excerpt":"Right-sizing for now: With 2 active tenants and realistic growth to 5&ndash;10 in the near term, the RG model has headroom with mitigations. Subscription-level rearchitecture is premature. Governance is the priority: BC…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"open-questions-for-microsoft","sectionTitle":"Open Questions for Microsoft","text":"❓ These questions are tracked in #74 and require input from the Microsoft CAF/FastTrack team: What is the turnaround time for PTU quota increases when current allocation is at full capacity? Does PTU support dynamic scaling (elastic range) or is it fixed at a provisioned point? Can you provide Terraform samples for auto-fallback between PTU and GlobalStandard (pay-as-you-go)? Can the 32 model deployment limit per Cognitive Services account be increased? To what ceiling? Is there a recommended pattern for multi-AI-Foundry-Hub accounts within a single subscription to distribute deployments?","excerpt":"❓ These questions are tracked in #74 and require input from the Microsoft CAF/FastTrack team: What is the turnaround time for PTU quota increases when current allocation is at full capacity? Does PTU support dynamic…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"consequences-14","sectionTitle":"Consequences","text":"Positive No immediate rearchitecture needed: The platform continues operating with the validated RG-based model while answers from Microsoft are pending. Clear scaling triggers: The team knows exactly which quotas to monitor and at what tenant count to revisit the decision. Documented escape path: If RG-based scaling hits limits, the migration path to subscription-per-tenant (or hybrid) is architecturally understood. Negative Near-term ceiling: The 32-deployment limit means maximum ~4&ndash;5 tenants without a quota increase or model consolidation. This is a known constraint. MS dependency: Key mitigations (quota increases, PTU scaling guidance) depend on Microsoft response timelines. Potential future migration: If the hybrid model is eventually needed, migrating a tenant from shared subscription to dedicated subscription requires re-creating resources, migrating data, and updating APIM routing &mdash; non-trivial effort.","excerpt":"Positive No immediate rearchitecture needed: The platform continues operating with the validated RG-based model while answers from Microsoft are pending. Clear scaling triggers: The team knows exactly which quotas to…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"references-12","sectionTitle":"References","text":"Issue #63: Decision | Tenant Isolation | RG Or Subscription Issue #74: Foundry Hub | Single Subscription | Scaling (parent issue) ADR-010: Multi-Tenant Isolation Model &mdash; four-layer isolation architecture ADR-013: Scaled Stack Architecture &mdash; phased deployment with isolated state Azure OpenAI Quotas and Limits Azure Subscription Service Limits","excerpt":"Issue #63: Decision | Tenant Isolation | RG Or Subscription Issue #74: Foundry Hub | Single Subscription | Scaling (parent issue) ADR-010: Multi-Tenant Isolation Model &mdash; four-layer isolation architecture ADR-013:…"},{"page":"decisions.html","pageTitle":"Architecture Decision Records","sectionId":"adr-template","sectionTitle":"ADR Template","text":"Use this template when adding new ADRs: ## ADR-XXX: [Title] **Status:** [Proposed | Accepted | Deprecated | Superseded] **Date:** YYYY-MM **Deciders:** [Team/People] **Category:** [Security | Networking | Infrastructure | Documentation | etc.] ### Context [What is the issue? What forces are at play?] ### Decision [What is the decision? Be specific.] ### Rationale [Why this decision over alternatives?] ### Consequences #### Positive - [Good outcomes] #### Negative - [Tradeoffs accepted] ### References - [Links to relevant docs, diagrams, discussions] You have reached the end of the ADR list. ↑ Back to Decision Index AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"Use this template when adding new ADRs: ## ADR-XXX: [Title] **Status:** [Proposed | Accepted | Deprecated | Superseded] **Date:** YYYY-MM **Deciders:** [Team/People] **Category:** [Security | Networking | Infrastructure…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"architecture-diagrams","sectionTitle":"Architecture Diagrams","text":"Interactive diagrams showing the OIDC authentication flow, infrastructure architecture, and deployment processes. Click any diagram to view it in the interactive viewer with zoom and pan controls.","excerpt":"Interactive diagrams showing the OIDC authentication flow, infrastructure architecture, and deployment processes. Click any diagram to view it in the interactive viewer with zoom and pan controls."},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"select-a-diagram","sectionTitle":"Select a Diagram","text":"","excerpt":""},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"architecture-overview","sectionTitle":"Architecture Overview","text":"Coming Soon '\"> Architecture Layers From Microsoft upstream to BC Gov adaptation to deployed environments Coming Soon '\"> Multi-Tenant Isolation How ministries share the landing zone securely with data isolation Coming Soon '\"> AI Request Data Flow Complete request path from user through App Gateway, APIM to AI response Coming Soon '\"> 3-Step Access Evolution Evolution from Bastion → Container Apps runners (previous) → Chisel+App Service (current) with cost comparison Coming Soon '\"> Chisel Tunnel Detail How HTTPS tunnel from laptop reaches private endpoints via App Service Coming Soon '\"> When Terraform Needs Key Vault Data plane vs control plane operations with real examples","excerpt":"Coming Soon '\"> Architecture Layers From Microsoft upstream to BC Gov adaptation to deployed environments Coming Soon '\"> Multi-Tenant Isolation How ministries share the landing zone securely with data isolation Coming…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"stakeholder-infographics-share-these","sectionTitle":"Stakeholder Infographics (Share These!)","text":"Coming Soon '\"> Tenant Resource Group Model One-pager: Per-ministry RG structure, IP allocation, AVM modules, what's included Coming Soon '\"> Microsoft vs BC Gov Side-by-side: What Microsoft assumes vs what BC Gov requires Coming Soon '\"> What's Included / Not Included, conditional, and out-of-scope services with IP budget guide Coming Soon '\"> IP Budget Breakdown Detailed IP allocation: base infrastructure, per-tenant consumption, 50 IP calculation","excerpt":"Coming Soon '\"> Tenant Resource Group Model One-pager: Per-ministry RG structure, IP allocation, AVM modules, what's included Coming Soon '\"> Microsoft vs BC Gov Side-by-side: What Microsoft assumes vs what BC Gov…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"network-infrastructure","sectionTitle":"Network & Infrastructure","text":"Coming Soon '\"> Networking Architecture (Detailed) Complete network diagram: VNets, subnets, NSGs, traffic flow, private endpoints, IP budgets Coming Soon '\"> Network Environments All 4 VNets (prod, test, dev, tools) with subnet allocations and NSG rules Coming Soon '\"> Network Architecture VNet topology, subnets, NSGs, and Bastion connectivity","excerpt":"Coming Soon '\"> Networking Architecture (Detailed) Complete network diagram: VNets, subnets, NSGs, traffic flow, private endpoints, IP budgets Coming Soon '\"> Network Environments All 4 VNets (prod, test, dev, tools)…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"platform-access-security","sectionTitle":"Platform Access & Security","text":"Coming Soon '\"> Control vs Data Plane Why OIDC works for some operations but not others with private endpoints Coming Soon '\"> Access Methods Architecture Four toggleable access methods: GitHub-hosted runners (CI/CD via Chisel), optional self-hosted runners, Bastion, Chisel Coming Soon '\"> Who Deploys What Platform Team vs Project Teams: Who owns what infrastructure Coming Soon '\"> Deployment Scenarios Three paths: Project team, Platform admin, Solo dev with costs","excerpt":"Coming Soon '\"> Control vs Data Plane Why OIDC works for some operations but not others with private endpoints Coming Soon '\"> Access Methods Architecture Four toggleable access methods: GitHub-hosted runners (CI/CD via…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"authentication-cicd","sectionTitle":"Authentication & CI/CD","text":"OIDC Complete Guide Full authentication flow, token lifecycle, and architecture overview Coming Soon '\"> Token Exchange Flow Detailed JWT token exchange between GitHub and Azure Coming Soon '\"> Deployment Pipeline All GHA workflows, manual dispatch through secure tunnel, phased Terraform Coming Soon '\"> APIM Key Rotation Daily scheduled rotation with alternating slot pattern and zero-downtime Coming Soon '\"> Scaled Stack Deployment 3-phase execution engine with isolated state files and parallel tenants","excerpt":"OIDC Complete Guide Full authentication flow, token lifecycle, and architecture overview Coming Soon '\"> Token Exchange Flow Detailed JWT token exchange between GitHub and Azure Coming Soon '\"> Deployment Pipeline All…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"microsoft-reference-upstream","sectionTitle":"Microsoft Reference (Upstream)","text":"Coming Soon '\"> MS: With Platform LZ Microsoft's reference architecture with Platform Landing Zone (recommended) Coming Soon '\"> MS: Without Platform LZ Microsoft's standalone application landing zone reference","excerpt":"Coming Soon '\"> MS: With Platform LZ Microsoft's reference architecture with Platform Landing Zone (recommended) Coming Soon '\"> MS: Without Platform LZ Microsoft's standalone application landing zone reference"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"interactive-viewer","sectionTitle":"Interactive Viewer","text":"Architecture Layers (Upstream to Deployment) − Zoom Out 100% + Zoom In Reset Fit Width ⛶ Fullscreen ↓ Download + / - Zoom 0 Reset W Fit Width F Fullscreen Esc Exit Fullscreen BC Blue - Primary elements BC Gold - Highlights & actions Green - Success states Azure Blue - Azure services","excerpt":"Architecture Layers (Upstream to Deployment) − Zoom Out 100% + Zoom In Reset Fit Width ⛶ Fullscreen ↓ Download + / - Zoom 0 Reset W Fit Width F Fullscreen Esc Exit Fullscreen BC Blue - Primary elements BC Gold -…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"diagram-descriptions","sectionTitle":"Diagram Descriptions","text":"","excerpt":""},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"oidc-complete-guide","sectionTitle":"OIDC Complete Guide","text":"The comprehensive diagram showing: Section 1: One-time setup process and prerequisites Section 2: Token lifecycle and 5-step exchange flow Section 3: Terraform backend and workflow configuration Section 4: Complete architecture with all components Section 5: Quick reference checklist and troubleshooting","excerpt":"The comprehensive diagram showing: Section 1: One-time setup process and prerequisites Section 2: Token lifecycle and 5-step exchange flow Section 3: Terraform backend and workflow configuration Section 4: Complete…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"token-exchange-flow","sectionTitle":"Token Exchange Flow","text":"Detailed sequence diagram showing: GitHub Actions requesting OIDC token JWT claims and audience configuration Azure AD token validation Federated credential matching Access token issuance and scope","excerpt":"Detailed sequence diagram showing: GitHub Actions requesting OIDC token JWT claims and audience configuration Azure AD token validation Federated credential matching Access token issuance and scope"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"network-architecture","sectionTitle":"Network Architecture","text":"Infrastructure topology showing: Virtual Network and address spaces Subnet segmentation strategy NSG rules and traffic flow Bastion and Jumpbox connectivity Private endpoint configurations","excerpt":"Infrastructure topology showing: Virtual Network and address spaces Subnet segmentation strategy NSG rules and traffic flow Bastion and Jumpbox connectivity Private endpoint configurations"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"network-environments","sectionTitle":"Network Environments","text":"Complete environment layout: All 4 VNets (da4cf6-prod/test/dev/tools) Subnet allocations per environment Canada Central (prod) vs Canada East (non-prod) Client connectivity via App Gateway + APIM NSG rules and cross-environment isolation","excerpt":"Complete environment layout: All 4 VNets (da4cf6-prod/test/dev/tools) Subnet allocations per environment Canada Central (prod) vs Canada East (non-prod) Client connectivity via App Gateway + APIM NSG rules and…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"deployment-pipeline","sectionTitle":"Deployment Pipeline","text":"Complete CI/CD workflow visualization: All 6 GHA workflows (manual-dispatch, key-rotation, module mgmt, schedule, PR, pages) Manual dispatch to dev/test/prod with OIDC federation Proxy deploy → health check → secure tunnel (chisel+privoxy) Reusable workflow templates (.deployer + .deployer-using-secure-tunnel) Script architecture: deploy-terraform.sh → deploy-scaled.sh → 3 phases","excerpt":"Complete CI/CD workflow visualization: All 6 GHA workflows (manual-dispatch, key-rotation, module mgmt, schedule, PR, pages) Manual dispatch to dev/test/prod with OIDC federation Proxy deploy → health check → secure…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"apim-key-rotation","sectionTitle":"APIM Key Rotation","text":"Automated key rotation architecture: Daily schedule (9 UTC) + manual dispatch triggers Scheduled flow: dev+test parallel → prod gated on test success 8-step rotation script process with alternating primary/secondary slots Zero-downtime pattern: regenerate inactive → store in KV → swap active Infrastructure: APIM ↔ Hub Key Vault ↔ Terraform Config","excerpt":"Automated key rotation architecture: Daily schedule (9 UTC) + manual dispatch triggers Scheduled flow: dev+test parallel → prod gated on test success 8-step rotation script process with alternating primary/secondary…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"scaled-stack-deployment","sectionTitle":"Scaled Stack Deployment","text":"3-phase execution engine architecture: 5 isolated Terraform state files (shared, tenant, foundry, apim, tenant-user-mgmt) Phase 1: shared foundation (sequential) — network, KV, AppGW, WAF Phase 2: tenant stacks (parallel per-tenant) — isolated state Phase 3: foundry + apim + tenant-user-mgmt (all 3 in parallel) Performance: ~4m39s total (19% improvement over monolithic)","excerpt":"3-phase execution engine architecture: 5 isolated Terraform state files (shared, tenant, foundry, apim, tenant-user-mgmt) Phase 1: shared foundation (sequential) — network, KV, AppGW, WAF Phase 2: tenant stacks (parallel…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"using-svg-diagrams","sectionTitle":"Using SVG Diagrams","text":"💡 Why SVG? SVG diagrams are vector-based, meaning they scale infinitely without losing quality. You can zoom in to see fine details, search text within the diagram, and even modify colors or extract sections for presentations.","excerpt":"💡 Why SVG? SVG diagrams are vector-based, meaning they scale infinitely without losing quality. You can zoom in to see fine details, search text within the diagram, and even modify colors or extract sections for…"},{"page":"diagrams.html","pageTitle":"Architecture Diagrams","sectionId":"tips-for-working-with-svg-diagrams","sectionTitle":"Tips for Working with SVG Diagrams","text":"In Browser Use Ctrl+F to search for text Right-click → \"Open image in new tab\" for native zoom Browser zoom (Ctrl +/-) works on SVG Downloaded Open in VS Code for editing Use Inkscape for advanced modifications Import into Figma/Sketch for presentations /** * ============================================================================ * SVG Diagram Viewer - Pure ES6 JavaScript (No Dependencies) * ============================================================================ * * This viewer provides interactive zoom, pan, and fullscreen for SVG diagrams. * It uses only vanilla JavaScript and CSS transforms - no libraries needed. * * How it works: * 1. Diagrams are stored in an object with IDs, titles, and file paths * 2. CSS transform: scale() handles zooming (GPU-accelerated) * 3. Overflow: auto on the container provides panning via scrollbars * 4. CSS position: fixed handles fullscreen mode * * Browser Support: All modern browsers (Chrome, Firefox, Safari, Edge) * ============================================================================ */ // ───────────────────────────────────────────────────────────────────────────── // CONFIGURATION: Diagram Registry // ───────────────────────────────────────────────────────────────────────────── // Each diagram has a unique ID, display title, and path to the SVG file. // To add a new diagram: add an entry here and a card in the HTML gallery. const diagrams = { // Architecture Overview 'architecture-layers': { title: 'Architecture Layers (Upstream to Deployment)', src: 'assets/architecture-layers.svg' }, // Stakeholder Infographics (NEW) 'tenant-rg-model': { title: 'Tenant Resource Group Model', src: 'assets/tenant-resource-group-model.svg' }, 'ms-vs-bcgov': { title: 'Microsoft vs BC Gov Comparison', src: 'assets/microsoft-vs-bcgov-comparison.svg' }, 'whats-included': { title: 'What\\'s Included / Not Included', src: 'assets/whats-included-scope.svg' }, 'ip-budget': { title: 'IP Budget Breakdown', src: 'assets/ip-budget-breakdown.svg' }, // Authentication 'oidc-complete': { title: 'OIDC Complete Guide', src: 'assets/azure-oidc-complete-guide.svg' }, 'token-flow': { title: 'Token Exchange Flow', src: 'assets/token-flow.svg' }, // Networking 'network-detailed': { title: 'Networking Architecture (Detailed)', src: 'assets/networking-architecture-detailed.svg' }, 'network-arch': { title: 'Network Architecture', src: 'assets/network-architecture.svg' }, 'network-environments': { title: 'Network Environments (All VNets)', src: 'assets/network-environments.svg' }, // Multi-Tenancy & Flow 'multi-tenant': { title: 'Multi-Tenant Isolation Model', src: 'assets/multi-tenant-isolation.svg' }, 'data-flow': { title: 'AI Request Data Flow', src: 'assets/data-flow.svg' }, // Platform Access & Security 'control-data-plane': { title: 'Control Plane vs Data Plane', src: 'assets/control-vs-data-plane.svg' }, 'access-methods': { title: 'Access Methods Architecture', src: 'assets/access-methods-architecture.svg' }, 'who-deploys-what': { title: 'Who Deploys What', src: 'assets/who-deploys-what.svg' }, 'deployment-scenarios': { title: 'Deployment Scenarios', src: 'assets/deployment-scenarios.svg' }, 'three-steps-evolution': { title: '3-Step Access Evolution', src: 'assets/three-steps-access-evolution.svg' }, 'chisel-detail': { title: 'Chisel Tunnel Detail', src: 'assets/chisel-tunnel-detail.svg' }, 'terraform-keyvault': { title: 'When Terraform Needs Key Vault', src: 'assets/when-terraform-needs-keyvault.svg' }, // CI/CD 'deployment-pipeline': { title: 'Deployment Pipeline', src: 'assets/deployment-pipeline.svg' }, 'apim-key-rotation': { title: 'APIM Key Rotation', src: 'assets/apim-key-rotation.svg' }, 'scaled-deployment': { title: 'Scaled Stack Deployment', src: 'assets/scaled-deployment.svg' }, // Microsoft Reference (PNG) 'ms-with-platform': { title: 'MS Reference: With Platform LZ', src: 'assets/AI-Landing-Zone-with-platform.png' }, 'ms-without-platform': { title: 'MS Reference: Without Platform LZ', src: 'assets/AI-Landing-Zone-without-platform.png' } }; // ───────────────────────────────────────────────────────────────────────────── // STATE: Zoom Level Management // ───────────────────────────────────────────────────────────────────────────── // Using 'let' because this value changes. Constants define boundaries. let currentZoom = 100; // Current zoom level as percentage (100 = actual size) const minZoom = 25; // Minimum zoom: 25% (zoomed out) const maxZoom = 400; // Maximum zoom: 400% (zoomed in) const zoomStep = 25; // How much to zoom per click/keypress // ───────────────────────────────────────────────────────────────────────────── // FUNCTION: loadDiagram(id, element) // ───────────────────────────────────────────────────────────────────────────── // Loads a diagram into the viewer when user clicks a gallery card. // // Parameters: // id - String key matching a diagram in the 'diagrams' object // element - The DOM element (card) that was clicked // // What it does: // 1. Looks up diagram data by ID // 2. Updates gallery cards to show which is selected // 3. Updates the viewer with the new diagram // 4. Resets zoom to 100% // 5. Scrolls the viewer into view function loadDiagram(id, element, skipScroll = false) { // Look up the diagram configuration const diagram = diagrams[id]; // Guard clause: exit if diagram ID doesn't exist if (!diagram) return; // Update gallery cards: remove 'active' class from all cards // querySelectorAll returns a NodeList, forEach iterates over it document.querySelectorAll('.diagram-card').forEach(card => card.classList.remove('active')); // Add 'active' class to the clicked card (if element provided) if (element) element.classList.add('active'); // Update the viewer elements with new diagram data // getElementById is the fastest way to find a single element by ID document.getElementById('currentDiagramTitle').textContent = diagram.title; document.getElementById('currentDiagram').src = diagram.src; document.getElementById('currentDiagram').alt = diagram.title; document.getElementById('downloadBtn').href = diagram.src; // ───────────────────────────────────────────────────────────────────────── // DEEP LINKING: Update URL hash so users can share links to specific diagrams // Example: diagrams.html#network-arch links directly to the network diagram // ───────────────────────────────────────────────────────────────────────── // history.pushState allows updating URL without page reload // We use replaceState to avoid cluttering browser history with each click if (history.replaceState) { history.replaceState(null, null, '#' + id); } else { // Fallback for older browsers window.location.hash = id; } // Reset zoom to 100% for the new diagram resetZoom(); // Smooth scroll the viewer into view (only when user explicitly clicks a card) // Uses an offset-aware scroll so the sticky navbar doesn't cover the viewer top if (!skipScroll) { const viewer = document.getElementById('diagramViewer'); const navbar = document.querySelector('.bc-header'); const navHeight = navbar ? navbar.getBoundingClientRect().height : 70; const top = viewer.getBoundingClientRect().top + window.scrollY - navHeight - 8; window.scrollTo({ top: Math.max(0, top), behavior: 'smooth' }); } } // ───────────────────────────────────────────────────────────────────────────── // FUNCTION: updateZoom() // ───────────────────────────────────────────────────────────────────────────── // Applies the current zoom level to the SVG wrapper element. // // How CSS transform: scale() works: // - scale(1) = 100% = actual size // - scale(2) = 200% = twice as large // - scale(0.5) = 50% = half size // // We divide by 100 to convert our percentage to the decimal scale() expects. // The transform is GPU-accelerated, making it smooth even for large SVGs. function updateZoom() { const wrapper = document.getElementById('svgWrapper'); // Apply CSS transform with template literal for string interpolation // Example: currentZoom=150 becomes \"scale(1.5)\" wrapper.style.transform = `scale(${currentZoom / 100})`; // Update the zoom percentage display in the toolbar document.getElementById('zoomLevel').textContent = currentZoom + '%'; } // ───────────────────────────────────────────────────────────────────────────── // FUNCTION: zoomIn() // ───────────────────────────────────────────────────────────────────────────── // Increases zoom level by zoomStep (25%). // Uses Math.min to ensure we never exceed maxZoom. function zoomIn() { // Only zoom if we haven't hit the maximum if (currentZoom minZoom) { // Subtract zoomStep, but floor at minZoom // Math.max(a, b) returns the larger value currentZoom = Math.max(currentZoom - zoomStep, minZoom); updateZoom(); } } // ───────────────────────────────────────────────────────────────────────────── // FUNCTION: resetZoom() // ───────────────────────────────────────────────────────────────────────────── // Resets zoom to 100% (actual size) and scrolls to top-left corner. function resetZoom() { currentZoom = 100; updateZoom(); // Reset scroll position to top-left // scrollTo(x, y) sets the scroll position in pixels document.getElementById('diagramContainer').scrollTo(0, 0); } // ───────────────────────────────────────────────────────────────────────────── // FUNCTION: fitToWidth() // ───────────────────────────────────────────────────────────────────────────── // Calculates and applies the zoom level that makes the diagram fit the // container width exactly. // // Math: // zoom = (containerWidth / imageWidth) * 100 // Example: 800px container / 1600px image = 0.5 * 100 = 50% function fitToWidth() { const container = document.getElementById('diagramContainer'); const img = document.getElementById('currentDiagram'); // clientWidth = visible width of element (excludes scrollbar) // Subtract 40 for padding (20px on each side) const containerWidth = container.clientWidth - 40; // naturalWidth = actual image width in pixels // Fallback to 1600 if image hasn't loaded yet const imgWidth = img.naturalWidth || 1600; // Calculate zoom percentage // Math.round removes decimal places for cleaner display currentZoom = Math.round((containerWidth / imgWidth) * 100); // Clamp to min/max bounds // This nested Math.max/min ensures: minZoom c.classList.remove('active')); if (card) card.classList.add('active'); document.getElementById('currentDiagramTitle').textContent = diagrams[id].title; document.getElementById('currentDiagram').src = diagrams[id].src; document.getElementById('downloadBtn').href = diagrams[id].src; resetZoom(); } } }); /** * ============================================================================ * CSS Explained (key styles from the block above) * ============================================================================ * * .diagram-svg-wrapper { * transform-origin: top left; // Scale from top-left corner * transition: transform 0.3s; // Smooth animation when zooming * } * * .diagram-container { * overflow: auto; // Enables scrollbars for panning * max-height: 80vh; // Limits height to 80% of viewport * } * * .diagram-viewer.fullscreen { * position: fixed; // Removes from document flow * top: 0; left: 0; // Positions at top-left of viewport * right: 0; bottom: 0; // Stretches to fill viewport * z-index: 9999; // Ensures it's above other content * } * * ============================================================================ */ AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"In Browser Use Ctrl+F to search for text Right-click → \"Open image in new tab\" for native zoom Browser zoom (Ctrl +/-) works on SVG Downloaded Open in VS Code for editing Use Inkscape for advanced modifications Import…"},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"document-intelligence-guide","sectionTitle":"Document Intelligence Guide","text":"This guide covers integration patterns and SDK configuration for Azure Document Intelligence through the APIM gateway. SDK Configuration Required When using Azure Document Intelligence SDKs through APIM, you must configure the SDK to use api-key instead of the default Ocp-Apim-Subscription-Key header.","excerpt":"This guide covers integration patterns and SDK configuration for Azure Document Intelligence through the APIM gateway. SDK Configuration Required When using Azure Document Intelligence SDKs through APIM, you must…"},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"api-key-header-configuration","sectionTitle":"API Key Header Configuration","text":"","excerpt":""},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"why-api-key","sectionTitle":"Why api-key ?","text":"APIM is used as a unified gateway for multiple Azure AI services (OpenAI, Document Intelligence, AI Search, Storage). Azure's API Management can only be configured with a single subscription key header name across all APIs. The platform uses api-key because: SDK Compatibility: OpenAI SDK and other AI service libraries expect api-key Industry Standard: api-key is a more widely recognized header name than APIM-specific headers Developer Experience: Reduces confusion by using a consistent, familiar header across all services Default Behavior vs Required Behavior: SDK Default Header APIM Expected Header Azure Document Intelligence SDK Ocp-Apim-Subscription-Key api-key Azure OpenAI SDK api-key api-key ✓","excerpt":"APIM is used as a unified gateway for multiple Azure AI services (OpenAI, Document Intelligence, AI Search, Storage). Azure's API Management can only be configured with a single subscription key header name across all…"},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"sdk-configuration-examples","sectionTitle":"SDK Configuration Examples","text":"","excerpt":""},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"javascripttypescript-azure-restai-document-intelligence","sectionTitle":"JavaScript/TypeScript ( @azure-rest/ai-document-intelligence )","text":"When using the @azure-rest/ai-document-intelligence npm package, configure the client to use api-key header: import DocumentIntelligence from \"@azure-rest/ai-document-intelligence\"; const endpoint = \"https://apim-gateway.azure-api.net/tenant/documentintelligence\"; const apiKey = \"your-apim-subscription-key\"; // Configure client with custom API key header name const client = DocumentIntelligence(endpoint, { key: apiKey }, { credentials: { apiKeyHeaderName: \"api-key\", // Override default \"Ocp-Apim-Subscription-Key\" }, }); // Use the client normally const result = await client.path(\"/documentModels/{modelId}:analyze\", \"prebuilt-read\") .post({ contentType: \"application/json\", body: { urlSource: \"https://example.com/document.pdf\" } }); Key Point The apiKeyHeaderName configuration tells the SDK to send the subscription key using the api-key header instead of the default Ocp-Apim-Subscription-Key .","excerpt":"When using the @azure-rest/ai-document-intelligence npm package, configure the client to use api-key header: import DocumentIntelligence from \"@azure-rest/ai-document-intelligence\"; const endpoint =…"},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"python-azure-ai-documentintelligence","sectionTitle":"Python ( azure-ai-documentintelligence )","text":"from azure.ai.documentintelligence import DocumentIntelligenceClient from azure.core.credentials import AzureKeyCredential from azure.core.pipeline.policies import HeadersPolicy endpoint = \"https://apim-gateway.azure-api.net/tenant/documentintelligence\" api_key = \"your-apim-subscription-key\" # Create custom headers policy to use api-key header headers_policy = HeadersPolicy() headers_policy.add_header(\"api-key\", api_key) # Create client with custom policy client = DocumentIntelligenceClient( endpoint=endpoint, credential=AzureKeyCredential(api_key), headers_policy=headers_policy ) # Alternatively, use custom header directly in requests # Note: Some SDK versions may require different configuration approaches Python SDK Note The Python SDK's approach to custom headers may vary by version. Check the SDK documentation for your specific version. Some versions may require setting headers differently or may not support custom API key header names. In such cases, use direct REST API calls with the requests library.","excerpt":"from azure.ai.documentintelligence import DocumentIntelligenceClient from azure.core.credentials import AzureKeyCredential from azure.core.pipeline.policies import HeadersPolicy endpoint =…"},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"net-azureaidocumentintelligence","sectionTitle":".NET ( Azure.AI.DocumentIntelligence )","text":"using Azure; using Azure.AI.DocumentIntelligence; using Azure.Core.Pipeline; string endpoint = \"https://apim-gateway.azure-api.net/tenant/documentintelligence\"; string apiKey = \"your-apim-subscription-key\"; // Create client options with custom header var options = new DocumentIntelligenceClientOptions(); options.AddPolicy(new AddHeaderPolicy(\"api-key\", apiKey), HttpPipelinePosition.PerCall); // Create client var client = new DocumentIntelligenceClient( new Uri(endpoint), new AzureKeyCredential(apiKey), options ); // Custom policy to add api-key header public class AddHeaderPolicy : HttpPipelineSynchronousPolicy { private readonly string _headerName; private readonly string _headerValue; public AddHeaderPolicy(string headerName, string headerValue) { _headerName = headerName; _headerValue = headerValue; } public override void OnSendingRequest(HttpMessage message) { message.Request.Headers.Add(_headerName, _headerValue); } }","excerpt":"using Azure; using Azure.AI.DocumentIntelligence; using Azure.Core.Pipeline; string endpoint = \"https://apim-gateway.azure-api.net/tenant/documentintelligence\"; string apiKey = \"your-apim-subscription-key\"; // Create…"},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"direct-rest-api-curl","sectionTitle":"Direct REST API (curl)","text":"If SDK configuration is complex or unavailable, use direct REST API calls: # Analyze document with prebuilt-read model curl -X POST \"https://apim-gateway.azure-api.net/tenant/documentintelligence/documentModels/prebuilt-read:analyze?api-version=2024-07-31-preview\" \\ -H \"api-key: your-apim-subscription-key\" \\ -H \"Content-Type: application/json\" \\ -d '{ \"urlSource\": \"https://example.com/document.pdf\" }' # Alternative: Use query parameter curl -X POST \"https://apim-gateway.azure-api.net/tenant/documentintelligence/documentModels/prebuilt-read:analyze?api-version=2024-07-31-preview&api-key=your-apim-subscription-key\" \\ -H \"Content-Type: application/json\" \\ -d '{ \"urlSource\": \"https://example.com/document.pdf\" }'","excerpt":"If SDK configuration is complex or unavailable, use direct REST API calls: # Analyze document with prebuilt-read model curl -X POST…"},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"async-operations-polling","sectionTitle":"Async Operations & Polling","text":"Document Intelligence async operations (document analysis, model training) return a 202 Accepted response with an Operation-Location header for status polling.","excerpt":"Document Intelligence async operations (document analysis, model training) return a 202 Accepted response with an Operation-Location header for status polling."},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"automatic-header-rewrite","sectionTitle":"Automatic Header Rewrite","text":"APIM automatically rewrites the Operation-Location header to point back through the APIM gateway instead of directly to the Document Intelligence backend. Example transformation: Backend returns: Operation-Location: https://tenant-docint.cognitiveservices.azure.com/documentintelligence/documentModels/prebuilt-read/analyzeResults/abc123 APIM rewrites to: Operation-Location: https://apim-gateway.azure-api.net/tenant/documentintelligence/documentModels/prebuilt-read/analyzeResults/abc123 Why this matters: SDKs automatically poll the Operation-Location URL Polling continues through APIM with consistent authentication No special SDK configuration needed for polling Works transparently with Document Intelligence SDK polling logic","excerpt":"APIM automatically rewrites the Operation-Location header to point back through the APIM gateway instead of directly to the Document Intelligence backend. Example transformation: Backend returns: Operation-Location:…"},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"troubleshooting","sectionTitle":"Troubleshooting","text":"Issue Cause Solution 401 Unauthorized SDK sending Ocp-Apim-Subscription-Key instead of api-key Configure SDK to use api-key header as shown in examples above 403 Forbidden Invalid or expired APIM subscription key Verify subscription key is valid in APIM portal Polling fails after initial request Operation-Location header not being rewritten (rare) Verify tenant API policy includes Operation-Location rewrite logic in <outbound> section SDK throws \"Invalid endpoint\" error Endpoint URL must include /tenant/documentintelligence path Use full APIM path: https://apim-gateway.azure-api.net/tenant/documentintelligence","excerpt":"Issue Cause Solution 401 Unauthorized SDK sending Ocp-Apim-Subscription-Key instead of api-key Configure SDK to use api-key header as shown in examples above 403 Forbidden Invalid or expired APIM subscription key Verify…"},{"page":"document-intelligence.html","pageTitle":"Document Intelligence Guide","sectionId":"additional-resources","sectionTitle":"Additional Resources","text":"Azure Document Intelligence Documentation @azure-rest/ai-document-intelligence npm package azure-ai-documentintelligence Python package Azure.AI.DocumentIntelligence NuGet package For APIM Technical Details See the APIM Policy README for information about Operation-Location header rewriting, subscription key normalization, and other APIM policy behaviors. AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"Azure Document Intelligence Documentation @azure-rest/ai-document-intelligence npm package azure-ai-documentintelligence Python package Azure.AI.DocumentIntelligence NuGet package For APIM Technical Details See the APIM…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"frequently-asked-questions","sectionTitle":"Frequently Asked Questions","text":"Common questions about the AI Services Hub Landing Zone, network architecture, and onboarding process. Questions still being researched or awaiting a decision are marked with Pending Network & Subscriptions Control vs Data Plane Onboarding & Access Technical Architecture Questions for Microsoft Pending Decisions","excerpt":"Common questions about the AI Services Hub Landing Zone, network architecture, and onboarding process. Questions still being researched or awaiting a decision are marked with Pending Network & Subscriptions Control vs…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"network-subscription-setup","sectionTitle":"Network & Subscription Setup","text":"","excerpt":""},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"what-network-sizes-were-allocated-for-the-ai-hub","sectionTitle":"What network sizes were allocated for the AI Hub?","text":"Answered Environment VNet Size Usable IPs da4cf6-prod 4x /24 (= /22) ~1,020 da4cf6-test 2x /24 (= /23) ~508 da4cf6-dev 1x /24 ~251 da4cf6-tools 1x /24 ~251 Confirmed by Platform Services Team on Dec 11, 2025","excerpt":"Answered Environment VNet Size Usable IPs da4cf6-prod 4x /24 (= /22) ~1,020 da4cf6-test 2x /24 (= /23) ~508 da4cf6-dev 1x /24 ~251 da4cf6-tools 1x /24 ~251 Confirmed by Platform Services Team on Dec 11, 2025"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"why-does-the-ai-hub-need-larger-vnets-than-standard-24","sectionTitle":"Why does the AI Hub need larger VNets than standard /24?","text":"Answered The AI Hub will run multiple Azure services that each require significant IP allocation: Service Min Size Recommended API Management (APIM) /26 /24 App Gateway /26 /24 AI Foundry /25 /24 PrivateLink Subnet /27 /27 AKS Variable Variable Total: This exceeds the standard /24 (256 IPs), requiring at least a /22 for production.","excerpt":"Answered The AI Hub will run multiple Azure services that each require significant IP allocation: Service Min Size Recommended API Management (APIM) /26 /24 App Gateway /26 /24 AI Foundry /25 /24 PrivateLink Subnet /27…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"control-plane-vs-data-plane","sectionTitle":"Control Plane vs Data Plane","text":"","excerpt":""},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"whats-the-difference-between-control-plane-and-data-plane","sectionTitle":"What's the difference between control plane and data plane?","text":"Answered Azure has two distinct access paths: Aspect Control Plane Data Plane What Managing resources (create, configure, delete) Accessing data inside resources Endpoint management.azure.com *.vault.azure.net , *.blob.core.windows.net OIDC Works? Yes - always No - blocked by private endpoints Examples Create Key Vault, assign RBAC roles Read secrets, write blobs, query databases See ADR-011 and Control vs Data Plane Diagram for details.","excerpt":"Answered Azure has two distinct access paths: Aspect Control Plane Data Plane What Managing resources (create, configure, delete) Accessing data inside resources Endpoint management.azure.com *.vault.azure.net ,…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"why-cant-i-see-key-vault-secrets-in-the-azure-portal","sectionTitle":"Why can't I see Key Vault secrets in the Azure Portal?","text":"Answered The Azure Portal is a control plane UI . When you browse to a Key Vault: &#10003; You can see the vault exists (control plane: list resources) &#10003; You can see its configuration (control plane: read properties) &#10007; You CANNOT click \"Show Secret Value\" (data plane: blocked by private endpoint) To view secrets, use Chisel tunnel or connect through the Jumpbox via Bastion .","excerpt":"Answered The Azure Portal is a control plane UI . When you browse to a Key Vault: &#10003; You can see the vault exists (control plane: list resources) &#10003; You can see its configuration (control plane: read…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"do-tenant-developers-get-chisel-access","sectionTitle":"Do tenant developers get Chisel access?","text":"Answered No. Chisel is for platform maintainers only . Tenant/project developers access AI services through the designed public entry points: App Gateway + APIM : Public-facing API endpoints Their own applications : Which call APIM endpoints This separation ensures proper isolation and metering. Tenants don't need (or get) direct access to private endpoints.","excerpt":"Answered No. Chisel is for platform maintainers only . Tenant/project developers access AI services through the designed public entry points: App Gateway + APIM : Public-facing API endpoints Their own applications :…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"which-access-method-should-i-use","sectionTitle":"Which access method should I use?","text":"Answered If you need... Use this CI/CD with data plane (secrets, state) Chisel tunnel ( enable_azure_proxy ) Admin access, debugging, CLI tools as platform admin Chisel tunnel ( enable_azure_proxy ) Local dev access to private databases or Azure services Chisel tunnel ( enable_azure_proxy ) Resource-only deployments Public GitHub runners (default) See Choosing Your Access Method and Access Methods Diagram .","excerpt":"Answered If you need... Use this CI/CD with data plane (secrets, state) Chisel tunnel ( enable_azure_proxy ) Admin access, debugging, CLI tools as platform admin Chisel tunnel ( enable_azure_proxy ) Local dev access to…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"onboarding-access","sectionTitle":"Onboarding & Access","text":"","excerpt":""},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"how-do-other-teams-onboard-to-the-ai-hub","sectionTitle":"How do other teams onboard to the AI Hub?","text":"Pending The onboarding process for other BC Gov teams to use the AI Hub is being developed. Open Questions: What's the intake process for new teams? What prerequisites must teams meet? How are resources allocated per team? What's the cost model (chargeback)?","excerpt":"Pending The onboarding process for other BC Gov teams to use the AI Hub is being developed. Open Questions: What's the intake process for new teams? What prerequisites must teams meet? How are resources allocated per…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"whats-the-3-6-9-month-roadmap","sectionTitle":"What's the 3-6-9 month roadmap?","text":"Pending A planning/whiteboarding session was proposed with the following agenda: Roles Overview Technical capabilities - first 3 months to showcase value Services onboarding enablers 3-6-9 months baseline roadmap/milestones WBS tracker (Azure DevOps/GitHub) Regular cadences Status: Planning session with Microsoft to be scheduled. Date TBD.","excerpt":"Pending A planning/whiteboarding session was proposed with the following agenda: Roles Overview Technical capabilities - first 3 months to showcase value Services onboarding enablers 3-6-9 months baseline…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"technical-architecture","sectionTitle":"Technical Architecture","text":"","excerpt":""},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"why-cant-github-actions-run-terraform-directly","sectionTitle":"Why can't GitHub Actions run Terraform directly?","text":"Answered See ADR-001: Shared Landing Zone for the full explanation. Short answer: GitHub-hosted runners cannot reach private endpoints directly. The platform solves this with a Chisel SOCKS5 tunnel : an Azure App Service running Chisel inside the VNet acts as a proxy, routing Terraform’s private-endpoint traffic from the public runner through the VNet. An optional github_runners_aca module for persistent self-hosted runners is available but not used by this platform’s own CI/CD. Cost note: The Chisel proxy runs as an App Service (billed by plan tier), which scales independently of workflow run frequency. See Cost Tracking for details.","excerpt":"Answered See ADR-001: Shared Landing Zone for the full explanation. Short answer: GitHub-hosted runners cannot reach private endpoints directly. The platform solves this with a Chisel SOCKS5 tunnel : an Azure App Service…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"what-azure-services-will-the-ai-hub-provide","sectionTitle":"What Azure services will the AI Hub provide?","text":"Answered The AI Hub provides shared AI services for BC Gov teams through a fully automated, multi-tenant platform. The following services are live in dev and test : Azure AI Foundry — GPT-4.1, GPT-4o, GPT-5 chat models; o1/o3-mini/o4-mini reasoning models; text-embedding models API Management (APIM) — Per-tenant subscription keys, rate limiting ( x-ms-tenant header routing), and TPM quota metering App Gateway + WAF — Public ingress with TLS termination and cognitive service routing (Document Intelligence OCR, Language PII) Language Service (PII detection) — ML-based PII detection via APIM, available to all tenants Azure AI Search, Speech, Document Intelligence — Shared cognitive services routed via App Gateway See the AI Services Catalogue for the full model list, TPM quotas, and per-tenant allocation details.","excerpt":"Answered The AI Hub provides shared AI services for BC Gov teams through a fully automated, multi-tenant platform. The following services are live in dev and test : Azure AI Foundry — GPT-4.1, GPT-4o, GPT-5 chat models;…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"how-does-vnet-peering-work-between-environments","sectionTitle":"How does VNet peering work between environments?","text":"Answered AI Hub uses VNet peering for CI/CD. tools-> dev, test, prod Outbound traffic from tools is allowed to dev, test, prod for CI/CD purposes.","excerpt":"Answered AI Hub uses VNet peering for CI/CD. tools-> dev, test, prod Outbound traffic from tools is allowed to dev, test, prod for CI/CD purposes."},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"questions-for-microsoft","sectionTitle":"Questions for Microsoft","text":"Post kick-off questions for Microsoft regarding Azure AI Application Zone (Dec 2025) Click any question to expand details","excerpt":"Post kick-off questions for Microsoft regarding Azure AI Application Zone (Dec 2025) Click any question to expand details"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"access-security","sectionTitle":"Access & Security","text":"1. User access model for AI Foundry Pending How will end users (data scientists, developers) access AI Foundry? What's the authentication/authorization model? Questions: Direct portal access vs API-only? IDIR integration? Guest access for contractors? 2. RBAC model Pending What RBAC roles are needed for different user personas (platform admins, team leads, developers, data scientists)? Personas to define: Platform Admin - full control Team Lead - manage team resources Developer - deploy models, run experiments Data Scientist - read-only model access Auditor - view logs and compliance 3. Governance automation Pending How can we automate governance policies (data classification, model approval, prompt logging)? Areas needing automation: Data classification enforcement Model deployment approval workflows Prompt/response logging for audit PII detection and masking","excerpt":"1. User access model for AI Foundry Pending How will end users (data scientists, developers) access AI Foundry? What's the authentication/authorization model? Questions: Direct portal access vs API-only? IDIR…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"infrastructure-cost","sectionTitle":"Infrastructure & Cost","text":"4. Cost-effective IaC deployment without Bastion+VM Answered Resolved: The platform uses standard GitHub-hosted runners ( ubuntu-24.04 ) for all CI/CD, including Terraform operations that touch private endpoints. No persistent Bastion or Jumpbox is needed for automated deployments. The mechanism is a Docker-based Chisel SOCKS tunnel + Privoxy running directly on the GitHub-hosted runner: A Chisel server ( azure-proxy/chisel container) is first deployed into the tools VNet via .deployer.yml The Terraform deployer job starts a Chisel client container + Privoxy on the runner, creating an encrypted SOCKS tunnel into the VNet at localhost:8118 Terraform sets HTTP_PROXY / HTTPS_PROXY to route data-plane traffic (Key Vault, private state) through the tunnel; Azure control-plane endpoints bypass it via NO_PROXY Bastion + Jumpbox remains available for interactive admin sessions (portal access, CLI debugging) but is not needed in CI/CD pipelines, and is auto-destroyed nightly by schedule.yml . An optional github_runners_aca module (Container Apps self-hosted runners in the VNet) is also available for workloads in other repos that can't use the Chisel proxy approach. 5. GitHub self-hosted runners vs Azure DevOps Answered — GitHub (public runners + Chisel tunnel) Decision: GitHub Actions was chosen over Azure DevOps. CI/CD jobs run on standard GitHub-hosted runners ( ubuntu-24.04 ), not self-hosted runners inside the VNet. Private-endpoint access is handled by the Chisel SOCKS tunnel approach: a proxy server in the tools VNet tunnels data-plane traffic for Terraform runners on demand. This avoids the ongoing cost and management overhead of persistent self-hosted agents (GitHub or Azure DevOps). The optional github_runners_aca module provisions Container Apps-based self-hosted runners when a workload genuinely needs persistent VNet-internal compute. These scale to zero when idle. See Cost Tracking: CI/CD Runner Costs for a detailed cost breakdown of the optional self-hosted runner module. 6. Shared vs dedicated resources per team Pending Which resources should be shared across teams (APIM, AI models) vs dedicated per team (compute, storage)? Proposed split: Shared Dedicated APIM gateway Compute quotas AI model deployments Storage accounts Networking (VNet, NSG) Key Vault Monitoring infrastructure Resource groups 7. Cost allocation and chargeback Pending How do we track and allocate costs to individual teams/projects using shared AI services? Mechanisms needed: Tagging strategy for cost attribution APIM subscription-based metering Monthly cost reports per team Budget alerts 8. Telemetry and tagging strategy Pending What tagging conventions and telemetry should be implemented for cost tracking and observability? Required tags: cost-center - ministry/team billing code project - project identifier environment - dev/test/prod owner - responsible team data-classification - public/protected/confidential 9. Noisy neighbor mitigation Pending How do we prevent one team's workload from impacting others in a shared environment (rate limiting, quotas)? Mitigation strategies: APIM rate limiting per subscription Resource quotas per resource group Kubernetes resource limits/requests AI model TPM (tokens per minute) limits","excerpt":"4. Cost-effective IaC deployment without Bastion+VM Answered Resolved: The platform uses standard GitHub-hosted runners ( ubuntu-24.04 ) for all CI/CD, including Terraform operations that touch private endpoints. No…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"onboarding-operations","sectionTitle":"Onboarding & Operations","text":"10. Project namespace concept Pending How should we isolate team workloads? Resource groups per team? Subscriptions? Kubernetes namespaces? Options: Resource Groups: Simple but limited isolation Subscriptions: Strong isolation but management overhead K8s Namespaces: Good for container workloads Hybrid: Shared subscription + RG per team + K8s namespaces 11. Non-Foundry services governance Pending How do we govern teams that want to deploy their own AI services (Ollama, vLLM) outside of AI Foundry? Considerations: Security review process for custom deployments Approved container images list Network isolation requirements Logging/monitoring requirements 12. Onboarding journey Pending What's the end-to-end flow for a new team to request access, get approved, and start using AI services? Proposed flow: Intake form submission Security/privacy assessment Resource allocation approval Technical onboarding session Sandbox environment provisioning Production access (after validation) 13. Runbooks and playbooks Answered The Playbooks page documents operational runbooks for Day 2 operations, including: Chisel tunnel setup for private endpoint access Bastion + Jumpbox access APIM key rotation Chisel tunnel setup and proxy operations Additional runbooks (incident response, disaster recovery, cost spike investigation) are in progress. 14. SDPR OCR scope Answered Document Intelligence (OCR) for SDPR is handled at the App Gateway layer . SDPR's applications call the App Gateway endpoint, which routes requests to the shared Document Intelligence cognitive service — no tenant-specific configuration required. The integration is operational. SDPR is one of three active tenants ( wlrs , sdpr , nr-dap ) in the test environment.","excerpt":"10. Project namespace concept Pending How should we isolate team workloads? Resource groups per team? Subscriptions? Kubernetes namespaces? Options: Resource Groups: Simple but limited isolation Subscriptions: Strong…"},{"page":"faq.html","pageTitle":"Frequently Asked Questions","sectionId":"pending-decisions","sectionTitle":"Pending Decisions","text":"📝 Items requiring team discussion or decisions: # Question Owner Status 1 Team onboarding process documentation Product Management In Progress 2 3-6-9 month roadmap Microsoft In Progress 3 Cost model / chargeback for AI services Executive Sponsor Not Started 4 Chisel tunnel proxy setup in VNet Platform Team Done 5 AI model governance policy TBD Not Started AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"📝 Items requiring team discussion or decisions: # Question Owner Status 1 Team onboarding process documentation Product Management In Progress 2 3-6-9 month roadmap Microsoft In Progress 3 Cost model / chargeback for AI…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"ai-services-hub","sectionTitle":"AI Services Hub","text":"Shared, secure AI services for BC Government teams — compliant by design. Private endpoints, zero secrets, full infrastructure as code. Get Started ↓ View Architecture","excerpt":"Shared, secure AI services for BC Government teams — compliant by design. Private endpoints, zero secrets, full infrastructure as code. Get Started ↓ View Architecture"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"pilot-project-disclaimer","sectionTitle":"Pilot Project Disclaimer","text":"This is an early-stage pilot. Many architectural patterns are still being validated with Platform Services. This project consolidates hard-learned lessons from navigating Azure policy into a shared landing zone to help other BC Gov teams avoid the same pitfalls. The upstream Azure AI Landing Zones reference architecture carries an archival risk, of which this project team is aware.","excerpt":"This is an early-stage pilot. Many architectural patterns are still being validated with Platform Services. This project consolidates hard-learned lessons from navigating Azure policy into a shared landing zone to help…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"where-do-you-want-to-start","sectionTitle":"Where Do You Want to Start?","text":"","excerpt":""},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"im-a-tenant","sectionTitle":"I'm a Tenant","text":"My team wants to use AI services (OpenAI, Document Intelligence, PII detection, Speech) through the hub. See Available Services →","excerpt":"My team wants to use AI services (OpenAI, Document Intelligence, PII detection, Speech) through the hub. See Available Services →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"im-a-platform-admin","sectionTitle":"I'm a Platform Admin","text":"I maintain the hub infrastructure — deploying, operating, and troubleshooting the landing zone. Go to Playbooks →","excerpt":"I maintain the hub infrastructure — deploying, operating, and troubleshooting the landing zone. Go to Playbooks →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"im-exploring","sectionTitle":"I'm Exploring","text":"I want to understand the architecture and evaluate whether this platform fits my needs. View Architecture →","excerpt":"I want to understand the architecture and evaluate whether this platform fits my needs. View Architecture →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"project-scope-enabling-ai-on-azure","sectionTitle":"Project Scope: Enabling AI on Azure","text":"","excerpt":""},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"this-is-an-ai-platform-not-a-general-azure-onboarding-tool","sectionTitle":"This is an AI Platform, Not a General Azure Onboarding Tool","text":"The primary mission of this project is to create a secure, compliant, and reusable \"paved road\" for AI-specific workloads in the BC Government. It is not intended for general-purpose application hosting. Our scope is defined by what can be provisioned and managed via Infrastructure as Code. We exclusively support services that have a mature Azure Verified Module (AVM) for Terraform. This ensures every component of the platform is repeatable, auditable, and aligned with industry best practices.","excerpt":"The primary mission of this project is to create a secure, compliant, and reusable \"paved road\" for AI-specific workloads in the BC Government. It is not intended for general-purpose application hosting. Our scope is…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"the-challenge-microsofts-model-vs-bc-govs-reality","sectionTitle":"The Challenge: Microsoft's Model vs. BC Gov's Reality","text":"A newcomer to this project might ask: \"Why is this so complex? Why not just follow Microsoft's tutorials?\" This project exists to answer that question. There is a fundamental disconnect between Microsoft's standard approach and the strict policy requirements of the BC Government.","excerpt":"A newcomer to this project might ask: \"Why is this so complex? Why not just follow Microsoft's tutorials?\" This project exists to answer that question. There is a fundamental disconnect between Microsoft's standard…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"microsofts-assumption-ui-first-public-friendly","sectionTitle":"Microsoft's Assumption: UI-First, Public-Friendly","text":"Microsoft's documentation and tools (like Azure Portal and AI Studio) are designed for a user-friendly, web-based experience. This model assumes that Azure services have public endpoints so the browser-based UIs can connect to them.","excerpt":"Microsoft's documentation and tools (like Azure Portal and AI Studio) are designed for a user-friendly, web-based experience. This model assumes that Azure services have public endpoints so the browser-based UIs can…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"bc-govs-reality-private-only-zero-trust","sectionTitle":"BC Gov's Reality: Private-Only, Zero-Trust","text":"BC Government security policy mandates a \"zero-trust\" network model. Critically, this means **no public endpoints** on any Azure PaaS services. All access must be from within a private, controlled network. 💡 This is the core problem. The \"no public endpoints\" policy makes the standard, UI-driven Microsoft workflow non-functional. This project implements the architecture required to operate securely within this constraint. For a full breakdown, see Microsoft vs BC Gov Comparison and ADR-008 .","excerpt":"BC Government security policy mandates a \"zero-trust\" network model. Critically, this means **no public endpoints** on any Azure PaaS services. All access must be from within a private, controlled network. 💡 This is the…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"our-solution-an-api-first-secure-landing-zone","sectionTitle":"Our Solution: An API-First, Secure Landing Zone","text":"This repository provides a standardized, secure-by-default environment that solves the challenges above. Instead of a UI-driven model, we provide an API-first, Infrastructure-as-Code (IaC) model . 1. Secure Private Network A shared VNet isolates all resources. A Bastion Host and Jumpbox VM provide secure administrative access. Public GitHub Actions runners reach private endpoints via the Chisel tunnel through the Azure Proxy App Service. See ADR-001: Shared Landing Zone and CI/CD Runner Costs 2. Passwordless OIDC Auth We eliminate long-lived secrets by using OpenID Connect (OIDC) . GitHub Actions receives temporary, auto-expiring tokens from Azure for each deployment, dramatically improving security. See ADR-002: OIDC Authentication 3. Reusable IaC Modules We use Microsoft's official Azure Verified Modules (AVM) to define infrastructure. This provides a library of tested, maintained, and reusable components for anyone to consume. See ADR-009: Why AVMs","excerpt":"This repository provides a standardized, secure-by-default environment that solves the challenges above. Instead of a UI-driven model, we provide an API-first, Infrastructure-as-Code (IaC) model . 1. Secure Private…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"flexible-access-methods","sectionTitle":"Flexible Access Methods","text":"Private endpoints block data plane access from the public internet. We provide four interchangeable access methods - enable only what you need.","excerpt":"Private endpoints block data plane access from the public internet. We provide four interchangeable access methods - enable only what you need."},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"control-plane-always-works","sectionTitle":"Control Plane (Always Works)","text":"Creating/configuring resources via ARM API ( management.azure.com ). OIDC authentication works from anywhere. Examples: Create Key Vault, deploy VMs, assign RBAC roles","excerpt":"Creating/configuring resources via ARM API ( management.azure.com ). OIDC authentication works from anywhere. Examples: Create Key Vault, deploy VMs, assign RBAC roles"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"data-plane-requires-vnet-access","sectionTitle":"Data Plane (Requires VNet Access)","text":"Accessing data inside resources (blocked by private endpoints). Needs network path into VNet. Examples: Read Key Vault secrets, write Storage blobs, query databases GitHub Runners Control plane only Self-Hosted Full access (in VNet) Bastion + Jumpbox Admin access Chisel Tunnel Local dev access ADR-011: Control vs Data Plane | Choose Your Method | Architecture Diagram","excerpt":"Accessing data inside resources (blocked by private endpoints). Needs network path into VNet. Examples: Read Key Vault secrets, write Storage blobs, query databases GitHub Runners Control plane only Self-Hosted Full…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"what-can-you-run-here","sectionTitle":"What Can You Run Here?","text":"This landing zone is optimized for modern AI/ML workloads that require secure compute and private data access. Azure AI Foundry Access many models (OpenAI, Meta, Mistral) and cognitive services through a unified, secure platform. Open Source Models Host private weights (Llama 3, Mistral) on secure VMs using Ollama or vLLM. RAG & Data Apps Vector databases and Streamlit/Gradio apps for rapid internal prototyping.","excerpt":"This landing zone is optimized for modern AI/ML workloads that require secure compute and private data access. Azure AI Foundry Access many models (OpenAI, Meta, Mistral) and cognitive services through a unified, secure…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"i-want-to","sectionTitle":"I want to...","text":"Set up Authentication Configure OIDC trust between GitHub and Azure. Deploy Infrastructure Deploy VNet, Bastion, and Jumpbox modules. Fix a Problem Troubleshoot state locks, auth failures, or rollbacks.","excerpt":"Set up Authentication Configure OIDC trust between GitHub and Azure. Deploy Infrastructure Deploy VNet, Bastion, and Jumpbox modules. Fix a Problem Troubleshoot state locks, auth failures, or rollbacks."},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"network-allocation-license-plate-da4cf6","sectionTitle":"Network Allocation (License Plate: da4cf6)","text":"Confirmed Dec 11, 2025 - Platform Services Team 4x /24 Prod (= /22) 2x /24 Test (= /23) 1x /24 Dev 1x /24 Tools See FAQ for pending questions about Canada East non-routable ranges.","excerpt":"Confirmed Dec 11, 2025 - Platform Services Team 4x /24 Prod (= /22) 2x /24 Test (= /23) 1x /24 Dev 1x /24 Tools See FAQ for pending questions about Canada East non-routable ranges."},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"documentation-library","sectionTitle":"Documentation Library","text":"","excerpt":""},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"adrs","sectionTitle":"ADRs","text":"Architecture decisions and why things are built this way. Start Here →","excerpt":"Architecture decisions and why things are built this way. Start Here →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"faq","sectionTitle":"FAQ","text":"Common questions, pending decisions, and contact info. View FAQ →","excerpt":"Common questions, pending decisions, and contact info. View FAQ →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"oidc-setup","sectionTitle":"OIDC Setup","text":"Complete guide to passwordless authentication setup. View Guide →","excerpt":"Complete guide to passwordless authentication setup. View Guide →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"tf-reference","sectionTitle":"TF Reference","text":"Auto-generated variable & output docs for all modules. View Reference →","excerpt":"Auto-generated variable & output docs for all modules. View Reference →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"workflows","sectionTitle":"Workflows","text":"CI/CD pipeline automation details. View Workflows →","excerpt":"CI/CD pipeline automation details. View Workflows →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"diagrams","sectionTitle":"Diagrams","text":"Interactive architecture and flow visualizations. View Diagrams →","excerpt":"Interactive architecture and flow visualizations. View Diagrams →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"playbooks","sectionTitle":"Playbooks","text":"Operational runbooks for Day 2 maintenance. View Playbooks →","excerpt":"Operational runbooks for Day 2 maintenance. View Playbooks →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"tf-reference-1","sectionTitle":"TF Reference","text":"Auto-generated variable and output docs. View Reference →","excerpt":"Auto-generated variable and output docs. View Reference →"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"quick-start","sectionTitle":"Quick Start","text":"","excerpt":""},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"get-started-in-3-steps","sectionTitle":"Get Started in 3 Steps","text":"1 Run Setup Script Configure OIDC trust between GitHub and Azure (once per environment) 2 Add Workflow Copy the deploy.yml workflow and backend.tf to your repo 3 Push & Deploy Push to main and watch Terraform deploy automatically","excerpt":"1 Run Setup Script Configure OIDC trust between GitHub and Azure (once per environment) 2 Add Workflow Copy the deploy.yml workflow and backend.tf to your repo 3 Push & Deploy Push to main and watch Terraform deploy…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"step-1-initial-setup","sectionTitle":"Step 1: Initial Setup","text":"Run this one-time command to create the Azure identity and trust relationship: ./initial-setup/initial-azure-setup.sh \\ -g \"YOUR-RESOURCE-GROUP\" \\ -n \"your-app-identity\" \\ -r \"bcgov/your-repo\" \\ -e \"dev\" \\ --create-storage --create-github-secrets","excerpt":"Run this one-time command to create the Azure identity and trust relationship: ./initial-setup/initial-azure-setup.sh \\ -g \"YOUR-RESOURCE-GROUP\" \\ -n \"your-app-identity\" \\ -r \"bcgov/your-repo\" \\ -e \"dev\" \\…"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"key-features","sectionTitle":"Key Features","text":"","excerpt":""},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"secure-by-default","sectionTitle":"Secure by Default","text":"OIDC federated credentials No stored secrets Environment isolation Least privilege access","excerpt":"OIDC federated credentials No stored secrets Environment isolation Least privilege access"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"azure-native","sectionTitle":"Azure Native","text":"Managed identities Azure Bastion access Blob storage for state NSG security rules","excerpt":"Managed identities Azure Bastion access Blob storage for state NSG security rules"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"automated","sectionTitle":"Automated","text":"GitOps workflow Auto VM shutdown Scheduled cleanup On-demand resources","excerpt":"GitOps workflow Auto VM shutdown Scheduled cleanup On-demand resources"},{"page":"index.html","pageTitle":"AI Services Hub","sectionId":"contributing","sectionTitle":"Contributing","text":"All changes follow the project's Developer SDLC — branch, PR, merge to main, promote to prod. This documentation is built automatically from the docs/ folder. To add or update pages: Create a feature branch and edit files in docs/_pages/ Run ./docs/build.sh to test locally Open a PR — lint checks and Terraform plan run automatically Merge to main — GitHub Actions deploys to GitHub Pages automatically See Workflows for the full SDLC flow, branching patterns (stacked PRs, release PRs), and release process. AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"All changes follow the project's Developer SDLC — branch, PR, merge to main, promote to prod. This documentation is built automatically from the docs/ folder. To add or update pages: Create a feature branch and edit…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"language-service-pii-detection","sectionTitle":"Language Service PII Detection","text":"This system supports tenant-controlled PII anonymization by calling Azure AI Language Service (Text Analytics) from Azure API Management (APIM) policies. The goal is to mask sensitive data before it is forwarded to downstream backends such as OpenAI. Enterprise-grade PII Protection Azure AI Language Service provides ML-based entity recognition that enables accurate detection and redaction of sensitive information including names, addresses, financial data, and medical terms.","excerpt":"This system supports tenant-controlled PII anonymization by calling Azure AI Language Service (Text Analytics) from Azure API Management (APIM) policies. The goal is to mask sensitive data before it is forwarded to…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"overview","sectionTitle":"Overview","text":"The system uses Azure AI Language Service PII entity recognition to identify and redact sensitive information in requests. This ML-based approach provides broad entity coverage, context-aware detection, and machine learning accuracy for enterprise-grade PII protection.","excerpt":"The system uses Azure AI Language Service PII entity recognition to identify and redact sensitive information in requests. This ML-based approach provides broad entity coverage, context-aware detection, and machine…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"supported-entity-types","sectionTitle":"Supported Entity Types","text":"Azure AI Language Service can detect and redact a wide range of PII entity types: Personal Identifiers: Names, email addresses, phone numbers Financial Data: Credit card numbers, bank account numbers Government IDs: Social Security Numbers, passport numbers, driver's license numbers Location Data: Physical addresses, GPS coordinates Medical Information: Medical record numbers, health insurance information","excerpt":"Azure AI Language Service can detect and redact a wide range of PII entity types: Personal Identifiers: Names, email addresses, phone numbers Financial Data: Credit card numbers, bank account numbers Government IDs:…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"architecture","sectionTitle":"Architecture","text":"Requests enter APIM, tenant API policies decide whether to apply PII anonymization, and when enabled, APIM calls the shared Language Service endpoint using managed identity. The Language Service endpoint is provided to APIM policies via an APIM Named Value: piiServiceUrl .","excerpt":"Requests enter APIM, tenant API policies decide whether to apply PII anonymization, and when enabled, APIM calls the shared Language Service endpoint using managed identity. The Language Service endpoint is provided to…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"request-flow","sectionTitle":"Request Flow","text":"Client request arrives at APIM with sensitive content Tenant API policy extracts request body content PII anonymization fragment calls Language Service via managed identity Language Service analyzes and redacts PII entities APIM replaces request body with redacted content Request forwards to backend (OpenAI, Document Intelligence, etc.)","excerpt":"Client request arrives at APIM with sensitive content Tenant API policy extracts request body content PII anonymization fragment calls Language Service via managed identity Language Service analyzes and redacts PII…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"how-it-works","sectionTitle":"How It Works","text":"A tenant request arrives at APIM. The tenant API policy (generated from api_policy.xml.tftpl ) routes the request to the correct backend based on path (for example openai , documentintelligence , ai-search , storage ). For OpenAI requests, when PII redaction is enabled, the policy extracts the request body as text and sets it to piiInputContent . The tenant policy sets configuration variables from the tenant's apim_policies.pii_redaction settings: piiExcludedCategories - Categories to exclude from detection piiDetectionLanguage - Language code for detection accuracy piiPreserveJsonStructure - Whether to restore structural JSON values piiStructuralWhitelist - Additional values to preserve The policy includes the pii-anonymization policy fragment, which uses these configuration variables. The fragment: Obtains an AAD token via <authentication-managed-identity> for https://cognitiveservices.azure.com . Calls Language Service /language/:analyze-text?api-version=2025-11-15-preview with request kind PiiEntityRecognition . Uses a CharacterMask redaction policy (mask character # ). Extracts results.documents[0].redactedText into piiAnonymizedContent . Emits diagnostics including status code, entity count, entity types, and whether content changed. The tenant policy explicitly applies the anonymized content back to the request body using <set-body> and forwards the request. Example Redaction Input: \"My email is alice@example.com and my SSN is 123-45-6789\" Output: \"My email is ##################### and my SSN is ###########\"","excerpt":"A tenant request arrives at APIM. The tenant API policy (generated from api_policy.xml.tftpl ) routes the request to the correct backend based on path (for example openai , documentintelligence , ai-search , storage ).…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"configuration-guide","sectionTitle":"Configuration Guide","text":"","excerpt":""},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"shared-configuration-all-environments","sectionTitle":"Shared Configuration (All Environments)","text":"PII detection depends on the shared Language Service being enabled via shared_config.language_service.enabled and integrated into APIM via piiServiceUrl . Language Service is configured for private access (no public network access) and is connected through a private endpoint.","excerpt":"PII detection depends on the shared Language Service being enabled via shared_config.language_service.enabled and integrated into APIM via piiServiceUrl . Language Service is configured for private access (no public…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"per-tenant-configuration","sectionTitle":"Per-Tenant Configuration","text":"PII anonymization is controlled per tenant via APIM policy settings ( apim_policies.pii_redaction.enabled ). The tenant API policy generation includes PII only when tenant PII redaction is enabled and the shared Language Service is enabled. # Example tenant policy flags apim_policies { pii_redaction { enabled = true # Optional: Fail-closed mode (default: false) # When true: blocks requests with 503 if Language Service fails # When false: passes through unredacted content on failure (fail-open) fail_closed = false # Optional: Exclude specific PII categories from detection excluded_categories = [\"PhoneNumber\", \"Address\"] # Optional: Language for detection (default: \"en\") detection_language = \"en\" # Optional: Preserve JSON structure (default: true) preserve_json_structure = true # Optional: Additional values to preserve (whitelist) structural_whitelist = [\"customRole\", \"metadata\"] } rate_limiting { enabled = true tokens_per_minute = 10000 } usage_logging { enabled = true } streaming_metrics { enabled = true } tracking_dimensions { enabled = true } } PII Redaction Configuration Options Option Type Default Description enabled boolean false Enable or disable PII redaction for this tenant fail_closed boolean false Controls failure behavior when Language Service is unavailable. When true , blocks requests with HTTP 503 error if PII service fails (fail-closed mode). When false (default), allows requests through with unredacted content on failure (fail-open mode). See FAQ below for details on choosing between modes. excluded_categories list(string) [] PII categories to exclude from detection (e.g., [\"PhoneNumber\", \"Address\"]). See Microsoft Learn for available categories. detection_language string \"en\" Language code for PII detection. Controls detection accuracy for language-specific entities. preserve_json_structure boolean true Restore structural JSON values after redaction to prevent breaking JSON structure (e.g., \"user\", \"system\", \"assistant\" roles in OpenAI messages) structural_whitelist list(string) [] Additional quoted string values to preserve beyond default whitelist (OpenAI roles). Use for custom structural fields that shouldn't be redacted.","excerpt":"PII anonymization is controlled per tenant via APIM policy settings ( apim_policies.pii_redaction.enabled ). The tenant API policy generation includes PII only when tenant PII redaction is enabled and the shared Language…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"flexible-tenant-control","sectionTitle":"Flexible Tenant Control","text":"Each tenant can independently enable or disable PII redaction based on their specific requirements. This allows for granular control over data privacy settings while sharing the same infrastructure.","excerpt":"Each tenant can independently enable or disable PII redaction based on their specific requirements. This allows for granular control over data privacy settings while sharing the same infrastructure."},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"security-model","sectionTitle":"Security Model","text":"","excerpt":""},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"managed-identity-authentication","sectionTitle":"Managed Identity Authentication","text":"Language Service uses managed identity only ( local_auth_enabled = false ) rather than API keys. This eliminates the need for credential rotation and follows Azure security best practices.","excerpt":"Language Service uses managed identity only ( local_auth_enabled = false ) rather than API keys. This eliminates the need for credential rotation and follows Azure security best practices."},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"private-network-access","sectionTitle":"Private Network Access","text":"Language Service network ACLs default to deny and it is accessed via a private endpoint. APIM is granted access via RBAC ( Cognitive Services User role). APIM policy calls use AAD tokens (Authorization Bearer) and remove any api-key header before calling Cognitive Services APIs.","excerpt":"Language Service network ACLs default to deny and it is accessed via a private endpoint. APIM is granted access via RBAC ( Cognitive Services User role). APIM policy calls use AAD tokens (Authorization Bearer) and remove…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"observability","sectionTitle":"Observability","text":"","excerpt":""},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"pii-detection-diagnostics","sectionTitle":"PII Detection Diagnostics","text":"The pii-anonymization fragment emits rich diagnostic traces to Application Insights, including: pii-status-code: HTTP response status from Language Service API call pii-entity-count: Number of PII entities detected in the request pii-entity-types: Comma-separated list of entity categories found (e.g., \"Email,SSN,CreditCard\") pii-content-changed: Boolean flag indicating whether any redaction occurred request-id: Correlation ID for tracing the request across services tenant-id: Tenant identifier for per-tenant analytics These diagnostics enable monitoring of PII detection effectiveness, understanding which entity types are most commonly detected, and tracking Language Service API health.","excerpt":"The pii-anonymization fragment emits rich diagnostic traces to Application Insights, including: pii-status-code: HTTP response status from Language Service API call pii-entity-count: Number of PII entities detected in…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"openai-usage-logging","sectionTitle":"OpenAI Usage Logging","text":"For OpenAI requests, the tenant policy template sets routing metadata variables before including the openai-usage-logging fragment: backendId: APIM backend identifier (e.g., tenant-openai ) routeLocation: Azure region for the backend (single-backend for now) routeName: Route identifier for future intelligent routing deploymentName: Extracted from the URL path (e.g., gpt-4 ) These dimensions are logged to Application Insights along with token usage data, enabling detailed cost allocation, chargeback analytics, and deployment-level monitoring even in the current single-backend setup.","excerpt":"For OpenAI requests, the tenant policy template sets routing metadata variables before including the openai-usage-logging fragment: backendId: APIM backend identifier (e.g., tenant-openai ) routeLocation: Azure region…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"additional-monitoring-fragments","sectionTitle":"Additional Monitoring Fragments","text":"Fragment Purpose Status tracking-dimensions Extract session, user, app, and correlation IDs from headers Active openai-usage-logging Detailed usage tracking to Application Insights with routing metadata Active openai-streaming-metrics Token metrics for streaming responses Reserved for future use intelligent-routing Priority-based multi-backend selection Reserved for future use","excerpt":"Fragment Purpose Status tracking-dimensions Extract session, user, app, and correlation IDs from headers Active openai-usage-logging Detailed usage tracking to Application Insights with routing metadata Active…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"frequently-asked-questions","sectionTitle":"Frequently Asked Questions","text":"What kinds of entities are supported? The PII fragment is designed for enterprise PII detection and supports names, addresses, SSN, medical terms, financial data, and many other entity types. Azure Language Service uses machine learning to detect entities based on context. What happens if Language Service fails? Failure behavior is controlled by the fail_closed configuration setting: Fail-Open Mode (fail_closed = false, default) PII redaction operates on a best-effort basis . If Language Service fails: If the Language Service returns a non-200 response, the original unredacted content is passed through If the response cannot be parsed, the original unredacted content is passed through If the Language Service is temporarily unavailable, requests continue to flow without redaction All failures are logged in diagnostics with appropriate status codes and error details Use when: Service availability is prioritized over PII protection, or when PII redaction is a defense-in-depth measure rather than a strict requirement. Fail-Closed Mode (fail_closed = true) PII redaction is strictly enforced . If Language Service fails: If the Language Service returns a non-200 response, the request is blocked with HTTP 503 If the response cannot be parsed, the request is blocked with HTTP 503 If the Language Service is unavailable, all requests are blocked until service is restored Clients receive a JSON error response with code PiiRedactionUnavailable Use when: Strict PII protection is required and no unredacted content should reach downstream services. Ensures that sensitive data is never exposed, even during service outages. Configuration example: pii_redaction { enabled = true fail_closed = true # Block requests if PII service fails } Does this apply to all requests? PII anonymization is tenant-controlled and is applied (in the current routing) for OpenAI requests when enabled via apim_policies.pii_redaction.enabled . What is the performance impact? PII anonymization adds an extra network call from APIM to Language Service for requests where it is enabled. The Language Service call uses a fixed timeout of 20 seconds. For most requests, the latency impact is minimal (typically under 500ms). Can I customize which entity types are redacted? Yes. Use the excluded_categories setting in apim_policies.pii_redaction to specify PII categories that should not be detected or redacted. For example: pii_redaction { enabled = true excluded_categories = [\"PhoneNumber\", \"Address\"] } See Microsoft Learn: PII Entity Categories for the full list of available categories. How does \"preserve JSON structure\" work? The preserve_json_structure feature (enabled by default) uses a heuristic post-processing step to restore certain quoted string values that were masked by Language Service but are actually structural JSON fields rather than PII. How it works: After Language Service redacts the content (replacing PII with ##### patterns), the fragment identifies masked values that match known structural patterns Default whitelist includes OpenAI message roles: \"user\" , \"system\" , \"assistant\" , \"function\" , \"tool\" Custom values can be added via structural_whitelist configuration Restoration matches based on the length of the #### pattern (e.g., \"####\" could restore to \"user\" ) Example: If Language Service masks \"role\": \"user\" as \"role\": \"####\" , the post-processing step restores it to \"role\": \"user\" because \"user\" is in the default whitelist. Caution: This is a heuristic approach based on pattern matching. It reduces false positives on structural fields but could theoretically restore a value that happens to match both the pattern length and whitelist entry. For strict PII protection requirements, consider setting preserve_json_structure = false .","excerpt":"What kinds of entities are supported? The PII fragment is designed for enterprise PII detection and supports names, addresses, SSN, medical terms, financial data, and many other entity types. Azure Language Service uses…"},{"page":"language-service-pii.html","pageTitle":"Language Service PII Detection","sectionId":"troubleshooting","sectionTitle":"Troubleshooting","text":"Issue Cause Solution 401/403 calling Language Service Missing or incorrect RBAC permissions Verify APIM managed identity has the Cognitive Services User role assignment on the Language Service resource DNS / private endpoint not ready Private DNS zone integration incomplete Deployment includes a DNS wait step; ensure private DNS zone integration is complete before testing Transient failures after deploy Role assignment propagation delay Role assignment propagation can cause temporary failures until RBAC takes effect (typically 5-10 minutes) No redaction occurring PII detection not enabled Confirm tenant apim_policies.pii_redaction.enabled is true and shared language_service.enabled is true For Technical Details See the APIM Policy README for deep technical documentation on policy fragments, infrastructure components, and configuration schema. AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"Issue Cause Solution 401/403 calling Language Service Missing or incorrect RBAC permissions Verify APIM managed identity has the Cognitive Services User role assignment on the Language Service resource DNS / private…"},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"oidc-setup-guide","sectionTitle":"OIDC Setup Guide","text":"This guide explains how to configure OpenID Connect (OIDC) authentication between GitHub Actions and Azure, enabling passwordless deployments. Why OIDC? No secrets to rotate, no credentials stored in GitHub, and automatic token expiration for enhanced security.","excerpt":"This guide explains how to configure OpenID Connect (OIDC) authentication between GitHub Actions and Azure, enabling passwordless deployments. Why OIDC? No secrets to rotate, no credentials stored in GitHub, and…"},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"how-it-works","sectionTitle":"How It Works","text":"","excerpt":""},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"trust-chain","sectionTitle":"Trust Chain","text":"GitHub signs tokens with its private key for each workflow run Azure validates the token signature using GitHub's public key Subject claim matching ensures only the specified repo/environment gets access Bearer token issued by Azure for actual resource access","excerpt":"GitHub signs tokens with its private key for each workflow run Azure validates the token signature using GitHub's public key Subject claim matching ensures only the specified repo/environment gets access Bearer token…"},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"prerequisites","sectionTitle":"Prerequisites","text":"Azure CLI installed and logged in ( az login ) Terraform installed GitHub CLI (optional, for auto-creating secrets) Owner access to Azure security group","excerpt":"Azure CLI installed and logged in ( az login ) Terraform installed GitHub CLI (optional, for auto-creating secrets) Owner access to Azure security group"},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"setup-script-initial-azure-setupsh","sectionTitle":"Setup Script: initial-azure-setup.sh","text":"This script configures everything needed for OIDC authentication. Run it once per environment.","excerpt":"This script configures everything needed for OIDC authentication. Run it once per environment."},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"usage","sectionTitle":"Usage","text":"./initial-setup/initial-azure-setup.sh \\ -g \"RESOURCE-GROUP-NAME\" \\ -n \"identity-name\" \\ -r \"owner/repo\" \\ -e \"environment\" \\ -s \"subscription-id\" \\ --create-storage \\ --create-github-secrets","excerpt":"./initial-setup/initial-azure-setup.sh \\ -g \"RESOURCE-GROUP-NAME\" \\ -n \"identity-name\" \\ -r \"owner/repo\" \\ -e \"environment\" \\ -s \"subscription-id\" \\ --create-storage \\ --create-github-secrets"},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"parameters","sectionTitle":"Parameters","text":"Parameter Description Required -g Azure resource group name Yes -n Managed identity name Yes -r GitHub repository (owner/repo) Yes -e Environment name (dev, test, prod) Yes -s Azure subscription ID No (uses current) --create-storage Create storage account for Terraform state No --create-github-secrets Automatically create GitHub environment secrets No","excerpt":"Parameter Description Required -g Azure resource group name Yes -n Managed identity name Yes -r GitHub repository (owner/repo) Yes -e Environment name (dev, test, prod) Yes -s Azure subscription ID No (uses current)…"},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"what-gets-created","sectionTitle":"What Gets Created","text":"","excerpt":""},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"managed-identity","sectionTitle":"Managed Identity","text":"Azure service account for your pipeline to authenticate as.","excerpt":"Azure service account for your pipeline to authenticate as."},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"federated-credential","sectionTitle":"Federated Credential","text":"Trust link between your GitHub repo/environment and the Azure identity.","excerpt":"Trust link between your GitHub repo/environment and the Azure identity."},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"storage-account","sectionTitle":"Storage Account","text":"For Terraform state files (with --create-storage ).","excerpt":"For Terraform state files (with --create-storage )."},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"environment-examples","sectionTitle":"Environment Examples","text":"","excerpt":""},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"dev-environment","sectionTitle":"Dev Environment","text":"./initial-azure-setup.sh \\ -g \"ABCD-dev-networking\" \\ -n \"myapp-dev-identity\" \\ -r \"bcgov/myapp\" \\ -e \"dev\" \\ --create-storage \\ --create-github-secrets Creates: Identity: myapp-dev-identity Storage: tfdevmyapp Subject: repo:bcgov/myapp:environment:dev","excerpt":"./initial-azure-setup.sh \\ -g \"ABCD-dev-networking\" \\ -n \"myapp-dev-identity\" \\ -r \"bcgov/myapp\" \\ -e \"dev\" \\ --create-storage \\ --create-github-secrets Creates: Identity: myapp-dev-identity Storage: tfdevmyapp Subject:…"},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"prod-environment","sectionTitle":"Prod Environment","text":"./initial-azure-setup.sh \\ -g \"ABCD-prod-networking\" \\ -n \"myapp-prod-identity\" \\ -r \"bcgov/myapp\" \\ -e \"prod\" \\ --create-storage \\ --create-github-secrets Creates: Identity: myapp-prod-identity Storage: tfprodmyapp Subject: repo:bcgov/myapp:environment:prod Important: Dev and Prod are completely isolated &mdash; different subscriptions, different identities, different permissions. A dev pipeline cannot access prod resources.","excerpt":"./initial-azure-setup.sh \\ -g \"ABCD-prod-networking\" \\ -n \"myapp-prod-identity\" \\ -r \"bcgov/myapp\" \\ -e \"prod\" \\ --create-storage \\ --create-github-secrets Creates: Identity: myapp-prod-identity Storage: tfprodmyapp…"},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"token-lifecycle","sectionTitle":"Token Lifecycle","text":"Token Type TTL Notes GitHub OIDC Token ~5 minutes Generated fresh each workflow run, only used to get Azure token Azure Bearer Token 1 hour (3600s) Auto-refreshed by azure/login action if job runs longer","excerpt":"Token Type TTL Notes GitHub OIDC Token ~5 minutes Generated fresh each workflow run, only used to get Azure token Azure Bearer Token 1 hour (3600s) Auto-refreshed by azure/login action if job runs longer"},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"troubleshooting","sectionTitle":"Troubleshooting","text":"","excerpt":""},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"common-issues","sectionTitle":"Common Issues","text":"Error Solution AADSTS700024: Subject mismatch environment: in workflow must match -e flag used in setup OIDC token not generated Add permissions: id-token: write to workflow 403 Forbidden on terraform apply Identity not in security group, or wrong subscription State file access denied Add use_azuread_auth = true in backend config","excerpt":"Error Solution AADSTS700024: Subject mismatch environment: in workflow must match -e flag used in setup OIDC token not generated Add permissions: id-token: write to workflow 403 Forbidden on terraform apply Identity not…"},{"page":"oidc-setup.html","pageTitle":"OIDC Setup Guide","sectionId":"full-architecture-diagram","sectionTitle":"Full Architecture Diagram","text":"Click to view full size AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"Click to view full size AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"operational-playbooks","sectionTitle":"Operational Playbooks","text":"Step-by-step procedures for common operational scenarios, troubleshooting, and disaster recovery. These runbooks help operators respond quickly to issues. Before You Begin Ensure you have the required permissions and have read the relevant documentation. When in doubt, escalate to the platform team.","excerpt":"Step-by-step procedures for common operational scenarios, troubleshooting, and disaster recovery. These runbooks help operators respond quickly to issues. Before You Begin Ensure you have the required permissions and…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"quick-reference","sectionTitle":"Quick Reference","text":"","excerpt":""},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"state-lock-stuck","sectionTitle":"State Lock Stuck","text":"Terraform state is locked and won't release View Playbook →","excerpt":"Terraform state is locked and won't release View Playbook →"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"oidc-auth-failing","sectionTitle":"OIDC Auth Failing","text":"Token exchange errors between GitHub and Azure View Playbook →","excerpt":"Token exchange errors between GitHub and Azure View Playbook →"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"rollback-deployment","sectionTitle":"Rollback Deployment","text":"Revert to a previous known-good state View Playbook →","excerpt":"Revert to a previous known-good state View Playbook →"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"rotate-credentials","sectionTitle":"Rotate Credentials","text":"Update federated credentials if compromised View Playbook →","excerpt":"Update federated credentials if compromised View Playbook →"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"bastion-access-issues","sectionTitle":"Bastion Access Issues","text":"Cannot connect to VMs via Bastion View Playbook →","excerpt":"Cannot connect to VMs via Bastion View Playbook →"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"pipeline-stuck-1","sectionTitle":"Pipeline Stuck","text":"GitHub Actions workflow hanging or failing View Playbook →","excerpt":"GitHub Actions workflow hanging or failing View Playbook →"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"chisel-tunnel-setup","sectionTitle":"Chisel Tunnel Setup","text":"Local access to private Azure resources View Playbook →","excerpt":"Local access to private Azure resources View Playbook →"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"state-lock","sectionTitle":"Playbook: Terraform State Lock Stuck","text":"","excerpt":""},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"symptoms","sectionTitle":"Symptoms","text":"Terraform commands fail with: Error acquiring the state lock Message includes: Lock Info: ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx Previous pipeline run may have crashed or been cancelled","excerpt":"Terraform commands fail with: Error acquiring the state lock Message includes: Lock Info: ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx Previous pipeline run may have crashed or been cancelled"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"diagnosis","sectionTitle":"Diagnosis","text":"Check if another operation is running Look at GitHub Actions for any in-progress Terraform jobs. Check the lock info az storage blob show \\ --account-name <storage_account> \\ --container-name tfstate \\ --name terraform.tfstate \\ --query \"properties.lease\"","excerpt":"Check if another operation is running Look at GitHub Actions for any in-progress Terraform jobs. Check the lock info az storage blob show \\ --account-name <storage_account> \\ --container-name tfstate \\ --name…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"resolution","sectionTitle":"Resolution","text":"⚠️ Caution: Only force-unlock if you are CERTAIN no other operation is running. Breaking an active lock can corrupt state. Option 1: Wait and Retry (Safest) Locks typically auto-release after 15-60 minutes. Wait and retry. Option 2: Break the Blob Lease # List current leases az storage blob lease show \\ --account-name <storage_account> \\ --container-name tfstate \\ --blob-name terraform.tfstate # Break the lease (requires Storage Blob Data Owner role) az storage blob lease break \\ --account-name <storage_account> \\ --container-name tfstate \\ --blob-name terraform.tfstate Option 3: Force Unlock via Terraform # Get the lock ID from the error message, then: terraform force-unlock <LOCK_ID> # Example: terraform force-unlock 12345678-1234-1234-1234-123456789012","excerpt":"⚠️ Caution: Only force-unlock if you are CERTAIN no other operation is running. Breaking an active lock can corrupt state. Option 1: Wait and Retry (Safest) Locks typically auto-release after 15-60 minutes. Wait and…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"prevention","sectionTitle":"Prevention","text":"Never cancel Terraform runs mid-operation Use workflow concurrency controls (already configured) Ensure proper timeout settings on pipeline jobs","excerpt":"Never cancel Terraform runs mid-operation Use workflow concurrency controls (already configured) Ensure proper timeout settings on pipeline jobs"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"oidc-failure","sectionTitle":"Playbook: OIDC Authentication Failing","text":"","excerpt":""},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"symptoms-1","sectionTitle":"Symptoms","text":"GitHub Actions fails at azure/login step Error: AADSTS700024: Client assertion is not within its valid time range Error: AADSTS70021: No matching federated identity record found Error: AADSTS700016: Application with identifier 'xxx' was not found","excerpt":"GitHub Actions fails at azure/login step Error: AADSTS700024: Client assertion is not within its valid time range Error: AADSTS70021: No matching federated identity record found Error: AADSTS700016: Application with…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"diagnosis-by-error-code","sectionTitle":"Diagnosis by Error Code","text":"Error Cause Fix AADSTS700024 Token timing issue (clock skew) Retry the workflow - usually transient AADSTS70021 Subject claim doesn't match federated credential Check branch/environment matches credential config AADSTS700016 Client ID doesn't exist or wrong tenant Verify AZURE_CLIENT_ID secret is correct","excerpt":"Error Cause Fix AADSTS700024 Token timing issue (clock skew) Retry the workflow - usually transient AADSTS70021 Subject claim doesn't match federated credential Check branch/environment matches credential config…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"resolution-steps","sectionTitle":"Resolution Steps","text":"1. Verify GitHub Secrets # These secrets must be set in GitHub repository settings: AZURE_CLIENT_ID # Managed Identity Client ID AZURE_TENANT_ID # Azure AD Tenant ID AZURE_SUBSCRIPTION_ID # Target Subscription ID 2. Verify Federated Credential Configuration # Check federated credentials on the managed identity az ad app federated-credential list \\ --id <APP_OBJECT_ID> \\ --query \"[].{name:name, subject:subject, issuer:issuer}\" The subject must match exactly: For environment: repo:bcgov/ai-hub-tracking:environment:dev For branch: repo:bcgov/ai-hub-tracking:ref:refs/heads/main 3. Check Token Claims Add this step to your workflow to debug the token: - name: Debug OIDC Token run: | TOKEN=$(curl -s -H \"Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \\ \"$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange\" | jq -r '.value') echo \"Token claims:\" echo $TOKEN | cut -d. -f2 | base64 -d 2>/dev/null | jq . 4. Recreate Federated Credential # Delete and recreate if misconfigured az ad app federated-credential delete \\ --id <APP_OBJECT_ID> \\ --federated-credential-id <CREDENTIAL_ID> # Recreate with correct subject ./initial-setup/initial-azure-setup.sh \\ -g \"your-rg\" -n \"your-identity\" \\ -r \"bcgov/ai-hub-tracking\" -e \"dev\"","excerpt":"1. Verify GitHub Secrets # These secrets must be set in GitHub repository settings: AZURE_CLIENT_ID # Managed Identity Client ID AZURE_TENANT_ID # Azure AD Tenant ID AZURE_SUBSCRIPTION_ID # Target Subscription ID 2.…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"rollback","sectionTitle":"Playbook: Rollback Failed Deployment","text":"","excerpt":""},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"when-to-use","sectionTitle":"When to Use","text":"A deployment broke existing functionality Resources are in an inconsistent state Need to revert to a known-good configuration","excerpt":"A deployment broke existing functionality Resources are in an inconsistent state Need to revert to a known-good configuration"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"option-1-git-revert-recommended","sectionTitle":"Option 1: Git Revert (Recommended)","text":"# Find the last good commit git log --oneline -10 # Revert the problematic commit(s) git revert <BAD_COMMIT_SHA> # Push to trigger pipeline with reverted code git push origin main","excerpt":"# Find the last good commit git log --oneline -10 # Revert the problematic commit(s) git revert <BAD_COMMIT_SHA> # Push to trigger pipeline with reverted code git push origin main"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"option-2-restore-from-state-backup","sectionTitle":"Option 2: Restore from State Backup","text":"Azure Blob Storage keeps versions of the state file: # List state file versions az storage blob list \\ --account-name <storage_account> \\ --container-name tfstate \\ --include v \\ --query \"[?name=='terraform.tfstate'].{version:versionId, modified:properties.lastModified}\" # Download a previous version az storage blob download \\ --account-name <storage_account> \\ --container-name tfstate \\ --name terraform.tfstate \\ --version-id <VERSION_ID> \\ --file terraform.tfstate.backup","excerpt":"Azure Blob Storage keeps versions of the state file: # List state file versions az storage blob list \\ --account-name <storage_account> \\ --container-name tfstate \\ --include v \\ --query…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"option-3-targeted-destroy-and-recreate","sectionTitle":"Option 3: Targeted Destroy and Recreate","text":"# Destroy specific problematic resources terraform destroy -target=azurerm_virtual_machine.jumpbox # Reapply to recreate with correct config terraform apply 💡 Tip: Always run terraform plan before apply after a rollback to verify the expected changes.","excerpt":"# Destroy specific problematic resources terraform destroy -target=azurerm_virtual_machine.jumpbox # Reapply to recreate with correct config terraform apply 💡 Tip: Always run terraform plan before apply after a rollback…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"credential-rotation","sectionTitle":"Playbook: Rotate Federated Credentials","text":"","excerpt":""},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"when-to-use-1","sectionTitle":"When to Use","text":"Suspected credential compromise Security audit requires rotation Changing repository or organization ✅ Good News: With OIDC, there are no long-lived secrets to rotate! The \"credential\" is the trust relationship, not a secret key.","excerpt":"Suspected credential compromise Security audit requires rotation Changing repository or organization ✅ Good News: With OIDC, there are no long-lived secrets to rotate! The \"credential\" is the trust relationship, not a…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"to-update-the-trust-relationship","sectionTitle":"To Update the Trust Relationship","text":"1. Delete Existing Federated Credential az ad app federated-credential list --id <APP_OBJECT_ID> az ad app federated-credential delete \\ --id <APP_OBJECT_ID> \\ --federated-credential-id <CREDENTIAL_ID> 2. Create New Federated Credential ./initial-setup/initial-azure-setup.sh \\ -g \"your-rg\" \\ -n \"your-identity\" \\ -r \"bcgov/new-repo-name\" \\ -e \"dev\" 3. Update GitHub Secrets (if Client ID changed) Go to Repository Settings → Secrets and variables → Actions Update AZURE_CLIENT_ID with new Managed Identity Client ID 4. Verify New Configuration # Trigger a test workflow run gh workflow run deploy.yml","excerpt":"1. Delete Existing Federated Credential az ad app federated-credential list --id <APP_OBJECT_ID> az ad app federated-credential delete \\ --id <APP_OBJECT_ID> \\ --federated-credential-id <CREDENTIAL_ID> 2. Create New…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"bastion-access","sectionTitle":"Playbook: Bastion Access Issues","text":"","excerpt":""},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"symptoms-2","sectionTitle":"Symptoms","text":"Cannot connect to VM via Azure Portal Bastion Connection times out \"Bastion host not found\" error","excerpt":"Cannot connect to VM via Azure Portal Bastion Connection times out \"Bastion host not found\" error"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"diagnosis-1","sectionTitle":"Diagnosis","text":"1. Check if Bastion is Deployed az network bastion list \\ --resource-group <RG_NAME> \\ --query \"[].{name:name, state:provisioningState}\" If empty, Bastion may be disabled (cost-saving). Deploy it: # Via GitHub Actions gh workflow run add-or-remove-module.yml -f action=add # Or via manual trigger in GitHub UI 2. Check NSG Rules # Bastion subnet requires specific NSG rules az network nsg rule list \\ --resource-group <RG_NAME> \\ --nsg-name <BASTION_NSG> \\ --query \"[].{name:name, access:access, direction:direction, port:destinationPortRange}\" Required inbound rules: HTTPS (443) from Internet Gateway Manager from GatewayManager service tag Azure Load Balancer from AzureLoadBalancer service tag 3. Check VM Status az vm get-instance-view \\ --resource-group <RG_NAME> \\ --name <VM_NAME> \\ --query \"instanceView.statuses[1].displayStatus\" VM must be in \"VM running\" state.","excerpt":"1. Check if Bastion is Deployed az network bastion list \\ --resource-group <RG_NAME> \\ --query \"[].{name:name, state:provisioningState}\" If empty, Bastion may be disabled (cost-saving). Deploy it: # Via GitHub Actions gh…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"pipeline-stuck","sectionTitle":"Playbook: GitHub Actions Pipeline Stuck","text":"","excerpt":""},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"symptoms-3","sectionTitle":"Symptoms","text":"Pipeline shows \"In progress\" for extended time Terraform plan/apply seems to hang No new log output appearing","excerpt":"Pipeline shows \"In progress\" for extended time Terraform plan/apply seems to hang No new log output appearing"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"resolution-1","sectionTitle":"Resolution","text":"1. Check for Pending Approvals Production environments require approval. Check the workflow run for pending reviews. 2. Cancel and Retry # Cancel via CLI gh run cancel <RUN_ID> # Retry gh workflow run <WORKFLOW_NAME> 3. Check for State Lock If Terraform is waiting on state lock, see State Lock Playbook . 4. Check Runner Health # View recent workflow runs gh run list --limit 10 # Check specific run logs gh run view <RUN_ID> --log 5. GitHub Status Check GitHub Status Page for platform issues.","excerpt":"1. Check for Pending Approvals Production environments require approval. Check the workflow run for pending reviews. 2. Cancel and Retry # Cancel via CLI gh run cancel <RUN_ID> # Retry gh workflow run <WORKFLOW_NAME> 3.…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"chisel-tunnel","sectionTitle":"Playbook: Chisel Tunnel for Local Development","text":"🔧 Platform Maintainers Only: This playbook is for the platform team to access private Azure resources (databases, Key Vault, etc.) from their local machines. Tenant developers should use the APIM/App Gateway endpoints instead. 📖 Looking for the full deployment workflow? See the comprehensive Local Development Deployment Guide for step-by-step instructions on deploying infrastructure from your local machine, including environment switching and integration testing.","excerpt":"🔧 Platform Maintainers Only: This playbook is for the platform team to access private Azure resources (databases, Key Vault, etc.) from their local machines. Tenant developers should use the APIM/App Gateway endpoints…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"when-to-use-2","sectionTitle":"When to Use","text":"You need to connect to a private PostgreSQL/CosmosDB database from your laptop You need to debug private endpoints locally You need to test API calls to private Azure services Bastion/Jumpbox is overkill for quick data plane access","excerpt":"You need to connect to a private PostgreSQL/CosmosDB database from your laptop You need to debug private endpoints locally You need to test API calls to private Azure services Bastion/Jumpbox is overkill for quick data…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"prerequisites","sectionTitle":"Prerequisites","text":"Docker installed on your local machine Chisel credentials from Terraform output (contact platform team) Azure Proxy deployed ( enable_azure_proxy = true in Terraform)","excerpt":"Docker installed on your local machine Chisel credentials from Terraform output (contact platform team) Azure Proxy deployed ( enable_azure_proxy = true in Terraform)"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"step-1-get-chisel-credentials","sectionTitle":"Step 1: Get Chisel Credentials","text":"The Chisel server credentials are stored in Terraform outputs. Contact the platform team or retrieve them yourself: # From a machine with Terraform access (e.g., Jumpbox) cd initial-setup/infra terraform output azure_proxy_chisel_auth # Output format: tunnel:XXXXXXXX You'll also need the App Service URL: terraform output azure_proxy_url # Output: https://<app-name>.azurewebsites.net","excerpt":"The Chisel server credentials are stored in Terraform outputs. Contact the platform team or retrieve them yourself: # From a machine with Terraform access (e.g., Jumpbox) cd initial-setup/infra terraform output…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"step-2-connect-to-a-private-database","sectionTitle":"Step 2: Connect to a Private Database","text":"Example: Connecting to a private PostgreSQL database on port 5432: # Run Chisel client in Docker docker run --rm -it \\ -p 5432:5432 \\ jpillora/chisel:latest client \\ --auth \"tunnel:XXXXXXXX\" \\ https://<app-name>.azurewebsites.net \\ 0.0.0.0:5432:<postgres-server>.postgres.database.azure.com:5432 # Now connect locally psql -h localhost -p 5432 -U <username> -d <database> ⚠️ Port Conflicts: If port 5432 is already in use locally, map to a different port: -p 5462:5432 Then connect with psql -h localhost -p 5462 ...","excerpt":"Example: Connecting to a private PostgreSQL database on port 5432: # Run Chisel client in Docker docker run --rm -it \\ -p 5432:5432 \\ jpillora/chisel:latest client \\ --auth \"tunnel:XXXXXXXX\" \\…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"step-3-connect-to-multiple-services-socks5-proxy","sectionTitle":"Step 3: Connect to Multiple Services (SOCKS5 Proxy)","text":"For accessing multiple private services or browsing private endpoints: # Run Chisel as SOCKS5 proxy docker run --rm -it \\ -p 1080:1080 \\ jpillora/chisel:latest client \\ --auth \"tunnel:XXXXXXXX\" \\ https://<app-name>.azurewebsites.net \\ socks Configure Firefox with SmartProxy Extension Install SmartProxy extension Add a proxy server: Type: SOCKS5 Address: localhost Port: 1080 Add rules for Azure private endpoints: *.vault.azure.net *.postgres.database.azure.com *.blob.core.windows.net","excerpt":"For accessing multiple private services or browsing private endpoints: # Run Chisel as SOCKS5 proxy docker run --rm -it \\ -p 1080:1080 \\ jpillora/chisel:latest client \\ --auth \"tunnel:XXXXXXXX\" \\…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"step-4-connect-to-key-vault","sectionTitle":"Step 4: Connect to Key Vault","text":"# Tunnel to Key Vault (port 443) docker run --rm -it \\ -p 8443:443 \\ jpillora/chisel:latest client \\ --auth \"tunnel:XXXXXXXX\" \\ https://<app-name>.azurewebsites.net \\ 0.0.0.0:443:<keyvault-name>.vault.azure.net:443 # Use Azure CLI with HTTPS_PROXY (alternative method) HTTPS_PROXY=socks5://localhost:1080 az keyvault secret list --vault-name <keyvault-name>","excerpt":"# Tunnel to Key Vault (port 443) docker run --rm -it \\ -p 8443:443 \\ jpillora/chisel:latest client \\ --auth \"tunnel:XXXXXXXX\" \\ https://<app-name>.azurewebsites.net \\ 0.0.0.0:443:<keyvault-name>.vault.azure.net:443 # Use…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"troubleshooting","sectionTitle":"Troubleshooting","text":"Issue Cause Solution Connection refused Chisel server not running or wrong URL Verify App Service is running, check URL Authentication failed Wrong credentials Get fresh credentials from Terraform output Timeout connecting to target Target hostname wrong or not in VNet Verify private endpoint hostname, check VNet peering Port already in use Local service using the port Use different local port: -p 5462:5432 DNS resolution failed Private DNS not linked Use IP address instead, or check Private DNS Zone","excerpt":"Issue Cause Solution Connection refused Chisel server not running or wrong URL Verify App Service is running, check URL Authentication failed Wrong credentials Get fresh credentials from Terraform output Timeout…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"security-notes","sectionTitle":"Security Notes","text":"🔒 Credentials: Chisel auth is randomly generated and stored in App Service settings (encrypted by Azure) Access logging: All connections are logged in Application Insights Scope: Chisel can only reach resources within the VNet or peered VNets Not for tenants: This is platform team tooling, not for ministry developers","excerpt":"🔒 Credentials: Chisel auth is randomly generated and stored in App Service settings (encrypted by Azure) Access logging: All connections are logged in Application Insights Scope: Chisel can only reach resources within…"},{"page":"playbooks.html","pageTitle":"Operational Playbooks","sectionId":"related-resources","sectionTitle":"Related Resources","text":"ADR-011: Control Plane vs Data Plane Access & Chisel Tunnel Terraform Reference: azure-proxy module Chisel GitHub Repository AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"ADR-011: Control Plane vs Data Plane Access & Chisel Tunnel Terraform Reference: azure-proxy module Chisel GitHub Repository AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub…"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"available-ai-services","sectionTitle":"Available AI Services","text":"The AI Services Hub provides secure, compliant access to Azure AI capabilities for BC Government teams. This page describes what services are available, what each tenant gets, and how to request access. All services run on private endpoints — no public internet exposure. Access is through the APIM gateway using your tenant's subscription key. See APIM Internal Endpoints for the API reference.","excerpt":"The AI Services Hub provides secure, compliant access to Azure AI capabilities for BC Government teams. This page describes what services are available, what each tenant gets, and how to request access. All services run…"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"quick-navigation","sectionTitle":"Quick Navigation","text":"OpenAI Models GPT-4.1, GPT-5, o-series, embeddings Cognitive Services Document Intelligence, Language PII, Speech What Each Tenant Gets Shared vs. dedicated resource breakdown","excerpt":"OpenAI Models GPT-4.1, GPT-5, o-series, embeddings Cognitive Services Document Intelligence, Language PII, Speech What Each Tenant Gets Shared vs. dedicated resource breakdown"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"openai-models","sectionTitle":"OpenAI Models","text":"Each tenant accesses OpenAI models through their dedicated AI Foundry Project endpoint, routed via APIM. All models run in the Canada East region using the GlobalStandard SKU — no access approval required.","excerpt":"Each tenant accesses OpenAI models through their dedicated AI Foundry Project endpoint, routed via APIM. All models run in the Canada East region using the GlobalStandard SKU — no access approval required."},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"chat-reasoning-models","sectionTitle":"Chat & Reasoning Models","text":"Model Kind Best For Quota (Canada East) gpt-4.1 Chat Complex reasoning, long context 30,000 TPM gpt-4.1-mini Chat Fast, cost-efficient tasks 150,000 TPM gpt-4.1-nano Chat High-throughput simple tasks 150,000 TPM gpt-4o Chat Multimodal inputs (text + images) 30,000 TPM gpt-4o-mini Chat Fast multimodal tasks 150,000 TPM gpt-5-mini Chat Next-gen compact model 10,000 TPM gpt-5-nano Chat Next-gen ultra-fast tasks 150,000 TPM gpt-5.1-chat Chat Preview Next-gen preview chat model 5,000 TPM o1 Reasoning Step-by-step scientific / math problems 5,000 TPM o3-mini Reasoning Cost-efficient multi-step reasoning 5,000 TPM o4-mini Reasoning Latest compact reasoning model 10,000 TPM gpt-5.1-codex-mini Code Code generation & completion 10,000 TPM","excerpt":"Model Kind Best For Quota (Canada East) gpt-4.1 Chat Complex reasoning, long context 30,000 TPM gpt-4.1-mini Chat Fast, cost-efficient tasks 150,000 TPM gpt-4.1-nano Chat High-throughput simple tasks 150,000 TPM gpt-4o…"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"embedding-models","sectionTitle":"Embedding Models","text":"Embedding models convert text into dense vector representations — essential for search, RAG (Retrieval Augmented Generation), and semantic similarity tasks. Model Dimensions Best For Quota (Canada East) text-embedding-3-large 3,072 Highest accuracy RAG retrieval 10,000 TPM text-embedding-3-small 1,536 Fast, cost-efficient semantic search 10,000 TPM text-embedding-ada-002 1,536 Legacy compatibility 10,000 TPM 💡 TPM = Tokens Per Minute. These are subscription-wide limits ; each tenant is allocated a share. Current allocation is 1% per tenant for test/dev environments. Contact the platform team to discuss production quota increases. See model-deployments.md for exact per-tenant allocation.","excerpt":"Embedding models convert text into dense vector representations — essential for search, RAG (Retrieval Augmented Generation), and semantic similarity tasks. Model Dimensions Best For Quota (Canada East)…"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"cognitive-services","sectionTitle":"Cognitive Services","text":"Beyond OpenAI models, each tenant can access the following Azure AI capabilities through the hub.","excerpt":"Beyond OpenAI models, each tenant can access the following Azure AI capabilities through the hub."},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"document-intelligence","sectionTitle":"Document Intelligence","text":"Extract structured data from unstructured documents — forms, invoices, PDFs, scanned images. Supports custom models trained on your document types. Dedicated instance per tenant &mdash; View setup guide →","excerpt":"Extract structured data from unstructured documents — forms, invoices, PDFs, scanned images. Supports custom models trained on your document types. Dedicated instance per tenant &mdash; View setup guide →"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"language-service-pii-detection","sectionTitle":"Language Service / PII Detection","text":"Detect and redact Personally Identifiable Information (PII) from text using Microsoft's pre-trained ML models. Supports named entity recognition, sentiment analysis, and key phrase extraction. Shared hub service &mdash; View PII guide →","excerpt":"Detect and redact Personally Identifiable Information (PII) from text using Microsoft's pre-trained ML models. Supports named entity recognition, sentiment analysis, and key phrase extraction. Shared hub service &mdash;…"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"speech-services","sectionTitle":"Speech Services","text":"Convert speech to text and text to speech. Supports real-time transcription, batch audio processing, and custom voice models. Optimized for Canadian English and French. Dedicated instance per tenant &mdash; See FAQ for details","excerpt":"Convert speech to text and text to speech. Supports real-time transcription, batch audio processing, and custom voice models. Optimized for Canadian English and French. Dedicated instance per tenant &mdash; See FAQ for…"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"ai-search","sectionTitle":"AI Search","text":"Managed vector + full-text search service for building RAG pipelines, semantic search over documents, and hybrid retrieval. Integrates directly with AI Foundry for grounding model responses. Dedicated instance per tenant","excerpt":"Managed vector + full-text search service for building RAG pipelines, semantic search over documents, and hybrid retrieval. Integrates directly with AI Foundry for grounding model responses. Dedicated instance per tenant"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"shared-vs-dedicated","sectionTitle":"What Each Tenant Gets","text":"The hub operates on a shared platform, dedicated data model. Expensive control-plane infrastructure is shared; all data-plane services are isolated per tenant.","excerpt":"The hub operates on a shared platform, dedicated data model. Expensive control-plane infrastructure is shared; all data-plane services are isolated per tenant."},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"shared-platform-infrastructure","sectionTitle":"Shared Platform Infrastructure","text":"Provisioned once, used by all tenants. Cost is split proportionally. AI Foundry Hub — shared model registry & endpoint API Management (APIM) — unified API gateway Application Gateway + WAF — TLS termination, routing Virtual Network & Private DNS — private connectivity Azure Container Registry — shared container images Log Analytics Workspace — centralized monitoring","excerpt":"Provisioned once, used by all tenants. Cost is split proportionally. AI Foundry Hub — shared model registry & endpoint API Management (APIM) — unified API gateway Application Gateway + WAF — TLS termination, routing…"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"dedicated-per-tenant-resources","sectionTitle":"Dedicated Per-Tenant Resources","text":"Provisioned exclusively for your team. Cost is directly attributed to you. AI Foundry Project — your own API endpoint & prompt flows OpenAI Deployments — quota allocated to your project Document Intelligence — your own instance & models AI Search — your own indexes for RAG Speech Services — your own instance Key Vault — your secrets, isolated from other tenants Storage Account — your documents & data Cosmos DB — your NoSQL database (when enabled) Resource Group — rg-{tenant}-{env} APIM Subscription Key — your API credential Cross-tenant isolation is enforced at the network and identity layer. Dedicated Key Vaults and Resource Groups mean one tenant cannot access another tenant's data — even if they share APIM or AI Foundry Hub infrastructure. See ADR-010: Multi-Tenant Isolation Model for the full security rationale.","excerpt":"Provisioned exclusively for your team. Cost is directly attributed to you. AI Foundry Project — your own API endpoint & prompt flows OpenAI Deployments — quota allocated to your project Document Intelligence — your own…"},{"page":"services.html","pageTitle":"Available AI Services","sectionId":"related-resources","sectionTitle":"Related Resources","text":"APIM Endpoints Full API reference for tenant-info and apim-keys endpoints. View Reference → Key Rotation How your APIM subscription key is rotated automatically. View Guide → Cost Tracking How costs are allocated and attributed per tenant. View Costs → AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"APIM Endpoints Full API reference for tenant-info and apim-keys endpoints. View Reference → Key Rotation How your APIM subscription key is rotated automatically. View Guide → Cost Tracking How costs are allocated and…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"technical-deep-dive-control-vs-data-plane-chisel-architecture","sectionTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","text":"This document provides an in-depth technical explanation of why we need Key Vault access, when terraform operations fail, and how Chisel provides a solution.","excerpt":"This document provides an in-depth technical explanation of why we need Key Vault access, when terraform operations fail, and how Chisel provides a solution."},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"table-of-contents","sectionTitle":"Table of Contents","text":"Control Plane vs Data Plane: The Fundamental Divide Key Vault Operations: What Requires Data Plane Access Terraform + Key Vault: When Operations Fail Chisel: How the Tunnel Works Deployment Scenarios: Who Needs What","excerpt":"Control Plane vs Data Plane: The Fundamental Divide Key Vault Operations: What Requires Data Plane Access Terraform + Key Vault: When Operations Fail Chisel: How the Tunnel Works Deployment Scenarios: Who Needs What"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"control-vs-data-plane","sectionTitle":"1. Control Plane vs Data Plane: The Fundamental Divide","text":"","excerpt":""},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"what-is-control-plane","sectionTitle":"What is Control Plane?","text":"The control plane is Azure's management layer that handles: Creating, updating, deleting resources Reading metadata and configuration Managing RBAC and policies Endpoint: management.azure.com Authentication: OIDC (OpenID Connect) works perfectly","excerpt":"The control plane is Azure's management layer that handles: Creating, updating, deleting resources Reading metadata and configuration Managing RBAC and policies Endpoint: management.azure.com Authentication: OIDC (OpenID…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"what-is-data-plane","sectionTitle":"What is Data Plane?","text":"The data plane is where actual data operations happen: Reading/writing secrets from Key Vault Accessing storage blobs Querying databases Any operation that touches actual data Endpoint: Service-specific (e.g., *.vault.azure.net , *.blob.core.windows.net ) Authentication: OIDC often fails when private endpoints exist","excerpt":"The data plane is where actual data operations happen: Reading/writing secrets from Key Vault Accessing storage blobs Querying databases Any operation that touches actual data Endpoint: Service-specific (e.g.,…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"why-the-divide","sectionTitle":"Why the Divide?","text":"Azure separates these for security and architectural reasons: Control plane can use service principals and managed identities with OIDC Data plane requires direct network access to the service endpoint Private endpoints block public access to data plane endpoints Critical Insight: When you enable private endpoints, you are blocking public access to data plane endpoints. This means tools that worked via OIDC before may suddenly fail.","excerpt":"Azure separates these for security and architectural reasons: Control plane can use service principals and managed identities with OIDC Data plane requires direct network access to the service endpoint Private endpoints…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"keyvault-operations","sectionTitle":"2. Key Vault Operations: What Requires Data Plane Access","text":"","excerpt":""},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"key-vault-endpoints","sectionTitle":"Key Vault Endpoints","text":"Control Plane: management.azure.com (create KV, set policies, read metadata) Data Plane: *.vault.azure.net (read/write secrets, keys, certificates)","excerpt":"Control Plane: management.azure.com (create KV, set policies, read metadata) Data Plane: *.vault.azure.net (read/write secrets, keys, certificates)"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"operations-that-require-data-plane-access","sectionTitle":"Operations That Require Data Plane Access","text":"Reading Secrets // This REQUIRES data plane access data \"azurerm_key_vault_secret\" \"example\" { name = \"my-secret\" vault_id = \"/subscriptions/.../keyvaults/myvault\" } // When private endpoints are enabled: // ✗ FAILS: Cannot reach myvault.vault.azure.net from GitHub runner // ✓ WORKS: Can reach myvault.vault.azure.net from within VNet or via Chisel Writing Secrets // This REQUIRES data plane access resource \"azurerm_key_vault_secret\" \"example\" { name = \"my-secret\" value = \"secret-value\" key_vault_id = azurerm_key_vault.main.id // Terraform must connect to: myvault.vault.azure.net // When private endpoints are enabled: // ✗ FAILS: GitHub runner cannot reach myvault.vault.azure.net // ✓ WORKS: Chisel tunnel provides access to myvault.vault.azure.net }","excerpt":"Reading Secrets // This REQUIRES data plane access data \"azurerm_key_vault_secret\" \"example\" { name = \"my-secret\" vault_id = \"/subscriptions/.../keyvaults/myvault\" } // When private endpoints are enabled: // ✗ FAILS:…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"why-these-fail-with-oidc-private-endpoints","sectionTitle":"Why These Fail with OIDC + Private Endpoints","text":"GitHub Runner (OIDC Authentication) ↓ Azure AD (Token: aud=management.azure.com) ↓ Azure ARM API (management.azure.com) ✓ WORKS ↓ Terraform creates resource ↓ Terraform tries to write secret ↓ needs to access: myvault.vault.azure.net ✗ BLOCKED ↑ Private endpoint blocks public access GitHub runner has no route to VNet","excerpt":"GitHub Runner (OIDC Authentication) ↓ Azure AD (Token: aud=management.azure.com) ↓ Azure ARM API (management.azure.com) ✓ WORKS ↓ Terraform creates resource ↓ Terraform tries to write secret ↓ needs to access:…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"terraform-keyvault","sectionTitle":"3. Terraform + Key Vault: When Operations Fail","text":"The following examples illustrate how Terraform operations interact with Key Vault. The actual implementation is spread across infra-ai-hub/stacks/ (the hub no longer uses a single monolithic main.tf ).","excerpt":"The following examples illustrate how Terraform operations interact with Key Vault. The actual implementation is spread across infra-ai-hub/stacks/ (the hub no longer uses a single monolithic main.tf )."},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"creating-key-vault-control-plane-works","sectionTitle":"Creating Key Vault (Control Plane - Works)","text":"resource \"azurerm_key_vault\" \"main\" { name = var.key_vault_name location = var.location resource_group_name = azurerm_resource_group.main.name } // ✓ WORKS with OIDC // Uses: management.azure.com // No private endpoint yet, so no blocking","excerpt":"resource \"azurerm_key_vault\" \"main\" { name = var.key_vault_name location = var.location resource_group_name = azurerm_resource_group.main.name } // ✓ WORKS with OIDC // Uses: management.azure.com // No private endpoint…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"creating-private-endpoint-control-plane-works","sectionTitle":"Creating Private Endpoint (Control Plane - Works)","text":"resource \"azurerm_private_endpoint\" \"key_vault_pe\" { name = \"${var.app_name}-kv-pe\" location = var.location resource_group_name = azurerm_resource_group.main.name subnet_id = module.network.private_endpoint_subnet_id private_service_connection { name = \"${var.app_name}-kv-psc\" private_connection_resource_id = azurerm_key_vault.main.id is_manual_connection = false subresource_names = [\"vault\"] } } // ✓ WORKS with OIDC // Uses: management.azure.com // This BLOCKS public access to *.vault.azure.net","excerpt":"resource \"azurerm_private_endpoint\" \"key_vault_pe\" { name = \"${var.app_name}-kv-pe\" location = var.location resource_group_name = azurerm_resource_group.main.name subnet_id = module.network.private_endpoint_subnet_id…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"waiting-for-dns-dns-propagation-workaround","sectionTitle":"Waiting for DNS (DNS Propagation Workaround)","text":"resource \"null_resource\" \"wait_for_key_vault_private_dns\" { triggers = { private_endpoint_id = azurerm_private_endpoint.key_vault_pe.id // ... other values } provisioner \"local-exec\" { command = <<EOT # Wait for DNS to be ready before trying data plane operations # Azure creates private DNS records asynchronously # We poll until the private endpoint can resolve its DNS name EOT } depends_on = [azurerm_private_endpoint.key_vault_pe] } // Why necessary? // After private endpoint creation, Azure asynchronously: // 1. Creates private DNS zone: privatelink.vaultcore.azure.net // 2. Links it to the VNet // 3. Creates A records for the private endpoint // 4. This can take 30-120 seconds // // If we try to create secrets immediately: // ✗ FAILS: Cannot resolve myvault.vault.azure.net // ✓ WORKS: After DNS is ready, myvault.vault.azure.net resolves to private IP","excerpt":"resource \"null_resource\" \"wait_for_key_vault_private_dns\" { triggers = { private_endpoint_id = azurerm_private_endpoint.key_vault_pe.id // ... other values } provisioner \"local-exec\" { command = <<EOT # Wait for DNS to…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"creating-secrets-data-plane-fails-without-chisel","sectionTitle":"Creating Secrets (Data Plane - FAILS without Chisel)","text":"resource \"azurerm_key_vault_secret\" \"secret_one\" { name = \"example-secret-test-one\" value = random_password.secret_one.result key_vault_id = azurerm_key_vault.main.id expiration_date = \"2025-12-31T23:59:59Z\" depends_on = [null_resource.wait_for_key_vault_private_dns] } resource \"azurerm_key_vault_secret\" \"secret_two\" { name = \"example-secret-test-two\" value = random_password.secret_two.result key_vault_id = azurerm_key_vault.main.id expiration_date = \"2025-12-31T23:59:59Z\" depends_on = [null_resource.wait_for_key_vault_private_dns] } // ✗ FAILS with OIDC + Private Endpoints // Terraform tries to connect to: myvault.vault.azure.net // GitHub runner has no route to the private IP // // ✓ WORKS with: // 1. Self-hosted runner inside VNet // 2. Bastion + Jumpbox (VPN to VNet) // 3. Chisel tunnel (App Service → VNet → *.vault.azure.net)","excerpt":"resource \"azurerm_key_vault_secret\" \"secret_one\" { name = \"example-secret-test-one\" value = random_password.secret_one.result key_vault_id = azurerm_key_vault.main.id expiration_date = \"2025-12-31T23:59:59Z\" depends_on =…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"chisel-solution","sectionTitle":"4. Chisel: How the Tunnel Works","text":"","excerpt":""},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"the-problem-chisel-solves","sectionTitle":"The Problem Chisel Solves","text":"BEFORE Chisel: ┌──────────────┐ ┌──────────────┐ │ GitHub Runner │ ──OIDC──> │ Azure ARM API │ │ (Public) │ │ mgmt.azure.com│ └──────────────┘ └──────┬───────┘ │ │ Creates resources ↓ ┌──────────────┐ ┌──────▼───────┐ │ GitHub Runner │ │ Private │ │ ✗ No route │ │ Endpoint │ │ to VNet │ │ *.vault.azure.net │ └──────────────┘ │ BLOCKED │ └──────────────┘ AFTER Chisel: ┌──────────────┐ ┌──────────────┐ │ GitHub Runner │ ──OIDC──> │ Azure ARM API │ │ (Public) │ │ mgmt.azure.com│ └──────┬───────┘ └──────┬───────┘ │ │ │ Creates │ ↓ │ ┌──────▼──────────┐ ┌─────▼──────┐ │ App Service │ │ Private │ │ (Chisel Server) │────────> │ Endpoint │ │ VNet Integrated │ │ *.vault.azure.net │ └──────┬──────────┘ │ ACCESSIBLE │ │ │ │ Chisel tunnel │ ↓ (HTTPS/WebSocket) │ ┌──────▼──────────┐ │ │ Local Machine │ ←────────────┘ │ (Chisel Client) │ └─────────────────┘","excerpt":"BEFORE Chisel: ┌──────────────┐ ┌──────────────┐ │ GitHub Runner │ ──OIDC──> │ Azure ARM API │ │ (Public) │ │ mgmt.azure.com│ └──────────────┘ └──────┬───────┘ │ │ Creates resources ↓ ┌──────────────┐ ┌──────▼───────┐ │…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"how-chisel-works-technical-deep-dive","sectionTitle":"How Chisel Works (Technical Deep Dive)","text":"Step 1: App Service Deployment (Control Plane - Works with OIDC) From initial-setup/infra/modules/azure-proxy/main.tf : resource \"azurerm_linux_web_app\" \"azure_proxy\" { name = \"${var.app_name}-${var.app_env}-azure-proxy-${random_string.proxy_dns_suffix.result}\" resource_group_name = var.resource_group_name location = var.location service_plan_id = azurerm_service_plan.azure_proxy_asp.id // ✓ KEY: VNet Integration virtual_network_subnet_id = var.app_service_subnet_id // ✓ KEY: Managed Identity for Docker pulls identity { type = \"SystemAssigned\" } site_config { application_stack { docker_image_name = var.azure_proxy_image docker_registry_url = var.container_registry_url } } app_settings = { // ✓ KEY: Chisel authentication CHISEL_AUTH = \"${random_uuid.proxy_chisel_username.result}:${random_password.proxy_chisel_password.result}\" } } // ✓ This WORKS with OIDC because: // 1. Creates App Service (management.azure.com) ✓ // 2. Pulls Docker image (docker.io) ✓ // 3. Deploys to App Service (management.azure.com) ✓ // 4. Integrates with VNet (management.azure.com) ✓ Step 2: Chisel Server Runs in App Service From azure-proxy/chisel/start-chisel.sh : #!/bin/sh set -e # Chisel runs as a server inside the App Service # Listens on port 80 (configured by PORT env var) chisel server \\ --port $PORT \\ --auth $CHISEL_AUTH \\ --socks5 \\ --reverse # What this does: # --port 80: Listen on HTTP (App Service handles HTTPS termination) # --auth: Require authentication (prevents unauthorized access) # --socks5: Enable SOCKS5 proxy (for general traffic) # --reverse: Enable reverse tunneling (clients can expose local ports) Step 3: Local Machine Connects From azure-proxy/chisel/README.md : # Developer runs this on their laptop: docker run --rm -it -p 5462:5432 jpillora/chisel:latest client \\ --auth \"tunnel:XXXXXXX\" \\ https://${azure-proxy-app-service-url} \\ 0.0.0.0:5432:${postgres_hostname}$:5432 # What happens: # 1. Chisel client on laptop connects to Chisel server in App Service # 2. Connection goes: laptop → Internet → App Service (public) # 3. App Service is VNet-integrated # 4. Chisel forwards: laptop:5432 → App Service → VNet → postgres:5432 Step 4: Traffic Flow with Private Endpoints ┌──────────────┐ │ Laptop │ │ Chisel Client│ │ Port 5432 │ └──────┬───────┘ │ │ 1. Connect to App Service │ HTTPS / WebSocket ↓ ┌──────▼──────────┐ │ App Service │ │ (Chisel Server) │ │ Public endpoint │ │ VNet integrated │ └──────┬──────────┘ │ │ 2. Inside VNet │ Private IPs ↓ ┌──────▼──────────────────┐ │ Private Endpoint │ │ Subnet │ │ Routes to: │ │ myvault.vault.azure.net │ └──────┬──────────────────┘ │ │ 3. Data plane access │ *.vault.azure.net ↓ ┌──────▼──────────┐ │ Key Vault │ │ Data operations │ │ - Get secrets │ │ - Set secrets │ │ - List secrets │ └────────────────┘ ✓ SUCCESS: Terraform can read/write secrets!","excerpt":"Step 1: App Service Deployment (Control Plane - Works with OIDC) From initial-setup/infra/modules/azure-proxy/main.tf : resource \"azurerm_linux_web_app\" \"azure_proxy\" { name =…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"why-chisel-vs-alternatives","sectionTitle":"Why Chisel vs Alternatives?","text":"Method Cost Setup Use Case Limitations Bastion + Jumpbox $200-300/mo High Admin access, full VM Expensive, overkill for single developer Self-hosted Runner $100/mo Medium CI/CD with secrets Always running, needs management Chisel + App Service $15/mo Low Local dev, on-demand access Manual connection needed","excerpt":"Method Cost Setup Use Case Limitations Bastion + Jumpbox $200-300/mo High Admin access, full VM Expensive, overkill for single developer Self-hosted Runner $100/mo Medium CI/CD with secrets Always running, needs…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"deployment-scenarios","sectionTitle":"5. Deployment Scenarios: Who Needs What","text":"","excerpt":""},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"scenario-1-platform-team-deploys-landing-zone","sectionTitle":"Scenario 1: Platform Team (Deploys Landing Zone)","text":"Who: Platform Services Team, Infrastructure Admins What they deploy: ✓ Network (VNets, subnets, NSGs) ✓ Key Vault + Private Endpoints ✓ App Service Plans + Azure Proxy (Chisel) ✓ Bastion + Jumpbox (optional) ✓ Self-hosted runners (optional) ✓ API Management, App Gateway ✓ Azure AI Foundry When they need data plane access: Creating Key Vault secrets (initial setup) Testing private endpoints Debugging network connectivity Manual secret rotation Recommended access method: Option 1: Chisel tunnel ($15/mo) - for most developers Option 2: Bastion + Jumpbox ($200-300/mo) - for admins who need full VM Option 3: GitHub-hosted runners + Chisel tunnel — for CI/CD (use .deployer-using-secure-tunnel )","excerpt":"Who: Platform Services Team, Infrastructure Admins What they deploy: ✓ Network (VNets, subnets, NSGs) ✓ Key Vault + Private Endpoints ✓ App Service Plans + Azure Proxy (Chisel) ✓ Bastion + Jumpbox (optional) ✓…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"scenario-2-project-teams-deploy-applications","sectionTitle":"Scenario 2: Project Teams (Deploy Applications)","text":"Who: Ministry Application Teams What they deploy: ✓ App Service Plans (their apps) ✓ Container Apps (their workloads) ✓ Storage Accounts (their data) ✓ Application Code What they DON'T deploy: ✗ Network infrastructure (provided by platform) ✗ Bastion/Jumpbox (platform team maintains) ✗ Chisel (platform team provides endpoint) ✗ Key Vault (may use shared or create their own) ✗ Private endpoints (configured by platform) When they need data plane access: Reading secrets from Key Vault (their app needs secrets) Writing secrets during deployment Testing their apps against private endpoints Recommended access method: Use platform's Chisel endpoint - provided by platform team Public GitHub runners - for control plane operations No self-hosted needed - platform provides infrastructure","excerpt":"Who: Ministry Application Teams What they deploy: ✓ App Service Plans (their apps) ✓ Container Apps (their workloads) ✓ Storage Accounts (their data) ✓ Application Code What they DON'T deploy: ✗ Network infrastructure…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"scenario-3-solo-developer","sectionTitle":"Scenario 3: Solo Developer","text":"Who: Single developer, proof-of-concept work What they deploy: ✓ Their application code ✓ Minimal infrastructure if needed Recommended setup: Chisel tunnel only ($15/mo) - connect laptop to VNet Public GitHub runners (free) - for infrastructure deploys Skip: ✗ Bastion + Jumpbox ($200-300/mo) - too expensive ✗ Self-hosted runners ($100/mo) - not needed for solo work","excerpt":"Who: Single developer, proof-of-concept work What they deploy: ✓ Their application code ✓ Minimal infrastructure if needed Recommended setup: Chisel tunnel only ($15/mo) - connect laptop to VNet Public GitHub runners…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"summary","sectionTitle":"Summary","text":"","excerpt":""},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"why-we-need-key-vault-access","sectionTitle":"Why We Need Key Vault Access","text":"Security: Private endpoints prevent public access to secrets Compliance: BC Gov requires zero-trust, no public data plane access Operations: Applications need to read secrets at runtime Automation: Terraform needs to write secrets during deployment","excerpt":"Security: Private endpoints prevent public access to secrets Compliance: BC Gov requires zero-trust, no public data plane access Operations: Applications need to read secrets at runtime Automation: Terraform needs to…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"why-oidc-alone-isnt-enough","sectionTitle":"Why OIDC Alone Isn't Enough","text":"OIDC provides access to management.azure.com (control plane) Private endpoints block *.vault.azure.net (data plane) GitHub runners have no route to VNet private IPs Even with valid tokens, network access is required","excerpt":"OIDC provides access to management.azure.com (control plane) Private endpoints block *.vault.azure.net (data plane) GitHub runners have no route to VNet private IPs Even with valid tokens, network access is required"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"how-chisel-solves-this","sectionTitle":"How Chisel Solves This","text":"App Service runs in VNet (via VNet integration) Chisel server in App Service bridges public → private Developer connects laptop to App Service via HTTPS Traffic flows: laptop → App Service → VNet → private endpoints Result: Data plane access without exposing services publicly","excerpt":"App Service runs in VNet (via VNet integration) Chisel server in App Service bridges public → private Developer connects laptop to App Service via HTTPS Traffic flows: laptop → App Service → VNet → private endpoints…"},{"page":"technical-deep-dive.html","pageTitle":"Technical Deep Dive: Control vs Data Plane & Chisel Architecture","sectionId":"when-to-use-each-method","sectionTitle":"When to Use Each Method","text":"Platform Team: Deploy all, use Chisel or Bastion for access Project Teams: Deploy apps only, use platform's Chisel Solo Dev: Deploy minimal, use Chisel only CI/CD with secrets: Use GitHub-hosted runners + Chisel tunnel ( .deployer-using-secure-tunnel workflow) Admin work: Use Bastion + Jumpbox AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"Platform Team: Deploy all, use Chisel or Bastion for access Project Teams: Deploy apps only, use platform's Chisel Solo Dev: Deploy minimal, use Chisel only CI/CD with secrets: Use GitHub-hosted runners + Chisel tunnel (…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"terraform-reference","sectionTitle":"Terraform Reference","text":"🤖 Auto-Generated Documentation This page is automatically generated from Terraform source files. Run ./docs/generate-tf-docs.sh to update. Complete reference documentation for all Terraform modules, variables, and outputs extracted directly from the source code.","excerpt":"🤖 Auto-Generated Documentation This page is automatically generated from Terraform source files. Run ./docs/generate-tf-docs.sh to update. Complete reference documentation for all Terraform modules, variables, and…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"initial-setup","sectionTitle":"Initial Setup","text":"Network foundation: VNet, Bastion, Jumpbox, self-hosted runners.","excerpt":"Network foundation: VNet, Bastion, Jumpbox, self-hosted runners."},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"ai-services-hub","sectionTitle":"AI Services Hub","text":"AI platform: APIM, AI Foundry, tenants, key rotation, WAF.","excerpt":"AI platform: APIM, AI Foundry, tenants, key rotation, WAF."},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"section-initial-setup","sectionTitle":"Initial Setup ( initial-setup/infra/ )","text":"Network foundation layer &mdash; VNet, Bastion, Jumpbox, and self-hosted GitHub runners. Deployed once per environment via initial-setup/infra/deploy-terraform.sh .","excerpt":"Network foundation layer &mdash; VNet, Bastion, Jumpbox, and self-hosted GitHub runners. Deployed once per environment via initial-setup/infra/deploy-terraform.sh ."},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"initial-root","sectionTitle":"Root Module","text":"------------- Location: initial-setup/infra/ Variables Name Type Default Description app_env string required Application environment (dev, test, prod) app_name string required Name of the application common_tags map(string) required Common tags to apply to all resources location string Canada Azure region for resources resource_group_name string required Name of the resource group subscription_id string required Azure subscription ID tenant_id string required Azure tenant ID use_oidc bool true Use OIDC for authentication vnet_address_space string required Address space for the virtual network, it is created by platform team vnet_name string required Name of the existing virtual network vnet_resource_group_name string required Resource group name where the virtual network exists client_id string required Azure client ID for the service principal github_runners_aca_enabled bool false Enable GitHub self-hosted runners on Azure Container Apps github_organization string required GitHub organization name (e.g., 'bcgov') github_repository string required GitHub repository name (e.g., 'ai-hub-tracking') github_runner_pat string required GitHub Personal Access Token with Administration:write permission for runner registration github_runners_container_cpu string 1 CPU cores for each runner container github_runners_container_memory string 2Gi Memory for each runner container (e.g., '4Gi') github_runners_max_count number 4 Maximum number of concurrent runners github_runners_log_analytics_workspace_creation_enabled bool true Whether the GitHub runners module should create a Log Analytics workspace github_runners_log_analytics_workspace_id string null Existing Log Analytics workspace ID to use when workspace creation is disabled dev_address_spaces list(string) [] Address space for the dev environment of the vnet peering prod_address_spaces list(string) [] Address space for the prod environment of the vnet peering test_address_spaces list(string) [] Address space for the test environment of the vnet peering azure_proxy_image string required The image for the Azure Proxy container app_service_sku_name_azure_proxy string P0v4 The SKU name for the azure proxy App Service plan. enable_azure_proxy bool false Enable deployment of the Azure Proxy App Service enable_bastion bool false Enable deployment of the Azure Bastion host enable_jumpbox bool false Enable deployment of the Azure Jumpbox VM log_analytics_retention_days number 30 Number of days to retain data in Log Analytics Workspace log_analytics_sku string PerGB2018 SKU for Log Analytics Workspace Outputs Name Description jumpbox_vm_id ID of the jumpbox virtual machine jumpbox_vm_name Name of the jumpbox virtual machine jumpbox_admin_username Admin username for SSH access to jumpbox jumpbox_auto_shutdown_time Auto-shutdown time (PST) jumpbox_auto_start_schedule Auto-start schedule (PST) bastion_resource_id Resource ID of Azure Bastion bastion_fqdn FQDN of the Bastion service github_runners_environment_name Name of the Container App Environment for GitHub runners github_runners_job_name Name of the Container App Job running the GitHub runner github_runners_label The label to use in workflow runs-on to target these runners github_runners_acr_name Name of the Azure Container Registry for runner images proxy_url URL of the Azure Proxy service proxy_auth Authentication info for the Azure Proxy service Resources Created azurerm_resource_group (main)","excerpt":"------------- Location: initial-setup/infra/ Variables Name Type Default Description app_env string required Application environment (dev, test, prod) app_name string required Name of the application common_tags…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"initial-azure-proxy","sectionTitle":"azure-proxy","text":"Location: initial-setup/infra/modules/azure-proxy/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description app_env string required The deployment environment (e.g., dev, test, prod). app_name string required The base name of the application. Used for naming Azure resources. app_service_subnet_id string required The subnet ID for the App Service. appinsights_connection_string string required The Application Insights connection string for monitoring. appinsights_instrumentation_key string required The Application Insights instrumentation key. common_tags map(string) {} A map of tags to apply to resources. container_registry_url string https://ghcr.io The URL of the container registry to pull images from. location string required The Azure region where resources will be created. log_analytics_workspace_id string required The resource ID of the Log Analytics workspace for diagnostics. repo_name string required The repository name, used for resource naming. resource_group_name string required The name of the resource group in which to create resources. azure_proxy_image string required The image for the Azure DB Proxy container app_service_sku_name_azure_proxy string required The SKU name for the azure db proxy App Service plan. Outputs Name Description proxy_url The URL of the Azure Proxy App Service proxy_auth The authentication string for the Azure Proxy Resources Created azurerm_service_plan (azure_proxy_asp) random_uuid (proxy_chisel_username) random_password (proxy_chisel_password) azurerm_linux_web_app (azure_proxy) azurerm_monitor_diagnostic_setting (azure_proxy_diagnostics)","excerpt":"Location: initial-setup/infra/modules/azure-proxy/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description app_env string required The deployment environment (e.g., dev, test, prod).…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"initial-bastion","sectionTitle":"bastion","text":"----------------------------------------------------------------------------- Location: initial-setup/infra/modules/bastion/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description app_name string required Name of the application, used for resource naming resource_group_name string required Name of the resource group location string required Azure region for resources bastion_subnet_id string required Subnet ID for Azure Bastion (must be named AzureBastionSubnet) common_tags map(string) required Common tags to apply to all resources bastion_sku string Basic SKU for Azure Bastion (Basic or Standard) Outputs Name Description bastion_resource_id Resource ID of the Azure Bastion host bastion_fqdn FQDN of the Bastion host public_ip_address Public IP address of the Bastion host Resources Created azurerm_public_ip (bastion) azurerm_bastion_host (main)","excerpt":"----------------------------------------------------------------------------- Location: initial-setup/infra/modules/bastion/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"initial-github-runners-aca","sectionTitle":"github-runners-aca","text":"----------------------------------------------------------------------------- Location: initial-setup/infra/modules/github-runners-aca/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description enabled bool true Enable or disable the GitHub runners module postfix string required A postfix used to build default names for resources (e.g., 'ai-hub') location string required Azure region where resources will be deployed resource_group_name string required Name of the existing resource group common_tags map(string) {} Common tags to apply to all resources github_organization string required GitHub organization name (e.g., 'bcgov') github_repository string required GitHub repository name (e.g., 'ai-hub-tracking') github_runner_pat string required GitHub Personal Access Token with Administration:write permission for runner registration vnet_id string required ID of the existing virtual network container_app_subnet_id string required ID of the subnet for Container Apps (must be delegated to Microsoft.App/environments) private_endpoint_subnet_id string required ID of the subnet for private endpoints (used for ACR) container_cpu string 1 CPU cores for each runner container (e.g., 1, 2, 4) container_memory string 2Gi Memory for each runner container (e.g., '4Gi') max_runners number 4 Maximum number of concurrent runners log_analytics_workspace_creation_enabled bool true Whether the AVM runner module should create a Log Analytics workspace log_analytics_workspace_id string null Existing Log Analytics workspace ID to use when creation is disabled Outputs Name Description container_app_environment_name Name of the Container App Environment container_app_environment_id Resource ID of the Container App Environment container_app_job_name Name of the Container App Job running the GitHub runner container_app_job_id Resource ID of the Container App Job container_registry_name Name of the Azure Container Registry container_registry_login_server Login server URL of the Azure Container Registry runner_label The label to use in workflow runs-on to target these runners (use just 'self-hosted' for AVM-based runners)","excerpt":"----------------------------------------------------------------------------- Location: initial-setup/infra/modules/github-runners-aca/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"initial-jumpbox","sectionTitle":"jumpbox","text":"----------------------------------------------------------------------------- Location: initial-setup/infra/modules/jumpbox/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description app_name string required Name of the application, used for resource naming resource_group_name string required Name of the resource group location string required Azure region for resources subnet_id string required Subnet ID for the jumpbox VM common_tags map(string) required Common tags to apply to all resources vm_size string Standard_B2als_v2 Size of the virtual machine (B2als_v2: 2 vCPU, 4 GB RAM - cost-effective for jumpbox) os_disk_type string Standard_LRS Storage account type for the OS disk os_disk_size_gb number 64 Size of the OS disk in GB Outputs Name Description vm_id ID of the jumpbox virtual machine vm_name Name of the jumpbox virtual machine private_ip_address Private IP address of the jumpbox VM admin_username Admin username for SSH access principal_id Principal ID of the VM's managed identity ssh_public_key_id Resource ID of the SSH public key in Azure ssh_private_key_path Local path to the SSH private key file automation_account_id ID of the Azure Automation Account for VM scheduling auto_shutdown_time Auto-shutdown time (PST) auto_start_schedule Auto-start schedule Resources Created azapi_resource_action (ssh_public_key_gen) azapi_resource (ssh_public_key) random_string (admin_username) azurerm_network_interface (jumpbox) azurerm_linux_virtual_machine (jumpbox) local_sensitive_file (ssh_private_key) azurerm_dev_test_global_vm_shutdown_schedule (jumpbox) azurerm_automation_account (jumpbox) azurerm_automation_runbook (start_vm) azurerm_automation_schedule (weekday_start) azurerm_automation_job_schedule (start_vm) azurerm_role_assignment (automation_vm_contributor)","excerpt":"----------------------------------------------------------------------------- Location: initial-setup/infra/modules/jumpbox/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"initial-monitoring","sectionTitle":"monitoring","text":"Log Analytics Workspace Location: initial-setup/infra/modules/monitoring/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description app_name string required Name of the application common_tags map(string) required Common tags to apply to all resources location string Canada Azure region for resources log_analytics_retention_days number 30 Number of days to retain data in Log Analytics Workspace log_analytics_sku string PerGB2018 SKU for Log Analytics Workspace Outputs Name Description appinsights_connection_string The Application Insights connection string. appinsights_instrumentation_key The Application Insights instrumentation key. log_analytics_workspace_id The resource ID of the Log Analytics workspace. log_analytics_workspace_key The primary shared key for the Log Analytics workspace. log_analytics_workspace_workspaceId The name of the Log Analytics workspace. Resources Created azurerm_log_analytics_workspace (main) azurerm_application_insights (main)","excerpt":"Log Analytics Workspace Location: initial-setup/infra/modules/monitoring/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description app_name string required Name of the application…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"initial-network","sectionTitle":"network","text":"Location: initial-setup/infra/modules/network/ Files (5) locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description apps_service_subnet_name string app-service-subnet Name of the subnet for App Services common_tags map(string) required Common tags to apply to all resources container_instance_subnet_name string container-instance-subnet Name of the subnet for container instances container_apps_subnet_name string container-apps-subnet Name of the subnet for Container Apps location string Canada Azure region for resources private_endpoint_subnet_name string privateendpoints-subnet Name of the subnet for private endpoints resource_group_name string required Name of the resource group vnet_address_space string required Address space for the virtual network, it is created by platform team vnet_name string required Name of the existing virtual network vnet_resource_group_name string required Resource group name where the virtual network exists web_subnet_name string web-subnet Name of the web subnet for APIM deployment apim_subnet_name string apim-subnet Name of the subnet for API Management jumpbox_subnet_name string jumpbox-subnet Name of the subnet for Jumpbox VM bastion_subnet_name string AzureBastionSubnet Name of the subnet for Azure Bastion (must be AzureBastionSubnet) dev_address_spaces list(string) [] Address space for the dev environment of the vnet peering prod_address_spaces list(string) [] Address space for the prod environment of the vnet peering test_address_spaces list(string) [] Address space for the test environment of the vnet peering Outputs Name Description container_instance_subnet_id The subnet ID for the container instance. app_service_subnet_id The subnet ID for the App Service. private_endpoint_subnet_id The subnet ID for private endpoints. container_apps_subnet_id The subnet ID for Container Apps Environment. apim_subnet_id The subnet ID for API Management. jumpbox_subnet_id The subnet ID for the Jumpbox VM. bastion_subnet_id The subnet ID for Azure Bastion. dns_servers The DNS servers for the virtual network. vnet_id ID of the virtual network vnet_name Name of the virtual network Resources Created azurerm_network_security_group (privateendpoints) azurerm_network_security_group (app_service) azurerm_network_security_group (container_instance) azurerm_network_security_group (container_apps) azurerm_network_security_group (apim) azapi_resource (privateendpoints_subnet) azapi_resource (app_service_subnet) azapi_resource (container_instance_subnet) azapi_resource (container_apps_subnet) azapi_resource (apim_subnet) azurerm_network_security_group (jumpbox) azapi_resource (jumpbox_subnet) azurerm_network_security_group (bastion) azapi_resource (bastion_subnet)","excerpt":"Location: initial-setup/infra/modules/network/ Files (5) locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description apps_service_subnet_name string app-service-subnet Name of the subnet…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"section-ai-hub","sectionTitle":"AI Services Hub ( infra-ai-hub/ )","text":"Multi-tenant AI platform deployed via 5 isolated Terraform stacks with parallel execution. See ADR-013 for architecture rationale.","excerpt":"Multi-tenant AI platform deployed via 5 isolated Terraform stacks with parallel execution. See ADR-013 for architecture rationale."},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"ai-hub-stacks","sectionTitle":"Stacks","text":"Each stack has its own state file and backend configuration. Deployed in dependency order: shared &rarr; tenant (parallel) &rarr; foundry + apim + tenant-user-mgmt (parallel).","excerpt":"Each stack has its own state file and backend configuration. Deployed in dependency order: shared &rarr; tenant (parallel) &rarr; foundry + apim + tenant-user-mgmt (parallel)."},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"stack-shared","sectionTitle":"shared","text":"Location: infra-ai-hub/stacks/shared/ Files (6) backend.tf locals.tf main.tf outputs.tf providers.tf variables.tf Variables Name Type Default Description app_env string required Application environment app_name string required Application name prefix location string required Azure region resource_group_name string required Shared resource group name common_tags map(string) {} Common tags subscription_id string required Azure subscription ID tenant_id string required Azure tenant ID client_id string required Azure client ID use_oidc bool true Use OIDC vnet_name string required Landing zone VNet name vnet_resource_group_name string required Landing zone VNet resource group target_vnet_address_spaces list(string) required Target VNet address spaces source_vnet_address_space string required Source VNet address space private_endpoint_subnet_name string privateendpoints-subnet Private endpoint subnet name shared_config any required Shared environment config defender_enabled bool false Enable Defender for Cloud plans defender_resource_types map(object({ {} Defender for Cloud resource types and subplans backend_resource_group string required Backend resource group (unused by shared stack logic, accepted for command consistency) backend_storage_account string required Backend storage account (unused by shared stack logic, accepted for command consistency) backend_container_name string tfstate Backend container name (unused by shared stack logic, accepted for command consistency) Outputs Name Description resource_group_name No description resource_group_id No description private_endpoint_subnet_id No description private_endpoint_subnet_cidr No description private_endpoint_nsg_id No description apim_subnet_id No description appgw_subnet_id No description ai_foundry_hub_id No description ai_foundry_hub_name No description ai_foundry_hub_endpoint No description ai_foundry_hub_principal_id No description log_analytics_workspace_id No description application_insights_id No description application_insights_connection_string No description application_insights_instrumentation_key No description language_service_id No description language_service_endpoint No description hub_key_vault_id No description hub_key_vault_name No description hub_key_vault_uri No description dns_zone_public_ip_id No description dns_zone_public_ip_address No description waf_policy_id No description app_gateway_id No description app_gateway_name No description appgw_url App Gateway frontend URL (https:// ). Null when App Gateway is not deployed. Resources Created azurerm_resource_group (main) azurerm_cognitive_account (language_service) azurerm_private_endpoint (language_service) terraform_data (language_service_dns_wait) terraform_data (hub_kv_dns_wait)","excerpt":"Location: infra-ai-hub/stacks/shared/ Files (6) backend.tf locals.tf main.tf outputs.tf providers.tf variables.tf Variables Name Type Default Description app_env string required Application environment app_name string…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"stack-tenant","sectionTitle":"tenant","text":"Location: infra-ai-hub/stacks/tenant/ Files (6) backend.tf locals.tf main.tf outputs.tf providers.tf variables.tf Variables Name Type Default Description app_env string required No description location string required No description common_tags map(string) {} No description subscription_id string required No description tenant_id string required No description client_id string required No description use_oidc bool true No description shared_config any required No description tenants map(any) {} No description backend_resource_group string required No description backend_storage_account string required No description backend_container_name string tfstate No description Outputs Name Description tenant_resource_groups No description tenant_key_vaults No description tenant_storage_accounts No description tenant_ai_search No description tenant_cosmos_db No description tenant_document_intelligence No description tenant_speech_services No description tenant_log_analytics No description tenant_enabled_resources No description","excerpt":"Location: infra-ai-hub/stacks/tenant/ Files (6) backend.tf locals.tf main.tf outputs.tf providers.tf variables.tf Variables Name Type Default Description app_env string required No description location string required No…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"stack-foundry","sectionTitle":"foundry","text":"Location: infra-ai-hub/stacks/foundry/ Files (6) backend.tf locals.tf main.tf outputs.tf providers.tf variables.tf Variables Name Type Default Description app_env string required No description location string required No description common_tags map(string) {} No description subscription_id string required No description tenant_id string required No description client_id string required No description use_oidc bool true No description shared_config any required No description tenants map(any) {} No description backend_resource_group string required No description backend_storage_account string required No description backend_container_name string tfstate No description Outputs Name Description tenant_projects No description tenant_ai_model_deployments No description","excerpt":"Location: infra-ai-hub/stacks/foundry/ Files (6) backend.tf locals.tf main.tf outputs.tf providers.tf variables.tf Variables Name Type Default Description app_env string required No description location string required…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"stack-apim","sectionTitle":"apim","text":"Location: infra-ai-hub/stacks/apim/ Files (6) backend.tf locals.tf main.tf outputs.tf providers.tf variables.tf Variables Name Type Default Description app_env string required No description app_name string required No description location string required No description common_tags map(string) {} No description subscription_id string required No description tenant_id string required No description client_id string required No description use_oidc bool true No description shared_config any required No description tenants map(any) {} No description defender_enabled bool false No description defender_resource_types map(object({ {} No description backend_resource_group string required No description backend_storage_account string required No description backend_container_name string tfstate No description Outputs Name Description apim_gateway_url No description apim_name No description apim_key_rotation_summary No description apim_tenant_subscriptions No description Resources Created azurerm_api_management_named_value (ai_foundry_endpoint) azurerm_api_management_named_value (openai_endpoint) azurerm_api_management_named_value (docint_endpoint) azurerm_api_management_named_value (storage_endpoint) azurerm_api_management_named_value (ai_search_endpoint) azurerm_api_management_named_value (speech_services_endpoint) azurerm_api_management_named_value (pii_service_url) azurerm_api_management_backend (ai_foundry) azurerm_api_management_backend (openai) azurerm_api_management_backend (docint) azurerm_api_management_backend (storage) azurerm_api_management_backend (ai_search) azurerm_api_management_backend (speech_services_stt) azurerm_api_management_backend (speech_services_tts) azurerm_api_management_named_value (speech_services_key) azurerm_api_management_logger (app_insights) azurerm_api_management_diagnostic (app_insights) azurerm_api_management_logger (tenant_app_insights) azurerm_api_management_api_diagnostic (tenant) azurerm_api_management_policy_fragment (cognitive_services_auth) azurerm_api_management_policy_fragment (storage_auth) azurerm_api_management_policy_fragment (keyvault_auth) azurerm_api_management_policy_fragment (openai_usage_logging) azurerm_api_management_policy_fragment (openai_streaming_metrics) azurerm_api_management_policy_fragment (pii_anonymization) azurerm_api_management_policy_fragment (intelligent_routing) azurerm_api_management_policy_fragment (tracking_dimensions) azurerm_api_management_api_policy (tenant) azurerm_role_assignment (apim_openai_user) azurerm_role_assignment (apim_docint_user) azurerm_role_assignment (apim_storage_reader) azurerm_role_assignment (apim_search_contributor) azurerm_role_assignment (apim_search_service_contributor) azurerm_role_assignment (apim_speech_services_user) azurerm_role_assignment (apim_language_service_user) azurerm_role_assignment (apim_keyvault_secrets_user) azurerm_api_management_subscription (tenant) azurerm_key_vault_secret (apim_subscription_primary_key) azurerm_key_vault_secret (apim_subscription_secondary_key) azurerm_key_vault_secret (apim_rotation_metadata) azurerm_api_management_api (landing_page) azurerm_api_management_api_operation (landing_page_get) azurerm_api_management_api_policy (landing_page) azurerm_api_management_api_operation (tenant_methods) azurerm_api_management_product_api (tenant) azapi_resource (defender_api_collection)","excerpt":"Location: infra-ai-hub/stacks/apim/ Files (6) backend.tf locals.tf main.tf outputs.tf providers.tf variables.tf Variables Name Type Default Description app_env string required No description app_name string required No…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"stack-tenant-user-mgmt","sectionTitle":"tenant-user-mgmt","text":"Location: infra-ai-hub/stacks/tenant-user-mgmt/ Files (6) backend.tf locals.tf main.tf outputs.tf providers.tf variables.tf Variables Name Type Default Description app_env string required Application environment (dev, test, prod) subscription_id string required Azure subscription ID tenant_id string required Azure tenant ID client_id string required Azure client ID for the service principal (OIDC) use_oidc bool true Use OIDC for authentication tenants any {} Tenant configurations (reuses the same tfvars as the main config) backend_resource_group string required Backend resource group (accepted for shared deploy command contract) backend_storage_account string required Backend storage account (accepted for shared deploy command contract) backend_container_name string tfstate Backend container name (accepted for shared deploy command contract) Outputs Name Description tenant_user_management Map of tenant names to their Entra group IDs and custom role definition IDs","excerpt":"Location: infra-ai-hub/stacks/tenant-user-mgmt/ Files (6) backend.tf locals.tf main.tf outputs.tf providers.tf variables.tf Variables Name Type Default Description app_env string required Application environment (dev,…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"ai-hub-modules","sectionTitle":"Modules","text":"Reusable modules consumed by the stacks above. Each module wraps Azure Verified Modules (AVM) or native azurerm / azapi resources.","excerpt":"Reusable modules consumed by the stacks above. Each module wraps Azure Verified Modules (AVM) or native azurerm / azapi resources."},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-ai-foundry-hub","sectionTitle":"ai-foundry-hub","text":"AI Foundry Hub Module Location: infra-ai-hub/modules/ai-foundry-hub/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the AI Foundry account resource_group_name string required Name of the resource group resource_group_id string required Resource ID of the resource group location string required Azure region for supporting resources (Log Analytics, App Insights, Private Endpoints) ai_location string null Azure region for AI Foundry Hub. Can differ from location for model availability (e.g., canadaeast for GPT-4.1). Defaults to location. sku string S0 SKU for the AI Foundry account public_network_access_enabled bool false Whether public network access is enabled local_auth_enabled bool false Whether local authentication (API keys) is enabled private_endpoint_subnet_id string required Subnet ID for private endpoints log_analytics object({ { Log Analytics workspace configuration application_insights optional(string, { Application Insights configuration for AI Foundry monitoring ai_agent object({ { AI Agent service configuration with network injection support bing_grounding object({ { Bing Web Search resource for grounding AI models private_endpoint_dns_wait object({ {} Configuration for waiting on policy-managed DNS zone groups scripts_dir string required Path to the scripts directory containing wait-for-dns-zone.sh purge_on_destroy bool false Whether to permanently purge the AI Foundry account on destroy (bypasses soft delete) purge_wait object({ {} Wait configuration for AI Foundry soft-delete before purge tags map(string) {} Tags to apply to resources Outputs Name Description id Resource ID of the AI Foundry account name Name of the AI Foundry account ai_location Azure region where the AI Foundry Hub is deployed (may differ from PE location) endpoint Primary endpoint of the AI Foundry account principal_id Principal ID of the system-assigned managed identity tenant_id Tenant ID of the system-assigned managed identity private_endpoint_id Resource ID of the private endpoint private_endpoint_ip Private IP address of the private endpoint log_analytics_workspace_id Resource ID of the Log Analytics workspace (if created or provided) application_insights_id Resource ID of Application Insights (if enabled) application_insights_connection_string Connection string for Application Insights (if enabled) application_insights_instrumentation_key Instrumentation key for Application Insights (if enabled, deprecated - use connection_string) ai_agent_id Resource ID of the AI Agent service (if enabled) ai_agent_principal_id Principal ID of the AI Agent's managed identity bing_grounding_id Resource ID of the Bing Grounding resource (if enabled) bing_grounding_endpoint Endpoint of the Bing Grounding resource (if enabled) Resources Created azurerm_log_analytics_workspace (this) azurerm_application_insights (this) azapi_resource (ai_foundry) azurerm_private_endpoint (ai_foundry) null_resource (wait_for_dns) azurerm_monitor_diagnostic_setting (ai_foundry) azapi_resource (ai_agent) azurerm_private_endpoint (ai_agent) null_resource (wait_for_dns_ai_agent) azurerm_cognitive_account (bing_grounding) null_resource (purge_ai_foundry)","excerpt":"AI Foundry Hub Module Location: infra-ai-hub/modules/ai-foundry-hub/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the AI Foundry account…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-apim","sectionTitle":"apim","text":"API Management Module (stv2) Location: infra-ai-hub/modules/apim/ Files (5) locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the API Management instance resource_group_name string required Name of the resource group location string required Azure region for resources sku_name string StandardV2_1 SKU name for APIM (stv2). StandardV2_1-10 for cost-effective, PremiumV2_1-30 for VNet injection and advanced features. publisher_name string required Publisher name for APIM publisher_email string required Publisher email for APIM public_network_access_enabled bool true Whether public network access is enabled for APIM. Set to false to restrict access to private endpoints only. enable_private_endpoint bool false Whether to create a private endpoint for APIM inbound access. Must be set explicitly to avoid plan-time evaluation issues. private_endpoint_subnet_id string null Subnet ID for APIM private endpoint (stv2). Required when enable_private_endpoint is true. private_dns_zone_ids list(string) [] List of private DNS zone IDs to link for APIM private endpoint enable_vnet_integration bool false Whether to enable VNet integration for outbound connectivity. Required when backend services have public network access disabled. vnet_integration_subnet_id string null Subnet ID for APIM VNet integration (outbound). Required when enable_vnet_integration is true. Subnet must have delegation to Microsoft.Web/hostingEnvironments. enable_diagnostics bool false Whether to enable diagnostic settings. Must be set explicitly to avoid plan-time evaluation issues. log_analytics_workspace_id string null Log Analytics Workspace ID for diagnostics. Required when enable_diagnostics is true. tenant_products map(object({ {} Map of tenant names to their product configurations tags map(string) {} Tags to apply to resources enable_telemetry bool false Enable AVM telemetry apis optional(string, {} Map of APIs to create in APIM subscriptions string {} Map of subscriptions to create named_values map(object({ {} Map of named values (properties) for APIM policy_fragments map(object({ {} Map of reusable policy fragments global_policy_xml string null XML content for the global API Management policy scripts_dir string required Path to the scripts directory containing wait-for-dns-zone.sh private_endpoint_dns_wait object({ {} Configuration for waiting on policy-managed DNS zone groups Outputs Name Description id Resource ID of the API Management instance name Name of the API Management instance gateway_url Gateway URL of the API Management instance management_url Management URL of the API Management instance developer_portal_url Developer portal URL private_ip_addresses Private IP addresses of APIM (when VNet integrated) public_ip_addresses Public IP addresses of APIM product_ids Map of product names to their resource IDs principal_id Principal ID of the APIM managed identity private_endpoint_ip Private IP address of the APIM private endpoint Resources Created azurerm_api_management_policy (global) null_resource (wait_for_dns_apim)","excerpt":"API Management Module (stv2) Location: infra-ai-hub/modules/apim/ Files (5) locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the API Management…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-app-configuration","sectionTitle":"app-configuration","text":"App Configuration Module Location: infra-ai-hub/modules/app-configuration/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the App Configuration store resource_group_name string required Name of the resource group location string required Azure region for resources sku string standard SKU for App Configuration (free or standard) public_network_access_enabled bool false Enable public network access local_auth_enabled bool false Enable local authentication (access keys) purge_protection_enabled bool true Enable purge protection soft_delete_retention_days number 7 Soft delete retention in days (1-7) private_endpoint_subnet_id string null Subnet ID for private endpoint encryption object({ { Customer-managed key encryption configuration replicas list(object({ [] Geo-replication configuration (Standard SKU only) feature_flags map(object({ {} Feature flags to create configuration_keys optional(string) {} Configuration key-value pairs log_analytics_workspace_id string null Log Analytics Workspace ID for diagnostics scripts_dir string required Path to shared scripts directory for DNS wait operations private_endpoint_dns_wait object({ {} Configuration for waiting on policy-managed DNS zone groups tags map(string) {} Tags to apply to resources Outputs Name Description resource_id Resource ID of the App Configuration store name Name of the App Configuration store endpoint Endpoint of the App Configuration store primary_read_key Primary read key connection string principal_id Principal ID of the system-assigned managed identity private_endpoint_id Resource ID of the private endpoint Resources Created azurerm_app_configuration (this) azurerm_private_endpoint (app_config) azurerm_app_configuration_feature (features) azurerm_app_configuration_key (keys) azurerm_monitor_diagnostic_setting (app_config) null_resource (wait_for_dns_appconfig)","excerpt":"App Configuration Module Location: infra-ai-hub/modules/app-configuration/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the App Configuration…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-app-gateway","sectionTitle":"app-gateway","text":"Application Gateway Module Location: infra-ai-hub/modules/app-gateway/ Files (5) locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the Application Gateway resource_group_name string required Name of the resource group location string required Azure region for resources subnet_id string required Subnet ID for the Application Gateway sku object({ { SKU configuration for App Gateway autoscale object({ null Autoscale configuration (if set, overrides sku.capacity) waf_enabled bool true Enable Web Application Firewall waf_mode string Prevention WAF mode: Detection or Prevention ssl_certificates map(object({ {} SSL certificates — from Key Vault (key_vault_secret_id) or direct PFX upload (data+password). Certificates can also be uploaded via Azure Portal; Terraform will ignore changes to ssl_certificate blocks. ssl_certificate_name string null Name of an SSL certificate already on the App Gateway (uploaded via CLI/portal). When set, enables HTTPS listener and HTTP→HTTPS redirect. Only set after the cert has been uploaded to the App Gateway. backend_apim object({ required APIM backend configuration. The FQDN resolves to the PE private IP via private DNS zone linked to the App GW VNet. frontend_hostname string required Frontend hostname for the listener enable_diagnostics bool false Whether to enable diagnostic settings (use static bool to avoid count unknown at plan time) log_analytics_workspace_id string null Log Analytics Workspace ID for diagnostics key_vault_id string null Key Vault ID for SSL certificate access public_ip_resource_id string null Resource ID of a pre-created static Public IP for the App Gateway. When set, App GW uses this existing PIP. When null, this module does not create or associate any Public IP, and you must ensure a suitable frontend configuration (for example, a private frontend or an externally managed PIP). Typically provided by the dns-zone module. tags map(string) {} Tags to apply to resources zones set(string) [1, Availability zones for App Gateway url_path_map_configurations map(object({ null URL path maps for path-based routing rewrite_rule_set map(object({ null Rewrite rule sets for header and URL manipulation waf_policy_id string null Resource ID of WAF policy to associate with App Gateway Outputs Name Description id Resource ID of the Application Gateway name Name of the Application Gateway public_ip_address Public IP address of the Application Gateway. Returns null - get this from the dns_zone module output instead (dns_zone_public_ip) to avoid data source lookup failures during first deployment. public_ip_id Public IP resource ID backend_address_pools Backend address pools principal_id Principal ID of the App Gateway managed identity (user-assigned) Resources Created azurerm_user_assigned_identity (appgw) azurerm_role_assignment (appgw_to_keyvault) azurerm_application_gateway (this) azurerm_monitor_diagnostic_setting (appgw) null_resource (diag_destination_type_trigger)","excerpt":"Application Gateway Module Location: infra-ai-hub/modules/app-gateway/ Files (5) locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the Application…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-container-app-environment","sectionTitle":"container-app-environment","text":"Container App Environment Module Location: infra-ai-hub/modules/container-app-environment/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the Container App Environment resource_group_name string required Name of the resource group location string required Azure region for resources infrastructure_subnet_id string required Subnet ID for the Container App Environment infrastructure internal_load_balancer_enabled bool true Use internal load balancer (private only access) zone_redundancy_enabled bool false Enable zone redundancy. Requires /23+ subnet. Set to false for /27 consumption-only. mtls_enabled bool true Enable mTLS peer authentication between apps workload_profiles string [] Workload profiles for dedicated compute (Consumption-only if empty) log_analytics_workspace_id string null Log Analytics Workspace ID for diagnostics tags map(string) {} Tags to apply to resources enable_telemetry bool false Enable AVM telemetry Outputs Name Description resource_id Resource ID of the Container App Environment name Name of the Container App Environment default_domain Default domain of the Container App Environment static_ip_address Static IP address of the Container App Environment","excerpt":"Container App Environment Module Location: infra-ai-hub/modules/container-app-environment/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-container-registry","sectionTitle":"container-registry","text":"Container Registry Module Location: infra-ai-hub/modules/container-registry/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the Container Registry resource_group_name string required Name of the resource group location string required Azure region for resources sku string Premium SKU for Container Registry. Premium required for private endpoints and geo-replication. public_network_access_enabled bool true Enable public network access. Set to true for public ACR, false for private-only. private_endpoint_subnet_id string null Subnet ID for private endpoints. Required if public_network_access_enabled is false. admin_enabled bool false Enable admin user for the registry quarantine_policy_enabled bool false Enable quarantine policy for images data_endpoint_enabled bool false Enable dedicated data endpoints for each region export_policy_enabled bool true Enable export policy (allows images to be exported) zone_redundancy_enabled bool true Enable zone redundancy (Premium only) enable_trust_policy bool false Enable content trust / image signing (Premium only) retention_policy_days number 7 Days to retain untagged manifests (0 = disabled) georeplications map(object({ {} Geo-replication configuration for Premium SKU log_analytics_workspace_id string null Log Analytics Workspace ID for diagnostics scripts_dir string required Path to shared scripts directory for DNS wait operations private_endpoint_dns_wait object({ {} Configuration for waiting on policy-managed DNS zone groups resource_group_name_for_dns_wait string null Resource group name to use for DNS wait operations (where PE is created) tags map(string) {} Tags to apply to resources enable_telemetry bool false Enable AVM telemetry Outputs Name Description resource_id Resource ID of the Container Registry name Name of the Container Registry login_server Login server URL of the Container Registry principal_id Principal ID of the system-assigned managed identity private_endpoint_id Resource ID of the private endpoint Resources Created null_resource (wait_for_dns_acr)","excerpt":"Container Registry Module Location: infra-ai-hub/modules/container-registry/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the Container…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-defender","sectionTitle":"defender","text":"Microsoft Defender for Cloud Subscription Pricing Location: infra-ai-hub/modules/defender/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description resource_types map(object({ {} Map of Defender for Cloud resource types to enable with their configuration. Keys are resource type names (e.g., 'Api', 'StorageAccounts'), values are objects with subplan. Outputs Name Description enabled_resource_types List of Defender for Cloud resource types that are enabled pricing_ids Map of resource type to pricing resource ID Resources Created azurerm_security_center_subscription_pricing (this)","excerpt":"Microsoft Defender for Cloud Subscription Pricing Location: infra-ai-hub/modules/defender/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description resource_types map(object({ {} Map…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-dns-zone","sectionTitle":"dns-zone","text":"============================================================================= Location: infra-ai-hub/modules/dns-zone/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name_prefix string required Prefix for resource names (e.g., ai-hub-test) location string required Azure region for resources dns_zone_name string required DNS zone name (e.g., test.aihub.gov.bc.ca) resource_group_name string required Name of the DNS resource group a_record_ttl number 3600 TTL for the A record in seconds tags map(string) {} Tags to apply to resources Outputs Name Description dns_zone_id Resource ID of the DNS zone dns_zone_name Name of the DNS zone name_servers Name servers for the DNS zone (provide these to your DNS registrar for delegation) public_ip_id Resource ID of the static public IP (pass to App Gateway module) public_ip_address IP address of the static public IP resource_group_name Name of the DNS resource group resource_group_id Resource ID of the DNS resource group Resources Created azurerm_resource_group (dns) azurerm_dns_zone (this) azurerm_public_ip (appgw) azurerm_dns_a_record (apex)","excerpt":"============================================================================= Location: infra-ai-hub/modules/dns-zone/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-foundry-project","sectionTitle":"foundry-project","text":"============================================================================= Location: infra-ai-hub/modules/foundry-project/ Files (5) locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description tenant_name string required Name of the tenant (used for resource naming) location string required Azure region for the project ai_location string required Azure region for AI resources (can differ from project location for model availability) ai_foundry_hub_id string required Resource ID of the parent AI Foundry hub tags map(string) {} Tags to apply to resources key_vault object({ { Key Vault configuration from tenant module storage_account object({ { Storage account configuration from tenant module ai_search object({ { AI Search configuration from tenant module cosmos_db object({ { Cosmos DB configuration from tenant module document_intelligence object({ { Document Intelligence configuration from tenant module ai_model_deployments string {} AI model deployments to create on the shared AI Foundry Hub (prefixed with tenant name) project_connections object({ {} Toggle which project connections to create Outputs Name Description project_id Resource ID of the AI Foundry project project_name Name of the AI Foundry project project_principal_id Principal ID of the AI Foundry project's managed identity ai_model_deployment_ids Map of original model names to their resource IDs (deployment names are tenant-prefixed) ai_model_deployment_names List of deployed AI model names (tenant-prefixed, e.g., 'wlrs-gpt-4.1-mini') ai_model_deployment_mapping Map of client-facing model names to tenant-prefixed deployment names has_model_deployments Whether this tenant has any AI model deployments complete Marker indicating all project resources are complete (for serialization) Resources Created azapi_resource (project) azurerm_role_assignment (project_to_keyvault) azurerm_role_assignment (project_to_storage) azurerm_role_assignment (project_to_search) azurerm_role_assignment (project_to_cosmos) azurerm_role_assignment (project_to_docint) azapi_resource (connection_keyvault) azapi_resource (connection_storage) azapi_resource (connection_ai_search) azapi_resource (connection_cosmos) azapi_resource (ai_model_deployment) azapi_resource (connection_docint)","excerpt":"============================================================================= Location: infra-ai-hub/modules/foundry-project/ Files (5) locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-network","sectionTitle":"network","text":"Network Module - Main Configuration Location: infra-ai-hub/modules/network/ Files (6) data.tf locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name_prefix string required Prefix used for naming resources (e.g., ai-hub-dev) location string required Azure region for resources common_tags map(string) {} Common tags to apply to all resources vnet_name string required Name of the existing virtual network (target environment) vnet_resource_group_name string required Resource group name where the virtual network exists (target environment) target_vnet_address_spaces list(string) required Address spaces of the target environment VNet. The first entry (index 0) is used to derive the private endpoint subnet. source_vnet_address_space string required Address space of the source environment VNet (single CIDR string), used for NSG allow rules (e.g., tools VNet CIDR). private_endpoint_subnet_name string privateendpoints-subnet Name of the private endpoint subnet to create in the target VNet apim_subnet object({ { No description appgw_subnet object({ { Configuration for the Application Gateway subnet. Automatically placed after PE/APIM subnets. aca_subnet object({ { No description Outputs Name Description private_endpoint_subnet_id Resource ID of the primary private endpoint subnet (first in pool) private_endpoint_subnet_cidr CIDR of the primary private endpoint subnet private_endpoint_nsg_id Resource ID of the private endpoint NSG private_endpoint_subnet_pool Map of all PE subnets available for tenant allocation (name => cidr) apim_subnet_id Resource ID of the APIM subnet (null if not enabled) apim_subnet_cidr CIDR of the APIM subnet (null if not enabled) apim_nsg_id Resource ID of the APIM NSG (null if not enabled) appgw_subnet_id Resource ID of the App Gateway subnet (null if not enabled) appgw_subnet_cidr CIDR of the App Gateway subnet (null if not enabled) appgw_nsg_id Resource ID of the App Gateway NSG (null if not enabled) aca_subnet_id Resource ID of the ACA subnet (null if not enabled) aca_subnet_cidr CIDR of the ACA subnet (null if not enabled) aca_nsg_id Resource ID of the ACA NSG (null if not enabled) vnet_id Resource ID of the target VNet vnet_name Name of the target VNet Resources Created azurerm_network_security_group (private_endpoints) azapi_resource (private_endpoints_subnet) azurerm_network_security_group (apim) azapi_resource (apim_subnet) azurerm_network_security_group (appgw) azurerm_route_table (appgw) azurerm_route (appgw_internet) azapi_resource (appgw_subnet) azurerm_network_security_group (aca) azapi_resource (aca_subnet)","excerpt":"Network Module - Main Configuration Location: infra-ai-hub/modules/network/ Files (6) data.tf locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name_prefix string required…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-tenant","sectionTitle":"tenant","text":"Tenant Module - Main Configuration Location: infra-ai-hub/modules/tenant/ Files (6) data.tf locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description tenant_name string required Unique identifier for the tenant (used in resource names) display_name string required Human-readable display name for the tenant location string required Azure region for resources ai_location string null Azure region for AI services (OpenAI, Document Intelligence). Can differ from location for model availability. resource_group_name_override string null Optional custom name for the tenant resource group. If not provided, defaults to '{tenant_name}-rg' private_endpoint_subnet_id string required Subnet ID for private endpoints log_analytics_workspace_id string null Resource ID of Log Analytics workspace for diagnostics (legacy/shared) log_analytics object({ { Per-tenant Log Analytics workspace configuration private_endpoint_dns_wait object({ {} Configuration for waiting on policy-managed DNS zone groups scripts_dir string required Path to shared scripts directory for DNS wait operations key_vault object({ { Key Vault configuration for the tenant storage_account optional(string, { Storage Account configuration for the tenant ai_search object({ { Azure AI Search configuration for the tenant cosmos_db optional(string, { Cosmos DB configuration for the tenant document_intelligence object({ { Document Intelligence configuration for the tenant speech_services object({ { Azure Speech Services configuration for the tenant ai_foundry_hub_id string null Resource ID of the shared AI Foundry Hub (for reference in outputs) tags map(string) {} Tags to apply to tenant resources Outputs Name Description resource_group_name Name of the tenant's resource group resource_group_id ID of the tenant's resource group key_vault_id Resource ID of the Key Vault key_vault_name Name of the Key Vault key_vault_uri URI of the Key Vault storage_account_id Resource ID of the Storage Account storage_account_name Name of the Storage Account storage_account_primary_blob_endpoint Primary blob endpoint of the Storage Account storage_account_primary_access_key Primary access key of the Storage Account storage_account_primary_connection_string Primary connection string of the Storage Account ai_search_id Resource ID of the AI Search service ai_search_name Name of the AI Search service ai_search_endpoint Endpoint URL of the AI Search service cosmos_db_id Resource ID of the Cosmos DB account cosmos_db_name Name of the Cosmos DB account cosmos_db_account_name Account name of the Cosmos DB (alias for cosmos_db_name, used for role assignments) cosmos_db_resource_group_name Resource group name containing the Cosmos DB account cosmos_db_endpoint Endpoint of the Cosmos DB account cosmos_db_database_name Name of the pre-created Cosmos DB SQL database document_intelligence_id Resource ID of the Document Intelligence account document_intelligence_name Name of the Document Intelligence account document_intelligence_endpoint Endpoint of the Document Intelligence account speech_services_id Resource ID of the Speech Services account speech_services_name Name of the Speech Services account speech_services_endpoint Endpoint of the Speech Services account speech_services_primary_key Primary access key for the Speech Services account openai_endpoint Endpoint for OpenAI-compatible API calls (shared AI Foundry Hub) openai_id Resource ID for AI models (points to AI Foundry Hub) log_analytics_workspace_id Resource ID of the tenant's Log Analytics workspace (if enabled) has_log_analytics Whether the tenant has a Log Analytics workspace (own or shared) log_analytics_enabled Whether the tenant has its own dedicated Log Analytics workspace application_insights_id Resource ID of the tenant's Application Insights (if tenant LAW enabled) application_insights_instrumentation_key Instrumentation key for the tenant's Application Insights application_insights_connection_string Connection string for the tenant's Application Insights enabled_resources Summary of which resources are enabled for this tenant Resources Created azurerm_resource_group (tenant) random_string (suffix) azurerm_log_analytics_workspace (tenant) azurerm_application_insights (tenant) azurerm_monitor_diagnostic_setting (key_vault) azurerm_storage_account (this) azurerm_storage_container (default) azurerm_monitor_diagnostic_setting (storage) azurerm_monitor_diagnostic_setting (ai_search) azurerm_cosmosdb_account (this) azurerm_cosmosdb_sql_database (default) azurerm_cosmosdb_sql_container (default) azurerm_monitor_diagnostic_setting (cosmos) azurerm_private_endpoint (cosmos_db) azurerm_monitor_diagnostic_setting (document_intelligence) azurerm_monitor_diagnostic_setting (speech_services) null_resource (wait_for_dns_key_vault) null_resource (wait_for_dns_ai_search) null_resource (wait_for_dns_cosmos_db) null_resource (wait_for_dns_document_intelligence) null_resource (wait_for_dns_speech_services)","excerpt":"Tenant Module - Main Configuration Location: infra-ai-hub/modules/tenant/ Files (6) data.tf locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description tenant_name string required Unique…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-tenant-user-management","sectionTitle":"tenant-user-management","text":"============================================================================= Location: infra-ai-hub/modules/tenant-user-management/ Files (6) data.tf locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description tenant_name string required Unique identifier for the tenant (used in group/role names) display_name string required Human-readable display name for the tenant app_env string required Application environment (dev, test, prod) — included in group/role names to prevent cross-environment conflicts resource_group_id string required Resource group ID for tenant scope role assignments user_management object({ {} Tenant user management configuration (Entra groups + custom roles) Outputs Name Description group_object_ids Object IDs for tenant role groups (empty when create_groups = false) role_definition_ids Role definition IDs for tenant custom roles mode Assignment mode: 'group' when create_groups=true, 'direct_user' otherwise direct_user_assignments Map of direct user role assignments (empty when create_groups = true) Resources Created azuread_group (tenant) azuread_group_member (seed_members) azurerm_role_definition (tenant_admin) azurerm_role_definition (tenant_write) azurerm_role_definition (tenant_read) azurerm_role_assignment (tenant_groups) azurerm_role_assignment (direct_users)","excerpt":"============================================================================= Location: infra-ai-hub/modules/tenant-user-management/ Files (6) data.tf locals.tf main.tf outputs.tf variables.tf versions.tf Variables Name…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"hub-waf-policy","sectionTitle":"waf-policy","text":"WAF Policy Module Location: infra-ai-hub/modules/waf-policy/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the WAF policy resource_group_name string required Name of the resource group location string required Azure region for resources enabled bool true Enable the WAF policy mode string Prevention WAF mode: Detection or Prevention request_body_check bool true Enable request body inspection request_body_enforcement bool true Enforce max request body size limit. When false, WAF inspects up to inspect_limit but does not reject oversized requests. Requires OWASP CRS 3.2+ request_body_inspect_limit_in_kb number 128 How deep into a request body the WAF inspects and applies rules (KB). Only used with CRS 3.2+ max_request_body_size_kb number 128 Maximum request body size in KB (8-2000) file_upload_limit_mb number 100 Maximum file upload size in MB managed_rule_sets \"Microsoft_BotManagerRuleSet\" [ Managed rule sets to apply exclusions list(object({ [] Rule exclusions for false positive handling custom_rules string [] Custom WAF rules tags map(string) {} Tags to apply to resources Outputs Name Description resource_id Resource ID of the WAF policy name Name of the WAF policy http_listener_ids Associated HTTP listener IDs path_based_rule_ids Associated path-based rule IDs Resources Created azurerm_web_application_firewall_policy (this)","excerpt":"WAF Policy Module Location: infra-ai-hub/modules/waf-policy/ Files (4) main.tf outputs.tf variables.tf versions.tf Variables Name Type Default Description name string required Name of the WAF policy resource_group_name…"},{"page":"terraform-reference.html","pageTitle":"Terraform Reference","sectionId":"adding-new-modules","sectionTitle":"Adding New Modules","text":"When creating new Terraform modules, follow these conventions to ensure automatic documentation: Add a description comment at the top of main.tf : # Description: This module creates Azure storage accounts with encryption Always include description for variables: variable \"storage_name\" { type = string description = \"Name of the storage account (must be globally unique)\" } Always include description for outputs: output \"storage_id\" { value = azurerm_storage_account.main.id description = \"The resource ID of the storage account\" } Run the documentation generator: ./docs/generate-tf-docs.sh 💡 Tip: The documentation generator runs automatically during the GitHub Pages build. Push to main and docs are rebuilt. AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"When creating new Terraform modules, follow these conventions to ensure automatic documentation: Add a description comment at the top of main.tf : # Description: This module creates Azure storage accounts with encryption…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"terraform-modules","sectionTitle":"Terraform Modules","text":"This project uses modular Terraform configuration for Azure Landing Zone infrastructure. Each module is designed to be reusable and follows Azure best practices.","excerpt":"This project uses modular Terraform configuration for Azure Landing Zone infrastructure. Each module is designed to be reusable and follows Azure best practices."},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"module-overview","sectionTitle":"Module Overview","text":"Module Purpose Key Resources Optional? network VNet subnets and NSG configuration Subnets, Network Security Groups No monitoring Observability with Log Analytics & Application Insights Log Analytics Workspace, App Insights No bastion Secure VM access without public IPs Azure Bastion Host, Public IP Yes ( enable_bastion ) jumpbox Development VM with CLI tools Linux VM, SSH Keys, Auto-shutdown Yes ( enable_jumpbox ) github-runners-aca Self-hosted GitHub runners on Container Apps Container Apps Environment, Container Job, ACR Yes ( github_runners_aca_enabled ) azure-proxy Secure tunnel (chisel) for proxying to peered networks App Service, Container Image Yes ( enable_azure_proxy ) Optional Modules: Modules marked as optional can be toggled on/off using their respective variables. Set them in terraform.tfvars or as environment variables.","excerpt":"Module Purpose Key Resources Optional? network VNet subnets and NSG configuration Subnets, Network Security Groups No monitoring Observability with Log Analytics & Application Insights Log Analytics Workspace, App…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"deployment-script-deploy-terraformsh","sectionTitle":"Deployment Script: deploy-terraform.sh","text":"A wrapper script that simplifies Terraform operations with proper Azure authentication. Features auto-import of conflicting resources and intelligent retry logic.","excerpt":"A wrapper script that simplifies Terraform operations with proper Azure authentication. Features auto-import of conflicting resources and intelligent retry logic."},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"usage","sectionTitle":"Usage","text":"./initial-setup/infra/deploy-terraform.sh [options] Commands: init Initialize Terraform with backend configuration plan Preview infrastructure changes apply Apply infrastructure changes (with auto-import & retry) destroy Destroy all infrastructure output Display Terraform outputs","excerpt":"./initial-setup/infra/deploy-terraform.sh [options] Commands: init Initialize Terraform with backend configuration plan Preview infrastructure changes apply Apply infrastructure changes (with auto-import & retry) destroy…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"smart-apply-logic","sectionTitle":"Smart Apply Logic","text":"The apply command now includes: Auto-detection : Detects \"already exists\" errors from Azure Automatic import : Imports conflicting resources into Terraform state Retry on success : Reruns apply after successful import (max 3 attempts) Clear failure messages : Shows which resource was imported or why the apply failed","excerpt":"The apply command now includes: Auto-detection : Detects \"already exists\" errors from Azure Automatic import : Imports conflicting resources into Terraform state Retry on success : Reruns apply after successful import…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"examples","sectionTitle":"Examples","text":"","excerpt":""},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"full-deployment","sectionTitle":"Full Deployment","text":"./initial-setup/infra/deploy-terraform.sh init ./initial-setup/infra/deploy-terraform.sh plan ./initial-setup/infra/deploy-terraform.sh apply","excerpt":"./initial-setup/infra/deploy-terraform.sh init ./initial-setup/infra/deploy-terraform.sh plan ./initial-setup/infra/deploy-terraform.sh apply"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"target-specific-module","sectionTitle":"Target Specific Module","text":"# Deploy only bastion ./initial-setup/infra/deploy-terraform.sh apply \\ -target=module.bastion # Deploy only jumpbox ./initial-setup/infra/deploy-terraform.sh apply \\ -target=module.jumpbox","excerpt":"# Deploy only bastion ./initial-setup/infra/deploy-terraform.sh apply \\ -target=module.bastion # Deploy only jumpbox ./initial-setup/infra/deploy-terraform.sh apply \\ -target=module.jumpbox"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"monitoring-module","sectionTitle":"Monitoring Module","text":"Provides centralized observability across all deployed resources using Azure Monitor services.","excerpt":"Provides centralized observability across all deployed resources using Azure Monitor services."},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"resources-created","sectionTitle":"Resources Created","text":"Log Analytics Workspace : Central logs and metrics repository (default retention: 30 days, configurable) Application Insights : APM for applications, connected to Log Analytics workspace","excerpt":"Log Analytics Workspace : Central logs and metrics repository (default retention: 30 days, configurable) Application Insights : APM for applications, connected to Log Analytics workspace"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"key-variables","sectionTitle":"Key Variables","text":"Variable Default Description log_analytics_sku PerGB2018 Log Analytics pricing tier log_analytics_retention_days 30 Data retention period in days","excerpt":"Variable Default Description log_analytics_sku PerGB2018 Log Analytics pricing tier log_analytics_retention_days 30 Data retention period in days"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"network-module","sectionTitle":"Network Module","text":"Configures subnets within an existing VNet and creates Network Security Groups (NSGs) for traffic control.","excerpt":"Configures subnets within an existing VNet and creates Network Security Groups (NSGs) for traffic control."},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"subnets-created","sectionTitle":"Subnets Created","text":"Subnet Purpose Delegation AzureBastionSubnet Azure Bastion service None (required name) jumpbox-subnet Jumpbox VM None privateendpoints-subnet Private Endpoints for Azure services None app-service-subnet App Service VNet integration Microsoft.Web/serverFarms container-instance-subnet Azure Container Instances Microsoft.ContainerInstance/containerGroups container-apps-subnet Azure Container Apps Environment Microsoft.App/environments apim-subnet Azure API Management Microsoft.Web/serverFarms","excerpt":"Subnet Purpose Delegation AzureBastionSubnet Azure Bastion service None (required name) jumpbox-subnet Jumpbox VM None privateendpoints-subnet Private Endpoints for Azure services None app-service-subnet App Service VNet…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"network-security-groups","sectionTitle":"Network Security Groups","text":"Each subnet has a dedicated NSG with rules for: Bastion NSG : HTTPS inbound, Gateway Manager, SSH/RDP to VNet Jumpbox NSG : SSH/RDP from Bastion only, outbound to Private Endpoints App Service NSG : HTTP/HTTPS from internet, communication with Private Endpoints Container Apps NSG : Load Balancer, HTTP/HTTPS, Private Endpoint access APIM NSG : API Management traffic, backend service access","excerpt":"Each subnet has a dedicated NSG with rules for: Bastion NSG : HTTPS inbound, Gateway Manager, SSH/RDP to VNet Jumpbox NSG : SSH/RDP from Bastion only, outbound to Private Endpoints App Service NSG : HTTP/HTTPS from…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"bastion-module","sectionTitle":"Bastion Module","text":"Deploys Azure Bastion for secure, browser-based SSH/RDP access to VMs without exposing public IPs.","excerpt":"Deploys Azure Bastion for secure, browser-based SSH/RDP access to VMs without exposing public IPs."},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"resources-created-1","sectionTitle":"Resources Created","text":"Public IP : Static, Standard SKU (required for Bastion) Bastion Host : Basic SKU for cost optimization","excerpt":"Public IP : Static, Standard SKU (required for Bastion) Bastion Host : Basic SKU for cost optimization"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"features","sectionTitle":"Features","text":"Web-based SSH/RDP from Azure Portal No public IPs needed on VMs TLS encryption for all sessions NSG rules per Microsoft requirements Cost Tip: Azure Bastion has hourly charges. Use the add-or-remove-module.yml workflow to deploy/destroy Bastion on demand.","excerpt":"Web-based SSH/RDP from Azure Portal No public IPs needed on VMs TLS encryption for all sessions NSG rules per Microsoft requirements Cost Tip: Azure Bastion has hourly charges. Use the add-or-remove-module.yml workflow…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"jumpbox-module","sectionTitle":"Jumpbox Module","text":"Creates a Linux VM for development and administration tasks, pre-configured with essential CLI tools.","excerpt":"Creates a Linux VM for development and administration tasks, pre-configured with essential CLI tools."},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"vm-configuration","sectionTitle":"VM Configuration","text":"Setting Value OS Ubuntu 24.04 LTS (Noble Numbat) Size B-series burstable (configurable) Authentication SSH Key (auto-generated, stored in sensitive/ ) Public IP None (access via Bastion only) Identity System-assigned managed identity","excerpt":"Setting Value OS Ubuntu 24.04 LTS (Noble Numbat) Size B-series burstable (configurable) Authentication SSH Key (auto-generated, stored in sensitive/ ) Public IP None (access via Bastion only) Identity System-assigned…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"pre-installed-tools","sectionTitle":"Pre-installed Tools","text":"The VM is bootstrapped with cloud-init to install: Azure & Cloud Azure CLI Terraform kubectl Development Docker & Compose GitHub CLI Python 3 & pip Utilities git, vim, tmux jq, curl, wget htop, net-tools","excerpt":"The VM is bootstrapped with cloud-init to install: Azure & Cloud Azure CLI Terraform kubectl Development Docker & Compose GitHub CLI Python 3 & pip Utilities git, vim, tmux jq, curl, wget htop, net-tools"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"auto-shutdown-start","sectionTitle":"Auto-Shutdown & Start","text":"Cost optimization through scheduled operations: Schedule Time Method Auto-Shutdown 7:00 PM PST daily Azure Dev/Test shutdown schedule Auto-Start 8:00 AM PST Mon-Fri Azure Automation Runbook (Python3)","excerpt":"Cost optimization through scheduled operations: Schedule Time Method Auto-Shutdown 7:00 PM PST daily Azure Dev/Test shutdown schedule Auto-Start 8:00 AM PST Mon-Fri Azure Automation Runbook (Python3)"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"azure-proxy-module-chisel-tunnel","sectionTitle":"Azure Proxy Module (Chisel Tunnel)","text":"Deploys a Chisel secure tunnel server for accessing private Azure resources (data plane) from your local machine. This solves the problem of accessing private endpoints when you're outside the VNet. Why Chisel? Private endpoints block data plane access from the public internet. Chisel creates an HTTPS tunnel through an App Service (which has VNet integration) to reach Key Vault secrets, databases, and other private resources from your laptop.","excerpt":"Deploys a Chisel secure tunnel server for accessing private Azure resources (data plane) from your local machine. This solves the problem of accessing private endpoints when you're outside the VNet. Why Chisel? Private…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"resources-created-2","sectionTitle":"Resources Created","text":"App Service Plan : Linux plan hosting the tunnel (configurable SKU) Web App : Runs containerized Chisel server with VNet integration Random Credentials : Auto-generated username/password for tunnel auth Application Insights : Connection logging and monitoring","excerpt":"App Service Plan : Linux plan hosting the tunnel (configurable SKU) Web App : Runs containerized Chisel server with VNet integration Random Credentials : Auto-generated username/password for tunnel auth Application…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"security-features","sectionTitle":"Security Features","text":"HTTPS Only : TLS 1.3 minimum Mandatory Auth : Random credentials stored in App Settings Health Checks : Automatic restart on failure Logging : All connections logged to App Insights","excerpt":"HTTPS Only : TLS 1.3 minimum Mandatory Auth : Random credentials stored in App Settings Health Checks : Automatic restart on failure Logging : All connections logged to App Insights"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"key-variables-1","sectionTitle":"Key Variables","text":"Variable Default Description enable_azure_proxy false Enable/disable Chisel deployment azure_proxy_image - Container image URI (built by pr-open workflow) app_service_sku_name_azure_proxy B1 App Service plan SKU","excerpt":"Variable Default Description enable_azure_proxy false Enable/disable Chisel deployment azure_proxy_image - Container image URI (built by pr-open workflow) app_service_sku_name_azure_proxy B1 App Service plan SKU"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"usage-example","sectionTitle":"Usage Example","text":"After deployment, connect from your laptop: # Get credentials from Terraform output terraform output azure_proxy_chisel_auth terraform output azure_proxy_url # Connect to private PostgreSQL database docker run --rm -it -p 5432:5432 jpillora/chisel:latest client \\ --auth \"tunnel:XXXXXXXX\" \\ https://your-app.azurewebsites.net \\ 0.0.0.0:5432:private-postgres.postgres.database.azure.com:5432 # Now connect locally psql -h localhost -p 5432 -U admin -d mydb See Chisel Tunnel Playbook for detailed instructions. Platform Maintainers Only: Chisel is for the platform team to access private resources. Tenant developers should use APIM/App Gateway endpoints designed for their applications.","excerpt":"After deployment, connect from your laptop: # Get credentials from Terraform output terraform output azure_proxy_chisel_auth terraform output azure_proxy_url # Connect to private PostgreSQL database docker run --rm -it…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"choosing-your-access-method","sectionTitle":"Choosing Your Access Method","text":"The infrastructure provides four interchangeable access methods for reaching Azure resources. Enable only what you need - all are optional and controlled via Terraform variables. Understanding Control vs Data Plane: OIDC authentication works for control plane (creating resources) but not data plane (accessing secrets, blobs, databases) when private endpoints are enabled. See ADR-011 for details. Access Method Toggle Variable Control Plane Data Plane Best For Public GitHub Runners (default, no toggle) &#10003; Yes &#10007; No Resource deployments only Self-Hosted Runners github_runners_aca_enabled &#10003; Yes &#10003; Yes Tenant CI/CD pipelines needing VNet access Bastion + Jumpbox enable_bastion + enable_jumpbox &#10003; Yes &#10003; Yes Admin access, debugging Chisel Tunnel enable_azure_proxy &#10003; Yes &#10003; Yes Local dev access from laptop","excerpt":"The infrastructure provides four interchangeable access methods for reaching Azure resources. Enable only what you need - all are optional and controlled via Terraform variables. Understanding Control vs Data Plane: OIDC…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"example-minimal-control-plane-only","sectionTitle":"Example: Minimal (Control Plane Only)","text":"# terraform.tfvars enable_bastion = false enable_jumpbox = false enable_azure_proxy = false github_runners_aca_enabled = false # Uses public GitHub runners # Good for: Resource-only Terraform","excerpt":"# terraform.tfvars enable_bastion = false enable_jumpbox = false enable_azure_proxy = false github_runners_aca_enabled = false # Uses public GitHub runners # Good for: Resource-only Terraform"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"example-full-access","sectionTitle":"Example: Full Access","text":"# terraform.tfvars enable_bastion = true enable_jumpbox = true enable_azure_proxy = true github_runners_aca_enabled = true # All access methods available # Good for: Platform maintainers","excerpt":"# terraform.tfvars enable_bastion = true enable_jumpbox = true enable_azure_proxy = true github_runners_aca_enabled = true # All access methods available # Good for: Platform maintainers"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"recommended-setup-by-role","sectionTitle":"Recommended Setup by Role","text":"Platform Maintainers Enable all: Bastion + Jumpbox for admin, Chisel for local dev, Self-hosted for CI/CD Project Developers No direct access needed - use APIM/App Gateway endpoints provided by platform Cost-Conscious Chisel only ( enable_azure_proxy ) - cheapest option with data plane access See Access Methods Architecture Diagram for a visual overview.","excerpt":"Platform Maintainers Enable all: Bastion + Jumpbox for admin, Chisel for local dev, Self-hosted for CI/CD Project Developers No direct access needed - use APIM/App Gateway endpoints provided by platform Cost-Conscious…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"backend-configuration","sectionTitle":"Backend Configuration","text":"Terraform state is stored in Azure Blob Storage with Azure AD authentication. # infra/backend.tf terraform { backend \"azurerm\" { resource_group_name = \"your-resource-group\" storage_account_name = \"tfstateaccount\" container_name = \"tfstate\" key = \"terraform.tfstate\" use_azuread_auth = true # Required for OIDC } } Important: The use_azuread_auth = true setting is required when using OIDC authentication. Without it, Terraform will fail to access the state file.","excerpt":"Terraform state is stored in Azure Blob Storage with Azure AD authentication. # infra/backend.tf terraform { backend \"azurerm\" { resource_group_name = \"your-resource-group\" storage_account_name = \"tfstateaccount\"…"},{"page":"terraform.html","pageTitle":"Terraform Modules","sectionId":"variables-reference","sectionTitle":"Variables Reference","text":"Key variables used across modules: Variable Description Source app_name Application name prefix for resources Environment variable app_env Environment (dev, test, prod) GitHub Environment location Azure region Default: Canada Central resource_group_name Target resource group Environment variable vnet_name Existing VNet name GitHub Secret vnet_address_space VNet CIDR for subnet calculation GitHub Secret AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"Key variables used across modules: Variable Description Source app_name Application name prefix for resources Environment variable app_env Environment (dev, test, prod) GitHub Environment location Azure region Default:…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"github-actions-workflows","sectionTitle":"GitHub Actions Workflows","text":"This project uses GitHub Actions for automated infrastructure deployments with OIDC authentication to Azure.","excerpt":"This project uses GitHub Actions for automated infrastructure deployments with OIDC authentication to Azure."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"workflow-overview","sectionTitle":"Workflow Overview","text":"Workflow Trigger Purpose .builds.yml Called by other workflows Reusable container build workflow for azure-proxy images .deployer.yml Called by other workflows Reusable Terraform deployer for initial-setup/infra (tools bootstrap and module-level operations) .deployer-using-secure-tunnel.yml Called by other workflows Reusable Terraform deployer for infra-ai-hub through Chisel + Privoxy secure tunnel .lint.yml Called by other workflows Reusable validation: pre-commit ( terraform fmt + tflint ), conventional commits, fork check add-or-remove-module.yml Manual (workflow_dispatch) Deploy or destroy selected tools modules (bastion, azure_proxy, jumpbox, github_runners_aca) manual-dispatch.yml Manual (workflow_dispatch) Run plan/apply/destroy for dev/test/prod; prod apply requires a semver tag (e.g. v1.2.3 ) and creates a GitHub Release merge-main.yml Push to main Automatic post-merge: semantic version tag via conventional commits, apply infrastructure to test pr-open.yml Pull request events + manual trigger PR validation: lint, container builds, deploy proxy in tools, and plan against test schedule.yml Cron (daily at 5 PM PST) Auto-destroy Bastion for cost savings apim-key-rotation.yml Daily cron + manual trigger Rotate APIM subscription keys across environments (manual single-env or scheduled all-env flow) pages.yml Push to main (docs and Terraform roots) + manual trigger Generate docs and deploy GitHub Pages site","excerpt":"Workflow Trigger Purpose .builds.yml Called by other workflows Reusable container build workflow for azure-proxy images .deployer.yml Called by other workflows Reusable Terraform deployer for initial-setup/infra (tools…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"developer-sdlc-flow-branch-pr-test-prod","sectionTitle":"Developer SDLC Flow (Branch → PR → TEST → PROD)","text":"The repository enforces a promote-through-environments workflow. Every change flows through a validated path before reaching production. Create feature branch from main (e.g. feat/<work-item> , fix/<issue> ) and commit changes. Open PR to main , which triggers pr-open.yml : Lint (pre-commit: terraform fmt + tflint, conventional commit title, fork check) Container image builds Terraform plan against test (via secure tunnel) — summary appended to PR description Merge to main once PR checks and code review pass. Auto-apply to test + semver tag : merge-main.yml starts two jobs concurrently — semantic versioning (conventional commit history → v1.2.3 tag + CHANGELOG.md update) and proxy bootstrap in tools . Once the proxy is up, it applies infrastructure to test through the Chisel tunnel. After a successful apply, integration tests run automatically (two phases — see below). Promote to prod : Use manual-dispatch.yml , select prod + apply , and provide the semver tag. This is gated — requires approval from designated reviewers (configured in the GitHub prod environment protection rules). Release created : After successful prod apply, a GitHub Release is automatically created from the deployed tag with deployment metadata. PROD is gated: The prod environment has required reviewers configured as a GitHub Environment protection rule. Any workflow job targeting prod will pause and wait for manual approval before executing. Only designated reviewers can approve. Developer branch testing (occasional): Developers can run manual dispatch to dev from a feature/PR branch for targeted validation; use this sparingly and co-ordinate with other devs. The dev environment does not include App Gateway or DNS Zone — full ingress path validation is only available in test and prod . Feature Branch │ └── Pull Request ──► pr-open.yml ├─ .lint.yml (fmt, tflint, conventional commits, fork check) ├─ .builds.yml ├─ .deployer.yml (tools/azure_proxy) ├─ .deployer-using-secure-tunnel.yml (test plan) └─ Update PR description with plan summary │ ▼ Merge to main │ ▼ merge-main.yml ├─ Semantic version tag (v1.2.3) ─────────────────── concurrent ├─ Deploy azure_proxy (tools) ───────────────────────────────┤ └─ Apply to test (via Chisel tunnel) └─ Integration tests (post-apply) ├─ Direct: all tests except apim-key-rotation.bats └─ Via proxy: apim-key-rotation.bats (KV private endpoint) │ ▼ manual-dispatch.yml (prod + apply + tag) ├─ ⏸ Requires prod environment approval ├─ Apply to prod using tagged commit └─ Create GitHub Release","excerpt":"The repository enforces a promote-through-environments workflow. Every change flows through a validated path before reaching production. Create feature branch from main (e.g. feat/<work-item> , fix/<issue> ) and commit…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"advanced-branching-patterns","sectionTitle":"Advanced Branching Patterns","text":"The basic SDLC flow above covers the single-feature-per-PR path. In practice, teams often need to coordinate dependent work or bundle multiple features into a single release. Two patterns handle this: Stacked PRs and Release PRs .","excerpt":"The basic SDLC flow above covers the single-feature-per-PR path. In practice, teams often need to coordinate dependent work or bundle multiple features into a single release. Two patterns handle this: Stacked PRs and…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"stacked-prs-dependent-feature-chains","sectionTitle":"Stacked PRs (Dependent Feature Chains)","text":"Use stacked PRs when a feature depends on another feature that hasn't merged to main yet. Each PR in the stack targets the previous branch instead of main .","excerpt":"Use stacked PRs when a feature depends on another feature that hasn't merged to main yet. Each PR in the stack targets the previous branch instead of main ."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"when-to-use","sectionTitle":"When to Use","text":"Feature B requires infrastructure created by Feature A (e.g. a new subnet added in A is referenced in B) Breaking a large change into reviewable, incremental PRs Multiple developers working on sequential pieces of a story","excerpt":"Feature B requires infrastructure created by Feature A (e.g. a new subnet added in A is referenced in B) Breaking a large change into reviewable, incremental PRs Multiple developers working on sequential pieces of a…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"how-it-works","sectionTitle":"How It Works","text":"Create feat/base-network from main → open PR #1 targeting main Create feat/add-apim-policy from feat/base-network → open PR #2 targeting feat/base-network Each PR triggers pr-open.yml independently for lint and plan Merge PR #1 first (bottom of the stack) — this triggers merge-main.yml Retarget PR #2 to main and rebase onto updated main Merge PR #2 — triggers another merge-main.yml run with its own semver tag main ─────────────────────────┬───────────────────┬──────► \\ │ merge PR #1 │ merge PR #2 └─ feat/base-network ─────┘ (v1.3.0) │ \\ │ └─ feat/add-apim-policy ─── rebase ──────┘ (v1.4.0) Important: Always merge bottom-up. If you merge PR #2 before PR #1, the diff will include both sets of changes and the base branch won't exist in main yet. After merging the base PR, rebase the dependent branch onto main to pick up any squash-merge differences before merging. CI Behaviour: Each PR in the stack runs pr-open.yml against test . The plan for PR #2 will show changes from both branches while PR #1 is open (because the diff includes the base). After PR #1 merges, re-running PR #2's checks shows only its own changes. Each merge to main produces its own semver tag.","excerpt":"Create feat/base-network from main → open PR #1 targeting main Create feat/add-apim-policy from feat/base-network → open PR #2 targeting feat/base-network Each PR triggers pr-open.yml independently for lint and plan…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"release-prs-bundled-multi-feature-releases","sectionTitle":"Release PRs (Bundled Multi-Feature Releases)","text":"Use a Release PR when multiple developers are working on separate features that should ship together as a single coordinated release. All feature branches merge into a shared release branch , which then opens one PR to main .","excerpt":"Use a Release PR when multiple developers are working on separate features that should ship together as a single coordinated release. All feature branches merge into a shared release branch , which then opens one PR to…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"when-to-use-1","sectionTitle":"When to Use","text":"A planned release includes work from multiple developers across different modules Features need integration testing together before merging to main You want one semver tag to represent the entire release bundle (e.g. a sprint deliverable) Coordinating breaking changes that span multiple Terraform stacks","excerpt":"A planned release includes work from multiple developers across different modules Features need integration testing together before merging to main You want one semver tag to represent the entire release bundle (e.g. a…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"how-it-works-1","sectionTitle":"How It Works","text":"Create a release branch from main : release/sprint-42 (or release/apim-v2 , etc.) Developers create feature branches from the release branch: feat/new-tenant-config → PR targeting release/sprint-42 feat/apim-rate-limits → PR targeting release/sprint-42 fix/dns-zone-ttl → PR targeting release/sprint-42 Feature PRs are reviewed and merged into the release branch (these merges do not trigger merge-main.yml since they don't target main ) Optionally deploy the release branch to dev via manual-dispatch.yml to validate the combined changes When all features are complete, open one Release PR : release/sprint-42 → main The Release PR triggers pr-open.yml — the plan shows the aggregate of all bundled changes Merge the Release PR → merge-main.yml creates one semver tag and applies to test main ─────────────────────────────────────────┬──────────► \\ │ merge Release PR └─ release/sprint-42 ───┬──────┬──────────┘ (v2.0.0) \\ │ │ ├─ feat/tenant ───┘ │ │ │ └─ feat/rate-limits ─────┘ CI Behaviour: PRs targeting the release branch still trigger pr-open.yml (lint and plan), giving each feature its own review cycle. The final Release PR to main runs the full pipeline and shows a combined plan. Only the merge to main triggers merge-main.yml for semver tagging and test apply. PR Title Convention: The Release PR title must follow Conventional Commits (e.g. feat: sprint 42 release — tenant config and rate limits ) since it controls the semver bump. Use feat: for minor, fix: for patch, or include BREAKING CHANGE in the body for major.","excerpt":"Create a release branch from main : release/sprint-42 (or release/apim-v2 , etc.) Developers create feature branches from the release branch: feat/new-tenant-config → PR targeting release/sprint-42 feat/apim-rate-limits…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"choosing-between-stacked-prs-and-release-prs","sectionTitle":"Choosing Between Stacked PRs and Release PRs","text":"Stacked PRs Release PR Best for Sequential/dependent changes by 1–2 developers Parallel independent features by multiple developers Semver tags One tag per merged PR (e.g. v1.3.0, v1.4.0) One tag for the entire bundle (e.g. v2.0.0) Review granularity Each PR is reviewed independently with a focused diff Feature PRs reviewed individually; Release PR shows combined diff merge-main.yml runs Triggers once per PR merged to main Triggers once for the entire release Risk Rebase conflicts after base merges Release branch can drift from main if long-lived Recommendation Keep stacks shallow (2–3 deep max) Keep release branches short-lived; rebase from main regularly","excerpt":"Stacked PRs Release PR Best for Sequential/dependent changes by 1–2 developers Parallel independent features by multiple developers Semver tags One tag per merged PR (e.g. v1.3.0, v1.4.0) One tag for the entire bundle…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"when-do-i-need-self-hosted-runners","sectionTitle":"When Do I Need Self-Hosted Runners?","text":"How this platform solves the private-endpoint problem: All CI/CD in this repo runs on standard GitHub-hosted runners ( ubuntu-24.04 ). To reach private endpoints, the Terraform deployer spins up a Chisel SOCKS tunnel + Privoxy inside Docker on the runner, routing data-plane traffic through a proxy deployed in the tools VNet. No self-hosted runners are needed for this repo's own pipelines. The optional github_runners_aca module (deployable via add-or-remove-module.yml ) can provision self-hosted runners inside the VNet. Use this when other repos or workloads need persistent VNet-internal compute — not for this repo's own CI/CD. The table below describes the general pattern. Data-plane work that can't use the Chisel tunnel approach — for example, other repos without the proxy setup — would still need self-hosted runners. Understanding the Difference: See ADR-011: Control Plane vs Data Plane for a detailed explanation of why OIDC works for some operations but not others. Operation Plane Public Runner? Example Create resources (VMs, VNets, Key Vault) Control &#10003; Yes azurerm_key_vault Configure settings, RBAC roles Control &#10003; Yes azurerm_role_assignment Deploy private endpoints Control &#10003; Yes azurerm_private_endpoint Read/write Key Vault secrets Data &#10007; No azurerm_key_vault_secret Read/write Storage blobs Data &#10007; No azurerm_storage_blob Terraform state (if private) Data &#10007; No Backend storage account","excerpt":"How this platform solves the private-endpoint problem: All CI/CD in this repo runs on standard GitHub-hosted runners ( ubuntu-24.04 ). To reach private endpoints, the Terraform deployer spins up a Chisel SOCKS tunnel +…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"public-runners-work-for","sectionTitle":"Public Runners Work For","text":"Deploying all infrastructure modules Network, Bastion, Jumpbox, Proxy Any resource that doesn't read secrets Documentation builds (pages.yml)","excerpt":"Deploying all infrastructure modules Network, Bastion, Jumpbox, Proxy Any resource that doesn't read secrets Documentation builds (pages.yml)"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"self-hosted-required-for","sectionTitle":"Self-Hosted Required For","text":"Terraform using azurerm_key_vault_secret Private state backend (blocked by PE) Any code that reads secrets at plan time Database migrations, blob uploads Cost Tip: If your Terraform doesn't need data plane access, stick with public runners. Self-hosted runners on Container Apps add cost. Only enable github_runners_aca_enabled if you actually need data plane access in CI/CD.","excerpt":"Terraform using azurerm_key_vault_secret Private state backend (blocked by PE) Any code that reads secrets at plan time Database migrations, blob uploads Cost Tip: If your Terraform doesn't need data plane access, stick…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"deployeryml-reusable-workflow","sectionTitle":".deployer.yml (Reusable Workflow)","text":"Reusable Terraform workflow for initial-setup/infra , primarily used to manage the tools environment and targeted foundational modules.","excerpt":"Reusable Terraform workflow for initial-setup/infra , primarily used to manage the tools environment and targeted foundational modules."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"inputs","sectionTitle":"Inputs","text":"Input Type Description environment_name string Target environment name (commonly tools ) command string Terraform command (init, plan, apply, destroy) target_module string Required module target (for example: azure_proxy , bastion , jumpbox )","excerpt":"Input Type Description environment_name string Target environment name (commonly tools ) command string Terraform command (init, plan, apply, destroy) target_module string Required module target (for example: azure_proxy…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"key-features","sectionTitle":"Key Features","text":"OIDC Authentication : Uses azure/login@v2 with federated credentials Environment Isolation : Each environment has separate secrets and identity Module Targeting : Deploy specific modules with -target=module.name (supports all modules including azure-proxy) Optional Modules : Deploy only what you need—all modules except network and monitoring can be toggled on/off ARM_USE_OIDC : Enabled for Terraform Azure provider","excerpt":"OIDC Authentication : Uses azure/login@v2 with federated credentials Environment Isolation : Each environment has separate secrets and identity Module Targeting : Deploy specific modules with -target=module.name…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"required-permissions","sectionTitle":"Required Permissions","text":"permissions: id-token: write # Required for OIDC token generation contents: read # Required for repository checkout Important: Without id-token: write permission, the workflow cannot generate the OIDC token needed for Azure authentication.","excerpt":"permissions: id-token: write # Required for OIDC token generation contents: read # Required for repository checkout Important: Without id-token: write permission, the workflow cannot generate the OIDC token needed for…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"deployer-using-secure-tunnelyml-reusable-workflow","sectionTitle":".deployer-using-secure-tunnel.yml (Reusable Workflow)","text":"Reusable Terraform workflow for infra-ai-hub . It receives encrypted proxy outputs from .deployer.yml , starts Chisel + Privoxy, then runs stack deployment and (for apply in dev/test) integration tests.","excerpt":"Reusable Terraform workflow for infra-ai-hub . It receives encrypted proxy outputs from .deployer.yml , starts Chisel + Privoxy, then runs stack deployment and (for apply in dev/test) integration tests."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"highlights","sectionTitle":"Highlights","text":"Validated environments : dev , test , prod Secure tunnel bootstrap : decrypts proxy_url / proxy_auth with GPG_PASSPHRASE Proxy-aware Terraform : sets HTTP_PROXY , HTTPS_PROXY , and NO_PROXY Integration tests (after successful apply in dev/test) — two phases: Direct (no proxy): all suites except apim-key-rotation.bats — APIM and App Gateway are public endpoints; proxy not required Via proxy: apim-key-rotation.bats only — Key Vault is private-endpoint only ( public_network_access_enabled=false ), so the KV fallback ( az keyvault secret show ) must route through the Chisel tunnel","excerpt":"Validated environments : dev , test , prod Secure tunnel bootstrap : decrypts proxy_url / proxy_auth with GPG_PASSPHRASE Proxy-aware Terraform : sets HTTP_PROXY , HTTPS_PROXY , and NO_PROXY Integration tests (after…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"lintyml-reusable-workflow","sectionTitle":".lint.yml (Reusable Workflow)","text":"Reusable validation workflow used by PR checks. Runs Terraform formatting and linting, enforces PR title conventions, and blocks forks.","excerpt":"Reusable validation workflow used by PR checks. Runs Terraform formatting and linting, enforces PR title conventions, and blocks forks."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"what-it-runs","sectionTitle":"What It Runs","text":"Pre-commit hooks : terraform fmt + tflint (diff-based when possible, full-repo fallback) Conventional Commits : Validates PR title follows Conventional Commits spec (e.g. feat: , fix: , chore: ) Fork check : Rejects PRs from forked repositories Summary on failure : When any check fails, prints a consolidated error summary with common reasons","excerpt":"Pre-commit hooks : terraform fmt + tflint (diff-based when possible, full-repo fallback) Conventional Commits : Validates PR title follows Conventional Commits spec (e.g. feat: , fix: , chore: ) Fork check : Rejects PRs…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"buildsyml-container-build-workflow","sectionTitle":".builds.yml (Container Build Workflow)","text":"Reusable workflow for building and pushing container images to GitHub Container Registry (GHCR). Supports matrix builds for multiple packages including the azure-proxy services.","excerpt":"Reusable workflow for building and pushing container images to GitHub Container Registry (GHCR). Supports matrix builds for multiple packages including the azure-proxy services."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"built-packages","sectionTitle":"Built Packages","text":"azure-proxy/chisel - Chisel-based secure tunnel server for private network access azure-proxy/privoxy - Privoxy HTTP/SOCKS proxy server","excerpt":"azure-proxy/chisel - Chisel-based secure tunnel server for private network access azure-proxy/privoxy - Privoxy HTTP/SOCKS proxy server"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"add-or-remove-moduleyml","sectionTitle":"add-or-remove-module.yml","text":"Manual workflow for deploying or destroying infrastructure modules on demand. Evolved from the earlier bastion-only workflow to support all optional modules (bastion, jumpbox, azure_proxy, github_runners_aca).","excerpt":"Manual workflow for deploying or destroying infrastructure modules on demand. Evolved from the earlier bastion-only workflow to support all optional modules (bastion, jumpbox, azure_proxy, github_runners_aca)."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"when-to-use-2","sectionTitle":"When to Use","text":"Deploy Module : When you need to provision a specific infrastructure module Destroy Module : When done, to save costs or clean up resources","excerpt":"Deploy Module : When you need to provision a specific infrastructure module Destroy Module : When done, to save costs or clean up resources"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"how-to-run","sectionTitle":"How to Run","text":"Go to Actions tab in GitHub Select \"Deploy or Remove Bastion Host\" Click \"Run workflow\" Choose tools , module, and command","excerpt":"Go to Actions tab in GitHub Select \"Deploy or Remove Bastion Host\" Click \"Run workflow\" Choose tools , module, and command"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"workflow-inputs","sectionTitle":"Workflow Inputs","text":"Input Options Description environment_name tools Target environment module bastion, jumpbox, azure_proxy, github_runners_aca Module to deploy or destroy command apply, destroy Terraform command to execute Cost Optimization: Azure Bastion has hourly charges (~$0.19/hour for Basic SKU). Deploy only when needed and destroy when done.","excerpt":"Input Options Description environment_name tools Target environment module bastion, jumpbox, azure_proxy, github_runners_aca Module to deploy or destroy command apply, destroy Terraform command to execute Cost…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"pr-openyml-pull-request-checks","sectionTitle":"pr-open.yml (Pull Request Checks)","text":"Runs on pull request events (and manual dispatch) to provide fast CI signal before merge.","excerpt":"Runs on pull request events (and manual dispatch) to provide fast CI signal before merge."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"automated-checks","sectionTitle":"Automated Checks","text":"Validation : Invokes .lint.yml (pre-commit fmt + tflint, conventional commits, fork check) Container Build Validation : Invokes .builds.yml for proxy images Tools Proxy Bootstrap : Invokes .deployer.yml to deploy azure_proxy in tools Plan Against Test : Invokes .deployer-using-secure-tunnel.yml with command=plan PR Description Update : Appends the test plan summary to the PR description under AI Hub Infra Changes Final Result : Reports pass/fail per job with clear ✅/❌ indicators; PR-Description is non-blocking Note: The pr-open workflow must pass before a PR can be merged. The plan step appends an AI Hub Infra Changes section to the PR description with a readable plan summary; when there are no infra diffs the section says No Changes to AI Hub Infra in this PR .","excerpt":"Validation : Invokes .lint.yml (pre-commit fmt + tflint, conventional commits, fork check) Container Build Validation : Invokes .builds.yml for proxy images Tools Proxy Bootstrap : Invokes .deployer.yml to deploy…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"scheduleyml-scheduled-cleanup","sectionTitle":"schedule.yml (Scheduled Cleanup)","text":"Automatically destroys Bastion every day at 5 PM PST to prevent unnecessary charges.","excerpt":"Automatically destroys Bastion every day at 5 PM PST to prevent unnecessary charges."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"schedule","sectionTitle":"Schedule","text":"# Runs daily at 5 PM PST (1 AM UTC next day) on: schedule: - cron: \"0 1 * * *\"","excerpt":"# Runs daily at 5 PM PST (1 AM UTC next day) on: schedule: - cron: \"0 1 * * *\""},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"workflow-logic","sectionTitle":"Workflow Logic","text":"Check if Bastion exists : Uses Azure CLI to query the Bastion resource Conditional destroy : Only runs Terraform destroy if Bastion is found Status notification : Reports whether Bastion was destroyed or already removed","excerpt":"Check if Bastion exists : Uses Azure CLI to query the Bastion resource Conditional destroy : Only runs Terraform destroy if Bastion is found Status notification : Reports whether Bastion was destroyed or already removed"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"jobs-flow","sectionTitle":"Jobs Flow","text":"check-and-destroy-bastion │ ├── bastion_exists=true ──► destroy-bastion ──► notification │ └── bastion_exists=false ──────────────────────► notification","excerpt":"check-and-destroy-bastion │ ├── bastion_exists=true ──► destroy-bastion ──► notification │ └── bastion_exists=false ──────────────────────► notification"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"manual-dispatchyml-manual-promotion-workflow","sectionTitle":"manual-dispatch.yml (Manual Promotion Workflow)","text":"Use this workflow to run plan , apply , or destroy for dev , test , and prod .","excerpt":"Use this workflow to run plan , apply , or destroy for dev , test , and prod ."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"how-it-works-2","sectionTitle":"How It Works","text":"Validates inputs — prod apply requires a deploy_tag (a semver tag like v1.2.3 from a successful merge-main.yml run) Deploys/refreshes azure_proxy in tools via .deployer.yml Passes encrypted proxy outputs to .deployer-using-secure-tunnel.yml Executes selected Terraform command in chosen environment For prod apply only : Creates a GitHub Release from the deployed tag with deployment metadata PROD is gated: The prod environment has required reviewers configured as a GitHub Environment protection rule. Any workflow job targeting prod will pause and wait for manual approval from designated reviewers before executing. Additionally, prod apply requires you to specify which semver git tag to deploy — ensuring only test-validated commits reach production. Dev Environment Scope: Developers may occasionally deploy to dev from a PR branch using workflow dispatch to test specific features. The dev environment does not include App Gateway or DNS Zone; end-to-end ingress and DNS validation is only supported in test and prod .","excerpt":"Validates inputs — prod apply requires a deploy_tag (a semver tag like v1.2.3 from a successful merge-main.yml run) Deploys/refreshes azure_proxy in tools via .deployer.yml Passes encrypted proxy outputs to…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"merge-mainyml-auto-apply-semantic-version-on-main","sectionTitle":"merge-main.yml (Auto Apply + Semantic Version on Main)","text":"This workflow runs on every push to main . It creates a semantic version tag using Conventional Commits and then applies infrastructure to test .","excerpt":"This workflow runs on every push to main . It creates a semantic version tag using Conventional Commits and then applies infrastructure to test ."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"execution-flow","sectionTitle":"Execution Flow","text":"Concurrently on push to main : Semantic version : TriPSs/conventional-changelog-action inspects commits since last tag ( feat: → minor, fix: → patch, BREAKING CHANGE → major), creates a git tag (e.g. v1.2.3 ), and pushes an updated CHANGELOG.md Proxy bootstrap : deploys/refreshes azure_proxy in tools via .deployer.yml Once azure_proxy is live, its encrypted URL+auth outputs are passed to .deployer-using-secure-tunnel.yml Run apply against test (through Chisel tunnel) After successful apply, integration tests run automatically in two phases (direct + via proxy — see .deployer-using-secure-tunnel.yml section) Why semver tags? Semantic version tags serve as the input for prod deployments. When promoting to prod via manual-dispatch.yml , you provide a version tag (e.g. v1.2.3 ) to ensure the exact commit that passed test is what gets applied to production. The version is derived from commit messages, so feat: and fix: prefixes directly control versioning.","excerpt":"Concurrently on push to main : Semantic version : TriPSs/conventional-changelog-action inspects commits since last tag ( feat: → minor, fix: → patch, BREAKING CHANGE → major), creates a git tag (e.g. v1.2.3 ), and pushes…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"release-process-test-prod","sectionTitle":"Release Process (TEST → PROD)","text":"Production releases follow a tag-based promotion flow:","excerpt":"Production releases follow a tag-based promotion flow:"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"steps-to-release-to-production","sectionTitle":"Steps to Release to Production","text":"Merge your PR to main — the test deployment and semantic versioning run automatically Verify the test deployment succeeded and a version tag was created (visible in Actions summary and repo tags, e.g. v1.2.3 ) Go to Actions → Deploy to Environments (Manual Dispatch) Select: environment=prod , command=apply , deploy_tag=v1.2.3 Click Run workflow — the job will pause waiting for prod environment approval A designated reviewer approves the deployment in the Actions UI After successful apply, a GitHub Release is automatically created with deployment details","excerpt":"Merge your PR to main — the test deployment and semantic versioning run automatically Verify the test deployment succeeded and a version tag was created (visible in Actions summary and repo tags, e.g. v1.2.3 ) Go to…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"release-contents","sectionTitle":"Release Contents","text":"Each GitHub Release created for prod includes: The git tag that was deployed Commit SHA Who triggered the deployment Link to the workflow run Timestamp","excerpt":"Each GitHub Release created for prod includes: The git tag that was deployed Commit SHA Who triggered the deployment Link to the workflow run Timestamp"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"concurrency-strategy","sectionTitle":"Concurrency Strategy","text":"Several workflows and reusable jobs use concurrency to prevent race conditions and conflicting Terraform operations. Workflow/Job Concurrency Group Why It Helps .deployer.yml tools Serializes tools/bootstrap changes so multiple runs don't mutate shared proxy infra at the same time. .deployer-using-secure-tunnel.yml ${environment_name} Ensures only one Terraform operation per environment runs at once (for example, only one test apply). pr-open.yml builds job builds-${PR number} (cancel in-progress) Stops stale image builds when a newer commit arrives in the same PR. manual-dispatch.yml manual-deploy-${run_id} Keeps each manually triggered deployment isolated and traceable to a single run. merge-main.yml deploy-test-on-main Queues merges to main so test applies execute in order and avoid state lock contention. Practical Effect: Concurrency improves deployment reliability by reducing Terraform state lock failures, avoiding overlapping applies, and ensuring each environment converges predictably.","excerpt":"Several workflows and reusable jobs use concurrency to prevent race conditions and conflicting Terraform operations. Workflow/Job Concurrency Group Why It Helps .deployer.yml tools Serializes tools/bootstrap changes so…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"apim-key-rotationyml-scheduled-manual","sectionTitle":"apim-key-rotation.yml (Scheduled + Manual)","text":"Rotates APIM subscription keys using OIDC-authenticated Azure CLI execution.","excerpt":"Rotates APIM subscription keys using OIDC-authenticated Azure CLI execution."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"manual-mode","sectionTitle":"Manual Mode","text":"Trigger with workflow_dispatch Select environment: dev , test , prod Optional dry_run=true for safe preview","excerpt":"Trigger with workflow_dispatch Select environment: dev , test , prod Optional dry_run=true for safe preview"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"scheduled-mode","sectionTitle":"Scheduled Mode","text":"Runs daily at 0 9 * * * UTC (1–2 AM Pacific, depending on DST) rotate-dev and rotate-test run concurrently (no dependency between them) rotate-prod has needs: [rotate-test] — waits for test to succeed first A notify job ( if: always() ) prints a per-environment result summary","excerpt":"Runs daily at 0 9 * * * UTC (1–2 AM Pacific, depending on DST) rotate-dev and rotate-test run concurrently (no dependency between them) rotate-prod has needs: [rotate-test] — waits for test to succeed first A notify job…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"pagesyml-documentation","sectionTitle":"pages.yml (Documentation)","text":"Deploys this documentation site to GitHub Pages when changes are pushed to docs or Terraform roots (so generated references stay current).","excerpt":"Deploys this documentation site to GitHub Pages when changes are pushed to docs or Terraform roots (so generated references stay current)."},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"triggers","sectionTitle":"Triggers","text":"Push to main : When files in docs/** , initial-setup/infra/** , or infra-ai-hub/** change Manual : Can be triggered manually via workflow_dispatch","excerpt":"Push to main : When files in docs/** , initial-setup/infra/** , or infra-ai-hub/** change Manual : Can be triggered manually via workflow_dispatch"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"deployment-steps","sectionTitle":"Deployment Steps","text":"Checkout repository Run docs/generate-tf-docs.sh to refresh Terraform reference content Run docs/build.sh to generate HTML from templates Configure GitHub Pages Upload docs/ folder as artifact Deploy to GitHub Pages","excerpt":"Checkout repository Run docs/generate-tf-docs.sh to refresh Terraform reference content Run docs/build.sh to generate HTML from templates Configure GitHub Pages Upload docs/ folder as artifact Deploy to GitHub Pages"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"environment-secrets","sectionTitle":"Environment Secrets","text":"Each GitHub environment requires these secrets (created by initial-azure-setup.sh ): Secret Description Source AZURE_CLIENT_ID Managed Identity client ID Created by setup script AZURE_TENANT_ID Azure AD tenant ID Your Azure subscription AZURE_SUBSCRIPTION_ID Target subscription ID Your Azure subscription VNET_RESOURCE_GROUP_NAME Resource group containing VNet Your infrastructure VNET_NAME Existing VNet name Your infrastructure VNET_ADDRESS_SPACE VNet CIDR block Your infrastructure","excerpt":"Each GitHub environment requires these secrets (created by initial-azure-setup.sh ): Secret Description Source AZURE_CLIENT_ID Managed Identity client ID Created by setup script AZURE_TENANT_ID Azure AD tenant ID Your…"},{"page":"workflows.html","pageTitle":"GitHub Actions Workflows","sectionId":"running-workflows-locally","sectionTitle":"Running Workflows Locally","text":"For local development and testing, use the deployment scripts in each Terraform root: # Ensure you're logged in az login # Initial setup / tools ./initial-setup/infra/deploy-terraform.sh init ./initial-setup/infra/deploy-terraform.sh plan ./initial-setup/infra/deploy-terraform.sh apply # AI Hub stacks ./infra-ai-hub/scripts/deploy-terraform.sh plan dev ./infra-ai-hub/scripts/deploy-terraform.sh apply test Note: Local runs use your Azure CLI credentials instead of OIDC. Make sure you have the required permissions. AI Services Hub Infrastructure as Code for Azure Landing Zone deployments Resources GitHub Repository Architecture Diagram Documentation AI Services Architecture Diagrams Playbooks ADRs FAQ BC Government gov.bc.ca Digital Office &copy; 2026 Province of British Columbia Built with zero dependencies (function () { function scrollToWithHeaderOffset(el) { if (!el) return; const header = document.querySelector('.bc-header'); const offset = (header ? header.getBoundingClientRect().height : 0) + 16; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: Math.max(0, top) }); } function openDetailsFromHash() { const hash = window.location.hash; if (!hash || hash.length title. requestAnimationFrame(function () { requestAnimationFrame(function () { scrollToWithHeaderOffset(el); }); }); } } document.addEventListener('DOMContentLoaded', function () { openDetailsFromHash(); }); window.addEventListener('hashchange', function () { openDetailsFromHash(); }); // If user clicks the same #hash twice, hashchange won't fire. // This ensures ADR links always expand. document.addEventListener('click', function (e) { const link = e.target.closest && e.target.closest('a[href^=\"#\"]'); if (!link) return; const href = link.getAttribute('href'); if (!href || href.length","excerpt":"For local development and testing, use the deployment scripts in each Terraform root: # Ensure you're logged in az login # Initial setup / tools ./initial-setup/infra/deploy-terraform.sh init…"}]