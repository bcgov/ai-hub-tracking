<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 1200">
  <defs>
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#001a33"/>
      <stop offset="100%" style="stop-color:#003366"/>
    </linearGradient>
    <linearGradient id="vnetGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#1a5a96" stop-opacity="0.3"/>
      <stop offset="100%" style="stop-color:#003366" stop-opacity="0.1"/>
    </linearGradient>
    <filter id="shadow">
      <feDropShadow dx="0" dy="3" stdDeviation="4" flood-opacity="0.3"/>
    </filter>
    <marker id="arrowGold" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#fcba19"/>
    </marker>
    <marker id="arrowGreen" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#4ade80"/>
    </marker>
    <marker id="arrowBlue" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#60a5fa"/>
    </marker>
    <marker id="arrowRed" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#ef4444"/>
    </marker>
    <marker id="arrowPurple" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#a78bfa"/>
    </marker>
    <marker id="arrowWhite" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#94a3b8"/>
    </marker>
    <marker id="arrowCyan" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#22d3ee"/>
    </marker>
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#1a4d80" stroke-width="0.5" opacity="0.3"/>
    </pattern>
  </defs>

  <!-- Background -->
  <rect width="1600" height="1200" fill="url(#bgGrad)"/>
  <rect width="1600" height="1200" fill="url(#grid)"/>

  <!-- Title -->
  <text x="800" y="40" text-anchor="middle" font-family="Arial, sans-serif" font-size="26" font-weight="bold" fill="white">Network Architecture — VWAN Spoke</text>
  <text x="800" y="65" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" fill="#94a3b8">Azure Landing Zone · App Gateway WAF_v2 · APIM StandardV2 · Private Endpoints · Multi-Tenant</text>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- INTERNET + PUBLIC DNS -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <g filter="url(#shadow)">
    <ellipse cx="140" cy="170" rx="110" ry="50" fill="#374151" stroke="#6b7280" stroke-width="2"/>
    <text x="140" y="165" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="white">Internet</text>
    <text x="140" y="185" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#9ca3af">Public Clients</text>
  </g>

  <!-- Public DNS -->
  <g filter="url(#shadow)">
    <rect x="60" y="250" width="160" height="60" rx="8" fill="#0c4a6e" stroke="#0ea5e9" stroke-width="1.5"/>
    <text x="140" y="275" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#0ea5e9" font-weight="bold">Public DNS Zone</text>
    <text x="140" y="293" text-anchor="middle" font-family="monospace" font-size="8" fill="#94a3b8">{env}.aihub.gov.bc.ca</text>
  </g>
  <path d="M 140 220 L 140 250" stroke="#0ea5e9" stroke-width="1.5" marker-end="url(#arrowCyan)"/>
  <path d="M 220 280 L 300 280" stroke="#fcba19" stroke-width="2" marker-end="url(#arrowGold)"/>
  <text x="258" y="272" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#fcba19">A → PIP</text>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- AZURE SUBSCRIPTION BOUNDARY -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <rect x="290" y="80" width="1280" height="1080" rx="16" fill="none" stroke="#0078d4" stroke-width="2" stroke-dasharray="8,4"/>
  <text x="310" y="100" font-family="Arial, sans-serif" font-size="11" fill="#0078d4" font-weight="bold">Azure Subscription — Canada Central</text>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- VNET (VWAN SPOKE - PRE-EXISTING) -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <rect x="310" y="115" width="1240" height="1030" rx="14" fill="url(#vnetGrad)" stroke="#1a5a96" stroke-width="2"/>
  <text x="330" y="140" font-family="Arial, sans-serif" font-size="13" fill="#93c5fd" font-weight="bold">VNet: da4cf6-{env}-vwan-spoke (VWAN Spoke — pre-existing)</text>
  <text x="330" y="158" font-family="monospace" font-size="10" fill="#64748b">Address Spaces: 10.x.136.0/24 + 10.x.82.0/24 (2 × /24)</text>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- APP GATEWAY SUBNET -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <g filter="url(#shadow)">
    <rect x="340" y="180" width="390" height="280" rx="10" fill="#002244" stroke="#fcba19" stroke-width="2"/>
    <text x="535" y="205" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#fcba19" font-weight="bold">appgw-subnet</text>
    <text x="535" y="222" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">10.x.82.32/27 · NSG: appgw-nsg · RT: appgw-rt</text>

    <!-- App Gateway box -->
    <rect x="360" y="238" width="350" height="205" rx="8" fill="#1e3a5f" stroke="#60a5fa" stroke-width="1.5"/>
    <text x="535" y="262" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="white" font-weight="bold">Application Gateway (WAF_v2)</text>
    <text x="535" y="280" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#60a5fa">Autoscale 1-2 · Zones 1,2,3 · Static PIP</text>

    <!-- AppGW details -->
    <g font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">
      <text x="380" y="305"><tspan fill="#22c55e">Frontend:</tspan> 443 (HTTPS) + 80 (HTTP→redirect)</text>
      <text x="380" y="322"><tspan fill="#22c55e">SSL:</tspan> TLS 1.2+ · AppGwSslPolicy20220101S</text>
      <text x="380" y="339"><tspan fill="#22c55e">Backend Pool:</tspan> APIM FQDN (private DNS)</text>
      <text x="380" y="356"><tspan fill="#22c55e">Backend HTTPS:</tspan> 443, pick hostname, probe /status-*</text>
      <text x="380" y="373"><tspan fill="#fcba19">Rewrite 1:</tspan> Ocp-Apim-Subscription-Key → api-key</text>
      <text x="380" y="390"><tspan fill="#fcba19">Rewrite 2:</tspan> Add X-Forwarded-Host header</text>
      <text x="380" y="407"><tspan fill="#ef4444">Identity:</tspan> User-Assigned MI (KV Secrets User)</text>
    </g>

    <!-- WAF Policy badge -->
    <rect x="545" y="420" width="155" height="16" rx="4" fill="#ef4444"/>
    <text x="622" y="432" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white" font-weight="bold">WAF Prevention · OWASP 3.2</text>
  </g>

  <!-- NSG rules callout for AppGW -->
  <g filter="url(#shadow)">
    <rect x="340" y="475" width="390" height="82" rx="8" fill="#1c1917" stroke="#f97316" stroke-width="1"/>
    <text x="360" y="495" font-family="Arial, sans-serif" font-size="10" fill="#f97316" font-weight="bold">appgw-nsg Rules</text>
    <g font-family="monospace" font-size="8" fill="#94a3b8">
      <text x="360" y="512"><tspan fill="#4ade80">100 IN</tspan>  Allow Internet → 443 (HTTPS)</text>
      <text x="360" y="526"><tspan fill="#4ade80">110 IN</tspan>  Allow Internet → 80 (HTTP)</text>
      <text x="360" y="540"><tspan fill="#4ade80">120 IN</tspan>  Allow GatewayManager → 65200-65535</text>
      <text x="360" y="554"><tspan fill="#4ade80">130 IN</tspan>  Allow AzureLoadBalancer → *</text>
    </g>
  </g>

  <!-- Route Table badge -->
  <g filter="url(#shadow)">
    <rect x="340" y="566" width="390" height="32" rx="6" fill="#92400e" stroke="#fcba19" stroke-width="1"/>
    <text x="535" y="586" text-anchor="middle" font-family="monospace" font-size="9" fill="#fcba19">Route Table: 0.0.0.0/0 → Internet (prevent VWAN asymmetric routing)</text>
  </g>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- APIM SUBNET -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <g filter="url(#shadow)">
    <rect x="760" y="180" width="360" height="280" rx="10" fill="#002244" stroke="#a78bfa" stroke-width="2"/>
    <text x="940" y="205" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#a78bfa" font-weight="bold">apim-subnet</text>
    <text x="940" y="222" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">10.x.82.0/27 · NSG: apim-nsg · Delegation: Microsoft.Web/serverFarms</text>

    <!-- APIM box -->
    <rect x="780" y="238" width="320" height="205" rx="8" fill="#1e3a5f" stroke="#a78bfa" stroke-width="1.5"/>
    <text x="940" y="262" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="white" font-weight="bold">API Management (StandardV2)</text>
    <text x="940" y="280" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#a78bfa">Outbound VNet Integration · Public Access: Disabled</text>

    <g font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">
      <text x="800" y="305"><tspan fill="#22c55e">Inbound:</tspan> via Private Endpoint (PE subnet)</text>
      <text x="800" y="322"><tspan fill="#22c55e">Outbound:</tspan> VNet-injected (this subnet)</text>
      <text x="800" y="339"><tspan fill="#22c55e">API Key:</tspan> api-key header (Azure SDK compat)</text>
      <text x="800" y="356"><tspan fill="#fcba19">Per-tenant APIs:</tspan></text>
      <text x="810" y="373">OpenAI · Doc Intel · AI Search · Speech</text>
      <text x="810" y="390">Language · Storage · Cosmos DB</text>
      <text x="800" y="410"><tspan fill="#ef4444">Auth:</tspan> Managed Identity → backend services</text>
      <text x="800" y="427"><tspan fill="#ef4444">Policy:</tspan> Rate limit · PII · Usage log · MI</text>
    </g>
  </g>

  <!-- APIM NSG -->
  <g filter="url(#shadow)">
    <rect x="760" y="475" width="360" height="123" rx="8" fill="#1c1917" stroke="#f97316" stroke-width="1"/>
    <text x="780" y="495" font-family="Arial, sans-serif" font-size="10" fill="#f97316" font-weight="bold">apim-nsg Rules</text>
    <g font-family="monospace" font-size="8" fill="#94a3b8">
      <text x="780" y="512"><tspan fill="#4ade80">100 IN</tspan>  Allow ApiManagement → VNet:3443</text>
      <text x="780" y="526"><tspan fill="#4ade80">110 IN</tspan>  Allow AzureLoadBalancer → VNet:*</text>
      <text x="780" y="540"><tspan fill="#60a5fa">100 OUT</tspan> Allow VNet → Storage:443</text>
      <text x="780" y="554"><tspan fill="#60a5fa">110 OUT</tspan> Allow VNet → AzureKeyVault:443</text>
      <text x="780" y="568"><tspan fill="#60a5fa">120 OUT</tspan> Allow VNet → VNet:443</text>
      <text x="780" y="582"><tspan fill="#60a5fa">130 OUT</tspan> Allow VNet → AAD:443 + Internet:443</text>
    </g>
  </g>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- ACA SUBNET -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <g filter="url(#shadow)">
    <rect x="1150" y="180" width="370" height="145" rx="10" fill="#002244" stroke="#22d3ee" stroke-width="2"/>
    <text x="1335" y="205" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#22d3ee" font-weight="bold">aca-subnet (if enabled)</text>
    <text x="1335" y="222" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">10.x.82.64/27 · NSG: aca-nsg · Delegation: Microsoft.App/environments</text>

    <rect x="1170" y="238" width="330" height="72" rx="8" fill="#1e3a5f" stroke="#22d3ee" stroke-width="1"/>
    <text x="1335" y="262" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="white" font-weight="bold">Container App Environment</text>
    <text x="1335" y="280" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#22d3ee">Internal LB · mTLS · Key Rotation Func</text>
    <text x="1335" y="296" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">NSG: ACR + Monitor + AAD outbound allowed</text>
  </g>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- TOOLS VNET (source) -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <g filter="url(#shadow)">
    <rect x="1150" y="345" width="370" height="120" rx="10" fill="#002244" stroke="#64748b" stroke-width="2" stroke-dasharray="6,3"/>
    <text x="1335" y="370" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8" font-weight="bold">Tools VNet (Source — VWAN Spoke)</text>
    <text x="1335" y="388" text-anchor="middle" font-family="monospace" font-size="9" fill="#64748b">10.x.115.0/24 · Separate resource group</text>
    <g font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">
      <text x="1170" y="412">Chisel Tunnel (Container App proxy)</text>
      <text x="1170" y="430">GitHub Actions → Secure Tunnel → this VNet</text>
      <text x="1170" y="448">NSG rules allow traffic to/from PE subnet</text>
    </g>
  </g>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- PRIVATE ENDPOINTS SUBNET (main /24) -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <g filter="url(#shadow)">
    <rect x="340" y="625" width="1180" height="480" rx="12" fill="#002244" stroke="#22c55e" stroke-width="2"/>
    <text x="930" y="652" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#22c55e" font-weight="bold">privateendpoints-subnet</text>
    <text x="930" y="672" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">10.x.136.0/24 · NSG: pe-nsg · All PaaS Private Endpoints · 8 × /27 logical pools for multi-tenant scaling</text>

    <!-- ─── SHARED STACK PRIVATE ENDPOINTS ─── -->
    <rect x="365" y="690" width="550" height="190" rx="8" fill="#0c4a6e" stroke="#1a5a96" stroke-width="1.5"/>
    <text x="640" y="712" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#60a5fa" font-weight="bold">Shared Stack Private Endpoints</text>

    <!-- PE items - row 1 -->
    <rect x="380" y="725" width="155" height="55" rx="6" fill="#1e3a5f" stroke="#60a5fa" stroke-width="1"/>
    <text x="457" y="748" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">AI Foundry Hub</text>
    <text x="457" y="762" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">OpenAI models (Canada East)</text>
    <text x="457" y="774" text-anchor="middle" font-family="monospace" font-size="7" fill="#60a5fa">cognitiveservices</text>

    <rect x="550" y="725" width="155" height="55" rx="6" fill="#1e3a5f" stroke="#60a5fa" stroke-width="1"/>
    <text x="627" y="748" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">APIM PE</text>
    <text x="627" y="762" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">Gateway inbound endpoint</text>
    <text x="627" y="774" text-anchor="middle" font-family="monospace" font-size="7" fill="#a78bfa">azure-api.net</text>

    <rect x="720" y="725" width="175" height="55" rx="6" fill="#1e3a5f" stroke="#60a5fa" stroke-width="1"/>
    <text x="807" y="748" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">Hub Key Vault</text>
    <text x="807" y="762" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">Certs, keys, rotation secrets</text>
    <text x="807" y="774" text-anchor="middle" font-family="monospace" font-size="7" fill="#22c55e">vaultcore.azure.net</text>

    <!-- PE items - row 2 -->
    <rect x="380" y="795" width="155" height="55" rx="6" fill="#1e3a5f" stroke="#60a5fa" stroke-width="1"/>
    <text x="457" y="818" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">Language Service</text>
    <text x="457" y="832" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">PII detection</text>
    <text x="457" y="844" text-anchor="middle" font-family="monospace" font-size="7" fill="#60a5fa">cognitiveservices</text>

    <rect x="550" y="795" width="155" height="55" rx="6" fill="#1e3a5f" stroke="#60a5fa" stroke-width="1"/>
    <text x="627" y="818" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">App Configuration</text>
    <text x="627" y="832" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">Feature flags, config</text>
    <text x="627" y="844" text-anchor="middle" font-family="monospace" font-size="7" fill="#0ea5e9">azconfig.io</text>

    <rect x="720" y="795" width="175" height="55" rx="6" fill="#1e3a5f" stroke="#60a5fa" stroke-width="1"/>
    <text x="807" y="818" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">Container Registry</text>
    <text x="807" y="832" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">Premium SKU (if private)</text>
    <text x="807" y="844" text-anchor="middle" font-family="monospace" font-size="7" fill="#22d3ee">azurecr.io</text>

    <!-- ─── PER-TENANT PRIVATE ENDPOINTS ─── -->
    <rect x="935" y="690" width="565" height="190" rx="8" fill="#14532d" stroke="#166534" stroke-width="1.5"/>
    <text x="1217" y="712" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#4ade80" font-weight="bold">Per-Tenant Private Endpoints (× N tenants)</text>

    <!-- Tenant PE items - row 1 -->
    <rect x="950" y="725" width="165" height="55" rx="6" fill="#1e3a5f" stroke="#4ade80" stroke-width="1"/>
    <text x="1032" y="748" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">Tenant Key Vault</text>
    <text x="1032" y="762" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">Per-tenant secrets</text>
    <text x="1032" y="774" text-anchor="middle" font-family="monospace" font-size="7" fill="#22c55e">vaultcore.azure.net</text>

    <rect x="1130" y="725" width="165" height="55" rx="6" fill="#1e3a5f" stroke="#4ade80" stroke-width="1"/>
    <text x="1212" y="748" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">AI Search</text>
    <text x="1212" y="762" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">Semantic search index</text>
    <text x="1212" y="774" text-anchor="middle" font-family="monospace" font-size="7" fill="#0ea5e9">search.windows.net</text>

    <rect x="1310" y="725" width="175" height="55" rx="6" fill="#1e3a5f" stroke="#4ade80" stroke-width="1"/>
    <text x="1397" y="748" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">Document Intelligence</text>
    <text x="1397" y="762" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">Form recognizer</text>
    <text x="1397" y="774" text-anchor="middle" font-family="monospace" font-size="7" fill="#60a5fa">cognitiveservices</text>

    <!-- Tenant PE items - row 2 -->
    <rect x="950" y="795" width="165" height="55" rx="6" fill="#1e3a5f" stroke="#4ade80" stroke-width="1"/>
    <text x="1032" y="818" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">Speech Services</text>
    <text x="1032" y="832" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">STT / TTS</text>
    <text x="1032" y="844" text-anchor="middle" font-family="monospace" font-size="7" fill="#60a5fa">cognitiveservices</text>

    <rect x="1130" y="795" width="165" height="55" rx="6" fill="#1e3a5f" stroke="#4ade80" stroke-width="1"/>
    <text x="1212" y="818" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white" font-weight="bold">Cosmos DB</text>
    <text x="1212" y="832" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#94a3b8">Chat history / state</text>
    <text x="1212" y="844" text-anchor="middle" font-family="monospace" font-size="7" fill="#f97316">documents.azure.com</text>

    <rect x="1310" y="795" width="175" height="55" rx="6" fill="#374151" stroke="#64748b" stroke-width="1" stroke-dasharray="4,2"/>
    <text x="1397" y="818" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#94a3b8" font-weight="bold">Storage Account</text>
    <text x="1397" y="832" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#64748b">Public access (no PE)</text>
    <text x="1397" y="844" text-anchor="middle" font-family="monospace" font-size="7" fill="#64748b">blob.core.windows.net</text>

    <!-- ─── PE SUBNET NSG ─── -->
    <rect x="365" y="893" width="550" height="95" rx="8" fill="#1c1917" stroke="#f97316" stroke-width="1"/>
    <text x="385" y="913" font-family="Arial, sans-serif" font-size="10" fill="#f97316" font-weight="bold">pe-nsg Rules</text>
    <g font-family="monospace" font-size="8" fill="#94a3b8">
      <text x="385" y="930"><tspan fill="#4ade80">100 IN</tspan>  Allow 10.x.136.0/24 → 10.x.136.0/24 (self)</text>
      <text x="385" y="944"><tspan fill="#4ade80">101 IN</tspan>  Allow 10.x.82.0/24 → 10.x.136.0/24 (infra subnets)</text>
      <text x="385" y="958"><tspan fill="#4ade80">300 IN</tspan>  Allow 10.x.115.0/24 → PE subnet (tools VNet)</text>
      <text x="385" y="972"><tspan fill="#60a5fa">200-301 OUT</tspan> Allow PE ↔ VNet + PE ↔ Tools VNet</text>
    </g>

    <!-- ─── PRIVATE DNS ZONES ─── -->
    <rect x="935" y="893" width="565" height="95" rx="8" fill="#0c4a6e" stroke="#0ea5e9" stroke-width="1"/>
    <text x="1217" y="913" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#0ea5e9" font-weight="bold">Private DNS Zones (Azure Policy-Managed)</text>
    <g font-family="monospace" font-size="7.5" fill="#94a3b8">
      <text x="955" y="932">privatelink.cognitiveservices.azure.com (AI Foundry, Doc Intel, Speech, Language)</text>
      <text x="955" y="946">privatelink.azure-api.net (APIM) · privatelink.vaultcore.azure.net (KV)</text>
      <text x="955" y="960">privatelink.search.windows.net · privatelink.documents.azure.com (Cosmos)</text>
      <text x="955" y="974">privatelink.azconfig.io (App Config) · privatelink.azurecr.io (ACR)</text>
    </g>

    <!-- ─── ARCHITECTURE NOTE ─── -->
    <rect x="365" y="1002" width="1135" height="85" rx="8" fill="#374151" stroke="#64748b" stroke-width="1"/>
    <text x="930" y="1022" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#fcba19" font-weight="bold">Key Architecture Notes</text>
    <g font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">
      <text x="385" y="1040"><tspan fill="#fcba19">①</tspan> VWAN Spoke — AppGW needs route table (0.0.0.0/0 → Internet) to prevent asymmetric routing through VWAN hub</text>
      <text x="385" y="1056"><tspan fill="#fcba19">②</tspan> APIM dual-homed — inbound via PE (PE subnet), outbound via VNet integration (APIM subnet) → reaches all backend PEs</text>
      <text x="385" y="1072"><tspan fill="#fcba19">③</tspan> Cross-region — AI Foundry Hub in Canada East for model availability, PE connects cross-region to Canada Central VNet</text>
      <text x="385" y="1088"><tspan fill="#fcba19">④</tspan> Policy DNS — Landing Zone Azure Policy auto-creates DNS zone groups on PEs; TF uses wait-for-dns-zone.sh to poll propagation</text>
    </g>
  </g>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- CONNECTION ARROWS -->
  <!-- ═══════════════════════════════════════════════════════════ -->

  <!-- Internet → AppGW (public entry) -->
  <path d="M 250 170 L 358 290" stroke="#fcba19" stroke-width="2.5" fill="none" marker-end="url(#arrowGold)"/>
  <text x="270" y="218" font-family="Arial, sans-serif" font-size="9" fill="#fcba19" transform="rotate(25 270 218)">HTTPS (443)</text>

  <!-- AppGW → APIM PE (via private DNS → PE subnet) -->
  <path d="M 535 443 L 535 540 L 535 560 L 627 560 L 627 625 L 627 725" stroke="#60a5fa" stroke-width="2" fill="none" marker-end="url(#arrowBlue)" stroke-dasharray="6,3"/>
  <text x="543" y="518" font-family="Arial, sans-serif" font-size="8" fill="#60a5fa">Backend → APIM FQDN</text>
  <text x="543" y="532" font-family="Arial, sans-serif" font-size="8" fill="#64748b">(resolves via private DNS to PE IP)</text>

  <!-- APIM PE (in PE subnet) → APIM (via VNet integration) -->
  <path d="M 627 725 L 720 625 L 810 500 L 860 460" stroke="#a78bfa" stroke-width="2" fill="none" marker-end="url(#arrowPurple)" stroke-dasharray="4,3"/>
  <text x="730" y="580" font-family="Arial, sans-serif" font-size="8" fill="#a78bfa" transform="rotate(-40 730 580)">PE → APIM instance</text>

  <!-- APIM outbound → backend PEs -->
  <path d="M 940 460 L 940 540 L 750 625 L 640 690" stroke="#22c55e" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
  <text x="865" y="555" font-family="Arial, sans-serif" font-size="8" fill="#22c55e">VNet-injected outbound</text>
  <text x="865" y="568" font-family="Arial, sans-serif" font-size="8" fill="#64748b">→ reaches all PEs in subnet</text>

  <!-- APIM → tenant PEs -->
  <path d="M 940 540 L 1100 625 L 1217 690" stroke="#4ade80" stroke-width="2" fill="none" marker-end="url(#arrowGreen)" stroke-dasharray="5,3"/>

  <!-- Tools VNet → PE subnet -->
  <path d="M 1335 465 L 1335 540 L 1300 625" stroke="#94a3b8" stroke-width="1.5" fill="none" marker-end="url(#arrowWhite)" stroke-dasharray="6,3"/>
  <text x="1345" y="510" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">Tunnel → PE access</text>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- LEGEND -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <g filter="url(#shadow)">
    <rect x="60" y="370" width="200" height="250" rx="8" fill="#002244" stroke="#64748b" stroke-width="1"/>
    <text x="160" y="395" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="white" font-weight="bold">Legend</text>

    <rect x="80" y="412" width="14" height="14" rx="3" fill="#fcba19"/>
    <text x="102" y="424" font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">App Gateway Subnet</text>

    <rect x="80" y="436" width="14" height="14" rx="3" fill="#a78bfa"/>
    <text x="102" y="448" font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">APIM Subnet</text>

    <rect x="80" y="460" width="14" height="14" rx="3" fill="#22c55e"/>
    <text x="102" y="472" font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">PE Subnet</text>

    <rect x="80" y="484" width="14" height="14" rx="3" fill="#22d3ee"/>
    <text x="102" y="496" font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">ACA Subnet</text>

    <rect x="80" y="508" width="14" height="14" rx="3" fill="#f97316"/>
    <text x="102" y="520" font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">NSG Rules</text>

    <rect x="80" y="532" width="14" height="14" rx="3" fill="#0ea5e9"/>
    <text x="102" y="544" font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">DNS Zones</text>

    <line x1="80" y1="564" x2="94" y2="564" stroke="#60a5fa" stroke-width="2" stroke-dasharray="4,2"/>
    <text x="102" y="568" font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">Private Link</text>

    <line x1="80" y1="586" x2="94" y2="586" stroke="#fcba19" stroke-width="2"/>
    <text x="102" y="590" font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">Public Traffic</text>

    <rect x="80" y="600" width="14" height="14" rx="3" fill="none" stroke="#64748b" stroke-width="1" stroke-dasharray="3,2"/>
    <text x="102" y="612" font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">Public Access (no PE)</text>
  </g>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- FOOTER -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <rect x="0" y="1160" width="1600" height="40" fill="#fcba19"/>
  <text x="800" y="1186" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#003366">AI Services Hub — Network Architecture (VWAN Spoke · App Gateway WAF_v2 → APIM StandardV2 → Private Endpoints)</text>
</svg>
