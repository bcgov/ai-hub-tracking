<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 950">
  <defs>
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#001a33"/>
      <stop offset="100%" style="stop-color:#003366"/>
    </linearGradient>
    <filter id="shadow">
      <feDropShadow dx="0" dy="4" stdDeviation="6" flood-opacity="0.3"/>
    </filter>
    <marker id="arrowGold" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#fcba19"/>
    </marker>
    <marker id="arrowGreen" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#4ade80"/>
    </marker>
    <marker id="arrowBlue" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#60a5fa"/>
    </marker>
    <marker id="arrowWhite" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#94a3b8"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1400" height="950" fill="url(#bgGrad)"/>
  <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#1a4d80" stroke-width="0.5" opacity="0.3"/>
  </pattern>
  <rect width="1400" height="950" fill="url(#grid)"/>

  <!-- Title -->
  <text x="700" y="42" text-anchor="middle" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="white">Deployment Pipeline</text>
  <text x="700" y="66" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#94a3b8">GitHub Actions CI/CD · Manual Dispatch · OIDC · Secure Tunnel · Phased Terraform</text>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- WORKFLOW OVERVIEW (top row) -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <rect x="40" y="88" width="1320" height="160" rx="12" fill="#002244" stroke="#1a5a96" stroke-width="1"/>
  <text x="700" y="112" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" fill="#60a5fa" font-weight="bold">GITHUB ACTIONS WORKFLOWS</text>

  <!-- manual-dispatch.yml -->
  <g filter="url(#shadow)">
    <rect x="65" y="125" width="250" height="108" rx="8" fill="#1e3a5f" stroke="#fcba19" stroke-width="2"/>
    <rect x="65" y="125" width="250" height="25" rx="8" fill="#92400e"/>
    <text x="190" y="142" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#fcba19" font-weight="bold">manual-dispatch.yml</text>
    <g font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">
      <text x="80" y="165">Trigger: <tspan fill="#fcba19">workflow_dispatch</tspan></text>
      <text x="80" y="180">Env: <tspan fill="#38bdf8">dev</tspan> | <tspan fill="#22c55e">test</tspan> | <tspan fill="#ef4444">prod</tspan></text>
      <text x="80" y="195">Cmd: <tspan fill="white">plan | apply | destroy</tspan></text>
      <text x="80" y="210">Flow: proxy → tunnel → deploy</text>
      <text x="80" y="225" fill="#4ade80">Primary deployment workflow</text>
    </g>
  </g>

  <!-- apim-key-rotation.yml -->
  <g filter="url(#shadow)">
    <rect x="340" y="125" width="220" height="108" rx="8" fill="#1e3a5f" stroke="#22c55e" stroke-width="2"/>
    <rect x="340" y="125" width="220" height="25" rx="8" fill="#166534"/>
    <text x="450" y="142" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#22c55e" font-weight="bold">apim-key-rotation.yml</text>
    <g font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">
      <text x="355" y="165">Trigger: <tspan fill="#22c55e">schedule + dispatch</tspan></text>
      <text x="355" y="180">Cron: <tspan fill="white">0 9 * * * (daily)</tspan></text>
      <text x="355" y="195">Env: dev∥test → prod (gated)</text>
      <text x="355" y="210">Script: rotate-apim-keys.sh</text>
      <text x="355" y="225" fill="#fcba19">Alternating slot pattern</text>
    </g>
  </g>

  <!-- add-or-remove-module.yml -->
  <g filter="url(#shadow)">
    <rect x="585" y="125" width="220" height="108" rx="8" fill="#1e3a5f" stroke="#a78bfa" stroke-width="2"/>
    <rect x="585" y="125" width="220" height="25" rx="8" fill="#5b21b6"/>
    <text x="695" y="142" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#a78bfa" font-weight="bold">add-or-remove-module.yml</text>
    <g font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">
      <text x="600" y="165">Trigger: <tspan fill="#a78bfa">workflow_dispatch</tspan></text>
      <text x="600" y="180">Env: <tspan fill="white">tools only</tspan></text>
      <text x="600" y="195">Modules: bastion, proxy,</text>
      <text x="600" y="210">  jumpbox, github-runners</text>
      <text x="600" y="225">Uses: <tspan fill="white">.deployer.yml</tspan></text>
    </g>
  </g>

  <!-- schedule.yml -->
  <g filter="url(#shadow)">
    <rect x="830" y="125" width="200" height="108" rx="8" fill="#1e3a5f" stroke="#0ea5e9" stroke-width="2"/>
    <rect x="830" y="125" width="200" height="25" rx="8" fill="#0369a1"/>
    <text x="930" y="142" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#0ea5e9" font-weight="bold">schedule.yml</text>
    <g font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">
      <text x="845" y="165">Trigger: <tspan fill="#0ea5e9">cron daily</tspan></text>
      <text x="845" y="180">Action: <tspan fill="white">Bastion cleanup</tspan></text>
      <text x="845" y="195">Check: az bastion exists?</text>
      <text x="845" y="210">If yes: destroy module</text>
      <text x="845" y="225">Env: <tspan fill="white">tools</tspan></text>
    </g>
  </g>

  <!-- pr-open.yml + pages.yml -->
  <g filter="url(#shadow)">
    <rect x="1055" y="125" width="140" height="108" rx="8" fill="#1e3a5f" stroke="#94a3b8" stroke-width="1.5"/>
    <rect x="1055" y="125" width="140" height="25" rx="8" fill="#374151"/>
    <text x="1125" y="142" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white" font-weight="bold">pr-open.yml</text>
    <g font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">
      <text x="1070" y="165">Trigger: <tspan fill="white">PR open</tspan></text>
      <text x="1070" y="180">Build containers</text>
      <text x="1070" y="195">chisel + privoxy</text>
      <text x="1070" y="210">Tag: PR# + latest</text>
      <text x="1070" y="225">Uses: <tspan fill="white">.builds.yml</tspan></text>
    </g>
  </g>

  <g filter="url(#shadow)">
    <rect x="1220" y="125" width="120" height="108" rx="8" fill="#1e3a5f" stroke="#94a3b8" stroke-width="1.5"/>
    <rect x="1220" y="125" width="120" height="25" rx="8" fill="#374151"/>
    <text x="1280" y="142" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white" font-weight="bold">pages.yml</text>
    <g font-family="Arial, sans-serif" font-size="9" fill="#94a3b8">
      <text x="1235" y="165">Trigger: <tspan fill="white">push main</tspan></text>
      <text x="1235" y="180">Generate TF docs</text>
      <text x="1235" y="195">Build HTML</text>
      <text x="1235" y="210">Deploy Pages</text>
      <text x="1235" y="225">Path: <tspan fill="white">docs/**</tspan></text>
    </g>
  </g>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- MAIN DEPLOYMENT FLOW (manual-dispatch detail) -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <rect x="40" y="268" width="1320" height="30" rx="8" fill="#1a5a96"/>
  <text x="700" y="288" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" fill="white" font-weight="bold">MAIN DEPLOYMENT FLOW — manual-dispatch.yml → .deployer.yml → .deployer-using-secure-tunnel.yml</text>

  <!-- Pipeline stages -->
  <rect x="40" y="310" width="1320" height="120" rx="12" fill="#002244" stroke="#1a5a96" stroke-width="1"/>
  <text x="700" y="335" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#60a5fa" font-weight="bold">Pipeline Stages (sequential)</text>

  <!-- Stage 1: Dispatch -->
  <g filter="url(#shadow)">
    <rect x="60" y="348" width="120" height="60" rx="6" fill="#374151" stroke="#fcba19" stroke-width="1.5"/>
    <text x="120" y="373" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#fcba19" font-weight="bold">Dispatch</text>
    <text x="120" y="393" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">env + command</text>
  </g>
  <path d="M 180 378 L 200 378" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowWhite)"/>

  <!-- Stage 2: Deploy Proxy -->
  <g filter="url(#shadow)">
    <rect x="205" y="348" width="130" height="60" rx="6" fill="#5b21b6" stroke="#a78bfa" stroke-width="1.5"/>
    <text x="270" y="373" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white" font-weight="bold">Proxy Deploy</text>
    <text x="270" y="393" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#c4b5fd">tools / azure_proxy</text>
  </g>
  <path d="M 335 378 L 355 378" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowWhite)"/>

  <!-- Stage 3: Health Check -->
  <g filter="url(#shadow)">
    <rect x="360" y="348" width="120" height="60" rx="6" fill="#14532d" stroke="#4ade80" stroke-width="1.5"/>
    <text x="420" y="373" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#4ade80" font-weight="bold">Health Check</text>
    <text x="420" y="393" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#bbf7d0">/healthz (120s)</text>
  </g>
  <path d="M 480 378 L 500 378" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowWhite)"/>

  <!-- Stage 4: Tunnel -->
  <g filter="url(#shadow)">
    <rect x="505" y="348" width="120" height="60" rx="6" fill="#991b1b" stroke="#ef4444" stroke-width="1.5"/>
    <text x="565" y="373" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white" font-weight="bold">Tunnel Setup</text>
    <text x="565" y="393" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#fca5a5">chisel + privoxy</text>
  </g>
  <path d="M 625 378 L 645 378" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowWhite)"/>

  <!-- Stage 5: OIDC -->
  <g filter="url(#shadow)">
    <rect x="650" y="348" width="110" height="60" rx="6" fill="#92400e" stroke="#fcba19" stroke-width="1.5"/>
    <text x="705" y="373" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#fcba19" font-weight="bold">OIDC Auth</text>
    <text x="705" y="393" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#fed7aa">azure/login@v2</text>
  </g>
  <path d="M 760 378 L 780 378" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowWhite)"/>

  <!-- Stage 6: TF Init -->
  <g filter="url(#shadow)">
    <rect x="785" y="348" width="110" height="60" rx="6" fill="#5c4ee5" stroke="#7c3aed" stroke-width="1.5"/>
    <text x="840" y="373" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white" font-weight="bold">TF Init</text>
    <text x="840" y="393" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#c4b5fd">backend config</text>
  </g>
  <path d="M 895 378 L 915 378" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowWhite)"/>

  <!-- Stage 7: Phased Deploy -->
  <g filter="url(#shadow)">
    <rect x="920" y="348" width="150" height="60" rx="6" fill="#0ea5e9" stroke="#38bdf8" stroke-width="1.5"/>
    <text x="995" y="373" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white" font-weight="bold">Phased Deploy</text>
    <text x="995" y="393" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#bae6fd">3-phase execution</text>
  </g>
  <path d="M 1070 378 L 1090 378" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowWhite)"/>

  <!-- Stage 8: Tests -->
  <g filter="url(#shadow)">
    <rect x="1095" y="348" width="110" height="60" rx="6" fill="#166534" stroke="#22c55e" stroke-width="1.5"/>
    <text x="1150" y="373" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#4ade80" font-weight="bold">Tests</text>
    <text x="1150" y="393" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#bbf7d0">bats + integration</text>
  </g>
  <path d="M 1205 378 L 1225 378" stroke="#94a3b8" stroke-width="1.5" marker-end="url(#arrowWhite)"/>

  <!-- Stage 9: Complete -->
  <g filter="url(#shadow)">
    <rect x="1230" y="348" width="110" height="60" rx="6" fill="#14532d" stroke="#22c55e" stroke-width="2"/>
    <text x="1285" y="373" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#4ade80" font-weight="bold">Complete</text>
    <text x="1285" y="393" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#86efac">✓ deployed</text>
  </g>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- REUSABLE WORKFLOWS + ENVIRONMENTS + STATE -->
  <!-- ═══════════════════════════════════════════════════════════ -->

  <!-- Reusable Workflows -->
  <g filter="url(#shadow)">
    <rect x="40" y="455" width="440" height="280" rx="12" fill="#002244" stroke="#1a5a96" stroke-width="2"/>
    <rect x="40" y="455" width="440" height="32" rx="12" fill="#1a5a96"/>
    <text x="260" y="476" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="white" font-weight="bold">Reusable Workflow Templates</text>

    <!-- .deployer.yml -->
    <rect x="60" y="500" width="400" height="95" rx="8" fill="#0c4a6e" stroke="#38bdf8" stroke-width="1"/>
    <text x="260" y="520" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#38bdf8" font-weight="bold">.deployer.yml — Direct Deployer</text>
    <g font-family="monospace" font-size="9" fill="#94a3b8">
      <text x="75" y="540"><tspan fill="#f97316">on:</tspan> workflow_call</text>
      <text x="75" y="555"><tspan fill="#22c55e">inputs:</tspan> environment, command, target_module</text>
      <text x="75" y="570">Uses: <tspan fill="white">initial-setup/infra/deploy-terraform.sh</tspan></text>
      <text x="75" y="585">For: <tspan fill="#fcba19">tools env</tspan> (bastion, proxy, jumpbox)</text>
    </g>

    <!-- .deployer-using-secure-tunnel.yml -->
    <rect x="60" y="610" width="400" height="110" rx="8" fill="#0c4a6e" stroke="#ef4444" stroke-width="1"/>
    <text x="260" y="630" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#ef4444" font-weight="bold">.deployer-using-secure-tunnel.yml</text>
    <g font-family="monospace" font-size="9" fill="#94a3b8">
      <text x="75" y="650"><tspan fill="#f97316">on:</tspan> workflow_call</text>
      <text x="75" y="665"><tspan fill="#22c55e">inputs:</tspan> environment, command, proxy_url, proxy_auth</text>
      <text x="75" y="680">Tunnel: chisel client + privoxy (HTTP proxy on :8118)</text>
      <text x="75" y="695">Uses: <tspan fill="white">infra-ai-hub/scripts/deploy-terraform.sh</tspan></text>
      <text x="75" y="710">For: <tspan fill="#fcba19">dev/test/prod</tspan> (needs private endpoint access)</text>
    </g>
  </g>

  <!-- Environment Cards -->
  <g filter="url(#shadow)">
    <rect x="510" y="455" width="420" height="280" rx="12" fill="#002244" stroke="#1a5a96" stroke-width="2"/>
    <rect x="510" y="455" width="420" height="32" rx="12" fill="#1a5a96"/>
    <text x="720" y="476" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="white" font-weight="bold">GitHub Environments</text>

    <!-- tools -->
    <rect x="530" y="498" width="180" height="60" rx="6" fill="#1e3a5f" stroke="#a78bfa" stroke-width="1.5"/>
    <text x="620" y="518" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#a78bfa" font-weight="bold">tools</text>
    <text x="620" y="535" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">Proxy, bastion, runners</text>
    <text x="620" y="550" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#4ade80">No approval</text>

    <!-- dev -->
    <rect x="730" y="498" width="180" height="60" rx="6" fill="#1e3a5f" stroke="#38bdf8" stroke-width="1.5"/>
    <text x="820" y="518" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#38bdf8" font-weight="bold">dev</text>
    <text x="820" y="535" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">Development testing</text>
    <text x="820" y="550" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#4ade80">No approval</text>

    <!-- test -->
    <rect x="530" y="575" width="180" height="60" rx="6" fill="#1e3a5f" stroke="#22c55e" stroke-width="1.5"/>
    <text x="620" y="595" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#22c55e" font-weight="bold">test</text>
    <text x="620" y="612" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">Integration / QA</text>
    <text x="620" y="627" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#4ade80">No approval</text>

    <!-- prod -->
    <rect x="730" y="575" width="180" height="60" rx="6" fill="#1e3a5f" stroke="#ef4444" stroke-width="2"/>
    <text x="820" y="595" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#ef4444" font-weight="bold">prod</text>
    <text x="820" y="612" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">Production (Canada Central)</text>
    <text x="820" y="627" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#f97316">Approval required</text>

    <!-- OIDC note -->
    <rect x="530" y="650" width="380" height="70" rx="6" fill="#0c4a6e" stroke="#fcba19" stroke-width="1"/>
    <text x="720" y="672" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#fcba19" font-weight="bold">OIDC Federation (per environment)</text>
    <g font-family="monospace" font-size="8" fill="#94a3b8">
      <text x="545" y="690">Subject: repo:*:environment:<tspan fill="#fcba19">&lt;env&gt;</tspan></text>
      <text x="545" y="705">Secrets: AZURE_CLIENT_ID, TENANT_ID, SUBSCRIPTION_ID</text>
    </g>
  </g>

  <!-- State Management + Secrets -->
  <g filter="url(#shadow)">
    <rect x="960" y="455" width="400" height="280" rx="12" fill="#002244" stroke="#1a5a96" stroke-width="2"/>
    <rect x="960" y="455" width="400" height="32" rx="12" fill="#1a5a96"/>
    <text x="1160" y="476" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="white" font-weight="bold">State &amp; Security</text>

    <!-- State backend -->
    <rect x="980" y="500" width="180" height="100" rx="8" fill="#0c4a6e" stroke="#0ea5e9" stroke-width="1.5"/>
    <text x="1070" y="520" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#0ea5e9" font-weight="bold">Azure Blob Backend</text>
    <g font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">
      <text x="995" y="540">Container: tfstate</text>
      <text x="995" y="555">Key: per-stack files</text>
      <text x="995" y="570">Lock: blob lease</text>
      <text x="995" y="585" fill="#4ade80">✓ encrypted at rest</text>
    </g>

    <!-- Secrets -->
    <rect x="1180" y="500" width="160" height="100" rx="8" fill="#0c4a6e" stroke="#ef4444" stroke-width="1.5"/>
    <text x="1260" y="520" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#ef4444" font-weight="bold">Required Secrets</text>
    <g font-family="monospace" font-size="8" fill="#fca5a5">
      <text x="1195" y="540">AZURE_CLIENT_ID</text>
      <text x="1195" y="555">AZURE_TENANT_ID</text>
      <text x="1195" y="570">AZURE_SUBSCRIPTION_ID</text>
      <text x="1195" y="585">GPG_PASSPHRASE</text>
    </g>

    <!-- Proxy output encryption -->
    <rect x="980" y="615" width="360" height="105" rx="8" fill="#0c4a6e" stroke="#a78bfa" stroke-width="1"/>
    <text x="1160" y="635" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#a78bfa" font-weight="bold">Secure Tunnel Architecture</text>
    <g font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">
      <text x="995" y="655">1. .deployer.yml → deploy azure_proxy to tools</text>
      <text x="995" y="670">2. Outputs: proxy_url + proxy_auth (GPG encrypted)</text>
      <text x="995" y="685">3. .deployer-using-secure-tunnel.yml decrypts</text>
      <text x="995" y="700">4. Chisel client → SOCKS5 → Privoxy → HTTP proxy</text>
      <text x="995" y="715" fill="#ef4444">5. All TF traffic routed through VNet private endpoints</text>
    </g>
  </g>

  <!-- ═══════════════════════════════════════════════════════════ -->
  <!-- DEPLOY SCRIPT LAYERS -->
  <!-- ═══════════════════════════════════════════════════════════ -->
  <rect x="40" y="760" width="1320" height="140" rx="12" fill="#002244" stroke="#fcba19" stroke-width="2"/>
  <rect x="40" y="760" width="1320" height="30" rx="12" fill="#92400e"/>
  <text x="700" y="780" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#fcba19" font-weight="bold">Script Architecture: deploy-terraform.sh → deploy-scaled.sh (3-Phase Execution Engine)</text>

  <!-- Layer boxes -->
  <g filter="url(#shadow)">
    <rect x="60" y="802" width="200" height="82" rx="6" fill="#1e3a5f" stroke="#fcba19" stroke-width="1.5"/>
    <text x="160" y="822" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#fcba19" font-weight="bold">deploy-terraform.sh</text>
    <g font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">
      <text x="75" y="840">CLI interface + validation</text>
      <text x="75" y="855">Azure auth + env setup</text>
      <text x="75" y="870">Orchestrates deploy-scaled.sh</text>
    </g>
  </g>
  <path d="M 260 842 L 285 842" stroke="#fcba19" stroke-width="2" marker-end="url(#arrowGold)"/>

  <g filter="url(#shadow)">
    <rect x="290" y="802" width="200" height="82" rx="6" fill="#1e3a5f" stroke="#60a5fa" stroke-width="1.5"/>
    <text x="390" y="822" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#60a5fa" font-weight="bold">deploy-scaled.sh</text>
    <g font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">
      <text x="305" y="840">Phase 1: shared (sequential)</text>
      <text x="305" y="855">Phase 2: tenants (parallel)</text>
      <text x="305" y="870">Phase 3: services (parallel)</text>
    </g>
  </g>
  <path d="M 490 842 L 515 842" stroke="#60a5fa" stroke-width="2" marker-end="url(#arrowBlue)"/>

  <!-- Phase boxes at bottom -->
  <g filter="url(#shadow)">
    <rect x="520" y="802" width="130" height="82" rx="6" fill="#1e40af" stroke="#60a5fa" stroke-width="1.5"/>
    <text x="585" y="822" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white" font-weight="bold">Phase 1</text>
    <text x="585" y="840" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">shared</text>
    <text x="585" y="855" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">network, KV, AppGW</text>
    <text x="585" y="870" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">foundry hub, WAF</text>
  </g>
  <path d="M 650 842 L 675 842" stroke="#fcba19" stroke-width="2" marker-end="url(#arrowGold)"/>

  <g filter="url(#shadow)">
    <rect x="680" y="802" width="130" height="82" rx="6" fill="#166534" stroke="#22c55e" stroke-width="1.5"/>
    <text x="745" y="822" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#4ade80" font-weight="bold">Phase 2</text>
    <text x="745" y="840" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">tenant (×N)</text>
    <text x="745" y="855" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">parallel per-tenant</text>
    <text x="745" y="870" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#4ade80">isolated state files</text>
  </g>
  <path d="M 810 842 L 835 842" stroke="#fcba19" stroke-width="2" marker-end="url(#arrowGold)"/>

  <g filter="url(#shadow)">
    <rect x="840" y="802" width="180" height="82" rx="6" fill="#5b21b6" stroke="#a78bfa" stroke-width="1.5"/>
    <text x="930" y="822" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white" font-weight="bold">Phase 3</text>
    <text x="930" y="840" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">foundry + apim +</text>
    <text x="930" y="855" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">tenant-user-mgmt</text>
    <text x="930" y="870" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#a78bfa">all 3 in parallel</text>
  </g>
  <path d="M 1020 842 L 1045 842" stroke="#4ade80" stroke-width="2" marker-end="url(#arrowGreen)"/>

  <!-- Integration tests -->
  <g filter="url(#shadow)">
    <rect x="1050" y="802" width="140" height="82" rx="6" fill="#14532d" stroke="#4ade80" stroke-width="1.5"/>
    <text x="1120" y="822" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#4ade80" font-weight="bold">Integration Tests</text>
    <text x="1120" y="840" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">bats-core harness</text>
    <text x="1120" y="855" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">run-tests.sh --env</text>
    <text x="1120" y="870" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#94a3b8">dev + test only</text>
  </g>
  <path d="M 1190 842 L 1215 842" stroke="#4ade80" stroke-width="2" marker-end="url(#arrowGreen)"/>

  <!-- Complete -->
  <g filter="url(#shadow)">
    <rect x="1220" y="802" width="120" height="82" rx="6" fill="#14532d" stroke="#22c55e" stroke-width="2"/>
    <text x="1280" y="830" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#4ade80" font-weight="bold">✓</text>
    <text x="1280" y="850" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white" font-weight="bold">Done</text>
    <text x="1280" y="870" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#4ade80">~4m 39s</text>
  </g>

  <!-- Footer -->
  <rect x="0" y="912" width="1400" height="38" fill="#fcba19"/>
  <text x="700" y="936" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#003366">AI Services Hub — Deployment Pipeline (GHA Manual Dispatch → OIDC → Secure Tunnel → Phased Terraform)</text>
</svg>
