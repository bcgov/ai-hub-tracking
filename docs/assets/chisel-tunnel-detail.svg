<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 900" width="1100" height="900">
  <defs>
    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#003366"/>
      <stop offset="100%" style="stop-color:#1a5a96"/>
    </linearGradient>
    <filter id="shadow" x="-5%" y="-5%" width="110%" height="110%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
    </filter>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
    </marker>
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1100" height="900" fill="#f8fafc"/>

  <!-- Header -->
  <rect x="0" y="0" width="1100" height="60" fill="url(#headerGrad)"/>
  <text x="550" y="38" font-family="Segoe UI, Arial" font-size="22" font-weight="bold" fill="white" text-anchor="middle">How Chisel Tunnel Works with Azure App Service</text>
  <text x="550" y="55" font-family="Segoe UI, Arial" font-size="12" fill="#e2e8f0" text-anchor="middle">HTTPS Tunnel from Laptop to Private Endpoints</text>

  <!-- Left Side: Your Laptop -->
  <rect x="30" y="90" width="320" height="720" rx="12" fill="white" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <rect x="30" y="90" width="320" height="40" rx="12" fill="#f59e0b"/>
  <text x="190" y="118" font-family="Segoe UI, Arial" font-size="16" font-weight="bold" fill="white" text-anchor="middle">Your Laptop (Developer)</text>

  <!-- Docker Container -->
  <rect x="50" y="155" width="280" height="100" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
  <text x="190" y="178" font-family="Segoe UI, Arial" font-size="12" font-weight="bold" fill="#92400e" text-anchor="middle">Docker Container</text>
  <text x="190" y="195" font-family="Segoe UI, Arial" font-size="10" fill="#b45309" text-anchor="middle">jpillora/chisel:latest</text>
  <text x="190" y="210" font-family="Courier New" font-size="9" fill="#78350f" text-anchor="middle">Chisel Client Mode</text>

  <!-- Container Details -->
  <rect x="60" y="225" width="260" height="60" rx="6" fill="white" stroke="#f59e0b"/>
  <text x="190" y="245" font-family="Segoe UI, Arial" font-size="10" font-weight="bold" fill="#92400e" text-anchor="middle">Client Configuration</text>
  <text x="70" y="263" font-family="Courier New" font-size="9" fill="#78350f">--auth "tunnel:XXXXXXXX"</text>
  <text x="70" y="278" font-family="Courier New" font-size="9" fill="#78350f">client https://app.azurewebsites.net</text>

  <!-- Local Ports -->
  <rect x="50" y="300" width="280" height="120" rx="8" fill="#fffbeb" stroke="#fbbf24"/>
  <text x="190" y="323" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#92400e" text-anchor="middle">Local Port Forwards</text>

  <rect x="70" y="335" width="100" height="30" rx="4" fill="white" stroke="#fbbf24"/>
  <text x="120" y="355" font-family="Courier New" font-size="10" fill="#78350f" text-anchor="middle">5432 â†’ PostgreSQL</text>

  <rect x="180" y="335" width="100" height="30" rx="4" fill="white" stroke="#fbbf24"/>
  <text x="230" y="355" font-family="Courier New" font-size="10" fill="#78350f" text-anchor="middle">8080 â†’ CosmosDB</text>

  <rect x="70" y="375" width="100" height="30" rx="4" fill="white" stroke="#fbbf24"/>
  <text x="120" y="395" font-family="Courier New" font-size="10" fill="#78350f" text-anchor="middle">443 â†’ Key Vault</text>

  <rect x="180" y="375" width="100" height="30" rx="4" fill="white" stroke="#fbbf24"/>
  <text x="230" y="395" font-family="Courier New" font-size="10" fill="#78350f" text-anchor="middle">9000 â†’ Storage</text>

  <!-- Arrow to internet -->
  <path d="M 190 450 L 190 480" stroke="#f59e0b" stroke-width="3" marker-end="url(#arrowRed)"/>
  <text x="210" y="450" font-family="Segoe UI, Arial" font-size="10" fill="#78350f">HTTPS (TLS 1.3)</text>

  <!-- Internet Cloud -->
  <ellipse cx="190" cy="530" rx="140" ry="60" fill="#f1f5f9" stroke="#94a3b8" stroke-width="2"/>
  <text x="190" y="525" font-family="Segoe UI, Arial" font-size="14" font-weight="bold" fill="#475569" text-anchor="middle">INTERNET</text>
  <text x="190" y="542" font-family="Segoe UI, Arial" font-size="10" fill="#64748b" text-anchor="middle">Public DNS Resolution</text>

  <!-- Center: Azure App Service -->
  <rect x="380" y="90" width="340" height="720" rx="12" fill="white" stroke="#0ea5e9" stroke-width="2" filter="url(#shadow)"/>
  <rect x="380" y="90" width="340" height="40" rx="12" fill="#0ea5e9"/>
  <text x="550" y="118" font-family="Segoe UI, Arial" font-size="16" font-weight="bold" fill="white" text-anchor="middle">Azure App Service (Linux)</text>

  <!-- App Service Plan -->
  <rect x="400" y="150" width="300" height="80" rx="8" fill="#e0f2fe" stroke="#0284c7"/>
  <text x="550" y="173" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#0c4a6e" text-anchor="middle">App Service Plan</text>
  <text x="550" y="190" font-family="Segoe UI, Arial" font-size="9" fill="#075985" text-anchor="middle">SKU: B1 (Basic $15/month)</text>
  <text x="550" y="205" font-family="Segoe UI, Arial" font-size="9" fill="#075985" text-anchor="middle">Region: Canada Central</text>
  <text x="550" y="220" font-family="Segoe UI, Arial" font-size="9" fill="#075985" text-anchor="middle">OS: Linux</text>

  <!-- Web App -->
  <rect x="400" y="245" width="300" height="120" rx="8" fill="#cffafe" stroke="#06b6d4" stroke-width="2"/>
  <text x="550" y="268" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#0e7490" text-anchor="middle">Web App - Chisel Server</text>
  <text x="550" y="285" font-family="Segoe UI, Arial" font-size="10" fill="#155e75" text-anchor="middle">Container: azure-proxy/chisel:latest</text>
  <text x="550" y="300" font-family="Segoe UI, Arial" font-size="10" fill="#155e75" text-anchor="middle">Port: 80 (internal httpd)</text>
  <text x="550" y="315" font-family="Segoe UI, Arial" font-size="10" fill="#155e75" text-anchor="middle">TLS: HTTPS only, min 1.3</text>
  <text x="550" y="330" font-family="Segoe UI, Arial" font-size="10" fill="#155e75" text-anchor="middle">Auth: Username/Password required</text>
  <text x="550" y="345" font-family="Segoe UI, Arial" font-size="10" fill="#155e75" text-anchor="middle">Health: /healthz endpoint</text>

  <!-- VNet Integration -->
  <rect x="400" y="380" width="300" height="100" rx="8" fill="#dcfce7" stroke="#22c55e"/>
  <text x="550" y="403" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#166534" text-anchor="middle">VNet Integration</text>
  <text x="550" y="420" font-family="Segoe UI, Arial" font-size="10" fill="#15803d" text-anchor="middle">Subnet: app-service-subnet</text>
  <text x="550" y="435" font-family="Segoe UI, Arial" font-size="10" fill="#15803d" text-anchor="middle">Delegation: Microsoft.Web/serverFarms</text>
  <text x="550" y="450" font-family="Segoe UI, Arial" font-size="10" fill="#15803d" text-anchor="middle">Route: All outbound to VNet</text>
  <text x="550" y="465" font-family="Segoe UI, Arial" font-size="10" fill="#15803d" text-anchor="middle">NSG: Allow HTTP/HTTPS from internet</text>

  <!-- Chisel Server Process -->
  <rect x="400" y="495" width="300" height="80" rx="8" fill="#fef3c7" stroke="#f59e0b"/>
  <text x="550" y="518" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#92400e" text-anchor="middle">Chisel Server Process</text>
  <text x="550" y="535" font-family="Courier New" font-size="9" fill="#b45309" text-anchor="middle">chisel server --auth tunnel:XXXXXXXX</text>
  <text x="550" y="550" font-family="Segoe UI, Arial" font-size="9" fill="#b45309" text-anchor="middle">Port 8080 (internal)</text>
  <text x="550" y="565" font-family="Segoe UI, Arial" font-size="9" fill="#b45309" text-anchor="middle">Forwards to *.postgres.database.azure.com:5432</text>

  <!-- App Settings -->
  <rect x="400" y="590" width="300" height="80" rx="8" fill="#f3e8ff" stroke="#a855f7"/>
  <text x="550" y="613" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#6b21a8" text-anchor="middle">Application Settings</text>
  <text x="410" y="630" font-family="Courier New" font-size="9" fill="#7e22ce">WEBSITE_DYNAMIC_CACHE = 0</text>
  <text x="410" y="643" font-family="Courier New" font-size="9" fill="#7e22ce">WEBSITE_VNET_ROUTE_ALL = 1</text>
  <text x="410" y="656" font-family="Courier New" font-size="9" fill="#7e22ce">CHISEL_AUTH = tunnel:XXXXXXXX</text>
  <text x="410" y="669" font-family="Segoe UI, Arial" font-size="9" fill="#7e22ce">(Randomly generated by Terraform)</text>

  <!-- Application Insights -->
  <rect x="400" y="685" width="300" height="50" rx="8" fill="#fee2e2" stroke="#dc2626"/>
  <text x="550" y="708" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#991b1b" text-anchor="middle">Monitoring: Application Insights</text>
  <text x="550" y="723" font-family="Segoe UI, Arial" font-size="9" fill="#b91c1c" text-anchor="middle">All connections logged, health monitored</text>

  <!-- Arrow to VNet -->
  <path d="M 700 450 L 750 450" stroke="#22c55e" stroke-width="3" marker-end="url(#arrowGreen)"/>
  <text x="685" y="425" font-family="Segoe UI, Arial" font-size="10" fill="#15803d">VNet traffic</text>

  <!-- Right Side: VNet -->
  <rect x="750" y="90" width="320" height="720" rx="12" fill="white" stroke="#22c55e" stroke-width="2" filter="url(#shadow)"/>
  <rect x="750" y="90" width="320" height="40" rx="12" fill="#22c55e"/>
  <text x="910" y="118" font-family="Segoe UI, Arial" font-size="16" font-weight="bold" fill="white" text-anchor="middle">Virtual Network (VNet)</text>

  <!-- Private Endpoints Subnet -->
  <rect x="770" y="150" width="280" height="120" rx="8" fill="#fef3c7" stroke="#f59e0b"/>
  <text x="910" y="173" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#92400e" text-anchor="middle">privateendpoints-subnet (/28)</text>

  <rect x="790" y="190" width="240" height="35" rx="4" fill="white" stroke="#f59e0b"/>
  <text x="910" y="213" font-family="Segoe UI, Arial" font-size="10" fill="#92400e" text-anchor="middle">Key Vault Private Endpoint</text>

  <rect x="790" y="235" width="240" height="35" rx="4" fill="white" stroke="#f59e0b"/>
  <text x="910" y="258" font-family="Segoe UI, Arial" font-size="10" fill="#92400e" text-anchor="middle">Storage Account Private Endpoint</text>

  <!-- Other Private Services -->
  <rect x="770" y="285" width="280" height="120" rx="8" fill="#fffbeb" stroke="#fbbf24"/>
  <text x="910" y="308" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#92400e" text-anchor="middle">Other Private Endpoints</text>

  <rect x="790" y="325" width="240" height="30" rx="4" fill="white" stroke="#fbbf24"/>
  <text x="910" y="345" font-family="Segoe UI, Arial" font-size="10" fill="#b45309" text-anchor="middle">PostgreSQL Flexible Server</text>

  <rect x="790" y="365" width="240" height="30" rx="4" fill="white" stroke="#fbbf24"/>
  <text x="910" y="385" font-family="Segoe UI, Arial" font-size="10" fill="#b45309" text-anchor="middle">Cosmos DB (Mongo API)</text>

  <!-- Flow arrows from App Service to Private Endpoints -->
  <path d="M 730 345 L 770 210" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <path d="M 730 365 L 770 255" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <path d="M 730 385 L 770 340" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>

  <!-- Data Flow Examples -->
  <rect x="770" y="420" width="280" height="160" rx="8" fill="#dcfce7" stroke="#22c55e"/>
  <text x="910" y="443" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#166534" text-anchor="middle">Example: PostgreSQL Access</text>

  <text x="790" y="465" font-family="Segoe UI, Arial" font-size="9" fill="#15803d">1. Client: psql -h localhost -p 5432</text>
  <text x="790" y="480" font-family="Segoe UI, Arial" font-size="9" fill="#15803d">2. Chisel Client: Encrypts, sends via HTTPS</text>
  <text x="790" y="495" font-family="Segoe UI, Arial" font-size="9" fill="#15803d">3. Chisel Server: Decrypts in VNet</text>
  <text x="790" y="510" font-family="Segoe UI, Arial" font-size="9" fill="#15803d">4. Private Endpoint: Forwards to PE</text>
  <text x="790" y="525" font-family="Segoe UI, Arial" font-size="9" fill="#15803d">5. PostgreSQL: Receives on VNet IP</text>
  <text x="790" y="540" font-family="Segoe UI, Arial" font-size="9" fill="#15803d">6. Return path: Same in reverse</text>
  <text x="790" y="565" font-family="Segoe UI, Arial" font-size="9" font-weight="bold" fill="#166534">Total: All traffic appears from VNet!</text>

  <!-- Security Notes -->
  <rect x="770" y="595" width="280" height="100" rx="8" fill="#fee2e2" stroke="#ef4444"/>
  <text x="910" y="618" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#991b1b" text-anchor="middle">Security Features</text>

  <text x="790" y="638" font-family="Segoe UI, Arial" font-size="9" fill="#b91c1c">âœ“ HTTPS TLS 1.3 encryption</text>
  <text x="790" y="652" font-family="Segoe UI, Arial" font-size="9" fill="#b91c1c">âœ“ Mandatory authentication</text>
  <text x="790" y="666" font-family="Segoe UI, Arial" font-size="9" fill="#b91c1c">âœ“ No public endpoints on services</text>
  <text x="790" y="680" font-family="Segoe UI, Arial" font-size="9" fill="#b91c1c">âœ“ All access from VNet only</text>

  <!-- Connection Flow -->
  <rect x="770" y="710" width="280" height="80" rx="8" fill="#e0f2fe" stroke="#0284c7"/>
  <text x="910" y="733" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#0c4a6e" text-anchor="middle">Setup Commands</text>
  <text x="780" y="752" font-family="Courier New" font-size="8" fill="#075985"># Get from Terraform output</text>
  <text x="780" y="765" font-family="Courier New" font-size="8" fill="#075985">terraform output azure_proxy_chisel_auth</text>
  <text x="780" y="778" font-family="Courier New" font-size="8" fill="#075985">terraform output azure_proxy_url</text>

  <!-- Footer -->
  <rect x="30" y="830" width="1040" height="50" rx="8" fill="#f0f9ff" stroke="#0ea5e9" stroke-width="1"/>
  <text x="550" y="853" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#0369a1" text-anchor="middle">ðŸ’¡ Key Insight: Chisel creates a secure, authenticated tunnel that makes private endpoints accessible from anywhere</text>
  <text x="550" y="868" font-family="Segoe UI, Arial" font-size="9" fill="#0284c7" text-anchor="middle">while maintaining full network isolation and zero-trust security</text>

</svg>
