<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1250" width="1200" height="1250">
  <defs>
    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#003366"/>
      <stop offset="100%" style="stop-color:#1a5a96"/>
    </linearGradient>
    <filter id="shadow" x="-5%" y="-5%" width="110%" height="110%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
    </filter>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1200" height="1250" fill="#f8fafc"/>

  <!-- Header -->
  <rect x="0" y="0" width="1200" height="65" fill="url(#headerGrad)"/>
  <text x="600" y="40" font-family="Segoe UI, Arial" font-size="22" font-weight="bold" fill="white" text-anchor="middle">When and Why Terraform Needs Key Vault Access</text>
  <text x="600" y="58" font-family="Segoe UI, Arial" font-size="12" fill="#e2e8f0" text-anchor="middle">Understanding Data Plane vs Control Plane Operations</text>

  <!-- Question Box -->
  <rect x="50" y="85" width="1100" height="85" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="600" y="112" font-family="Segoe UI, Arial" font-size="16" font-weight="bold" fill="#92400e" text-anchor="middle">Why do we need Key Vault? What operations require it?</text>
  <text x="600" y="135" font-family="Segoe UI, Arial" font-size="12" fill="#b45309" text-anchor="middle">Key Vault stores secrets. But when does Terraform actually need to READ or WRITE those secrets?</text>
  <text x="600" y="155" font-family="Segoe UI, Arial" font-size="11" fill="#78350f" text-anchor="middle">(Hint: NOT as often as you might think!)</text>

  <!-- Top: Control Plane Operations -->
  <rect x="50" y="190" width="520" height="370" rx="12" fill="white" stroke="#22c55e" stroke-width="3" filter="url(#shadow)"/>
  <rect x="50" y="190" width="520" height="60" rx="12" fill="#22c55e"/>
  <text x="310" y="221" font-family="Segoe UI, Arial" font-size="16" font-weight="bold" fill="white" text-anchor="middle">CONTROL PLANE (OIDC Works)</text>
  <text x="310" y="241" font-family="Segoe UI, Arial" font-size="12" fill="white" text-anchor="middle">No Key Vault Access Needed</text>

  <!-- Checkmark -->
  <circle cx="75" cy="222" r="14" fill="white"/>
  <text x="75" y="228" font-family="Segoe UI, Arial" font-size="16" fill="#22c55e" text-anchor="middle">âœ“</text>

  <text x="70" y="265" font-family="Segoe UI, Arial" font-size="12" font-weight="bold" fill="#166534">What you CAN do with OIDC alone:</text>

  <!-- Control Plane Operations List -->
  <rect x="70" y="280" width="480" height="265" rx="8" fill="#f0fdf4"/>
  <text x="90" y="308" font-family="Segoe UI, Arial" font-size="12" fill="#166534">1. CREATE Key Vault</text>
  <text x="110" y="330" font-family="Segoe UI, Arial" font-size="10" fill="#15803d">   â””â”€ azurerm_key_vault resource</text>
  <text x="110" y="345" font-family="Segoe UI, Arial" font-size="10" fill="#15803d">   â””â”€ This is a management API call</text>

  <text x="90" y="375" font-family="Segoe UI, Arial" font-size="12" fill="#166534">2. CONFIGURE Key Vault</text>
  <text x="110" y="397" font-family="Segoe UI, Arial" font-size="10" fill="#15803d">   â””â”€ Enable RBAC, set policies</text>
  <text x="110" y="412" font-family="Segoe UI, Arial" font-size="10" fill="#15803d">   â””â”€ Add network rules, private endpoints</text>

  <text x="90" y="442" font-family="Segoe UI, Arial" font-size="12" fill="#166534">3. ASSIGN RBAC Roles</text>
  <text x="110" y="464" font-family="Segoe UI, Arial" font-size="10" fill="#15803d">   â””â”€ Give users/identities access</text>
  <text x="110" y="479" font-family="Segoe UI, Arial" font-size="10" fill="#15803d">   â””â”€ Reader, Secrets Officer, etc.</text>

  <text x="90" y="509" font-family="Segoe UI, Arial" font-size="12" fill="#166534">4. DEPLOY Private Endpoint</text>
  <text x="110" y="531" font-family="Segoe UI, Arial" font-size="10" fill="#15803d">   â””â”€ azurerm_private_endpoint resource</text>
  <text x="110" y="546" font-family="Segoe UI, Arial" font-size="10" fill="#15803d">   â””â”€ Creates network path to vault</text>

  <!-- Terraform Examples -->
  <rect x="70" y="560" width="480" height="120" rx="8" fill="white" stroke="#22c55e"/>
  <text x="90" y="587" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#166534">Terraform Example:</text>
  <text x="90" y="607" font-family="Courier New" font-size="9" fill="#15803d"># Create the vault</text>
  <text x="90" y="622" font-family="Courier New" font-size="9" fill="#15803d">resource "azurerm_key_vault" "main" {</text>
  <text x="110" y="637" font-family="Courier New" font-size="9" fill="#15803d">name = "my-vault"</text>
  <text x="110" y="652" font-family="Courier New" font-size="9" fill="#15803d">public_network_access_enabled = false</text>

  <!-- Bottom: Data Plane Operations -->
  <rect x="630" y="190" width="520" height="370" rx="12" fill="white" stroke="#ef4444" stroke-width="3" filter="url(#shadow)"/>
  <rect x="630" y="190" width="520" height="60" rx="12" fill="#ef4444"/>
  <text x="890" y="221" font-family="Segoe UI, Arial" font-size="16" font-weight="bold" fill="white" text-anchor="middle">DATA PLANE (OIDC BLOCKED)</text>
  <text x="890" y="241" font-family="Segoe UI, Arial" font-size="12" fill="white" text-anchor="middle">Needs VNet Access to Key Vault</text>

  <!-- X mark -->
  <circle cx="655" cy="222" r="14" fill="white"/>
  <text x="655" y="228" font-family="Segoe UI, Arial" font-size="18" fill="#ef4444" text-anchor="middle">âœ—</text>

  <text x="640" y="265" font-family="Segoe UI, Arial" font-size="12" font-weight="bold" fill="#991b1b">What requires DATA PLANE access:</text>

  <!-- Data Plane Operations List -->
  <rect x="650" y="280" width="480" height="265" rx="8" fill="#fef2f2"/>
  <text x="670" y="308" font-family="Segoe UI, Arial" font-size="12" fill="#991b1b">1. READ Key Vault Secrets</text>
  <text x="690" y="330" font-family="Segoe UI, Arial" font-size="10" fill="#b91c1c">   â””â”€ terraform_data, external, http data sources</text>
  <text x="690" y="345" font-family="Segoe UI, Arial" font-size="10" fill="#b91c1c">   â””â”€ azurerm_key_vault_secret data source</text>

  <text x="670" y="375" font-family="Segoe UI, Arial" font-size="12" fill="#991b1b">2. WRITE Key Vault Secrets</text>
  <text x="690" y="397" font-family="Segoe UI, Arial" font-size="10" fill="#b91c1c">   â””â”€ azurerm_key_vault_secret resource</text>
  <text x="690" y="412" font-family="Segoe UI, Arial" font-size="10" fill="#b91c1c">   â””â”€ Creates new secrets in vault</text>

  <text x="670" y="442" font-family="Segoe UI, Arial" font-size="12" fill="#991b1b">3. Terraform Backend (Private State)</text>
  <text x="690" y="464" font-family="Segoe UI, Arial" font-size="10" fill="#b91c1c">   â””â”€ azurerm backend with private storage</text>
  <text x="690" y="479" font-family="Segoe UI, Arial" font-size="10" fill="#b91c1c">   â””â”€ State file stored in private blob</text>

  <text x="670" y="509" font-family="Segoe UI, Arial" font-size="12" fill="#991b1b">4. Read Secrets at Plan Time</text>
  <text x="690" y="531" font-family="Segoe UI, Arial" font-size="10" fill="#b91c1c">   â””â”€ Variable defaults from Key Vault</text>
  <text x="690" y="546" font-family="Segoe UI, Arial" font-size="10" fill="#b91c1c">   â””â”€ Configuration values from secrets</text>

  <!-- Terraform Examples -->
  <rect x="650" y="560" width="480" height="120" rx="8" fill="white" stroke="#ef4444"/>
  <text x="670" y="587" font-family="Segoe UI, Arial" font-size="11" font-weight="bold" fill="#991b1b">Terraform Example:</text>
  <text x="670" y="607" font-family="Courier New" font-size="9" fill="#b91c1c"># Read a secret (data plane)</text>
  <text x="670" y="622" font-family="Courier New" font-size="9" fill="#b91c1c">data "azurerm_key_vault_secret" "db_password" {</text>
  <text x="690" y="637" font-family="Courier New" font-size="9" fill="#b91c1c">name = "db-password"</text>
  <text x="690" y="652" font-family="Courier New" font-size="9" fill="#b91c1c">vault_uri = azurerm_key_vault.main.vault_uri</text>

  <!-- Middle: Why Do We Need Key Vault? -->
  <rect x="50" y="720" width="1100" height="140" rx="12" fill="white" stroke="#6366f1" stroke-width="2" filter="url(#shadow)"/>
  <text x="600" y="752" font-family="Segoe UI, Arial" font-size="16" font-weight="bold" fill="#4338ca" text-anchor="middle">But WHY do we need Key Vault at all?</text>

  <text x="120" y="782" font-family="Segoe UI, Arial" font-size="12" fill="#5b21b6">Secret Storage</text>
  <text x="120" y="800" font-family="Segoe UI, Arial" font-size="10" fill="#64748b">Store API keys, passwords,</text>
  <text x="120" y="815" font-family="Segoe UI, Arial" font-size="10" fill="#64748b">connection strings securely</text>

  <text x="320" y="782" font-family="Segoe UI, Arial" font-size="12" fill="#5b21b6">Secret Rotation</text>
  <text x="320" y="800" font-family="Segoe UI, Arial" font-size="10" fill="#64748b">Centralized rotation,</text>
  <text x="320" y="815" font-family="Segoe UI, Arial" font-size="10" fill="#64748b">audit access</text>

  <text x="520" y="782" font-family="Segoe UI, Arial" font-size="12" fill="#5b21b6">Access Control</text>
  <text x="520" y="800" font-family="Segoe UI, Arial" font-size="10" fill="#64748b">RBAC-based permissions,</text>
  <text x="520" y="815" font-family="Segoe UI, Arial" font-size="10" fill="#64748b">least privilege</text>

  <text x="720" y="782" font-family="Segoe UI, Arial" font-size="12" fill="#5b21b6">Encryption at Rest</text>
  <text x="720" y="800" font-family="Segoe UI, Arial" font-size="10" fill="#64748b">FIPS 140-2 validated HSMs,</text>
  <text x="720" y="815" font-family="Segoe UI, Arial" font-size="10" fill="#64748b">azure-managed keys</text>

  <text x="920" y="782" font-family="Segoe UI, Arial" font-size="12" fill="#5b21b6">Compliance</text>
  <text x="920" y="800" font-family="Segoe UI, Arial" font-size="10" fill="#64748b">BC Gov security policies</text>
  <text x="920" y="815" font-family="Segoe UI, Arial" font-size="10" fill="#64748b">and audit requirements</text>

  <!-- Bottom: When Do You Actually Need Key Vault Access? -->
  <rect x="50" y="880" width="1100" height="300" rx="12" fill="white" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="600" y="912" font-family="Segoe UI, Arial" font-size="16" font-weight="bold" fill="#92400e" text-anchor="middle">When Do You ACTUALLY Need Key Vault Access During Terraform?</text>

  <!-- Scenario 1: Yes -->
  <rect x="70" y="935" width="330" height="115" rx="8" fill="#fef3c7" stroke="#f59e0b"/>
  <text x="235" y="960" font-family="Segoe UI, Arial" font-size="13" font-weight="bold" fill="#92400e" text-anchor="middle">YES - Need Data Plane</text>

  <text x="90" y="985" font-family="Segoe UI, Arial" font-size="11" fill="#b45309">â€¢ Deploying database that needs</text>
  <text x="110" y="1000" font-family="Segoe UI, Arial" font-size="11" fill="#b45309">  connection string as secret</text>

  <text x="90" y="1020" font-family="Segoe UI, Arial" font-size="11" fill="#b45309">â€¢ Storing service principal</text>
  <text x="110" y="1035" font-family="Segoe UI, Arial" font-size="11" fill="#b45309">  credentials for app config</text>

  <!-- Scenario 2: No -->
  <rect x="435" y="935" width="330" height="115" rx="8" fill="#dcfce7" stroke="#22c55e"/>
  <text x="600" y="960" font-family="Segoe UI, Arial" font-size="13" font-weight="bold" fill="#166534" text-anchor="middle">NO - Control Plane Only</text>

  <text x="455" y="985" font-family="Segoe UI, Arial" font-size="11" fill="#15803d">â€¢ Creating Key Vault resource</text>
  <text x="475" y="1000" font-family="Segoe UI, Arial" font-size="11" fill="#15803d">  itself (management API)</text>

  <text x="455" y="1020" font-family="Segoe UI, Arial" font-size="11" fill="#15803d">â€¢ Deploying infrastructure</text>
  <text x="475" y="1035" font-family="Segoe UI, Arial" font-size="11" fill="#15803d">  (VMs, networks, storage)</text>

  <!-- Scenario 3: Alternative -->
  <rect x="800" y="935" width="330" height="115" rx="8" fill="#e0f2fe" stroke="#0284c7"/>
  <text x="965" y="960" font-family="Segoe UI, Arial" font-size="13" font-weight="bold" fill="#0c4a6e" text-anchor="middle">ALTERNATIVE APPROACH</text>

  <text x="820" y="985" font-family="Segoe UI, Arial" font-size="11" fill="#075985">â€¢ Store config in code</text>
  <text x="840" y="1000" font-family="Segoe UI, Arial" font-size="11" fill="#075985">  (not recommended for prod)</text>

  <text x="820" y="1020" font-family="Segoe UI, Arial" font-size="11" fill="#075985">â€¢ Use Azure DevOps</text>
  <text x="840" y="1035" font-family="Segoe UI, Arial" font-size="11" fill="#075985">  Variable Groups instead</text>

  <!-- Real World Examples -->
  <rect x="70" y="1065" width="1060" height="100" rx="8" fill="#f3f4f6" stroke="#94a3b8"/>
  <text x="600" y="1090" font-family="Segoe UI, Arial" font-size="12" font-weight="bold" fill="#374151" text-anchor="middle">Real-World Terraform Code Examples</text>

  <text x="90" y="1115" font-family="Courier New" font-size="9" fill="#6b7280"># Example 1: NEEDS Key Vault (data plane) - Writing a secret</text>
  <text x="90" y="1130" font-family="Courier New" font-size="9" fill="#ef4444">resource "azurerm_key_vault_secret" "db_password" {</text>
  <text x="110" y="1145" font-family="Courier New" font-size="9" fill="#ef4444">name  = "db-password"</text>
  <text x="110" y="1160" font-family="Courier New" font-size="9" fill="#ef4444">value = random_password.db_password.result</text>

  <text x="560" y="1115" font-family="Courier New" font-size="9" fill="#6b7280"># Example 2: NO Key Vault needed (control plane) - Creating vault</text>
  <text x="560" y="1130" font-family="Courier New" font-size="9" fill="#22c55e">resource "azurerm_key_vault" "main" {</text>
  <text x="580" y="1145" font-family="Courier New" font-size="9" fill="#22c55e">name = "my-vault"</text>
  <text x="580" y="1160" font-family="Courier New" font-size="9" fill="#22c55e">location = "canadacentral"</text>

  <!-- Footer -->
  <rect x="50" y="1195" width="1100" height="40" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
  <text x="600" y="1217" font-family="Segoe UI, Arial" font-size="12" font-weight="bold" fill="#92400e" text-anchor="middle">ðŸ’¡ Key Takeaway: Most Terraform operations only need control plane access (OIDC works)</text>
  <text x="600" y="1233" font-family="Segoe UI, Arial" font-size="11" fill="#b45309" text-anchor="middle">Only deploy resources that manage secrets if you have data plane access via VNet (self-hosted runners, Chisel, or Bastion)</text>

</svg>
