<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 680">
  <defs>
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#0f172a"/>
      <stop offset="100%" style="stop-color:#1e293b"/>
    </linearGradient>
    <filter id="shadow">
      <feDropShadow dx="0" dy="3" stdDeviation="4" flood-opacity="0.3"/>
    </filter>
    <marker id="arrowGold" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto">
      <path d="M0,2 L0,10 L10,6 z" fill="#fcba19"/>
    </marker>
    <marker id="arrowBlue" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto">
      <path d="M0,2 L0,10 L10,6 z" fill="#0ea5e9"/>
    </marker>
    <marker id="arrowGreen" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto">
      <path d="M0,2 L0,10 L10,6 z" fill="#22c55e"/>
    </marker>
    <marker id="arrowPurple" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto">
      <path d="M0,2 L0,10 L10,6 z" fill="#a855f7"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1400" height="680" fill="url(#bgGrad)"/>
  <pattern id="grid" width="25" height="25" patternUnits="userSpaceOnUse">
    <path d="M 25 0 L 0 0 0 25" fill="none" stroke="#334155" stroke-width="0.5" opacity="0.2"/>
  </pattern>
  <rect width="1400" height="680" fill="url(#grid)"/>

  <!-- Title -->
  <text x="700" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="white">AI Request Data Flow</text>
  <text x="700" y="60" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">From BC Gov Client Application to AI Response - Complete Request Path</text>

  <!-- Step Labels -->
  <g font-family="Arial, sans-serif" font-size="11" fill="#fcba19" font-weight="bold">
    <text x="120" y="96">1. Client App</text>
    <text x="325" y="96">2. App Gateway</text>
    <text x="560" y="96">3. APIM</text>
    <text x="780" y="96">4. AI Foundry</text>
    <text x="1080" y="96">5. Response</text>
  </g>

  <!-- Step 1: Client App -->
  <g filter="url(#shadow)" transform="translate(55, 110)">
    <rect x="0" y="0" width="180" height="110" rx="10" fill="#374151" stroke="#6b7280" stroke-width="2"/>
    <circle cx="90" cy="32" r="18" fill="#4b5563"/>
    <circle cx="90" cy="25" r="8" fill="#9ca3af"/>
    <path d="M70,45 Q90,60 110,45" fill="none" stroke="#9ca3af" stroke-width="2"/>
    <text x="90" y="78" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">Client Application</text>
    <text x="90" y="95" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#9ca3af">BC Gov Ministry App</text>
    <text x="90" y="108" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#9ca3af">APIM subscription key</text>
  </g>

  <!-- Arrow 1 to 2 -->
  <path d="M 240 165 L 295 165" stroke="#fcba19" stroke-width="3" marker-end="url(#arrowGold)"/>
  <text x="268" y="155" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#fef08a">HTTPS</text>

  <!-- Step 2: App Gateway -->
  <g filter="url(#shadow)" transform="translate(300, 110)">
    <rect x="0" y="0" width="195" height="110" rx="10" fill="#7c2d12" stroke="#f97316" stroke-width="2"/>
    <text x="97" y="28" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">App Gateway (WAF)</text>
    <text x="97" y="50" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#fed7aa">WAF Policy Enforcement</text>
    <text x="97" y="66" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#fed7aa">SSL/TLS Termination</text>
    <text x="97" y="82" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#fed7aa">Load Balancing</text>
    <text x="97" y="98" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#fed7aa">Public Entry Point</text>
  </g>

  <!-- Arrow 2 to 3 -->
  <path d="M 498 165 L 553 165" stroke="#0ea5e9" stroke-width="3" marker-end="url(#arrowBlue)"/>
  <text x="526" y="155" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#7dd3fc">Internal</text>

  <!-- Step 3: APIM -->
  <g filter="url(#shadow)" transform="translate(558, 110)">
    <rect x="0" y="0" width="195" height="110" rx="10" fill="#0c4a6e" stroke="#0ea5e9" stroke-width="2"/>
    <text x="97" y="28" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">APIM</text>
    <text x="97" y="50" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#bae6fd">API Key Authentication</text>
    <text x="97" y="66" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#bae6fd">Per-Tenant Rate Limiting</text>
    <text x="97" y="82" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#bae6fd">Request Logging</text>
    <text x="97" y="98" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#38bdf8">Routes to AI Foundry</text>
  </g>

  <!-- Arrow 3 to 4 -->
  <path d="M 756 165 L 808 165" stroke="#a855f7" stroke-width="3" marker-end="url(#arrowPurple)"/>
  <text x="782" y="155" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#c084fc">Private</text>

  <!-- Step 4: AI Foundry -->
  <g filter="url(#shadow)" transform="translate(813, 110)">
    <rect x="0" y="0" width="215" height="110" rx="10" fill="#581c87" stroke="#a855f7" stroke-width="2"/>
    <text x="107" y="28" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">AI Foundry</text>
    <text x="107" y="50" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#e9d5ff">Azure OpenAI Models</text>
    <text x="107" y="66" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#e9d5ff">Process Prompt</text>
    <text x="107" y="82" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#e9d5ff">Generate Completion</text>
    <text x="107" y="98" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#c084fc">Private Endpoint Only</text>
  </g>

  <!-- Arrow 4 to 5 -->
  <path d="M 1031 165 L 1083 165" stroke="#22c55e" stroke-width="3" marker-end="url(#arrowGreen)"/>
  <text x="1057" y="155" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#86efac">Response</text>

  <!-- Step 5: Response -->
  <g filter="url(#shadow)" transform="translate(1088, 110)">
    <rect x="0" y="0" width="190" height="110" rx="10" fill="#064e3b" stroke="#10b981" stroke-width="2"/>
    <text x="95" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="28" fill="#34d399">&#10003;</text>
    <text x="95" y="72" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">AI Response</text>
    <text x="95" y="90" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#6ee7b7">AI-generated answer</text>
    <text x="95" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#6ee7b7">returned via same path</text>
  </g>

  <!-- Return path -->
  <path d="M 1088 248 L 165 248 L 165 225" stroke="#6b7280" stroke-width="2" stroke-dasharray="8,4" marker-end="url(#arrowGold)"/>
  <text x="700" y="268" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#9ca3af">Response returns through APIM and App Gateway back to the client</text>

  <!-- Detail Left: APIM Backend Config -->
  <rect x="40" y="290" width="620" height="305" rx="10" fill="#1f2937" stroke="#475569" stroke-width="1"/>
  <text x="350" y="318" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="white">APIM Backend Configuration</text>

  <g transform="translate(60, 330)">
    <rect x="0" y="0" width="580" height="60" rx="6" fill="#0c4a6e" stroke="#0ea5e9" stroke-width="2"/>
    <text x="290" y="24" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#38bdf8">Single Backend: AI Foundry</text>
    <text x="290" y="44" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#bae6fd">All tenant API calls route to the shared AI Foundry hub via private endpoint</text>
  </g>

  <g transform="translate(60, 405)">
    <rect x="0" y="0" width="130" height="55" rx="5" fill="#0369a1" stroke="#0ea5e9"/>
    <text x="65" y="22" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="white">Tenant API Key</text>
    <text x="65" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#bae6fd">Identifies ministry</text>
    <text x="65" y="52" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#bae6fd">auth + rate limits</text>
  </g>

  <path d="M 195 432 L 225 432" stroke="#fcba19" stroke-width="2" marker-end="url(#arrowGold)"/>

  <g transform="translate(230, 405)">
    <rect x="0" y="0" width="130" height="55" rx="5" fill="#5b21b6" stroke="#8b5cf6"/>
    <text x="65" y="22" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="white">Policy Execution</text>
    <text x="65" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#ddd6fe">Validate, transform</text>
    <text x="65" y="52" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#ddd6fe">strip sensitive headers</text>
  </g>

  <path d="M 365 432 L 395 432" stroke="#fcba19" stroke-width="2" marker-end="url(#arrowGold)"/>

  <g transform="translate(400, 405)">
    <rect x="0" y="0" width="130" height="55" rx="5" fill="#581c87" stroke="#a855f7"/>
    <text x="65" y="22" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="white">Route to Foundry</text>
    <text x="65" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#e9d5ff">Private endpoint</text>
    <text x="65" y="52" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#e9d5ff">internal network only</text>
  </g>

  <g transform="translate(60, 475)">
    <rect x="0" y="0" width="580" height="100" rx="5" fill="#111827" stroke="#374151"/>
    <text x="20" y="22" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#fcba19">Key Points:</text>
    <text x="20" y="42" font-family="Arial, sans-serif" font-size="10" fill="#d1d5db">No ExpressRoute at this time - traffic enters via App Gateway over HTTPS</text>
    <text x="20" y="58" font-family="Arial, sans-serif" font-size="10" fill="#d1d5db">APIM has one backend: AI Foundry (no multi-backend routing)</text>
    <text x="20" y="74" font-family="Arial, sans-serif" font-size="10" fill="#d1d5db">RAG pipelines are a tenant responsibility, not managed by the hub</text>
    <text x="20" y="90" font-family="Arial, sans-serif" font-size="10" fill="#d1d5db">All internal hops are private (VNet-routed, no public endpoints inside)</text>
  </g>

  <!-- Detail Right: Security Checkpoints -->
  <rect x="680" y="290" width="680" height="305" rx="10" fill="#1f2937" stroke="#ef4444" stroke-width="1"/>
  <text x="1020" y="318" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#ef4444">Security Checkpoints Along the Path</text>

  <g transform="translate(700, 330)">
    <rect x="0" y="0" width="195" height="85" rx="5" fill="#292524" stroke="#f97316" stroke-width="1"/>
    <text x="97" y="20" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#f97316">App Gateway (WAF)</text>
    <text x="20" y="40" font-family="Arial, sans-serif" font-size="9" fill="#a8a29e">WAF rules (OWASP 3.2)</text>
    <text x="20" y="54" font-family="Arial, sans-serif" font-size="9" fill="#a8a29e">TLS 1.2+ enforced</text>
    <text x="20" y="68" font-family="Arial, sans-serif" font-size="9" fill="#a8a29e">DDoS protection</text>
  </g>

  <g transform="translate(915, 330)">
    <rect x="0" y="0" width="195" height="85" rx="5" fill="#1e1b4b" stroke="#6366f1" stroke-width="1"/>
    <text x="97" y="20" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#818cf8">APIM Gateway</text>
    <text x="20" y="40" font-family="Arial, sans-serif" font-size="9" fill="#a8a29e">API key validation</text>
    <text x="20" y="54" font-family="Arial, sans-serif" font-size="9" fill="#a8a29e">Rate limiting per tenant</text>
    <text x="20" y="68" font-family="Arial, sans-serif" font-size="9" fill="#a8a29e">Request/response logging</text>
  </g>

  <g transform="translate(1130, 330)">
    <rect x="0" y="0" width="195" height="85" rx="5" fill="#0f2418" stroke="#22c55e" stroke-width="1"/>
    <text x="97" y="20" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#22c55e">AI Foundry</text>
    <text x="20" y="40" font-family="Arial, sans-serif" font-size="9" fill="#a8a29e">Private endpoint access only</text>
    <text x="20" y="54" font-family="Arial, sans-serif" font-size="9" fill="#a8a29e">Managed Identity auth</text>
    <text x="20" y="68" font-family="Arial, sans-serif" font-size="9" fill="#a8a29e">Region: Canada Central</text>
  </g>

  <g transform="translate(700, 430)">
    <rect x="0" y="0" width="625" height="140" rx="5" fill="#111827" stroke="#374151"/>
    <text x="20" y="22" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#fcba19">Access Control Summary:</text>
    <text x="20" y="42" font-family="Arial, sans-serif" font-size="10" fill="#d1d5db">Public exposure: App Gateway only - all other components are internal VNet resources</text>
    <text x="20" y="58" font-family="Arial, sans-serif" font-size="10" fill="#d1d5db">APIM is deployed in internal mode - not directly reachable from the internet</text>
    <text x="20" y="74" font-family="Arial, sans-serif" font-size="10" fill="#d1d5db">AI Foundry has no public endpoint - reachable only via private endpoint in the VNet</text>
    <text x="20" y="90" font-family="Arial, sans-serif" font-size="10" fill="#d1d5db">Each tenant has a unique APIM subscription key with independent rate limits</text>
    <text x="20" y="106" font-family="Arial, sans-serif" font-size="10" fill="#d1d5db">Diagnostic logs flow to shared Log Analytics workspace (tenant-scoped queries)</text>
    <text x="20" y="122" font-family="Arial, sans-serif" font-size="10" fill="#d1d5db">No cross-tenant data access - APIM policies enforce tenant identity per request</text>
  </g>

  <!-- Footer -->
  <rect x="0" y="637" width="1400" height="43" fill="#fcba19"/>
  <text x="700" y="664" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#003366">BC Gov AI Hub - AI Request Data Flow</text>
</svg>
