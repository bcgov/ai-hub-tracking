<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 2400">
  <defs>
    <!-- Gradients -->
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#001a33"/>
      <stop offset="100%" style="stop-color:#003366"/>
    </linearGradient>

    <linearGradient id="azureGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#0078d4"/>
      <stop offset="100%" style="stop-color:#00a2ed"/>
    </linearGradient>

    <linearGradient id="githubGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#238636"/>
      <stop offset="100%" style="stop-color:#2ea043"/>
    </linearGradient>

    <linearGradient id="scriptGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#d4a012"/>
      <stop offset="100%" style="stop-color:#fcba19"/>
    </linearGradient>

    <linearGradient id="devGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#06b6d4"/>
      <stop offset="100%" style="stop-color:#22d3ee"/>
    </linearGradient>

    <linearGradient id="prodGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#dc2626"/>
      <stop offset="100%" style="stop-color:#ef4444"/>
    </linearGradient>

    <linearGradient id="terraformGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#7c3aed"/>
      <stop offset="100%" style="stop-color:#8b5cf6"/>
    </linearGradient>

    <!-- Filters -->
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="4" stdDeviation="8" flood-color="#000" flood-opacity="0.3"/>
    </filter>

    <!-- Grid pattern -->
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#1a4d80" stroke-width="0.5" opacity="0.3"/>
    </pattern>

    <!-- Markers -->
    <marker id="arrowGold" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#fcba19"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#34d399"/>
    </marker>
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#38bdf8"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1600" height="2400" fill="url(#bgGrad)"/>
  <rect width="1600" height="2400" fill="url(#grid)"/>

  <!-- ==================== TITLE ==================== -->
  <text x="800" y="50" text-anchor="middle" font-family="Arial, sans-serif" font-size="36" font-weight="700" fill="#f8fafc">
    Azure Landing Zone — GitHub Actions OIDC Complete Guide
  </text>
  <text x="800" y="85" text-anchor="middle" font-family="monospace" font-size="14" fill="#64748b">
    One-Time Setup → Token Lifecycle → Terraform Deployment
  </text>

  <!-- ==================== SECTION 1: ONE-TIME SETUP ==================== -->

  <rect x="40" y="110" width="1520" height="50" rx="8" fill="#002244" stroke="#fcba19" stroke-width="2"/>
  <text x="800" y="143" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="700" fill="#fcba19">
    SECTION 1: One-Time Setup (Run Once Per Environment)
  </text>

  <!-- When to Run Box -->
  <g filter="url(#shadow)">
    <rect x="60" y="180" width="350" height="140" rx="12" fill="#002244" stroke="#4a6d8c" stroke-width="1"/>
  </g>
  <text x="235" y="210" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#f8fafc">When To Run This Script</text>
  <text x="80" y="240" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">• Once when setting up a new project</text>
  <text x="80" y="262" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">• Once per environment (dev, test, prod)</text>
  <text x="80" y="284" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">• When adding a new repo to existing infra</text>
  <text x="80" y="306" font-family="Arial, sans-serif" font-size="12" fill="#fcba19">⚠️ NOT every deployment — just initial setup</text>

  <!-- Why It Works Box -->
  <g filter="url(#shadow)">
    <rect x="430" y="180" width="380" height="140" rx="12" fill="#002244" stroke="#4a6d8c" stroke-width="1"/>
  </g>
  <text x="620" y="210" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#f8fafc">Why It Works (Trust Chain)</text>
  <text x="450" y="240" font-family="monospace" font-size="11" fill="#94a3b8">GitHub signs tokens with private key</text>
  <text x="450" y="260" font-family="monospace" font-size="11" fill="#94a3b8">         ↓</text>
  <text x="450" y="280" font-family="monospace" font-size="11" fill="#94a3b8">Azure verifies with GitHub's public key</text>
  <text x="450" y="300" font-family="monospace" font-size="11" fill="#94a3b8">         ↓</text>
  <text x="450" y="320" font-family="monospace" font-size="11" fill="#10b981">Only matching repo+env gets access</text>

  <!-- What Gets Created Box -->
  <g filter="url(#shadow)">
    <rect x="830" y="180" width="350" height="140" rx="12" fill="#002244" stroke="#4a6d8c" stroke-width="1"/>
  </g>
  <text x="1005" y="210" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#f8fafc">What Gets Created</text>
  <text x="850" y="240" font-family="Arial, sans-serif" font-size="12" fill="#38bdf8">① Managed Identity</text>
  <text x="870" y="256" font-family="Arial, sans-serif" font-size="10" fill="#64748b">Azure service account for your pipeline</text>
  <text x="850" y="278" font-family="Arial, sans-serif" font-size="12" fill="#38bdf8">② Federated Credential</text>
  <text x="870" y="294" font-family="Arial, sans-serif" font-size="10" fill="#64748b">Trust link: "GitHub repo X → this identity"</text>
  <text x="850" y="316" font-family="Arial, sans-serif" font-size="12" fill="#38bdf8">③ Storage Account</text>
  <text x="870" y="332" font-family="Arial, sans-serif" font-size="10" fill="#64748b">For Terraform state files</text>

  <!-- Prerequisites Box -->
  <g filter="url(#shadow)">
    <rect x="1200" y="180" width="350" height="140" rx="12" fill="#002244" stroke="#4a6d8c" stroke-width="1"/>
  </g>
  <text x="1375" y="210" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#f8fafc">Prerequisites</text>
  <text x="1220" y="240" font-family="monospace" font-size="11" fill="#94a3b8">az login --use-device-code</text>
  <text x="1220" y="262" font-family="Arial, sans-serif" font-size="11" fill="#64748b">• Logged into correct subscription</text>
  <text x="1220" y="284" font-family="Arial, sans-serif" font-size="11" fill="#64748b">• Owner of security group</text>
  <text x="1220" y="306" font-family="Arial, sans-serif" font-size="11" fill="#64748b">• gh CLI installed (optional)</text>

  <!-- ==================== DEV vs PROD SETUP ==================== -->

  <!-- DEV Environment -->
  <g filter="url(#shadow)">
    <rect x="60" y="350" width="730" height="280" rx="16" fill="#0f172a" stroke="#06b6d4" stroke-width="2"/>
  </g>
  <rect x="60" y="350" width="730" height="45" rx="16" fill="url(#devGrad)"/>
  <rect x="60" y="383" width="730" height="12" fill="#0f172a"/>
  <text x="425" y="382" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="700" fill="#0f172a">
    DEV Environment Setup
  </text>

  <!-- Dev Subscription Info -->
  <text x="80" y="420" font-family="Arial, sans-serif" font-size="13" font-weight="600" fill="#22d3ee">Subscription: ABCD-Dev</text>
  <text x="80" y="440" font-family="monospace" font-size="11" fill="#64748b">ID: 12345678-aaaa-bbbb-cccc-111111111111</text>

  <!-- Dev Script Command -->
  <g filter="url(#shadow)">
    <rect x="80" y="460" width="690" height="150" rx="8" fill="#0d1f2d" stroke="#0e7490" stroke-width="1"/>
  </g>
  <text x="100" y="485" font-family="monospace" font-size="12" fill="#94a3b8">$ ./initial-azure-setup.sh \</text>
  <text x="100" y="505" font-family="monospace" font-size="12" fill="#22d3ee">    -g "ABCD-dev-networking" \</text>
  <text x="100" y="525" font-family="monospace" font-size="12" fill="#22d3ee">    -n "myapp-dev-identity" \</text>
  <text x="100" y="545" font-family="monospace" font-size="12" fill="#22d3ee">    -r "bcgov/myapp" \</text>
  <text x="100" y="565" font-family="monospace" font-size="12" fill="#22d3ee">    -e "dev" \</text>
  <text x="100" y="585" font-family="monospace" font-size="12" fill="#22d3ee">    -s "12345678-aaaa-bbbb-cccc-111111111111" \</text>
  <text x="100" y="605" font-family="monospace" font-size="12" fill="#fcba19">    --create-storage --create-github-secrets</text>

  <!-- Dev Creates -->
  <text x="520" y="420" font-family="Arial, sans-serif" font-size="12" fill="#64748b">Creates:</text>
  <text x="520" y="440" font-family="monospace" font-size="10" fill="#94a3b8">• Identity: myapp-dev-identity</text>
  <text x="520" y="456" font-family="monospace" font-size="10" fill="#94a3b8">• Storage: tfdevmyapp</text>
  <text x="520" y="472" font-family="monospace" font-size="10" fill="#10b981">• Subject: repo:bcgov/myapp:environment:dev</text>

  <!-- PROD Environment -->
  <g filter="url(#shadow)">
    <rect x="810" y="350" width="730" height="280" rx="16" fill="#0f172a" stroke="#dc2626" stroke-width="2"/>
  </g>
  <rect x="810" y="350" width="730" height="45" rx="16" fill="url(#prodGrad)"/>
  <rect x="810" y="383" width="730" height="12" fill="#0f172a"/>
  <text x="1175" y="382" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="700" fill="white">
    PROD Environment Setup
  </text>

  <!-- Prod Subscription Info -->
  <text x="830" y="420" font-family="Arial, sans-serif" font-size="13" font-weight="600" fill="#f87171">Subscription: ABCD-Prod</text>
  <text x="830" y="440" font-family="monospace" font-size="11" fill="#64748b">ID: 87654321-xxxx-yyyy-zzzz-999999999999</text>

  <!-- Prod Script Command -->
  <g filter="url(#shadow)">
    <rect x="830" y="460" width="690" height="150" rx="8" fill="#1f0d0d" stroke="#991b1b" stroke-width="1"/>
  </g>
  <text x="850" y="485" font-family="monospace" font-size="12" fill="#94a3b8">$ ./initial-azure-setup.sh \</text>
  <text x="850" y="505" font-family="monospace" font-size="12" fill="#f87171">    -g "ABCD-prod-networking" \</text>
  <text x="850" y="525" font-family="monospace" font-size="12" fill="#f87171">    -n "myapp-prod-identity" \</text>
  <text x="850" y="545" font-family="monospace" font-size="12" fill="#f87171">    -r "bcgov/myapp" \</text>
  <text x="850" y="565" font-family="monospace" font-size="12" fill="#f87171">    -e "prod" \</text>
  <text x="850" y="585" font-family="monospace" font-size="12" fill="#f87171">    -s "87654321-xxxx-yyyy-zzzz-999999999999" \</text>
  <text x="850" y="605" font-family="monospace" font-size="12" fill="#fcba19">    --create-storage --create-github-secrets</text>

  <!-- Prod Creates -->
  <text x="1270" y="420" font-family="Arial, sans-serif" font-size="12" fill="#64748b">Creates:</text>
  <text x="1270" y="440" font-family="monospace" font-size="10" fill="#94a3b8">• Identity: myapp-prod-identity</text>
  <text x="1270" y="456" font-family="monospace" font-size="10" fill="#94a3b8">• Storage: tfprodmyapp</text>
  <text x="1270" y="472" font-family="monospace" font-size="10" fill="#10b981">• Subject: repo:bcgov/myapp:environment:prod</text>

  <!-- Isolation Warning -->
  <g filter="url(#shadow)">
    <rect x="60" y="650" width="1480" height="50" rx="8" fill="#1a1a0a" stroke="#fcba19" stroke-width="2"/>
  </g>
  <text x="800" y="682" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="600" fill="#fcba19">
    ⚠️ IMPORTANT: Dev and Prod are completely isolated — different subscriptions, different identities, different permissions. Dev pipeline CANNOT access Prod.
  </text>

  <!-- ==================== SECTION 2: TOKEN LIFECYCLE ==================== -->

  <rect x="40" y="720" width="1520" height="50" rx="8" fill="#002244" stroke="#10b981" stroke-width="2"/>
  <text x="800" y="753" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="700" fill="#34d399">
    SECTION 2: Token Lifecycle (Happens Every Pipeline Run)
  </text>

  <!-- Token Timing Box -->
  <g filter="url(#shadow)">
    <rect x="60" y="790" width="400" height="200" rx="12" fill="#002244" stroke="#10b981" stroke-width="2"/>
  </g>
  <text x="260" y="825" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#34d399">Token Timing</text>

  <text x="80" y="860" font-family="Arial, sans-serif" font-size="13" fill="#f8fafc">GitHub OIDC Token:</text>
  <text x="100" y="882" font-family="monospace" font-size="12" fill="#94a3b8">• Generated fresh each workflow run</text>
  <text x="100" y="902" font-family="monospace" font-size="12" fill="#94a3b8">• Expires in ~5 minutes</text>
  <text x="100" y="922" font-family="monospace" font-size="12" fill="#94a3b8">• Only used to GET Azure token</text>

  <text x="80" y="952" font-family="Arial, sans-serif" font-size="13" fill="#f8fafc">Azure Bearer Token:</text>
  <text x="100" y="974" font-family="monospace" font-size="12" fill="#fcba19">• Expires in ~1 hour (3600 seconds)</text>
  <text x="100" y="994" font-family="monospace" font-size="12" fill="#94a3b8">• Auto-refreshed by azure/login action</text>

  <!-- Token Flow Diagram -->
  <g filter="url(#shadow)">
    <rect x="480" y="790" width="1060" height="200" rx="12" fill="#0f172a" stroke="#334155" stroke-width="1"/>
  </g>
  <text x="1010" y="820" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#f8fafc">Token Exchange Flow (Every Deployment)</text>

  <!-- Step boxes -->
  <g filter="url(#shadow)">
    <rect x="510" y="845" width="160" height="70" rx="8" fill="#0d2818" stroke="#4ade80" stroke-width="1"/>
  </g>
  <text x="590" y="870" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="600" fill="#4ade80">1. Workflow Starts</text>
  <text x="590" y="890" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">git push / PR merge</text>
  <text x="590" y="905" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">triggers deploy.yml</text>

  <path d="M 670 880 L 710 880" stroke="#4ade80" stroke-width="2" marker-end="url(#arrowGreen)" fill="none"/>

  <g filter="url(#shadow)">
    <rect x="720" y="845" width="160" height="70" rx="8" fill="#0d2818" stroke="#4ade80" stroke-width="1"/>
  </g>
  <text x="800" y="870" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="600" fill="#4ade80">2. GitHub Signs JWT</text>
  <text x="800" y="890" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">sub: repo:bcgov/myapp</text>
  <text x="800" y="905" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">    :environment:dev</text>

  <path d="M 880 880 L 920 880" stroke="#4ade80" stroke-width="2" marker-end="url(#arrowGreen)" fill="none"/>

  <g filter="url(#shadow)">
    <rect x="930" y="845" width="160" height="70" rx="8" fill="#1e3a5f" stroke="#38bdf8" stroke-width="1"/>
  </g>
  <text x="1010" y="870" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="600" fill="#38bdf8">3. Azure Validates</text>
  <text x="1010" y="890" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">✓ Signature valid</text>
  <text x="1010" y="905" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">✓ Subject matches</text>

  <path d="M 1090 880 L 1130 880" stroke="#38bdf8" stroke-width="2" marker-end="url(#arrowBlue)" fill="none"/>

  <g filter="url(#shadow)">
    <rect x="1140" y="845" width="160" height="70" rx="8" fill="#1e3a5f" stroke="#38bdf8" stroke-width="1"/>
  </g>
  <text x="1220" y="870" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="600" fill="#38bdf8">4. Bearer Token</text>
  <text x="1220" y="890" text-anchor="middle" font-family="monospace" font-size="9" fill="#fcba19">TTL: 3600 seconds</text>
  <text x="1220" y="905" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">Authorization: Bearer</text>

  <path d="M 1300 880 L 1340 880" stroke="#38bdf8" stroke-width="2" marker-end="url(#arrowBlue)" fill="none"/>

  <g filter="url(#shadow)">
    <rect x="1350" y="845" width="160" height="70" rx="8" fill="#2e1065" stroke="#a78bfa" stroke-width="1"/>
  </g>
  <text x="1430" y="870" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="600" fill="#a78bfa">5. Deploy!</text>
  <text x="1430" y="890" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">terraform apply</text>
  <text x="1430" y="905" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">uses bearer token</text>

  <text x="1010" y="960" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#64748b">
    If job runs &gt;1 hour, azure/login action auto-refreshes the token. No manual intervention needed.
  </text>

  <!-- ==================== SECTION 3: TERRAFORM USAGE ==================== -->

  <rect x="40" y="1020" width="1520" height="50" rx="8" fill="#002244" stroke="#8b5cf6" stroke-width="2"/>
  <text x="800" y="1053" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="700" fill="#a78bfa">
    SECTION 3: Using Terraform After Setup
  </text>

  <!-- Backend Config -->
  <g filter="url(#shadow)">
    <rect x="60" y="1090" width="480" height="280" rx="12" fill="#0f172a" stroke="#8b5cf6" stroke-width="2"/>
  </g>
  <text x="300" y="1125" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#a78bfa">backend.tf — State Storage Config</text>

  <rect x="80" y="1145" width="440" height="210" rx="6" fill="#1e1b4b"/>
  <text x="100" y="1175" font-family="monospace" font-size="11" fill="#c4b5fd">terraform {</text>
  <text x="100" y="1195" font-family="monospace" font-size="11" fill="#c4b5fd">  backend "azurerm" {</text>
  <text x="100" y="1215" font-family="monospace" font-size="11" fill="#94a3b8">    resource_group_name  = </text><text x="350" y="1215" font-family="monospace" font-size="11" fill="#fcba19">"ABCD-dev-networking"</text>
  <text x="100" y="1235" font-family="monospace" font-size="11" fill="#94a3b8">    storage_account_name = </text><text x="350" y="1235" font-family="monospace" font-size="11" fill="#fcba19">"tfdevmyapp"</text>
  <text x="100" y="1255" font-family="monospace" font-size="11" fill="#94a3b8">    container_name       = </text><text x="350" y="1255" font-family="monospace" font-size="11" fill="#fcba19">"tfstate"</text>
  <text x="100" y="1275" font-family="monospace" font-size="11" fill="#94a3b8">    key                  = </text><text x="350" y="1275" font-family="monospace" font-size="11" fill="#fcba19">"terraform.tfstate"</text>
  <text x="100" y="1295" font-family="monospace" font-size="11" fill="#10b981">    use_azuread_auth     = true</text>
  <text x="100" y="1315" font-family="monospace" font-size="11" fill="#c4b5fd">  }</text>
  <text x="100" y="1335" font-family="monospace" font-size="11" fill="#c4b5fd">}</text>

  <!-- GitHub Workflow -->
  <g filter="url(#shadow)">
    <rect x="560" y="1090" width="520" height="280" rx="12" fill="#0f172a" stroke="#238636" stroke-width="2"/>
  </g>
  <text x="820" y="1125" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#4ade80">.github/workflows/deploy.yml</text>

  <rect x="580" y="1145" width="480" height="210" rx="6" fill="#0d2818"/>
  <text x="600" y="1170" font-family="monospace" font-size="10" fill="#4ade80">name: Deploy Infrastructure</text>
  <text x="600" y="1188" font-family="monospace" font-size="10" fill="#4ade80">on:</text>
  <text x="600" y="1206" font-family="monospace" font-size="10" fill="#94a3b8">  push:</text>
  <text x="600" y="1224" font-family="monospace" font-size="10" fill="#94a3b8">    branches: [main]</text>
  <text x="600" y="1246" font-family="monospace" font-size="10" fill="#4ade80">jobs:</text>
  <text x="600" y="1264" font-family="monospace" font-size="10" fill="#94a3b8">  deploy:</text>
  <text x="600" y="1282" font-family="monospace" font-size="10" fill="#94a3b8">    runs-on: ubuntu-latest</text>
  <text x="600" y="1300" font-family="monospace" font-size="10" fill="#fcba19">    environment: dev</text>
  <text x="600" y="1318" font-family="monospace" font-size="10" fill="#64748b">    # ↑ MUST match federated credential</text>
  <text x="600" y="1340" font-family="monospace" font-size="10" fill="#94a3b8">    permissions:</text>
  <text x="600" y="1355" font-family="monospace" font-size="10" fill="#10b981">      id-token: write  # Required for OIDC</text>

  <!-- Workflow Steps -->
  <g filter="url(#shadow)">
    <rect x="1100" y="1090" width="440" height="280" rx="12" fill="#0f172a" stroke="#238636" stroke-width="2"/>
  </g>
  <text x="1320" y="1125" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#4ade80">Workflow Steps</text>

  <rect x="1120" y="1145" width="400" height="210" rx="6" fill="#0d2818"/>
  <text x="1140" y="1170" font-family="monospace" font-size="10" fill="#4ade80">steps:</text>
  <text x="1140" y="1190" font-family="monospace" font-size="10" fill="#94a3b8">  - uses: actions/checkout@v4</text>
  <text x="1140" y="1215" font-family="monospace" font-size="10" fill="#fcba19">  - uses: azure/login@v2</text>
  <text x="1140" y="1235" font-family="monospace" font-size="10" fill="#94a3b8">    with:</text>
  <text x="1140" y="1255" font-family="monospace" font-size="10" fill="#94a3b8">      client-id: ${{ secrets.AZURE_CLIENT_ID }}</text>
  <text x="1140" y="1275" font-family="monospace" font-size="10" fill="#94a3b8">      tenant-id: ${{ secrets.AZURE_TENANT_ID }}</text>
  <text x="1140" y="1295" font-family="monospace" font-size="10" fill="#94a3b8">      subscription-id: ${{ secrets.AZURE_... }}</text>
  <text x="1140" y="1320" font-family="monospace" font-size="10" fill="#fcba19">  - uses: hashicorp/setup-terraform@v3</text>
  <text x="1140" y="1345" font-family="monospace" font-size="10" fill="#10b981">  - run: terraform init</text>
  <text x="1140" y="1365" font-family="monospace" font-size="10" fill="#10b981">  - run: terraform apply -auto-approve</text>

  <!-- ==================== SECTION 4: COMPLETE ARCHITECTURE ==================== -->

  <rect x="40" y="1400" width="1520" height="50" rx="8" fill="#002244" stroke="#0078d4" stroke-width="2"/>
  <text x="800" y="1433" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="700" fill="#38bdf8">
    SECTION 4: Complete Architecture — How It All Fits Together
  </text>

  <!-- Large Architecture Diagram -->
  <g filter="url(#shadow)">
    <rect x="60" y="1470" width="1480" height="550" rx="16" fill="#0f172a" stroke="#334155" stroke-width="1"/>
  </g>

  <!-- GitHub Side -->
  <g filter="url(#shadow)">
    <rect x="100" y="1510" width="400" height="480" rx="12" fill="#0d2818" stroke="#238636" stroke-width="2"/>
  </g>
  <rect x="100" y="1510" width="400" height="40" rx="12" fill="url(#githubGrad)"/>
  <rect x="100" y="1538" width="400" height="12" fill="#0d2818"/>
  <text x="300" y="1538" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="700" fill="white">GitHub</text>

  <!-- Repository -->
  <g filter="url(#shadow)">
    <rect x="130" y="1570" width="340" height="80" rx="8" fill="#1a4d2e" stroke="#4ade80" stroke-width="1"/>
  </g>
  <text x="300" y="1600" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="600" fill="#4ade80">bcgov/myapp</text>
  <text x="300" y="1625" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">Your Terraform code lives here</text>
  <text x="300" y="1642" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">.github/workflows/deploy.yml</text>

  <!-- Dev Environment -->
  <g filter="url(#shadow)">
    <rect x="130" y="1670" width="160" height="100" rx="8" fill="#164e63" stroke="#22d3ee" stroke-width="1"/>
  </g>
  <text x="210" y="1700" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="600" fill="#22d3ee">Environment: dev</text>
  <text x="210" y="1720" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">AZURE_CLIENT_ID</text>
  <text x="210" y="1735" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">AZURE_TENANT_ID</text>
  <text x="210" y="1750" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">AZURE_SUBSCRIPTION_ID</text>
  <text x="210" y="1765" text-anchor="middle" font-family="monospace" font-size="9" fill="#64748b">(dev values)</text>

  <!-- Prod Environment -->
  <g filter="url(#shadow)">
    <rect x="310" y="1670" width="160" height="100" rx="8" fill="#7f1d1d" stroke="#f87171" stroke-width="1"/>
  </g>
  <text x="390" y="1700" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="600" fill="#f87171">Environment: prod</text>
  <text x="390" y="1720" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">AZURE_CLIENT_ID</text>
  <text x="390" y="1735" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">AZURE_TENANT_ID</text>
  <text x="390" y="1750" text-anchor="middle" font-family="monospace" font-size="9" fill="#94a3b8">AZURE_SUBSCRIPTION_ID</text>
  <text x="390" y="1765" text-anchor="middle" font-family="monospace" font-size="9" fill="#64748b">(prod values)</text>

  <!-- GitHub Actions Runner -->
  <g filter="url(#shadow)">
    <rect x="130" y="1800" width="340" height="80" rx="8" fill="#1a4d2e" stroke="#4ade80" stroke-width="1"/>
  </g>
  <text x="300" y="1830" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="600" fill="#4ade80">GitHub Actions Runner</text>
  <text x="300" y="1855" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">Executes workflow, generates OIDC token</text>
  <text x="300" y="1872" text-anchor="middle" font-family="monospace" font-size="10" fill="#fcba19">permissions: id-token: write</text>

  <!-- OIDC Token -->
  <g filter="url(#shadow)">
    <rect x="130" y="1910" width="340" height="60" rx="8" fill="#1e1b4b" stroke="#818cf8" stroke-width="2"/>
  </g>
  <text x="300" y="1940" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="600" fill="#a5b4fc">OIDC JWT Token</text>
  <text x="300" y="1960" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">sub: repo:bcgov/myapp:environment:{env}</text>

  <!-- Azure Side -->
  <g filter="url(#shadow)">
    <rect x="600" y="1510" width="900" height="480" rx="12" fill="#0c1929" stroke="#0078d4" stroke-width="2"/>
  </g>
  <rect x="600" y="1510" width="900" height="40" rx="12" fill="url(#azureGrad)"/>
  <rect x="600" y="1538" width="900" height="12" fill="#0c1929"/>
  <text x="1050" y="1538" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="700" fill="white">Microsoft Azure</text>

  <!-- Entra ID -->
  <g filter="url(#shadow)">
    <rect x="640" y="1570" width="280" height="180" rx="8" fill="#1e3a5f" stroke="#38bdf8" stroke-width="1"/>
  </g>
  <text x="780" y="1600" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="600" fill="#38bdf8">Entra ID (Azure AD)</text>
  <text x="660" y="1630" font-family="Arial, sans-serif" font-size="11" fill="#64748b">Federated Credentials:</text>
  <rect x="660" y="1645" width="240" height="40" rx="4" fill="#164e63" stroke="#22d3ee" stroke-width="1"/>
  <text x="780" y="1665" text-anchor="middle" font-family="monospace" font-size="9" fill="#22d3ee">myapp-dev-identity</text>
  <text x="780" y="1680" text-anchor="middle" font-family="monospace" font-size="8" fill="#94a3b8">sub: ...environment:dev</text>
  <rect x="660" y="1695" width="240" height="40" rx="4" fill="#7f1d1d" stroke="#f87171" stroke-width="1"/>
  <text x="780" y="1715" text-anchor="middle" font-family="monospace" font-size="9" fill="#f87171">myapp-prod-identity</text>
  <text x="780" y="1730" text-anchor="middle" font-family="monospace" font-size="8" fill="#94a3b8">sub: ...environment:prod</text>

  <!-- Dev Subscription -->
  <g filter="url(#shadow)">
    <rect x="960" y="1570" width="250" height="200" rx="8" fill="#0c4a6e" stroke="#22d3ee" stroke-width="2"/>
  </g>
  <text x="1085" y="1598" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="600" fill="#22d3ee">Dev Subscription</text>
  <text x="980" y="1625" font-family="monospace" font-size="9" fill="#94a3b8">Security Group:</text>
  <text x="980" y="1642" font-family="monospace" font-size="8" fill="#22d3ee">DO_PuC_Azure_Live_ABCD_Contributor</text>
  <text x="980" y="1665" font-family="monospace" font-size="9" fill="#94a3b8">Storage:</text>
  <text x="980" y="1682" font-family="monospace" font-size="9" fill="#22d3ee">tfdevmyapp/tfstate</text>
  <rect x="980" y="1700" width="210" height="55" rx="4" fill="#164e63"/>
  <text x="1085" y="1720" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#94a3b8">Dev Resources</text>
  <text x="1085" y="1738" text-anchor="middle" font-family="monospace" font-size="8" fill="#64748b">VNets, Apps, DBs...</text>

  <!-- Prod Subscription -->
  <g filter="url(#shadow)">
    <rect x="1230" y="1570" width="250" height="200" rx="8" fill="#7f1d1d" stroke="#f87171" stroke-width="2"/>
  </g>
  <text x="1355" y="1598" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="600" fill="#f87171">Prod Subscription</text>
  <text x="1250" y="1625" font-family="monospace" font-size="9" fill="#94a3b8">Security Group:</text>
  <text x="1250" y="1642" font-family="monospace" font-size="8" fill="#f87171">DO_PuC_Azure_Live_ABCD_Contributor</text>
  <text x="1250" y="1665" font-family="monospace" font-size="9" fill="#94a3b8">Storage:</text>
  <text x="1250" y="1682" font-family="monospace" font-size="9" fill="#f87171">tfprodmyapp/tfstate</text>
  <rect x="1250" y="1700" width="210" height="55" rx="4" fill="#450a0a"/>
  <text x="1355" y="1720" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#94a3b8">Prod Resources</text>
  <text x="1355" y="1738" text-anchor="middle" font-family="monospace" font-size="8" fill="#64748b">VNets, Apps, DBs...</text>

  <!-- Bearer Token Box -->
  <g filter="url(#shadow)">
    <rect x="640" y="1800" width="280" height="70" rx="8" fill="#1e3a5f" stroke="#fcba19" stroke-width="2"/>
  </g>
  <text x="780" y="1830" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="600" fill="#fcba19">Azure Bearer Token</text>
  <text x="780" y="1855" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">Authorization: Bearer eyJ...</text>
  <text x="780" y="1870" text-anchor="middle" font-family="monospace" font-size="9" fill="#64748b">TTL: 3600 seconds (1 hour)</text>

  <!-- Terraform Box -->
  <g filter="url(#shadow)">
    <rect x="960" y="1800" width="250" height="70" rx="8" fill="#2e1065" stroke="#a78bfa" stroke-width="2"/>
  </g>
  <text x="1085" y="1830" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="600" fill="#a78bfa">Terraform</text>
  <text x="1085" y="1852" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">terraform init</text>
  <text x="1085" y="1867" text-anchor="middle" font-family="monospace" font-size="10" fill="#10b981">terraform apply</text>

  <!-- State File Box -->
  <g filter="url(#shadow)">
    <rect x="1230" y="1800" width="250" height="70" rx="8" fill="#1e3a5f" stroke="#38bdf8" stroke-width="1"/>
  </g>
  <text x="1355" y="1830" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="600" fill="#38bdf8">State File</text>
  <text x="1355" y="1852" text-anchor="middle" font-family="monospace" font-size="10" fill="#94a3b8">terraform.tfstate</text>
  <text x="1355" y="1867" text-anchor="middle" font-family="monospace" font-size="9" fill="#64748b">Stored in Azure Blob</text>

  <!-- Flow Arrows -->
  <path d="M 470 1940 L 550 1940 Q 580 1940 580 1700 L 580 1660 Q 580 1640 600 1640 L 635 1640" stroke="#818cf8" stroke-width="3" marker-end="url(#arrowGold)" fill="none"/>
  <text x="530" y="1780" font-family="Arial, sans-serif" font-size="10" fill="#818cf8" transform="rotate(-90 530 1780)">OIDC Token</text>

  <path d="M 780 1750 L 780 1795" stroke="#fcba19" stroke-width="3" marker-end="url(#arrowGold)" fill="none"/>
  <text x="795" y="1775" font-family="Arial, sans-serif" font-size="9" fill="#fcba19">validates → issues</text>

  <path d="M 920 1835 L 955 1835" stroke="#a78bfa" stroke-width="2" marker-end="url(#arrowGold)" fill="none"/>
  <path d="M 1210 1835 L 1225 1835" stroke="#a78bfa" stroke-width="2" marker-end="url(#arrowGold)" fill="none"/>

  <!-- Legend and Notes -->
  <g filter="url(#shadow)">
    <rect x="640" y="1895" width="830" height="75" rx="8" fill="#002244" stroke="#4a6d8c" stroke-width="1"/>
  </g>
  <text x="660" y="1920" font-family="Arial, sans-serif" font-size="12" font-weight="600" fill="#f8fafc">Flow Summary:</text>
  <text x="660" y="1942" font-family="Arial, sans-serif" font-size="11" fill="#94a3b8">1. Workflow runs with environment: dev (or prod)</text>
  <text x="660" y="1960" font-family="Arial, sans-serif" font-size="11" fill="#94a3b8">2. GitHub generates OIDC token with matching subject claim</text>
  <text x="1050" y="1942" font-family="Arial, sans-serif" font-size="11" fill="#94a3b8">3. Azure validates and returns bearer token</text>
  <text x="1050" y="1960" font-family="Arial, sans-serif" font-size="11" fill="#94a3b8">4. Terraform uses token to deploy to correct subscription</text>

  <!-- ==================== SECTION 5: QUICK REFERENCE ==================== -->

  <rect x="40" y="2050" width="1520" height="50" rx="8" fill="#002244" stroke="#4a6d8c" stroke-width="2"/>
  <text x="800" y="2083" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="700" fill="#f8fafc">
    SECTION 5: Quick Reference
  </text>

  <!-- Checklist -->
  <g filter="url(#shadow)">
    <rect x="60" y="2120" width="480" height="220" rx="12" fill="#002244" stroke="#10b981" stroke-width="1"/>
  </g>
  <text x="300" y="2155" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#34d399">Setup Checklist</text>
  <text x="80" y="2185" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">□ Run script for dev environment</text>
  <text x="80" y="2207" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">□ Run script for prod environment</text>
  <text x="80" y="2229" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">□ Verify GitHub environments created</text>
  <text x="80" y="2251" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">□ Add backend.tf to your Terraform code</text>
  <text x="80" y="2273" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">□ Add deploy.yml workflow</text>
  <text x="80" y="2295" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">□ Set permissions: id-token: write</text>
  <text x="80" y="2317" font-family="Arial, sans-serif" font-size="12" fill="#94a3b8">□ Push and watch the magic happen</text>

  <!-- Common Issues -->
  <g filter="url(#shadow)">
    <rect x="560" y="2120" width="480" height="220" rx="12" fill="#002244" stroke="#fcba19" stroke-width="1"/>
  </g>
  <text x="800" y="2155" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#fcba19">Common Issues</text>
  <text x="580" y="2185" font-family="Arial, sans-serif" font-size="11" fill="#f87171">AADSTS700024: Subject mismatch</text>
  <text x="600" y="2203" font-family="Arial, sans-serif" font-size="10" fill="#64748b">→ environment: in workflow must match -e flag</text>
  <text x="580" y="2228" font-family="Arial, sans-serif" font-size="11" fill="#f87171">OIDC token not generated</text>
  <text x="600" y="2246" font-family="Arial, sans-serif" font-size="10" fill="#64748b">→ Add permissions: id-token: write</text>
  <text x="580" y="2271" font-family="Arial, sans-serif" font-size="11" fill="#f87171">403 Forbidden on terraform apply</text>
  <text x="600" y="2289" font-family="Arial, sans-serif" font-size="10" fill="#64748b">→ Identity not in security group, or wrong subscription</text>
  <text x="580" y="2314" font-family="Arial, sans-serif" font-size="11" fill="#f87171">State file access denied</text>
  <text x="600" y="2332" font-family="Arial, sans-serif" font-size="10" fill="#64748b">→ use_azuread_auth = true missing in backend</text>

  <!-- Key Numbers -->
  <g filter="url(#shadow)">
    <rect x="1060" y="2120" width="480" height="220" rx="12" fill="#002244" stroke="#8b5cf6" stroke-width="1"/>
  </g>
  <text x="1300" y="2155" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="#a78bfa">Key Numbers</text>
  <text x="1080" y="2190" font-family="Arial, sans-serif" font-size="13" fill="#f8fafc">GitHub OIDC Token TTL:</text>
  <text x="1350" y="2190" font-family="monospace" font-size="13" fill="#fcba19">~5 minutes</text>
  <text x="1080" y="2220" font-family="Arial, sans-serif" font-size="13" fill="#f8fafc">Azure Bearer Token TTL:</text>
  <text x="1350" y="2220" font-family="monospace" font-size="13" fill="#fcba19">3600 sec (1 hr)</text>
  <text x="1080" y="2250" font-family="Arial, sans-serif" font-size="13" fill="#f8fafc">Auto-refresh:</text>
  <text x="1350" y="2250" font-family="monospace" font-size="13" fill="#10b981">Yes (azure/login)</text>
  <text x="1080" y="2280" font-family="Arial, sans-serif" font-size="13" fill="#f8fafc">Secrets to rotate:</text>
  <text x="1350" y="2280" font-family="monospace" font-size="13" fill="#10b981">Zero</text>
  <text x="1080" y="2310" font-family="Arial, sans-serif" font-size="13" fill="#f8fafc">Script runs needed:</text>
  <text x="1350" y="2310" font-family="monospace" font-size="13" fill="#10b981">Once per env</text>

  <!-- Footer -->
  <text x="800" y="2380" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#7a9cc6">
    BC Government Public Cloud — Azure Landing Zone — OIDC Authentication Guide
  </text>
</svg>
