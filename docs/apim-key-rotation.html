<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIMKeyRotation | AI Services Hub</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <style>
        :root {
            --bc-blue: #003366;
            --bc-gold: #fcba19;
            --bc-blue-dark: #002244;
            --bc-blue-light: #1a5a96;
            --text-primary: #313132;
            --text-secondary: #606060;
            --bg-light: #f2f2f2;
            --white: #ffffff;
            --gradient-hero: linear-gradient(135deg, #003366 0%, #1a5a96 50%, #003366 100%);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'BC Sans', 'Noto Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .bc-header {
            background: var(--gradient-hero);
            border-bottom: 4px solid var(--bc-gold);
            padding: 0.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .bc-header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }

        .bc-header-logo {
            height: 36px;
            width: auto;
            border-radius: 4px;
        }

        .bc-header-title {
            color: var(--white);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .bc-header-subtitle {
            color: var(--bc-gold);
            font-size: 0.875rem;
        }

        /* Navigation with Dropdowns */
        .bc-nav {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .bc-nav > a,
        .nav-dropdown > .nav-trigger {
            color: var(--white);
            text-decoration: none;
            padding: 0.6rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            border: none;
            background: transparent;
            font-family: inherit;
        }

        .bc-nav > a:hover,
        .nav-dropdown:hover > .nav-trigger {
            background: rgba(255,255,255,0.15);
        }

        .bc-nav > a.active {
            background: var(--bc-gold);
            color: var(--bc-blue);
            font-weight: 600;
        }

        /* Dropdown */
        .nav-dropdown {
            position: relative;
        }

        .nav-trigger::after {
            content: '';
            border: solid currentColor;
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(45deg);
            margin-top: -3px;
            transition: transform 0.2s;
        }

        .nav-dropdown:hover .nav-trigger::after {
            transform: rotate(-135deg);
            margin-top: 3px;
        }

        .nav-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .nav-dropdown:hover .nav-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nav-dropdown-menu a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-dropdown-menu a:hover {
            background: var(--bg-light);
            border-left-color: var(--bc-gold);
            color: var(--bc-blue);
        }

        .nav-dropdown-menu a small {
            display: block;
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 0.2rem;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
            width: 100%;
        }

        /* Hero Section */
        .hero {
            background: var(--gradient-hero);
            color: var(--white);
            padding: 3rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .hero h1 {
            color: var(--white);
            border: none;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Typography */
        h1 {
            color: var(--bc-blue);
            font-size: 2.25rem;
            margin-bottom: 1rem;
            border-bottom: 3px solid var(--bc-gold);
            padding-bottom: 0.5rem;
        }

        h2 {
            color: var(--bc-blue);
            font-size: 1.5rem;
            margin: 2rem 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 1.5rem;
            background: var(--bc-gold);
            border-radius: 2px;
        }

        h3 {
            color: var(--bc-blue-light);
            font-size: 1.25rem;
            margin: 1.5rem 0 0.75rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* Cards - Enhanced */
        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--bc-blue);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-gold {
            border-left-color: var(--bc-gold);
        }

        .card h3 {
            margin-top: 0;
        }

        /* Clickable Cards */
        a.card-link {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        a.card-link .card {
            cursor: pointer;
        }

        a.card-link .card:hover {
            border-left-width: 6px;
        }

        .card-arrow {
            color: var(--bc-blue-light);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            transition: var(--transition);
        }

        a.card-link:hover .card-arrow {
            gap: 0.75rem;
            color: var(--bc-blue);
        }

        /* Feature Cards */
        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .feature-icon.gold { background: rgba(252, 186, 25, 0.15); }
        .feature-icon.blue { background: rgba(0, 51, 102, 0.1); }
        .feature-icon.green { background: rgba(34, 197, 94, 0.1); }
        .feature-icon.purple { background: rgba(139, 92, 246, 0.1); }

        /* Stats */
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--bc-gold);
            line-height: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Code blocks */
        pre {
            background: var(--bc-blue-dark);
            color: #e2e8f0;
            padding: 1.25rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.875rem;
            box-shadow: var(--shadow-sm);
        }

        code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: #e2e8f0;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        pre code {
            background: none;
            padding: 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        th {
            background: var(--bc-blue);
            color: var(--white);
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f8fafc;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        /* Links */
        a {
            color: var(--bc-blue-light);
            transition: var(--transition);
        }

        a:hover {
            color: var(--bc-blue);
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert > * {
            min-width: 0;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-info {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-left: 4px solid #0ea5e9;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--bc-gold);
        }

        .alert-success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left: 4px solid #22c55e;
        }

        /* Image containers */
        .img-container {
            margin: 1.5rem 0;
            text-align: center;
        }

        .img-container img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-gold {
            background: var(--bc-gold);
            color: var(--bc-blue);
        }

        .badge-blue {
            background: var(--bc-blue);
            color: var(--white);
        }

        /* Accordion / Collapsible */
        details {
            background: var(--white);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--bc-blue);
            overflow: hidden;
            transition: var(--transition);
        }

        details:hover {
            box-shadow: var(--shadow-md);
        }

        details[open] {
            border-left-color: var(--bc-gold);
        }

        summary {
            padding: 1rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--bc-blue);
            display: flex;
            align-items: center;
            justify-content: space-between;
            list-style: none;
            user-select: none;
            transition: var(--transition);
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::after {
            content: '';
            border: solid var(--bc-blue-light);
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 4px;
            transform: rotate(-45deg);
            transition: transform 0.2s ease;
            flex-shrink: 0;
            margin-left: 1rem;
        }

        details[open] summary::after {
            transform: rotate(45deg);
        }

        summary:hover {
            background: var(--bg-light);
        }

        details[open] summary {
            border-bottom: 1px solid #e2e8f0;
            background: var(--bg-light);
        }

        .accordion-content {
            padding: 1rem 1.25rem;
        }

        .accordion-content p:last-child {
            margin-bottom: 0;
        }

        /* Accordion with badge */
        summary .badge {
            margin-left: auto;
            margin-right: 1rem;
        }

        /* Accordion group */
        .accordion-group {
            margin: 1rem 0;
        }

        .accordion-group details:last-child {
            margin-bottom: 0;
        }

        /* Footer */
        .site-footer {
            background: var(--bc-blue);
            color: var(--white);
            padding: 3rem 2rem;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }

        .footer-brand h4,
        .footer-links h4 {
            color: var(--bc-gold);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .footer-brand p {
            color: #94a3b8;
            font-size: 0.875rem;
            margin: 0;
        }

        .footer-links ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-links li {
            margin-bottom: 0.5rem;
        }

        .footer-links a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .footer-links a:hover {
            color: var(--bc-gold);
        }

        .footer-copyright {
            text-align: right;
        }

        .footer-copyright p {
            color: #64748b;
            font-size: 0.75rem;
            margin: 0;
        }

        .footer-meta {
            margin-top: 0.5rem !important;
            opacity: 0.7;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .bc-header {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }

            .bc-nav {
                justify-content: center;
            }

            .nav-dropdown-menu {
                position: fixed;
                left: 1rem;
                right: 1rem;
                width: auto;
            }

            main {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .hero {
                padding: 2rem 1rem;
            }

            .hero h1 {
                font-size: 1.75rem;
            }

            .footer-content {
                text-align: center;
            }

            .footer-copyright {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header class="bc-header">
        <a href="index.html" class="bc-header-brand">
            <img src="assets/bc_citz_logo.jpg" alt="BC Government" class="bc-header-logo">
            <div>
                <div class="bc-header-title">AI Services Hub</div>
                <div class="bc-header-subtitle">Azure Landing Zone Infrastructure</div>
            </div>
        </a>
        <nav class="bc-nav">
            <a href="index.html" class="">Home</a>
            <div class="nav-dropdown">
                <span class="nav-trigger">Guides</span>
                <div class="nav-dropdown-menu">
                    <a href="oidc-setup.html">
                        OIDC Setup
                        <small>GitHub to Azure authentication</small>
                    </a>
                    <a href="terraform.html">
                        Terraform Modules
                        <small>Network, Bastion, Runners, Proxy</small>
                    </a>
                    <a href="language-service-pii.html">
                        Language Service PII
                        <small>ML-based PII detection & APIM</small>
                    </a>
                    <a href="document-intelligence.html">
                        Document Intelligence
                        <small>SDK configuration & APIM integration</small>
                    </a>
                    <a href="workflows.html">
                        GitHub Workflows
                        <small>CI/CD automation</small>
                    </a>
                    <a href="terraform-reference.html">
                        TF Reference
                        <small>Auto-generated from code</small>
                    </a>
                    <a href="apim-key-rotation.html">
                        APIM Key Rotation
                        <small>Subscription key auto-rotation</small>
                    </a>
                </div>
            </div>
            <a href="diagrams.html" class="">Diagrams</a>
            <a href="playbooks.html" class="">Playbooks</a>
            <a href="decisions.html" class="">ADRs</a>
            <a href="cost.html" class="">Cost</a>
            <a href="faq.html" class="">FAQ</a>
        </nav>
    </header>
    <main>

<h1>APIM Subscription Key Rotation</h1>

<p>This guide explains how APIM subscription keys are automatically rotated for tenant teams, and how to update your application to use the new keys.</p>

<div class="alert alert-info">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
    </div>
    <div>
        <strong>Zero Downtime</strong><br>
        Key rotation uses an alternating primary/secondary pattern. Only one key is rotated at a time &mdash; the other remains valid and untouched. Your service is never interrupted.
    </div>
</div>

<h2>How It Works</h2>

<div class="card">
    <h3>Alternating Primary/Secondary Pattern</h3>
    <p>APIM subscriptions have two key slots: <strong>primary</strong> and <strong>secondary</strong>. Both are valid for API calls at all times. Each rotation cycle regenerates one slot while the other remains untouched:</p>
    <ol>
        <li><strong>Week 1: Regenerate SECONDARY</strong> &mdash; tenants continue using PRIMARY (untouched)</li>
        <li><strong>Week 2: Regenerate PRIMARY</strong> &mdash; tenants continue using SECONDARY (regenerated last week, still valid)</li>
        <li><strong>Week 3: Regenerate SECONDARY</strong> &mdash; alternates indefinitely</li>
    </ol>
    <p>Both keys are stored in the centralized hub Key Vault after every rotation. Tenants can fetch new keys at their convenience via the APIM internal endpoint or by requesting access from the platform team.</p>
</div>

<div class="card">
    <h3>Key Lifecycle Timeline</h3>
    <table>
        <thead>
            <tr>
                <th>Event</th>
                <th>Primary Key</th>
                <th>Secondary Key</th>
                <th>Safe to Use</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Initial</strong></td>
                <td>key_A</td>
                <td>key_B</td>
                <td>Either &check;</td>
            </tr>
            <tr>
                                <td><strong>Rotation 1</strong> (regen secondary)</td>
                                <td>key_A (untouched)</td>
                                <td><strong>key_C</strong> (NEW)</td>
                                <td>key_A &check;</td>
            </tr>
            <tr>
                                <td><strong>Rotation 2</strong> (regen primary)</td>
                                <td><strong>key_D</strong> (NEW)</td>
                                <td>key_C (untouched)</td>
                                <td>key_C &check;</td>
            </tr>
            <tr>
                                <td><strong>Rotation 3</strong> (regen secondary)</td>
                                <td>key_D (untouched)</td>
                                <td><strong>key_E</strong> (NEW)</td>
                                <td>key_D &check;</td>
            </tr>
        </tbody>
    </table>
    <p><em>The key NOT being rotated is always safe. You have the full rotation interval to switch to the new key.</em></p>
</div>

<h2>Platform Team Runbook (Emergency)</h2>

<div class="card">
        <h3>Compromised Keys: Rotate Both Slots Immediately</h3>
        <p>Use this runbook only for emergency compromise scenarios where both keys must be replaced right away. This is a manual operational procedure (documentation only).</p>
        <ol>
                <li>Identify the APIM subscription ID and tenant name.</li>
                <li>Regenerate <strong>secondary</strong> and then <strong>primary</strong> in APIM.</li>
                <li>Read latest key values from APIM <code>listSecrets</code>.</li>
                <li>Write both keys to hub Key Vault with 90-day expiry.</li>
                <li>Update <code>{tenant}-apim-rotation-metadata</code> with <code>safe_slot</code> and timestamps.</li>
                <li>Notify tenant team to pull new keys from <code>/internal/apim-keys</code>.</li>
        </ol>

        <h4>Example CLI Sequence</h4>
        <pre># Inputs
SUBSCRIPTION_ID="&lt;azure-subscription-id&gt;"
RESOURCE_GROUP="ai-services-hub-dev"
APIM_NAME="ai-services-hub-dev-apim"
TENANT="wlrs-water-form-assistant"
APIM_SUB_ID="&lt;apim-subscription-guid&gt;"
HUB_KV="ai-services-hub-dev-hkv"

# 1) Regenerate both slots (secondary first, then primary)
az rest --method POST \
    --url "https://management.azure.com/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.ApiManagement/service/${APIM_NAME}/subscriptions/${APIM_SUB_ID}/regenerateSecondaryKey?api-version=2024-05-01"

az rest --method POST \
    --url "https://management.azure.com/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.ApiManagement/service/${APIM_NAME}/subscriptions/${APIM_SUB_ID}/regeneratePrimaryKey?api-version=2024-05-01"

# 2) Get current keys from APIM
SECRETS_JSON=$(az rest --method POST \
    --url "https://management.azure.com/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.ApiManagement/service/${APIM_NAME}/subscriptions/${APIM_SUB_ID}/listSecrets?api-version=2024-05-01")

PRIMARY=$(echo "$SECRETS_JSON" | jq -r '.primaryKey')
SECONDARY=$(echo "$SECRETS_JSON" | jq -r '.secondaryKey')
EXPIRES_ON=$(date -u -d "+90 days" +"%Y-%m-%dT%H:%M:%SZ")
NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# 3) Store keys in hub Key Vault
az keyvault secret set --vault-name "$HUB_KV" --name "${TENANT}-apim-primary-key" --value "$PRIMARY" --expires "$EXPIRES_ON"
az keyvault secret set --vault-name "$HUB_KV" --name "${TENANT}-apim-secondary-key" --value "$SECONDARY" --expires "$EXPIRES_ON"

# 4) Update metadata
METADATA=$(jq -n --arg now "$NOW" '{
    last_rotated_slot: "primary",
    last_rotation_at: $now,
    next_rotation_at: "manual-emergency",
    rotation_number: 999,
    safe_slot: "secondary"
}')

az keyvault secret set \
    --vault-name "$HUB_KV" \
    --name "${TENANT}-apim-rotation-metadata" \
    --value "$METADATA" \
    --content-type "application/json" \
    --expires "$EXPIRES_ON"</pre>

        <div class="alert alert-warning" style="margin-top: 0.75rem;">
                <div>
                        <strong>Important:</strong> This emergency sequence invalidates all previously leaked keys. Coordinate tenant notifications immediately after completion.
                </div>
        </div>
</div>

<div class="card">
        <h3>Tenant Retrieval After Emergency Rotation</h3>
        <p>After platform team rotates both keys, tenant teams should fetch current keys from APIM and switch to the <code>safe_slot</code> key.</p>
        <pre>curl -s -H "api-key: YOUR_CURRENT_VALID_KEY" \
    "https://your-apim-gateway.azure-api.net/YOUR_TENANT/internal/apim-keys" | jq .

# Read the recommended key:
# .rotation.safe_slot
# Then use .primary_key or .secondary_key accordingly.</pre>
        <p>If the tenant has no valid key left, platform team must provide one-time bootstrap access/key out-of-band.</p>
</div>

<h2>Configuration</h2>

<div class="card">
    <h3>Shared Config (<code>params/{env}/shared.tfvars</code>)</h3>
    <p>Key rotation is configured globally for all tenants in the shared config:</p>
    <pre>apim = {
  # ... existing APIM config ...

  key_rotation = {
    rotation_enabled       = true   # Master flag (on/off for all tenants)
    rotation_interval_days = 7      # Rotate every N days (same for all tenants)
  }
}</pre>
    <table>
        <thead>
            <tr>
                <th>Setting</th>
                <th>Type</th>
                <th>Default</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>rotation_enabled</code></td>
                <td>bool</td>
                <td><code>false</code></td>
                <td>Master flag. When <code>false</code>, no keys are rotated for any tenant.</td>
            </tr>
            <tr>
                <td><code>rotation_interval_days</code></td>
                <td>number</td>
                <td><code>7</code></td>
                <td>Days between rotations. Applies uniformly to all tenants.</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Tenant Prerequisites</h3>
    <p>For a tenant to participate in key rotation, it only needs:</p>
    <ul>
        <li><code>apim_auth.mode = "subscription_key"</code> (default)</li>
    </ul>
    <div class="alert alert-info" style="margin-top: 0.75rem;">
        <div>
            <strong>Note:</strong> A per-tenant Key Vault is <strong>not required</strong> for key rotation. All rotation keys are stored in a centralized hub Key Vault managed by the platform team. Any tenant using subscription_key auth is automatically eligible.
        </div>
    </div>
</div>

<h2>How Tenants Fetch New Keys</h2>

<div class="alert alert-success">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
    </div>
    <div>
        <strong>Key Insight</strong><br>
        After rotation, one of your keys is always still valid (the one that was NOT rotated). Use it to call the APIM internal endpoint or continue using your service while you update to the new key.
    </div>
</div>

<div class="card">
    <h3>Option 1: APIM Internal Endpoint (Simplest)</h3>
    <p>Call <code>GET /{your-tenant}/internal/apim-keys</code> with ANY valid subscription key. Returns both keys plus rotation metadata as JSON.</p>

    <h4>Bash</h4>
    <pre>#!/bin/bash
# Fetch both APIM keys via the internal endpoint
APIM_GATEWAY="https://your-apim-gateway.azure-api.net"
TENANT="your-tenant-name"
CURRENT_KEY="your-current-valid-key"

RESPONSE=$(curl -s \
    -H "api-key: ${CURRENT_KEY}" \
    "${APIM_GATEWAY}/${TENANT}/internal/apim-keys")

echo "${RESPONSE}" | jq .

# Example response:
# {
#   "tenant": "your-tenant-name",
#   "primary_key": "abc123...",
#   "secondary_key": "def456...",
#   "rotation": {
#     "last_rotated_slot": "primary",
#     "last_rotation_at": "2026-02-11T02:00:00Z",
#     "next_rotation_at": "2026-02-18T02:00:00Z",
#     "rotation_number": 5,
#     "safe_slot": "secondary"
#   },
#   "keyvault": {
#     "uri": "https://hub-kv.vault.azure.net/",
#     "primary_key_secret": "your-tenant-name-apim-primary-key",
#     "secondary_key_secret": "your-tenant-name-apim-secondary-key"
#   }
# }

# Use the safe_slot key (the one NOT just rotated)
SAFE_SLOT=$(echo "${RESPONSE}" | jq -r '.rotation.safe_slot')
if [[ "${SAFE_SLOT}" == "primary" ]]; then
    NEW_KEY=$(echo "${RESPONSE}" | jq -r '.primary_key')
else
    NEW_KEY=$(echo "${RESPONSE}" | jq -r '.secondary_key')
fi
echo "Safe key to use: ${NEW_KEY:0:8}..."</pre>

    <h4>Python</h4>
    <pre>import requests

apim_gateway = "https://your-apim-gateway.azure-api.net"
tenant = "your-tenant-name"
current_key = "your-current-valid-key"

response = requests.get(
    f"{apim_gateway}/{tenant}/internal/apim-keys",
    headers={"api-key": current_key}
)
data = response.json()

safe_slot = data["rotation"]["safe_slot"]  # "primary" or "secondary"
safe_key = data[f"{safe_slot}_key"]
print(f"Safe slot: {safe_slot}, key: {safe_key[:8]}...")</pre>
</div>

<div class="card">
    <h3>Option 2: Contact Platform Team</h3>
    <p>If you've missed a rotation schedule or need a fresh set of keys, contact the platform team directly. The platform team manages the centralized hub Key Vault and can provide your current keys or trigger an ad-hoc rotation.</p>
    <div class="alert alert-info" style="margin-top: 0.75rem;">
        <div>
            <strong>Hub Key Vault:</strong> All tenant rotation keys are stored centrally in the hub Key Vault (<code>{app_name}-{env}-hkv</code>). Tenants do not need their own Key Vault for rotation. Secret names follow the pattern: <code>{tenant}-apim-primary-key</code>, <code>{tenant}-apim-secondary-key</code>.
        </div>
    </div>
</div>

<div class="card">
    <h3>Option 3: Automatic Key Refresh (Production Pattern)</h3>
    <p>For production apps, implement a periodic key check. This pattern uses the APIM endpoint so no Azure SDK is needed.</p>

    <pre>#!/bin/bash
# rotate-my-key.sh - Run via cron: 0 3 * * * /path/to/rotate-my-key.sh
set -euo pipefail

APIM_GATEWAY="https://your-apim-gateway.azure-api.net"
TENANT="your-tenant-name"
CONFIG_FILE="/etc/myapp/apim-key"

# Read the current key your app is using
CURRENT_KEY=$(cat "${CONFIG_FILE}" 2>/dev/null || echo "")

if [[ -z "${CURRENT_KEY}" ]]; then
    echo "ERROR: No current key found in ${CONFIG_FILE}"
    exit 1
fi

# Fetch both keys via APIM (authenticates with current key)
RESPONSE=$(curl -s -H "api-key: ${CURRENT_KEY}" \
    "${APIM_GATEWAY}/${TENANT}/internal/apim-keys")

SAFE_SLOT=$(echo "${RESPONSE}" | jq -r '.rotation.safe_slot')
if [[ "${SAFE_SLOT}" == "primary" ]]; then
    LATEST_KEY=$(echo "${RESPONSE}" | jq -r '.primary_key')
else
    LATEST_KEY=$(echo "${RESPONSE}" | jq -r '.secondary_key')
fi

if [[ "${CURRENT_KEY}" != "${LATEST_KEY}" ]]; then
    echo "$(date -u +'%Y-%m-%dT%H:%M:%SZ') Key changed - updating config"
    echo "${LATEST_KEY}" > "${CONFIG_FILE}"
    # Optionally: systemctl reload myapp
else
    echo "$(date -u +'%Y-%m-%dT%H:%M:%SZ') Key unchanged"
fi</pre>
</div>

<h2>Key Vault Secrets Reference</h2>

<div class="card">
    <p>All secrets are stored in the centralized hub Key Vault (<code>{app_name}-{env}-hkv</code>) with tenant-prefixed names:</p>
    <table>
        <thead>
            <tr>
                <th>Secret Name Pattern</th>
                <th>Description</th>
                <th>Managed By</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>{tenant}-apim-primary-key</code></td>
                <td>Current value of the APIM primary key slot for this tenant.</td>
                <td>Terraform (seed) + Rotation script</td>
            </tr>
            <tr>
                <td><code>{tenant}-apim-secondary-key</code></td>
                <td>Current value of the APIM secondary key slot for this tenant.</td>
                <td>Terraform (seed) + Rotation script</td>
            </tr>
            <tr>
                <td><code>{tenant}-apim-rotation-metadata</code></td>
                <td>JSON metadata: last rotated slot, safe slot, rotation timestamp, rotation number.</td>
                <td>Rotation script</td>
            </tr>
        </tbody>
    </table>
</div>

<h2>Rotation Schedule</h2>

<div class="card">
    <table>
        <thead>
            <tr>
                <th>Environment</th>
                <th>Interval</th>
                <th>Schedule</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Dev</td>
                <td>7 days</td>
                <td>Every Monday 02:00 UTC</td>
                <td>Enabled</td>
            </tr>
            <tr>
                <td>Test</td>
                <td>7 days</td>
                <td>Every Monday 02:00 UTC</td>
                <td>Enabled</td>
            </tr>
            <tr>
                <td>Prod</td>
                <td>30 days</td>
                <td>Every Monday 02:00 UTC (only rotates when interval elapsed)</td>
                <td>Disabled (pending validation)</td>
            </tr>
        </tbody>
    </table>
    <p>The GitHub Actions workflow runs weekly, but the bash script checks whether the rotation interval has actually elapsed before regenerating keys. A 30-day interval means the script will skip most weekly runs.</p>
    <div class="alert alert-warning" style="margin-top: 0.75rem;">
        <div>
            <strong>Repository Maintenance Required:</strong> GitHub automatically disables scheduled workflows after 60 days of repo inactivity. This repo must have regular commits or activity to keep the rotation workflow running. If the workflow gets disabled, re-enable it from the Actions tab or trigger manually via <code>workflow_dispatch</code>.
        </div>
    </div>
    <div class="alert alert-info" style="margin-top: 0.75rem;">
        <div>
            <strong>Missed Rotation?</strong> If a rotation was missed due to workflow inactivity, tenants can contact the platform team for a new set of keys or to trigger an ad-hoc rotation.
        </div>
    </div>
</div>

<h2>APIM Internal Endpoint</h2>

<div class="card">
    <h3><code>GET /{tenant-name}/internal/apim-keys</code></h3>
    <p>When key rotation is enabled, each tenant API exposes an internal endpoint for fetching both subscription keys.</p>

    <h4>Authentication</h4>
    <p>Requires a valid APIM subscription key (either primary or secondary) in the <code>api-key</code> header. APIM validates the key before serving the response.</p>

    <h4>How It Works</h4>
    <ol>
        <li>APIM validates the incoming subscription key (standard APIM behavior)</li>
        <li>APIM policy uses its managed identity to read secrets from the centralized hub Key Vault</li>
        <li>Returns JSON with primary key, secondary key, rotation metadata, and Key Vault info</li>
    </ol>

    <h4>Response Example</h4>
    <pre>{
  "tenant": "your-tenant-name",
  "primary_key": "abc123def456...",
  "secondary_key": "ghi789jkl012...",
  "rotation": {
    "last_rotated_slot": "primary",
    "last_rotation_at": "2026-02-11T02:00:00Z",
    "next_rotation_at": "2026-02-18T02:00:00Z",
    "rotation_number": 5,
    "safe_slot": "secondary"
  },
  "keyvault": {
    "uri": "https://hub-kv.vault.azure.net/",
    "primary_key_secret": "your-tenant-name-apim-primary-key",
    "secondary_key_secret": "your-tenant-name-apim-secondary-key"
  }
}</pre>

    <h4>Infrastructure</h4>
    <p>The endpoint is implemented purely in APIM policy (no backend service). APIM's system-assigned managed identity is granted <code>Key Vault Secrets User</code> on the centralized hub Key Vault via a single Terraform RBAC assignment (scales to 1000+ tenants).</p>
</div>

<h2>Troubleshooting</h2>

<div class="card">
    <h3>My API calls return 401 after rotation</h3>
    <p>Your app is using the key that was just rotated. The other key is still valid. Fix:</p>
    <ol>
        <li>Fetch both keys: <code>curl -H "api-key: YOUR_OTHER_KEY" https://apim/{tenant}/internal/apim-keys</code></li>
        <li>Use the <code>safe_slot</code> key from the response</li>
        <li>Both keys are also in the hub Key Vault: <code>{tenant}-apim-primary-key</code> and <code>{tenant}-apim-secondary-key</code></li>
    </ol>

    <h3>How do I check rotation metadata?</h3>
    <pre>az keyvault secret show \
    --vault-name HUB_KV_NAME \
    --name "YOUR_TENANT-apim-rotation-metadata" \
    --query "value" -o tsv | jq .</pre>
    <p>Output:</p>
    <pre>{
  "last_rotated_slot": "primary",
  "last_rotation_at": "2026-02-11T02:00:00Z",
  "next_rotation_at": "2026-02-18T02:00:00Z",
  "rotation_number": 5,
  "safe_slot": "secondary"
}</pre>

    <h3>The /internal/apim-keys endpoint returns empty keys</h3>
    <p>APIM's managed identity may not have access to the hub Key Vault. Verify the RBAC assignment:</p>
    <pre>terraform output apim_key_rotation_summary</pre>
    <p>Ensure the <code>azurerm_role_assignment.apim_keyvault_secrets_user</code> resource exists on the hub Key Vault. Check that the hub Key Vault (<code>{app_name}-{env}-hkv</code>) is deployed and accessible.</p>

    <h3>GitHub Actions rotation stopped running</h3>
    <p>GitHub disables scheduled workflows after 60 days of repo inactivity. This repo requires regular maintenance (commits, activity) to keep scheduled workflows active.</p>
    <ol>
        <li>Go to Actions tab &rarr; Find "APIM Key Rotation" workflow</li>
        <li>Click "Enable workflow"</li>
        <li>Or trigger manually via <code>workflow_dispatch</code></li>
        <li><strong>Contact the platform team</strong> if rotation was missed &mdash; they can issue new keys or trigger an ad-hoc rotation</li>
    </ol>

    <h3>I want to temporarily disable rotation for my environment</h3>
    <p>Set <code>rotation_enabled = false</code> in <code>params/{env}/shared.tfvars</code> and deploy. The rotation workflow will skip all tenants.</p>

    <h3>My tenant is not eligible for rotation</h3>
    <p>Check:</p>
    <pre>terraform output apim_key_rotation_summary</pre>
    <p>Common reasons:</p>
    <ul>
        <li><code>apim_auth.mode != "subscription_key"</code> &mdash; rotation only applies to subscription key auth</li>
        <li>Rotation is globally disabled (<code>rotation_enabled = false</code> in <code>shared.tfvars</code>)</li>
    </ul>
</div>

<h2>Architecture</h2>

<div class="card">
    <h3>Component Overview</h3>
    <table>
        <thead>
            <tr>
                <th>Component</th>
                <th>Purpose</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Rotation Script</td>
                <td>Self-contained bash script: discovers APIM + hub KV, rotates keys, stores in hub KV</td>
                <td><code>infra-ai-hub/scripts/rotate-apim-keys.sh</code></td>
            </tr>
            <tr>
                <td>GitHub Actions Workflow</td>
                <td>Thin wrapper: checkout, OIDC login, calls script with <code>--environment</code></td>
                <td><code>.github/workflows/apim-key-rotation.yml</code></td>
            </tr>
            <tr>
                <td>Hub Key Vault</td>
                <td>Centralized KV storing ALL tenant rotation keys (scales to 1000+ tenants)</td>
                <td><code>infra-ai-hub/main.tf</code> (<code>module.hub_key_vault</code>)</td>
            </tr>
            <tr>
                <td>APIM Policy Endpoint</td>
                <td>Internal <code>/apim-keys</code> route reads from hub KV</td>
                <td><code>infra-ai-hub/params/apim/api_policy.xml.tftpl</code></td>
            </tr>
            <tr>
                <td>Terraform Config</td>
                <td>Seeds initial KV secrets, rotation metadata, single RBAC for APIM MI &rarr; hub KV</td>
                <td><code>infra-ai-hub/main.tf</code> (key rotation section)</td>
            </tr>
            <tr>
                <td>Shared Config</td>
                <td>Rotation enabled flag + interval days</td>
                <td><code>infra-ai-hub/params/{env}/shared.tfvars</code></td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Security Considerations</h3>
    <ul>
        <li><strong>OIDC Authentication</strong>: The rotation workflow uses the same OIDC identity as Terraform deployments. No stored secrets.</li>
        <li><strong>Centralized Hub Key Vault</strong>: All rotation keys are stored in a single hub KV. APIM reads keys via its system-assigned MI with one RBAC assignment. Scales to 1000+ tenants.</li>
        <li><strong>No Per-Tenant KV Required</strong>: Tenants do not need their own Key Vault for rotation. The hub KV handles all tenants centrally.</li>
        <li><strong>Audit Trail</strong>: Every key change is versioned in Key Vault with rotation metadata tags.</li>
        <li><strong>No Key in Logs</strong>: The rotation script never prints key values. Only metadata appears in logs.</li>
        <li><strong>Terraform Lifecycle</strong>: Key Vault secrets use <code>ignore_changes = [value, tags]</code> so Terraform won't overwrite rotated keys.</li>
        <li><strong>Internal Endpoint Security</strong>: The <code>/internal/apim-keys</code> endpoint requires a valid subscription key. Only authenticated tenants can read their own keys.</li>
    </ul>
</div>
    </main>
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-brand">
                <h4>AI Services Hub</h4>
                <p>Infrastructure as Code for Azure Landing Zone deployments</p>
            </div>
            <div class="footer-links">
                <h4>Resources</h4>
                <ul>
                    <li><a href="https://github.com/bcgov/ai-hub-tracking">GitHub Repository</a></li>
                    <li><a href="assets/azure-oidc-complete-guide.svg" target="_blank">Architecture Diagram</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>BC Government</h4>
                <ul>
                    <li><a href="https://www2.gov.bc.ca">gov.bc.ca</a></li>
                    <li><a href="https://digital.gov.bc.ca">Digital Office</a></li>
                </ul>
            </div>
            <div class="footer-copyright">
                <p>&copy; 2026 Province of British Columbia</p>
                <p class="footer-meta">Built with zero dependencies</p>
            </div>
        </div>
    </footer>

    <script>
        (function () {
            function scrollToWithHeaderOffset(el) {
                if (!el) return;
                const header = document.querySelector('.bc-header');
                const offset = (header ? header.getBoundingClientRect().height : 0) + 16;

                const top = el.getBoundingClientRect().top + window.scrollY - offset;
                window.scrollTo({ top: Math.max(0, top) });
            }

            function openDetailsFromHash() {
                const hash = window.location.hash;
                if (!hash || hash.length < 2) return;

                const id = hash.substring(1);
                const el = document.getElementById(id);
                if (el && el.tagName && el.tagName.toLowerCase() === 'details') {
                    el.open = true;
                    // Opening can change layout; adjust scroll after paint so the
                    // sticky header doesn't cover the <summary> title.
                    requestAnimationFrame(function () {
                        requestAnimationFrame(function () {
                            scrollToWithHeaderOffset(el);
                        });
                    });
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                openDetailsFromHash();
            });

            window.addEventListener('hashchange', function () {
                openDetailsFromHash();
            });

            // If user clicks the same #hash twice, hashchange won't fire.
            // This ensures ADR links always expand.
            document.addEventListener('click', function (e) {
                const link = e.target.closest && e.target.closest('a[href^="#"]');
                if (!link) return;

                const href = link.getAttribute('href');
                if (!href || href.length < 2) return;

                const id = href.substring(1);
                const el = document.getElementById(id);
                if (el && el.tagName && el.tagName.toLowerCase() === 'details') {
                    el.open = true;
                    requestAnimationFrame(function () {
                        requestAnimationFrame(function () {
                            scrollToWithHeaderOffset(el);
                        });
                    });
                }
            });
        })();
    </script>
</body>
</html>
