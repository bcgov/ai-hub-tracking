<!-- TITLE: Architecture Decisions -->
<!-- NAV: decisions -->

<style>
/* Collapsible ADR Styling */
details.adr {
    background: var(--white);
    border-radius: 8px;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

details.adr[open] {
    border-color: var(--bc-gold);
    box-shadow: var(--shadow-md);
}

details.adr summary {
    padding: 1rem 1.5rem;
    cursor: pointer;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 2px solid transparent;
    display: flex;
    align-items: center;
    gap: 1rem;
    font-weight: 600;
    color: var(--bc-blue);
    list-style: none;
}

details.adr summary::-webkit-details-marker {
    display: none;
}

details.adr summary::before {
    content: "â–¶";
    font-size: 0.8rem;
    transition: transform 0.2s;
    color: var(--bc-gold);
}

details.adr[open] summary::before {
    transform: rotate(90deg);
}

details.adr[open] summary {
    border-bottom: 2px solid var(--bc-gold);
    background: linear-gradient(135deg, #fef9e7 0%, #fef3c7 100%);
}

details.adr summary .adr-title {
    flex: 1;
}

details.adr summary .adr-status {
    font-size: 0.85rem;
}

details.adr .adr-content {
    padding: 1.5rem;
}

details.adr.pending summary {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
}

details.adr.pending[open] summary {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
}
</style>

<h1>Architecture Decision Records</h1>

<p>This page documents key architectural decisions for the AI Hub Tracking infrastructure. Each ADR explains the context, decision, and consequences to help future maintainers understand why things are built the way they are.</p>

<div class="alert alert-warning">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10Z"/></svg>
    </div>
    <div>
        <strong>BC Government Policy Context</strong><br>
        Most decisions documented here are <strong>driven by BC Government security policies</strong>, not optional architectural choices. Key policy constraints include:
        <ul style="margin: 0.5rem 0 0 0;">
            <li><strong>No public endpoints</strong> - All Azure services must use private endpoints only</li>
            <li><strong>Private networking required</strong> - Resources must be isolated within VNets</li>
            <li><strong>No long-lived secrets</strong> - Credential rotation policies favor OIDC/managed identities</li>
            <li><strong>Bastion-only access</strong> - Direct SSH/RDP from internet is prohibited</li>
        </ul>
    </div>
</div>

<div class="card" style="border-left-color: #003366; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
    <h3 style="margin-top: 0; color: var(--bc-blue);">Start Here: ADR-001</h3>
    <p style="margin-bottom: 0;"><strong>ADR-001 (Shared Landing Zone)</strong> is the foundation that explains <em>why</em> all the other infrastructure exists. Read it first to understand the architecture.</p>
</div>

<div class="alert alert-info">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    </div>
    <div>
        <strong>About ADRs</strong><br>
        Architecture Decision Records capture decisions along with their context and consequences. They help prevent re-litigating settled discussions and provide onboarding context for new team members.
    </div>
</div>

<h2>Decision Index</h2>

<table>
    <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Driver</th>
        <th>Status</th>
    </tr>
    <tr>
        <td><a href="#adr-001">ADR-001</a></td>
        <td>Shared Landing Zone with Bastion/Jumpbox</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-002">ADR-002</a></td>
        <td>Use OIDC instead of Service Principal Secrets</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-003">ADR-003</a></td>
        <td>Use Azure Bastion for VM Access</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-004">ADR-004</a></td>
        <td>Private Endpoints for All Azure Services</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-005">ADR-005</a></td>
        <td>Zero-Dependency Documentation System</td>
        <td><span class="badge" style="background:#22c55e;color:white;">Choice</span></td>
        <td><span class="badge badge-gold">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-006">ADR-006</a></td>
        <td>Multi-Tenant Isolation Model</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></td>
    </tr>
    <tr>
        <td><a href="#adr-007">ADR-007</a></td>
        <td>Client Connectivity via App Gateway + APIM</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></td>
    </tr>
    <tr>
        <td><a href="#adr-008">ADR-008</a></td>
        <td>No Azure Portal or Foundry Studio UI Access</td>
        <td><span class="badge badge-blue">Policy</span></td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></td>
    </tr>
    <tr>
        <td><a href="#adr-009">ADR-009</a></td>
        <td>Why AI Landing Zone vs Custom Solution</td>
        <td><span class="badge" style="background:#22c55e;color:white;">Choice</span></td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></td>
    </tr>
</table>

<!-- ADR-001 -->
<details class="adr" id="adr-001" open>
<summary>
    <span class="adr-title">ADR-001: Shared Landing Zone with Bastion/Jumpbox</span>
    <span class="adr-status"><span class="badge badge-gold">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Architecture</div>
</div>

<div class="alert alert-success">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
    </div>
    <div>
        <strong>This is the foundational ADR.</strong> It explains why we need VNets, Bastion, Jumpbox, and self-hosted runners. All other ADRs build on these concepts.
    </div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    </div>
    <div>
        <strong>Policy Driver:</strong> BC Gov requires all Azure services to use private endpoints only. GitHub Actions runners on the public internet cannot reach private endpoints. This creates a fundamental problem: how do we run Terraform if GitHub can't talk to Azure resources?
    </div>
</div>

<h3>The Problem: Why Can't GitHub Just Run Terraform Directly?</h3>

<div class="card" style="border-left-color: #ef4444;">
    <h4 style="margin-top: 0;">The Network Barrier</h4>
    <p>When you run <code>terraform apply</code> from GitHub Actions, here's what happens:</p>
    <ol>
        <li>GitHub spins up a runner (a VM on Microsoft's public cloud)</li>
        <li>Terraform tries to connect to Azure Storage (for state file)</li>
        <li><strong style="color:#ef4444;">BLOCKED</strong> - Storage has no public endpoint</li>
        <li>Terraform tries to connect to Key Vault, databases, etc.</li>
        <li><strong style="color:#ef4444;">BLOCKED</strong> - All services are private-only</li>
    </ol>
    <p style="margin-bottom:0;"><strong>Result:</strong> Terraform cannot run from the public internet because it can't reach any Azure resources.</p>
</div>

<h3>The Solution: Landing Zone Architecture</h3>

<p>We need infrastructure <strong>inside the private network</strong> that can:</p>
<ul>
    <li>Receive commands from GitHub (via OIDC tokens)</li>
    <li>Run Terraform against private endpoints</li>
    <li>Allow humans to access resources for debugging</li>
</ul>

<div class="grid grid-3">
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0;">VNet (Virtual Network)</h4>
        <p><strong>What:</strong> Private network in Azure</p>
        <p><strong>Why:</strong> All resources live here, isolated from public internet</p>
        <p style="margin-bottom:0;"><strong>Analogy:</strong> The building's internal network</p>
    </div>
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0;">Jumpbox VM</h4>
        <p><strong>What:</strong> Linux VM inside the VNet</p>
        <p><strong>Why:</strong> Runs Terraform, can reach all private endpoints</p>
        <p style="margin-bottom:0;"><strong>Analogy:</strong> A workstation inside the secure office</p>
    </div>
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0;">Azure Bastion</h4>
        <p><strong>What:</strong> Managed gateway service</p>
        <p><strong>Why:</strong> Secure way to access Jumpbox (no public SSH)</p>
        <p style="margin-bottom:0;"><strong>Analogy:</strong> The secure lobby with ID verification</p>
    </div>
</div>

<h3>How Terraform Actually Runs</h3>

<div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
<pre style="background: var(--bc-blue-dark); margin: 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DEPLOYMENT FLOW                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   GitHub Actions          â”‚ Azure Landing Zone (Private Network)        â”‚
â”‚   (Public Internet)       â”‚                                              â”‚
â”‚                           â”‚                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Workflow     â”‚        â”‚    â”‚ Self-Hosted  â”‚    â”‚ Private         â”‚  â”‚
â”‚   â”‚ Triggers     â”‚â”€â”€â”€OIDCâ”€â”€â”€â”€â–¶â”‚ Runner       â”‚â”€â”€â”€â–¶â”‚ Endpoints       â”‚  â”‚
â”‚   â”‚              â”‚  Token  â”‚    â”‚ (in VNet)    â”‚    â”‚ (Storage, KV)   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚           â”‚                                  â”‚
â”‚                           â”‚           â–¼                                  â”‚
â”‚                           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                           â”‚    â”‚ terraform    â”‚                         â”‚
â”‚                           â”‚    â”‚ plan/apply   â”‚                         â”‚
â”‚                           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                           â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
</div>

<p><strong>Two deployment options:</strong></p>

<div class="grid grid-2">
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">Option A: Self-Hosted Runners</h4>
        <p>GitHub Actions runners deployed inside the VNet. Workflows run directly on these VMs.</p>
        <ul>
            <li>Runner registers with GitHub</li>
            <li>Workflow triggers, runner picks it up</li>
            <li>Terraform runs inside VNet</li>
            <li>Full access to private endpoints</li>
        </ul>
        <p style="margin-bottom:0;color:#22c55e;"><strong>Recommended for CI/CD</strong></p>
    </div>
    <div class="card" style="border-left-color: #0ea5e9;">
        <h4 style="margin-top: 0;">Option B: Jumpbox + Bastion</h4>
        <p>Manual access via Bastion for debugging, testing, and emergency fixes.</p>
        <ul>
            <li>Human connects via Azure Portal</li>
            <li>Bastion brokers SSH connection</li>
            <li>Land on Jumpbox inside VNet</li>
            <li>Run commands, debug issues</li>
        </ul>
        <p style="margin-bottom:0;color:#0ea5e9;"><strong>Required for human access</strong></p>
    </div>
</div>

<h3>What About Other Repositories?</h3>

<div class="alert alert-success">
    <span class="alert-icon">âœ…</span>
    <div>
        <strong>Good News: Other repos do NOT need their own Bastion/Jumpbox/VNet!</strong><br>
        This is <strong>shared infrastructure</strong> - the Landing Zone is set up once and used by all projects.
    </div>
</div>

<h4>What This Repo Provides (Set Up Once)</h4>
<table>
    <tr>
        <th>Component</th>
        <th>Purpose</th>
        <th>Shared?</th>
    </tr>
    <tr>
        <td>VNet + Subnets</td>
        <td>Private network for all resources</td>
        <td><strong>Yes - all projects use this</strong></td>
    </tr>
    <tr>
        <td>Azure Bastion</td>
        <td>Secure access gateway</td>
        <td><strong>Yes - one Bastion for all</strong></td>
    </tr>
    <tr>
        <td>Jumpbox VM</td>
        <td>Admin access point</td>
        <td><strong>Yes - shared by admins</strong></td>
    </tr>
    <tr>
        <td>Self-Hosted Runners</td>
        <td>CI/CD execution inside VNet</td>
        <td><strong>Yes - shared runner pool</strong></td>
    </tr>
    <tr>
        <td>Private DNS Zones</td>
        <td>Name resolution for private endpoints</td>
        <td><strong>Managed by Platform Services</strong></td>
    </tr>
</table>

<div class="alert alert-info" style="margin-top: 1rem;">
    <span class="alert-icon">&#128274;</span>
    <div>
        <strong>DNS & ExpressRoute Note:</strong> Private DNS zones are managed centrally by Platform Services, not by this Landing Zone. ExpressRoute connectivity exists for on-premises access, but AI Hub clients will connect through <strong>App Gateway + APIM</strong> endpoints rather than directly via ExpressRoute.
    </div>
</div>

<h4>How Access Actually Works (Public vs Private)</h4>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ”‘</span>
    <div>
        <strong>Key Concept:</strong> "No public endpoints" doesn't mean "no access". It means access flows through <strong>controlled private channels</strong>, not the open internet.
    </div>
</div>

<table>
    <tr>
        <th>Who</th>
        <th>Access Path</th>
        <th>Public IPs?</th>
        <th>How It Works</th>
    </tr>
    <tr>
        <td><strong>Platform Team (Admin)</strong></td>
        <td>Internet â†’ Azure Portal â†’ Bastion â†’ VMs</td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Bastion only</span></td>
        <td>Bastion is Azure-managed PaaS with public IP. VMs have private IPs only. This is the ONE public-to-private bridge.</td>
    </tr>
    <tr>
        <td><strong>Ministry Apps/Users</strong></td>
        <td>Gov Network â†’ ExpressRoute â†’ App Gateway â†’ APIM â†’ Services</td>
        <td><span class="badge" style="background:#22c55e;color:white;">None</span></td>
        <td>ExpressRoute is a <strong>private dedicated circuit</strong> from BC Gov data centers to Azure backbone. Traffic never touches public internet.</td>
    </tr>
    <tr>
        <td><strong>GitHub Actions (CI/CD)</strong></td>
        <td>Self-hosted runners inside VNet â†’ Private Endpoints</td>
        <td><span class="badge" style="background:#22c55e;color:white;">None</span></td>
        <td>Runners are VMs inside our VNet. They access Azure resources via private IPs directly.</td>
    </tr>
</table>

<div class="grid grid-2" style="margin-top: 1rem;">
    <div class="card" style="border-left-color: #8b5cf6;">
        <h4 style="margin-top: 0; color: #7c3aed;">What is ExpressRoute?</h4>
        <p>ExpressRoute is <strong>NOT</strong> a public endpoint. It's a dedicated fiber connection from BC Gov's data centers directly into Azure's network backbone.</p>
        <ul style="margin-bottom: 0;">
            <li>Traffic stays on private circuits (not internet)</li>
            <li>Managed by BC Gov Platform Services</li>
            <li>Already exists - we just use it</li>
            <li>Like a private tunnel to Azure</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: #0078d4;">
        <h4 style="margin-top: 0; color: #0078d4;">Why App Gateway + APIM are Internal</h4>
        <p>App Gateway and APIM have <strong>private IPs only</strong>. They're reachable because:</p>
        <ul style="margin-bottom: 0;">
            <li>ExpressRoute connects Gov Network â†’ Azure VNet</li>
            <li>App Gateway listens on internal VNet IP</li>
            <li>Gov users can reach internal IPs via ExpressRoute</li>
            <li>No public internet exposure needed</li>
        </ul>
    </div>
</div>

<div class="card" style="border-left-color: #003366; margin-top: 1rem; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
    <h4 style="margin-top: 0;">Summary: Only ONE Public Endpoint</h4>
    <pre style="background: #1e1e1e; font-size: 11px; margin: 0.5rem 0; padding: 1rem;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           BC Gov Network                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚  â”‚ Ministry     â”‚                                                            â”‚
â”‚  â”‚ Applications â”‚â”€â”€â”                                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                                         â”‚
â”‚                    â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Ministry     â”‚â”€â”€â”¼â”€â”€â”€â”€â”‚         ExpressRoute (Private Circuit)           â”‚â”‚
â”‚  â”‚ Users        â”‚  â”‚    â”‚         NOT public internet!                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Azure (Private VNet)                               â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  App Gateway   â”‚â”€â”€â”€â–¶â”‚     APIM       â”‚â”€â”€â”€â–¶â”‚   Private Endpoints        â”‚ â”‚
â”‚  â”‚  (Internal IP) â”‚    â”‚  (Internal IP) â”‚    â”‚   (Storage, OpenAI, etc.)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â–²                                                                    â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â”‚ All private IPs - reachable via ExpressRoute                      â”‚
â”‚                                                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚    BASTION     â”‚â”€â”€â”€â–¶â”‚   Jumpbox VM   â”‚    â—€â”€â”€ Only Bastion has public IP â”‚
â”‚  â”‚  (PUBLIC IP)   â”‚    â”‚  (Private IP)  â”‚        (for admin access)         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚         â–²                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Admin accesses via Azure Portal (browser)
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    INTERNET      â”‚
â”‚  (Platform Team) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    </pre>
</div>

<h4>What Other Repos Need To Do</h4>
<table>
    <tr>
        <th>Task</th>
        <th>Why</th>
        <th>Effort</th>
    </tr>
    <tr>
        <td>Configure OIDC federation</td>
        <td>Allow their repo to authenticate to Azure</td>
        <td>~30 min setup</td>
    </tr>
    <tr>
        <td>Use shared runner labels</td>
        <td>Target self-hosted runners in VNet</td>
        <td>1 line in workflow</td>
    </tr>
    <tr>
        <td>Deploy into existing VNet</td>
        <td>Resources join the private network</td>
        <td>Reference VNet in Terraform</td>
    </tr>
</table>

<div class="card" style="border-left-color: #22c55e; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
    <h4 style="margin-top: 0; color: #166534;">Example: New Project Onboarding</h4>
    <p>A new AI project wants to deploy a model endpoint. Here's what they do:</p>
    <ol>
        <li><strong>OIDC Setup:</strong> Platform team adds federated credential for <code>repo:bcgov/new-project:*</code></li>
        <li><strong>Workflow:</strong> Use <code>runs-on: [self-hosted, azure-vnet]</code> instead of <code>runs-on: ubuntu-latest</code></li>
        <li><strong>Terraform:</strong> Reference existing VNet: <code>data "azurerm_virtual_network" "hub" { ... }</code></li>
        <li><strong>Deploy:</strong> Resources automatically use private endpoints in the shared network</li>
    </ol>
    <p style="margin-bottom:0;"><strong>Total setup time: ~1 hour</strong> (vs. days to build their own Landing Zone)</p>
</div>

<h3>Why Not Just Open Public Endpoints Temporarily?</h3>

<div class="card" style="border-left-color: #ef4444;">
    <p><strong>Policy prohibits this.</strong> Even temporary public access:</p>
    <ul>
        <li>Creates audit findings</li>
        <li>Requires security exemption paperwork</li>
        <li>Introduces attack window</li>
        <li>Must be reverted manually (often forgotten)</li>
    </ul>
    <p style="margin-bottom:0;">The Landing Zone approach is <strong>always private</strong> - no exemptions needed.</p>
</div>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>Fully policy compliant</strong> - No public endpoints ever</li>
    <li><strong>Shared infrastructure</strong> - One-time setup, many projects benefit</li>
    <li><strong>Consistent security</strong> - All projects inherit the same secure baseline</li>
    <li><strong>Cost efficient</strong> - Single Bastion (~$140/mo) serves all projects</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>Initial complexity</strong> - Landing Zone must be built first</li>
    <li><strong>Runner maintenance</strong> - Self-hosted runners need updates</li>
    <li><strong>VNet planning</strong> - Must allocate IP ranges carefully</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/">Azure Landing Zone Concepts</a></li>
    <li><a href="https://docs.github.com/en/actions/hosting-your-own-runners">GitHub Self-Hosted Runners</a></li>
    <li><a href="diagrams.html#network-arch">Network Architecture Diagram</a></li>
</ul>

</div>
</details>

<!-- ADR-002 -->
<details class="adr" id="adr-002">
<summary>
    <span class="adr-title">ADR-002: Use OIDC instead of Service Principal Secrets</span>
    <span class="adr-status"><span class="badge badge-gold">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Security</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Policy Driver:</strong> BC Gov security policy requires minimizing long-lived credentials and implementing credential rotation. The platform team provides rotating keys, but OIDC eliminates the need for a cron job to fetch and update credentials.
    </div>
</div>

<p>GitHub Actions workflows need to authenticate with Azure to deploy infrastructure via Terraform. We evaluated three options for credential management:</p>

<div class="grid grid-3">
    <div class="card" style="border-left-color: #ef4444;">
        <h4 style="margin-top: 0;">Option A: Static Secrets</h4>
        <ul>
            <li>Create Azure AD App Registration</li>
            <li>Generate Client Secret</li>
            <li>Store in GitHub Secrets</li>
            <li>Rotate manually every 1-2 years</li>
        </ul>
        <p style="margin-bottom:0;color:#ef4444;"><strong>Not policy compliant</strong> - Long-lived credentials prohibited</p>
    </div>
    <div class="card" style="border-left-color: #f59e0b;">
        <h4 style="margin-top: 0;">Option B: Platform Rotating Keys</h4>
        <ul>
            <li>Platform team rotates keys every 2 days</li>
            <li>Keys expire after 4 days</li>
            <li>Requires cron job to fetch/update</li>
            <li>Must sync to GitHub Secrets</li>
        </ul>
        <p style="margin-bottom:0;color:#f59e0b;"><strong>Policy compliant</strong> - But adds operational overhead</p>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">Option C: OIDC Federation</h4>
        <ul>
            <li>Create Managed Identity</li>
            <li>Configure GitHub OIDC trust</li>
            <li>Token fetched in pipeline</li>
            <li>No cron job needed</li>
        </ul>
        <p style="margin-bottom:0;color:#22c55e;"><strong>Policy compliant</strong> - Zero operational overhead</p>
    </div>
</div>

<h3>Decision</h3>

<p><strong>We chose Option C: OIDC Federated Credentials.</strong></p>

<p>While the platform team's rotating key solution (Option B) is policy compliant, it requires maintaining a cron job to continuously fetch and update credentials. OIDC eliminates this operational burden - the bearer token is obtained directly within the GitHub Actions workflow at runtime, with no external synchronization required.</p>

<h3>Rationale</h3>

<table>
    <tr>
        <th>Criteria</th>
        <th>Static Secrets</th>
        <th>Platform Rotating</th>
        <th>OIDC</th>
    </tr>
    <tr>
        <td>Policy Compliant</td>
        <td style="color:#ef4444;">No</td>
        <td>Yes</td>
        <td><strong>Yes</strong></td>
    </tr>
    <tr>
        <td>Secret Management</td>
        <td>Manual rotation</td>
        <td>Cron job required</td>
        <td><strong>No secrets needed</strong></td>
    </tr>
    <tr>
        <td>Security Risk</td>
        <td>Long-lived credential leak</td>
        <td>4-day window if compromised</td>
        <td><strong>~10 min window</strong></td>
    </tr>
    <tr>
        <td>Operational Overhead</td>
        <td>Annual rotation</td>
        <td>Cron job maintenance</td>
        <td><strong>Set and forget</strong></td>
    </tr>
    <tr>
        <td>Token Lifetime</td>
        <td>1-2 years</td>
        <td>4 days max</td>
        <td><strong>~10 minutes</strong></td>
    </tr>
    <tr>
        <td>Failure Mode</td>
        <td>Expired secret breaks deploy</td>
        <td>Cron failure breaks deploy</td>
        <td><strong>Self-contained in pipeline</strong></td>
    </tr>
    <tr>
        <td>Scope Control</td>
        <td>Per application</td>
        <td>Per application</td>
        <td><strong>Per repo/branch/env</strong></td>
    </tr>
</table>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>Zero secrets to rotate</strong> - Eliminates credential management overhead</li>
    <li><strong>Reduced blast radius</strong> - Tokens valid for minutes, not years</li>
    <li><strong>Fine-grained access</strong> - Can restrict to specific branches/environments</li>
    <li><strong>Better audit trail</strong> - Every token exchange is logged with JWT claims</li>
    <li><strong>No secret sprawl</strong> - Secrets don't end up in logs, config files, or developer machines</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>More complex initial setup</strong> - Federated credential configuration is more involved</li>
    <li><strong>Newer technology</strong> - Less documentation and community examples available</li>
    <li><strong>GitHub dependency</strong> - Tightly coupled to GitHub's OIDC provider</li>
</ul>

<h4>Neutral</h4>
<ul>
    <li>Requires understanding of JWT claims and subject matching</li>
    <li>Debugging auth failures requires knowledge of OIDC flow</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect">GitHub OIDC Documentation</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/active-directory/workload-identities/workload-identity-federation">Azure Workload Identity Federation</a></li>
    <li><a href="diagrams.html#token-flow">Token Exchange Flow Diagram</a></li>
</ul>

</div>
</details>

<!-- ADR-003 -->
<details class="adr" id="adr-003">
<summary>
    <span class="adr-title">ADR-003: Use Azure Bastion for VM Access</span>
    <span class="adr-status"><span class="badge badge-gold">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Networking</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Policy Driver:</strong> BC Gov policy prohibits public IP addresses on virtual machines. VMs must only be accessible through private networks. Azure Bastion provides compliant access without exposing VMs to the internet.
    </div>
</div>

<div class="alert alert-info">
    <span class="alert-icon">ğŸŒ‰</span>
    <div>
        <strong>Bastion = The Public-to-Private Bridge</strong><br>
        Azure Bastion is the <strong>one approved exception</strong> to the "no public endpoints" rule. It's an Azure-managed PaaS service with a public IP that provides secure browser-based access to private VMs. The key point: Bastion has the public IP, not the VMs themselves.
    </div>
</div>

<h4>Public Endpoints in the Architecture</h4>
<table>
    <tr>
        <th>Service</th>
        <th>Has Public IP?</th>
        <th>Why</th>
    </tr>
    <tr>
        <td><strong>Azure Bastion</strong></td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Yes (exception)</span></td>
        <td>Required for browser-based VM access. Azure-managed, AAD-authenticated. This is the public-to-private bridge for admin access.</td>
    </tr>
    <tr>
        <td>App Gateway</td>
        <td><span class="badge" style="background:#22c55e;color:white;">No (internal)</span></td>
        <td>Receives traffic from ExpressRoute (on-premises), not public internet. Internal listener only.</td>
    </tr>
    <tr>
        <td>APIM</td>
        <td><span class="badge" style="background:#22c55e;color:white;">No (internal)</span></td>
        <td>Deployed in internal mode, sits behind App Gateway. No public exposure.</td>
    </tr>
    <tr>
        <td>VMs (Jumpbox)</td>
        <td><span class="badge" style="background:#22c55e;color:white;">No</span></td>
        <td>Private IPs only. Access via Bastion.</td>
    </tr>
    <tr>
        <td>Storage, Key Vault, etc.</td>
        <td><span class="badge" style="background:#22c55e;color:white;">No</span></td>
        <td>Private endpoints only. Public access disabled.</td>
    </tr>
</table>

<p>Operators need secure access to jumpbox VMs for debugging and administration. The VMs cannot have public IPs per policy. We evaluated:</p>

<div class="grid grid-3">
    <div class="card">
        <h4 style="margin-top: 0;">Option A: VPN Gateway</h4>
        <p>Point-to-site VPN for developer access</p>
    </div>
    <div class="card">
        <h4 style="margin-top: 0;">Option B: Public IP + NSG</h4>
        <p>Expose SSH/RDP with IP allowlisting</p>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">Option C: Azure Bastion</h4>
        <p>Browser-based RDP/SSH via Azure Portal</p>
    </div>
</div>

<h3>Decision</h3>

<p><strong>We chose Option C: Azure Bastion.</strong></p>

<h3>Rationale</h3>

<table>
    <tr>
        <th>Criteria</th>
        <th>VPN Gateway</th>
        <th>Public IP</th>
        <th>Bastion</th>
    </tr>
    <tr>
        <td>Setup Complexity</td>
        <td>High (certs, clients)</td>
        <td>Low</td>
        <td><strong>Medium</strong></td>
    </tr>
    <tr>
        <td>Client Requirements</td>
        <td>VPN client software</td>
        <td>SSH/RDP client</td>
        <td><strong>Browser only</strong></td>
    </tr>
    <tr>
        <td>Attack Surface</td>
        <td>VPN endpoint</td>
        <td>High (exposed ports)</td>
        <td><strong>Minimal</strong></td>
    </tr>
    <tr>
        <td>Cost</td>
        <td>~$140/month</td>
        <td>~$5/month</td>
        <td><strong>~$140/month (when on)</strong></td>
    </tr>
    <tr>
        <td>On-demand</td>
        <td>No (always on)</td>
        <td>Yes</td>
        <td><strong>Yes (can destroy)</strong></td>
    </tr>
</table>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>No public IPs on VMs</strong> - VMs only have private IPs</li>
    <li><strong>No client software</strong> - Works from any browser</li>
    <li><strong>Azure AD integration</strong> - Uses existing identity</li>
    <li><strong>Session recording</strong> - Can enable for audit</li>
    <li><strong>Cost control</strong> - Can deploy/destroy on demand via workflow</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>Azure Portal dependency</strong> - Must use Azure UI or CLI</li>
    <li><strong>File transfer limitations</strong> - No native SCP/SFTP</li>
    <li><strong>Latency</strong> - Browser-based adds some lag</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="https://learn.microsoft.com/en-us/azure/bastion/bastion-overview">Azure Bastion Documentation</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/bastion/bastion-connect-vm-ssh-linux">Connect to Linux VM via Bastion</a></li>
    <li><a href="diagrams.html#network-environments">Network Environments Diagram</a></li>
</ul>

</div>
</details>

<!-- ADR-004 -->
<details class="adr" id="adr-004">
<summary>
    <span class="adr-title">ADR-004: Private Endpoints for All Azure Services</span>
    <span class="adr-status"><span class="badge badge-gold">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Networking</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Policy Driver:</strong> BC Gov security policy mandates that all Azure PaaS services must be accessed via Private Endpoints only. Public endpoints must be disabled. This ensures all traffic stays within the Azure backbone and private networks.
    </div>
</div>

<p>Azure PaaS services (Storage Accounts, Key Vaults, Databases, etc.) by default have public endpoints accessible from the internet. BC Gov policy requires these to be locked down.</p>

<h3>Policy Requirements</h3>

<div class="card" style="border-left-color: #ef4444;">
    <h4 style="margin-top: 0;">What Policy Prohibits</h4>
    <ul style="margin-bottom: 0;">
        <li>Public endpoints on any Azure service</li>
        <li>Storage accounts accessible from internet</li>
        <li>Key Vaults with public network access</li>
        <li>Databases with public connectivity</li>
        <li>Any service reachable without VNet integration</li>
    </ul>
</div>

<div class="card" style="border-left-color: #22c55e;">
    <h4 style="margin-top: 0;">What Policy Requires</h4>
    <ul style="margin-bottom: 0;">
        <li>Private Endpoints for all PaaS services</li>
        <li>Private DNS zones for name resolution <em>(managed by Platform Services)</em></li>
        <li>VNet integration for all access</li>
        <li>Network Security Groups controlling traffic</li>
        <li>"Deny public access" enabled on all services</li>
    </ul>
</div>

<h3>Implementation</h3>

<div class="alert alert-info" style="margin-bottom: 1rem;">
    <span class="alert-icon">&#128274;</span>
    <div>
        <strong>DNS Management:</strong> All private DNS zones are managed centrally by Platform Services. The AI Hub team does not manage DNS - we only create private endpoints that link to the existing DNS zones.
    </div>
</div>

<table>
    <tr>
        <th>Service</th>
        <th>Private Endpoint</th>
        <th>DNS Zone (Platform Services)</th>
    </tr>
    <tr>
        <td>Storage Account (Terraform State)</td>
        <td><code>privateEndpoint-blob</code></td>
        <td><code>privatelink.blob.core.windows.net</code></td>
    </tr>
    <tr>
        <td>Key Vault (if used)</td>
        <td><code>privateEndpoint-vault</code></td>
        <td><code>privatelink.vaultcore.azure.net</code></td>
    </tr>
    <tr>
        <td>Container Registry (if used)</td>
        <td><code>privateEndpoint-acr</code></td>
        <td><code>privatelink.azurecr.io</code></td>
    </tr>
</table>

<h3>Client Connectivity Model</h3>

<div class="card" style="border-left-color: var(--bc-gold);">
    <h4 style="margin-top: 0;">ExpressRoute + App Gateway + APIM</h4>
    <p>BC Gov has ExpressRoute connectivity to Azure, but AI Hub clients will <strong>not</strong> access services directly via ExpressRoute. Instead:</p>
    <ul>
        <li><strong>App Gateway:</strong> Provides ingress, WAF protection, and SSL termination</li>
        <li><strong>APIM:</strong> API management layer for authentication, rate limiting, and routing</li>
        <li><strong>Private Endpoints:</strong> Backend services (AI models, storage) remain fully private</li>
    </ul>
    <p style="margin-bottom: 0;"><strong>Client flow:</strong> Client â†’ App Gateway â†’ APIM â†’ Private Endpoint â†’ Azure Service</p>
</div>

<h3>Consequences</h3>

<h4>Challenges</h4>
<ul>
    <li><strong>GitHub Actions cannot reach private endpoints directly</strong> - Requires self-hosted runners inside the VNet (see <a href="#adr-001">ADR-001</a>)</li>
    <li><strong>Local development complexity</strong> - Developers cannot access resources without VPN/Bastion</li>
    <li><strong>DNS resolution</strong> - Must configure private DNS zones correctly</li>
    <li><strong>Debugging difficulty</strong> - Cannot easily test from outside the network</li>
</ul>

<h4>Workarounds</h4>
<ul>
    <li><strong>Terraform State:</strong> Use self-hosted runners inside the VNet which can access the private storage endpoint directly. The <code>use_azuread_auth = true</code> setting enables Azure AD authentication for state access.</li>
    <li><strong>Development:</strong> Use Bastion + Jumpbox for all Azure resource access (see <a href="#adr-003">ADR-003</a>)</li>
    <li><strong>CI/CD:</strong> Use self-hosted runners in the VNet for full private access (see <a href="#adr-001">ADR-001</a>)</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview">Azure Private Endpoint Documentation</a></li>
    <li><a href="diagrams.html#network-arch">Network Architecture Diagram</a></li>
</ul>

</div>
</details>

<!-- ADR-005 -->
<details class="adr" id="adr-005">
<summary>
    <span class="adr-title">ADR-005: Zero-Dependency Documentation System</span>
    <span class="adr-status"><span class="badge badge-gold">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-12</div>
    <div><strong>Driver:</strong> <span class="badge" style="background:#22c55e;color:white;">Choice</span></div>
    <div><strong>Category:</strong> Documentation</div>
</div>

<h3>Context</h3>

<p>We needed a documentation site for the project. Options considered:</p>

<div class="grid grid-2">
    <div class="card">
        <h4 style="margin-top: 0;">Static Site Generators</h4>
        <ul>
            <li>Jekyll (Ruby)</li>
            <li>Hugo (Go)</li>
            <li>Docusaurus (Node.js)</li>
            <li>MkDocs (Python)</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">Custom Bash Build</h4>
        <ul>
            <li>Header/footer partials</li>
            <li>Variable substitution</li>
            <li>~60 lines of shell script</li>
            <li>Zero external dependencies</li>
        </ul>
    </div>
</div>

<h3>Decision</h3>

<p><strong>We built a custom Bash-based static site generator.</strong></p>

<h3>Rationale</h3>

<ul>
    <li><strong>Portability:</strong> Runs anywhere with Bash (Linux, Mac, WSL, CI)</li>
    <li><strong>No dependency management:</strong> No npm, gem, pip, go install required</li>
    <li><strong>Simplicity:</strong> Anyone can understand the 60-line build script</li>
    <li><strong>Speed:</strong> Builds in milliseconds</li>
    <li><strong>GitHub Pages native:</strong> No special plugins or build configurations</li>
    <li><strong>AI-friendly:</strong> HTML generation is trivial for AI assistants</li>
</ul>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li>Zero build dependencies to maintain or update</li>
    <li>Works in any environment without setup</li>
    <li>Easy to understand and modify</li>
    <li>No security vulnerabilities from npm packages</li>
</ul>

<h4>Negative</h4>
<ul>
    <li>No built-in Markdown support (write HTML directly)</li>
    <li>No automatic table of contents generation</li>
    <li>No built-in search (added custom client-side solution)</li>
</ul>

<h4>Mitigations</h4>
<ul>
    <li>Created template page with all components for easy copy-paste</li>
    <li>AI assistants generate HTML as easily as Markdown</li>
    <li>Added custom SVG viewer for diagrams</li>
</ul>

</div>
</details>

<!-- ADR-006 -->
<details class="adr pending" id="adr-006">
<summary>
    <span class="adr-title">ADR-006: Multi-Tenant Isolation Model</span>
    <span class="adr-status"><span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></span>
</summary>
<div class="adr-content">

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> <span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></div>
    <div><strong>Date:</strong> 2025-12</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Architecture</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Policy Driver:</strong> BC Gov requires strict data isolation between ministries. Each ministry's data must be logically separated, with access controls preventing cross-ministry data exposure. The AI Hub serves multiple ministries (Health, SDPR, Justice, etc.) from shared infrastructure.
    </div>
</div>

<p>The AI Hub Landing Zone is designed to serve multiple BC Government ministries from a single shared infrastructure deployment. This creates a multi-tenancy challenge: how do we provide cost-efficient shared services while ensuring strict data isolation between ministries?</p>

<h3>The Problem: Shared Infrastructure, Isolated Data</h3>

<div class="grid grid-2">
    <div class="card" style="border-left-color: #ef4444;">
        <h4 style="margin-top: 0;">What We Cannot Do</h4>
        <ul style="margin-bottom: 0;">
            <li>Allow Ministry A to access Ministry B's documents</li>
            <li>Share AI search indexes across ministries</li>
            <li>Use single storage accounts for all ministry data</li>
            <li>Allow cross-ministry API access without authorization</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">What We Can Share</h4>
        <ul style="margin-bottom: 0;">
            <li>Network infrastructure (VNets, Bastion, NSGs)</li>
            <li>Compute resources (AI Foundry, AKS clusters)</li>
            <li>Ingress layer (App Gateway, APIM)</li>
            <li>Monitoring and logging infrastructure</li>
        </ul>
    </div>
</div>

<h3>Decision</h3>

<p><strong>We implement a four-layer isolation model:</strong></p>

<div class="grid grid-2">
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0;">1. Storage Isolation</h4>
        <p><strong>Separate storage accounts per ministry</strong></p>
        <ul style="margin-bottom: 0;">
            <li>Each ministry gets dedicated blob containers</li>
            <li>Azure RBAC restricts access to ministry principals</li>
            <li>Private endpoints per storage account</li>
            <li>Encryption keys can be ministry-specific (CMK)</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0;">2. AI Search Index Isolation</h4>
        <p><strong>Separate search indexes per ministry</strong></p>
        <ul style="margin-bottom: 0;">
            <li>Each ministry's documents indexed separately</li>
            <li>RAG queries scoped to ministry index only</li>
            <li>No cross-index queries permitted</li>
            <li>Index-level access control via Azure RBAC</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: var(--bc-blue);">
        <h4 style="margin-top: 0;">3. API Isolation (APIM)</h4>
        <p><strong>APIM subscriptions per ministry</strong></p>
        <ul style="margin-bottom: 0;">
            <li>Unique subscription keys per ministry</li>
            <li>Rate limiting scoped to subscription</li>
            <li>API policies enforce ministry context</li>
            <li>Audit logging includes ministry identifier</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: var(--bc-blue);">
        <h4 style="margin-top: 0;">4. Network Isolation (NSGs)</h4>
        <p><strong>Network policies enforce boundaries</strong></p>
        <ul style="margin-bottom: 0;">
            <li>NSG rules restrict subnet-to-subnet traffic</li>
            <li>Private endpoints isolated by ministry where needed</li>
            <li>No direct cross-ministry network paths</li>
            <li>All traffic routed through controlled ingress</li>
        </ul>
    </div>
</div>

<h3>Implementation Architecture</h3>

<div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
<pre style="background: var(--bc-blue-dark); margin: 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MULTI-TENANT ISOLATION MODEL                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Ministry Health        Ministry SDPR         Ministry Justice             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚ APIM Sub: H â”‚       â”‚ APIM Sub: S â”‚       â”‚ APIM Sub: J â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚          â”‚                     â”‚                     â”‚                      â”‚
â”‚          â–¼                     â–¼                     â–¼                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚              Shared APIM (Policy Enforcement)                â”‚          â”‚
â”‚   â”‚         (validates subscription â†’ routes to ministry)        â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚          â”‚                     â”‚                     â”‚                      â”‚
â”‚          â–¼                     â–¼                     â–¼                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚ Storage: H  â”‚       â”‚ Storage: S  â”‚       â”‚ Storage: J  â”‚              â”‚
â”‚   â”‚ Index: H    â”‚       â”‚ Index: S    â”‚       â”‚ Index: J    â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                              â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â”‚
â”‚                    Shared Infrastructure Layer                               â”‚
â”‚        (VNet, Bastion, AI Foundry Compute, Monitoring)                      â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
</div>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>Strong data isolation</strong> - Ministry data never co-mingled</li>
    <li><strong>Cost efficiency</strong> - Shared compute and network infrastructure</li>
    <li><strong>Audit compliance</strong> - Clear ministry attribution in all logs</li>
    <li><strong>Scalable onboarding</strong> - New ministries get isolated resources automatically</li>
    <li><strong>Flexible isolation levels</strong> - Can increase isolation (dedicated compute) if needed</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>Resource multiplication</strong> - Each ministry needs separate storage/indexes</li>
    <li><strong>Complexity</strong> - More resources to manage and monitor</li>
    <li><strong>Cost per ministry</strong> - Base cost increases with each ministry onboarded</li>
</ul>

<h3>Cost Tracking</h3>

<p>Multi-tenant isolation also enables per-tenant cost tracking and chargeback. See the detailed cost allocation strategy:</p>

<div class="img-container">
    <a href="cost.html">
        <img src="assets/cost-tracking-architecture.svg" alt="Multi-Tenant Cost Tracking Architecture" style="max-width: 100%; cursor: pointer;">
    </a>
    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">Click diagram to view full Cost Tracking documentation</p>
</div>

<h3>References</h3>
<ul>
    <li><a href="cost.html">Cost Tracking Documentation</a> - Full cost allocation strategy</li>
    <li><a href="diagrams.html#multi-tenant">Multi-Tenant Isolation Diagram</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/architecture/guide/multitenant/overview">Azure Multi-Tenant Architecture Guide</a></li>
    <li><a href="diagrams.html#data-flow">AI Request Data Flow Diagram</a></li>
</ul>

</div>
</details>

<!-- ADR-007 -->
<details class="adr pending" id="adr-007">
<summary>
    <span class="adr-title">ADR-007: Client Connectivity via App Gateway + APIM</span>
    <span class="adr-status"><span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></span>
</summary>
<div class="adr-content">

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> <span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></div>
    <div><strong>Date:</strong> 2025-12</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Networking</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Platform Context:</strong> BC Gov Platform Services provides ExpressRoute connectivity to Azure for private, high-bandwidth access. ExpressRoute is <strong>available</strong>, not denied. However, for this multi-tenant AI Hub platform, we <strong>recommend</strong> all clients connect through App Gateway + APIM to ensure consistent security controls across all tenants.
    </div>
</div>

<p>BC Government Platform Services has established ExpressRoute connectivity between on-premises networks and Azure. For this AI Hub Landing Zone, the question arose: should ministry applications connect directly to AI services via ExpressRoute, or through a managed ingress layer?</p>

<h3>Options Considered</h3>

<div class="grid grid-2">
    <div class="card" style="border-left-color: #f59e0b;">
        <h4 style="margin-top: 0;">Option A: Direct ExpressRoute Access</h4>
        <p>Clients connect directly to private endpoints via ExpressRoute.</p>
        <ul>
            <li>Lowest latency (no middlemen)</li>
            <li>Simpler architecture for single-tenant</li>
            <li>ExpressRoute is provided by Platform Services</li>
        </ul>
        <p style="color:#f59e0b;margin-bottom:0;"><strong>Case-by-Case:</strong> Available upon request with justification. Requires separate security review as it bypasses WAF, rate limiting, and centralized audit logging.</p>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">Option B: App Gateway + APIM (Recommended)</h4>
        <p>All traffic flows through App Gateway and APIM before reaching backends.</p>
        <ul>
            <li>WAF protection at ingress</li>
            <li>Centralized authentication</li>
            <li>Rate limiting and quotas per tenant</li>
            <li>Complete audit trail</li>
            <li>Consistent multi-tenant isolation</li>
        </ul>
        <p style="color:#22c55e;margin-bottom:0;"><strong>Recommended:</strong> Standard path for all AI Hub clients</p>
    </div>
</div>

<h3>Decision</h3>

<p><strong>For a clear multi-tenant platform, we recommend all clients connect through App Gateway â†’ APIM â†’ Private Endpoints.</strong></p>

<p>ExpressRoute connectivity is provided by Platform Services and is available. However, to support consistent security controls, audit logging, and fair resource allocation across multiple ministries, we recommend the App Gateway + APIM path as the standard connectivity model.</p>

<div class="alert alert-info">
    <span class="alert-icon">ğŸ’¡</span>
    <div>
        <strong>Direct ExpressRoute Access:</strong> If a client has a specific requirement for direct ExpressRoute access to backend services (e.g., extremely latency-sensitive workloads), this can be analyzed on a case-by-case basis. Such requests require justification and a separate security review.
    </div>
</div>

<h3>Traffic Flow</h3>

<div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
<pre style="background: var(--bc-blue-dark); margin: 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT CONNECTIVITY MODEL                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   On-Premises                    â”‚         Azure Landing Zone               â”‚
â”‚   (Ministry Apps)                â”‚                                          â”‚
â”‚                                  â”‚                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Ministry App â”‚              â”‚    â”‚         App Gateway              â”‚   â”‚
â”‚   â”‚ (Health)     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â€¢ SSL Termination              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Express    â”‚    â”‚  â€¢ WAF Protection               â”‚   â”‚
â”‚                      Route      â”‚    â”‚  â€¢ DDoS Mitigation              â”‚   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”‚ Ministry App â”‚              â”‚                   â”‚                       â”‚
â”‚   â”‚ (SDPR)       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶               â–¼                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                 â”‚    â”‚            APIM                  â”‚   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚    â”‚  â€¢ Authentication (API Keys)    â”‚   â”‚
â”‚   â”‚ Ministry App â”‚              â”‚    â”‚  â€¢ Rate Limiting                â”‚   â”‚
â”‚   â”‚ (Justice)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â€¢ Request Validation           â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚    â”‚  â€¢ Ministry Routing             â”‚   â”‚
â”‚                                 â”‚    â”‚  â€¢ Audit Logging                â”‚   â”‚
â”‚                                 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                   â”‚                       â”‚
â”‚                                 â”‚                   â–¼                       â”‚
â”‚                                 â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                 â”‚    â”‚      Private Endpoints          â”‚   â”‚
â”‚                                 â”‚    â”‚  â€¢ AI Foundry                   â”‚   â”‚
â”‚                                 â”‚    â”‚  â€¢ Azure OpenAI                 â”‚   â”‚
â”‚                                 â”‚    â”‚  â€¢ AI Search                    â”‚   â”‚
â”‚                                 â”‚    â”‚  â€¢ Storage (RAG docs)           â”‚   â”‚
â”‚                                 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
</div>

<h3>Security Controls at Each Layer</h3>

<table>
    <tr>
        <th>Layer</th>
        <th>Security Control</th>
        <th>Purpose</th>
    </tr>
    <tr>
        <td><strong>App Gateway</strong></td>
        <td>Web Application Firewall (WAF)</td>
        <td>Block OWASP top 10, SQL injection, XSS</td>
    </tr>
    <tr>
        <td><strong>App Gateway</strong></td>
        <td>SSL/TLS Termination</td>
        <td>Enforce HTTPS, manage certificates</td>
    </tr>
    <tr>
        <td><strong>App Gateway</strong></td>
        <td>DDoS Protection</td>
        <td>Mitigate volumetric attacks</td>
    </tr>
    <tr>
        <td><strong>APIM</strong></td>
        <td>Subscription Keys</td>
        <td>Identify and authenticate ministry</td>
    </tr>
    <tr>
        <td><strong>APIM</strong></td>
        <td>Rate Limiting</td>
        <td>Prevent abuse, ensure fair usage</td>
    </tr>
    <tr>
        <td><strong>APIM</strong></td>
        <td>Request Validation</td>
        <td>Validate payload structure</td>
    </tr>
    <tr>
        <td><strong>APIM</strong></td>
        <td>Audit Logging</td>
        <td>Track all requests with ministry context</td>
    </tr>
    <tr>
        <td><strong>Private Endpoints</strong></td>
        <td>Network Isolation</td>
        <td>Backend services unreachable from internet</td>
    </tr>
</table>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>Defense in depth</strong> - Multiple security layers before reaching backends</li>
    <li><strong>Centralized policy</strong> - All clients subject to same rules</li>
    <li><strong>Audit compliance</strong> - Every request logged with full context</li>
    <li><strong>Flexibility</strong> - Can update policies without changing backends</li>
    <li><strong>Cost attribution</strong> - Can track usage per ministry via APIM metrics</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>Added latency</strong> - Two extra hops (App Gateway + APIM)</li>
    <li><strong>Cost</strong> - App Gateway and APIM have significant monthly costs</li>
    <li><strong>Complexity</strong> - More components to configure and maintain</li>
</ul>

<h4>Mitigations</h4>
<ul>
    <li>Latency is typically &lt;10ms additional per hop</li>
    <li>Costs are shared across all ministries (per <a href="#adr-006">ADR-006</a>)</li>
    <li>Infrastructure-as-code manages complexity</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="diagrams.html#data-flow">AI Request Data Flow Diagram</a></li>
    <li><a href="diagrams.html#full-stack">Full Stack Architecture Diagram</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/api-management/api-management-key-concepts">Azure API Management Overview</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/application-gateway/overview">Azure Application Gateway Overview</a></li>
</ul>

</div>
</details>

<!-- ADR-008 -->
<details class="adr pending" id="adr-008">
<summary>
    <span class="adr-title">ADR-008: No Azure Portal or Foundry Studio UI Access</span>
    <span class="adr-status"><span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></span>
</summary>
<div class="adr-content">

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> <span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></div>
    <div><strong>Date:</strong> 2025-12</div>
    <div><strong>Driver:</strong> <span class="badge badge-blue">Policy Required</span></div>
    <div><strong>Category:</strong> Operations</div>
</div>

<h3>Context</h3>

<div class="alert alert-warning">
    <span class="alert-icon">ğŸ›ï¸</span>
    <div>
        <strong>Policy Driver:</strong> BC Gov requires all Azure services to use private endpoints only, with no public network access. Azure Portal, AI Foundry Studio, and other browser-based management tools require public endpoints to function. This creates a fundamental incompatibility.
    </div>
</div>

<p>Microsoft's standard approach to AI Landing Zones assumes users will manage resources through:</p>
<ul>
    <li>Azure Portal (portal.azure.com)</li>
    <li>AI Foundry Studio (ai.azure.com)</li>
    <li>Azure Machine Learning Studio</li>
</ul>

<p>All of these require public endpoint access to the Azure services being managed.</p>

<h3>The Problem: UI Requires Public Endpoints</h3>

<div class="card" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-left-color: #ef4444;">
<pre style="background: #1e1e1e; margin: 0; font-size: 12px;">
User Browser (Public Internet)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ai.azure.com / portal.azure.com (Public Endpoint)              â”‚
â”‚                                                                  â”‚
â”‚  "To manage your AI Foundry project, we need to reach           â”‚
â”‚   your Azure resources over the public internet"                â”‚
â”‚                                                                  â”‚
â”‚        â”‚                                                        â”‚
â”‚        â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Your AI Foundry / Storage / Search             â”‚           â”‚
â”‚  â”‚                                                  â”‚           â”‚
â”‚  â”‚  âŒ PUBLIC ENDPOINT REQUIRED                    â”‚           â”‚
â”‚  â”‚     BC Gov Policy: DENIED                       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
</div>

<h3>Decision</h3>

<p><strong>No browser-based UI access is supported for tenant management.</strong></p>

<p>All resource provisioning and management must occur through:</p>
<ul>
    <li><strong>Terraform/AVM modules</strong> - Infrastructure as Code</li>
    <li><strong>Azure CLI</strong> - Via self-hosted runners or Jumpbox (admin only)</li>
    <li><strong>REST APIs</strong> - Via APIM with subscription keys</li>
</ul>

<h3>What This Means for Tenants</h3>

<div class="alert alert-info" style="margin-bottom: 1rem;">
    <span class="alert-icon">ğŸ‘ï¸</span>
    <div>
        <strong>Important Clarification:</strong> Tenants <strong>CAN</strong> navigate to Azure Portal and AI Foundry Studio. They can <strong>see</strong> their resources, browse the UI, and view configurations. However, <strong>operations that require the UI to communicate with Azure services will fail</strong> because those services have no public endpoints. The UI is read-only at best, non-functional at worst.
    </div>
</div>

<div class="grid grid-3">
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0; color: #22c55e;">Can Do (View Only)</h4>
        <ul style="margin-bottom: 0;">
            <li>Browse to portal.azure.com</li>
            <li>See resource groups and resources</li>
            <li>View configurations (read-only)</li>
            <li>Navigate AI Foundry Studio UI</li>
            <li>See project structure</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: #ef4444;">
        <h4 style="margin-top: 0; color: #ef4444;">Cannot Do (UI Blocked)</h4>
        <ul style="margin-bottom: 0;">
            <li>Create/modify resources via Portal</li>
            <li>Upload documents in Foundry Studio</li>
            <li>Test models in Foundry playground</li>
            <li>Configure settings via web forms</li>
            <li>Any operation requiring service connection</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: var(--bc-gold);">
        <h4 style="margin-top: 0; color: var(--bc-gold);">Supported Methods</h4>
        <ul style="margin-bottom: 0;">
            <li>Request resources via Terraform PR</li>
            <li>Upload documents via API (APIM)</li>
            <li>Query AI models via API (APIM)</li>
            <li>Automate via CLI in pipelines</li>
            <li>Use SDK from within VNet</li>
        </ul>
    </div>
</div>

<div class="card" style="border-left-color: #f59e0b; margin-top: 1rem;">
    <h4 style="margin-top: 0;">Why Does This Happen?</h4>
    <p>When you click "Upload Document" in Foundry Studio, the browser (on public internet) tries to connect directly to your Storage Account. But your Storage Account has <strong>no public endpoint</strong> - it only accepts connections from within the VNet via Private Endpoint.</p>
    <pre style="background: #1e1e1e; font-size: 11px; margin: 0.5rem 0;">
Browser (Public) â†’ Storage Account (Private Only) = âŒ Connection Refused
Pipeline (VNet)  â†’ Storage Account (Private EP)   = âœ… Works
    </pre>
    <p style="margin-bottom: 0;">The UI shows the resource exists, but can't actually interact with it.</p>
</div>

<h3>Why Not Provide Bastion Access to Everyone?</h3>

<div class="card" style="border-left-color: #f59e0b;">
    <h4 style="margin-top: 0;">This was considered and rejected:</h4>
    <table>
        <tr>
            <th>Approach</th>
            <th>Problem</th>
        </tr>
        <tr>
            <td>Bastion + VM per tenant</td>
            <td>Not scalable (20 ministries = 20 VMs = $$$), security nightmare</td>
        </tr>
        <tr>
            <td>Shared Jumpbox for all</td>
            <td>Multi-tenant isolation violated, credential management chaos</td>
        </tr>
        <tr>
            <td>VPN per tenant</td>
            <td>Massive operational overhead, not self-service</td>
        </tr>
    </table>
    <p style="margin-bottom: 0;"><strong>Result:</strong> Bastion/Jumpbox is for platform team administration only. Tenants interact via API.</p>
</div>

<h3>AVM Module Requirement</h3>

<p>Because all management must be IaC-based, <strong>only services with Azure Verified Modules (AVM) are supported</strong>.</p>

<div class="card" style="border-left-color: var(--bc-blue);">
    <h4 style="margin-top: 0;">Supported AVM Modules</h4>
    <div class="grid grid-3" style="font-size: 0.85rem;">
        <div>
            <strong>AI Services:</strong>
            <ul style="margin: 0.25rem 0;">
                <li>cognitiveservices-account</li>
                <li>machinelearningservices-workspace</li>
                <li>search-searchservice</li>
            </ul>
        </div>
        <div>
            <strong>Data:</strong>
            <ul style="margin: 0.25rem 0;">
                <li>storage-storageaccount</li>
                <li>documentdb-databaseaccount</li>
                <li>keyvault-vault</li>
            </ul>
        </div>
        <div>
            <strong>Compute:</strong>
            <ul style="margin: 0.25rem 0;">
                <li>containerservice-managedcluster</li>
                <li>containerregistry-registry</li>
                <li>apimanagement-service</li>
            </ul>
        </div>
    </div>
    <p style="margin-bottom: 0; margin-top: 0.5rem;"><strong>Full catalog:</strong> <a href="https://azure.github.io/Azure-Verified-Modules/indexes/terraform/">azure.github.io/Azure-Verified-Modules</a></p>
</div>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>Policy compliant</strong> - No public endpoints ever exposed</li>
    <li><strong>Reproducible</strong> - All infrastructure is code, auditable, version controlled</li>
    <li><strong>Scalable</strong> - Onboard 100 tenants with same process as 1</li>
    <li><strong>Secure</strong> - No browser-based attack surface</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>Steeper learning curve</strong> - Tenants must use IaC, not click-ops</li>
    <li><strong>No visual management</strong> - Can't "see" resources in Portal</li>
    <li><strong>Debugging harder</strong> - Must use CLI/API, not browser dev tools</li>
    <li><strong>Microsoft disconnect</strong> - Their guidance assumes UI access</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="diagrams.html#ms-vs-bcgov">Microsoft vs BC Gov Comparison Diagram</a></li>
    <li><a href="diagrams.html#whats-included">What's Included / Not Included Infographic</a></li>
    <li><a href="https://azure.github.io/Azure-Verified-Modules/">Azure Verified Modules Catalog</a></li>
</ul>

</div>
</details>

<!-- ADR-009 -->
<details class="adr pending" id="adr-009">
<summary>
    <span class="adr-title">ADR-009: Why AI Landing Zone vs Custom Solution</span>
    <span class="adr-status"><span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></span>
</summary>
<div class="adr-content">

<div class="grid grid-4" style="margin-bottom: 1rem;">
    <div><strong>Status:</strong> <span class="badge" style="background:#f59e0b;color:white;">Pending Platform/MS</span></div>
    <div><strong>Date:</strong> 2025-12</div>
    <div><strong>Driver:</strong> <span class="badge" style="background:#22c55e;color:white;">Choice</span></div>
    <div><strong>Category:</strong> Architecture</div>
</div>

<h3>Context</h3>

<p>A valid question arises: <strong>If we're customizing everything for BC Gov requirements anyway, why use Microsoft's AI Landing Zone at all? Why not just build our own custom solution from scratch?</strong></p>

<p>This ADR explains what value the AI Landing Zone and Azure Verified Modules (AVM) actually provide, even when we can't use Microsoft's default assumptions.</p>

<h3>What AI Landing Zone Actually Provides</h3>

<div class="alert alert-info">
    <span class="alert-icon">ğŸ’¡</span>
    <div>
        <strong>Key Insight:</strong> We're not using Microsoft's AI Landing Zone as a turnkey solution. We're using it as a <strong>reference architecture</strong> and leveraging the <strong>Azure Verified Modules (AVM)</strong> it's built on. The value is in the tested, maintained, modular components - not the out-of-box configuration.
    </div>
</div>

<h3>The Real Value: AVM Modules</h3>

<div class="grid grid-2">
    <div class="card" style="border-left-color: #ef4444;">
        <h4 style="margin-top: 0; color: #ef4444;">Building From Scratch</h4>
        <p>If we wrote our own Terraform modules:</p>
        <ul style="margin-bottom: 0;">
            <li>Write 1000+ lines of Terraform per service</li>
            <li>Handle every Azure API change ourselves</li>
            <li>Debug edge cases Microsoft already solved</li>
            <li>Maintain security patches ourselves</li>
            <li>No community validation or review</li>
            <li>Reinvent private endpoint patterns</li>
            <li>Figure out RBAC configurations</li>
            <li>Test against every Azure region</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0; color: #22c55e;">Using AVM Modules</h4>
        <p>With Azure Verified Modules:</p>
        <ul style="margin-bottom: 0;">
            <li>~50 lines of Terraform to deploy a service</li>
            <li>Microsoft maintains API compatibility</li>
            <li>Edge cases handled by module maintainers</li>
            <li>Security updates pushed automatically</li>
            <li>Community tested, Microsoft validated</li>
            <li>Private endpoint patterns built-in</li>
            <li>RBAC best practices included</li>
            <li>Tested across all Azure regions</li>
        </ul>
    </div>
</div>

<h3>What We Get From AI Landing Zone Reference</h3>

<table>
    <tr>
        <th>Component</th>
        <th>What Microsoft Provides</th>
        <th>What We Customize</th>
    </tr>
    <tr>
        <td><strong>Network Topology</strong></td>
        <td>Hub-spoke pattern, subnet sizing guidance, NSG rule templates</td>
        <td>IP ranges, Canada regions, Platform Services DNS integration</td>
    </tr>
    <tr>
        <td><strong>AI Foundry Setup</strong></td>
        <td>AVM module for workspace, project structure, compute patterns</td>
        <td>Disable public access, multi-tenant project isolation</td>
    </tr>
    <tr>
        <td><strong>Private Endpoints</strong></td>
        <td>Patterns for connecting services privately, DNS zone integration</td>
        <td>Link to Platform Services DNS, IP allocation per tenant</td>
    </tr>
    <tr>
        <td><strong>APIM Integration</strong></td>
        <td>AVM module, backend pool patterns, policy templates</td>
        <td>Subscription per tenant, OpenAPI routing, rate limits</td>
    </tr>
    <tr>
        <td><strong>Security Baseline</strong></td>
        <td>RBAC templates, managed identity patterns, Key Vault integration</td>
        <td>BC Gov RBAC requirements, ministry-level isolation</td>
    </tr>
</table>

<h3>AVM Module Maturity - Honest Assessment</h3>

<div class="alert alert-warning">
    <span class="alert-icon">âš ï¸</span>
    <div>
        <strong>Important:</strong> Not all AVM modules are equally mature. AI Foundry modules are newer and still evolving. We must be realistic about what's production-ready vs what's in development.
    </div>
</div>

<table>
    <tr>
        <th>Module</th>
        <th>Status</th>
        <th>Maturity</th>
        <th>Notes</th>
    </tr>
    <tr>
        <td><code>avm-res-storage-storageaccount</code></td>
        <td><span class="badge" style="background:#22c55e;color:white;">Released</span></td>
        <td>Production Ready</td>
        <td>Mature, well-tested</td>
    </tr>
    <tr>
        <td><code>avm-res-keyvault-vault</code></td>
        <td><span class="badge" style="background:#22c55e;color:white;">Released</span></td>
        <td>Production Ready</td>
        <td>Mature, well-tested</td>
    </tr>
    <tr>
        <td><code>avm-res-network-virtualnetwork</code></td>
        <td><span class="badge" style="background:#22c55e;color:white;">Released</span></td>
        <td>Production Ready</td>
        <td>Mature, well-tested</td>
    </tr>
    <tr>
        <td><code>avm-res-network-applicationgateway</code></td>
        <td><span class="badge" style="background:#22c55e;color:white;">Released</span></td>
        <td>Production Ready</td>
        <td>Mature, well-tested</td>
    </tr>
    <tr>
        <td><code>avm-res-network-bastionhost</code></td>
        <td><span class="badge" style="background:#22c55e;color:white;">Released</span></td>
        <td>Production Ready</td>
        <td>Mature, well-tested</td>
    </tr>
    <tr>
        <td><code>avm-res-documentdb-databaseaccount</code></td>
        <td><span class="badge" style="background:#22c55e;color:white;">Released</span></td>
        <td>Production Ready</td>
        <td>Cosmos DB - mature</td>
    </tr>
    <tr>
        <td><code>avm-res-apimanagement-service</code></td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Pending</span></td>
        <td>Early Release</td>
        <td>v0.0.5 - may need custom work</td>
    </tr>
    <tr>
        <td><code>avm-res-cognitiveservices-account</code></td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Pending</span></td>
        <td>Maturing</td>
        <td>OpenAI, Doc Intel - verify features</td>
    </tr>
    <tr>
        <td><code>avm-res-search-searchservice</code></td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Pending</span></td>
        <td>Maturing</td>
        <td>AI Search - verify private EP support</td>
    </tr>
    <tr>
        <td><code>avm-res-machinelearningservices-workspace</code></td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Pending</span></td>
        <td>Maturing</td>
        <td>Core resource for Foundry Hub/Project</td>
    </tr>
    <tr>
        <td><code>avm-ptn-aiml-ai-foundry</code></td>
        <td><span class="badge" style="background:#ef4444;color:white;">In Development</span></td>
        <td>Not Production Ready</td>
        <td>Pattern module - active development</td>
    </tr>
    <tr>
        <td><code>avm-ptn-ai-foundry-enterprise</code></td>
        <td><span class="badge" style="background:#666;color:white;">Archived</span></td>
        <td>Abandoned</td>
        <td>Was archived July 2025 - do not use</td>
    </tr>
    <tr>
        <td><code>avm-res-containerservice-managedcluster</code></td>
        <td><span class="badge" style="background:#f59e0b;color:white;">Pending</span></td>
        <td>Pre-release</td>
        <td>AKS - v0.4.0-pre2</td>
    </tr>
</table>

<h4>What This Means</h4>

<div class="grid grid-2">
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0; color: #22c55e;">Safe to Use AVM</h4>
        <ul style="margin-bottom: 0;">
            <li>Virtual Networks, Subnets, NSGs</li>
            <li>Storage Accounts</li>
            <li>Key Vault</li>
            <li>Bastion Host</li>
            <li>App Gateway</li>
            <li>Cosmos DB</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: #f59e0b;">
        <h4 style="margin-top: 0; color: #f59e0b;">Evaluate / May Need Custom</h4>
        <ul style="margin-bottom: 0;">
            <li>AI Foundry (use resource module, not pattern)</li>
            <li>APIM (early version, test thoroughly)</li>
            <li>Cognitive Services (verify private EP)</li>
            <li>AI Search (verify features needed)</li>
            <li>AKS (pre-release)</li>
        </ul>
    </div>
</div>

<div class="alert alert-info" style="margin-top: 1rem;">
    <span class="alert-icon">ğŸ’¡</span>
    <div>
        <strong>Our Strategy:</strong> Use mature AVM modules for infrastructure (networking, storage, security). For AI Foundry, start with the core <code>machinelearningservices-workspace</code> resource module rather than the pattern modules. Be prepared to write custom Terraform for AI-specific configurations that AVM doesn't yet support.
    </div>
</div>

<h3>Concrete Example: Storage Account</h3>

<div class="card" style="border-left-color: var(--bc-blue);">
    <h4 style="margin-top: 0;">Without AVM (Custom from scratch)</h4>
    <pre style="background: #1e1e1e; font-size: 11px; margin: 0;">
# ~200 lines of Terraform to handle:
resource "azurerm_storage_account" "main" { ... }
resource "azurerm_storage_account_network_rules" "main" { ... }
resource "azurerm_private_endpoint" "blob" { ... }
resource "azurerm_private_endpoint" "file" { ... }
resource "azurerm_private_endpoint" "queue" { ... }
resource "azurerm_private_dns_zone_virtual_network_link" "blob" { ... }
resource "azurerm_role_assignment" "contributor" { ... }
resource "azurerm_role_assignment" "reader" { ... }
resource "azurerm_monitor_diagnostic_setting" "main" { ... }
# Plus encryption, lifecycle policies, soft delete, versioning...
# Plus handling for every Azure API version change...
    </pre>
</div>

<div class="card" style="border-left-color: #22c55e; margin-top: 1rem;">
    <h4 style="margin-top: 0;">With AVM Module</h4>
    <pre style="background: #1e1e1e; font-size: 11px; margin: 0;">
module "storage" {
  source  = "Azure/avm-res-storage-storageaccount/azurerm"
  version = "0.6.7"

  name                = "ministryhealthstorage"
  resource_group_name = azurerm_resource_group.ministry.name
  location            = "canadacentral"

  # Private endpoints - one line enables the pattern
  private_endpoints = {
    blob = { subnet_id = module.network.subnet_ids["private-endpoints"] }
  }

  # All the security, RBAC, monitoring handled by module
  tags = var.common_tags
}
    </pre>
    <p style="margin-bottom: 0;"><strong>Result:</strong> Same outcome, 10x less code, maintained by Microsoft.</p>
</div>

<h3>Why Not 100% Custom?</h3>

<div class="grid grid-2">
    <div class="card" style="border-left-color: #f59e0b;">
        <h4 style="margin-top: 0;">Custom = Maintenance Burden</h4>
        <ul style="margin-bottom: 0;">
            <li>Azure releases ~100 API changes/month</li>
            <li>Each change could break custom modules</li>
            <li>Security vulnerabilities need patching</li>
            <li>New features require manual implementation</li>
            <li>Team turnover = knowledge loss</li>
            <li><strong>Who maintains this in 3 years?</strong></li>
        </ul>
    </div>
    <div class="card" style="border-left-color: #22c55e;">
        <h4 style="margin-top: 0;">AVM = Shared Maintenance</h4>
        <ul style="margin-bottom: 0;">
            <li>Microsoft + community maintain modules</li>
            <li>API changes handled upstream</li>
            <li>Security patches published as versions</li>
            <li>New features added automatically</li>
            <li>Documentation maintained centrally</li>
            <li><strong>Sustainable long-term</strong></li>
        </ul>
    </div>
</div>

<h3>What We're Actually Doing</h3>

<div class="card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-left-color: #22c55e;">
    <h4 style="margin-top: 0; color: #166534;">Our Approach: AVM + BC Gov Customization Layer</h4>
    <pre style="background: #1e1e1e; font-size: 12px; margin: 0.5rem 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BC Gov AI Hub Architecture                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  BC Gov Customization Layer (Our Code)                      â”‚   â”‚
â”‚   â”‚  â€¢ Multi-tenant resource group structure                    â”‚   â”‚
â”‚   â”‚  â€¢ APIM subscription per ministry                           â”‚   â”‚
â”‚   â”‚  â€¢ IP allocation policies                                   â”‚   â”‚
â”‚   â”‚  â€¢ Platform Services DNS integration                        â”‚   â”‚
â”‚   â”‚  â€¢ Canada data residency enforcement                        â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Azure Verified Modules (Microsoft Maintained)              â”‚   â”‚
â”‚   â”‚  â€¢ avm-res-cognitiveservices-account                        â”‚   â”‚
â”‚   â”‚  â€¢ avm-res-machinelearningservices-workspace                â”‚   â”‚
â”‚   â”‚  â€¢ avm-res-storage-storageaccount                           â”‚   â”‚
â”‚   â”‚  â€¢ avm-res-network-virtualnetwork                           â”‚   â”‚
â”‚   â”‚  â€¢ avm-res-apimanagement-service                            â”‚   â”‚
â”‚   â”‚  â€¢ ... 100+ more modules                                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Azure Resource Manager APIs                                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    </pre>
    <p style="margin-bottom: 0;"><strong>We write the thin customization layer. Microsoft maintains the heavy lifting.</strong></p>
</div>

<h3>Decision</h3>

<p><strong>We use AI Landing Zone reference architecture and AVM modules as our foundation, with a BC Gov customization layer on top.</strong></p>

<p>We do NOT use Microsoft's default configuration. We use their:</p>
<ul>
    <li><strong>Reference patterns</strong> - How to wire services together</li>
    <li><strong>AVM modules</strong> - Tested, maintained infrastructure components</li>
    <li><strong>Best practices</strong> - Security, networking, RBAC patterns</li>
</ul>

<h3>Consequences</h3>

<h4>Positive</h4>
<ul>
    <li><strong>Reduced maintenance</strong> - Microsoft maintains 90% of the code</li>
    <li><strong>Faster development</strong> - Use proven patterns instead of inventing</li>
    <li><strong>Security updates</strong> - Get patches via module version bumps</li>
    <li><strong>Community support</strong> - Issues/bugs reported and fixed by others</li>
    <li><strong>Audit trail</strong> - Using "official" modules helps with compliance</li>
</ul>

<h4>Negative</h4>
<ul>
    <li><strong>Module constraints</strong> - Can only do what AVM modules support</li>
    <li><strong>Version management</strong> - Must track and update module versions</li>
    <li><strong>Abstraction leakage</strong> - Sometimes need to understand module internals</li>
</ul>

<h3>References</h3>
<ul>
    <li><a href="https://azure.github.io/Azure-Verified-Modules/">Azure Verified Modules (AVM)</a></li>
    <li><a href="https://github.com/Azure/terraform-azurerm-avm-ptn-aiml-landing-zone">AI/ML Landing Zone Pattern Module</a></li>
    <li><a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/">Azure Landing Zone Concepts</a></li>
    <li><a href="diagrams.html#architecture-layers">Architecture Layers Diagram</a></li>
</ul>

</div>
</details>

<h2>ADR Template</h2>

<p>Use this template when adding new ADRs:</p>

<div class="card" style="background: var(--bg-light);">
<pre style="background: transparent; box-shadow: none; margin: 0;">## ADR-XXX: [Title]

**Status:** [Proposed | Accepted | Deprecated | Superseded]
**Date:** YYYY-MM
**Deciders:** [Team/People]
**Category:** [Security | Networking | Infrastructure | Documentation | etc.]

### Context
[What is the issue? What forces are at play?]

### Decision
[What is the decision? Be specific.]

### Rationale
[Why this decision over alternatives?]

### Consequences
#### Positive
- [Good outcomes]

#### Negative
- [Tradeoffs accepted]

### References
- [Links to relevant docs, diagrams, discussions]</pre>
</div>
