<!-- TITLE: Terraform Modules -->
<!-- NAV: terraform -->

<h1>Terraform Modules</h1>

<p>This project uses modular Terraform configuration for Azure Landing Zone infrastructure. Each module is designed to be reusable and follows Azure best practices.</p>

<h2>Module Overview</h2>

<table>
    <thead>
        <tr>
            <th>Module</th>
            <th>Purpose</th>
            <th>Key Resources</th>
            <th>Optional?</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>network</strong></td>
            <td>VNet subnets and NSG configuration</td>
            <td>Subnets, Network Security Groups</td>
            <td><strong>No</strong></td>
        </tr>
        <tr>
            <td><strong>monitoring</strong></td>
            <td>Observability with Log Analytics & Application Insights</td>
            <td>Log Analytics Workspace, App Insights</td>
            <td>No</td>
        </tr>
        <tr>
            <td><strong>bastion</strong></td>
            <td>Secure VM access without public IPs</td>
            <td>Azure Bastion Host, Public IP</td>
            <td>Yes (<code>enable_bastion</code>)</td>
        </tr>
        <tr>
            <td><strong>jumpbox</strong></td>
            <td>Development VM with CLI tools</td>
            <td>Linux VM, SSH Keys, Auto-shutdown</td>
            <td>Yes (<code>enable_jumpbox</code>)</td>
        </tr>
        <tr>
            <td><strong>github-runners-aca</strong></td>
            <td>Self-hosted GitHub runners on Container Apps</td>
            <td>Container Apps Environment, Container Job, ACR</td>
            <td>Yes (<code>github_runners_aca_enabled</code>)</td>
        </tr>
        <tr>
            <td><strong>azure-proxy</strong></td>
            <td>Secure tunnel (chisel) for proxying to peered networks</td>
            <td>App Service, Container Image</td>
            <td>Yes (<code>enable_azure_proxy</code>)</td>
        </tr>
    </tbody>
</table>

<div class="alert alert-info">
    <strong>Optional Modules:</strong> Modules marked as optional can be toggled on/off using their respective variables. Set them in <code>terraform.tfvars</code> or as environment variables.
</div>

<h2>Deployment Script: deploy-terraform.sh</h2>

<p>A wrapper script that simplifies Terraform operations with proper Azure authentication. Features auto-import of conflicting resources and intelligent retry logic.</p>

<h3>Usage</h3>

<pre>./initial-setup/infra/deploy-terraform.sh <command> [options]

Commands:
  init     Initialize Terraform with backend configuration
  plan     Preview infrastructure changes
  apply    Apply infrastructure changes (with auto-import & retry)
  destroy  Destroy all infrastructure
  output   Display Terraform outputs</pre>

<div class="card card-gold">
    <h3>Smart Apply Logic</h3>
    <p>The <code>apply</code> command now includes:</p>
    <ul>
        <li><strong>Auto-detection</strong>: Detects "already exists" errors from Azure</li>
        <li><strong>Automatic import</strong>: Imports conflicting resources into Terraform state</li>
        <li><strong>Retry on success</strong>: Reruns apply after successful import (max 3 attempts)</li>
        <li><strong>Clear failure messages</strong>: Shows which resource was imported or why the apply failed</li>
    </ul>
</div>

<h3>Examples</h3>

<div class="grid grid-2">
    <div class="card">
        <h3>Full Deployment</h3>
        <pre>./initial-setup/infra/deploy-terraform.sh init
./initial-setup/infra/deploy-terraform.sh plan
./initial-setup/infra/deploy-terraform.sh apply</pre>
    </div>
    <div class="card">
        <h3>Target Specific Module</h3>
        <pre># Deploy only bastion
./initial-setup/infra/deploy-terraform.sh apply \
  -target=module.bastion

# Deploy only jumpbox
./initial-setup/infra/deploy-terraform.sh apply \
  -target=module.jumpbox</pre>
    </div>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Monitoring Module</h2>

<p>Provides centralized observability across all deployed resources using Azure Monitor services.</p>

<div class="card">
    <h3>Resources Created</h3>
    <ul>
        <li><strong>Log Analytics Workspace</strong>: Central logs and metrics repository (default retention: 30 days, configurable)</li>
        <li><strong>Application Insights</strong>: APM for applications, connected to Log Analytics workspace</li>
    </ul>
</div>

<div class="card card-gold">
    <h3>Key Variables</h3>
    <table>
        <thead>
            <tr>
                <th>Variable</th>
                <th>Default</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>log_analytics_sku</code></td>
                <td>PerGB2018</td>
                <td>Log Analytics pricing tier</td>
            </tr>
            <tr>
                <td><code>log_analytics_retention_days</code></td>
                <td>30</td>
                <td>Data retention period in days</td>
            </tr>
        </tbody>
    </table>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Network Module</h2>

<p>Configures subnets within an existing VNet and creates Network Security Groups (NSGs) for traffic control.</p>

<div class="card">
    <h3>Subnets Created</h3>
    <table>
        <thead>
            <tr>
                <th>Subnet</th>
                <th>Purpose</th>
                <th>Delegation</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>AzureBastionSubnet</code></td>
                <td>Azure Bastion service</td>
                <td>None (required name)</td>
            </tr>
            <tr>
                <td><code>jumpbox-subnet</code></td>
                <td>Jumpbox VM</td>
                <td>None</td>
            </tr>
            <tr>
                <td><code>privateendpoints-subnet</code></td>
                <td>Private Endpoints for Azure services</td>
                <td>None</td>
            </tr>
            <tr>
                <td><code>app-service-subnet</code></td>
                <td>App Service VNet integration</td>
                <td>Microsoft.Web/serverFarms</td>
            </tr>
            <tr>
                <td><code>container-instance-subnet</code></td>
                <td>Azure Container Instances</td>
                <td>Microsoft.ContainerInstance/containerGroups</td>
            </tr>
            <tr>
                <td><code>container-apps-subnet</code></td>
                <td>Azure Container Apps Environment</td>
                <td>Microsoft.App/environments</td>
            </tr>
            <tr>
                <td><code>apim-subnet</code></td>
                <td>Azure API Management</td>
                <td>Microsoft.Web/serverFarms</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card card-gold">
    <h3>Network Security Groups</h3>
    <p>Each subnet has a dedicated NSG with rules for:</p>
    <ul>
        <li><strong>Bastion NSG</strong>: HTTPS inbound, Gateway Manager, SSH/RDP to VNet</li>
        <li><strong>Jumpbox NSG</strong>: SSH/RDP from Bastion only, outbound to Private Endpoints</li>
        <li><strong>App Service NSG</strong>: HTTP/HTTPS from internet, communication with Private Endpoints</li>
        <li><strong>Container Apps NSG</strong>: Load Balancer, HTTP/HTTPS, Private Endpoint access</li>
        <li><strong>APIM NSG</strong>: API Management traffic, backend service access</li>
    </ul>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Bastion Module</h2>

<p>Deploys Azure Bastion for secure, browser-based SSH/RDP access to VMs without exposing public IPs.</p>

<div class="grid grid-2">
    <div class="card">
        <h3>Resources Created</h3>
        <ul>
            <li><strong>Public IP</strong>: Static, Standard SKU (required for Bastion)</li>
            <li><strong>Bastion Host</strong>: Basic SKU for cost optimization</li>
        </ul>
    </div>
    <div class="card">
        <h3>Features</h3>
        <ul>
            <li>Web-based SSH/RDP from Azure Portal</li>
            <li>No public IPs needed on VMs</li>
            <li>TLS encryption for all sessions</li>
            <li>NSG rules per Microsoft requirements</li>
        </ul>
    </div>
</div>

<div class="alert alert-info">
    <strong>Cost Tip:</strong> Azure Bastion has hourly charges. Use the <code>add-or-remove-module.yml</code> workflow to deploy/destroy Bastion on demand.
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Jumpbox Module</h2>

<p>Creates a Linux VM for development and administration tasks, pre-configured with essential CLI tools.</p>

<div class="card">
    <h3>VM Configuration</h3>
    <table>
        <thead>
            <tr>
                <th>Setting</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>OS</td>
                <td>Ubuntu 24.04 LTS (Noble Numbat)</td>
            </tr>
            <tr>
                <td>Size</td>
                <td>B-series burstable (configurable)</td>
            </tr>
            <tr>
                <td>Authentication</td>
                <td>SSH Key (auto-generated, stored in <code>sensitive/</code>)</td>
            </tr>
            <tr>
                <td>Public IP</td>
                <td>None (access via Bastion only)</td>
            </tr>
            <tr>
                <td>Identity</td>
                <td>System-assigned managed identity</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card card-gold">
    <h3>Pre-installed Tools</h3>
    <p>The VM is bootstrapped with cloud-init to install:</p>
    <div class="grid grid-3">
        <div>
            <strong>Azure & Cloud</strong>
            <ul>
                <li>Azure CLI</li>
                <li>Terraform</li>
                <li>kubectl</li>
            </ul>
        </div>
        <div>
            <strong>Development</strong>
            <ul>
                <li>Docker & Compose</li>
                <li>GitHub CLI</li>
                <li>Python 3 & pip</li>
            </ul>
        </div>
        <div>
            <strong>Utilities</strong>
            <ul>
                <li>git, vim, tmux</li>
                <li>jq, curl, wget</li>
                <li>htop, net-tools</li>
            </ul>
        </div>
    </div>
</div>

<div class="card">
    <h3>Auto-Shutdown & Start</h3>
    <p>Cost optimization through scheduled operations:</p>
    <table>
        <thead>
            <tr>
                <th>Schedule</th>
                <th>Time</th>
                <th>Method</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Auto-Shutdown</strong></td>
                <td>7:00 PM PST daily</td>
                <td>Azure Dev/Test shutdown schedule</td>
            </tr>
            <tr>
                <td><strong>Auto-Start</strong></td>
                <td>8:00 AM PST Mon-Fri</td>
                <td>Azure Automation Runbook (Python3)</td>
            </tr>
        </tbody>
    </table>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Azure Proxy Module (Chisel Tunnel)</h2>

<p>Deploys a <strong>Chisel</strong> secure tunnel server for accessing private Azure resources (data plane) from your local machine. This solves the problem of accessing private endpoints when you're outside the VNet.</p>

<div class="alert alert-info">
    <strong>Why Chisel?</strong> Private endpoints block data plane access from the public internet. Chisel creates an HTTPS tunnel through an App Service (which has VNet integration) to reach Key Vault secrets, databases, and other private resources from your laptop.
</div>

<div class="grid grid-2">
    <div class="card">
        <h3>Resources Created</h3>
        <ul>
            <li><strong>App Service Plan</strong>: Linux plan hosting the tunnel (configurable SKU)</li>
            <li><strong>Web App</strong>: Runs containerized Chisel server with VNet integration</li>
            <li><strong>Random Credentials</strong>: Auto-generated username/password for tunnel auth</li>
            <li><strong>Application Insights</strong>: Connection logging and monitoring</li>
        </ul>
    </div>
    <div class="card card-gold">
        <h3>Security Features</h3>
        <ul>
            <li><strong>HTTPS Only</strong>: TLS 1.3 minimum</li>
            <li><strong>Mandatory Auth</strong>: Random credentials stored in App Settings</li>
            <li><strong>Health Checks</strong>: Automatic restart on failure</li>
            <li><strong>Logging</strong>: All connections logged to App Insights</li>
        </ul>
    </div>
</div>

<div class="card">
    <h3>Key Variables</h3>
    <table>
        <thead>
            <tr>
                <th>Variable</th>
                <th>Default</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>enable_azure_proxy</code></td>
                <td>false</td>
                <td>Enable/disable Chisel deployment</td>
            </tr>
            <tr>
                <td><code>azure_proxy_image</code></td>
                <td>-</td>
                <td>Container image URI (built by pr-open workflow)</td>
            </tr>
            <tr>
                <td><code>app_service_sku_name_azure_proxy</code></td>
                <td>B1</td>
                <td>App Service plan SKU</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card" style="border-left-color: #8b5cf6;">
    <h3>Usage Example</h3>
    <p>After deployment, connect from your laptop:</p>
    <pre># Get credentials from Terraform output
terraform output azure_proxy_chisel_auth
terraform output azure_proxy_url

# Connect to private PostgreSQL database
docker run --rm -it -p 5432:5432 jpillora/chisel:latest client \
  --auth "tunnel:XXXXXXXX" \
  https://your-app.azurewebsites.net \
  0.0.0.0:5432:private-postgres.postgres.database.azure.com:5432

# Now connect locally
psql -h localhost -p 5432 -U admin -d mydb</pre>
    <p>See <a href="playbooks.html#chisel-tunnel">Chisel Tunnel Playbook</a> for detailed instructions.</p>
</div>

<div class="alert alert-warning">
    <strong>Platform Maintainers Only:</strong> Chisel is for the platform team to access private resources. Tenant developers should use APIM/App Gateway endpoints designed for their applications.
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Choosing Your Access Method</h2>

<p>The infrastructure provides <strong>four interchangeable access methods</strong> for reaching Azure resources. Enable only what you need - all are optional and controlled via Terraform variables.</p>

<div class="alert alert-success">
    <strong>Understanding Control vs Data Plane:</strong> OIDC authentication works for <em>control plane</em> (creating resources) but <em>not</em> data plane (accessing secrets, blobs, databases) when private endpoints are enabled. See <a href="decisions.html#adr-011">ADR-011</a> for details.
</div>

<table>
    <thead>
        <tr>
            <th>Access Method</th>
            <th>Toggle Variable</th>
            <th>Control Plane</th>
            <th>Data Plane</th>
            <th>Best For</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Public GitHub Runners</strong></td>
            <td><em>(default, no toggle)</em></td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td style="color: #ef4444;">&#10007; No</td>
            <td>Resource deployments only</td>
        </tr>
        <tr>
            <td><strong>Self-Hosted Runners</strong></td>
            <td><code>github_runners_aca_enabled</code></td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td>Tenant CI/CD pipelines needing VNet access</td>
        </tr>
        <tr>
            <td><strong>Bastion + Jumpbox</strong></td>
            <td><code>enable_bastion</code> + <code>enable_jumpbox</code></td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td>Admin access, debugging</td>
        </tr>
        <tr>
            <td><strong>Chisel Tunnel</strong></td>
            <td><code>enable_azure_proxy</code></td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td>Local dev access from laptop</td>
        </tr>
    </tbody>
</table>

<div class="grid grid-2">
    <div class="card">
        <h3>Example: Minimal (Control Plane Only)</h3>
        <pre># terraform.tfvars
enable_bastion              = false
enable_jumpbox              = false
enable_azure_proxy          = false
github_runners_aca_enabled  = false

# Uses public GitHub runners
# Good for: Resource-only Terraform</pre>
    </div>
    <div class="card card-gold">
        <h3>Example: Full Access</h3>
        <pre># terraform.tfvars
enable_bastion              = true
enable_jumpbox              = true
enable_azure_proxy          = true
github_runners_aca_enabled  = true

# All access methods available
# Good for: Platform maintainers</pre>
    </div>
</div>

<div class="card" style="border-left-color: #0ea5e9;">
    <h3>Recommended Setup by Role</h3>
    <table>
        <tr>
            <td><strong>Platform Maintainers</strong></td>
            <td>Enable all: Bastion + Jumpbox for admin, Chisel for local dev, Self-hosted for CI/CD</td>
        </tr>
        <tr>
            <td><strong>Project Developers</strong></td>
            <td>No direct access needed - use APIM/App Gateway endpoints provided by platform</td>
        </tr>
        <tr>
            <td><strong>Cost-Conscious</strong></td>
            <td>Chisel only (<code>enable_azure_proxy</code>) - cheapest option with data plane access</td>
        </tr>
    </table>
</div>

<p>See <a href="diagrams.html#access-methods">Access Methods Architecture Diagram</a> for a visual overview.</p>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2>Backend Configuration</h2>

<p>Terraform state is stored in Azure Blob Storage with Azure AD authentication.</p>

<pre># infra/backend.tf
terraform {
  backend "azurerm" {
    resource_group_name  = "your-resource-group"
    storage_account_name = "tfstateaccount"
    container_name       = "tfstate"
    key                  = "terraform.tfstate"
    use_azuread_auth     = true  # Required for OIDC
  }
}</pre>

<div class="alert alert-warning">
    <strong>Important:</strong> The <code>use_azuread_auth = true</code> setting is required when using OIDC authentication. Without it, Terraform will fail to access the state file.
</div>

<h2>Variables Reference</h2>

<p>Key variables used across modules:</p>

<table>
    <thead>
        <tr>
            <th>Variable</th>
            <th>Description</th>
            <th>Source</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>app_name</code></td>
            <td>Application name prefix for resources</td>
            <td>Environment variable</td>
        </tr>
        <tr>
            <td><code>app_env</code></td>
            <td>Environment (dev, test, prod)</td>
            <td>GitHub Environment</td>
        </tr>
        <tr>
            <td><code>location</code></td>
            <td>Azure region</td>
            <td>Default: Canada Central</td>
        </tr>
        <tr>
            <td><code>resource_group_name</code></td>
            <td>Target resource group</td>
            <td>Environment variable</td>
        </tr>
        <tr>
            <td><code>vnet_name</code></td>
            <td>Existing VNet name</td>
            <td>GitHub Secret</td>
        </tr>
        <tr>
            <td><code>vnet_address_space</code></td>
            <td>VNet CIDR for subnet calculation</td>
            <td>GitHub Secret</td>
        </tr>
    </tbody>
</table>
