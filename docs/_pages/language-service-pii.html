<!-- TITLE: Language Service PII Detection -->
<!-- NAV: language-service-pii -->

<h1>Language Service PII Detection</h1>

<p>This system supports tenant-controlled PII anonymization by calling Azure AI Language Service (Text Analytics) from Azure API Management (APIM) policies. The goal is to mask sensitive data before it is forwarded to downstream backends such as OpenAI.</p>

<div class="alert alert-info">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    </div>
    <div>
        <strong>Enterprise-grade PII Protection</strong><br>
        Azure AI Language Service provides ML-based entity recognition that enables accurate detection and redaction of sensitive information including names, addresses, financial data, and medical terms.
    </div>
</div>

<h2>Overview</h2>

<p>The system uses Azure AI Language Service PII entity recognition to identify and redact sensitive information in requests. This ML-based approach provides broad entity coverage, context-aware detection, and machine learning accuracy for enterprise-grade PII protection.</p>

<h3>Supported Entity Types</h3>
<p>Azure AI Language Service can detect and redact a wide range of PII entity types:</p>
<ul>
    <li><strong>Personal Identifiers:</strong> Names, email addresses, phone numbers</li>
    <li><strong>Financial Data:</strong> Credit card numbers, bank account numbers</li>
    <li><strong>Government IDs:</strong> Social Security Numbers, passport numbers, driver's license numbers</li>
    <li><strong>Location Data:</strong> Physical addresses, GPS coordinates</li>
    <li><strong>Medical Information:</strong> Medical record numbers, health insurance information</li>
</ul>

<h2>Architecture</h2>

<p>Requests enter APIM, tenant API policies decide whether to apply PII anonymization, and when enabled, APIM calls the shared Language Service endpoint using managed identity. The Language Service endpoint is provided to APIM policies via an APIM Named Value: <code>piiServiceUrl</code>.</p>

<div class="card">
    <h3 style="margin-top: 0;">Request Flow</h3>
    <ol>
        <li>Client request arrives at APIM with sensitive content</li>
        <li>Tenant API policy extracts request body content</li>
        <li>PII anonymization fragment calls Language Service via managed identity</li>
        <li>Language Service analyzes and redacts PII entities</li>
        <li>APIM replaces request body with redacted content</li>
        <li>Request forwards to backend (OpenAI, Document Intelligence, etc.)</li>
    </ol>
</div>

<h2>How It Works</h2>

<ol>
    <li>A tenant request arrives at APIM.</li>
    <li>The tenant API policy (generated from <code>api_policy.xml.tftpl</code>) routes the request to the correct backend based on path (for example <code>openai</code>, <code>documentintelligence</code>, <code>ai-search</code>, <code>storage</code>).</li>
    <li>For OpenAI requests, when PII redaction is enabled, the policy extracts the request body as text and sets it to <code>piiInputContent</code>.</li>
    <li>The policy includes the <code>pii-anonymization</code> policy fragment.</li>
    <li>The fragment:
        <ul>
            <li>Obtains an AAD token via <code>&lt;authentication-managed-identity&gt;</code> for <code>https://cognitiveservices.azure.com</code>.</li>
            <li>Calls Language Service <code>/language/:analyze-text?api-version=2025-11-15-preview</code> with request kind <code>PiiEntityRecognition</code>.</li>
            <li>Uses a CharacterMask redaction policy (mask character <code>#</code>).</li>
            <li>Extracts <code>results.documents[0].redactedText</code> into <code>piiAnonymizedContent</code>.</li>
            <li>Emits diagnostics including status code, entity count, entity types, and whether content changed.</li>
        </ul>
    </li>
    <li>The tenant policy explicitly applies the anonymized content back to the request body using <code>&lt;set-body&gt;</code> and forwards the request.</li>
</ol>

<div class="alert alert-warning">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10Z"/></svg>
    </div>
    <div>
        <strong>Example Redaction</strong><br>
        Input: "My email is alice@example.com and my SSN is 123-45-6789"<br>
        Output: "My email is ##################### and my SSN is ###########"
    </div>
</div>

<h2>Configuration Guide</h2>

<h3>Shared Configuration (All Environments)</h3>

<p>PII detection depends on the shared Language Service being enabled via <code>shared_config.language_service.enabled</code> and integrated into APIM via <code>piiServiceUrl</code>. Language Service is configured for private access (no public network access) and is connected through a private endpoint.</p>

<h3>Per-Tenant Configuration</h3>

<p>PII anonymization is controlled per tenant via APIM policy settings (<code>apim_policies.pii_redaction.enabled</code>). The tenant API policy generation includes PII only when tenant PII redaction is enabled and the shared Language Service is enabled.</p>

<pre><code># Example tenant policy flags
apim_policies {
  pii_redaction {
    enabled = true
  }
  rate_limiting {
    enabled = true
    tokens_per_minute = 10000
  }
  usage_logging {
    enabled = true
  }
  streaming_metrics {
    enabled = true
  }
  tracking_dimensions {
    enabled = true
  }
}
</code></pre>

<div class="card card-gold">
    <h3 style="margin-top: 0;">Flexible Tenant Control</h3>
    <p>Each tenant can independently enable or disable PII redaction based on their specific requirements. This allows for granular control over data privacy settings while sharing the same infrastructure.</p>
</div>

<h2>Security Model</h2>

<div class="grid grid-2">
    <div class="card">
        <h3 style="margin-top: 0;">Managed Identity Authentication</h3>
        <p>Language Service uses managed identity only (<code>local_auth_enabled = false</code>) rather than API keys. This eliminates the need for credential rotation and follows Azure security best practices.</p>
    </div>
    <div class="card">
        <h3 style="margin-top: 0;">Private Network Access</h3>
        <p>Language Service network ACLs default to deny and it is accessed via a private endpoint. APIM is granted access via RBAC (<code>Cognitive Services User</code> role).</p>
    </div>
</div>

<p>APIM policy calls use AAD tokens (Authorization Bearer) and remove any <code>api-key</code> header before calling Cognitive Services APIs.</p>

<h2>Observability</h2>

<h3>PII Detection Diagnostics</h3>

<p>The <code>pii-anonymization</code> fragment emits rich diagnostic traces to Application Insights, including:</p>

<ul>
    <li><strong>pii-status-code:</strong> HTTP response status from Language Service API call</li>
    <li><strong>pii-entity-count:</strong> Number of PII entities detected in the request</li>
    <li><strong>pii-entity-types:</strong> Comma-separated list of entity categories found (e.g., "Email,SSN,CreditCard")</li>
    <li><strong>pii-content-changed:</strong> Boolean flag indicating whether any redaction occurred</li>
    <li><strong>request-id:</strong> Correlation ID for tracing the request across services</li>
    <li><strong>tenant-id:</strong> Tenant identifier for per-tenant analytics</li>
</ul>

<p>These diagnostics enable monitoring of PII detection effectiveness, understanding which entity types are most commonly detected, and tracking Language Service API health.</p>

<h3>OpenAI Usage Logging</h3>

<p>For OpenAI requests, the tenant policy template sets routing metadata variables before including the <code>openai-usage-logging</code> fragment:</p>

<ul>
    <li><strong>backendId:</strong> APIM backend identifier (e.g., <code>tenant-openai</code>)</li>
    <li><strong>routeLocation:</strong> Azure region for the backend (single-backend for now)</li>
    <li><strong>routeName:</strong> Route identifier for future intelligent routing</li>
    <li><strong>deploymentName:</strong> Extracted from the URL path (e.g., <code>gpt-4</code>)</li>
</ul>

<p>These dimensions are logged to Application Insights along with token usage data, enabling detailed cost allocation, chargeback analytics, and deployment-level monitoring even in the current single-backend setup.</p>

<h3>Additional Monitoring Fragments</h3>

<table>
    <thead>
        <tr>
            <th>Fragment</th>
            <th>Purpose</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>tracking-dimensions</code></td>
            <td>Extract session, user, app, and correlation IDs from headers</td>
            <td>Active</td>
        </tr>
        <tr>
            <td><code>openai-usage-logging</code></td>
            <td>Detailed usage tracking to Application Insights with routing metadata</td>
            <td>Active</td>
        </tr>
        <tr>
            <td><code>openai-streaming-metrics</code></td>
            <td>Token metrics for streaming responses</td>
            <td>Reserved for future use</td>
        </tr>
        <tr>
            <td><code>intelligent-routing</code></td>
            <td>Priority-based multi-backend selection</td>
            <td>Reserved for future use</td>
        </tr>
    </tbody>
</table>

<h2>Frequently Asked Questions</h2>

<details>
    <summary><strong>What kinds of entities are supported?</strong></summary>
    <div class="accordion-content">
        <p>The PII fragment is designed for enterprise PII detection and supports names, addresses, SSN, medical terms, financial data, and many other entity types. Azure Language Service uses machine learning to detect entities based on context.</p>
    </div>
</details>

<details>
    <summary><strong>What happens if Language Service fails?</strong></summary>
    <div class="accordion-content">
        <p>PII redaction operates on a <strong>best-effort basis</strong>. The Language Service call uses <code>ignore-error="true"</code>, which means:</p>
        <ul>
            <li>If the Language Service returns a non-200 response, the original content is passed through</li>
            <li>If the response cannot be parsed, the original content is passed through</li>
            <li>If the Language Service is temporarily unavailable, requests continue to flow without redaction</li>
            <li>All failures are logged in diagnostics with appropriate status codes and error details</li>
        </ul>
        <p>This design prioritizes service availability over PII protection. If strict PII redaction is required with no fallback, the fragment behavior would need to be modified to fail requests when Language Service is unavailable.</p>
    </div>
</details>

<details>
    <summary><strong>Does this apply to all requests?</strong></summary>
    <div class="accordion-content">
        <p>PII anonymization is tenant-controlled and is applied (in the current routing) for OpenAI requests when enabled via <code>apim_policies.pii_redaction.enabled</code>.</p>
    </div>
</details>

<details>
    <summary><strong>What is the performance impact?</strong></summary>
    <div class="accordion-content">
        <p>PII anonymization adds an extra network call from APIM to Language Service for requests where it is enabled. The Language Service call uses a fixed timeout of 20 seconds. For most requests, the latency impact is minimal (typically under 500ms).</p>
    </div>
</details>

<details>
    <summary><strong>Can I customize which entity types are redacted?</strong></summary>
    <div class="accordion-content">
        <p>The current implementation redacts all detected PII entity types. Customization of entity type filtering can be configured in the <code>pii-anonymization.xml</code> fragment by modifying the Language Service API request parameters.</p>
    </div>
</details>

<h2>Known Limitations</h2>

<div class="alert alert-warning">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
    </div>
    <div>
        <strong>Production Considerations</strong><br>
        The current PII detection implementation has several known limitations that may impact production deployments. Evaluate these constraints when deciding whether to enable PII redaction for your tenant.
    </div>
</div>

<h3>1. Best-Effort Redaction (Fail-Open on Errors)</h3>

<p>The PII fragment is configured with <code>ignore-error="true"</code>, which means the system prioritizes service availability over strict PII protection:</p>

<div class="card">
    <p><strong>Impact:</strong> When the Language Service call fails, times out, or returns an invalid response, the original unredacted content is passed through to the backend.</p>
    <p><strong>Scenarios where unredacted data may pass:</strong></p>
    <ul>
        <li>Language Service API returns non-200 status codes (e.g., 429 throttling, 500 server errors)</li>
        <li>Network timeouts (20-second timeout threshold)</li>
        <li>Response parsing failures (malformed JSON, unexpected schema)</li>
        <li>Language Service outages or maintenance windows</li>
    </ul>
    <p><strong>Mitigation:</strong> Monitor the <code>pii-status-code</code> diagnostic metric in Application Insights to track failure rates. If strict PII protection is required with no fallback, the fragment would need to be modified to fail requests (return 500/503) when Language Service is unavailable.</p>
</div>

<h3>2. Preview API Dependency</h3>

<p>The implementation uses a preview API version (<code>api-version=2025-11-15-preview</code>) for PII detection:</p>

<div class="card">
    <p><strong>Impact:</strong> Preview APIs are subject to breaking changes, behavior shifts, or deprecation without extended support timelines.</p>
    <p><strong>Risks:</strong></p>
    <ul>
        <li>Microsoft may change request/response schema in future preview updates</li>
        <li>Entity detection accuracy or coverage may change between preview versions</li>
        <li>Preview API may be deprecated before reaching General Availability (GA)</li>
        <li>No SLA guarantees for preview services</li>
    </ul>
    <p><strong>Mitigation:</strong> Monitor Microsoft announcements for API version updates. Plan to migrate to GA API version when available. Test preview API updates in non-production environments before deploying.</p>
</div>

<h3>3. Request Size and Language Constraints</h3>

<p>The current implementation has hard-coded constraints that may limit effectiveness for certain workloads:</p>

<div class="card">
    <p><strong>Language Limitation:</strong> The fragment hard-codes <code>language="en"</code> in the API request, which may reduce detection accuracy for non-English content.</p>
    <p><strong>Single Document Processing:</strong> The entire request body is sent as a single document to Language Service, subject to Azure limits:</p>
    <ul>
        <li>Maximum <strong>5,120 text elements</strong> per document</li>
        <li>Maximum <strong>5 documents</strong> per API request</li>
        <li>Maximum <strong>1 MB total payload size</strong> across all documents</li>
    </ul>
    <p><strong>Chat History Re-processing:</strong> For OpenAI chat completion requests, the entire conversation history (all messages in the <code>messages</code> array) is sent to Language Service on every request. This means:</p>
    <ul>
        <li>Previously redacted messages are re-processed on each subsequent request</li>
        <li>Long conversation threads may exceed the 5,120 text element limit</li>
        <li>Processing costs scale with conversation length, not just new messages</li>
    </ul>
    <p><strong>No Chunking:</strong> Large payloads that exceed limits are not automatically split into multiple documents or requests.</p>
    <p><strong>Current Behavior:</strong> If request size exceeds Language Service limits, the API call may fail and fall back to passing through unredacted content (fail-open behavior).</p>
    <p><strong>Future Improvements:</strong></p>
    <ul>
        <li>Add language detection or make language configurable per tenant</li>
        <li>Implement chunking for large payloads to stay within API limits</li>
        <li>Consider processing only new messages in chat requests (requires message-level tracking)</li>
        <li>Add request size validation before calling Language Service</li>
    </ul>
</div>

<h2>Troubleshooting</h2>

<table>
    <thead>
        <tr>
            <th>Issue</th>
            <th>Cause</th>
            <th>Solution</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>401/403 calling Language Service</td>
            <td>Missing or incorrect RBAC permissions</td>
            <td>Verify APIM managed identity has the <code>Cognitive Services User</code> role assignment on the Language Service resource</td>
        </tr>
        <tr>
            <td>DNS / private endpoint not ready</td>
            <td>Private DNS zone integration incomplete</td>
            <td>Deployment includes a DNS wait step; ensure private DNS zone integration is complete before testing</td>
        </tr>
        <tr>
            <td>Transient failures after deploy</td>
            <td>Role assignment propagation delay</td>
            <td>Role assignment propagation can cause temporary failures until RBAC takes effect (typically 5-10 minutes)</td>
        </tr>
        <tr>
            <td>No redaction occurring</td>
            <td>PII detection not enabled</td>
            <td>Confirm tenant <code>apim_policies.pii_redaction.enabled</code> is true and shared <code>language_service.enabled</code> is true</td>
        </tr>
    </tbody>
</table>

<div class="alert alert-info">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    </div>
    <div>
        <strong>For Technical Details</strong><br>
        See the <a href="https://github.com/bcgov/ai-hub-tracking/blob/main/infra-ai-hub/params/apim/README.md">APIM Policy README</a> for deep technical documentation on policy fragments, infrastructure components, and configuration schema.
    </div>
</div>
