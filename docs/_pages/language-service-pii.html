<!-- TITLE: Language Service PII Detection -->
<!-- NAV: language-service-pii -->

<h1>Language Service PII Detection</h1>

<p>This system supports tenant-controlled PII anonymization by calling Azure AI Language Service (Text Analytics) from Azure API Management (APIM) policies. The goal is to mask sensitive data before it is forwarded to downstream backends such as OpenAI.</p>

<div class="alert alert-info">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    </div>
    <div>
        <strong>Enterprise-grade PII Protection</strong><br>
        Azure AI Language Service provides ML-based entity recognition that enables accurate detection and redaction of sensitive information including names, addresses, financial data, and medical terms.
    </div>
</div>

<h2>Overview</h2>

<p>The system uses Azure AI Language Service PII entity recognition to identify and redact sensitive information in requests. This ML-based approach provides broad entity coverage, context-aware detection, and machine learning accuracy for enterprise-grade PII protection.</p>

<h3>Supported Entity Types</h3>
<p>Azure AI Language Service can detect and redact a wide range of PII entity types:</p>
<ul>
    <li><strong>Personal Identifiers:</strong> Names, email addresses, phone numbers</li>
    <li><strong>Financial Data:</strong> Credit card numbers, bank account numbers</li>
    <li><strong>Government IDs:</strong> Social Security Numbers, passport numbers, driver's license numbers</li>
    <li><strong>Location Data:</strong> Physical addresses, GPS coordinates</li>
    <li><strong>Medical Information:</strong> Medical record numbers, health insurance information</li>
</ul>

<h2>Architecture</h2>

<p>Requests enter APIM, tenant API policies decide whether to apply PII anonymization, and when enabled, APIM calls the shared Language Service endpoint using managed identity. The Language Service endpoint is provided to APIM policies via an APIM Named Value: <code>piiServiceUrl</code>.</p>

<div class="card">
    <h3 style="margin-top: 0;">Request Flow</h3>
    <ol>
        <li>Client request arrives at APIM with sensitive content</li>
        <li>Tenant API policy extracts request body content</li>
        <li>PII anonymization fragment calls Language Service via managed identity</li>
        <li>Language Service analyzes and redacts PII entities</li>
        <li>APIM replaces request body with redacted content</li>
        <li>Request forwards to backend (OpenAI, Document Intelligence, etc.)</li>
    </ol>
</div>

<h2>How It Works</h2>

<ol>
    <li>A tenant request arrives at APIM.</li>
    <li>The tenant API policy (generated from <code>api_policy.xml.tftpl</code>) routes the request to the correct backend based on path (for example <code>openai</code>, <code>documentintelligence</code>, <code>ai-search</code>, <code>storage</code>).</li>
    <li>For OpenAI requests, when PII redaction is enabled, the policy extracts the request body as text and sets it to <code>piiInputContent</code>.</li>
    <li>The tenant policy sets configuration variables from the tenant's <code>apim_policies.pii_redaction</code> settings:
        <ul>
            <li><code>piiExcludedCategories</code> - Categories to exclude from detection</li>
            <li><code>piiDetectionLanguage</code> - Language code for detection accuracy</li>
            <li><code>piiPreserveJsonStructure</code> - Whether to restore structural JSON values</li>
            <li><code>piiStructuralWhitelist</code> - Additional values to preserve</li>
        </ul>
    </li>
    <li>The policy includes the <code>pii-anonymization</code> policy fragment, which uses these configuration variables.</li>
    <li>The fragment:
        <ul>
            <li>Obtains an AAD token via <code>&lt;authentication-managed-identity&gt;</code> for <code>https://cognitiveservices.azure.com</code>.</li>
            <li>Calls Language Service <code>/language/:analyze-text?api-version=2025-11-15-preview</code> with request kind <code>PiiEntityRecognition</code>.</li>
            <li>Uses a CharacterMask redaction policy (mask character <code>#</code>).</li>
            <li>Extracts <code>results.documents[0].redactedText</code> into <code>piiAnonymizedContent</code>.</li>
            <li>Emits diagnostics including status code, entity count, entity types, and whether content changed.</li>
        </ul>
    </li>
    <li>The tenant policy explicitly applies the anonymized content back to the request body using <code>&lt;set-body&gt;</code> and forwards the request.</li>
</ol>

<div class="alert alert-warning">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10Z"/></svg>
    </div>
    <div>
        <strong>Example Redaction</strong><br>
        Input: "My email is alice@example.com and my SSN is 123-45-6789"<br>
        Output: "My email is ##################### and my SSN is ###########"
    </div>
</div>

<h2>Configuration Guide</h2>

<h3>Shared Configuration (All Environments)</h3>

<p>PII detection depends on the shared Language Service being enabled via <code>shared_config.language_service.enabled</code> and integrated into APIM via <code>piiServiceUrl</code>. Language Service is configured for private access (no public network access) and is connected through a private endpoint.</p>

<h3>Per-Tenant Configuration</h3>

<p>PII anonymization is controlled per tenant via APIM policy settings (<code>apim_policies.pii_redaction.enabled</code>). The tenant API policy generation includes PII only when tenant PII redaction is enabled and the shared Language Service is enabled.</p>

<pre><code># Example tenant policy flags
apim_policies {
  pii_redaction {
    enabled                 = true

    # Optional: Fail-closed mode (default: false)
    # When true: blocks requests with 503 if Language Service fails
    # When false: passes through unredacted content on failure (fail-open)
    fail_closed             = false

    # Optional: Exclude specific PII categories from detection
    excluded_categories     = ["PhoneNumber", "Address"]

    # Optional: Language for detection (default: "en")
    detection_language      = "en"

    # Optional: Preserve JSON structure (default: true)
    preserve_json_structure = true

    # Optional: Additional values to preserve (whitelist)
    structural_whitelist    = ["customRole", "metadata"]
  }
  rate_limiting {
    enabled = true
    tokens_per_minute = 10000
  }
  usage_logging {
    enabled = true
  }
  streaming_metrics {
    enabled = true
  }
  tracking_dimensions {
    enabled = true
  }
}
</code></pre>

<h4>PII Redaction Configuration Options</h4>

<table>
    <thead>
        <tr>
            <th>Option</th>
            <th>Type</th>
            <th>Default</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>enabled</code></td>
            <td>boolean</td>
            <td>false</td>
            <td>Enable or disable PII redaction for this tenant</td>
        </tr>
        <tr>
            <td><code>fail_closed</code></td>
            <td>boolean</td>
            <td>false</td>
            <td>Controls failure behavior when Language Service is unavailable. When <code>true</code>, blocks requests with HTTP 503 error if PII service fails (fail-closed mode). When <code>false</code> (default), allows requests through with unredacted content on failure (fail-open mode). See FAQ below for details on choosing between modes.</td>
        </tr>
        <tr>
            <td><code>excluded_categories</code></td>
            <td>list(string)</td>
            <td>[]</td>
            <td>PII categories to exclude from detection (e.g., ["PhoneNumber", "Address"]). See <a href="https://learn.microsoft.com/en-us/azure/ai-services/language-service/personally-identifiable-information/concepts/entity-categories">Microsoft Learn</a> for available categories.</td>
        </tr>
        <tr>
            <td><code>detection_language</code></td>
            <td>string</td>
            <td>"en"</td>
            <td>Language code for PII detection. Controls detection accuracy for language-specific entities.</td>
        </tr>
        <tr>
            <td><code>preserve_json_structure</code></td>
            <td>boolean</td>
            <td>true</td>
            <td>Restore structural JSON values after redaction to prevent breaking JSON structure (e.g., "user", "system", "assistant" roles in OpenAI messages)</td>
        </tr>
        <tr>
            <td><code>structural_whitelist</code></td>
            <td>list(string)</td>
            <td>[]</td>
            <td>Additional quoted string values to preserve beyond default whitelist (OpenAI roles). Use for custom structural fields that shouldn't be redacted.</td>
        </tr>
    </tbody>
</table>

<div class="card card-gold">
    <h3 style="margin-top: 0;">Flexible Tenant Control</h3>
    <p>Each tenant can independently enable or disable PII redaction based on their specific requirements. This allows for granular control over data privacy settings while sharing the same infrastructure.</p>
</div>

<h2>Security Model</h2>

<div class="grid grid-2">
    <div class="card">
        <h3 style="margin-top: 0;">Managed Identity Authentication</h3>
        <p>Language Service uses managed identity only (<code>local_auth_enabled = false</code>) rather than API keys. This eliminates the need for credential rotation and follows Azure security best practices.</p>
    </div>
    <div class="card">
        <h3 style="margin-top: 0;">Private Network Access</h3>
        <p>Language Service network ACLs default to deny and it is accessed via a private endpoint. APIM is granted access via RBAC (<code>Cognitive Services User</code> role).</p>
    </div>
</div>

<p>APIM policy calls use AAD tokens (Authorization Bearer) and remove any <code>api-key</code> header before calling Cognitive Services APIs.</p>

<h2>Observability</h2>

<h3>PII Detection Diagnostics</h3>

<p>The <code>pii-anonymization</code> fragment emits rich diagnostic traces to Application Insights, including:</p>

<ul>
    <li><strong>pii-status-code:</strong> HTTP response status from Language Service API call</li>
    <li><strong>pii-entity-count:</strong> Number of PII entities detected in the request</li>
    <li><strong>pii-entity-types:</strong> Comma-separated list of entity categories found (e.g., "Email,SSN,CreditCard")</li>
    <li><strong>pii-content-changed:</strong> Boolean flag indicating whether any redaction occurred</li>
    <li><strong>request-id:</strong> Correlation ID for tracing the request across services</li>
    <li><strong>tenant-id:</strong> Tenant identifier for per-tenant analytics</li>
</ul>

<p>These diagnostics enable monitoring of PII detection effectiveness, understanding which entity types are most commonly detected, and tracking Language Service API health.</p>

<h3>OpenAI Usage Logging</h3>

<p>For OpenAI requests, the tenant policy template sets routing metadata variables before including the <code>openai-usage-logging</code> fragment:</p>

<ul>
    <li><strong>backendId:</strong> APIM backend identifier (e.g., <code>tenant-openai</code>)</li>
    <li><strong>routeLocation:</strong> Azure region for the backend (single-backend for now)</li>
    <li><strong>routeName:</strong> Route identifier for future intelligent routing</li>
    <li><strong>deploymentName:</strong> Extracted from the URL path (e.g., <code>gpt-4</code>)</li>
</ul>

<p>These dimensions are logged to Application Insights along with token usage data, enabling detailed cost allocation, chargeback analytics, and deployment-level monitoring even in the current single-backend setup.</p>

<h3>Additional Monitoring Fragments</h3>

<table>
    <thead>
        <tr>
            <th>Fragment</th>
            <th>Purpose</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>tracking-dimensions</code></td>
            <td>Extract session, user, app, and correlation IDs from headers</td>
            <td>Active</td>
        </tr>
        <tr>
            <td><code>openai-usage-logging</code></td>
            <td>Detailed usage tracking to Application Insights with routing metadata</td>
            <td>Active</td>
        </tr>
        <tr>
            <td><code>openai-streaming-metrics</code></td>
            <td>Token metrics for streaming responses</td>
            <td>Reserved for future use</td>
        </tr>
        <tr>
            <td><code>intelligent-routing</code></td>
            <td>Priority-based multi-backend selection</td>
            <td>Reserved for future use</td>
        </tr>
    </tbody>
</table>

<h2>Frequently Asked Questions</h2>

<details>
    <summary><strong>What kinds of entities are supported?</strong></summary>
    <div class="accordion-content">
        <p>The PII fragment is designed for enterprise PII detection and supports names, addresses, SSN, medical terms, financial data, and many other entity types. Azure Language Service uses machine learning to detect entities based on context.</p>
    </div>
</details>

<details>
    <summary><strong>What happens if Language Service fails?</strong></summary>
    <div class="accordion-content">
        <p>Failure behavior is controlled by the <code>fail_closed</code> configuration setting:</p>

        <h4>Fail-Open Mode (fail_closed = false, default)</h4>
        <p>PII redaction operates on a <strong>best-effort basis</strong>. If Language Service fails:</p>
        <ul>
            <li>If the Language Service returns a non-200 response, the original unredacted content is passed through</li>
            <li>If the response cannot be parsed, the original unredacted content is passed through</li>
            <li>If the Language Service is temporarily unavailable, requests continue to flow without redaction</li>
            <li>All failures are logged in diagnostics with appropriate status codes and error details</li>
        </ul>
        <p><strong>Use when:</strong> Service availability is prioritized over PII protection, or when PII redaction is a defense-in-depth measure rather than a strict requirement.</p>

        <h4>Fail-Closed Mode (fail_closed = true)</h4>
        <p>PII redaction is <strong>strictly enforced</strong>. If Language Service fails:</p>
        <ul>
            <li>If the Language Service returns a non-200 response, the request is blocked with HTTP 503</li>
            <li>If the response cannot be parsed, the request is blocked with HTTP 503</li>
            <li>If the Language Service is unavailable, all requests are blocked until service is restored</li>
            <li>Clients receive a JSON error response with code <code>PiiRedactionUnavailable</code></li>
        </ul>
        <p><strong>Use when:</strong> Strict PII protection is required and no unredacted content should reach downstream services. Ensures that sensitive data is never exposed, even during service outages.</p>

        <p><strong>Configuration example:</strong></p>
        <pre><code>pii_redaction {
  enabled     = true
  fail_closed = true  # Block requests if PII service fails
}</code></pre>
    </div>
</details>

<details>
    <summary><strong>Does this apply to all requests?</strong></summary>
    <div class="accordion-content">
        <p>PII anonymization is tenant-controlled and is applied (in the current routing) for OpenAI requests when enabled via <code>apim_policies.pii_redaction.enabled</code>.</p>
    </div>
</details>

<details>
    <summary><strong>What is the performance impact?</strong></summary>
    <div class="accordion-content">
        <p>PII anonymization adds an extra network call from APIM to Language Service for requests where it is enabled. The Language Service call uses a fixed timeout of 20 seconds. For most requests, the latency impact is minimal (typically under 500ms).</p>
    </div>
</details>

<details>
    <summary><strong>Can I customize which entity types are redacted?</strong></summary>
    <div class="accordion-content">
        <p>Yes. Use the <code>excluded_categories</code> setting in <code>apim_policies.pii_redaction</code> to specify PII categories that should not be detected or redacted. For example:</p>
        <pre><code>pii_redaction {
  enabled = true
  excluded_categories = ["PhoneNumber", "Address"]
}</code></pre>
        <p>See <a href="https://learn.microsoft.com/en-us/azure/ai-services/language-service/personally-identifiable-information/concepts/entity-categories">Microsoft Learn: PII Entity Categories</a> for the full list of available categories.</p>
    </div>
</details>

<details>
    <summary><strong>How does "preserve JSON structure" work?</strong></summary>
    <div class="accordion-content">
        <p>The <code>preserve_json_structure</code> feature (enabled by default) uses a heuristic post-processing step to restore certain quoted string values that were masked by Language Service but are actually structural JSON fields rather than PII.</p>
        <p><strong>How it works:</strong></p>
        <ul>
            <li>After Language Service redacts the content (replacing PII with <code>#####</code> patterns), the fragment identifies masked values that match known structural patterns</li>
            <li>Default whitelist includes OpenAI message roles: <code>"user"</code>, <code>"system"</code>, <code>"assistant"</code>, <code>"function"</code>, <code>"tool"</code></li>
            <li>Custom values can be added via <code>structural_whitelist</code> configuration</li>
            <li>Restoration matches based on the length of the <code>####</code> pattern (e.g., <code>"####"</code> could restore to <code>"user"</code>)</li>
        </ul>
        <p><strong>Example:</strong> If Language Service masks <code>"role": "user"</code> as <code>"role": "####"</code>, the post-processing step restores it to <code>"role": "user"</code> because <code>"user"</code> is in the default whitelist.</p>
        <p><strong>Caution:</strong> This is a heuristic approach based on pattern matching. It reduces false positives on structural fields but could theoretically restore a value that happens to match both the pattern length and whitelist entry. For strict PII protection requirements, consider setting <code>preserve_json_structure = false</code>.</p>
    </div>
</details>

<h2>Troubleshooting</h2>

<table>
    <thead>
        <tr>
            <th>Issue</th>
            <th>Cause</th>
            <th>Solution</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>401/403 calling Language Service</td>
            <td>Missing or incorrect RBAC permissions</td>
            <td>Verify APIM managed identity has the <code>Cognitive Services User</code> role assignment on the Language Service resource</td>
        </tr>
        <tr>
            <td>DNS / private endpoint not ready</td>
            <td>Private DNS zone integration incomplete</td>
            <td>Deployment includes a DNS wait step; ensure private DNS zone integration is complete before testing</td>
        </tr>
        <tr>
            <td>Transient failures after deploy</td>
            <td>Role assignment propagation delay</td>
            <td>Role assignment propagation can cause temporary failures until RBAC takes effect (typically 5-10 minutes)</td>
        </tr>
        <tr>
            <td>No redaction occurring</td>
            <td>PII detection not enabled</td>
            <td>Confirm tenant <code>apim_policies.pii_redaction.enabled</code> is true and shared <code>language_service.enabled</code> is true</td>
        </tr>
    </tbody>
</table>

<div class="alert alert-info">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    </div>
    <div>
        <strong>For Technical Details</strong><br>
        See the <a href="https://github.com/bcgov/ai-hub-tracking/blob/main/infra-ai-hub/params/apim/README.md">APIM Policy README</a> for deep technical documentation on policy fragments, infrastructure components, and configuration schema.
    </div>
</div>
