<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHubWorkflows | AI Services Hub</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <style>
        :root {
            --bc-blue: #003366;
            --bc-gold: #fcba19;
            --bc-blue-dark: #002244;
            --bc-blue-light: #1a5a96;
            --text-primary: #313132;
            --text-secondary: #606060;
            --bg-light: #f2f2f2;
            --white: #ffffff;
            --gradient-hero: linear-gradient(135deg, #003366 0%, #1a5a96 50%, #003366 100%);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Offset anchor scroll so the sticky header never covers the target */
        html {
            scroll-padding-top: 80px;
        }

        body {
            font-family: 'BC Sans', 'Noto Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .bc-header {
            background: var(--gradient-hero);
            border-bottom: 4px solid var(--bc-gold);
            padding: 0.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .bc-header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }

        .bc-header-logo {
            height: 36px;
            width: auto;
            border-radius: 4px;
        }

        .bc-header-title {
            color: var(--white);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .bc-header-subtitle {
            color: var(--bc-gold);
            font-size: 0.875rem;
        }

        /* Navigation with Dropdowns */
        .bc-nav {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .bc-nav > a,
        .nav-dropdown > .nav-trigger {
            color: var(--white);
            text-decoration: none;
            padding: 0.6rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            border: none;
            background: transparent;
            font-family: inherit;
        }

        .bc-nav > a:hover,
        .nav-dropdown:hover > .nav-trigger {
            background: rgba(255,255,255,0.15);
        }

        .bc-nav > a.active {
            background: var(--bc-gold);
            color: var(--bc-blue);
            font-weight: 600;
        }

        /* Dropdown */
        .nav-dropdown {
            position: relative;
        }

        .nav-trigger::after {
            content: '';
            border: solid currentColor;
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(45deg);
            margin-top: -3px;
            transition: transform 0.2s;
        }

        .nav-dropdown:hover .nav-trigger::after {
            transform: rotate(-135deg);
            margin-top: 3px;
        }

        .nav-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .nav-dropdown:hover .nav-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nav-dropdown-menu a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-dropdown-menu a:hover {
            background: var(--bg-light);
            border-left-color: var(--bc-gold);
            color: var(--bc-blue);
        }

        .nav-dropdown-menu a.active {
            background: #fef9e7;
            border-left-color: var(--bc-gold);
            border-left-width: 4px;
            color: var(--bc-blue);
            font-weight: 600;
        }

        .nav-dropdown-menu a small {
            display: block;
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 0.2rem;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
            width: 100%;
        }

        /* Hero Section */
        .hero {
            background: var(--gradient-hero);
            color: var(--white);
            padding: 3rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .hero h1 {
            color: var(--white);
            border: none;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Typography */
        h1 {
            color: var(--bc-blue);
            font-size: 2.25rem;
            margin-bottom: 1rem;
            border-bottom: 3px solid var(--bc-gold);
            padding-bottom: 0.5rem;
        }

        h2 {
            color: var(--bc-blue);
            font-size: 1.5rem;
            margin: 2rem 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 1.5rem;
            background: var(--bc-gold);
            border-radius: 2px;
        }

        h3 {
            color: var(--bc-blue-light);
            font-size: 1.25rem;
            margin: 1.5rem 0 0.75rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* Cards - Enhanced */
        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--bc-blue);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-gold {
            border-left-color: var(--bc-gold);
        }

        .card h3 {
            margin-top: 0;
        }

        /* Clickable Cards */
        a.card-link {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        a.card-link .card {
            cursor: pointer;
        }

        a.card-link .card:hover {
            border-left-width: 6px;
        }

        .card-arrow {
            color: var(--bc-blue-light);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            transition: var(--transition);
        }

        a.card-link:hover .card-arrow {
            gap: 0.75rem;
            color: var(--bc-blue);
        }

        /* Feature Cards */
        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .feature-icon.gold { background: rgba(252, 186, 25, 0.15); }
        .feature-icon.blue { background: rgba(0, 51, 102, 0.1); }
        .feature-icon.green { background: rgba(34, 197, 94, 0.1); }
        .feature-icon.purple { background: rgba(139, 92, 246, 0.1); }

        /* Stats */
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--bc-gold);
            line-height: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Code blocks */
        pre {
            background: var(--bc-blue-dark);
            color: #e2e8f0;
            padding: 1.25rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.875rem;
            box-shadow: var(--shadow-sm);
        }

        code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: #e2e8f0;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        pre code {
            background: none;
            padding: 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        th {
            background: var(--bc-blue);
            color: var(--white);
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f8fafc;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        /* Links */
        a {
            color: var(--bc-blue-light);
            transition: var(--transition);
        }

        a:hover {
            color: var(--bc-blue);
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert > * {
            min-width: 0;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-info {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-left: 4px solid #0ea5e9;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--bc-gold);
        }

        .alert-success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left: 4px solid #22c55e;
        }

        /* Image containers */
        .img-container {
            margin: 1.5rem 0;
            text-align: center;
        }

        .img-container img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-gold {
            background: var(--bc-gold);
            color: var(--bc-blue);
        }

        .badge-blue {
            background: var(--bc-blue);
            color: var(--white);
        }

        /* Accordion / Collapsible */
        details {
            background: var(--white);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--bc-blue);
            overflow: hidden;
            transition: var(--transition);
        }

        details:hover {
            box-shadow: var(--shadow-md);
        }

        details[open] {
            border-left-color: var(--bc-gold);
        }

        summary {
            padding: 1rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--bc-blue);
            display: flex;
            align-items: center;
            justify-content: space-between;
            list-style: none;
            user-select: none;
            transition: var(--transition);
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::after {
            content: '';
            border: solid var(--bc-blue-light);
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 4px;
            transform: rotate(-45deg);
            transition: transform 0.2s ease;
            flex-shrink: 0;
            margin-left: 1rem;
        }

        details[open] summary::after {
            transform: rotate(45deg);
        }

        summary:hover {
            background: var(--bg-light);
        }

        details[open] summary {
            border-bottom: 1px solid #e2e8f0;
            background: var(--bg-light);
        }

        .accordion-content {
            padding: 1rem 1.25rem;
        }

        .accordion-content p:last-child {
            margin-bottom: 0;
        }

        /* Accordion with badge */
        summary .badge {
            margin-left: auto;
            margin-right: 1rem;
        }

        /* Accordion group */
        .accordion-group {
            margin: 1rem 0;
        }

        .accordion-group details:last-child {
            margin-bottom: 0;
        }

        /* Footer */
        .site-footer {
            background: var(--bc-blue);
            color: var(--white);
            padding: 3rem 2rem;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }

        .footer-brand h4,
        .footer-links h4 {
            color: var(--bc-gold);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .footer-brand p {
            color: #94a3b8;
            font-size: 0.875rem;
            margin: 0;
        }

        .footer-links ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-links li {
            margin-bottom: 0.5rem;
        }

        .footer-links a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .footer-links a:hover {
            color: var(--bc-gold);
        }

        .footer-copyright {
            text-align: right;
        }

        .footer-copyright p {
            color: #64748b;
            font-size: 0.75rem;
            margin: 0;
        }

        .footer-meta {
            margin-top: 0.5rem !important;
            opacity: 0.7;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .bc-header {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }

            .bc-nav {
                justify-content: center;
            }

            .nav-dropdown-menu {
                position: fixed;
                left: 1rem;
                right: 1rem;
                width: auto;
            }

            main {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .hero {
                padding: 2rem 1rem;
            }

            .hero h1 {
                font-size: 1.75rem;
            }

            .footer-content {
                text-align: center;
            }

            .footer-copyright {
                text-align: center;
            }
        }

        /* =====================================================================
           SEARCH – button, modal, results, breadcrumb, highlight
           ===================================================================== */

        /* Search button in header nav */
        .search-btn {
            color: var(--white);
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            padding: 0.45rem 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.875rem;
            font-family: inherit;
            transition: var(--transition);
            white-space: nowrap;
        }

        .search-btn:hover {
            background: rgba(255,255,255,0.28);
        }

        .search-btn svg { flex-shrink: 0; }

        .search-btn-kbd {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            padding: 1px 6px;
            font-size: 0.72rem;
            line-height: 1.5;
            letter-spacing: 0.02em;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* Modal overlay */
        .search-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 20, 50, 0.65);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            align-items: flex-start;
            justify-content: center;
            padding: 6vh 1rem 1rem;
        }

        .search-modal--active {
            display: flex;
        }

        /* Modal box */
        .search-box {
            background: var(--white);
            border-radius: 14px;
            box-shadow: 0 24px 72px rgba(0,0,0,0.35);
            width: 100%;
            max-width: 680px;
            max-height: 82vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: search-appear 0.18s ease;
        }

        @keyframes search-appear {
            from { opacity: 0; transform: translateY(-14px) scale(0.97); }
            to   { opacity: 1; transform: translateY(0)  scale(1); }
        }

        /* Input row */
        .search-input-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.9rem 1.1rem;
            border-bottom: 1px solid #e5e9f0;
            flex-shrink: 0;
        }

        .search-input-row svg { color: var(--text-secondary); flex-shrink: 0; }

        #search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1.05rem;
            color: var(--text-primary);
            background: transparent;
            font-family: inherit;
            min-width: 0;
        }

        #search-input::placeholder { color: #a0aec0; }

        .search-modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.4rem;
            line-height: 1;
            padding: 0.2rem 0.45rem;
            border-radius: 6px;
            transition: background 0.15s, color 0.15s;
        }

        .search-modal-close:hover {
            background: var(--bg-light);
            color: var(--text-primary);
        }

        /* Results list */
        .search-results {
            overflow-y: auto;
            flex: 1;
        }

        .search-count {
            padding: 0.5rem 1.1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            border-bottom: 1px solid #f0f3f8;
            background: #fafbfd;
        }

        .search-result-item {
            display: block;
            padding: 0.9rem 1.1rem;
            border-bottom: 1px solid #f0f3f8;
            text-decoration: none;
            color: inherit;
            transition: background 0.12s;
            outline: none;
        }

        .search-result-item:hover,
        .search-result-item:focus {
            background: #f4f7fc;
        }

        .search-result-meta {
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #996600;
            margin-bottom: 0.2rem;
        }

        .search-result-title {
            font-weight: 600;
            color: var(--bc-blue);
            margin-bottom: 0.3rem;
            font-size: 0.97rem;
        }

        .search-result-excerpt {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.55;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .search-result-item mark {
            background: rgba(252, 186, 25, 0.45);
            color: inherit;
            border-radius: 2px;
            padding: 0 1px;
        }

        .search-no-results {
            padding: 2.5rem 1rem;
            text-align: center;
            color: var(--text-secondary);
        }

        .search-no-results svg {
            display: block;
            margin: 0 auto 0.75rem;
            opacity: 0.4;
        }

        .search-no-results p { margin: 0; font-size: 0.95rem; }

        .search-loading {
            padding: 1.5rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Modal footer hints */
        .search-hints {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.55rem 1.1rem;
            border-top: 1px solid #e5e9f0;
            background: #fafbfd;
            font-size: 0.75rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .search-hints kbd {
            display: inline-block;
            background: var(--white);
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 1px 5px;
            font-family: inherit;
            font-size: 0.72rem;
            line-height: 1.6;
        }

        /* ── Breadcrumb bar ───────────────────────────────────────────────── */
        #search-breadcrumb {
            display: none;
            background: var(--white);
            border: 1px solid #dde3ed;
            border-radius: 8px;
            padding: 0.65rem 1.1rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .breadcrumb-nav {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.875rem;
            flex-wrap: wrap;
        }

        .breadcrumb-nav a {
            color: var(--bc-blue-light);
            text-decoration: none;
        }

        .breadcrumb-nav a:hover {
            text-decoration: underline;
            color: var(--bc-blue);
        }

        .breadcrumb-current {
            color: var(--text-primary);
            font-weight: 600;
        }

        .breadcrumb-sep { color: #94a3b8; }

        /* ── Section highlight flash ──────────────────────────────────────── */
        @keyframes section-flash {
            0%   { background-color: rgba(252, 186, 25, 0.45); box-shadow: 0 0 0 4px rgba(252,186,25,0.25); }
            60%  { background-color: rgba(252, 186, 25, 0.15); }
            100% { background-color: transparent; box-shadow: none; }
        }

        .search-highlight {
            animation: section-flash 2.2s ease-out forwards;
            border-radius: 4px;
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.31/dist/flexsearch.bundle.js" defer></script>
    <script src="assets/search.js" defer id="search-script"></script>
</head>
<body>
    <header class="bc-header">
        <a href="index.html" class="bc-header-brand">
            <img src="assets/bc_citz_logo.jpg" alt="BC Government" class="bc-header-logo">
            <div>
                <div class="bc-header-title">AI Services Hub</div>
                <div class="bc-header-subtitle">Azure Landing Zone Infrastructure</div>
            </div>
        </a>
        <nav class="bc-nav">
            <a href="index.html" class="">Home</a>
            <div class="nav-dropdown">
                <span class="nav-trigger">For Tenants</span>
                <div class="nav-dropdown-menu">
                    <a href="services.html" class="">
                        AI Services
                        <small>Available models &amp; services catalogue</small>
                    </a>
                    <a href="language-service-pii.html" class="">
                        Language Service PII
                        <small>ML-based PII detection &amp; APIM</small>
                    </a>
                    <a href="apim-internal-endpoints.html" class="">
                        APIM Internal Endpoints
                        <small>tenant-info &amp; apim-keys API reference</small>
                    </a>
                    <a href="apim-key-rotation.html" class="">
                        APIM Key Rotation
                        <small>Subscription key auto-rotation</small>
                    </a>
                </div>
            </div>
            <div class="nav-dropdown">
                <span class="nav-trigger">For AI Hub Admins</span>
                <div class="nav-dropdown-menu">
                    <a href="playbooks.html" class="">
                        Playbooks
                        <small>Operational runbooks &amp; how-to guides</small>
                    </a>
                    <a href="oidc-setup.html" class="">
                        OIDC Setup
                        <small>GitHub to Azure authentication</small>
                    </a>
                    <a href="workflows.html" class="active">
                        GitHub Workflows
                        <small>CI/CD automation</small>
                    </a>
                    <a href="terraform-reference.html" class="">
                        TF Reference
                        <small>Auto-generated from code</small>
                    </a>
                    <a href="technical-deep-dive.html" class="">
                        Technical Deep Dive
                        <small>Control/data plane &amp; Chisel architecture</small>
                    </a>
                </div>
            </div>
            <a href="diagrams.html" class="">Diagrams</a>
            <a href="decisions.html" class="">ADRs</a>
            <a href="cost.html" class="">Cost</a>
            <a href="faq.html" class="">FAQ</a>

            <!-- Search button -->
            <button class="search-btn" id="search-btn" type="button" aria-label="Search documentation">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                Search
                <span class="search-btn-kbd" aria-label="keyboard shortcut">⌘K</span>
            </button>
        </nav>
    </header>

    <!-- ── Search modal ──────────────────────────────────────────────────── -->
    <div class="search-modal" id="search-modal" role="dialog" aria-modal="true" aria-label="Search documentation">
        <div class="search-box">
            <div class="search-input-row">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input
                    type="search"
                    id="search-input"
                    placeholder="Search documentation…"
                    autocomplete="off"
                    spellcheck="false"
                    aria-label="Search query"
                />
                <button class="search-modal-close" id="search-modal-close" type="button" aria-label="Close search">✕</button>
            </div>
            <div class="search-results" id="search-results" role="listbox" aria-label="Search results"></div>
            <div class="search-hints" aria-hidden="true">
                <span><kbd>↑</kbd><kbd>↓</kbd> navigate</span>
                <span><kbd>↵</kbd> open</span>
                <span><kbd>Esc</kbd> close</span>
                <span style="margin-left:auto"><kbd>⌘K</kbd> or <kbd>Ctrl+K</kbd></span>
            </div>
        </div>
    </div>

    <main>
        <!-- Breadcrumb: injected by search.js when arriving from a search result -->
        <div id="search-breadcrumb" aria-label="Search breadcrumb"></div>

<h1 id="github-actions-workflows">GitHub Actions Workflows</h1>

<p>This project uses GitHub Actions for automated infrastructure deployments with OIDC authentication to Azure.</p>

<h2 id="workflow-overview">Workflow Overview</h2>

<table>
    <thead>
        <tr>
            <th>Workflow</th>
            <th>Trigger</th>
            <th>Purpose</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>.builds.yml</strong></td>
            <td>Called by other workflows</td>
            <td>Reusable container build workflow for azure-proxy images</td>
        </tr>
        <tr>
            <td><strong>.deployer.yml</strong></td>
            <td>Called by other workflows</td>
            <td>Reusable Terraform deployer for <code>initial-setup/infra</code> (tools bootstrap and module-level operations)</td>
        </tr>
        <tr>
            <td><strong>.deployer-using-secure-tunnel.yml</strong></td>
            <td>Called by other workflows</td>
            <td>Reusable Terraform deployer for <code>infra-ai-hub</code> through Chisel + Privoxy secure tunnel</td>
        </tr>
        <tr>
            <td><strong>.lint.yml</strong></td>
            <td>Called by other workflows</td>
            <td>Reusable validation: pre-commit (<code>terraform fmt</code> + <code>tflint</code>), conventional commits, fork check</td>
        </tr>
        <tr>
            <td><strong>add-or-remove-module.yml</strong></td>
            <td>Manual (workflow_dispatch)</td>
            <td>Deploy or destroy selected tools modules (bastion, azure_proxy, jumpbox, github_runners_aca)</td>
        </tr>
        <tr>
            <td><strong>manual-dispatch.yml</strong></td>
            <td>Manual (workflow_dispatch)</td>
            <td>Run <code>plan/apply/destroy</code> for dev/test/prod; prod apply requires a semver tag (e.g. <code>v1.2.3</code>) and creates a GitHub Release</td>
        </tr>
        <tr>
            <td><strong>merge-main.yml</strong></td>
            <td>Push to <code>main</code></td>
            <td>Automatic post-merge: semantic version tag via conventional commits, apply infrastructure to test</td>
        </tr>
        <tr>
            <td><strong>pr-open.yml</strong></td>
            <td>Pull request events + manual trigger</td>
            <td>PR validation: lint, container builds, deploy proxy in tools, and plan against test</td>
        </tr>
        <tr>
            <td><strong>schedule.yml</strong></td>
            <td>Cron (daily at 5 PM PST)</td>
            <td>Auto-destroy Bastion for cost savings</td>
        </tr>
        <tr>
            <td><strong>apim-key-rotation.yml</strong></td>
            <td>Daily cron + manual trigger</td>
            <td>Rotate APIM subscription keys across environments (manual single-env or scheduled all-env flow)</td>
        </tr>
        <tr>
            <td><strong>pages.yml</strong></td>
            <td>Push to main (docs and Terraform roots) + manual trigger</td>
            <td>Generate docs and deploy GitHub Pages site</td>
        </tr>
    </tbody>
</table>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="developer-sdlc-flow-branch-pr-test-prod">Developer SDLC Flow (Branch → PR → TEST → PROD)</h2>

<p>The repository enforces a promote-through-environments workflow. Every change flows through a validated path before reaching production.</p>

<ol>
    <li><strong>Create feature branch</strong> from <code>main</code> (e.g. <code>feat/&lt;work-item&gt;</code>, <code>fix/&lt;issue&gt;</code>) and commit changes.</li>
    <li><strong>Open PR</strong> to <code>main</code>, which triggers <code>pr-open.yml</code>:
        <ul>
            <li>Lint (pre-commit: terraform fmt + tflint, conventional commit title, fork check)</li>
            <li>Container image builds</li>
            <li>Terraform plan against <code>test</code> (via secure tunnel) — summary appended to PR description</li>
        </ul>
    </li>
    <li><strong>Merge to main</strong> once PR checks and code review pass.</li>
    <li><strong>Auto-apply to test + semver tag</strong>: <code>merge-main.yml</code> starts two jobs concurrently — semantic versioning (conventional commit history → <code>v1.2.3</code> tag + <code>CHANGELOG.md</code> update) and proxy bootstrap in <code>tools</code>. Once the proxy is up, it applies infrastructure to <code>test</code> through the Chisel tunnel. After a successful apply, integration tests run automatically (two phases — see below).</li>
    <li><strong>Promote to prod</strong>: Use <code>manual-dispatch.yml</code>, select <code>prod</code> + <code>apply</code>, and provide the semver tag. <strong>This is gated — requires approval from designated reviewers</strong> (configured in the GitHub <code>prod</code> environment protection rules).</li>
    <li><strong>Release created</strong>: After successful prod apply, a GitHub Release is automatically created from the deployed tag with deployment metadata.</li>
</ol>

<div class="alert alert-warning">
    <div><strong>PROD is gated:</strong> The <code>prod</code> environment has required reviewers configured as a GitHub Environment protection rule. Any workflow job targeting <code>prod</code> will pause and wait for manual approval before executing. Only designated reviewers can approve.</div>
</div>

<div class="alert alert-info">
    <div><strong>Developer branch testing (occasional):</strong> Developers can run manual dispatch to <code>dev</code> from a feature/PR branch for targeted validation; use this sparingly and co-ordinate with other devs. The <code>dev</code> environment does <strong>not</strong> include App Gateway or DNS Zone — full ingress path validation is only available in <code>test</code> and <code>prod</code>.</div>
</div>

<pre>Feature Branch
   │
   └── Pull Request ──► pr-open.yml
                        ├─ .lint.yml (fmt, tflint, conventional commits, fork check)
                        ├─ .builds.yml
                        ├─ .deployer.yml (tools/azure_proxy)
                        ├─ .deployer-using-secure-tunnel.yml (test plan)
                        └─ Update PR description with plan summary
                                  │
                                  ▼
                             Merge to main
                                  │
                                  ▼
                        merge-main.yml
                        ├─ Semantic version tag (v1.2.3) ─────────────────── concurrent
                        ├─ Deploy azure_proxy (tools) ───────────────────────────────┤
                        └─ Apply to test (via Chisel tunnel)
                             └─ Integration tests (post-apply)
                                  ├─ Direct: all tests except apim-key-rotation.bats
                                  └─ Via proxy: apim-key-rotation.bats (KV private endpoint)
                                  │
                                  ▼
                        manual-dispatch.yml (prod + apply + tag)
                        ├─ ⏸ Requires prod environment approval
                        ├─ Apply to prod using tagged commit
                        └─ Create GitHub Release</pre>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="advanced-branching-patterns">Advanced Branching Patterns</h2>

<p>The basic SDLC flow above covers the single-feature-per-PR path. In practice, teams often need to coordinate dependent work or bundle multiple features into a single release. Two patterns handle this: <strong>Stacked PRs</strong> and <strong>Release PRs</strong>.</p>

<h3 id="stacked-prs-dependent-feature-chains">Stacked PRs (Dependent Feature Chains)</h3>

<p>Use stacked PRs when a feature depends on another feature that hasn't merged to <code>main</code> yet. Each PR in the stack targets the previous branch instead of <code>main</code>.</p>

<div class="card card-gold">
    <h3 id="when-to-use">When to Use</h3>
    <ul>
        <li>Feature B requires infrastructure created by Feature A (e.g. a new subnet added in A is referenced in B)</li>
        <li>Breaking a large change into reviewable, incremental PRs</li>
        <li>Multiple developers working on sequential pieces of a story</li>
    </ul>
</div>

<div class="card">
    <h3 id="how-it-works">How It Works</h3>
    <ol>
        <li>Create <code>feat/base-network</code> from <code>main</code> → open <strong>PR #1</strong> targeting <code>main</code></li>
        <li>Create <code>feat/add-apim-policy</code> from <code>feat/base-network</code> → open <strong>PR #2</strong> targeting <code>feat/base-network</code></li>
        <li>Each PR triggers <code>pr-open.yml</code> independently for lint and plan</li>
        <li>Merge <strong>PR #1</strong> first (bottom of the stack) — this triggers <code>merge-main.yml</code></li>
        <li><strong>Retarget PR #2</strong> to <code>main</code> and rebase onto updated <code>main</code></li>
        <li>Merge <strong>PR #2</strong> — triggers another <code>merge-main.yml</code> run with its own semver tag</li>
    </ol>
</div>

<pre>main ─────────────────────────┬───────────────────┬──────►
   \                          │ merge PR #1        │ merge PR #2
    └─ feat/base-network ─────┘   (v1.3.0)        │
         \                                         │
          └─ feat/add-apim-policy ─── rebase ──────┘
                                                 (v1.4.0)</pre>

<div class="alert alert-warning">
    <div><strong>Important:</strong> Always merge bottom-up. If you merge PR #2 before PR #1, the diff will include both sets of changes and the base branch won't exist in <code>main</code> yet. After merging the base PR, <strong>rebase</strong> the dependent branch onto <code>main</code> to pick up any squash-merge differences before merging.</div>
</div>

<div class="alert alert-info">
    <div><strong>CI Behaviour:</strong> Each PR in the stack runs <code>pr-open.yml</code> against <code>test</code>. The plan for PR #2 will show changes from both branches while PR #1 is open (because the diff includes the base). After PR #1 merges, re-running PR #2's checks shows only its own changes. Each merge to <code>main</code> produces its own semver tag.</div>
</div>

<h3 id="release-prs-bundled-multi-feature-releases">Release PRs (Bundled Multi-Feature Releases)</h3>

<p>Use a Release PR when multiple developers are working on separate features that should ship together as a single coordinated release. All feature branches merge into a shared <strong>release branch</strong>, which then opens one PR to <code>main</code>.</p>

<div class="card card-gold">
    <h3 id="when-to-use-1">When to Use</h3>
    <ul>
        <li>A planned release includes work from multiple developers across different modules</li>
        <li>Features need integration testing together before merging to <code>main</code></li>
        <li>You want one semver tag to represent the entire release bundle (e.g. a sprint deliverable)</li>
        <li>Coordinating breaking changes that span multiple Terraform stacks</li>
    </ul>
</div>

<div class="card">
    <h3 id="how-it-works-1">How It Works</h3>
    <ol>
        <li>Create a release branch from <code>main</code>: <code>release/sprint-42</code> (or <code>release/apim-v2</code>, etc.)</li>
        <li>Developers create feature branches from the release branch:
            <ul>
                <li><code>feat/new-tenant-config</code> → PR targeting <code>release/sprint-42</code></li>
                <li><code>feat/apim-rate-limits</code> → PR targeting <code>release/sprint-42</code></li>
                <li><code>fix/dns-zone-ttl</code> → PR targeting <code>release/sprint-42</code></li>
            </ul>
        </li>
        <li>Feature PRs are reviewed and merged into the release branch (these merges do <strong>not</strong> trigger <code>merge-main.yml</code> since they don't target <code>main</code>)</li>
        <li>Optionally deploy the release branch to <code>dev</code> via <code>manual-dispatch.yml</code> to validate the combined changes</li>
        <li>When all features are complete, open one <strong>Release PR</strong>: <code>release/sprint-42</code> → <code>main</code></li>
        <li>The Release PR triggers <code>pr-open.yml</code> — the plan shows the aggregate of all bundled changes</li>
        <li>Merge the Release PR → <code>merge-main.yml</code> creates one semver tag and applies to <code>test</code></li>
    </ol>
</div>

<pre>main ─────────────────────────────────────────┬──────────►
   \                                           │ merge Release PR
    └─ release/sprint-42 ───┬──────┬──────────┘  (v2.0.0)
         \                  │      │
          ├─ feat/tenant ───┘      │
          │                        │
          └─ feat/rate-limits ─────┘</pre>

<div class="alert alert-info">
    <div><strong>CI Behaviour:</strong> PRs targeting the release branch still trigger <code>pr-open.yml</code> (lint and plan), giving each feature its own review cycle. The final Release PR to <code>main</code> runs the full pipeline and shows a combined plan. Only the merge to <code>main</code> triggers <code>merge-main.yml</code> for semver tagging and test apply.</div>
</div>

<div class="alert alert-warning">
    <div><strong>PR Title Convention:</strong> The Release PR title must follow <a href="https://www.conventionalcommits.org/en/v1.0.0/">Conventional Commits</a> (e.g. <code>feat: sprint 42 release — tenant config and rate limits</code>) since it controls the semver bump. Use <code>feat:</code> for minor, <code>fix:</code> for patch, or include <code>BREAKING CHANGE</code> in the body for major.</div>
</div>

<h3 id="choosing-between-stacked-prs-and-release-prs">Choosing Between Stacked PRs and Release PRs</h3>

<table>
    <thead>
        <tr>
            <th></th>
            <th>Stacked PRs</th>
            <th>Release PR</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Best for</strong></td>
            <td>Sequential/dependent changes by 1–2 developers</td>
            <td>Parallel independent features by multiple developers</td>
        </tr>
        <tr>
            <td><strong>Semver tags</strong></td>
            <td>One tag per merged PR (e.g. v1.3.0, v1.4.0)</td>
            <td>One tag for the entire bundle (e.g. v2.0.0)</td>
        </tr>
        <tr>
            <td><strong>Review granularity</strong></td>
            <td>Each PR is reviewed independently with a focused diff</td>
            <td>Feature PRs reviewed individually; Release PR shows combined diff</td>
        </tr>
        <tr>
            <td><strong>merge-main.yml runs</strong></td>
            <td>Triggers once per PR merged to main</td>
            <td>Triggers once for the entire release</td>
        </tr>
        <tr>
            <td><strong>Risk</strong></td>
            <td>Rebase conflicts after base merges</td>
            <td>Release branch can drift from main if long-lived</td>
        </tr>
        <tr>
            <td><strong>Recommendation</strong></td>
            <td>Keep stacks shallow (2–3 deep max)</td>
            <td>Keep release branches short-lived; rebase from main regularly</td>
        </tr>
    </tbody>
</table>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="when-do-i-need-self-hosted-runners">When Do I Need Self-Hosted Runners?</h2>

<div class="alert alert-info">
    <div>
        <strong>How this platform solves the private-endpoint problem:</strong> All CI/CD in this repo runs on <strong>standard GitHub-hosted runners</strong> (<code>ubuntu-24.04</code>). To reach private endpoints, the Terraform deployer spins up a <strong>Chisel SOCKS tunnel + Privoxy</strong> inside Docker on the runner, routing data-plane traffic through a proxy deployed in the <code>tools</code> VNet. No self-hosted runners are needed for this repo's own pipelines.
        <br><br>
        The optional <strong><code>github_runners_aca</code></strong> module (deployable via <code>add-or-remove-module.yml</code>) can provision self-hosted runners inside the VNet. Use this when <em>other repos</em> or workloads need persistent VNet-internal compute — not for this repo's own CI/CD.
    </div>
</div>

<p>The table below describes the general pattern. Data-plane work that <em>can't</em> use the Chisel tunnel approach — for example, other repos without the proxy setup — would still need self-hosted runners.</p>

<div class="alert alert-info">
    <div><strong>Understanding the Difference:</strong> See <a href="decisions.html#adr-011">ADR-011: Control Plane vs Data Plane</a> for a detailed explanation of why OIDC works for some operations but not others.</div>
</div>

<table>
    <thead>
        <tr>
            <th>Operation</th>
            <th>Plane</th>
            <th>Public Runner?</th>
            <th>Example</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Create resources (VMs, VNets, Key Vault)</td>
            <td style="color: #22c55e;">Control</td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td><code>azurerm_key_vault</code></td>
        </tr>
        <tr>
            <td>Configure settings, RBAC roles</td>
            <td style="color: #22c55e;">Control</td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td><code>azurerm_role_assignment</code></td>
        </tr>
        <tr>
            <td>Deploy private endpoints</td>
            <td style="color: #22c55e;">Control</td>
            <td style="color: #22c55e;">&#10003; Yes</td>
            <td><code>azurerm_private_endpoint</code></td>
        </tr>
        <tr>
            <td><strong>Read/write Key Vault secrets</strong></td>
            <td style="color: #ef4444;">Data</td>
            <td style="color: #ef4444;">&#10007; No</td>
            <td><code>azurerm_key_vault_secret</code></td>
        </tr>
        <tr>
            <td><strong>Read/write Storage blobs</strong></td>
            <td style="color: #ef4444;">Data</td>
            <td style="color: #ef4444;">&#10007; No</td>
            <td><code>azurerm_storage_blob</code></td>
        </tr>
        <tr>
            <td><strong>Terraform state (if private)</strong></td>
            <td style="color: #ef4444;">Data</td>
            <td style="color: #ef4444;">&#10007; No</td>
            <td>Backend storage account</td>
        </tr>
    </tbody>
</table>

<div class="grid grid-2">
    <div class="card" style="border-left-color: #22c55e;">
        <h3 id="public-runners-work-for" style="margin-top: 0;">Public Runners Work For</h3>
        <ul style="margin-bottom: 0;">
            <li>Deploying all infrastructure modules</li>
            <li>Network, Bastion, Jumpbox, Proxy</li>
            <li>Any resource that doesn't read secrets</li>
            <li>Documentation builds (pages.yml)</li>
        </ul>
    </div>
    <div class="card" style="border-left-color: #ef4444;">
        <h3 id="self-hosted-required-for" style="margin-top: 0;">Self-Hosted Required For</h3>
        <ul style="margin-bottom: 0;">
            <li>Terraform using <code>azurerm_key_vault_secret</code></li>
            <li>Private state backend (blocked by PE)</li>
            <li>Any code that reads secrets at plan time</li>
            <li>Database migrations, blob uploads</li>
        </ul>
    </div>
</div>

<div class="alert alert-warning">
    <div><strong>Cost Tip:</strong> If your Terraform doesn't need data plane access, stick with public runners. Self-hosted runners on Container Apps add cost. Only enable <code>github_runners_aca_enabled</code> if you actually need data plane access in CI/CD.</div>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="deployeryml-reusable-workflow">.deployer.yml (Reusable Workflow)</h2>

<p>Reusable Terraform workflow for <code>initial-setup/infra</code>, primarily used to manage the tools environment and targeted foundational modules.</p>

<div class="card">
    <h3 id="inputs">Inputs</h3>
    <table>
        <thead>
            <tr>
                <th>Input</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>environment_name</code></td>
                <td>string</td>
                <td>Target environment name (commonly <code>tools</code>)</td>
            </tr>
            <tr>
                <td><code>command</code></td>
                <td>string</td>
                <td>Terraform command (init, plan, apply, destroy)</td>
            </tr>
            <tr>
                <td><code>target_module</code></td>
                <td>string</td>
                <td>Required module target (for example: <code>azure_proxy</code>, <code>bastion</code>, <code>jumpbox</code>)</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card card-gold">
    <h3 id="key-features">Key Features</h3>
    <ul>
        <li><strong>OIDC Authentication</strong>: Uses <code>azure/login@v2</code> with federated credentials</li>
        <li><strong>Environment Isolation</strong>: Each environment has separate secrets and identity</li>
        <li><strong>Module Targeting</strong>: Deploy specific modules with <code>-target=module.name</code> (supports all modules including azure-proxy)</li>
        <li><strong>Optional Modules</strong>: Deploy only what you need—all modules except <code>network</code> and <code>monitoring</code> can be toggled on/off</li>
        <li><strong>ARM_USE_OIDC</strong>: Enabled for Terraform Azure provider</li>
    </ul>
</div>

<h3 id="required-permissions">Required Permissions</h3>

<pre>permissions:
  id-token: write   # Required for OIDC token generation
  contents: read    # Required for repository checkout</pre>

<div class="alert alert-warning">
    <div><strong>Important:</strong> Without <code>id-token: write</code> permission, the workflow cannot generate the OIDC token needed for Azure authentication.</div>
</div>

<h2 id="deployer-using-secure-tunnelyml-reusable-workflow">.deployer-using-secure-tunnel.yml (Reusable Workflow)</h2>

<p>Reusable Terraform workflow for <code>infra-ai-hub</code>. It receives encrypted proxy outputs from <code>.deployer.yml</code>, starts Chisel + Privoxy, then runs stack deployment and (for apply in dev/test) integration tests.</p>

<div class="card">
    <h3 id="highlights">Highlights</h3>
    <ul>
        <li><strong>Validated environments</strong>: <code>dev</code>, <code>test</code>, <code>prod</code></li>
        <li><strong>Secure tunnel bootstrap</strong>: decrypts <code>proxy_url</code>/<code>proxy_auth</code> with <code>GPG_PASSPHRASE</code></li>
        <li><strong>Proxy-aware Terraform</strong>: sets <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code>, and <code>NO_PROXY</code></li>
        <li><strong>Integration tests</strong> (after successful <code>apply</code> in dev/test) — two phases:
            <ul>
                <li><strong>Direct (no proxy):</strong> all suites <em>except</em> <code>apim-key-rotation.bats</code> — APIM and App Gateway are public endpoints; proxy not required</li>
                <li><strong>Via proxy:</strong> <code>apim-key-rotation.bats</code> only — Key Vault is private-endpoint only (<code>public_network_access_enabled=false</code>), so the KV fallback (<code>az keyvault secret show</code>) must route through the Chisel tunnel</li>
            </ul>
        </li>
    </ul>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="lintyml-reusable-workflow">.lint.yml (Reusable Workflow)</h2>

<p>Reusable validation workflow used by PR checks. Runs Terraform formatting and linting, enforces PR title conventions, and blocks forks.</p>

<div class="card card-gold">
    <h3 id="what-it-runs">What It Runs</h3>
    <ul>
        <li><strong>Pre-commit hooks</strong>: <code>terraform fmt</code> + <code>tflint</code> (diff-based when possible, full-repo fallback)</li>
        <li><strong>Conventional Commits</strong>: Validates PR title follows <a href="https://www.conventionalcommits.org/en/v1.0.0/">Conventional Commits</a> spec (e.g. <code>feat:</code>, <code>fix:</code>, <code>chore:</code>)</li>
        <li><strong>Fork check</strong>: Rejects PRs from forked repositories</li>
        <li><strong>Summary on failure</strong>: When any check fails, prints a consolidated error summary with common reasons</li>
    </ul>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="buildsyml-container-build-workflow">.builds.yml (Container Build Workflow)</h2>

<p>Reusable workflow for building and pushing container images to GitHub Container Registry (GHCR). Supports matrix builds for multiple packages including the azure-proxy services.</p>

<div class="card">
    <h3 id="built-packages">Built Packages</h3>
    <ul>
        <li><strong>azure-proxy/chisel</strong> - Chisel-based secure tunnel server for private network access</li>
        <li><strong>azure-proxy/privoxy</strong> - Privoxy HTTP/SOCKS proxy server</li>
    </ul>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="add-or-remove-moduleyml">add-or-remove-module.yml</h2>

<p>Manual workflow for deploying or destroying infrastructure modules on demand. Evolved from the earlier bastion-only workflow to support all optional modules (bastion, jumpbox, azure_proxy, github_runners_aca).</p>

<div class="grid grid-2">
    <div class="card">
        <h3 id="when-to-use-2">When to Use</h3>
        <ul>
            <li><strong>Deploy Module</strong>: When you need to provision a specific infrastructure module</li>
            <li><strong>Destroy Module</strong>: When done, to save costs or clean up resources</li>
        </ul>
    </div>
    <div class="card">
        <h3 id="how-to-run">How to Run</h3>
        <ol>
            <li>Go to Actions tab in GitHub</li>
            <li>Select "Deploy or Remove Bastion Host"</li>
            <li>Click "Run workflow"</li>
            <li>Choose <code>tools</code>, module, and command</li>
        </ol>
    </div>
</div>

<h3 id="workflow-inputs">Workflow Inputs</h3>

<table>
    <thead>
        <tr>
            <th>Input</th>
            <th>Options</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>environment_name</code></td>
            <td>tools</td>
            <td>Target environment</td>
        </tr>
        <tr>
            <td><code>module</code></td>
            <td>bastion, jumpbox, azure_proxy, github_runners_aca</td>
            <td>Module to deploy or destroy</td>
        </tr>
        <tr>
            <td><code>command</code></td>
            <td>apply, destroy</td>
            <td>Terraform command to execute</td>
        </tr>
    </tbody>
</table>

<div class="alert alert-info">
    <div><strong>Cost Optimization:</strong> Azure Bastion has hourly charges (~$0.19/hour for Basic SKU). Deploy only when needed and destroy when done.</div>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="pr-openyml-pull-request-checks">pr-open.yml (Pull Request Checks)</h2>

<p>Runs on pull request events (and manual dispatch) to provide fast CI signal before merge.</p>

<div class="card card-gold">
    <h3 id="automated-checks">Automated Checks</h3>
    <ul>
        <li><strong>Validation</strong>: Invokes <code>.lint.yml</code> (pre-commit fmt + tflint, conventional commits, fork check)</li>
        <li><strong>Container Build Validation</strong>: Invokes <code>.builds.yml</code> for proxy images</li>
        <li><strong>Tools Proxy Bootstrap</strong>: Invokes <code>.deployer.yml</code> to deploy <code>azure_proxy</code> in <code>tools</code></li>
        <li><strong>Plan Against Test</strong>: Invokes <code>.deployer-using-secure-tunnel.yml</code> with <code>command=plan</code></li>
        <li><strong>PR Description Update</strong>: Appends the test plan summary to the PR description under <em>AI Hub Infra Changes</em></li>
        <li><strong>Final Result</strong>: Reports pass/fail per job with clear ✅/❌ indicators; PR-Description is non-blocking</li>
    </ul>
</div>

<div class="alert alert-info">
    <div><strong>Note:</strong> The pr-open workflow must pass before a PR can be merged. The plan step appends an <em>AI Hub Infra Changes</em> section to the PR description with a readable plan summary; when there are no infra diffs the section says <code>No Changes to AI Hub Infra in this PR</code>.</div>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="scheduleyml-scheduled-cleanup">schedule.yml (Scheduled Cleanup)</h2>

<p>Automatically destroys Bastion every day at 5 PM PST to prevent unnecessary charges.</p>

<div class="card">
    <h3 id="schedule">Schedule</h3>
    <pre># Runs daily at 5 PM PST (1 AM UTC next day)
on:
  schedule:
    - cron: "0 1 * * *"</pre>
</div>

<div class="card card-gold">
    <h3 id="workflow-logic">Workflow Logic</h3>
    <ol>
        <li><strong>Check if Bastion exists</strong>: Uses Azure CLI to query the Bastion resource</li>
        <li><strong>Conditional destroy</strong>: Only runs Terraform destroy if Bastion is found</li>
        <li><strong>Status notification</strong>: Reports whether Bastion was destroyed or already removed</li>
    </ol>
</div>

<h3 id="jobs-flow">Jobs Flow</h3>

<pre>check-and-destroy-bastion
         │
         ├── bastion_exists=true ──► destroy-bastion ──► notification
         │
         └── bastion_exists=false ──────────────────────► notification</pre>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="manual-dispatchyml-manual-promotion-workflow">manual-dispatch.yml (Manual Promotion Workflow)</h2>

<p>Use this workflow to run <code>plan</code>, <code>apply</code>, or <code>destroy</code> for <code>dev</code>, <code>test</code>, and <code>prod</code>.</p>

<div class="card">
    <h3 id="how-it-works-2">How It Works</h3>
    <ol>
        <li>Validates inputs — <strong>prod apply requires a <code>deploy_tag</code></strong> (a semver tag like <code>v1.2.3</code> from a successful <code>merge-main.yml</code> run)</li>
        <li>Deploys/refreshes <code>azure_proxy</code> in <code>tools</code> via <code>.deployer.yml</code></li>
        <li>Passes encrypted proxy outputs to <code>.deployer-using-secure-tunnel.yml</code></li>
        <li>Executes selected Terraform command in chosen environment</li>
        <li><strong>For prod apply only</strong>: Creates a GitHub Release from the deployed tag with deployment metadata</li>
    </ol>
</div>

<div class="alert alert-warning">
    <div><strong>PROD is gated:</strong> The <code>prod</code> environment has <strong>required reviewers</strong> configured as a GitHub Environment protection rule. Any workflow job targeting <code>prod</code> will pause and wait for manual approval from designated reviewers before executing. Additionally, <code>prod apply</code> requires you to specify which semver git tag to deploy — ensuring only test-validated commits reach production.</div>
</div>

<div class="alert alert-info">
    <div><strong>Dev Environment Scope:</strong> Developers may occasionally deploy to <code>dev</code> from a PR branch using workflow dispatch to test specific features. The <code>dev</code> environment does <strong>not</strong> include App Gateway or DNS Zone; end-to-end ingress and DNS validation is only supported in <code>test</code> and <code>prod</code>.</div>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="merge-mainyml-auto-apply-semantic-version-on-main">merge-main.yml (Auto Apply + Semantic Version on Main)</h2>

<p>This workflow runs on every push to <code>main</code>. It creates a semantic version tag using <a href="https://www.conventionalcommits.org/en/v1.0.0/">Conventional Commits</a> and then applies infrastructure to <code>test</code>.</p>

<div class="card">
    <h3 id="execution-flow">Execution Flow</h3>
    <ol>
        <li><strong>Concurrently on push to main</strong>:
            <ul>
                <li><strong>Semantic version</strong>: <code>TriPSs/conventional-changelog-action</code> inspects commits since last tag (<code>feat:</code> → minor, <code>fix:</code> → patch, <code>BREAKING CHANGE</code> → major), creates a git tag (e.g. <code>v1.2.3</code>), and pushes an updated <code>CHANGELOG.md</code></li>
                <li><strong>Proxy bootstrap</strong>: deploys/refreshes <code>azure_proxy</code> in <code>tools</code> via <code>.deployer.yml</code></li>
            </ul>
        </li>
        <li>Once <code>azure_proxy</code> is live, its encrypted URL+auth outputs are passed to <code>.deployer-using-secure-tunnel.yml</code></li>
        <li>Run <code>apply</code> against <code>test</code> (through Chisel tunnel)</li>
        <li>After successful apply, integration tests run automatically in two phases (direct + via proxy — see <code>.deployer-using-secure-tunnel.yml</code> section)</li>
    </ol>
</div>

<div class="alert alert-info">
    <div><strong>Why semver tags?</strong> Semantic version tags serve as the input for prod deployments. When promoting to prod via <code>manual-dispatch.yml</code>, you provide a version tag (e.g. <code>v1.2.3</code>) to ensure the exact commit that passed test is what gets applied to production. The version is derived from commit messages, so <code>feat:</code> and <code>fix:</code> prefixes directly control versioning.</div>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="release-process-test-prod">Release Process (TEST → PROD)</h2>

<p>Production releases follow a tag-based promotion flow:</p>

<div class="card card-gold">
    <h3 id="steps-to-release-to-production">Steps to Release to Production</h3>
    <ol>
        <li>Merge your PR to <code>main</code> — the test deployment and semantic versioning run automatically</li>
        <li>Verify the test deployment succeeded and a version tag was created (visible in Actions summary and repo tags, e.g. <code>v1.2.3</code>)</li>
        <li>Go to <strong>Actions → Deploy to Environments (Manual Dispatch)</strong></li>
        <li>Select: <code>environment=prod</code>, <code>command=apply</code>, <code>deploy_tag=v1.2.3</code></li>
        <li>Click <strong>Run workflow</strong> — the job will pause waiting for <strong>prod environment approval</strong></li>
        <li>A designated reviewer approves the deployment in the Actions UI</li>
        <li>After successful apply, a <strong>GitHub Release</strong> is automatically created with deployment details</li>
    </ol>
</div>

<div class="card">
    <h3 id="release-contents">Release Contents</h3>
    <p>Each GitHub Release created for prod includes:</p>
    <ul>
        <li>The git tag that was deployed</li>
        <li>Commit SHA</li>
        <li>Who triggered the deployment</li>
        <li>Link to the workflow run</li>
        <li>Timestamp</li>
    </ul>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="concurrency-strategy">Concurrency Strategy</h2>

<p>Several workflows and reusable jobs use <code>concurrency</code> to prevent race conditions and conflicting Terraform operations.</p>

<table>
    <thead>
        <tr>
            <th>Workflow/Job</th>
            <th>Concurrency Group</th>
            <th>Why It Helps</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>.deployer.yml</code></td>
            <td><code>tools</code></td>
            <td>Serializes tools/bootstrap changes so multiple runs don't mutate shared proxy infra at the same time.</td>
        </tr>
        <tr>
            <td><code>.deployer-using-secure-tunnel.yml</code></td>
            <td><code>${environment_name}</code></td>
            <td>Ensures only one Terraform operation per environment runs at once (for example, only one test apply).</td>
        </tr>
        <tr>
            <td><code>pr-open.yml</code> builds job</td>
            <td><code>builds-${PR number}</code> (cancel in-progress)</td>
            <td>Stops stale image builds when a newer commit arrives in the same PR.</td>
        </tr>
        <tr>
            <td><code>manual-dispatch.yml</code></td>
            <td><code>manual-deploy-${run_id}</code></td>
            <td>Keeps each manually triggered deployment isolated and traceable to a single run.</td>
        </tr>
        <tr>
            <td><code>merge-main.yml</code></td>
            <td><code>deploy-test-on-main</code></td>
            <td>Queues merges to main so test applies execute in order and avoid state lock contention.</td>
        </tr>
    </tbody>
</table>

<div class="alert alert-info">
    <div><strong>Practical Effect:</strong> Concurrency improves deployment reliability by reducing Terraform state lock failures, avoiding overlapping applies, and ensuring each environment converges predictably.</div>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="apim-key-rotationyml-scheduled-manual">apim-key-rotation.yml (Scheduled + Manual)</h2>

<p>Rotates APIM subscription keys using OIDC-authenticated Azure CLI execution.</p>

<div class="grid grid-2">
    <div class="card">
        <h3 id="manual-mode">Manual Mode</h3>
        <ul>
            <li>Trigger with <code>workflow_dispatch</code></li>
            <li>Select environment: <code>dev</code>, <code>test</code>, <code>prod</code></li>
            <li>Optional <code>dry_run=true</code> for safe preview</li>
        </ul>
    </div>
    <div class="card card-gold">
        <h3 id="scheduled-mode">Scheduled Mode</h3>
        <ul>
            <li>Runs daily at <code>0 9 * * *</code> UTC (1–2 AM Pacific, depending on DST)</li>
            <li><code>rotate-dev</code> and <code>rotate-test</code> run <strong>concurrently</strong> (no dependency between them)</li>
            <li><code>rotate-prod</code> has <code>needs: [rotate-test]</code> — waits for test to succeed first</li>
            <li>A <code>notify</code> job (<code>if: always()</code>) prints a per-environment result summary</li>
        </ul>
    </div>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="pagesyml-documentation">pages.yml (Documentation)</h2>

<p>Deploys this documentation site to GitHub Pages when changes are pushed to docs or Terraform roots (so generated references stay current).</p>

<div class="card">
    <h3 id="triggers">Triggers</h3>
    <ul>
        <li><strong>Push to main</strong>: When files in <code>docs/**</code>, <code>initial-setup/infra/**</code>, or <code>infra-ai-hub/**</code> change</li>
        <li><strong>Manual</strong>: Can be triggered manually via <code>workflow_dispatch</code></li>
    </ul>
</div>

<div class="card">
    <h3 id="deployment-steps">Deployment Steps</h3>
    <ol>
        <li>Checkout repository</li>
        <li>Run <code>docs/generate-tf-docs.sh</code> to refresh Terraform reference content</li>
        <li>Run <code>docs/build.sh</code> to generate HTML from templates</li>
        <li>Configure GitHub Pages</li>
        <li>Upload <code>docs/</code> folder as artifact</li>
        <li>Deploy to GitHub Pages</li>
    </ol>
</div>

<hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">

<h2 id="environment-secrets">Environment Secrets</h2>

<p>Each GitHub environment requires these secrets (created by <code>initial-azure-setup.sh</code>):</p>

<table>
    <thead>
        <tr>
            <th>Secret</th>
            <th>Description</th>
            <th>Source</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>AZURE_CLIENT_ID</code></td>
            <td>Managed Identity client ID</td>
            <td>Created by setup script</td>
        </tr>
        <tr>
            <td><code>AZURE_TENANT_ID</code></td>
            <td>Azure AD tenant ID</td>
            <td>Your Azure subscription</td>
        </tr>
        <tr>
            <td><code>AZURE_SUBSCRIPTION_ID</code></td>
            <td>Target subscription ID</td>
            <td>Your Azure subscription</td>
        </tr>
        <tr>
            <td><code>VNET_RESOURCE_GROUP_NAME</code></td>
            <td>Resource group containing VNet</td>
            <td>Your infrastructure</td>
        </tr>
        <tr>
            <td><code>VNET_NAME</code></td>
            <td>Existing VNet name</td>
            <td>Your infrastructure</td>
        </tr>
        <tr>
            <td><code>VNET_ADDRESS_SPACE</code></td>
            <td>VNet CIDR block</td>
            <td>Your infrastructure</td>
        </tr>
    </tbody>
</table>

<h2 id="running-workflows-locally">Running Workflows Locally</h2>

<p>For local development and testing, use the deployment scripts in each Terraform root:</p>

<pre># Ensure you're logged in
az login

# Initial setup / tools
./initial-setup/infra/deploy-terraform.sh init
./initial-setup/infra/deploy-terraform.sh plan
./initial-setup/infra/deploy-terraform.sh apply</pre>

<pre># AI Hub stacks
./infra-ai-hub/scripts/deploy-terraform.sh plan dev
./infra-ai-hub/scripts/deploy-terraform.sh apply test</pre>

<div class="alert alert-info">
    <div><strong>Note:</strong> Local runs use your Azure CLI credentials instead of OIDC. Make sure you have the required permissions.</div>
</div>
    </main>
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-brand">
                <h4>AI Services Hub</h4>
                <p>Infrastructure as Code for Azure Landing Zone deployments</p>
            </div>
            <div class="footer-links">
                <h4>Resources</h4>
                <ul>
                    <li><a href="https://github.com/bcgov/ai-hub-tracking">GitHub Repository</a></li>
                    <li><a href="assets/azure-oidc-complete-guide.svg" target="_blank">Architecture Diagram</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>Documentation</h4>
                <ul>
                    <li><a href="services.html">AI Services</a></li>
                    <li><a href="diagrams.html">Architecture Diagrams</a></li>
                    <li><a href="playbooks.html">Playbooks</a></li>
                    <li><a href="decisions.html">ADRs</a></li>
                    <li><a href="faq.html">FAQ</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>BC Government</h4>
                <ul>
                    <li><a href="https://www2.gov.bc.ca">gov.bc.ca</a></li>
                    <li><a href="https://digital.gov.bc.ca">Digital Office</a></li>
                </ul>
            </div>
            <div class="footer-copyright">
                <p>&copy; 2026 Province of British Columbia</p>
                <p class="footer-meta">Built with zero dependencies</p>
            </div>
        </div>
    </footer>

    <script>
        (function () {
            function scrollToWithHeaderOffset(el) {
                if (!el) return;
                const header = document.querySelector('.bc-header');
                const offset = (header ? header.getBoundingClientRect().height : 0) + 16;

                const top = el.getBoundingClientRect().top + window.scrollY - offset;
                window.scrollTo({ top: Math.max(0, top) });
            }

            function openDetailsFromHash() {
                const hash = window.location.hash;
                if (!hash || hash.length < 2) return;

                const id = hash.substring(1);
                const el = document.getElementById(id);
                if (el && el.tagName && el.tagName.toLowerCase() === 'details') {
                    el.open = true;
                    // Opening can change layout; adjust scroll after paint so the
                    // sticky header doesn't cover the <summary> title.
                    requestAnimationFrame(function () {
                        requestAnimationFrame(function () {
                            scrollToWithHeaderOffset(el);
                        });
                    });
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                openDetailsFromHash();
            });

            window.addEventListener('hashchange', function () {
                openDetailsFromHash();
            });

            // If user clicks the same #hash twice, hashchange won't fire.
            // This ensures ADR links always expand.
            document.addEventListener('click', function (e) {
                const link = e.target.closest && e.target.closest('a[href^="#"]');
                if (!link) return;

                const href = link.getAttribute('href');
                if (!href || href.length < 2) return;

                const id = href.substring(1);
                const el = document.getElementById(id);
                if (el && el.tagName && el.tagName.toLowerCase() === 'details') {
                    el.open = true;
                    requestAnimationFrame(function () {
                        requestAnimationFrame(function () {
                            scrollToWithHeaderOffset(el);
                        });
                    });
                }
            });
        })();
    </script>
</body>
</html>
