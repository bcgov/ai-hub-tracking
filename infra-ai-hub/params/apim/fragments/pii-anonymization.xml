<fragment>
    <!-- ================================================================== -->
    <!-- PII Anonymization via Azure Language Service                       -->
    <!-- Enterprise-grade PII detection using Azure AI Language API         -->
    <!-- Supports: Names, addresses, SSN, medical terms, financial data     -->
    <!-- ================================================================== -->
    <!-- 
        Prerequisites - Set these variables before including this fragment:
        - piiInputContent: The text content to analyze (request body messages)
        - piiAnonymizationEnabled: "true" or "false" based on tenant config
        
        Required Named Value:
        - piiServiceUrl: The Language Service endpoint URL (set in APIM Named Values)

        Output:
        - piiAnonymizedContent: The anonymized text (with redactionCharacter masking)

        Usage: Include after extracting text from request body
    -->
    <choose>
        <when condition="@(context.Variables.GetValueOrDefault&lt;string&gt;(&quot;piiAnonymizationEnabled&quot;, &quot;false&quot;) == &quot;true&quot;)">
            <!-- Get MSI token for Cognitive Services -->
            <authentication-managed-identity
                resource="https://cognitiveservices.azure.com"
                output-token-variable-name="pii-msi-access-token"
                ignore-error="false" />

            <!-- Call Azure Language Service PII API -->
            <send-request mode="new" response-variable-name="piiAnalysisResponse" timeout="20" ignore-error="true">
                <set-url>{{piiServiceUrl}}/language/:analyze-text?api-version=2023-04-01</set-url>
                <set-method>POST</set-method>
                <set-header name="Content-Type" exists-action="override">
                    <value>application/json</value>
                </set-header>
                <set-header name="Authorization" exists-action="override">
                    <value>@("Bearer " + (string)context.Variables["pii-msi-access-token"])</value>
                </set-header>
                <set-body>@{
                    var inputText = context.Variables.GetValueOrDefault&lt;string&gt;("piiInputContent", "");
                    var request = new JObject();
                    request["kind"] = "PiiEntityRecognition";
                    request["parameters"] = new JObject {
                        {"modelVersion", "latest"},
                        {"redactionPolicy", new JObject {
                            {"policyKind", "CharacterMask"},
                            {"redactionCharacter", "#"}
                        }}
                    };
                    request["analysisInput"] = new JObject {
                        {"documents", new JArray {
                            new JObject {
                                {"text", inputText},
                                {"id", "1"},
                                {"language", "en"}
                            }
                        }}
                    };
                    return request.ToString();
                }</set-body>
            </send-request>
            
            <!-- Extract redacted text from API response -->
            <set-variable name="piiAnonymizedContent" value="@{
                try {
                    var response = context.Variables.GetValueOrDefault&lt;IResponse&gt;("piiAnalysisResponse");
                    if (response != null &amp;&amp; response.StatusCode == 200) {
                        var responseBody = JObject.Parse(response.Body.As&lt;string&gt;());
                        var redactedText = responseBody.SelectToken("$.results.documents[0].redactedText");
                        if (redactedText != null) {
                            return redactedText.ToString();
                        }
                    }
                } catch { }
                // Fallback to original content on error
                return context.Variables.GetValueOrDefault&lt;string&gt;("piiInputContent", "");
            }" />
            
            <!-- Log PII detection to App Insights -->
            <trace source="pii-anonymization" severity="information">
                <message>PII Anonymization Applied</message>
                <metadata name="event-type" value="pii-anonymization" />
                <metadata name="request-id" value="@(context.RequestId.ToString())" />
                <metadata name="tenant-id" value="@(context.Request.Headers.GetValueOrDefault(&quot;X-Tenant-Id&quot;, &quot;unknown&quot;))" />
            </trace>
        </when>
        <otherwise>
            <!-- PII anonymization disabled - pass through original content -->
            <set-variable name="piiAnonymizedContent" 
                value="@(context.Variables.GetValueOrDefault&lt;string&gt;(&quot;piiInputContent&quot;, &quot;&quot;))" />
        </otherwise>
    </choose>
</fragment>
