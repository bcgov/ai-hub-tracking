<policies>
    <inbound>
        <base />
        <!-- Tenant identification -->
        <set-header name="X-Tenant-Id" exists-action="override">
            <value>wlrs-water-form-assistant</value>
        </set-header>

        <!-- Token rate limiting: 10,000 TPM per subscription for this tenant -->
        <!-- Protects backend from token exhaustion, returns 429 when exceeded -->
        <llm-token-limit
            counter-key="@(context.Subscription.Id)"
            tokens-per-minute="10000"
            estimate-prompt-tokens="true"
            remaining-tokens-variable-name="remainingTokens"
            remaining-tokens-header-name="x-ratelimit-remaining-tokens"
            tokens-consumed-variable-name="tokensConsumed" />

        <!-- Path-based routing to appropriate backend service -->
        <choose>
            <!-- Document Intelligence requests: match documentintelligence, formrecognizer, or documentModels in path -->
            <when condition="@(context.Request.Url.Path.ToLower().Contains("documentintelligence") || context.Request.Url.Path.ToLower().Contains("formrecognizer") || context.Request.Url.Path.ToLower().Contains("documentmodels"))">
                <set-backend-service backend-id="wlrs-water-form-assistant-docint" />
                <authentication-managed-identity resource="https://cognitiveservices.azure.com" output-token-variable-name="msi-access-token" ignore-error="false" />
                <set-header name="Authorization" exists-action="override">
                    <value>@("Bearer " + (string)context.Variables["msi-access-token"])</value>
                </set-header>
                <set-header name="api-key" exists-action="delete" />
            </when>
            <!-- OpenAI requests: /openai/* -->
            <when condition="@(context.Request.Url.Path.ToLower().Contains("openai"))">
                <set-backend-service backend-id="wlrs-water-form-assistant-openai" />
                <authentication-managed-identity resource="https://cognitiveservices.azure.com" output-token-variable-name="msi-access-token" ignore-error="false" />
                <set-header name="Authorization" exists-action="override">
                    <value>@("Bearer " + (string)context.Variables["msi-access-token"])</value>
                </set-header>
                <set-header name="api-key" exists-action="delete" />
            </when>
            <!-- Default: Return 404 for unmatched paths -->
            <otherwise>
                <return-response>
                    <set-status code="404" reason="Not Found" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>{"error":{"code":"NotFound","message":"The requested path is not supported by this API."}}</set-body>
                </return-response>
            </otherwise>
        </choose>
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>
