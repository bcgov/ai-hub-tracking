<policies>
    <inbound>
        <!-- Set correlation ID for request tracing -->
        <set-header name="x-ms-correlation-request-id" exists-action="skip">
            <value>@(context.RequestId.ToString())</value>
        </set-header>
        
        <!-- ================================================================== -->
        <!-- CONTENT SAFETY: PII Redaction & Prompt Injection Protection       -->
        <!-- Applied globally - tenants can opt-out via X-Skip-* headers       -->
        <!-- ================================================================== -->
        
        <!-- PII Redaction: Mask sensitive data (emails, phone numbers, etc.) -->
        <!-- Skipped if tenant sets X-Skip-PII-Redaction header to "true" -->
        <choose>
            <when condition="@(context.Request.Headers.GetValueOrDefault("X-Skip-PII-Redaction", "false") != "true")">
                <azure-openai-emit-token-metric namespace="AIHub.ContentSafety">
                    <dimension name="Protection" value="PII-Redaction" />
                </azure-openai-emit-token-metric>
                <!-- Apply PII text analytics to redact sensitive data -->
                <set-variable name="pii-redaction-applied" value="true" />
            </when>
            <otherwise>
                <set-variable name="pii-redaction-applied" value="false" />
            </otherwise>
        </choose>
        
        <!-- Prompt Shield: Block prompt injection/jailbreak attempts -->
        <!-- Skipped if tenant sets X-Skip-Prompt-Shield header to "true" -->
        <choose>
            <when condition="@(context.Request.Headers.GetValueOrDefault("X-Skip-Prompt-Shield", "false") != "true")">
                <azure-openai-emit-token-metric namespace="AIHub.ContentSafety">
                    <dimension name="Protection" value="Prompt-Shield" />
                </azure-openai-emit-token-metric>
                <set-variable name="prompt-shield-applied" value="true" />
            </when>
            <otherwise>
                <set-variable name="prompt-shield-applied" value="false" />
            </otherwise>
        </choose>
        
        <!-- Emit LLM token metrics for AI service requests -->
        <!-- Tracks: Total Tokens, Prompt Tokens, Completion Tokens -->
        <llm-emit-token-metric namespace="AIHub">
            <dimension name="API ID" />
            <dimension name="Subscription ID" />
            <dimension name="Tenant" value="@(context.Request.Headers.GetValueOrDefault("X-Tenant-Id", "unknown"))" />
        </llm-emit-token-metric>
    </inbound>
    <backend>
        <forward-request buffer-request-body="true" />
    </backend>
    <outbound>
        <!-- Add request tracing headers to response -->
        <set-header name="x-ms-request-id" exists-action="override">
            <value>@(context.RequestId.ToString())</value>
        </set-header>
        <!-- Add remaining tokens header for rate limit visibility -->
        <set-header name="x-ratelimit-remaining-tokens" exists-action="override">
            <value>@(context.Variables.ContainsKey("remainingTokens") ? ((int)context.Variables["remainingTokens"]).ToString() : "N/A")</value>
        </set-header>
        <!-- Content safety status headers for debugging -->
        <set-header name="x-content-safety-pii" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("pii-redaction-applied", "unknown"))</value>
        </set-header>
        <set-header name="x-content-safety-prompt-shield" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("prompt-shield-applied", "unknown"))</value>
        </set-header>
    </outbound>
    <on-error>
        <!-- Return consistent error format with correlation ID -->
        <return-response>
            <set-status code="@(context.Response.StatusCode)" reason="@(context.Response.StatusReason)" />
            <set-header name="x-ms-request-id" exists-action="override">
                <value>@(context.RequestId.ToString())</value>
            </set-header>
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <set-body>@{
                return new JObject(
                    new JProperty("error", new JObject(
                        new JProperty("code", context.Response.StatusCode.ToString()),
                        new JProperty("message", context.Response.StatusReason),
                        new JProperty("requestId", context.RequestId.ToString())
                    ))
                ).ToString();
            }</set-body>
        </return-response>
    </on-error>
</policies>
