<policies>
    <inbound>
        <!-- Set correlation ID for request tracing -->
        <set-header name="x-ms-correlation-request-id" exists-action="skip">
            <value>@(context.RequestId.ToString())</value>
        </set-header>
        
        <!-- ================================================================== -->
        <!-- CONTENT SAFETY: PII Redaction                                   -->
        <!-- Applied globally - tenant opt-out resolved at deploy time        -->
        <!-- ================================================================== -->

        <!-- Determine if this tenant opted out of PII redaction -->
        <set-variable name="pii-redaction-skip" value="@{
            var path = context.Request.Url.Path.ToLower().Trim('/');
            var apiPath = context.Api != null ? context.Api.Path?.ToLower() : null;
            var tenant = !string.IsNullOrEmpty(apiPath)
                ? apiPath.Trim('/')
                : (path.Contains("/") ? path.Split('/')[0] : path);
%{ if length(pii_redaction_opt_out_tenants) > 0 ~}
            var optOut = new [] { ${join(", ", [for t in pii_redaction_opt_out_tenants : "\"${t}\""])} };
            return optOut.Contains(tenant) ? "true" : "false";
%{ else ~}
            return "false";
%{ endif ~}
        }" />

        <!-- PII Redaction: Mask sensitive data in LLM requests/responses -->
        <!-- Skipped if tenant opted out in params/{env}/tenants.tfvars -->
        <choose>
            <when condition="@(context.Request.Url.Path.ToLower().Contains("openai") && context.Variables.GetValueOrDefault<string>("pii-redaction-skip", "false") != "true")">
                <set-variable name="pii-redaction-applied" value="true" />
                <set-body>@{
                    var body = context.Request.Body.As<string>(preserveContent: true);
                    if (string.IsNullOrEmpty(body)) {
                        return body;
                    }
                    body = System.Text.RegularExpressions.Regex.Replace(body, @"[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}", "[REDACTED_EMAIL]", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                    body = System.Text.RegularExpressions.Regex.Replace(body, @"\b(\+?\d{1,3}[\s\.-]?)?(\(?\d{3}\)?[\s\.-]?){1}\d{3}[\s\.-]?\d{4}\b", "[REDACTED_PHONE]");
                    body = System.Text.RegularExpressions.Regex.Replace(body, @"\b\d{3}-\d{2}-\d{4}\b", "[REDACTED_SSN]");
                    body = System.Text.RegularExpressions.Regex.Replace(body, @"\b(?:\d[ -]*?){13,16}\b", "[REDACTED_CC]");
                    return body;
                }</set-body>
            </when>
            <otherwise>
                <set-variable name="pii-redaction-applied" value="false" />
            </otherwise>
        </choose>
        
        <!-- Emit LLM token metrics for AI service requests -->
        <!-- Tracks: Total Tokens, Prompt Tokens, Completion Tokens -->
        <llm-emit-token-metric namespace="AIHub">
            <dimension name="API ID" />
            <dimension name="Subscription ID" />
            <dimension name="Tenant" value="@(context.Request.Headers.GetValueOrDefault("X-Tenant-Id", "unknown"))" />
        </llm-emit-token-metric>
    </inbound>
    <backend>
        <forward-request buffer-request-body="true" />
    </backend>
    <outbound>
        <!-- Add request tracing headers to response -->
        <set-header name="x-ms-request-id" exists-action="override">
            <value>@(context.RequestId.ToString())</value>
        </set-header>
        <!-- Add remaining tokens header for rate limit visibility -->
        <set-header name="x-ratelimit-remaining-tokens" exists-action="override">
            <value>@(context.Variables.ContainsKey("remainingTokens") ? ((int)context.Variables["remainingTokens"]).ToString() : "N/A")</value>
        </set-header>
        <!-- PII Redaction on responses (only if applied on inbound) -->
        <choose>
            <when condition="@(context.Variables.GetValueOrDefault<string>("pii-redaction-applied", "false") == "true")">
                <set-body>@{
                    var body = context.Response.Body.As<string>(preserveContent: true);
                    if (string.IsNullOrEmpty(body)) {
                        return body;
                    }
                    body = System.Text.RegularExpressions.Regex.Replace(body, @"[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}", "[REDACTED_EMAIL]", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                    body = System.Text.RegularExpressions.Regex.Replace(body, @"\b(\+?\d{1,3}[\s\.-]?)?(\(?\d{3}\)?[\s\.-]?){1}\d{3}[\s\.-]?\d{4}\b", "[REDACTED_PHONE]");
                    body = System.Text.RegularExpressions.Regex.Replace(body, @"\b\d{3}-\d{2}-\d{4}\b", "[REDACTED_SSN]");
                    body = System.Text.RegularExpressions.Regex.Replace(body, @"\b(?:\d[ -]*?){13,16}\b", "[REDACTED_CC]");
                    return body;
                }</set-body>
            </when>
        </choose>
        <!-- Content safety status headers for debugging -->
        <set-header name="x-content-safety-pii" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("pii-redaction-applied", "unknown"))</value>
        </set-header>
    </outbound>
    <on-error>
        <!-- Return consistent error format with correlation ID -->
        <return-response>
            <set-status code="@(context.Response.StatusCode)" reason="@(context.Response.StatusReason)" />
            <set-header name="x-ms-request-id" exists-action="override">
                <value>@(context.RequestId.ToString())</value>
            </set-header>
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <set-body>@{
                return new JObject(
                    new JProperty("error", new JObject(
                        new JProperty("code", context.Response.StatusCode.ToString()),
                        new JProperty("message", context.Response.StatusReason),
                        new JProperty("requestId", context.RequestId.ToString())
                    ))
                ).ToString();
            }</set-body>
        </return-response>
    </on-error>
</policies>
