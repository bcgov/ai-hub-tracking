name: Ephemeral Self-Hosted Runner (VM)
# This workflow deploys the Azure Container Apps-based GitHub self-hosted runners.
# It's a one-time deployment (or run when you need to update the infrastructure).
# Once deployed, runners auto-scale from 0 based on queued jobs.

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      action:
        description: "Terraform action to perform"
        required: true
        type: choice
        default: apply
        options:
          - plan
          - apply
          - destroy

permissions:
  id-token: write
  contents: read

env:
  TF_VERSION: 1.12.2
  TF_LOG: ERROR
  TF_VAR_app_name: "ai-hub-deploy-utils"
  TF_VAR_app_env: "tools"
  TF_VAR_location: "Canada Central"
  TF_VAR_resource_group_name: "ai-hub-deploy-utils-tools"
  TF_VAR_common_tags: >-
    {"environment":"tools","app_env":"tools","repo_name":"${{ github.event.repository.name }}"}

jobs:
  deploy-runners:
    name: Deploy GitHub Runners (${{ inputs.action }})
    runs-on: ubuntu-24.04
    environment: tools
    env:
      CI: "true"
      ARM_USE_OIDC: "true"
      TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
      TF_VAR_client_id: ${{ secrets.AZURE_CLIENT_ID }}
      TF_VAR_vnet_resource_group_name: ${{ secrets.VNET_RESOURCE_GROUP_NAME }}
      TF_VAR_vnet_name: ${{ secrets.VNET_NAME }}
      TF_VAR_vnet_address_space: ${{ secrets.VNET_ADDRESS_SPACE }}
      # GitHub Runners configuration
      TF_VAR_github_runners_aca_enabled: "true"
      TF_VAR_github_organization: ${{ github.repository_owner }}
      TF_VAR_github_repository: ${{ github.event.repository.name }}
      TF_VAR_github_runner_pat: ${{ secrets.GH_RUNNER_PAT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure CLI Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        shell: bash
        run: |
          chmod +x ./deploy-terraform.sh
          ./deploy-terraform.sh init

      - name: Terraform Plan
        if: inputs.action == 'plan' || inputs.action == 'apply'
        shell: bash
        run: |
          ./deploy-terraform.sh plan -target=module.github_runners_aca

      - name: Terraform Apply
        if: inputs.action == 'apply'
        shell: bash
        run: |
          ./deploy-terraform.sh apply -target=module.github_runners_aca

      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        shell: bash
        run: |
          ./deploy-terraform.sh destroy -target=module.github_runners_aca

      - name: Output Runner Label
        if: inputs.action == 'apply'
        shell: bash
        run: |
          echo "## GitHub Runners Deployed! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          RUNNER_LABEL=$(terraform -chdir=infra output -raw github_runners_label 2>/dev/null || echo "self-hosted-aca-${{ github.event.repository.name }}")
          echo "Use this label in your workflows:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          echo "runs-on:" >> $GITHUB_STEP_SUMMARY
          echo "  - self-hosted" >> $GITHUB_STEP_SUMMARY
          echo "  - ${RUNNER_LABEL}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Runners scale from 0 and spin up automatically when jobs are queued." >> $GITHUB_STEP_SUMMARY
