name: .Terraform Lint

on:
  workflow_call:
    inputs:
      base_sha:
        description: "Base commit SHA for diff-based pre-commit run"
        required: false
        type: string
      head_sha:
        description: "Head commit SHA for diff-based pre-commit run"
        required: false
        type: string

permissions:
  contents: read

jobs:
  terraform-lint:
    name: Terraform Lint and Format Check
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.2

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install pre-commit
        run: python -m pip install --upgrade pre-commit

      - name: Run pre-commit hooks
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ inputs.base_sha }}"
          HEAD_SHA="${{ inputs.head_sha }}"

          if [[ -n "$BASE_SHA" && -n "$HEAD_SHA" ]] \
            && git cat-file -e "$BASE_SHA^{commit}" 2>/dev/null \
            && git cat-file -e "$HEAD_SHA^{commit}" 2>/dev/null; then
            pre-commit run \
              --from-ref "$BASE_SHA" \
              --to-ref "$HEAD_SHA" \
              --show-diff-on-failure
          else
            echo "Falling back to full pre-commit run: base/head commit not available in local checkout."
            pre-commit run --all-files --show-diff-on-failure
          fi
