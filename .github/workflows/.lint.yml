name: .Terraform Lint

on:
  workflow_call:
    inputs:
      base_sha:
        description: "Base commit SHA for diff-based pre-commit run"
        required: false
        type: string
      head_sha:
        description: "Head commit SHA for diff-based pre-commit run"
        required: false
        type: string

permissions:
  contents: read

jobs:
  terraform-lint:
    name: Terraform Lint and Format Check
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: 1.12.2

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pre-commit
        run: python -m pip install --upgrade pre-commit

      - name: Run pre-commit hooks
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${{ inputs.base_sha }}" && -n "${{ inputs.head_sha }}" ]]; then
            pre-commit run \
              --from-ref "${{ inputs.base_sha }}" \
              --to-ref "${{ inputs.head_sha }}" \
              --show-diff-on-failure
          else
            pre-commit run --all-files --show-diff-on-failure
          fi
