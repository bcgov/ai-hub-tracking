name: .Terraform Deployer

on:
  workflow_call:
    inputs:
      environment_name:
        description: "The name of the environment to deploy to"
        required: true
        default: "tools"
        type: string
      command:
        description: "The Terraform command to run (init, plan, apply, destroy)"
        required: true
        default: "apply"
        type: string
      proxy_url:
        description: "The proxy URL to use for the secure tunnel"
        required: true
        type: string
      proxy_auth:
        description: "The proxy authentication token for the secure tunnel"
        required: true
        type: string
      tag:
        description: "The container tag to use for deployment"
        required: false
        type: string
      terraform_log_level:
        description: "The Terraform logging level"
        required: false
        default: "ERROR"
        type: string
env:
  TF_VERSION: 1.12.2
  TF_LOG: ${{ inputs.terraform_log_level }}
  CHISEL_IMAGE_VERSION: 1.11
  CHISEL_IMAGE: jpillora/chisel
permissions:
  id-token: write # Required for OIDC authentication
  contents: write

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-24.04
    steps:
      - name: Check Environment Name
        run: |
          VALID_ENVS=("dev" "test" "prod")
          if [[ ! " ${VALID_ENVS[@]} " =~ " ${{ inputs.environment_name }} " ]]; then
            echo "Error: Invalid environment name '${{ inputs.environment_name }}'. Valid options are: ${VALID_ENVS[*]}"
            exit 1
          fi
          # check that proxy_url and proxy_auth are non-empty
          if [[ -z "${{ inputs.proxy_url }}" || -z "${{ inputs.proxy_auth }}" ]]; then
            echo "Error: proxy_url and proxy_auth are required inputs."
            exit 1
          fi

  terraform:
    environment: ${{ inputs.environment_name }}
    name: Terraform ${{ inputs.command }} via Secure Tunnel
    concurrency:
      cancel-in-progress: false
      group: ${{ inputs.environment_name }}
    needs: validate
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Azure CLI Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      - name: Run proxy client
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${{ inputs.proxy_url }}" || -z "${{ inputs.proxy_auth }}" ]]; then
            echo "proxy_url and proxy_auth are required when use_secure_tunnel=true" >&2
            exit 1
          fi

          # Decode the proxy_url and proxy_auth.
          # Use loopback pinentry to avoid hangs; force stdout output to avoid "handle plaintext failed".
          KEY='${{ secrets.GPG_PASSPHRASE }}'
          if [[ -z "$KEY" ]]; then
            echo "GPG_PASSPHRASE secret is empty/missing" >&2
            exit 1
          fi

          decrypt_b64_gpg() {
            local encoded="$1"
            printf '%s' "$encoded" \
              | tr -d '\r\n' \
              | base64 --decode \
              | gpg --batch --yes --pinentry-mode loopback --passphrase "$KEY" --decrypt --output -
          }

          PROXY_URL="$(decrypt_b64_gpg '${{ inputs.proxy_url }}')"
          PROXY_AUTH="$(decrypt_b64_gpg '${{ inputs.proxy_auth }}')"
          echo "Proxy URL: ****${PROXY_URL: -4}"
          echo "Proxy Auth: ****${PROXY_AUTH: -4}"
          docker network create proxy-net >/dev/null 2>&1 || true
          docker run -d --name chisel-client --network proxy-net ${CHISEL_IMAGE}:${CHISEL_IMAGE_VERSION} client --auth "$PROXY_AUTH" "$PROXY_URL" 0.0.0.0:1080:socks
          docker run -d --name privoxy --network proxy-net -p 127.0.0.1:8118:8118 -e SOCKS_HOST=chisel-client -e SOCKS_PORT=1080 ghcr.io/${{ github.repository }}/azure-proxy/privoxy:${{inputs.tag || 'latest'}}
          docker logs chisel-client
          docker logs privoxy
          curl --proxy http://127.0.0.1:8118 https://ifconfig.me
      - name: Execute Deployment
        shell: bash
        working-directory: ./infra-ai-hub
        env:
          ARM_USE_OIDC: "true"
          CI: "true" # Common Terraform variables
          TF_VAR_app_name: "ai-services-hub"
          TF_VAR_app_env: ${{ inputs.environment_name }}
          TF_VAR_location: "Canada Central"
          TF_VAR_resource_group_name: ${{ format('{0}-{1}', 'ai-services-hub', inputs.environment_name) }}
          TF_VAR_common_tags: >-
            {"environment":"${{ inputs.environment_name }}","app_env":"${{ inputs.environment_name }}","repo_name":"${{ github.event.repository.name }}"}
          TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_client_id: ${{ secrets.AZURE_CLIENT_ID }}

          # Network-related variables (used by different modes)
          TF_VAR_vnet_name: ${{ secrets.VNET_NAME }}
          TF_VAR_vnet_resource_group_name: ${{ secrets.VNET_RESOURCE_GROUP_NAME }}
          TF_VAR_vnet_address_space: ${{ secrets.VNET_ADDRESS_SPACE }}
          TF_VAR_dev_address_spaces: ${{ secrets.DEV_ADDRESS_SPACES }}
          TF_VAR_test_address_spaces: ${{ secrets.TEST_ADDRESS_SPACES }}
          TF_VAR_prod_address_spaces: ${{ secrets.PROD_ADDRESS_SPACES }}
          TF_VAR_target_vnet_address_spaces: ${{ secrets.TARGET_VNET_ADDRESS_SPACES }}
          TF_VAR_source_vnet_address_space: ${{ secrets.SOURCE_VNET_ADDRESS_SPACE }}

          # Only used by infra-ai-hub, harmless if unset/unused
          TF_VAR_key_vault_name: ${{ format('{0}{1}{2}kv', 'aihub', inputs.environment_name, vars.SUBSCRIPTION_NAME) }}

          # Backend configuration for deploy script
          BACKEND_RESOURCE_GROUP: ${{ secrets.VNET_RESOURCE_GROUP_NAME }}
          BACKEND_STORAGE_ACCOUNT: ${{ vars.STORAGE_ACCOUNT_NAME }}

          HTTP_PROXY: "http://127.0.0.1:8118"
          HTTPS_PROXY: "http://127.0.0.1:8118"
          # Bypass proxy for Azure control plane APIs and Terraform registries; data plane uses proxy for private endpoint access
          NO_PROXY: "management.azure.com,login.microsoftonline.com,graph.microsoft.com,registry.terraform.io,releases.hashicorp.com,github.com,objects.githubusercontent.com"
        run: |
          export no_proxy="$NO_PROXY"

          # Make all scripts executable
          chmod +x ./scripts/*.sh

          # Run deployment via script
          ./scripts/deploy-terraform.sh "${{ inputs.command }}" "${{ inputs.environment_name }}"

      - name: Install bats-core
        if: inputs.command == 'apply'
        uses: bats-core/bats-action@4.0.0

      - name: Run Integration Tests
        if: inputs.command == 'apply' && (inputs.environment_name == 'dev' || inputs.environment_name == 'test')
        shell: bash
        working-directory: ./infra-ai-hub
        env:
          TEST_ENV: ${{ inputs.environment_name }}
          HTTP_PROXY: "http://127.0.0.1:8118"
          HTTPS_PROXY: "http://127.0.0.1:8118"
          NO_PROXY: "management.azure.com,login.microsoftonline.com,graph.microsoft.com,registry.terraform.io,releases.hashicorp.com,github.com,objects.githubusercontent.com"
        run: |
          set -euo pipefail

          echo "=== Running Integration Tests (env-aware harness) ==="
          cd ../tests/integration
          chmod +x ./run-tests.sh
          ./run-tests.sh --env "${TEST_ENV}"
