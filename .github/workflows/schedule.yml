name: Scheduled Bastion Cleanup

on:
  schedule:
    # Run every day at 5 PM PST (1 AM UTC next day)
    - cron: "0 1 * * *"
  workflow_dispatch:
permissions:
  id-token: write
  contents: read

jobs:
  check-and-destroy-bastion:
    name: Check and Destroy Bastion if Running
    environment: tools
    runs-on: ubuntu-24.04
    outputs:
      bastion_exists: ${{ steps.check_bastion.outputs.bastion_running }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure CLI Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check if Bastion Exists
        id: check_bastion
        shell: bash
        run: |
          BASTION_EXISTS=$(az network bastion show \
            --resource-group "ai-hub-deploy-utils-tools" \
            --name "ai-hub-deploy-utils-bastion" \
            --query "id" \
            -o tsv 2>/dev/null || echo "")

          if [[ -z "$BASTION_EXISTS" ]]; then
            echo "bastion_running=false" >> $GITHUB_OUTPUT
            echo "Bastion not found - skipping destruction"
          else
            echo "bastion_running=true" >> $GITHUB_OUTPUT
            echo "Bastion found - will destroy"
          fi

  destroy-bastion:
    name: Destroy Bastion Module
    needs: check-and-destroy-bastion
    if: needs.check-and-destroy-bastion.outputs.bastion_exists == 'true'
    uses: ./.github/workflows/.deployer.yml
    with:
      environment_name: tools
      command: destroy
      target_module: bastion
    secrets: inherit

  notification:
    name: Cleanup Status
    needs: [check-and-destroy-bastion, destroy-bastion]
    if: always()
    runs-on: ubuntu-24.04
    steps:
      - name: Report Status
        shell: bash
        run: |
          if [[ "${{ needs.check-and-destroy-bastion.outputs.bastion_exists }}" == "true" ]]; then
            echo "Bastion destroyed successfully at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          else
            echo "Bastion was not running - no action needed"
          fi
